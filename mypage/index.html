<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="„Åã„Å´„Çµ„Éº„Éê„Éº - „Éû„Ç§„Éö„Éº„Ç∏">
    <title>„Éû„Ç§„Éö„Éº„Ç∏ | „Åã„Å´„Çµ„Éº„Éê„Éº„Ç§„Éô„É≥„Éà</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;600;700&family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap"
        rel="stylesheet">

    <!-- Bootswatch Lux (Bootstrap 5.3.3) -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-purple: #6b5b95;
            --deep-purple: #4a3f6b;
            --cream: #faf5e8;
            --gold: #d4a853;
            --btn-gold: #c29544;
            --font-title: 'Noto Serif JP', serif;
            --font-body: 'M PLUS Rounded 1c', sans-serif;
        }

        .btn-gold {
            background-color: var(--gold);
            border: none;
        }

        .btn-gold:hover {
            background-color: var(--btn-gold);
            color: white;
        }


        body {
            font-family: var(--font-body);
            background: linear-gradient(180deg, #6b5b95 0%, #5a4d80 50%, #4a3f6b 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }

        .page-header {
            font-family: var(--font-title);
            color: var(--cream);
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
        }

        .back-button {
            font-family: var(--font-body);
            font-size: 1rem;
            padding: 10px 25px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #fff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .profile-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--gold);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .discord-badge {
            background: linear-gradient(135deg, #43b581, #3ca374);
            color: white;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(67, 181, 129, 0.4);
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid var(--gold);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--deep-purple);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .login-prompt {
            text-align: center;
            padding: 60px 20px;
        }

        .login-prompt-btn {
            background: linear-gradient(135deg, #5865F2, #4752c4);
            color: white;
            padding: 15px 40px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .login-prompt-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(88, 101, 242, 0.4);
        }

        .logout-btn {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 2px solid #dc3545;
            padding: 10px 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc3545;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <!-- Êàª„Çã„Éú„Çø„É≥ -->
        <div class="mb-4">
            <a href="../index.html" class="back-button">
                ‚Üê „Éõ„Éº„É†„Å´Êàª„Çã
            </a>
        </div>


        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <header class="text-center mb-5">
            <h1 class="page-header display-4 fw-bold mb-3">üë§ „Éû„Ç§„Éö„Éº„Ç∏</h1>
        </header>

        <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">

                <!-- Êú™„É≠„Ç∞„Ç§„É≥ÊôÇ -->
                <div id="login-prompt" class="profile-card login-prompt" style="display: none;">
                    <h3 class="mb-4" style="font-family: var(--font-title); color: var(--deep-purple);">
                        „É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                    </h3>
                    <p class="text-muted mb-4">
                        „Éû„Ç§„Éö„Éº„Ç∏„ÇíË°®Á§∫„Åô„Çã„Å´„ÅØDiscord„Åß„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ
                    </p>
                    <button onclick="loginWithDiscord()" class="login-prompt-btn">
                        <img src="https://assets-global.website-files.com/6257adef93867e50d84d30e2/636e0a69f118df70ad7828d4_icon_clyde_blurple_RGB.svg"
                            alt="Discord" style="width: 24px;">
                        Discord„Åß„É≠„Ç∞„Ç§„É≥
                    </button>
                </div>

                <!-- „É≠„Ç∞„Ç§„É≥Ê∏à„Åø -->
                <div id="profile-content" style="display: none;">
                    <div class="profile-card mb-4">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <img id="user-avatar" src="" alt="„Ç¢„Éê„Çø„Éº" class="avatar-large">
                            </div>
                            <div class="col">
                                <h2 id="user-name" class="mb-2"
                                    style="font-family: var(--font-title); color: var(--deep-purple);">
                                    „É¶„Éº„Ç∂„ÉºÂêç
                                </h2>
                                <span class="discord-badge">
                                    <img src="https://assets-global.website-files.com/6257adef93867e50d84d30e2/636e0a69f118df70ad7828d4_icon_clyde_blurple_RGB.svg"
                                        alt="Discord" style="width: 16px;">
                                    DiscordÈÄ£Êê∫Ê∏à„Åø
                                </span>
                                <div class="mt-3">
                                    <label class="small text-muted mb-1">„Éã„ÉÉ„ÇØ„Éç„Éº„É† („É©„É≥„Ç≠„É≥„Ç∞Á≠â„ÅßË°®Á§∫)</label>
                                    <div class="input-group">
                                        <input type="text" id="user-nickname" class="form-control" placeholder="Êú™Ë®≠ÂÆö">
                                        <button onclick="useDiscordName()" class="btn btn-outline-secondary btn-sm"
                                            title="Discord„ÅÆË°®Á§∫Âêç„ÇíÂÖ•„Çå„Çã">
                                            <small>DiscordÂêç„Çí‰ΩøÁî®</small>
                                        </button>
                                        <button onclick="saveNickname()"
                                            class="btn btn-gold text-white fw-bold">‰øùÂ≠ò</button>
                                    </div>
                                    <div id="save-msg" class="small mt-1" style="display:none;"></div>
                                </div>
                            </div>

                            <div class="col-auto">
                                <button onclick="logout()" class="logout-btn">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                            </div>
                        </div>
                    </div>

                    <!-- Áµ±Ë®à -->
                    <div class="row g-4 mb-4">
                        <div class="col-6 col-md-3">
                            <div class="stat-card">
                                <div class="stat-value">0</div>
                                <div class="stat-label">üÄÑ È∫ªÈõÄÂèÇÂä†</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stat-card">
                                <div class="stat-value">0</div>
                                <div class="stat-label">üÉè „Éù„Éº„Ç´„ÉºÂèÇÂä†</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stat-card">
                                <div class="stat-value">0</div>
                                <div class="stat-label">üèÜ ÂÑ™ÂãùÂõûÊï∞</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stat-card">
                                <div class="stat-value">-</div>
                                <div class="stat-label">üìä „É©„É≥„Ç≠„É≥„Ç∞</div>
                            </div>
                        </div>
                    </div>

                    <!-- ÊúÄËøë„ÅÆÊàêÁ∏æ -->
                    <div class="profile-card">
                        <h4 class="mb-3" style="font-family: var(--font-title); color: var(--deep-purple);">
                            üìã ÊúÄËøë„ÅÆÊàêÁ∏æ
                        </h4>
                        <p class="text-muted text-center py-4">
                            „Åæ„Å†Â§ß‰ºö„Å´ÂèÇÂä†„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SupabaseË®≠ÂÆö -->
    <script src="../js/supabase-config.js"></script>
    <script src="../js/auth-guard.js"></script>

    <script>
        // „Éû„Ç§„Éö„Éº„Ç∏Áî®„ÅÆË°®Á§∫Âá¶ÁêÜ
        async function displayMyPage() {
            const user = await getCurrentUser();
            const loginPrompt = document.getElementById('login-prompt');
            const profileContent = document.getElementById('profile-content');

            if (user) {
                // „É≠„Ç∞„Ç§„É≥Ê∏à„Åø
                loginPrompt.style.display = 'none';
                profileContent.style.display = 'block';

                const discordUser = user.user_metadata;

                // „Ç¢„Éê„Çø„Éº
                const avatarUrl = discordUser.avatar_url ||
                    `https://cdn.discordapp.com/avatars/${discordUser.provider_id}/${discordUser.avatar}`;
                document.getElementById('user-avatar').src = avatarUrl;

                // „É¶„Éº„Ç∂„ÉºÂêç
                document.getElementById('user-name').textContent =
                    discordUser.full_name || discordUser.name || '„É¶„Éº„Ç∂„Éº';

                // „Éã„ÉÉ„ÇØ„Éç„Éº„É†ÂèñÂæó
                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('nickname')
                    .eq('discord_account', discordUser.full_name || discordUser.name)
                    .single();
                if (profile && profile.nickname) {
                    document.getElementById('user-nickname').value = profile.nickname;
                }

            } else {

                // Êú™„É≠„Ç∞„Ç§„É≥
                loginPrompt.style.display = 'block';
                profileContent.style.display = 'none';
            }
        }

        async function useDiscordName() {
            const user = await getCurrentUser();
            if (!user) return;
            const discordUser = user.user_metadata;
            // Ë°®Á§∫Âêç„ÇíÂèñÂæó (global_name -> full_name -> name)
            const discordDisplayName = discordUser.custom_claims?.global_name || discordUser.full_name || discordUser.name;
            document.getElementById('user-nickname').value = discordDisplayName;
        }

        async function saveNickname() {

            const user = await getCurrentUser();
            if (!user) return;

            const nickname = document.getElementById('user-nickname').value;
            const discordAccount = user.user_metadata.full_name || user.user_metadata.name;
            const msg = document.getElementById('save-msg');

            msg.style.display = 'block';
            msg.textContent = '‰øùÂ≠ò‰∏≠...';
            msg.className = 'small mt-1 text-muted';

            const { error } = await supabaseClient
                .from('profiles')
                .update({ nickname: nickname, updated_at: new Date().toISOString() })
                .eq('discord_account', discordAccount);

            if (error) {
                msg.textContent = '„Ç®„É©„Éº: ' + error.message;
                msg.className = 'small mt-1 text-danger';
            } else {
                msg.textContent = '‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ';
                msg.className = 'small mt-1 text-success';
                setTimeout(() => { msg.style.display = 'none'; }, 2000);
            }
        }

        document.addEventListener('DOMContentLoaded', displayMyPage);

    </script>
</body>

</html>