<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="„Åã„Å´„Çµ„Éº„Éê„Éº - „Éû„Ç§„Éö„Éº„Ç∏">
    <title>„Éû„Ç§„Éö„Éº„Ç∏ | „Åã„Å´„Çµ„Éº„Éê„Éº„Ç§„Éô„É≥„Éà</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;600;700&family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap"
        rel="stylesheet">

    <!-- Bootswatch Lux (Bootstrap 5.3.3) -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <script src="../js/badge-utils.js"></script>

    <style>
        :root {
            --primary-purple: #6b5b95;
            --deep-purple: #4a3f6b;
            --cream: #faf5e8;
            --gold: #d4a853;
            --btn-gold: #c29544;
            --font-title: 'Noto Serif JP', serif;
            --font-body: 'M PLUS Rounded 1c', sans-serif;
        }

        .btn-gold {
            background-color: var(--gold);
            border: none;
        }

        .btn-gold:hover {
            background-color: var(--btn-gold);
            color: white;
        }


        body {
            font-family: var(--font-body);
            background: linear-gradient(180deg, #6b5b95 0%, #5a4d80 50%, #4a3f6b 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }

        .page-header {
            font-family: var(--font-title);
            color: var(--cream);
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
        }

        .back-button {
            font-family: var(--font-body);
            font-size: 1rem;
            padding: 10px 25px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #fff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .profile-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--gold);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .discord-badge {
            background: linear-gradient(135deg, #43b581, #3ca374);
            color: white;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(67, 181, 129, 0.4);
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid var(--gold);
        }

        .activity-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .activity-item-card {
            background: #fdfdfd;
            /* „Ç´„Éº„Éâ„ÅÆ‰∏≠„Å´„Ç´„Éº„Éâ„Åß„ÅÇ„Çã„Åì„Å®„ÇíÂº∑Ë™ø„Åô„Çã„Åü„ÇÅ„ÅÆÂæÆË™øÊï¥ */
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            border: 1px solid #eff0f1;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            display: block;
        }

        .activity-item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            border-color: var(--gold);
        }

        .activity-date {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 10px;
            display: block;
            border-bottom: 1px solid #f5f5f5;
            padding-bottom: 5px;
        }

        .activity-type-badge {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 50px;
            background: #f0f2f5;
            color: #4b515d;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .activity-details {
            font-size: 0.95rem;
            color: #2c3e50;
            font-weight: 500;
        }

        .activity-amount {
            font-family: 'Inter', 'Kosugi Maru', sans-serif;
            font-weight: 800;
            font-size: 1.15rem;
            letter-spacing: -0.02em;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--deep-purple);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        /* È∫ªÈõÄÁµ±Ë®à„Éï„Ç£„É´„Çø„Éº */
        .mahjong-filter-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .filter-label-mini {
            font-size: 0.7rem;
            color: #888;
            font-weight: bold;
        }

        .mahjong-filter-select {
            padding: 6px 12px;
            border: 2px solid #d4a853;
            border-radius: 8px;
            background: linear-gradient(135deg, #fff9e6 0%, #fff 100%);
            color: #333;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            min-width: 100px;
            transition: all 0.3s ease;
        }

        .mahjong-filter-select:hover {
            border-color: #c49743;
            box-shadow: 0 2px 8px rgba(212, 168, 83, 0.3);
        }

        .mahjong-filter-select:focus {
            outline: none;
            border-color: #b88533;
            box-shadow: 0 0 0 3px rgba(212, 168, 83, 0.2);
        }

        .login-prompt {
            text-align: center;
            padding: 60px 20px;
        }

        .login-prompt-btn {
            background: linear-gradient(135deg, #5865F2, #4752c4);
            color: white;
            padding: 15px 40px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .login-prompt-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(88, 101, 242, 0.4);
        }

        .logout-btn {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 2px solid #dc3545;
            padding: 10px 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc3545;
            color: white;
        }

        /* „Éã„ÉÉ„ÇØ„Éç„Éº„É†ÂÖ•ÂäõÊ¨Ñ */
        .nickname-input {
            background: #fff;
            border: 2px solid #e0d8f0;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 1rem;
            transition: all 0.3s ease;
            color: #333;
        }

        .nickname-input::placeholder {
            color: #aaa;
            font-style: italic;
        }

        .nickname-input:focus {
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 4px rgba(107, 91, 149, 0.15);
            outline: none;
            background: #fff;
        }

        /* „Ç¢„Ç§„Ç≥„É≥Êõ¥Êñ∞„Éú„Çø„É≥ */
        .btn-avatar-update {
            background: linear-gradient(135deg, #5865F2 0%, #4752c4 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(88, 101, 242, 0.3);
        }

        .btn-avatar-update:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(88, 101, 242, 0.5);
            background: linear-gradient(135deg, #6872f4 0%, #5865F2 100%);
        }

        /* Áµ±Ë®à„Éü„Éã„Ç´„Éº„Éâ */
        .stat-card-mini {
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
            cursor: pointer;
            height: 100%;
        }

        .stat-card-mini:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--gold);
        }

        .stat-card-mini.rank-1 {
            background: linear-gradient(135deg, #fff7ad 0%, #ffa700 100%) !important;
            border-left: 8px solid #ffd700 !important;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3) !important;
        }

        .stat-card-mini.rank-2 {
            background: linear-gradient(135deg, #f0f0f0 0%, #a0a0a0 100%) !important;
            border-left: 8px solid #c0c0c0 !important;
            box-shadow: 0 4px 15px rgba(192, 192, 192, 0.3) !important;
        }

        .stat-card-mini.rank-3 {
            background: linear-gradient(135deg, #f5d4b5 0%, #b87333 100%) !important;
            border-left: 8px solid #cd7f32 !important;
            box-shadow: 0 4px 15px rgba(205, 127, 50, 0.3) !important;
        }

        .stat-label-mini {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-value-mini {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--deep-purple);
        }

        .stat-rank {
            font-size: 0.7rem;
            color: #fff;
            background: linear-gradient(135deg, var(--gold), #b8860b);
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 5px;
            display: inline-block;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .stat-rank.no-data {
            background: #adb5bd;
        }

        @media (max-width: 767px) {
            .stat-card-mini {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 10px 15px;
                text-align: left;
            }

            .stat-label-mini {
                margin-bottom: 0;
                flex: 1;
            }

            .stat-value-mini {
                font-size: 1.1rem;
                margin: 0 10px;
                flex: 1;
                text-align: right;
            }

            .stat-rank {
                margin-top: 0;
                font-size: 0.65rem;
                min-width: 60px;
                text-align: center;
            }
        }

        /* „Éê„ÉÉ„Ç∏‰∏ÄË¶ß„ÅÆ„Çπ„Çø„Ç§„É´ */
        .badge-item {
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
            border-radius: 12px;
            padding: 8px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .badge-item:hover {
            transform: scale(1.05);
            background: #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .badge-item.equipped {
            border-color: rgba(212, 165, 116, 0.4);
            background: #fff9e6;
        }

        .badge-item.selected {
            border-color: var(--gold) !important;
            background: #fff !important;
            box-shadow: 0 0 0 3px rgba(211, 168, 83, 0.5) !important;
            transform: scale(1.05);
        }

        .badge-item img {
            width: 70px;
            height: 70px;
            object-fit: contain;
            display: block;
        }

        .badge-count-overlay {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            border: 2px solid white;
            z-index: 10;
        }

        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç™„Éº„Éê„Éº„É¨„Ç§ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s;
        }

        .loading-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        /* „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„É™„Çπ„Éà */
        .user-select-item {
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
        }

        .user-select-item:hover {
            background-color: #f8f9fa;
        }


        .user-select-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 2px solid var(--gold);
        }

        .user-select-badge {
            width: 24px;
            height: 24px;
            object-fit: contain;
            margin-left: 8px;
        }

        .user-select-name {
            font-weight: 700;
            color: var(--deep-purple);
            font-size: 1rem;
        }

        /* „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ */
        .nav-dropdown {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .record-button {
            background: linear-gradient(135deg, var(--gold) 0%, #b8892d 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 6px 20px rgba(212, 168, 83, 0.5);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            cursor: pointer;
        }

        .record-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 168, 83, 0.6);
            color: white;
        }

        .nav-dropdown-menu {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            min-width: 200px;
            overflow: hidden;
        }

        .nav-dropdown-menu .dropdown-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            transition: background 0.2s;
        }

        .nav-dropdown-menu .dropdown-item:hover {
            background: #f5f5f5;
        }

        .nav-dropdown-menu .dropdown-divider {
            margin: 0;
        }

        .notification-badge {
            background: #dc3545;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
        }

        /* „É¨„Ç¢„É™„ÉÜ„Ç£Âà•ËÉåÊôØËâ≤ */
        .rarity-wood {
            background: #d7ccc8 !important;
            color: #5d4037 !important;
            border-color: #8d6e63 !important;
        }

        .rarity-stone {
            background: #cfd8dc !important;
            color: #455a64 !important;
            border-color: #90a4ae !important;
        }

        .rarity-bronze {
            background: #ffe0b2 !important;
            color: #e65100 !important;
            border-color: #ffb74d !important;
        }

        .rarity-silver {
            background: #f5f5f5 !important;
            color: #616161 !important;
            border-color: #bdbdbd !important;
        }

        .rarity-gold {
            background: linear-gradient(135deg, #fff9c4 0%, #fbc02d 100%) !important;
            color: #f57f17 !important;
            border-color: #fdd835 !important;
        }

        .rarity-platinum {
            background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%) !important;
            color: #0277bd !important;
            border-color: #4fc3f7 !important;
        }

        .rarity-gem {
            background: linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%) !important;
            color: #7b1fa2 !important;
            border-color: #ba68c8 !important;
            box-shadow: 0 0 15px rgba(186, 104, 200, 0.4);
        }

        .rarity-legend {
            background: linear-gradient(135deg, #fff9c4 0%, #fbc02d 50%, #f9a825 100%) !important;
            color: #f57f17 !important;
            border-color: #ffd700 !important;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .rarity-fantasy {
            background: linear-gradient(135deg, #e1f5fe 0%, #81d4fa 50%, #4fc3f7 100%) !important;
            color: #01579b !important;
            border-color: #00bcd4 !important;
            box-shadow: 0 0 25px rgba(0, 188, 212, 0.5);
        }

        .rarity-supreme {
            background: linear-gradient(135deg, #fce4ec 0%, #f06292 50%, #e91e63 100%) !important;
            color: #880e4f !important;
            border-color: #ff4081 !important;
            box-shadow: 0 0 30px rgba(255, 64, 129, 0.6);
        }

        .rarity-mythic {
            background: linear-gradient(135deg, #fffde7 0%, #fff176 50%, #ffd600 100%) !important;
            color: #f57f17 !important;
            border-color: #ffea00 !important;
            box-shadow: 0 0 40px rgba(255, 234, 0, 0.7);
        }

        .rarity-void {
            background: #000 !important;
            color: #fff !important;
            border-color: #333 !important;
        }





        /* „Éó„É¨„Éü„Ç¢„É†„Éª„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ */
        .pagination-premium .page-link {
            border: none;
            margin: 0 4px;
            border-radius: 8px !important;
            color: var(--deep-purple);
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .pagination-premium .page-item.active .page-link {
            background: linear-gradient(135deg, var(--deep-purple), var(--soft-purple));
            color: white !important;
            box-shadow: 0 4px 10px rgba(106, 17, 203, 0.3);
        }

        /* „Éê„ÉÉ„Ç∏„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ÔºàÊîπÂñÑ„Éá„Ç∂„Ç§„É≥Ôºâ */
        .btn-badge-action {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border: 2px solid;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-badge-action i {
            font-size: 1.1rem;
        }

        .btn-badge-transfer {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }

        .btn-badge-transfer:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            border-color: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            color: white;
        }

        .btn-badge-sell {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-color: #f5576c;
            color: white;
        }

        .btn-badge-sell:hover {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
            border-color: #f093fb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
            color: white;
        }

        .btn-badge-equip {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-color: #fdcb6e;
            color: #2d3436;
        }

        .btn-badge-equip:hover {
            background: linear-gradient(135deg, #fdcb6e 0%, #ffeaa7 100%);
            border-color: #fdcb6e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(253, 203, 110, 0.4);
        }

        /* „Çª„ÇØ„Ç∑„Éß„É≥„Éò„ÉÉ„ÉÄ„Éº */
        .badge-section-header {
            cursor: pointer;
            padding: 8px 0;
            transition: all 0.2s;
            user-select: none;
        }

        .badge-section-header:hover {
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
            padding-left: 8px;
        }

        /* „Éê„ÉÉ„Ç∏„Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´ */
        .badge-control-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .badge-control-panel .form-control,
        .badge-control-panel .form-select {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: white;
        }

        .badge-control-panel .form-control:focus,
        .badge-control-panel .form-select:focus {
            border-color: var(--deep-purple);
            box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.1);
            outline: none;
        }

        /* „Éü„É•„Éº„Çø„É≥„Éà„Éï„Ç£„É´„Çø„Éº„Éú„Çø„É≥ */
        .btn-mutant-filter {
            background: white;
            border: 2px solid #dee2e6;
            color: #333;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
            white-space: nowrap;
        }

        .btn-mutant-filter:hover {
            border-color: var(--deep-purple);
            background: rgba(106, 17, 203, 0.05);
            transform: translateY(-1px);
        }

        .btn-mutant-filter.active {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%) !important;
            color: #2d3436 !important;
            border-color: transparent !important;
            box-shadow: 0 4px 15px rgba(255, 165, 0, 0.4);
            transform: scale(1.02);
        }

        .btn-mutant-filter.active::before {
            content: "‚≠ê ";
        }

        /* „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥„ÅÆ„Éó„É¨„Éü„Ç¢„É†„Çπ„Çø„Ç§„É´ */
        .pagination-premium {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 4px;
            margin-bottom: 0;
            padding: 0;
            list-style: none;
        }

        .pagination-premium .page-item {
            margin: 0 !important;
        }

        .pagination-premium .page-link {
            border: none;
            background: white;
            color: var(--deep-purple);
            border-radius: 8px !important;
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .pagination-premium .page-item.active .page-link {
            background: var(--primary-gradient) !important;
            color: white !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .pagination-premium .page-item.disabled .page-link {
            opacity: 0.5;
            pointer-events: none;
        }

        @media (max-width: 576px) {
            .pagination-premium {
                gap: 2px;
            }

            .pagination-premium .page-link {
                min-width: 28px;
                height: 28px;
                font-size: 0.75rem;
            }
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñË™øÊï¥ */
        @media (max-width: 767px) {
            .badge-control-panel {
                padding: 12px;
            }

            .badge-control-panel .form-control,
            .badge-control-panel .form-select,
            .badge-control-panel .form-check {
                font-size: 0.85rem;
            }
        }

        /* „Éï„Ç£„É´„Çø„Éº„Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´ */
        .badge-control-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #e9ecef;
        }

        /* „É¢„Éê„Ç§„É´ÂØæÂøú„ÅÆ„Ç∞„É™„ÉÉ„Éâ */
        @media (max-width: 767px) {

            /* „Éê„ÉÉ„Ç∏„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„ÅÆ„Ç∞„É™„ÉÉ„Éâ: 2ÂàóÂõ∫ÂÆö */
            #special-badge-list>div,
            #convertible-badge-list>div,
            #purchasable-badge-list>div {
                flex: 0 0 50% !important;
                max-width: 50% !important;
            }

            /* „Éú„Çø„É≥„ÇíÁ∏¶‰∏¶„Å≥„Å´ */
            .btn-badge-action {
                flex: 1;
                min-width: 0;
                justify-content: center;
            }

            /* „Éï„Ç£„É´„Çø„Éº„Ç≥„É≥„Éà„É≠„Éº„É´„Çí„É¢„Éê„Ç§„É´ÊúÄÈÅ©Âåñ */
            .badge-control-panel .row>div {
                margin-bottom: 8px;
            }

            .badge-control-panel select,
            .badge-control-panel input {
                font-size: 0.85rem;
            }
        }

        /* PCÁâà„Åß„ÅØ4Âàó */
        @media (min-width: 768px) {
            #purchasable-badge-list>div {
                flex: 0 0 25% !important;
                max-width: 25% !important;
            }
        }
    </style>
</head>

<body>
    <!-- Âè≥‰∏ä„ÅÆ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥ -->
    <div class="nav-dropdown dropdown">
        <button class="record-button dropdown-toggle" type="button" id="navDropdown" data-bs-toggle="dropdown"
            aria-expanded="false">
            üìù „É°„Éã„É•„Éº
        </button>
        <ul class="dropdown-menu nav-dropdown-menu dropdown-menu-end" aria-labelledby="navDropdown">
            <li><a class="dropdown-item" href="../index.html">üè† „Éõ„Éº„É†„Å´Êàª„Çã</a></li>
            <li><a class="dropdown-item" href="./index.html">üë§ „Éû„Ç§„Éö„Éº„Ç∏</a></li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="../mahjong/index.html">üìä „É©„É≥„Ç≠„É≥„Ç∞</a></li>
            <li><a class="dropdown-item" href="../mahjong/record.html">üìù Ë®òÈå≤„Åô„Çã</a></li>
            <li><a class="dropdown-item" href="../mahjong/users/index.html">üë• „É¶„Éº„Ç∂„Éº‰∏ÄË¶ß</a></li>
            <li><a class="dropdown-item" href="../mahjong/team/index.html">üèÖ „ÉÅ„Éº„É†ÁÆ°ÁêÜ <span id="team-notification-badge"
                        class="notification-badge" style="display:none;">0</span></a></li>
            <li><a class="dropdown-item" href="../badge/list.html">üìõ „Éê„ÉÉ„Ç∏‰∏ÄË¶ß</a></li>
            <li><a class="dropdown-item" href="../badge/shop.html">üõí „Éê„ÉÉ„Ç∏„Ç∑„Éß„ÉÉ„Éó</a></li>
            <li><a class="dropdown-item" href="../ranking/index.html">üí∞ Ë≥áÁî£„É©„É≥„Ç≠„É≥„Ç∞</a></li>
            <li class="admin-only" style="display:none;"><a class="dropdown-item" href="../omikuji/index.html">üéã
                    „Åä„Åø„Åè„Åò</a></li>
            <li class="admin-only" style="display:none;">
                <hr class="dropdown-divider">
            </li>
            <li class="admin-only" style="display:none;">
                <a class="dropdown-item" href="../admin/index.html">‚öôÔ∏è ÁÆ°ÁêÜÁîªÈù¢</a>
            </li>
        </ul>
    </div>

    <div class="container py-5">
        <!-- Êàª„Çã„Éú„Çø„É≥ -->
        <div class="mb-4">
            <a href="#" onclick="goBack(); return false;" class="back-button">
                ‚Üê Êàª„Çã
            </a>
        </div>


        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <header class="text-center mb-5">
            <h1 class="page-header display-4 fw-bold mb-3">üë§ „Éû„Ç§„Éö„Éº„Ç∏</h1>
        </header>

        <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">

                <!-- Êú™„É≠„Ç∞„Ç§„É≥ÊôÇ -->
                <div id="login-prompt" class="profile-card login-prompt" style="display: none;">
                    <h3 class="mb-4" style="font-family: var(--font-title); color: var(--deep-purple);">
                        „É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                    </h3>
                    <p class="text-muted mb-4">
                        „Éû„Ç§„Éö„Éº„Ç∏„ÇíË°®Á§∫„Åô„Çã„Å´„ÅØDiscord„Åß„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ
                    </p>
                    <button onclick="loginWithDiscord()" class="login-prompt-btn">
                        <img src="https://assets-global.website-files.com/6257adef93867e50d84d30e2/636e0a69f118df70ad7828d4_icon_clyde_blurple_RGB.svg"
                            alt="Discord" style="width: 24px;">
                        Discord„Åß„É≠„Ç∞„Ç§„É≥
                    </button>
                </div>

                <!-- „É≠„Ç∞„Ç§„É≥Ê∏à„ÅøÔºà„Åæ„Åü„ÅØÈñ≤Ë¶ß„É¢„Éº„ÉâÔºâ -->
                <div id="profile-content" style="display: none;">
                    <div class="profile-card mb-4">
                        <!-- ‰∏äÊÆµ: „Éê„ÉÉ„Ç∏ + ÂêçÂâç + „Éê„ÉÉ„Ç∏ + Á∑®ÈõÜ„Éú„Çø„É≥ -->
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center gap-2 flex-grow-1" style="min-width: 0;">
                                <div id="badge-container-left" class="mutant-badge-container">
                                    <img id="user-equipped-badge" src="" alt=""
                                        style="width: 36px; height: 36px; border-radius: 8px; display: none;" title="">
                                    <div class="mutant-badge-shine" style="display: none;"></div>
                                </div>
                                <h2 id="user-name" class="mb-0 text-truncate"
                                    style="font-family: var(--font-title); color: var(--deep-purple); font-size: 1.4rem; text-transform: none !important;">
                                    „É¶„Éº„Ç∂„ÉºÂêç
                                </h2>
                                <div id="badge-container-right" class="mutant-badge-container">
                                    <img id="user-equipped-badge-right" src="" alt=""
                                        style="width: 36px; height: 36px; border-radius: 8px; display: none;" title="">
                                    <div class="mutant-badge-shine" style="display: none;"></div>
                                </div>
                            </div>
                            <button id="nickname-edit-btn" onclick="openNicknameModal()"
                                class="btn btn-sm btn-outline-secondary flex-shrink-0" title="„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂ§âÊõ¥"
                                style="display: none; padding: 4px 10px;">
                                ‚úèÔ∏è
                            </button>
                        </div>

                        <!-- ‰∏ãÊÆµ: „Ç¢„Éê„Çø„Éº + ÊÉÖÂ†± -->
                        <div class="row align-items-start">
                            <div class="col-auto">
                                <div class="text-center">
                                    <img id="user-avatar" src="" alt="„Ç¢„Éê„Çø„Éº" class="avatar-large">
                                    <button id="sync-btn" onclick="updateAvatar()"
                                        class="btn btn-sm btn-outline-secondary mt-2" title="Discord„Åã„ÇâÊúÄÊñ∞„ÅÆ„Ç¢„Éê„Çø„ÉºÁîªÂÉè„ÇíÂèñÂæó"
                                        style="font-size: 0.7rem; padding: 3px 8px;">
                                        üîÑ ÂêåÊúü
                                    </button>
                                </div>
                            </div>
                            <div class="col">
                                <!-- Removed Player label -->
                                <h2 id="page-title-label" class="small text-muted mb-1" style="display:none;"></h2>

                                <!-- „ÉÅ„Éº„É†Âêç -->
                                <div id="user-team-display" class="mb-2">
                                    <span class="badge bg-secondary" style="font-size: 0.85rem;">
                                        üè† <span id="user-team-name">Êú™ÊâÄÂ±û</span>
                                    </span>
                                </div>

                                <!-- ÊâÄÊåÅÈáë -->
                                <div id="user-coins-display" class="mb-2"
                                    style="display: none; flex-wrap: wrap; gap: 8px; align-items: center;">
                                    <span class="badge bg-light text-dark shadow-sm"
                                        style="font-size: 0.85rem; border: 1px solid var(--gold); padding: 6px 12px;">
                                        ÊâÄÊåÅÈáë: ü™ô <span id="user-coins-value">0</span>
                                    </span>
                                    <span class="badge bg-light text-dark shadow-sm"
                                        style="font-size: 0.85rem; border: 1px solid #17a2b8; padding: 6px 12px;">
                                        Á∑èË≥áÁî£: üìä <span id="total-assets-value">0</span>
                                    </span>
                                    <span class="badge bg-light text-dark shadow-sm"
                                        style="font-size: 0.85rem; border: 1px solid #ffc107; padding: 6px 12px;">
                                        Á•àÈ°òÁ¨¶: üßß <span id="user-tickets-value">0</span>
                                    </span>
                                    <div class="d-flex gap-2">
                                        <button id="coin-transfer-btn" onclick="openCoinTransferModal()"
                                            class="btn btn-sm btn-outline-primary"
                                            style="display: none; padding: 2px 8px; font-size: 0.75rem;">
                                            üí∏ ÈÄÅÈáë
                                        </button>
                                        <button id="possessions-btn" onclick="openPossessionsModal()"
                                            class="btn btn-sm btn-outline-warning"
                                            style="display: none; padding: 2px 8px; font-size: 0.75rem;">
                                            üéÅ ÊâÄÊåÅÂìÅ
                                        </button>
                                    </div>
                                </div>

                                <!-- Removed view-area with Mahjong Player label -->
                            </div>
                        </div>
                    </div>

                    <!-- È∫ªÈõÄÁµ±Ë®à -->
                    <div class="profile-card mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                            <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0;">
                                üÄÑ È∫ªÈõÄÁµ±Ë®à
                            </h4>
                            <div class="d-flex gap-2 flex-wrap">
                                <div class="mahjong-filter-group">
                                    <label class="filter-label-mini">üèÜ Â§ß‰ºö</label>
                                    <select id="tournament-select" class="mahjong-filter-select"
                                        onchange="handleTournamentChange()">
                                        <!-- JS„ÅßÁîüÊàê -->
                                    </select>
                                </div>
                                <div class="mahjong-filter-group">
                                    <label class="filter-label-mini">üÄÑ ÂΩ¢Âºè</label>
                                    <select id="mode-select" class="mahjong-filter-select"
                                        onchange="handleModeChange()">
                                        <option value="individual_yonma" selected>ÂÄã‰∫∫Êà¶ÔºàÂõõÈ∫ªÔºâ</option>
                                        <option value="individual_sanma">ÂÄã‰∫∫Êà¶Ôºà‰∏âÈ∫ªÔºâ</option>
                                        <option value="team">„ÉÅ„Éº„É†Êà¶</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="stats-loading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
                            </div>
                        </div>

                        <div id="stats-content" style="display: none;">
                            <div id="stats-grid">
                                <!-- Row 1: ÂêàË®à„Çπ„Ç≥„Ç¢„ÄÄÂπ≥Âùá„Çπ„Ç≥„Ç¢„ÄÄÊúÄÂ§ß„Çπ„Ç≥„Ç¢ -->
                                <div class="row g-3 mb-3">
                                    <div class="col-12 col-md-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('all')">
                                            <div class="stat-label-mini">ÂêàË®à„Çπ„Ç≥„Ç¢</div>
                                            <div class="stat-value-mini" id="stat-total">-</div>
                                            <div class="stat-rank" id="rank-total">-</div>
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('avg_score')">
                                            <div class="stat-label-mini">Âπ≥Âùá„Çπ„Ç≥„Ç¢</div>
                                            <div class="stat-value-mini" id="stat-avg-score">-</div>
                                            <div class="stat-rank" id="rank-avg-score">-</div>
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('max_score')">
                                            <div class="stat-label-mini">ÊúÄÂ§ß„Çπ„Ç≥„Ç¢</div>
                                            <div class="stat-value-mini" id="stat-max-score">-</div>
                                            <div class="stat-rank" id="rank-max-score">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 2: Âíå‰∫ÜÁéá„ÄÄÊîæÈäÉÁéá„ÄÄ„Éê„É©„É≥„ÇπÈõÄÂäõ -->
                                <div class="row g-3 mb-3">
                                    <div class="col-12 col-md-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('win')">
                                            <div class="stat-label-mini">Âíå‰∫ÜÁéá</div>
                                            <div class="stat-value-mini" id="stat-win-rate">-</div>
                                            <div class="stat-rank" id="rank-win-rate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('deal')">
                                            <div class="stat-label-mini">ÊîæÈäÉÁéá</div>
                                            <div class="stat-value-mini" id="stat-deal-rate">-</div>
                                            <div class="stat-rank" id="rank-deal-rate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('skill')">
                                            <div class="stat-label-mini">„Éê„É©„É≥„ÇπÈõÄÂäõ</div>
                                            <div class="stat-value-mini" id="stat-skill">-</div>
                                            <div class="stat-rank" id="rank-skill">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 3: Âπ≥ÂùáÈ†Ü‰Ωç„ÄÄ„Éà„ÉÉ„ÉóÁéá„ÄÄ„É©„ÇπÂõûÈÅøÁéá -->
                                <div class="row g-3 mb-3">
                                    <div class="col-12 col-md-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('avg_rank')">
                                            <div class="stat-label-mini">Âπ≥ÂùáÈ†Ü‰Ωç</div>
                                            <div class="stat-value-mini" id="stat-avg-rank">-</div>
                                            <div class="stat-rank" id="rank-avg-rank">-</div>
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('top')">
                                            <div class="stat-label-mini">„Éà„ÉÉ„ÉóÁéá</div>
                                            <div class="stat-value-mini" id="stat-top-rate">-</div>
                                            <div class="stat-rank" id="rank-top-rate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('avoid')">
                                            <div class="stat-label-mini">„É©„ÇπÂõûÈÅøÁéá</div>
                                            <div class="stat-value-mini" id="stat-avoid-rate">-</div>
                                            <div class="stat-rank" id="rank-avoid-rate">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 4: Ë©¶ÂêàÊï∞„ÄÄÂ±ÄÊï∞„ÄÄ„É¨„Éº„ÉÜ„Ç£„É≥„Ç∞ -->
                                <div class="row g-3">
                                    <div class="col-12 col-md-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('match_count')">
                                            <div class="stat-label-mini">Ë©¶ÂêàÊï∞</div>
                                            <div class="stat-value-mini" id="stat-games">-</div>
                                            <div class="stat-rank" id="rank-games">-</div>
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-4">
                                        <div class="stat-card-mini" style="cursor: default;">
                                            <div class="stat-label-mini">Â±ÄÊï∞</div>
                                            <div class="stat-value-mini" id="stat-hands">-</div>
                                        </div>
                                    </div>
                                    <div class="col-12 col-md-4">
                                        <div class="stat-card-mini"
                                            style="background: linear-gradient(135deg, #f3e5f5, #fff); cursor: default;">
                                            <div class="stat-label-mini">üìä „É¨„Éº„ÉÜ„Ç£„É≥„Ç∞</div>
                                            <div class="stat-value-mini" id="stat-rating">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ÂØæÊà¶Áõ∏ÊâãÁµ±Ë®à -->
                                <div id="opponent-stats-section" class="mt-4 pt-3"
                                    style="border-top: 1px solid #eee; display: none;">
                                    <h6 class="text-muted mb-3" style="font-size: 1.1rem; font-weight: bold;">üéØ ÂØæÊà¶Áõ∏ÊâãÁµ±Ë®à
                                    </h6>

                                    <!-- ÂØæÊà¶ÂõûÊï∞„Éà„ÉÉ„Éó3 -->
                                    <div class="mb-3">
                                        <div class="small text-muted mb-2">„Çà„ÅèÂØæÊà¶„Åô„Çã„Éó„É¨„Ç§„É§„Éº</div>
                                        <div id="top-opponents-list" class="d-flex flex-wrap gap-2">
                                            <!-- JS„ÅßÁîüÊàê -->
                                        </div>
                                    </div>

                                    <!-- Áõ∏ÊÄßÁµ±Ë®à -->
                                    <div class="row g-2">
                                        <div class="col-12 col-md-6">
                                            <div class="p-2 rounded mb-1"
                                                style="background: linear-gradient(135deg, #e8f5e9, #fff); border: 1px solid #c8e6c9;">
                                                <div class="small text-muted mb-1">üî• ‰∏ÄÁï™Âãù„Å°Ë∂ä„Åó</div>
                                                <div id="best-matchup" class="d-flex align-items-center gap-2">
                                                    <span class="text-muted small">-</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <div class="p-2 rounded"
                                                style="background: linear-gradient(135deg, #ffebee, #fff); border: 1px solid #ffcdd2;">
                                                <div class="small text-muted mb-1">üíî ‰∏ÄÁï™Ë≤†„ÅëË∂ä„Åó</div>
                                                <div id="worst-matchup" class="d-flex align-items-center gap-2">
                                                    <span class="text-muted small">-</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="no-stats-msg" class="text-center text-muted py-3" style="display: none;">
                                „Åæ„Å†È∫ªÈõÄÂ§ß‰ºö„Å´ÂèÇÂä†„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì
                            </div>
                        </div>
                    </div>

                    <!-- „Éê„ÉÉ„Ç∏„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ -->
                    <div class="profile-card mb-4" id="badge-collection-section" style="display: none;">
                        <!-- „Çø„Ç§„Éà„É´Ë°å -->
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                            <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0;">
                                üìõ „Éê„ÉÉ„Ç∏„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥
                            </h4>
                            <div class="d-flex gap-2" id="badge-header-actions">
                                <button id="badge-change-btn" onclick="openBadgeChangeModal()"
                                    class="btn-badge-action btn-badge-equip" style="display: none;">
                                    <i class="bi bi-award"></i>
                                    <span>Ë£ÖÁùÄ</span>
                                </button>
                                <button id="badge-transfer-btn" onclick="openModernInventory('transfer')"
                                    class="btn-badge-action btn-badge-transfer" style="display: none;">
                                    <i class="bi bi-gift"></i>
                                    <span>Ë≠≤Ê∏°</span>
                                </button>
                                <button id="badge-sell-btn" onclick="openModernInventory('sell')"
                                    class="btn-badge-action btn-badge-sell" style="display: none;">
                                    <i class="bi bi-cash-coin"></i>
                                    <span>Â£≤Âç¥</span>
                                </button>
                            </div>
                        </div>

                        <!-- ÈôêÂÆö„Éê„ÉÉ„Ç∏ÔºàÊäò„ÇäÁï≥„ÅøÔºâ -->
                        <div id="special-badges-section" class="mb-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2 badge-section-header"
                                onclick="toggleBadgeSection('special')" style="cursor: pointer;">
                                <h6 class="text-muted mb-0" style="font-size: 0.9rem;">
                                    <span id="special-toggle-icon">‚ñ∂</span> üèÜ ÈôêÂÆö„Éê„ÉÉ„Ç∏
                                    <span id="special-count" class="badge bg-secondary ms-2">0</span>
                                </h6>
                            </div>
                            <div id="special-badge-content" style="display: none;">
                                <div id="special-badge-list" class="row g-3 mb-4">
                                    <!-- JS„ÅßÁîüÊàê -->
                                </div>
                            </div>
                        </div>

                        <!-- ÊèõÈáëÂìÅÔºàÊäò„ÇäÁï≥„ÅøÔºâ -->
                        <div id="convertible-badges-section" class="mb-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center mb-2 badge-section-header"
                                onclick="toggleBadgeSection('convertible')" style="cursor: pointer;">
                                <h6 class="text-muted mb-0" style="font-size: 0.9rem;">
                                    <span id="convertible-toggle-icon">‚ñ∂</span> üíé ÊèõÈáëÂìÅ
                                    <span id="convertible-count" class="badge bg-secondary ms-2">0</span>
                                </h6>
                            </div>
                            <div id="convertible-badge-content" style="display: none;">
                                <div id="convertible-badge-list" class="row g-3 mb-4">
                                    <!-- JS„ÅßÁîüÊàê -->
                                </div>
                            </div>
                        </div>

                        <!-- Ë≥ºÂÖ•„Éê„ÉÉ„Ç∏ -->
                        <div id="purchasable-badges-section" style="display: none;">
                            <h6 class="text-muted mb-3" style="font-size: 0.9rem;">üõí Ë≥ºÂÖ•„Éê„ÉÉ„Ç∏</h6>

                            <!-- „Éï„Ç£„É´„Çø„ÉºÔºÜ„ÇΩ„Éº„ÉàUI -->
                            <div class="badge-control-panel mb-3">
                                <div class="row g-2">
                                    <!-- Ê§úÁ¥¢„Éê„Éº -->
                                    <div class="col-12 col-md-3">
                                        <div class="position-relative">
                                            <i class="bi bi-search"
                                                style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #aaa;"></i>
                                            <input type="text" id="badge-search" class="form-control form-control-sm"
                                                style="padding-left: 35px;" placeholder="„Éê„ÉÉ„Ç∏Âêç„ÅßÊ§úÁ¥¢..."
                                                oninput="filterAndRenderBadges()">
                                        </div>
                                    </div>

                                    <!-- „ÇΩ„Éº„Éà -->
                                    <div class="col-6 col-md-3">
                                        <select id="badge-sort" class="form-select form-select-sm h-100"
                                            onchange="filterAndRenderBadges()">
                                            <option value="acquired_desc" selected>ÂÖ•ÊâãÈ†ÜÔºàÊñ∞‚ÜíÂè§Ôºâ</option>
                                            <option value="acquired_asc">ÂÖ•ÊâãÈ†ÜÔºàÂè§‚ÜíÊñ∞Ôºâ</option>
                                            <option value="number">„Éä„É≥„Éê„ÉºÈ†Ü</option>
                                            <option value="price_desc">‰æ°Ê†ºÈ†ÜÔºàÈ´ò‚Üí‰ΩéÔºâ</option>
                                            <option value="price_asc">‰æ°Ê†ºÈ†ÜÔºà‰Ωé‚ÜíÈ´òÔºâ</option>
                                            <option value="count">ÊâÄÊåÅÊï∞</option>
                                            <option value="circulation">ÊµÅÈÄöÊï∞</option>
                                        </select>
                                    </div>

                                    <!-- ÂΩ¢Âºè„Éï„Ç£„É´„Çø„Éº -->
                                    <div class="col-6 col-md-3">
                                        <select id="badge-type-filter" class="form-select form-select-sm h-100"
                                            onchange="filterAndRenderBadges()">
                                            <option value="">ÂΩ¢Âºè: „Åô„Åπ„Å¶</option>
                                            <option value="Â§âÂãïÂûã">Â§âÂãïÂûã</option>
                                            <option value="Âõ∫ÂÆöÂûã">Âõ∫ÂÆöÂûã</option>
                                            <option value="„Ç¨„ÉÅ„É£ÈôêÂÆö">„Ç¨„ÉÅ„É£ÈôêÂÆö</option>
                                        </select>
                                    </div>

                                    <!-- „Éü„É•„Éº„Çø„É≥„Éà„Éï„Ç£„É´„Çø„Éº -->
                                    <div class="col-12 col-md-3">
                                        <button id="filter-mutant-btn" class="btn btn-sm w-100 btn-mutant-filter py-1"
                                            onclick="toggleMutantFilter()"
                                            style="font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                            ‚ú® „Éü„É•„Éº„Çø„É≥„Éà
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- „Éê„ÉÉ„Ç∏„Ç∞„É™„ÉÉ„Éâ -->
                            <div id="purchasable-badge-list" class="row g-3">
                                <!-- JS„ÅßÁîüÊàê -->
                            </div>

                            <!-- „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ -->
                            <nav id="badge-pagination-area" class="mt-4" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                    <div class="text-muted small">
                                        <span id="badge-showing-info"></span>
                                    </div>
                                    <ul id="badge-pagination" class="pagination pagination-sm mb-0 pagination-premium">
                                        <!-- JS„ÅßÁîüÊàê -->
                                    </ul>
                                </div>
                            </nav>
                        </div>

                        <div id="no-badges-msg" class="text-center text-muted py-3" style="display: none;">
                            „Åæ„Å†„Éê„ÉÉ„Ç∏„ÇíÊåÅ„Å£„Å¶„ÅÑ„Åæ„Åõ„Çì
                        </div>
                    </div>

                    <!-- Ë≤©Â£≤ÂÆüÁ∏æ„Çª„ÇØ„Ç∑„Éß„É≥ -->
                    <div class="profile-card mb-4" id="revenue-section" style="display: none;">
                        <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0 0 15px 0;">
                            üí∞ Ë≤©Â£≤ÂÆüÁ∏æ
                        </h4>
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="stat-card-mini">
                                    <div class="stat-label-mini">Á¥ØË®àÂèéÁõä</div>
                                    <div class="stat-value-mini" id="total-revenue" style="color: #27ae60;">0</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card-mini">
                                    <div class="stat-label-mini">Ë≤©Â£≤ÂõûÊï∞</div>
                                    <div class="stat-value-mini" id="revenue-count">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÊúÄËøë„ÅÆÊ¥ªÂãï„Çª„ÇØ„Ç∑„Éß„É≥ (deployed 2026-01-12 13:27) -->
                    <div class="profile-card mb-4" id="activity-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                            <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0;">
                                üìã ÊúÄËøë„ÅÆÊ¥ªÂãï
                            </h4>
                            <select id="activity-action-filter" class="form-select form-select-sm"
                                style="width: auto; font-size: 0.8rem;" onchange="loadActivityLogs(1)">
                                <option value="all">üîç „Åô„Åπ„Å¶</option>
                                <option value="mahjong">üÄÑ È∫ªÈõÄ</option>
                                <option value="transfer">üí∏ ÈÄÅÈáë</option>
                                <option value="badge">üéÅ „Éê„ÉÉ„Ç∏</option>
                                <option value="gacha_draw">‚õ©Ô∏è „ÅäË≥ΩÈä≠</option>
                                <option value="omikuji">üéã „Åä„Åø„Åè„Åò</option>
                                <option value="royalty_receive">üíé Â£≤‰∏äÈÇÑÂÖÉ</option>
                            </select>
                        </div>
                        <div id="activity-list">
                            <div class="text-center text-muted py-3">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                        </div>
                        <nav id="activity-pagination-area" class="mt-4" style="display: none;">
                            <ul id="activity-pagination"
                                class="pagination pagination-sm justify-content-center pagination-premium"></ul>
                        </nav>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- „Éê„ÉÉ„Ç∏Â§âÊõ¥„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="badgeChangeModal" tabindex="-1" aria-labelledby="badgeChangeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="badgeChangeModalLabel">Ë£ÖÁùÄ„Éê„ÉÉ„Ç∏„ÇíÂ§âÊõ¥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <span class="badge bg-primary me-2" id="badge-position-indicator">‚óÄ Â∑¶„Å´Ë£ÖÁùÄ</span>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="badge-position" id="pos-left" value="left"
                                checked>
                            <label class="btn btn-outline-primary btn-sm" for="pos-left">‚óÄ Â∑¶</label>
                            <input type="radio" class="btn-check" name="badge-position" id="pos-right" value="right">
                            <label class="btn btn-outline-primary btn-sm" for="pos-right">Âè≥ ‚ñ∂</label>
                        </div>
                    </div>
                    <div id="badge-modal-list" class="row g-2">
                        <!-- JS„ÅßÁîüÊàê -->
                    </div>
                </div>
                <div class="text-center mt-3 d-grid gap-2">
                    <button class="btn btn-primary" id="btn-execute-equip" onclick="executeSelectedEquip()"
                        disabled>ÈÅ∏Êäû„Åó„Åü„Éê„ÉÉ„Ç∏„ÇíË£ÖÁùÄ</button>
                </div>
                <div class="text-center mt-3 d-flex justify-content-center gap-2">
                    <button class="btn btn-outline-danger btn-sm" onclick="equipBadge(null, 'left')">Â∑¶„ÇíÂ§ñ„Åô</button>
                    <button class="btn btn-outline-danger btn-sm" onclick="equipBadge(null, 'right')">Âè≥„ÇíÂ§ñ„Åô</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- „Éã„ÉÉ„ÇØ„Éç„Éº„É†Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="nicknameModal" tabindex="-1" aria-labelledby="nicknameModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nicknameModalLabel">„Éã„ÉÉ„ÇØ„Éç„Éº„É†Â§âÊõ¥</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label small text-muted">„É©„É≥„Ç≠„É≥„Ç∞Á≠â„ÅßË°®Á§∫„Åï„Çå„ÇãÂêçÂâç</label>
                    <input type="text" id="user-nickname" class="form-control mb-3" placeholder="„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÖ•Âäõ...">
                    <div class="d-grid gap-2">
                        <button onclick="useDiscordName()" class="btn btn-outline-secondary btn-sm">
                            DiscordÂêç„Çí‰ΩøÁî®
                        </button>
                        <button onclick="saveNickname()" class="btn btn-gold text-white fw-bold">
                            ‰øùÂ≠ò
                        </button>
                    </div>
                    <div id="save-msg" class="small mt-2 text-center" style="display:none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- ÊâÄÊåÅÂìÅ„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="possessionsModal" tabindex="-1" aria-labelledby="possessionsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="possessionsModalLabel">üéÅ „ÅÇ„Å™„Åü„ÅÆÊâÄÊåÅÂìÅ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6 class="fw-bold border-bottom pb-2">„ÉÅ„Ç±„ÉÉ„Éà</h6>
                        <div
                            class="d-flex align-items-center justify-content-between p-3 bg-light rounded shadow-sm border">
                            <div class="d-flex align-items-center gap-2">
                                <span style="font-size: 1.5rem;">üßß</span>
                                <div>
                                    <div class="fw-bold" style="color: var(--deep-purple);">Á•àÈ°òÁ¨¶</div>
                                    <div class="small text-muted">„ÅäË≥ΩÈä≠Ôºà„Ç¨„ÉÅ„É£Ôºâ„Çí1ÂõûÂºï„Åë„Åæ„Åô</div>
                                </div>
                            </div>
                            <div class="fs-4 fw-bold text-primary"><span id="modal-tickets-count">0</span> Êûö</div>
                        </div>
                    </div>

                    <div>
                        <h6 class="fw-bold border-bottom pb-2">ÂºïÊèõÂà∏</h6>
                        <div id="exchange-tickets-list" class="row g-3">
                            <!-- JS„ÅßÁîüÊàê -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase -->
    <!-- „Éê„ÉÉ„Ç∏Ë≠≤Ê∏°„ÉªÂ£≤Âç¥Áî®„Éê„ÉÉ„Ç∏ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="badgeActionModal" tabindex="-1" aria-labelledby="badgeActionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="badgeActionModalLabel">„Éê„ÉÉ„Ç∏„ÇíÈÅ∏Êäû</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="action-badge-list" class="row g-2">
                        <!-- JS„ÅßÁîüÊàê -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ (Ë≠≤Ê∏°„ÉªÈÄÅÈáëÁî®) -->
    <div class="modal fade" id="userSelectModal" tabindex="-1" aria-labelledby="userSelectModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userSelectModalLabel">Ë≠≤Ê∏°ÂÖà„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÈÅ∏Êäû</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="transfer-user-list" class="list-group list-group-flush">
                        <!-- JS„ÅßÁîüÊàê -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- „Ç≥„Ç§„É≥ÈÄÅÈáëÈáëÈ°çÂÖ•Âäõ„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="coinAmountModal" tabindex="-1" aria-labelledby="coinAmountModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="coinAmountModalLabel">ÈÄÅÈáëÈáëÈ°ç„ÇíÂÖ•Âäõ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="coin-transfer-target-name" class="fw-bold text-center mb-3"></p>
                    <div class="mb-3">
                        <label class="form-label">ÈÄÅÈáë„Åô„Çã„Ç≥„Ç§„É≥Êï∞</label>
                        <input type="number" id="coin-transfer-amount" class="form-control" placeholder="ÈáëÈ°ç..." min="1">
                        <div class="form-text mt-2 text-center">„ÅÇ„Å™„Åü„ÅÆÊâÄÊåÅÈáë: ü™ô <span id="my-coins-ref">0</span></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="button" class="btn btn-primary" onclick="executeCoinTransfer()">ÈÄÅÈáë„Åô„Çã</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SupabaseË®≠ÂÆö -->
    <script src="../js/supabase-config.js?v=20260112"></script>
    <script src="../js/badge-utils.js"></script>
    <script src="../js/auth-guard.js"></script>
    <!-- „Äê‰∏ÄÊôÇÁöÑ„Äë„Ç¢„É≥„Ç±„Éº„Éà„É¢„Éº„ÉÄ„É´ÔºàÊí§ÂéªÊôÇ„ÅØ‰∏ã1Ë°å„ÇíÂâäÈô§Ôºâ -->
    <script src="../js/survey-modal.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            initAccordionNav('../');
        });
    </script>

    <script>
        let isViewMode = false;
        let targetId = null;
        let allProfiles = []; // ÂÖ®„É¶„Éº„Ç∂„Éº„ÅÆ„Éó„É≠„Éï„Ç°„Ç§„É´„É™„Çπ„Éà
        let rarityThresholds = []; // „É¨„Ç¢„É™„ÉÜ„Ç£Â¢ÉÁïå„Éá„Éº„Çø

        /**
         * „Éö„Éº„Ç∏ÂàùÊúüÂåñ
         */
        async function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('user');

            // ÂÖ®„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæóÔºàÂêçÂâçËß£Ê±∫Áî®Ôºâ
            const [profilesRes, thresholdsRes] = await Promise.all([
                supabaseClient.from('profiles').select('discord_user_id, account_name, avatar_url, coins'),
                supabaseClient.from('rarity_thresholds').select('*').order('threshold_value', { ascending: true })
            ]);
            if (profilesRes.data) allProfiles = profilesRes.data;
            if (thresholdsRes.data) rarityThresholds = thresholdsRes.data;

            const user = await getCurrentUser();
            const myId = user?.user_metadata?.provider_id;

            // „Å™„Çä„Åô„Åæ„Åó‰∏≠„ÅÆ„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæó
            const impersonated = getImpersonatedUser();
            const effectiveId = impersonated ? impersonated.discord_user_id : myId;

            // URL„Éë„É©„É°„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà
            if (urlUserId) {
                targetId = urlUserId;
                // Ëá™ÂàÜ„Åß„ÇÇ„Å™„Çä„Åô„Åæ„ÅóÂØæË±°„Åß„ÇÇ„Å™„ÅÑÂ†¥Âêà„ÅØÈñ≤Ë¶ß„É¢„Éº„Éâ
                if (urlUserId !== myId && urlUserId !== (impersonated?.discord_user_id)) {
                    isViewMode = true;
                } else {
                    isViewMode = false;
                }
            } else {
                // URL„Éë„É©„É°„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊúâÂäπ„Å™„É¶„Éº„Ç∂„ÉºIDÔºà„Å™„Çä„Åô„Åæ„ÅóÂÑ™ÂÖàÔºâ
                targetId = effectiveId;
                isViewMode = false;
            }

            // UI„ÅÆÂü∫Êú¨Ë°®Á§∫Âàá„ÇäÊõø„Åà
            setupUI();

            // „Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
            if (isViewMode) {
                await loadTargetUserInfo();
            } else {
                if (user) {
                    await displayMyInfo(user);
                } else {
                    showLoginPrompt();
                    return;
                }
            }

            // È∫ªÈõÄÁµ±Ë®à„ÅÆË™≠„ÅøËæº„ÅøÔºàÂÖ±Êúâ„É≠„Ç∏„ÉÉ„ÇØÔºâ
            await loadMahjongStats();

            // „Éê„ÉÉ„Ç∏„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„ÅÆË™≠„ÅøËæº„Åø
            await loadOwnedBadges();

            // Ë≤©Â£≤ÂÆüÁ∏æ„ÅÆË™≠„ÅøËæº„Åø
            await loadRevenueStats();

            // ÊúÄËøë„ÅÆÊ¥ªÂãï„ÅÆË™≠„ÅøËæº„Åø
            await loadActivityLogs();
        }

        function setupUI() {
            const loginPrompt = document.getElementById('login-prompt');
            const profileContent = document.getElementById('profile-content');
            const viewArea = document.getElementById('view-area');
            const syncBtn = document.getElementById('sync-btn');
            const pageTitleLabel = document.getElementById('page-title-label');
            const pageHeader = document.querySelector('.page-header');
            const nicknameEditBtn = document.getElementById('nickname-edit-btn');

            if (profileContent) profileContent.style.display = 'block';
            if (loginPrompt) loginPrompt.style.display = 'none';

            if (isViewMode) {
                // Èñ≤Ë¶ß„É¢„Éº„ÉâË®≠ÂÆö
                if (viewArea) viewArea.style.display = 'block';
                if (syncBtn) syncBtn.style.display = 'none';
                if (pageTitleLabel) pageTitleLabel.style.display = 'block';
                if (pageHeader) pageHeader.textContent = 'üë§ „Éó„É¨„Ç§„É§„Éº„Éó„É≠„Éï„Ç£„Éº„É´';
                if (nicknameEditBtn) nicknameEditBtn.style.display = 'none';
            } else {
                // „Éû„Ç§„Éö„Éº„Ç∏Ë®≠ÂÆö
                if (viewArea) viewArea.style.display = 'none';
                if (syncBtn) syncBtn.style.display = 'inline-block';
                if (pageTitleLabel) pageTitleLabel.style.display = 'none';
                if (pageHeader) pageHeader.textContent = 'üë§ „Éû„Ç§„Éö„Éº„Ç∏';
                if (nicknameEditBtn) nicknameEditBtn.style.display = 'inline-block';
                const coinTransferBtn = document.getElementById('coin-transfer-btn');
                if (coinTransferBtn) coinTransferBtn.style.display = 'inline-block';
                const possessionsBtn = document.getElementById('possessions-btn');
                if (possessionsBtn) possessionsBtn.style.display = 'inline-block';
            }
        }

        function showLoginPrompt() {
            document.getElementById('login-prompt').style.display = 'block';
            document.getElementById('profile-content').style.display = 'none';
        }

        /**
         * Ë£ÖÂÇô‰∏≠„Éê„ÉÉ„Ç∏„Å´„Éü„É•„Éº„Çø„É≥„Éà„Ç®„Éï„Çß„ÇØ„Éà„ÇíÈÅ©Áî®
         */
        async function applyMutantEffect(containerId, badgeId, userId) {
            const container = document.getElementById(containerId);
            const shine = container ? container.querySelector('.mutant-badge-shine') : null;
            if (!container || !shine) return;

            if (!badgeId || !userId) {
                container.classList.remove('active');
                shine.style.display = 'none';
                return;
            }

            try {
                const { data } = await supabaseClient
                    .from('user_badges_new')
                    .select('uuid')
                    .eq('user_id', userId)
                    .eq('badge_id', badgeId)
                    .eq('is_mutant', true)
                    .limit(1);

                const isMutant = data && data.length > 0;

                if (isMutant) {
                    container.classList.add('active');
                    shine.style.display = 'block';
                } else {
                    container.classList.remove('active');
                    shine.style.display = 'none';
                }
            } catch (err) {
                console.error('Mutant effect check failed:', err);
            }
        }

        /**
         * Ëá™ÂàÜÔºà„Åæ„Åü„ÅØ„Å™„Çä„Åô„Åæ„Åó„É¶„Éº„Ç∂„ÉºÔºâ„ÅÆÊÉÖÂ†±„ÇíË°®Á§∫
         */
        async function displayMyInfo(user) {
            const discordUser = user.user_metadata;
            const impersonated = getImpersonatedUser();

            // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅÆÂèñÂæóÔºà„Éê„ÉÉ„Ç∏ÊÉÖÂ†±„Éª„Ç≥„Ç§„É≥„Éª„ÉÅ„Éº„É†ÊÉÖÂ†±„ÇíÂê´„ÇÄÔºâ
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('account_name, avatar_url, coins, total_assets, gacha_tickets, exchange_tickets, equipped_badge_id, equipped_badge_id_right, team_id, badges!equipped_badge_id(image_url, name), badges_right:badges!equipped_badge_id_right(image_url, name), teams!team_id(team_name, logo_badge:badges!logo_badge_id(image_url))')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            // allProfiles „Å´„ÇÇÊúÄÊñ∞ÊÉÖÂ†±„ÇíÂêåÊúü
            if (profile) {
                const pIdx = allProfiles.findIndex(p => p.discord_user_id === targetId);
                if (pIdx !== -1) {
                    allProfiles[pIdx] = { ...allProfiles[pIdx], ...profile };
                }
            }

            // „Ç¢„Éê„Çø„ÉºÔºà„Å™„Çä„Åô„Åæ„Åó‰∏≠„ÅØDB„Åã„Çâ„ÄÅ„Åù„ÅÜ„Åß„Å™„Åë„Çå„Å∞DiscordÔºâ
            const avatarUrl = impersonated
                ? (profile?.avatar_url || 'https://via.placeholder.com/150')
                : (discordUser.avatar_url || 'https://via.placeholder.com/150');
            document.getElementById('user-avatar').src = avatarUrl;

            // ÂêçÂâçÔºà„Å™„Çä„Åô„Åæ„Åó‰∏≠„ÅØ„Å™„Çä„Åô„Åæ„Åó„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂÑ™ÂÖàÔºâ
            const name = impersonated
                ? (impersonated.name || profile?.account_name || '„É¶„Éº„Ç∂„Éº')
                : (profile?.account_name || discordUser.full_name || discordUser.name || '„É¶„Éº„Ç∂„Éº');
            const coins = profile?.coins || 0;

            // ÂêçÂâç„ÅÆ„ÅøË°®Á§∫Ôºà„Éê„ÉÉ„Ç∏„ÅØÂà•Ë¶ÅÁ¥†Ôºâ
            document.getElementById('user-name').textContent = name;

            // „ÉÅ„Éº„É†Âêç„Å®„Ç¢„Ç§„Ç≥„É≥„ÇíË°®Á§∫
            const team = profile?.teams;
            const teamName = team?.team_name || 'Êú™ÊâÄÂ±û';
            let logoHtml = 'üè† ';
            if (team && team.logo_badge && team.logo_badge.image_url) {
                logoHtml = `<img src="${team.logo_badge.image_url}" alt="logo" style="width: 20px; height: 20px; object-fit: contain; margin-right: 4px;"> `;
            }

            const teamDisplayEl = document.getElementById('user-team-display');
            if (teamDisplayEl) {
                const badgeEl = teamDisplayEl.querySelector('.badge');
                if (badgeEl) {
                    badgeEl.innerHTML = `${logoHtml}<span id="user-team-name">${teamName}</span>`;
                }
            } else {
                // Fallback
                const teamNameEl = document.getElementById('user-team-name');
                if (teamNameEl) teamNameEl.textContent = teamName;
            }

            // Â∑¶„Éê„ÉÉ„Ç∏ÁîªÂÉè„ÇíË®≠ÂÆö
            const badgeImg = document.getElementById('user-equipped-badge');
            const badge = profile?.badges;
            if (badgeImg && badge) {
                badgeImg.src = badge.image_url;
                badgeImg.title = badge.name;
                badgeImg.style.display = 'block';
                applyMutantEffect('badge-container-left', profile.equipped_badge_id, targetId);
            } else if (badgeImg) {
                badgeImg.style.display = 'none';
                applyMutantEffect('badge-container-left', null, null);
            }

            // Âè≥„Éê„ÉÉ„Ç∏ÁîªÂÉè„ÇíË®≠ÂÆö
            const badgeImgRight = document.getElementById('user-equipped-badge-right');
            const badgeRight = profile?.badges_right;
            if (badgeImgRight && badgeRight) {
                badgeImgRight.src = badgeRight.image_url;
                badgeImgRight.title = badgeRight.name;
                badgeImgRight.style.display = 'block';
                applyMutantEffect('badge-container-right', profile.equipped_badge_id_right, targetId);
            } else if (badgeImgRight) {
                badgeImgRight.style.display = 'none';
                applyMutantEffect('badge-container-right', null, null);
            }



            // „Ç≥„Ç§„É≥Ë°®Á§∫„ÅÆÊõ¥Êñ∞
            const coinsDisplay = document.getElementById('user-coins-display');
            const coinsValue = document.getElementById('user-coins-value');
            const totalAssetsValue = document.getElementById('total-assets-value');
            const ticketsValue = document.getElementById('user-tickets-value');
            if (coinsDisplay && coinsValue) {
                coinsValue.textContent = coins.toLocaleString();
                // Á∑èË≥áÁî£„ÅØ loadBadgeCollection „ÅßË®àÁÆóÂæå„Å´Êõ¥Êñ∞„Åï„Çå„ÇãÔºà„Åì„Åì„Åß„ÅØË®≠ÂÆö„Åó„Å™„ÅÑÔºâ
                if (totalAssetsValue) {
                    totalAssetsValue.textContent = '-';
                }
                if (ticketsValue) {
                    ticketsValue.textContent = (profile?.gacha_tickets || 0).toLocaleString();
                }
                coinsDisplay.style.display = 'block';
            }

            // „Éã„ÉÉ„ÇØ„Éç„Éº„É†Á∑®ÈõÜ„Éú„Çø„É≥„ÇíË°®Á§∫
            const nicknameEditBtn = document.getElementById('nickname-edit-btn');
            if (nicknameEditBtn) {
                nicknameEditBtn.style.display = 'inline-block';
            }

            if (profile?.account_name) {
                document.getElementById('user-nickname').value = profile.account_name;
            }
        }

        // „Éã„ÉÉ„ÇØ„Éç„Éº„É†Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openNicknameModal() {
            const modalEl = document.getElementById('nicknameModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }

        /**
         * ‰ªñ‰∫∫„ÅÆÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶Ë°®Á§∫
         */
        async function loadTargetUserInfo() {
            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('discord_user_id, account_name, avatar_url, coins, total_assets, gacha_tickets, exchange_tickets, equipped_badge_id, equipped_badge_id_right, team_id, badges!equipped_badge_id(image_url, name), badges_right:badges!equipped_badge_id_right(image_url, name), teams!team_id(team_name, logo_badge:badges!logo_badge_id(image_url))')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            // allProfiles „Å´„ÇÇÊúÄÊñ∞ÊÉÖÂ†±„ÇíÂêåÊúü
            if (profile) {
                const pIdx = allProfiles.findIndex(p => p.discord_user_id === targetId);
                if (pIdx !== -1) {
                    allProfiles[pIdx] = { ...allProfiles[pIdx], ...profile };
                }

                // Ë£ÖÁùÄ„Éê„ÉÉ„Ç∏„ÅåÊâÄÊåÅ„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™çÔºàÊâÄÊåÅ„Åó„Å¶„ÅÑ„Å™„Åë„Çå„Å∞Ëá™Âãï„ÅßÂ§ñ„ÅôÔºâ
                if (!isViewMode && (profile.equipped_badge_id || profile.equipped_badge_id_right)) {
                    const { data: ownedBadges } = await supabaseClient
                        .from('user_badges_new')
                        .select('badge_id')
                        .eq('user_id', targetId);

                    const ownedIds = (ownedBadges || []).map(b => b.badge_id);
                    let updateNeeded = {};

                    if (profile.equipped_badge_id && !ownedIds.includes(profile.equipped_badge_id)) {
                        updateNeeded.equipped_badge_id = null;
                    }
                    if (profile.equipped_badge_id_right && !ownedIds.includes(profile.equipped_badge_id_right)) {
                        updateNeeded.equipped_badge_id_right = null;
                    }

                    if (Object.keys(updateNeeded).length > 0) {
                        await supabaseClient
                            .from('profiles')
                            .update(updateNeeded)
                            .eq('discord_user_id', targetId);
                        // Êõ¥Êñ∞„Åó„Åü„Çâ„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÂÜçÂèñÂæó
                        return loadTargetUserInfo();
                    }
                }
            }

            if (profile) {
                document.getElementById('user-avatar').src = profile.avatar_url || 'https://via.placeholder.com/150';

                // ÂêçÂâç„ÇíË®≠ÂÆö
                document.getElementById('user-name').textContent = profile.account_name || 'ÂêçÁß∞Êú™Ë®≠ÂÆö';

                // Â∑¶„Éê„ÉÉ„Ç∏ÁîªÂÉè„ÇíË®≠ÂÆö
                const badgeImg = document.getElementById('user-equipped-badge');
                const badge = profile?.badges;
                if (badgeImg && badge) {
                    badgeImg.src = badge.image_url;
                    badgeImg.title = badge.name;
                    badgeImg.style.display = 'block';
                    applyMutantEffect('badge-container-left', profile.equipped_badge_id, targetId);
                } else if (badgeImg) {
                    badgeImg.style.display = 'none';
                    applyMutantEffect('badge-container-left', null, null);
                }

                // Âè≥„Éê„ÉÉ„Ç∏ÁîªÂÉè„ÇíË®≠ÂÆö
                const badgeImgRight = document.getElementById('user-equipped-badge-right');
                const badgeRight = profile?.badges_right;
                if (badgeImgRight && badgeRight) {
                    badgeImgRight.src = badgeRight.image_url;
                    badgeImgRight.title = badgeRight.name;
                    badgeImgRight.style.display = 'block';
                    applyMutantEffect('badge-container-right', profile.equipped_badge_id_right, targetId);
                } else if (badgeImgRight) {
                    badgeImgRight.style.display = 'none';
                    applyMutantEffect('badge-container-right', null, null);
                }

                // „ÉÅ„Éº„É†Âêç„ÇíË®≠ÂÆö
                const teamNameEl = document.getElementById('user-team-name');
                const teamDisplayEl = document.getElementById('user-team-display');
                if (teamNameEl) {
                    const team = profile?.teams;
                    const teamName = team?.team_name || 'Êú™ÊâÄÂ±û';

                    let logoHtml = 'üè† ';
                    if (team && team.logo_badge && team.logo_badge.image_url) {
                        logoHtml = `<img src="${team.logo_badge.image_url}" alt="logo" style="width: 20px; height: 20px; object-fit: contain; margin-right: 4px;"> `;
                    }

                    // Ë¶™Ë¶ÅÁ¥†„ÅÆbadge„ÅÆ‰∏≠Ë∫´„ÇíÊõ∏„ÅçÊèõ„Åà„Çã
                    const badgeEl = teamDisplayEl.querySelector('.badge');
                    if (badgeEl) {
                        badgeEl.innerHTML = `${logoHtml}<span id="user-team-name">${teamName}</span>`;
                    } else {
                        teamNameEl.textContent = teamName;
                    }
                }

                // „Ç≥„Ç§„É≥Ë°®Á§∫„ÅÆÊõ¥Êñ∞
                const coins = profile?.coins || 0;
                const coinsDisplay = document.getElementById('user-coins-display');
                const coinsValue = document.getElementById('user-coins-value');
                const totalAssetsValue = document.getElementById('total-assets-value');
                const ticketsValue = document.getElementById('user-tickets-value');
                if (coinsDisplay && coinsValue) {
                    coinsValue.textContent = coins.toLocaleString();
                    // Á∑èË≥áÁî£„ÅØ loadBadgeCollection „ÅßË®àÁÆóÂæå„Å´Êõ¥Êñ∞„Åï„Çå„Çã
                    // Ë™≠„ÅøËæº„ÅøÂâç„ÅØ„Äå-„Äç„ÇíË°®Á§∫
                    if (totalAssetsValue) {
                        totalAssetsValue.textContent = '-';
                    }
                    if (ticketsValue) {
                        ticketsValue.textContent = (profile?.gacha_tickets || 0).toLocaleString();
                    }
                    coinsDisplay.style.display = 'block';
                }
            } else {
                document.getElementById('user-name').textContent = 'Unknown Player';
            }
        }

        async function useDiscordName() {
            const user = await getCurrentUser();
            if (!user) return;
            const discordUser = user.user_metadata;
            const discordDisplayName = discordUser.custom_claims?.global_name || discordUser.full_name || discordUser.name;
            document.getElementById('user-nickname').value = discordDisplayName;
        }

        async function updateAvatar() {
            const user = await getCurrentUser();
            if (!user || isViewMode) return;

            const btn = document.getElementById('sync-btn');
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Êõ¥Êñ∞‰∏≠...';

            try {
                const discordUser = user.user_metadata;
                const avatarUrl = discordUser.avatar_url || discordUser.picture || '';

                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        avatar_url: avatarUrl,
                        updated_at: new Date().toISOString()
                    })
                    .eq('discord_user_id', targetId);

                if (error) throw error;

                alert('„Ç¢„Éê„Çø„ÉºÁîªÂÉè„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ');
                document.getElementById('user-avatar').src = avatarUrl;
            } catch (err) {
                console.error('Error:', err);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function saveNickname() {
            if (isViewMode) return;

            const newNickname = document.getElementById('user-nickname').value.trim();
            const msg = document.getElementById('save-msg');

            if (!newNickname) {
                msg.textContent = '„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                msg.className = 'small mt-1 text-danger flex-grow-1';
                msg.style.display = 'block';
                setTimeout(() => { msg.style.display = 'none'; }, 3000);
                return;
            }

            msg.style.display = 'block';
            msg.textContent = '‰øùÂ≠ò‰∏≠...';
            msg.className = 'small mt-1 text-muted flex-grow-1';

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        account_name: newNickname,
                        updated_at: new Date().toISOString()
                    })
                    .eq('discord_user_id', targetId);

                if (error) throw error;

                msg.textContent = '‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ';
                msg.className = 'small mt-2 text-center text-success';

                // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                const modalEl = document.getElementById('nicknameModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) {
                    setTimeout(() => {
                        modal.hide();
                        // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Éê„ÉÉ„Ç∏‰ªò„Åç„ÅÆÂêçÂâç„ÇíÊõ¥Êñ∞
                        loadTargetUserInfo();
                    }, 1000);
                }
            } catch (err) {
                console.error('Error updating nickname:', err);
                msg.textContent = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                msg.className = 'small mt-2 text-center text-danger';
            }
        }

        // ============ „Éê„ÉÉ„Ç∏ÁÆ°ÁêÜÊ©üËÉΩ ============

        // „Éê„ÉÉ„Ç∏„Éá„Éº„Çø„ÅÆ„Ç∞„É≠„Éº„Éê„É´‰øùÂ≠òÁî®
        let allBadgeGroups = [];
        let specialBadges = [];
        let convertibleBadges = [];
        let purchasableBadges = [];
        let currentBadgePage = 1;
        let isMutantFilterActive = false;
        const BADGES_PER_PAGE = 12; // 4x3„Ç∞„É™„ÉÉ„Éâ

        function toggleMutantFilter() {
            isMutantFilterActive = !isMutantFilterActive;
            const btn = document.getElementById('filter-mutant-btn');
            if (btn) {
                if (isMutantFilterActive) {
                    btn.classList.add('active');
                    btn.classList.replace('btn-outline-secondary', 'btn-primary'); // ÂàùÊúüÊôÇÁî®
                    btn.style.background = 'linear-gradient(135deg, var(--deep-purple), var(--soft-purple))';
                    btn.style.color = 'white';
                    btn.style.borderColor = 'transparent';
                } else {
                    btn.classList.remove('active');
                    btn.style.background = 'white';
                    btn.style.color = '#333';
                    btn.style.borderColor = '#dee2e6';
                }
            }
            currentBadgePage = 1;
            filterAndRenderBadges();
        }


        async function loadOwnedBadges() {
            const section = document.getElementById('badge-collection-section');
            const noBadgesMsg = document.getElementById('no-badges-msg');

            if (!section) return;
            section.style.display = 'block';

            try {
                const [ownedRes, marketCountRes, profileRes, thresholdsRes] = await Promise.all([
                    supabaseClient.from('user_badges_new').select('*, badges(*)').eq('user_id', targetId),
                    supabaseClient.from('user_badges_new').select('*'),
                    supabaseClient.from('profiles').select('coins, equipped_badge_id, equipped_badge_id_right, total_assets').eq('discord_user_id', targetId).maybeSingle(),
                    supabaseClient.from('rarity_thresholds').select('*').order('threshold_value', { ascending: true })
                ]);

                if (ownedRes.error) throw ownedRes.error;
                const thresholds = thresholdsRes.data || [];

                function getDynamicRarity(assetValue, fixedRarity) {
                    if (fixedRarity) return fixedRarity;
                    if (!thresholds || thresholds.length === 0) return '-';
                    let current = thresholds[0].rarity_name;
                    for (const t of thresholds) {
                        if (assetValue >= t.threshold_value) {
                            current = t.rarity_name;
                        } else {
                            break;
                        }
                    }
                    return current;
                }
                const owned = ownedRes.data || [];
                // ÂÖ•ÊâãÈ†ÜÔºàacquired_at„ÅÆÈôçÈ†ÜÔºâ„Åß„ÇΩ„Éº„Éà
                owned.sort((a, b) => {
                    const dateA = new Date(a.acquired_at || 0);
                    const dateB = new Date(b.acquired_at || 0);
                    return dateB - dateA;
                });
                const profileData = profileRes.data;
                const userCoins = profileData?.coins || 0;
                const equippedId = profileData?.equipped_badge_id;
                const equippedRightId = profileData?.equipped_badge_id_right;

                // ÂêÑ„Éê„ÉÉ„Ç∏„ÅÆÁèæÂú®ÊµÅÈÄöÊï∞ n „ÇíÈõÜË®à
                const marketCounts = {};
                (marketCountRes.data || []).forEach(s => {
                    marketCounts[s.badge_id] = (marketCounts[s.badge_id] || 0) + 1;
                });

                // Ëá™ÂàÜ„ÅÆ„Éö„Éº„Ç∏„Å™„ÇâÁÆ°ÁêÜ„Éú„Çø„É≥„ÇíË°®Á§∫
                const badgeBtn = document.getElementById('badge-change-btn');
                const transferBtn = document.getElementById('badge-transfer-btn');
                const sellBtn = document.getElementById('badge-sell-btn');
                if (!isViewMode) {
                    if (badgeBtn) badgeBtn.style.display = 'inline-block';
                    if (transferBtn) transferBtn.style.display = 'inline-block';
                    if (sellBtn) sellBtn.style.display = 'inline-block';
                }

                if (!owned || owned.length === 0) {
                    document.getElementById('special-badges-section').style.display = 'none';
                    document.getElementById('convertible-badges-section').style.display = 'none';
                    document.getElementById('purchasable-badges-section').style.display = 'none';
                    if (noBadgesMsg) noBadgesMsg.style.display = 'block';
                    const totalAssetsEl = document.getElementById('total-assets-value');
                    if (totalAssetsEl) {
                        totalAssetsEl.textContent = userCoins.toLocaleString();
                    }
                    return;
                }

                // „Éê„ÉÉ„Ç∏„ÅÆ„Ç∞„É´„Éº„Éî„É≥„Ç∞Âá¶ÁêÜ (badge_id „Åî„Å®„Å´„Åæ„Å®„ÇÅ„Çã)
                const groupedOwned = {};
                owned.forEach(item => {
                    const bid = item.badge_id;
                    const itemId = Number(item.user_badges_new || item.id) || 0;

                    if (!groupedOwned[bid]) {
                        groupedOwned[bid] = {
                            badge: item.badges,
                            instances: [],
                            isEquippedLeft: false,
                            isEquippedRight: false,
                            latestAcquiredAt: item.acquired_at || '' // „ÇΩ„Éº„ÉàÂü∫Ê∫ñÁî®„ÅÆÊúÄÊñ∞Êó•ÊôÇ
                        };
                    }
                    groupedOwned[bid].instances.push(item);

                    // ÊúÄÊñ∞„ÅÆÂèñÂæóÊó•ÊôÇ„ÇíÂü∫Ê∫ñ„Å´„Åô„Çã
                    if (!groupedOwned[bid].latestAcquiredAt || new Date(item.acquired_at) > new Date(groupedOwned[bid].latestAcquiredAt)) {
                        groupedOwned[bid].latestAcquiredAt = item.acquired_at;
                    }

                    if (item.badge_id === equippedId) {
                        groupedOwned[bid].isEquippedLeft = true;
                    }
                    if (item.badge_id === equippedRightId) {
                        groupedOwned[bid].isEquippedRight = true;
                    }
                });

                // ÂêÑ„Ç∞„É´„Éº„Éó„ÅÆ mainItem „ÇíÊúÄÊñ∞ÔºàlatestAcquiredAtÔºâ„ÅÆÂÄã‰Ωì„Å´Ë®≠ÂÆö
                Object.values(groupedOwned).forEach(group => {
                    group.mainItem = group.instances.find(inst => inst.acquired_at === group.latestAcquiredAt) || group.instances[0];
                });

                let totalBadgeAssetValue = 0;
                specialBadges = [];
                convertibleBadges = [];
                purchasableBadges = [];

                // „Ç∞„É´„Éº„ÉóÂåñ„Åï„Çå„Åü„Éê„ÉÉ„Ç∏„ÇíÂàÜÈ°û„Åó„Å¶‰øùÂ≠ò
                Object.values(groupedOwned).forEach(group => {
                    const badge = group.badge;
                    if (!badge) return;

                    const count = group.instances.length;
                    const mainItem = group.instances[0];

                    const n = marketCounts[badge.id] || 0;
                    const badgeResult = BadgeUtils.calculateBadgeValues(badge, n, rarityThresholds);
                    const pValue = badgeResult.marketValue;

                    // „Éü„É•„Éº„Çø„É≥„Éà„ÅØ‰æ°ÂÄ§3ÂÄç„ÅßË®àÁÆó
                    group.instances.forEach(inst => {
                        const multiplier = inst.is_mutant ? 3 : 1;
                        totalBadgeAssetValue += (pValue * multiplier);
                    });

                    const rarity = getDynamicRarity(pValue, badge.fixed_rarity_name);
                    const hasMutant = group.instances.some(i => i.is_mutant);

                    // „Éê„ÉÉ„Ç∏ÊÉÖÂ†±„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
                    const badgeInfo = {
                        group,
                        badge,
                        count,
                        mainItem,
                        pValue,
                        rarity,
                        hasMutant,
                        n,
                        getDynamicRarity,
                        marketCounts
                    };

                    // ÂàÜÈ°û
                    if (badge.sales_type === 'ÊèõÈáëÂìÅ') {
                        convertibleBadges.push(badgeInfo);
                    } else if (badge.sales_type === 'ÈôêÂÆöÂìÅ') {
                        specialBadges.push(badgeInfo);
                    } else {
                        purchasableBadges.push(badgeInfo);
                    }
                });

                // ÈôêÂÆö„Éê„ÉÉ„Ç∏„Çí„Éä„É≥„Éê„ÉºÈ†Ü„Å´„ÇΩ„Éº„Éà
                specialBadges.sort((a, b) => (a.badge.id || 0) - (b.badge.id || 0));

                // ÊèõÈáëÂìÅ„Çí„Éä„É≥„Éê„ÉºÈ†Ü„Å´„ÇΩ„Éº„Éà
                convertibleBadges.sort((a, b) => (a.badge.id || 0) - (b.badge.id || 0));

                // ÈôêÂÆö„Éê„ÉÉ„Ç∏„ÅÆË°®Á§∫
                // ÈôêÂÆö„Éê„ÉÉ„Ç∏„ÅÆË°®Á§∫ (Êñ∞„É¢„Éº„ÉÄ„É´ÁßªË°å„Å´„Å§„ÅçÈùûË°®Á§∫)
                if (document.getElementById('special-badges-section')) {
                    document.getElementById('special-badges-section').style.display = 'none';
                }

                // ÊèõÈáëÂìÅ„ÅÆË°®Á§∫ (Êñ∞„É¢„Éº„ÉÄ„É´ÁßªË°å„Å´„Å§„ÅçÈùûË°®Á§∫)
                if (document.getElementById('convertible-badges-section')) {
                    document.getElementById('convertible-badges-section').style.display = 'none';
                }

                // Ë≥ºÂÖ•„Éê„ÉÉ„Ç∏„ÅÆË°®Á§∫ÔºàÊóß„É™„Çπ„Éà„ÅØÈùûË°®Á§∫„Å´„Åó„ÄÅÊñ∞„Éú„Çø„É≥„ÇíË°®Á§∫„Åô„Çã„É≠„Ç∏„ÉÉ„ÇØ„Å∏ÁßªË°åÔºâ
                if (purchasableBadges.length > 0) {
                    // Êóß„Çª„ÇØ„Ç∑„Éß„É≥„ÅØÈùûË°®Á§∫
                    const oldSection = document.getElementById('purchasable-badges-section');
                    if (oldSection) oldSection.style.display = 'none';

                } else {
                    document.getElementById('purchasable-badges-section').style.display = 'none';
                }

                if (noBadgesMsg) noBadgesMsg.style.display = 'none';

                // Êñ∞„Ç§„É≥„Éô„É≥„Éà„É™„Ç∑„Çπ„ÉÜ„É†Áî®„ÅÆ„Éá„Éº„Çø„ÇíÊßãÁØâ
                allInventoryBadges = owned.map(item => {
                    const badge = item.badges || {};
                    const n = marketCounts[item.badge_id] || 0;
                    const calc = BadgeUtils.calculateBadgeValues(badge, n, thresholds);

                    return {
                        uuid: item.uuid,
                        badge_id: item.badge_id,
                        badge_name: badge.name || '‰∏çÊòé',
                        badge_image_url: badge.image_url || '',
                        acquired_at: new Date(item.acquired_at).getTime(),
                        is_mutant: item.is_mutant,
                        purchased_price: item.purchased_price,
                        sales_type: badge.sales_type,
                        is_gacha_eligible: badge.is_gacha_eligible,
                        rarity_name: getDynamicRarity(calc.marketValue, badge.fixed_rarity_name),
                        // ‰æ°Ê†ºË®àÁÆóÔºàRank1Áâπ‰æãÂê´„ÇÄ„ÄÅ„Éü„É•„Éº„Çø„É≥„Éà3ÂÄçÔºâ
                        sell_price: calc.sellPrice * (item.is_mutant ? 3 : 1)
                    };
                });

                // „Ç§„É≥„Éô„É≥„Éà„É™„ÅåÈñã„Åã„Çå„Å¶„ÅÑ„Çå„Å∞ÂÜçÊèèÁîª
                if (document.getElementById('universalInventoryModal')?.classList.contains('show')) {
                    renderModernInventory();
                }

                // „Éê„ÉÉ„Ç∏„ÅÆÁ∑èË≥áÁî£„ÇíÊõ¥Êñ∞
                const totalAssetsEl = document.getElementById('total-assets-value');
                if (totalAssetsEl) {
                    totalAssetsEl.textContent = totalBadgeAssetValue.toLocaleString();
                }

            } catch (err) {
                console.error('„Éê„ÉÉ„Ç∏ÂèñÂæó„Ç®„É©„Éº:', err);
                if (noBadgesMsg) {
                    noBadgesMsg.textContent = 'Ë™≠„ÅøËæº„Åø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                    noBadgesMsg.style.display = 'block';
                }
            }
        }
    </script>

    <!-- Ê±éÁî®„Ç§„É≥„Éô„É≥„Éà„É™„É¢„Éº„ÉÄ„É´ (Â£≤Âç¥„ÉªË≠≤Ê∏°ÂÖ±ÈÄö) -->
    <div class="modal fade" id="universalInventoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
                <div class="modal-header border-0 bg-white pb-0">
                    <div>
                        <h5 class="modal-title fw-bold" id="universalInventoryTitle">„Éê„ÉÉ„Ç∏ÈÅ∏Êäû</h5>
                        <p class="text-muted small mb-0" id="universalInventorySubtitle">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-light">
                    <!-- „Éï„Ç£„É´„Çø„Éº„Ç®„É™„Ç¢ -->
                    <div class="card border-0 shadow-sm mb-3" style="border-radius: 12px;">
                        <div class="card-body p-3">
                            <div class="row g-2">
                                <div class="col-12 col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0"><i
                                                class="bi bi-search"></i></span>
                                        <input type="text" id="inventory-search"
                                            class="form-control border-start-0 ps-0" placeholder="„Éê„ÉÉ„Ç∏Âêç„ÅßÊ§úÁ¥¢...">
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <select class="form-select" id="inventory-sort">
                                        <option value="acquired_desc">ÂÖ•Êâã: Êñ∞„Åó„ÅÑÈ†Ü</option>
                                        <option value="acquired_asc">ÂÖ•Êâã: Âè§„ÅÑÈ†Ü</option>
                                        <option value="rarity_desc">‰æ°ÂÄ§: È´ò„ÅÑÈ†Ü</option>
                                        <option value="rarity_asc">‰æ°ÂÄ§: ‰Ωé„ÅÑÈ†Ü</option>
                                        <option value="name_asc">ÂêçÂâç: ‰∫îÂçÅÈü≥È†Ü</option>
                                    </select>
                                </div>
                                <div class="col-6 col-md-4">
                                    <select class="form-select" id="inventory-filter">
                                        <option value="all">„Åô„Åπ„Å¶Ë°®Á§∫</option>
                                        <option value="fixed">Âõ∫ÂÆöÂûã„ÅÆ„Åø</option>
                                        <option value="variable">Â§âÂãïÂûã„ÅÆ„Åø</option>
                                        <option value="shrine">„ÅäË≥ΩÈä≠ÈôêÂÆö</option>
                                        <option value="mutant">„Éü„É•„Éº„Çø„É≥„Éà„ÅÆ„Åø</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- „É™„Çπ„Éà„Ç®„É™„Ç¢ -->
                    <div id="inventory-list" class="vstack gap-2">
                        <!-- JS„ÅßÊèèÁîª -->
                    </div>
                </div>
                <!-- „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ -->
                <div class="modal-footer border-0 bg-white justify-content-center py-2" id="inventory-pagination-area">
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="inventory-pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Â£≤Âç¥„Ç¢„ÇØ„Ç∑„Éß„É≥Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
    <div class="modal fade" id="shopActionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow" style="border-radius: 20px;">
                <div class="modal-body text-center p-4">
                    <div class="mb-4">
                        <div class="d-inline-flex align-items-center justify-content-center bg-danger bg-opacity-10 text-danger rounded-circle mb-3"
                            style="width: 60px; height: 60px;">
                            <span style="font-size: 1.8rem;">üí¥</span>
                        </div>
                        <h5 class="fw-bold mb-1">Â£≤Âç¥„ÅÆÁ¢∫Ë™ç</h5>
                        <p class="text-muted small">„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì</p>
                    </div>

                    <div id="shopActionContent" class="mb-4 text-start bg-light p-3 rounded">
                        <!-- JS„ÅßÊ≥®ÂÖ• -->
                    </div>

                    <div class="d-flex gap-2 justify-content-center">
                        <button type="button" class="btn btn-light rounded-pill px-4"
                            data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                        <button type="button" class="btn btn-danger rounded-pill px-4 fw-bold"
                            onclick="executeSellFromShop()">
                            Â£≤Âç¥„Åô„Çã
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // „Éê„ÉÉ„Ç∏„Ç´„Éº„Éâ„ÇíÊèèÁîª„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
        function renderBadgeCard(badgeInfo, equippedId, equippedRightId) {
            const { group, badge, count, hasMutant, rarity } = badgeInfo;
            const rarityClass = getRarityClass(rarity);
            const isEquippedLeft = group.isEquippedLeft;
            const isEquippedRight = group.isEquippedRight;
            const isEquipped = isEquippedLeft || isEquippedRight;
            const isNonSaleable = (badge.sales_type === 'ÈôêÂÆöÂìÅ');
            const countLabel = count > 1 ? `<span class="badge bg-dark position-absolute bottom-0 end-0 m-1"
        style="font-size:0.6rem; z-index:4; opacity: 0.9;">x${count}</span>` : '';

            return `
    <div class="col-6 col-sm-4 col-md-3 mb-3">
        <div class="card h-100 shadow-sm border-0 position-relative badge-card ${rarityClass}"
            style="border-radius: 12px; overflow: hidden; transition: transform 0.2s;"
            onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
            <a href="../badge/index.html?id=${badge.id}${hasMutant ? '&view=mutant' : ''}"
                class="text-decoration-none w-100 h-100 d-flex flex-column align-items-center justify-content-center"
                style="color: inherit;">
                <div class="card-body p-2 d-flex flex-column align-items-center justify-content-center text-center">
                    <div class="position-relative mb-1">
                        <div class="badge-item ${isEquipped ? 'equipped' : ''} ${hasMutant ? 'mutant-badge-container active' : ''}"
                            style="width: 70px; height: 70px; padding: 5px; background: transparent; border-width: 2px; border-radius: 50%;">
                            <img src="${badge.image_url}" alt="${badge.name}"
                                style="width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2)); ${hasMutant ? 'position: relative; z-index: 1;' : ''}">
                            ${hasMutant ? '<div class="mutant-badge-shine"></div>' : ''}
                        </div>
                        ${isEquipped ? `
                        <span
                            class="badge bg-gold position-absolute top-0 start-0 d-flex align-items-center justify-content-center"
                            style="font-size:0.4rem; z-index:2; min-width: 45px; height: 16px; transform: translate(-10%, -10%);">
                            ${isEquippedLeft && isEquippedRight ? '‚óÄÂ∑¶Âè≥‚ñ∂' : (isEquippedLeft ? '‚óÄÂ∑¶ Ë£ÖÁùÄ' : 'Âè≥ Ë£ÖÁùÄ‚ñ∂')}
                        </span>` : ''}
                        ${countLabel}
                    </div>
                    <div class="small opacity-75 text-truncate w-100 px-1"
                        style="font-size: 0.65rem; line-height: 1.2;">${badge.name}</div>
                    <span class="badge mt-1"
                        style="background: rgba(0,0,0,0.2); font-size: 0.45rem; padding: 2px 5px;">${rarity}</span>
                </div>
            </a>

            ${(!isViewMode && !isNonSaleable) ? `
            <div class="dropdown position-absolute top-0 end-0" style="z-index: 5;">
                <button class="btn btn-link btn-sm p-1" data-bs-toggle="dropdown"
                    style="font-size: 0.7rem; color: inherit; opacity: 0.5;">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0"
                    style="font-size: 0.75rem; min-width: 80px;">
                    <li><a class="dropdown-item py-1" href="javascript:void(0)"
                            onclick="openBadgeSelectionModal('sell')">Â£≤Âç¥</a></li>
                    <li><a class="dropdown-item py-1" href="javascript:void(0)"
                            onclick="openBadgeSelectionModal('transfer')">Ë≠≤Ê∏°</a></li>
                </ul>
            </div>
            ` : ''}
        </div>
    </div>
    `;
        }

        // ÈôêÂÆö„Éê„ÉÉ„Ç∏„ÇíÊèèÁîª
        function renderSpecialBadges() {
            const list = document.getElementById('special-badge-list');
            const countEl = document.getElementById('special-count');
            if (!list || !countEl) return;

            let html = '';
            specialBadges.forEach(badgeInfo => {
                html += renderBadgeCard(badgeInfo, null, null);
            });

            list.innerHTML = html;
            countEl.textContent = specialBadges.length;
        }

        // ÊèõÈáëÂìÅ„ÇíÊèèÁîª
        function renderConvertibleBadges() {
            const list = document.getElementById('convertible-badge-list');
            const countEl = document.getElementById('convertible-count');
            if (!list || !countEl) return;

            let html = '';
            convertibleBadges.forEach(badgeInfo => {
                const { badge, count, rarity } = badgeInfo;
                const rarityClass = getRarityClass(rarity);
                const fixedSellPrice = badge.price;

                html += `
    <div class="col-6 col-sm-4 col-md-3 mb-3">
        <div class="card h-100 shadow-sm border-0 ${rarityClass}"
            style="border-radius: 12px; overflow: hidden; transition: transform 0.2s;"
            onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
            <a href="../badge/index.html?id=${badge.id}" class="text-decoration-none w-100 h-100"
                style="color: inherit;">
                <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center text-center">
                    <div class="small text-muted mb-1" style="font-size: 0.65rem;">${rarity}</div>
                    <div class="d-flex align-items-center justify-content-center mb-2" style="gap: 8px;">
                        <div style="width: 70px; height: 70px;">
                            <img src="${badge.image_url}" alt="${badge.name}"
                                style="width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));">
                        </div>
                        <span class="badge bg-dark" style="font-size:0.75rem; padding: 4px 8px;">√ó${count}</span>
                    </div>
                    <div class="small fw-bold text-truncate w-100" style="font-size: 0.75rem; line-height: 1.2;">
                        ${badge.name}</div>
                    <div class="small text-muted mt-1" style="font-size: 0.7rem;">üí∞ ${fixedSellPrice.toLocaleString()}
                        C</div>
                </div>
            </a>
        </div>
    </div>
    `;
            });

            list.innerHTML = html;
            countEl.textContent = convertibleBadges.length;
        }

        // Êäò„Çä„Åü„Åü„Åø„Éà„Ç∞„É´
        function toggleBadgeSection(type) {
            const content = document.getElementById(`${type}-badge-content`);
            const icon = document.getElementById(`${type}-toggle-icon`);

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        // „Éï„Ç£„É´„Çø„Éº„Éª„ÇΩ„Éº„Éà„Éª„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥Ê©üËÉΩ
        function filterAndRenderBadges() {
            const searchInput = document.getElementById('badge-search');
            const sortSelect = document.getElementById('badge-sort');
            const typeSelect = document.getElementById('badge-type-filter');

            const searchTerm = searchInput?.value.toLowerCase() || '';
            const sortBy = sortSelect?.value || 'acquired_desc';
            const typeFilter = typeSelect?.value || '';
            const mutantOnly = isMutantFilterActive;

            // „Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®
            let filtered = purchasableBadges.filter(badgeInfo => {
                const { badge, hasMutant } = badgeInfo;

                // Ê§úÁ¥¢„Éï„Ç£„É´„Çø„Éº
                if (searchTerm && !badge.name.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                // ÂΩ¢Âºè„Éï„Ç£„É´„Çø„Éº
                if (typeFilter) {
                    if (typeFilter === '„Ç¨„ÉÅ„É£ÈôêÂÆö') {
                        // is_gacha_eligible „ÅåÁúüÔºàtrue, 1, "true"„Å™„Å©Ôºâ„Åã„Å©„ÅÜ„Åã
                        if (!badge.is_gacha_eligible || badge.is_gacha_eligible === 'false') return false;
                    } else if (typeFilter === 'Â§âÂãïÂûã') {
                        if (badge.sales_type !== 'Â§âÂãïÂûã') return false;
                    } else if (typeFilter === 'Âõ∫ÂÆöÂûã') {
                        if (badge.sales_type !== 'Âõ∫ÂÆöÂûã') return false;
                    }
                }

                // „Éü„É•„Éº„Çø„É≥„Éà„Éï„Ç£„É´„Çø„Éº
                if (mutantOnly && !hasMutant) {
                    return false;
                }

                return true;
            });

            // „ÇΩ„Éº„ÉàÈÅ©Áî®
            filtered.sort((a, b) => {
                const valA = a;
                const valB = b;

                // ÂÖ•ÊâãÈ†Ü„ÅÆ„Åü„ÇÅ„ÅÆÂèñÂæóÊó•ÊôÇ
                const getAcquiredTime = (item) => new Date(item.acquired_at || 0).getTime();

                switch (sortBy) {
                    case 'acquired_desc':
                        return getAcquiredTime(valB.mainItem) - getAcquiredTime(valA.mainItem);
                    case 'acquired_asc':
                        return getAcquiredTime(valA.mainItem) - getAcquiredTime(valB.mainItem);
                    case 'number':
                        return (Number(valA.badge.id) || 0) - (Number(valB.badge.id) || 0);
                    case 'price_desc':
                        return (Number(valB.pValue) || 0) - (Number(valA.pValue) || 0);
                    case 'price_asc':
                        return (Number(valA.pValue) || 0) - (Number(valB.pValue) || 0);
                    case 'count':
                        return (Number(valB.count) || 0) - (Number(valA.count) || 0);
                    case 'circulation':
                        return (Number(valB.n) || 0) - (Number(valA.n) || 0);
                    default:
                        return 0;
                }
            });

            // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥: „É¢„Éê„Ç§„É´10ÂÄã„ÄÅPC12ÂÄã
            const isMobile = window.innerWidth < 768; const itemsPerPage = isMobile ? 10 : 12; const
                totalPages = Math.ceil(filtered.length / itemsPerPage); // „Éö„Éº„Ç∏Áï™Âè∑„ÅåÁØÑÂõ≤Â§ñ„ÅÆÂ†¥Âêà„ÅØ1„Éö„Éº„Ç∏ÁõÆ„Å´Êàª„Åô if (currentBadgePage> totalPages)
            {
                currentBadgePage = 1;
            }
            if (currentBadgePage < 1) { currentBadgePage = 1; } const startIdx = (currentBadgePage - 1) * itemsPerPage; const
                endIdx = startIdx + itemsPerPage; const pageItems = filtered.slice(startIdx, endIdx); // „Éê„ÉÉ„Ç∏ÊèèÁîª const
            list = document.getElementById('purchasable-badge-list'); if (list) {
                let html = '';
                pageItems.forEach(badgeInfo => {
                    html += renderBadgeCard(badgeInfo, null, null);
                });
                list.innerHTML = html || '<div class="col-12 text-center text-muted">Ë©≤ÂΩì„Åô„Çã„Éê„ÉÉ„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
            }

            // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ÊèèÁîª
            const paginationArea = document.getElementById('badge-pagination-area');
            const pagination = document.getElementById('badge-pagination');
            const showingInfo = document.getElementById('badge-showing-info');

            if (totalPages > 1) {
                paginationArea.style.display = 'block';

                // Ë°®Á§∫ÊÉÖÂ†±
                showingInfo.textContent = `${startIdx + 1}-${Math.min(endIdx, filtered.length)} / ${filtered.length}‰ª∂`;

                // „Éö„Éº„Ç∏„Éú„Çø„É≥
                let paginationHtml = '';

                // Ââç„Å∏„Éú„Çø„É≥
                paginationHtml += `
            <li class="page-item ${currentBadgePage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="javascript:void(0)" onclick="goToBadgePage(${currentBadgePage - 1})">‚Äπ</a>
            </li>
            `;

                // „Éö„Éº„Ç∏Áï™Âè∑ÔºàÊúÄÂ§ß7ÂÄãË°®Á§∫Ôºâ
                let startPage = Math.max(1, currentBadgePage - 3);
                let endPage = Math.min(totalPages, startPage + 6);

                if (endPage - startPage < 6) { startPage = Math.max(1, endPage - 6); } for (let i = startPage; i <= endPage; i++) {
                    paginationHtml += ` <li class="page-item ${i === currentBadgePage ? 'active' : ''}">
                <a class="page-link" href="javascript:void(0)" onclick="goToBadgePage(${i})">${i}</a>
                </li>
                `;
                }

                // Ê¨°„Å∏„Éú„Çø„É≥
                paginationHtml += `
                <li class="page-item ${currentBadgePage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0)"
                        onclick="goToBadgePage(${currentBadgePage + 1})">‚Ä∫</a>
                </li>
                `;

                pagination.innerHTML = paginationHtml;
            } else {
                paginationArea.style.display = 'none';
            }
        }

        // „Éö„Éº„Ç∏ÁßªÂãï
        function goToBadgePage(page) {
            currentBadgePage = page;
            filterAndRenderBadges();
            // „Éö„Éº„Ç∏ÁßªÂãïÊôÇ„ÄÅ„Éê„ÉÉ„Ç∏„Çª„ÇØ„Ç∑„Éß„É≥„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´
            document.getElementById('purchasable-badges-section')?.scrollIntoView({
                behavior: 'smooth', block:
                    'nearest'
            });
        }

        // ============ Ë≤©Â£≤ÂÆüÁ∏æ„ÅÆË™≠„ÅøËæº„Åø ============
        async function loadRevenueStats() {
            const section = document.getElementById('revenue-section');
            if (!section) return;

            try {
                // royalty_receiveÔºàÂ£≤‰∏äÈÇÑÂÖÉÔºâ„ÅÆ„É≠„Ç∞„ÇíÂèñÂæó
                const { data: logs, error } = await supabaseClient
                    .from('activity_logs')
                    .select('amount')
                    .eq('user_id', targetId)
                    .eq('action_type', 'royalty_receive');

                if (error) {
                    console.log('Activity logs table may not exist yet:', error);
                    return;
                }

                if (!logs || logs.length === 0) {
                    // Ë≤©Â£≤ÂÆüÁ∏æ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÈùûË°®Á§∫„ÅÆ„Åæ„Åæ
                    return;
                }

                section.style.display = 'block';

                const totalRevenue = logs.reduce((sum, log) => sum + (log.amount || 0), 0);
                document.getElementById('total-revenue').textContent = `ü™ô ${totalRevenue.toLocaleString()}`;
                document.getElementById('revenue-count').textContent = logs.length;

            } catch (err) {
                console.error('Ë≤©Â£≤ÂÆüÁ∏æÂèñÂæó„Ç®„É©„Éº:', err);
            }
        }

        // ============ ÊúÄËøë„ÅÆÊ¥ªÂãï„É≠„Ç∞„ÅÆË™≠„ÅøËæº„Åø ============
        let activityPage = 0;
        const ACTIVITY_PER_PAGE = 10;

        async function loadActivityLogs(page = 1) {
            const listEl = document.getElementById('activity-list');
            const paginationEl = document.getElementById('activity-pagination');
            const section = document.getElementById('activity-section');
            if (!listEl) return;

            const itemsPerPage = 10;
            const from = (page - 1) * itemsPerPage;
            const to = from + itemsPerPage - 1;

            console.log('--- loadActivityLogs start ---', { targetId, page, from, to });

            try {
                const targetProfile = allProfiles.find(u => u.discord_user_id === targetId);
                const targetName = targetProfile?.account_name;
                const actionFilter = document.getElementById('activity-action-filter')?.value || 'all';

                // „Éê„ÉÉ„Ç∏ÊÉÖÂ†±„ÅÆÂèñÂæó (gacha_drawË°®Á§∫Áî®) - „Åì„Çå„ÅØ„Ç≠„É£„ÉÉ„Ç∑„É•„Åó„Å¶„ÇÇ„ÅÑ„ÅÑ„Åå‰∏ÄÊó¶„Åù„ÅÆ„Åæ„Åæ
                let badgeMap = {};
                try {
                    const { data: badgesData } = await supabaseClient
                        .from('badges')
                        .select('id, name, image_url');
                    if (badgesData) {
                        badgesData.forEach(b => badgeMap[b.id] = b);
                    }
                } catch (e) { console.error('„Éê„ÉÉ„Ç∏ÊÉÖÂ†±ÂèñÂæó„Ç®„É©„Éº:', e); }

                // „Çµ„Éº„Éê„Éº„Çµ„Ç§„Éâ„Éª„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„ÇíÈÅ©Áî®
                // 1. Ê¥ªÂãï„É≠„Ç∞ (ÈÄÅÈáë„Éª„Åä„Åø„Åè„ÅòÁ≠â)
                let logsQuery = supabaseClient
                    .from('activity_logs')
                    .select('*', { count: 'exact' })
                    .eq('user_id', targetId) // ÊúÄÂàù„Åã„ÇâÊú¨‰∫∫„ÅÆ„Åø
                    .order('created_at', { ascending: false });

                // ‰∏çË¶Å„Å™„É≠„Ç∞„ÇíÈô§Â§ñÔºàquery„ÅßÈô§Â§ñ„Åß„Åç„Çã„ÇÇ„ÅÆ„ÅØ„Åì„Åì„Åß„Åô„ÇãÔºâ
                // mahjong(DBÁî®), admin_edit, badge_equip „ÅØË°®Á§∫„Åó„Å™„ÅÑ
                logsQuery = logsQuery.not('action_type', 'eq', 'mahjong')
                    .not('action_type', 'eq', 'admin_edit')
                    .not('action_type', 'eq', 'badge_equip');

                // „Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®
                if (actionFilter !== 'all') {
                    if (actionFilter === 'transfer') {
                        logsQuery = logsQuery.in('action_type', ['transfer_send', 'transfer_receive']);
                    } else if (actionFilter === 'badge') {
                        logsQuery = logsQuery.in('action_type', ['badge_transfer', 'badge_receive', 'badge_sell',
                            'badge_purchase']);
                    } else if (actionFilter === 'mahjong') {
                        // È∫ªÈõÄË®òÈå≤„ÅØ„Åì„Åì„Åß„ÅØÂèñÂæó„Åó„Å™„ÅÑÔºàmatches„ÅßÂèñÂæóÔºâ
                        logsQuery = logsQuery.eq('action_type', 'none_xyz');
                    } else {
                        logsQuery = logsQuery.eq('action_type', actionFilter);
                    }
                }

                // 2. È∫ªÈõÄË®òÈå≤ (discord_user_id „Åß„Éï„Ç£„É´„Çø)
                let matchesQuery = supabaseClient
                    .from('match_results')
                    .select('*', { count: 'exact' })
                    .eq('discord_user_id', targetId)
                    .order('event_datetime', { ascending: false });

                // È∫ªÈõÄ„Éï„Ç£„É´„Çø„ÉºÊôÇ„ÅØ„É≠„Ç∞„ÇíÂèñÂæó„Åó„Å™„ÅÑ
                const showMatches = actionFilter === 'all' || actionFilter === 'mahjong';

                // 3. ÈÅéÂéªÂ§ß‰ºö„Éá„Éº„Çø (discord_user_id „Åß„Éï„Ç£„É´„Çø)
                let legacyQuery = supabaseClient
                    .from('tournament_player_stats_snapshot')
                    .select('*', { count: 'exact' })
                    .eq('discord_user_id', targetId);

                // ÂêåÊôÇÂÆüË°å„Åó„Å¶ÁµêÊûú„Çí„Éû„Éº„Ç∏„Åô„Çã„Åå„ÄÅ„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥„ÅÆ„Åü„ÇÅ„Å´„ÅÇ„ÇãÁ®ãÂ∫¶Â§ö„ÇÅ„Å´ÂèñÂæó„Åô„Çã„ÄÇ
                // Ë§áÊï∞„ÅÆ„ÉÜ„Éº„Éñ„É´„Çí„Éû„Éº„Ç∏„Åô„ÇãÂ†¥Âêà„ÄÅÊ≠£Á¢∫„Å™„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥„ÅØÈõ£„Åó„ÅÑ„Åå„ÄÅ
                // Êú¨‰∫∫„ÅÆ„Éá„Éº„Çø„ÅÆ„Åø„Å´Áµû„Å£„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅ‰ª•Ââç„ÅÆ500‰ª∂„Çà„Çä„ÅØÂÖ®‰ª∂„Å´Ëøë„ÅÑ„Éá„Éº„Çø„ÅåÂèñÂæó„Åß„Åç„Çã„ÄÇ
                const [logsRes, matchesRes, legacyRes] = await Promise.all([
                    logsQuery.limit(200),
                    showMatches ? matchesQuery.limit(200) : Promise.resolve({ data: [] }),
                    showMatches ? legacyQuery.limit(100) : Promise.resolve({ data: [] })
                ]);

                let combined = [];

                if (logsRes.data) {
                    logsRes.data.forEach(l => {
                        let details = l.details;
                        if (typeof details === 'string') { try { details = JSON.parse(details); } catch (e) { } }
                        if (details?.is_internal) return; // ÂÜÖÈÉ®ÁöÑ„Å™„ÇÇ„ÅÆ„ÅØÈô§Â§ñ
                        combined.push({ ...l, details, timestamp: new Date(l.created_at), isMatch: false });
                    });
                }

                if (matchesRes.data) {
                    matchesRes.data.forEach(m => {
                        combined.push({
                            action_type: 'mahjong', amount: null, match_id: m.match_id,
                            timestamp: new Date(m.event_datetime),
                            details: {
                                rank: m.rank,
                                final_score: m.final_score,
                                mode: m.mahjong_mode,
                                tournament_type: m.tournament_type,
                                match_mode: m.match_mode
                            },
                            isMatch: true
                        });
                    });
                }

                if (legacyRes.data) {
                    legacyRes.data.forEach(m => {
                        combined.push({
                            action_type: 'mahjong', amount: null, match_id: 'legacy-' + Math.random(),
                            timestamp: new Date(m.created_at || m.updated_at || '2024-01-01'),
                            details: {
                                rank: null,
                                final_score: m.score_total,
                                mode: '„ÄêÁ¨¨‰∏ÄÂõûÈ∫ªÈõÄÂ§ß‰ºö„Äë',
                                is_legacy: true
                            },
                            isMatch: true
                        });
                    });
                }

                combined.sort((a, b) => b.timestamp - a.timestamp);

                if (combined.length === 0) {
                    listEl.innerHTML = `<div class="text-center text-muted py-3"> Ê¥ªÂãï„É≠„Ç∞„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div> `;
                    section.style.display = 'block';
                    paginationEl.style.display = 'none';
                    return;
                }

                section.style.display = 'block';

                // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥Ôºà„Éû„Éº„Ç∏„Åó„ÅüÂæå„ÅÆ‰ªÆÊÉ≥„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥Ôºâ
                const totalPages = Math.ceil(combined.length / itemsPerPage);
                const pageItems = combined.slice((page - 1) * itemsPerPage, page * itemsPerPage);

                const typeNames = {
                    'mahjong': 'üÄÑ È∫ªÈõÄË®òÈå≤',
                    'transfer_send': 'üí∏ ÈÄÅÈáë(ÈÄÅ)',
                    'transfer_receive': 'üßß ÈÄÅÈáë(Âèó)',
                    'badge_transfer': 'üéÅ „Éê„ÉÉ„Ç∏Ë≠≤Ê∏°',
                    'badge_receive': 'üì¶ „Éê„ÉÉ„Ç∏ÂèóÂèñ',
                    'badge_sell': 'üí¥ „Éê„ÉÉ„Ç∏Â£≤Âç¥',
                    'badge_purchase': 'üõí „Éê„ÉÉ„Ç∏Ë≥ºÂÖ•',
                    'omikuji': 'üéã „Åä„Åø„Åè„Åò',
                    'royalty_receive': 'üíé Â£≤‰∏äÈÇÑÂÖÉ',
                    'gacha_draw': '‚õ©Ô∏è „ÅäË≥ΩÈä≠'
                };

                listEl.innerHTML = pageItems.map(log => {
                    const date = log.timestamp.toLocaleString('ja-JP', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                    const typeName = typeNames[log.action_type] || log.action_type;

                    // ÈáëÈ°çË°®Á§∫„ÅÆÊßãÁØâ
                    let amountStr = '';
                    if (log.isMatch) {
                        // È∫ªÈõÄ„ÅÆÂ†¥Âêà„ÅØ„Çπ„Ç≥„Ç¢„ÇíÂè≥ÂÅ¥„Å´Ë°®Á§∫
                        const score = log.details?.final_score || 0;
                        const scoreFormatted = Number(score) >= 0 ? `+${score}` : `${score}`;
                        amountStr = `<span class="text-secondary">${scoreFormatted} pts</span>`;
                    } else {
                        const isTicketOmikuji = log.action_type === 'omikuji' && log.details?.ticket_reward;
                        // „Ç¨„ÉÅ„É£„Åß„Ç≥„Ç§„É≥0„ÅÆÂ†¥Âêà„ÅØÁ•àÈ°òÁ¨¶Ôºà„ÉÅ„Ç±„ÉÉ„ÉàÔºâ‰ΩøÁî®„Å™„ÅÆ„Åßüé´-1Ë°®Á§∫
                        const isTicketGacha = log.action_type === 'gacha_draw' && log.amount === 0;
                        amountStr = isTicketGacha ? 'üé´ -1' : (log.amount !== null && (!isTicketOmikuji || log.amount !== 0)) ?
                            `ü™ô ${log.amount.toLocaleString()}` : '';
                    }

                    // Áõ∏Êâã„ÅÆÊÉÖÂ†±„ÇíÂèñÂæóÔºàÂü∫Êú¨„ÅØ target_user_id„ÄÇÂ∏∏„Å´ÊúÄÊñ∞„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÂèÇÁÖßÔºâ
                    const otherId = log.target_user_id;
                    const otherProfile = otherId ? allProfiles.find(p => p.discord_user_id === String(otherId)) : null;

                    const otherHtml = otherProfile ? `
                <div class="d-inline-flex align-items-center gap-1 mx-1">
                    <img src="${otherProfile.avatar_url || 'https://cdn.discordapp.com/embed/avatars/0.png'}"
                        class="rounded-circle shadow-sm" style="width: 24px; height: 24px; object-fit: cover;">
                    <span class="fw-bold">${otherProfile.account_name || 'Ë™∞„Åã'}</span>
                </div>` : (otherId ? ` <span class="badge bg-secondary"> ID: ${otherId}</span> ` : '');

                    let detailsStr = '';
                    if (log.isMatch) {
                        const rank = log.details?.rank;
                        const mode = log.details?.mode || ''; // mahjong_mode
                        const tType = log.details?.tournament_type || '';
                        const mMode = log.details?.match_mode || '';

                        // Â§ß‰ºöÁ®ÆÂà•„ÅÆË°®Á§∫Áî®„É©„Éô„É´
                        const tLabel = mMode ? `${mMode} ` : (tType.includes('ÂÄã‰∫∫') ? 'ÂÄã‰∫∫Êà¶' : (tType.includes('Âõ£‰Ωì') ? 'Âõ£‰ΩìÊà¶' :
                            tType));
                        const tPrefix = tLabel ? `<span class="text-muted small me-1"> [${tLabel}]</span> ` : '';

                        // ÈÅéÂéªÂ§ß‰ºöÔºàlegacyÔºâ„ÅÆÂ†¥Âêà„ÅØÈ†Ü‰Ωç„ÇíÈùûË°®Á§∫
                        const showRank = !log.details?.is_legacy && rank !== null && rank !== undefined;

                        detailsStr = `
                <div class="d-inline-flex align-items-center flex-wrap">
                    ${tPrefix}
                    <span class="fw-bold text-dark me-2">${mode}</span>
                    ${showRank ? `<span
                        class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 me-2"
                        style="font-size: 0.8rem;">${rank}‰Ωç</span>` : ''}
                </div>
                `;
                    } else if (log.action_type === 'transfer_send') {
                        detailsStr = `‚û° ${otherHtml} „Å∏„ÅÆÈÄÅÈáë`;
                    } else if (log.action_type === 'transfer_receive') {
                        detailsStr = `‚¨Ö ${otherHtml} „Åã„Çâ„ÅÆÈÄÅÈáë`;
                    } else if (log.action_type === 'badge_transfer') {
                        detailsStr = `üéÅ „Äå${log.details?.badge_name || '„Éê„ÉÉ„Ç∏'}„Äç„Çí ${otherHtml} „Å∏Ë≠≤Ê∏°`;
                    } else if (log.action_type === 'badge_receive') {
                        detailsStr = `üì¶ „Äå${log.details?.badge_name || '„Éê„ÉÉ„Ç∏'}„Äç„Çí ${otherHtml} „Åã„ÇâÂèóÂèñ`;
                    } else if (log.action_type === 'badge_sell') {
                        detailsStr = `üí¥ „Äå${log.details?.badge_name || '„Éê„ÉÉ„Ç∏'}„Äç„ÇíÂ£≤Âç¥`;
                    } else if (log.action_type === 'badge_purchase') {
                        detailsStr = `üõí „Äå${log.details?.badge_name || '„Éê„ÉÉ„Ç∏'}„Äç„ÇíË≥ºÂÖ•`;
                    } else if (log.action_type === 'omikuji') {
                        const tr = log.details?.ticket_reward;
                        const rank = log.details?.rank || '‰∏çÊòé';
                        if (tr) {
                            detailsStr = `üéã ÈÅãÂã¢: <strong>${rank}</strong> <span class="badge bg-warning text-dark ms-1"
                    style="font-size: 0.75rem;">üé´ +${tr}Êûö Á•àÈ°òÁ¨¶</span>`;
                        } else {
                            detailsStr = `üéã ÈÅãÂã¢: <strong>${rank}</strong>`;
                        }
                    } else if (log.action_type === 'royalty_receive') {
                        detailsStr = `üíé „Äå${log.details?.badge_name || '„Éê„ÉÉ„Ç∏'}„Äç„ÅÆÂ£≤Ë≤∑ÈÇÑÂÖÉ ${otherId ? `(by ${otherHtml})` : ''} `;
                    } else if (log.action_type === 'admin_edit') {
                        detailsStr = `‚öôÔ∏è ÁÆ°ÁêÜËÄÖ„Å´„Çà„Çã${log.amount >= 0 ? 'Âä†ÁÆó' : 'Ê∏õÁÆó'} `;
                    } else if (log.action_type === 'gacha_draw') {
                        const bId = log.badge_id;
                        const resultName = log.details?.result_name || log.details?.name || '„Ç¢„Ç§„ÉÜ„É†';
                        const resultType = log.details?.result_type || log.details?.type;

                        if (bId && badgeMap[bId]) {
                            const badge = badgeMap[bId];
                            detailsStr = `
                <div class="d-inline-flex align-items-center gap-1">
                    <img src="${badge.image_url}" style="width: 30px; height: 30px; object-fit: contain;"
                        title="${badge.name}">
                    <span>${badge.name} „ÇíÁç≤Âæó</span>
                </div>
                `;
                        } else {
                            let icon = 'üéÅ';
                            if (resultType === 'exchange_ticket') icon = 'üé´';
                            else if (resultType === 'stone') icon = 'üí†';

                            detailsStr = `${icon} ${resultName} „ÇíÁç≤Âæó`;
                        }
                    }

                    // „Éê„ÉÉ„Ç∏Èñ¢ÈÄ£„ÅÆ„É≠„Ç∞„Åß„ÄÅdetails„Å´badge_id„Åå„Å™„ÅÑ„ÅålogÊú¨‰Ωì„Å´„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Ç¢„Ç§„Ç≥„É≥Ë°®Á§∫
                    const bId = log.badge_id;
                    if (['badge_transfer', 'badge_receive', 'badge_sell', 'badge_purchase'].includes(log.action_type) && bId
                        && badgeMap[bId]) {
                        const badge = badgeMap[bId];
                        const originalDetails = detailsStr;
                        detailsStr = `
                <div class="d-inline-flex align-items-center gap-1">
                    <img src="${badge.image_url}" style="width: 24px; height: 24px; object-fit: contain;"
                        title="${badge.name}">
                    <span>${originalDetails}</span>
                </div>
                `;
                    }

                    return `
                <div class="activity-item-card">
                    <span class="activity-date">${date}</span>
                    <div class="row align-items-center g-2">
                        <div class="col">
                            <div class="d-flex flex-wrap align-items-center gap-2">
                                <span class="activity-type-badge">${typeName}</span>
                                <span class="activity-details">${detailsStr}</span>
                            </div>
                        </div>
                        <div class="col-auto text-end">
                            <span
                                class="activity-amount ${log.amount > 0 ? 'text-success' : log.amount < 0 ? 'text-danger' : ''}">${amountStr}</span>
                        </div>
                    </div>
                </div>
                `;
                }).join('');


                // 6. „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥UIÔºàÊîπÂñÑÁâàÔºâ
                const paginationArea = document.getElementById('activity-pagination-area');
                if (totalPages > 1) {
                    // ÁîªÈù¢ÂπÖ„Å´Âøú„Åò„Å¶„Éú„Çø„É≥Ë°®Á§∫Êï∞„ÇíÂàá„ÇäÊõø„Åà („É¢„Éê„Ç§„É´:3, ‰∏≠Èñì:4, PC:5+)
                    const width = window.innerWidth;
                    const groupSize = width < 576 ? 3 : (width < 992 ? 4 : 5); const pageGroup = Math.ceil(page / groupSize);
                    const startPage = (pageGroup - 1) * groupSize + 1; const endPage = Math.min(startPage + (groupSize - 1),
                        totalPages); let pagHtml = '';
                    // „ÄåÊúÄÂàù„Å∏„Äç„Éú„Çø„É≥ 
                    pagHtml += ` <li
                    class="page-item ${page === 1 ? 'disabled' : ''}">
                    <a class="page-link shadow-sm" href="javascript:void(0)" onclick="loadActivityLogs(1)">¬´</a>
                    </li>`;

                    // „ÄåÂâç„ÅÆ„Ç∞„É´„Éº„Éó„Äç„Éú„Çø„É≥
                    if (startPage > 1) {
                        pagHtml += `
                    <li class="page-item">
                        <a class="page-link shadow-sm" href="javascript:void(0)"
                            onclick="loadActivityLogs(${startPage - 1})">‚Äπ</a>
                    </li>`;
                    }

                    // ÁèæÂú®„ÅÆ„Ç∞„É´„Éº„Éó„ÅÆ„Éö„Éº„Ç∏Áï™Âè∑ÔºàÊúÄÂ§ß5ÂÄãÔºâ
                    for (let i = startPage; i <= endPage; i++) {
                        pagHtml += ` <li
                        class="page-item ${i === page ? 'active' : ''}">
                        <a class="page-link shadow-sm" href="javascript:void(0)"
                            onclick="loadActivityLogs(${i})">${i}</a>
                        </li>`;
                    }

                    // „ÄåÊ¨°„ÅÆ„Ç∞„É´„Éº„Éó„Äç„Éú„Çø„É≥
                    if (endPage < totalPages) {
                        pagHtml += ` <li class="page-item">
                            <a class="page-link shadow-sm" href="javascript:void(0)"
                                onclick="loadActivityLogs(${endPage + 1})">‚Ä∫</a>
                            </li>`;
                    }

                    // „ÄåÊúÄÂæå„Å∏„Äç„Éú„Çø„É≥
                    pagHtml += `
                            <li class="page-item ${page === totalPages ? 'disabled' : ''}">
                                <a class="page-link shadow-sm" href="javascript:void(0)"
                                    onclick="loadActivityLogs(${totalPages})">¬ª</a>
                            </li>`;

                    // „Éó„É´„ÉÄ„Ç¶„É≥„Å´„Çà„Çã„Éö„Éº„Ç∏ÈÅ∏Êäû („É¢„Éê„Ç§„É´„Åß„ÅØ„Ç≥„É≥„Éë„ÇØ„Éà„Å´)
                    const selectWidth = width < 576 ? '100px' : 'auto'; pagHtml += ` <li
                                class="page-item ms-sm-2">
                                <select class="form-select form-select-sm shadow-sm"
                                    onchange="if(this.value) loadActivityLogs(parseInt(this.value))"
                                    style="width: ${selectWidth}; display: inline-block; font-size: 0.75rem;">
                                    <option value="">„Éö„Éº„Ç∏...</option>`;

                    for (let i = 1; i <= totalPages; i++) {
                        pagHtml += `<option value="${i}" ${i === page
                            ? 'selected' : ''}>${i}„Éö„Éº„Ç∏</option>`;
                    }

                    pagHtml += `
                                </select>
                                </li>`;

                    paginationEl.innerHTML = pagHtml;
                    if (paginationArea) paginationArea.style.display = 'block';
                } else {
                    if (paginationArea) paginationArea.style.display = 'none';
                }


            } catch (err) {
                console.error('Activity logs error:', err);
                listEl.innerHTML = '<div class="text-center text-danger py-3">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</div>';
            }
        }

        // ============ „Éê„ÉÉ„Ç∏Ë≠≤Ê∏°„ÉªÂ£≤Âç¥Ôºö„Éê„ÉÉ„Ç∏ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ ============
        // ============ „Éê„ÉÉ„Ç∏Ë≠≤Ê∏°„ÉªÂ£≤Âç¥Ôºö„Éê„ÉÉ„Ç∏ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ ============
        async function openBadgeSelectionModal(mode) {
            const listEl = document.getElementById('action-badge-list');
            listEl.innerHTML = '<p class="text-center text-muted py-3">Ë™≠„ÅøËæº„Åø‰∏≠...</p>';

            document.getElementById('badgeActionModalLabel').textContent = mode === 'transfer' ?
                'Ë≠≤Ê∏°„Åô„Çã„Éê„ÉÉ„Ç∏„ÇíÈÅ∏Êäû' : 'Â£≤Âç¥„Åô„Çã„Éê„ÉÉ„Ç∏„ÇíÈÅ∏Êäû';

            const modalEl = document.getElementById('badgeActionModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();

            try {
                // ÊâÄÊåÅ„Éê„ÉÉ„Ç∏„ÅÆÂèñÂæóÔºàÊñ∞„ÉÜ„Éº„Éñ„É´ user_badges_new „Çí‰ΩøÁî®Ôºâ
                const { data: owned, error } = await supabaseClient
                    .from('user_badges_new')
                    .select('*, badges(*)')
                    .eq('user_id', targetId);

                if (error) throw error;

                // ÂÖ®„Éê„ÉÉ„Ç∏„ÅÆÊµÅÈÄöÊï∞„ÇíÂèñÂæóÔºà‰æ°Ê†ºË®àÁÆóÁî®Ôºâ
                const { data: marketCountRes } = await supabaseClient
                    .from('user_badges_new')
                    .select('*');

                const marketCounts = {};
                (marketCountRes || []).forEach(s => {
                    marketCounts[s.badge_id] = (marketCounts[s.badge_id] || 0) + 1;
                });

                if (!owned || owned.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-muted py-3">ÂØæË±°„ÅÆ„Éê„ÉÉ„Ç∏„ÇíÊåÅ„Å£„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                    return;
                }

                // ÈùûÂ£≤ÂìÅÔºàÈôêÂÆöÂìÅÔºâ„ÇíÈô§Â§ñ
                let targetBadges = owned.filter(item => item.badges && item.badges.sales_type !==
                    'ÈôêÂÆöÂìÅ');

                // Ë≠≤Ê∏°„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅÆ„ÅøÊèõÈáëÂìÅ„ÇíÈô§Â§ñ
                if (mode === 'transfer') {
                    targetBadges = targetBadges.filter(item => item.badges && item.badges.sales_type !==
                        'ÊèõÈáëÂìÅ');
                }

                if (targetBadges.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-muted py-3">Ë≠≤Ê∏°„ÉªÂ£≤Âç¥ÂèØËÉΩ„Å™„Éê„ÉÉ„Ç∏„ÇíÊåÅ„Å£„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                    return;
                }

                // ÊèõÈáëÂìÅ„Å®ÈÄöÂ∏∏„Éê„ÉÉ„Ç∏„ÇíÂàÜÈõ¢
                const convertibleGroups = new Map();
                const normalItems = [];

                targetBadges.forEach(item => {
                    if (!item.badges) return;

                    if (item.badges.sales_type === 'ÊèõÈáëÂìÅ') {
                        const badgeId = item.badges.id;
                        if (!convertibleGroups.has(badgeId)) {
                            convertibleGroups.set(badgeId, {
                                badge: item.badges,
                                count: 0
                            });
                        }
                        convertibleGroups.get(badgeId).count++;
                    } else {
                        normalItems.push(item);
                    }
                });

                let htmlParts = [];

                // ÊèõÈáëÂìÅ„ÅÆHTMLÁîüÊàêÔºà„Ç∞„É´„Éº„ÉóÂåñÔºâ
                convertibleGroups.forEach(group => {
                    const badge = group.badge;
                    const count = group.count;
                    const sellPrice = badge.price;
                    const totalSell = sellPrice * count;

                    htmlParts.push(`
                                <div class="user-select-item"
                                    onclick="openConvertibleSellModal('${badge.id}', '${badge.name.replace(/'/g, "\\'")}', ${count}, ${sellPrice})">
                                    <img src="${badge.image_url}" class="user-select-avatar"
                                        style="border-radius: 8px;">
                                    <div class="flex-grow-1">
                                        <div class="user-select-name">${badge.name} <span
                                                class="badge bg-dark">√ó${count}</span></div>
                                        <div class="small text-muted" style="font-size: 0.75rem;">
                                            Â£≤Âç¥: ü™ô${sellPrice.toLocaleString()} C √ó ${count} =
                                            ü™ô${totalSell.toLocaleString()} C
                                        </div>
                                    </div>
                                    <div class="text-danger fw-bold">Â£≤Âç¥</div>
                                </div>
                                `);
                });

                // ÈÄöÂ∏∏„Éê„ÉÉ„Ç∏„ÅÆÂá¶ÁêÜ
                listEl.innerHTML = htmlParts.join('') + normalItems.map(item => {
                    const badge = item.badges;
                    if (!badge) return '';

                    const n = marketCounts[badge.id] || 0;

                    // Êñ∞„É¨„Ç¢„É™„ÉÜ„Ç£„Ç∑„Çπ„ÉÜ„É†„ÅßË®àÁÆó
                    const badgeResult = BadgeUtils.calculateBadgeValues(badge, n, rarityThresholds);
                    const pValue = badgeResult.marketValue;

                    // Â£≤Âç¥‰æ°Ê†º: 2ÊÆµÈöé‰∏ã„ÅÆ„É¨„Ç¢„É™„ÉÜ„Ç£‰æ°Ê†ºÔºà„Éü„É•„Éº„Çø„É≥„Éà„ÅØ3ÂÄçÔºâ
                    const pSell = badgeResult.sellPrice * (item.is_mutant ? 3 : 1);
                    const buyPrice = item.purchased_price || 0;

                    const mutantLabel = item.is_mutant ? '<span class="text-warning fw-bold">(Mutant)</span>' : '';

                    if (mode === 'transfer') {
                        return `
                                <div class="user-select-item"
                                    onclick="openUUIDTransferModal('${item.uuid}', '${badge.name.replace(/'/g, "\\'")}', ${buyPrice}, ${pValue}, ${pSell})">
                                    <img src="${badge.image_url}" class="user-select-avatar"
                                        style="border-radius: 8px;">
                                    <div class="flex-grow-1">
                                        <div class="user-select-name">${badge.name} ${mutantLabel}</div>
                                        <div class="small text-muted" style="font-size: 0.75rem;">
                                            Ë≥ºÂÖ•: ü™ô${buyPrice.toLocaleString()} |
                                            ÊôÇ‰æ°: ü™ô${pValue.toLocaleString()} |
                                            Â£≤Âç¥: ü™ô${pSell.toLocaleString()}
                                        </div>
                                    </div>
                                    <div class="text-primary fw-bold">ÈÅ∏Êäû</div>
                                </div>
                                `;
                    } else {
                        return `
                                <div class="user-select-item"
                                    onclick="sellBadgeConfirm('${item.uuid}', '${badge.name.replace(/'/g, "\\'")}',
                                    ${buyPrice}, ${pValue}, ${pSell})">
                                    <img src="${badge.image_url}" class="user-select-avatar"
                                        style="border-radius: 8px;">
                                    <div class="flex-grow-1">
                                        <div class="user-select-name">${badge.name} ${mutantLabel}</div>
                                        <div class="small text-muted" style="font-size: 0.75rem;">
                                            Ë≥ºÂÖ•: ü™ô${buyPrice.toLocaleString()} |
                                            ÊôÇ‰æ°: ü™ô${pValue.toLocaleString()} |
                                            Â£≤Âç¥: ü™ô${pSell.toLocaleString()}
                                        </div>
                                    </div>
                                    <div class="text-danger fw-bold">Â£≤Âç¥</div>
                                </div>
                                `;
                    }
                }).join('');
            } catch (err) {
                console.error('Error loading action badges:', err);
                listEl.innerHTML = '<p class="text-center text-danger py-3">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</p>';
            }
        }

        // ======= „Éê„ÉÉ„Ç∏Â£≤Âç¥„ÉªË≠≤Ê∏° =======
        let currentActionUUID = null;
        let currentActionBadgeName = null;
        let currentActionDetails = null;

        function sellBadgeConfirm(uuid, name, purchasedPrice, pValue, pSell) {
            currentActionUUID = uuid;
            currentActionBadgeName = name;

            // ÂÆâÂÖ®„Å™Êï∞ÂÄ§Â§âÊèõ„Å®„Éá„Éï„Ç©„É´„ÉàÂÄ§Ë®≠ÂÆö
            const pPrice = Number(purchasedPrice) || 0;
            const pVal = Number(pValue) || 0;
            const sPrice = Number(pSell) || 0;
            const profit = sPrice - pPrice;
            const profitStr = (profit >= 0 ? '+' : '') + profit.toLocaleString();

            const msg = `„Äå${name}„Äç„ÇíÂ£≤Âç¥„Åó„Åæ„Åô„ÅãÔºü\n\n` +
                `„ÉªË≥ºÂÖ•ÊôÇ„ÅÆÈáëÈ°ç: ü™ô ${pPrice.toLocaleString()} \n` +
                `„ÉªÁèæÂú®„ÅÆÂ∏ÇÂ†¥‰æ°ÂÄ§: ü™ô ${pVal.toLocaleString()} \n` +
                `„ÉªÂÆüÈöõ„ÅÆÂ£≤Âç¥‰æ°Ê†º: ü™ô ${sPrice.toLocaleString()} \n` +
                `--------------------------\n` +
                `„Éª‰∫àÊÉ≥ÊêçÁõä: ${profitStr} `;

            if (confirm(msg)) {
                // ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                const modalEl = document.getElementById('badgeActionModal');
                if (modalEl) {
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                }
                executeSellUUID();
            }
        }

        async function executeSellUUID() {
            toggleLoading(true);
            try {
                const { data, error } = await supabaseClient.rpc('sell_badge_v2', {
                    p_user_id: targetId,
                    p_badge_uuid: currentActionUUID
                });

                if (error) throw error;
                if (!data.ok) throw new Error(data.error);

                alert(`„Éê„ÉÉ„Ç∏„Çí ü™ô${data.sell_price.toLocaleString()} „ÅßÂ£≤Âç¥„Åó„Åæ„Åó„Åü„ÄÇ`);
                // Ê¥ªÂãï„É≠„Ç∞Ë®òÈå≤
                if (typeof logActivity === 'function') {
                    // „Éê„ÉÉ„Ç∏ID(Êï¥Êï∞)„ÇíÂèñÂæó
                    const { data: bInfo } = await
                        supabaseClient.from('user_badges_new').select('badge_id').eq('uuid',
                            currentActionUUID).single();
                    const bId = bInfo?.badge_id;

                    await logActivity(targetId, 'badge_sell', {
                        amount: data.sell_price,
                        badgeId: bId, // Êï¥Êï∞ID„ÇíËøΩÂä†
                        details: { badge_uuid: currentActionUUID, badge_name: currentActionBadgeName }
                    });
                }
                // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                const modalEl = document.getElementById('badgeActionModal');
                if (modalEl) {
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                }
                loadOwnedBadges();
                loadActivityLogs();
                // Ëá™ÂàÜ„ÅÆÊÉÖÂ†±„ÇíÂÜçË™≠„ÅøËæº„Åø
                const user = await getCurrentUser();
                if (user) displayMyInfo(user);
            } catch (err) {
                console.error('Â£≤Âç¥„Ç®„É©„Éº:', err);
                alert('Â£≤Âç¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message);
            } finally {
                toggleLoading(false);
            }
        }

        // ============ ÊèõÈáëÂìÅ„ÅÆÂ£≤Âç¥ ============
        async function openConvertibleSellModal(badgeId, badgeName, totalCount, fixedPrice) {
            const quantity = prompt(`„Äå${badgeName}„Äç„Çí‰ΩïÂÄãÂ£≤Âç¥„Åó„Åæ„Åô„ÅãÔºüÔºàÊâÄÊåÅÊï∞: ${totalCount} ÂÄã„ÄÅÂ£≤Âç¥‰æ°Ê†º:
                                ${fixedPrice.toLocaleString()} C / ÂÄãÔºâ`, '1');

            if (!quantity) return;

            const count = parseInt(quantity);
            if (isNaN(count) || count <= 0) { alert('ÊúâÂäπ„Å™ÂÄãÊï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'); return; } if (count >
                totalCount) {
                alert(`ÊâÄÊåÅÊï∞Ôºà${totalCount} ÂÄãÔºâ„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇ`);
                return;
            }

            const totalPrice = fixedPrice * count;
            if (!confirm(`„Äå${badgeName}„Äç„Çí ${count} ÂÄãÂ£≤Âç¥„Åó„Åæ„Åô„ÅãÔºüÔºàÂêàË®à: üí∞${totalPrice.toLocaleString()}
                                    CÔºâ`)) return;

            toggleLoading(true);
            try {
                // ÊâÄÊåÅ„Åó„Å¶„ÅÑ„ÇãÊèõÈáëÂìÅ„ÅÆ UUID „ÇíÂèñÂæó
                const { data: ownedItems, error: fetchError } = await supabaseClient
                    .from('user_badges_new')
                    .select('uuid')
                    .eq('user_id', targetId)
                    .eq('badge_id', badgeId)
                    .limit(count);

                if (fetchError) throw fetchError;
                if (!ownedItems || ownedItems.length < count) throw new Error('ÊåáÂÆö„Åó„ÅüÊï∞„ÅÆ„Éê„ÉÉ„Ç∏„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
                // ‰∏Ä„Å§„Åö„Å§Â£≤Âç¥ 
                let successCount = 0; for (const item of ownedItems) {
                    const { data,
                        error } = await supabaseClient.rpc('sell_badge_v2', {
                            p_user_id: targetId,
                            p_badge_uuid: item.uuid
                        }); if (error || !data.ok) {
                            console.error('Â£≤Âç¥„Ç®„É©„Éº:',
                                error || data.error); continue;
                        } successCount++;
                } if (successCount > 0) {
                    const actualTotalPrice = fixedPrice * successCount;
                    alert(`„Äå${badgeName}„Äç„Çí ${successCount} ÂÄãÂ£≤Âç¥„Åó„Åæ„Åó„Åü„ÄÇÔºàÂêàË®à:
                                        üí∞${actualTotalPrice.toLocaleString()} CÔºâ`);

                    // Ê¥ªÂãï„É≠„Ç∞Ë®òÈå≤
                    if (typeof logActivity === 'function') {
                        await logActivity(targetId, 'badge_sell', {
                            amount: actualTotalPrice,
                            details: {
                                badge_id: badgeId,
                                badge_name: badgeName,
                                quantity: successCount,
                                unit_price: fixedPrice
                            }
                        });
                    }

                    // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                    const modalEl = document.getElementById('badgeActionModal');
                    if (modalEl) {
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        if (modal) modal.hide();
                    }
                    loadOwnedBadges();
                    loadActivityLogs();
                    loadTargetUserInfo(); // Ë£ÖÁùÄ„Éê„ÉÉ„Ç∏„ÅåÂ£≤Âç¥„Åï„Çå„ÅüÂ†¥ÂêàËá™Âãï„ÅßÂ§ñ„Åô
                    const user = await getCurrentUser();
                    if (user) displayMyInfo(user);
                } else {
                    throw new Error('Â£≤Âç¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                }
            } catch (err) {
                console.error('ÊèõÈáëÂìÅÂ£≤Âç¥„Ç®„É©„Éº:', err);
                alert('Â£≤Âç¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + err.message);
            } finally {
                toggleLoading(false);
            }
        }

        function openUUIDTransferModal(uuid, name, purchasedPrice, pValue, pSell) {
            currentActionUUID = uuid;
            currentActionBadgeName = name;

            // Ë≠≤Ê∏°ÊôÇ„Å´„ÇÇË©≥Á¥∞ÊÉÖÂ†±„ÇíË°®Á§∫„Åô„Çã„Åü„ÇÅ„Å´Ë©≥Á¥∞ÊñáÂ≠óÂàó„ÇíÊßãÁØâ
            currentActionDetails =
                `„ÉªË≥ºÂÖ•È°ç: ü™ô ${purchasedPrice.toLocaleString()} \n` +
                `„ÉªÁèæÂú®‰æ°ÂÄ§: ü™ô ${pValue.toLocaleString()} \n` +
                `„ÉªÊúüÂæÖÂ£≤Âç¥È°ç: ü™ô ${pSell.toLocaleString()} \n` +
                `--------------------------\n` +
                `‚ÄªË≠≤Ê∏°„Åô„Çã„Å®„ÅÇ„Å™„Åü„ÅÆÊâãÂÖÉ„Åã„Çâ„ÅØ„Å™„Åè„Å™„Çä„Åæ„Åô„ÄÇ`;

            // ÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            const modalEl = document.getElementById('badgeActionModal');
            if (modalEl) bootstrap.Modal.getInstance(modalEl)?.hide();
            openUserSelectModal('badge_transfer');
        }

        // Ë≠≤Ê∏°ÂÆüË°å„ÅÆ„Ç™„Éº„Éê„Éº„É©„Ç§„ÉâÔºàÂÖ±Êúâ„Åï„Çå„Å¶„ÅÑ„Çã openUserSelectModal „Åã„ÇâÂëº„Å∞„Çå„ÇãÔºâ
        // Êó¢Â≠ò„ÅÆ executeTransferConfirmation „ÅØ badge_id „Éô„Éº„Çπ„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅUUIDÂØæÂøúÁâà„Å´Â∑Æ„ÅóÊõø„Åà„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÅØ
        // „Åì„Åì„ÅßÂÜçÂÆöÁæ©„Åô„Çã„Åã„ÄÅ„Ç∞„É≠„Éº„Éê„É´„Å´Ë™øÊï¥„Åô„Çã„ÄÇmypage/index.html ÂÜÖ„Å´ÂÆöÁæ©„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„Åù„Çå„Çí‰∏äÊõ∏„Åç„Åô„Çã„ÄÇ

        // ============ „Éê„ÉÉ„Ç∏Ë£ÖÁùÄ ============
        let selectedBadgeIdForEquip = null;

        function selectBadgeInModal(badgeId) {
            selectedBadgeIdForEquip = badgeId;
            document.querySelectorAll('#badge-modal-list .badge-item').forEach(el => {
                el.classList.remove('selected');
            });
            const targetEl =
                document.querySelector(`.badge-item[data-badge-id="${badgeId}"]`);
            if (targetEl) targetEl.classList.add('selected');

            const btn = document.getElementById('btn-execute-equip');
            if (btn) btn.disabled = false;
        }

        async function executeSelectedEquip() {
            if (!selectedBadgeIdForEquip) return;
            const posRadio = document.querySelector('input[name="badge-position"]:checked');
            const position = posRadio ? posRadio.value : 'left';

            toggleLoading(true);
            await equipBadge(selectedBadgeIdForEquip, position);
            toggleLoading(false);

            selectedBadgeIdForEquip = null;
        }

        async function equipBadge(badgeId, position = null) {
            if (isViewMode) return;

            // position„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„É©„Ç∏„Ç™„Éú„Çø„É≥„ÅÆÂÄ§„ÇíÂèñÂæó
            if (!position) {
                const posRadio = document.querySelector('input[name="badge-position"]:checked');
                position = posRadio ? posRadio.value : 'left';
            }

            const columnName = position === 'right' ? 'equipped_badge_id_right' :
                'equipped_badge_id';

            // ÁèæÂú®„ÅÆË£ÖÁùÄÁä∂Ê≥Å„ÇíÁ¢∫Ë™ç
            const { data: current } = await supabaseClient
                .from('profiles')
                .select('equipped_badge_id, equipped_badge_id_right')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            // Âêå„Åò„Éê„ÉÉ„Ç∏„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÂ†¥Âêà„ÅØÂ§ñ„Åô
            const currentBadgeId = position === 'right' ? current?.equipped_badge_id_right :
                current?.equipped_badge_id;
            const oppositeBadgeId = position === 'right' ? current?.equipped_badge_id :
                current?.equipped_badge_id_right;
            const oppositeColumn = position === 'right' ? 'equipped_badge_id' :
                'equipped_badge_id_right';

            const newBadgeId = (currentBadgeId === badgeId) ? null : badgeId;

            // ÂèçÂØæÂÅ¥„ÅÆ„Çπ„É≠„ÉÉ„Éà„Å´Âêå„Åò„Éê„ÉÉ„Ç∏„ÅåË£ÖÁùÄ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÁßªÂãïÔºàÂèçÂØæÂÅ¥„ÇíÂ§ñ„ÅôÔºâ
            let updateData = { [columnName]: newBadgeId };
            if (badgeId && badgeId === oppositeBadgeId) {
                updateData[oppositeColumn] = null; // ÂèçÂØæÂÅ¥„ÇíÂ§ñ„Åô
            }

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update(updateData)
                    .eq('discord_user_id', targetId);

                if (error) throw error;

                await loadOwnedBadges(); // „É™„Çπ„ÉàÊõ¥Êñ∞
                await loadTargetUserInfo(); // ÂêçÂâçÊ®™„ÅÆ„Éê„ÉÉ„Ç∏Êõ¥Êñ∞

                // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                const modalEl = document.getElementById('badgeChangeModal');
                bootstrap.Modal.getInstance(modalEl)?.hide();
            } catch (err) {
                console.error('Ë£ÖÁùÄ„Ç®„É©„Éº:', err);
                alert('„Éê„ÉÉ„Ç∏„ÅÆÂ§âÊõ¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // Ë£ÖÁùÄ„Éê„ÉÉ„Ç∏„ÅÆÂ§âÊõ¥„É¢„Éº„ÉÄ„É´
        async function openBadgeChangeModal() {
            selectedBadgeIdForEquip = null;
            const btnExec = document.getElementById('btn-execute-equip');
            if (btnExec) btnExec.disabled = true;

            const listEl = document.getElementById('badge-modal-list');
            listEl.innerHTML = '<p class="text-center text-muted py-3">Ë™≠„ÅøËæº„Åø‰∏≠...</p>';

            // „É©„Ç∏„Ç™„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÔºà1Âõû„Å†„ÅëË®≠ÂÆöÔºâ
            const posRadios = document.querySelectorAll('input[name="badge-position"]');
            posRadios.forEach(radio => {
                if (!radio.dataset.listenerAdded) {
                    radio.addEventListener('change', (e) => {
                        const indicator = document.getElementById('badge-position-indicator');
                        if (indicator) {
                            indicator.textContent = e.target.value === 'left' ? '‚óÄ Â∑¶„Å´Ë£ÖÁùÄ' : 'Âè≥„Å´Ë£ÖÁùÄ ‚ñ∂';
                        }
                    });
                    radio.dataset.listenerAdded = "true";
                }
            });

            // ÂàùÊúüÂåñ
            const leftRadio = document.getElementById('pos-left');
            const indicator = document.getElementById('badge-position-indicator');
            if (indicator) {
                if (leftRadio && leftRadio.checked) {
                    indicator.textContent = '‚óÄ Â∑¶„Å´Ë£ÖÁùÄ';
                } else {
                    indicator.textContent = 'Âè≥„Å´Ë£ÖÁùÄ ‚ñ∂';
                }
            }

            const modalEl = document.getElementById('badgeChangeModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();

            try {
                // ÊâÄÊåÅ„Éê„ÉÉ„Ç∏Ôºà„É¶„Éã„Éº„ÇØ„Å™ID„ÅÆ„ÅøÊäΩÂá∫Ôºâ
                const { data: owned, error } = await supabaseClient
                    .from('user_badges_new')
                    .select('badge_id, badges(*)')
                    .eq('user_id', targetId);

                if (error) throw error;

                const uniqueBadges = [];
                const seen = new Set();
                owned.forEach(item => {
                    if (item.badges && !seen.has(item.badge_id)) {
                        uniqueBadges.push(item.badges);
                        seen.add(item.badge_id);
                    }
                });

                const { data: profile } = await supabaseClient
                    .from('profiles').select('equipped_badge_id, equipped_badge_id_right').eq('discord_user_id', targetId).maybeSingle();
                const equippedLeftId = profile?.equipped_badge_id;
                const equippedRightId = profile?.equipped_badge_id_right;

                if (uniqueBadges.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-muted py-3">„Éê„ÉÉ„Ç∏„ÇíÊåÅ„Å£„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                    return;
                }

                listEl.innerHTML = uniqueBadges.map(badge => {
                    const isEquippedLeft = badge.id === equippedLeftId;
                    const isEquippedRight = badge.id === equippedRightId;
                    const isEquipped = isEquippedLeft || isEquippedRight;

                    let posLabel = '';
                    if (isEquippedLeft) posLabel = '‚óÄÂ∑¶';
                    if (isEquippedRight) posLabel = 'Âè≥‚ñ∂';
                    if (isEquippedLeft && isEquippedRight) posLabel = '‚óÄÂ∑¶Âè≥‚ñ∂';

                    return `
                                        <div class="col-4 col-md-3 text-center">
                                            <div class="badge-item ${isEquipped ? 'equipped' : ''}"
                                                data-badge-id="${badge.id}" onclick="selectBadgeInModal('${badge.id}')"
                                                style="cursor: pointer; position: relative;"
                                                title="${badge.name}${isEquipped ? ' (Ë£ÖÁùÄ‰∏≠)' : ''}">
                                                <img src="${badge.image_url}" alt="${badge.name}"
                                                    style="width: 60px; height: 60px; object-fit: contain;">
                                                ${isEquipped ? `<span
                                                    class="position-absolute top-0 start-50 translate-middle badge bg-primary"
                                                    style="font-size: 0.6rem; z-index: 10;">${posLabel}</span>` : ''}
                                            </div>
                                            <div class="small text-truncate mt-1" style="font-size: 0.7rem;">
                                                ${badge.name}</div>
                                        </div>
                                        `;
                }).join('');
            } catch (err) {
                console.error('„Éê„ÉÉ„Ç∏Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', err);
                listEl.innerHTML = '<p class="text-center text-danger py-3">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</p>';
            }
        }

        // ============ È∫ªÈõÄÁµ±Ë®àÊ©üËÉΩ ============
        let allMahjongRecords = [];
        let myAccountName = '';
        let currentMyTournament = 'Á¨¨‰∫åÂõûÈ∫ªÈõÄÂ§ß‰ºö';

        async function loadMahjongStats() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const targetUserId = urlParams.get('user');

                if (targetUserId) {
                    myAccountName = targetUserId;
                } else {
                    const user = await getCurrentUser();
                    if (!user) return;
                    myAccountName = user.user_metadata.provider_id;
                }

                // Á¨¨‰∫åÂõûÈ∫ªÈõÄÂ§ß‰ºö„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæóÔºàmatch_results„ÉÜ„Éº„Éñ„É´Ôºâ
                // Supabase„ÅÆ„Éá„Éï„Ç©„É´„Éà1000‰ª∂Âà∂Èôê„ÇíÂõûÈÅø„Åô„Çã„Åü„ÇÅ„ÄÅ„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÊòéÁ§∫ÁöÑ„Å´ÂèñÂæó
                let allCurrentData = [];
                let page = 0;
                const pageSize = 1000;

                while (true) {
                    const { data, error } = await supabaseClient
                        .from('match_results')
                        .select('*')
                        .range(page * pageSize, (page + 1) * pageSize - 1);

                    if (error) {
                        console.warn('Á¨¨‰∫åÂõû„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', error);
                        break;
                    }
                    if (!data || data.length === 0) break;

                    allCurrentData = allCurrentData.concat(data);

                    if (data.length < pageSize) break; page++;
                } console.log('‚úÖ „Éû„Ç§„Éö„Éº„Ç∏: match_resultsÂèñÂæóÂÆå‰∫Ü: ', allCurrentData.length, '‰ª∂'); const
                    currentData = allCurrentData; let legacyData = []; try {
                        const { data, error:
                            legacyError } = await supabaseClient.from('tournament_player_stats_snapshot')
                                .select('*'); if (!legacyError) legacyData = data || [];
                    } catch (e) {
                        console.warn('Á¨¨‰∏ÄÂõû„Éá„Éº„ÇøÂèñÂæó„Çπ„Ç≠„ÉÉ„Éó:', e);
                    } const taggedCurrentData = (currentData ||
                        []).map(r => ({ ...r, tournament_type: r.tournament_type || 'Á¨¨‰∫åÂõûÈ∫ªÈõÄÂ§ß‰ºö' }));
                const taggedLegacyData = (legacyData || []).map(r => ({
                    ...r,
                    tournament_type: r.tournament_type || 'Á¨¨‰∏ÄÂõûÈ∫ªÈõÄÂ§ß‰ºö'
                }));

                allMahjongRecords = [...taggedCurrentData, ...taggedLegacyData];
                renderTournamentDropdown();
                displayMahjongStats();
            } catch (err) {
                console.error('È∫ªÈõÄÁµ±Ë®àÂèñÂæó„Ç®„É©„Éº:', err);
                document.getElementById('stats-loading').style.display = 'none';
                document.getElementById('no-stats-msg').style.display = 'block';
            }
        }

        function renderTournamentDropdown() {
            const select = document.getElementById('tournament-select');
            if (!select) return;
            const tournaments = ['Á¨¨‰∫åÂõûÈ∫ªÈõÄÂ§ß‰ºö', 'Á¨¨‰∏ÄÂõûÈ∫ªÈõÄÂ§ß‰ºö'];
            let html = tournaments.map(t => `<option value="${t}"
                                                ${currentMyTournament === t ? 'selected' : ''}>${t}</option>`).join('');
            html += `<option value="all" ${currentMyTournament === 'all' ? 'selected' : ''
                }>ÂÖ®„Ç∑„Éº„Ç∫„É≥</option>`;
            select.innerHTML = html;
        }

        function handleTournamentChange() {
            const select = document.getElementById('tournament-select');
            currentMyTournament = select.value;
            displayMahjongStats();
        }

        let currentMahjongMode = 'individual_yonma'; // ÂõõÈ∫ª/‰∏âÈ∫ª/„ÉÅ„Éº„É†

        function handleModeChange() {
            const select = document.getElementById('mode-select');
            currentMahjongMode = select.value;
            displayMahjongStats();
        }

        function displayMahjongStats() {
            let records = allMahjongRecords;

            // Â§ß‰ºö„Éï„Ç£„É´„Çø„Éº
            if (currentMyTournament !== 'all') {
                records = records.filter(r => r.tournament_type === currentMyTournament);
            }

            // „É°„Ç§„É≥„Éï„Ç£„É´„Çø„ÉºÔºàÂØæÊà¶ÂΩ¢ÂºèÔºâ
            if (currentMahjongMode === 'team') {
                // „ÉÅ„Éº„É†Êà¶„ÅØ„Åæ„Å†„Éá„Éº„Çø„Åå„Å™„ÅÑ„ÅÆ„ÅßÁ©∫ÈÖçÂàó„Å´„Åô„Çã
                records = [];
            } else if (currentMahjongMode === 'individual_yonma') {
                records = records.filter(r => (r.mahjong_mode || r.mode) === 'ÂõõÈ∫ª');
            } else if (currentMahjongMode === 'individual_sanma') {
                records = records.filter(r => (r.mahjong_mode || r.mode) === '‰∏âÈ∫ª');
            }

            const playerStats = calculateAllPlayerStats(records);
            const myStats = playerStats.find(p => p.name === myAccountName);

            document.getElementById('stats-loading').style.display = 'none';
            document.getElementById('stats-content').style.display = 'block';

            const statsGrid = document.getElementById('stats-grid');
            const noStatsMsg = document.getElementById('no-stats-msg');

            if (!myStats || myStats.games === 0) {
                if (statsGrid) statsGrid.style.display = 'none';
                noStatsMsg.style.display = 'block';
                return;
            }
            if (statsGrid) statsGrid.style.display = 'block';
            noStatsMsg.style.display = 'none';

            const formatScore = (val) => (typeof val !== 'number') ? val :
                Math.round(val * 10) / 10;
            const games = myStats.games;

            updateStatCard('total', formatScore(myStats.total), playerStats, 'total',
                true, games);
            updateStatCard('avg-score', formatScore(myStats.avgScore), playerStats,
                'avgScore', true, games);
            updateStatCard('max-score', formatScore(myStats.maxScore), playerStats,
                'maxScore', true, games);
            updateStatCard('win-rate', myStats.winRate.toFixed(1) + '%', playerStats,
                'winRate', true, games);
            updateStatCard('deal-rate', myStats.dealRate.toFixed(1) + '%', playerStats,
                'dealRate', false, games);
            updateStatCard('skill', myStats.skill.toFixed(1) + '%', playerStats,
                'skill', true, games);
            updateStatCard('avg-rank', myStats.avgRank.toFixed(2), playerStats,
                'avgRank', false, games);
            updateStatCard('top-rate', myStats.topRate.toFixed(1) + '%', playerStats,
                'topRate', true, games);
            updateStatCard('avoid-rate', myStats.avoidRate.toFixed(1) + '%',
                playerStats, 'avoidRate', true, games);
            updateStatCard('games', myStats.games, playerStats, 'games', true, games);

            // Â±ÄÊï∞„Å®„É¨„Éº„ÉÜ„Ç£„É≥„Ç∞ÔºàÈ†Ü‰Ωç„Å™„ÅóÔºâ
            const handsEl = document.getElementById('stat-hands');
            if (handsEl) handsEl.textContent = myStats.hands || 0;

            const ratingEl = document.getElementById('stat-rating');
            if (ratingEl) ratingEl.textContent = '-'; // Êú™ÂÆüË£Ö

            // ÂØæÊà¶Áõ∏ÊâãÁµ±Ë®à„ÇíË®àÁÆó„ÉªË°®Á§∫
            displayOpponentStats(records, myAccountName);
        }

        function displayOpponentStats(records, myId) {
            const section = document.getElementById('opponent-stats-section');
            const topList = document.getElementById('top-opponents-list');
            const bestMatchup = document.getElementById('best-matchup');
            const worstMatchup = document.getElementById('worst-matchup');

            if (!section || !topList || !bestMatchup || !worstMatchup) return;

            // „Éó„É¨„Ç§„É§„ÉºIDÁâπÂÆö„É≠„Ç∏„ÉÉ„ÇØÔºàdiscord_user_id„Åå„ÅÇ„Çå„Å∞ÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞ÂêçÂâçÔºâ
            const getPlayerId = (r) => {
                let id = r.discord_user_id;
                if (!id || id === 'null') id = r.nickname || r.account_name || r.name ||
                    'Unknown';
                return String(id);
            };

            // Ë°®Á§∫ÂêçÁâπÂÆö„É≠„Ç∏„ÉÉ„ÇØÔºà„Éó„É≠„Éï„Ç£„Éº„É´„ÅÆÂêçÂâç„ÇíÂÑ™ÂÖàÔºâ
            const getDisplayName = (id, fallbackName) => {
                const profile = allProfiles.find(p => p.discord_user_id === String(id));
                return profile ? profile.account_name : (fallbackName || id);
            };

            // Ëá™ÂàÜ„ÅåÂèÇÂä†„Åó„ÅüË©¶Âêà„ÅÆmatch_id„ÇíÂèñÂæó
            // calculateAllPlayerStats„Å®ÂêåÊßò„ÅÆIDÊäΩÂá∫„É≠„Ç∏„ÉÉ„ÇØ„Çí‰ΩøÁî®
            const myMatches = records.filter(r => getPlayerId(r) === myId);
            const myMatchIds = [...new Set(myMatches.map(r => r.match_id).filter(id =>
                id))];

            if (myMatchIds.length === 0) {
                section.style.display = 'none';
                return;
            }

            // Âêå„Åòmatch_id„ÅÆ‰ªñ„Éó„É¨„Ç§„É§„Éº„ÇíÈõÜË®à
            const opponentData = {};

            myMatchIds.forEach(matchId => {
                const matchRecords = records.filter(r => r.match_id === matchId);
                const myRecord = matchRecords.find(r => getPlayerId(r) === myId);
                if (!myRecord) return;

                const myScore = Number(myRecord.final_score || myRecord.score_total || 0);

                matchRecords.forEach(r => {
                    const oppId = getPlayerId(r);
                    if (oppId === myId) return; // Ëá™ÂàÜ„ÅØÈô§Â§ñ

                    if (!opponentData[oppId]) {
                        opponentData[oppId] = {
                            count: 0,
                            myScoreSum: 0,
                            opponentScoreSum: 0,
                            fallbackName: r.nickname || r.account_name || r.name || oppId
                        };
                    }
                    opponentData[oppId].count++;
                    opponentData[oppId].myScoreSum += myScore;
                    opponentData[oppId].opponentScoreSum += Number(r.final_score ||
                        r.score_total || 0);
                });
            });

            const opponents = Object.entries(opponentData).map(([id, data]) => ({
                id,
                name: getDisplayName(id, data.fallbackName),
                count: data.count,
                scoreDiff: data.myScoreSum - data.opponentScoreSum
            }));

            if (opponents.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            // „Éà„ÉÉ„Éó3ÂØæÊà¶Áõ∏ÊâãÔºàÂõûÊï∞È†ÜÔºâ
            const top3 = [...opponents].sort((a, b) => b.count - a.count).slice(0, 3);
            topList.innerHTML = top3.map((opp, i) => {
                const medalColors = ['#ffd700', '#c0c0c0', '#cd7f32'];
                const medal = i < 3 ? `<span
                                                style="color: ${medalColors[i]}; font-weight: bold;">${i + 1}‰Ωç</span>` :
                    `${i + 1}‰Ωç`;

                // „Éó„É≠„Éï„Ç£„Éº„É´„Åã„Çâ„Ç¢„Éê„Çø„Éº„ÇíÂèñÂæó
                const profile = allProfiles.find(p => p.discord_user_id ===
                    String(opp.id));
                const avatarUrl = profile?.avatar_url ||
                    'https://cdn.discordapp.com/embed/avatars/0.png';

                // „É™„É≥„ÇØÂÖà„ÅÆË®≠ÂÆöÔºà„Éó„É≠„Éï„Ç£„Éº„É´„Åå„ÅÇ„Çå„Å∞„É™„É≥„ÇØÂåñÔºâ
                const linkUrl = profile ? `index.html?user=${opp.id}` : null;
                const wrapperStart = linkUrl ? `<a href="${linkUrl}"
                                                    class="text-decoration-none text-dark d-flex align-items-center gap-2 px-2 py-2 rounded"
                                                    style="background: #f8f9fa; border: 1px solid #eee; transition: background 0.2s;"
                                                    onmouseover="this.style.background='#e9ecef'"
                                                    onmouseout="this.style.background='#f8f9fa'">`
                    : `<div class="d-flex align-items-center gap-2 px-2 py-2 rounded"
                                                        style="background: #f8f9fa; border: 1px solid #eee;">`;
                const wrapperEnd = linkUrl ? `</a>` : `</div>`;

                return `
                                                ${wrapperStart}
                                                ${medal}
                                                <img src="${avatarUrl}" class="rounded-circle shadow-sm"
                                                    style="width: 24px; height: 24px; object-fit: cover;">
                                                <span class="fw-bold" style="font-size: 0.9rem;">${opp.name}</span>
                                                <span class="text-muted"
                                                    style="font-size: 0.8rem;">${opp.count}Ë©¶Âêà</span>
                                                ${wrapperEnd}
                                                `;
            }).join('');

            // „Éò„É´„Éë„Éº: „Éû„ÉÉ„ÉÅ„Ç¢„ÉÉ„Éó„Ç´„Éº„ÉâÁîüÊàê
            const createMatchupCard = (opp, isBest) => {
                if (!opp) return '<span class="text-muted small">-</span>';

                const profile = allProfiles.find(p => p.discord_user_id ===
                    String(opp.id));
                const avatarUrl = profile?.avatar_url ||
                    'https://cdn.discordapp.com/embed/avatars/0.png';
                const scoreClass = isBest ? 'text-success' : 'text-danger';
                const scorePrefix = isBest && opp.scoreDiff > 0 ? '+' : '';

                // „É™„É≥„ÇØË®≠ÂÆö
                const linkUrl = profile ? `index.html?user=${opp.id}` : null;
                const content = `
                                                <img src="${avatarUrl}" class="rounded-circle shadow-sm"
                                                    style="width: 20px; height: 20px; object-fit: cover;">
                                                <span class="fw-bold" style="font-size: 0.95rem;">${opp.name}</span>
                                                <span class="${scoreClass} fw-bold ms-auto"
                                                    style="font-size: 0.95rem;">${scorePrefix}${opp.scoreDiff.toFixed(1)}</span>
                                                `;

                if (linkUrl) {
                    return `<a href="${linkUrl}"
                                                    class="text-decoration-none text-dark d-flex align-items-center gap-2 w-100">${content}</a>`;
                } else {
                    return content;
                    // Êó¢Â≠ò„ÅÆÊßãÈÄ†‰∏ä„ÄÅÂ§ñÂÅ¥„ÅÆdiv„Å´„ÇØ„É©„Çπ„Åå„ÅÇ„Çã„ÅÆ„Åß„ÄÅÂÜÖÈÉ®Ë¶ÅÁ¥†„Å†„Åë„ÅßËâØ„ÅÑ„ÅãÁ¢∫Ë™ç„ÅåÂøÖË¶Å„Å†„Åå„ÄÅÂÖÉ„ÅÆÂÆüË£Ö„ÅØ innerHTML „Å´Áõ¥Êõ∏„Åç„Å†„Å£„Åü
                    // ÂÖÉ„ÅÆÂÆüË£Ö:
                    // bestMatchup.innerHTML = `...`;
                    // bestMatchup Ëá™‰Ωì„ÅØ div#best-matchup class="d-flex align-items-center gap - 2"
                    // „Åì„Åì„Åß‰∏≠Ë∫´„Çí <a> „ÅßÂåÖ„ÇÄ„Å® a „Åå flex item „Å´„Å™„Çã„ÄÇ
                    // a „Å´ w-100 d-flex align-items-center gap-2 „Çí„Å§„Åë„Çå„Å∞OK
                }
            };

            // ‰∏ÄÁï™Âãù„Å°Ë∂ä„Åó
            const bestOpp = [...opponents].sort((a, b) => b.scoreDiff -
                a.scoreDiff)[0];
            if (bestOpp && bestOpp.scoreDiff > 0) {
                bestMatchup.innerHTML = createMatchupCard(bestOpp, true);
            } else {
                bestMatchup.innerHTML = '<span class="text-muted small">-</span>';
            }

            // ‰∏ÄÁï™Ë≤†„ÅëË∂ä„Åó
            const worstOpp = [...opponents].sort((a, b) => a.scoreDiff -
                b.scoreDiff)[0];
            if (worstOpp && worstOpp.scoreDiff < 0) {
                worstMatchup.innerHTML = createMatchupCard(worstOpp, false);
            }
            else {
                worstMatchup.innerHTML = '<span class="text-muted small">-</span>'
                    ;
            }
        }
        function redirectToRanking(subFilter) {
            // ÁèæÂú®„ÅÆ„Éï„Ç£„É´„Çø„ÉºË®≠ÂÆö„ÇíÂèñÂæó
            const tournament = currentMyTournament;
            const main = currentMahjongMode;
            // Ëá™ÂàÜ„ÅÆID„ÇíÂèñÂæóÔºà„Ç¢„É≥„Ç´„ÉºÁî®Ôºâ 
            // myAccountName „ÅØ DiscordID „Åæ„Åü„ÅØ „Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã 
            const anchor = `#rank-player-${myAccountName}`;
            // URLÊßãÁØâ 
            const url = `../mahjong/index.html?tournament=${encodeURIComponent(tournament)}&main=${encodeURIComponent(main)}&sub=${encodeURIComponent(subFilter)}${anchor}`;
            // ÈÅ∑Áßª 
            window.location.href = url;
        }
        function updateStatCard(id,
            value, allStats, key, higherIsBetter, myGames) {
            const
                el = document.getElementById('stat-' + id); if (el)
                el.textContent = value;
            // 10Ë©¶Âêà‰ª•‰∏ä„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅÆ„Åø„Çí„É©„É≥„Ç≠„É≥„Ç∞ÂØæË±°„Å´„Åô„Çã 
            const qualified = [...allStats].filter(p => p.games >= 10);
            const sorted = qualified.sort((a, b) => higherIsBetter ? b[key]
                - a[key] : a[key] - b[key]);
            const myRank = sorted.findIndex(p => p.name === myAccountName) +
                1;
            const total = sorted.length;

            const rankEl = document.getElementById('rank-' + id);
            const cardEl = el ? el.closest('.stat-card-mini') : null;

            if (cardEl) {
                // Êó¢Â≠ò„ÅÆ„É©„É≥„ÇØ„ÇØ„É©„Çπ„ÇíÂâäÈô§
                cardEl.classList.remove('rank-1', 'rank-2', 'rank-3');
                // 10Ë©¶Âêà‰ª•‰∏ä„Åã„Å§3‰Ωç‰ª•ÂÜÖ„ÅÆÂ†¥Âêà„Å´„ÇØ„É©„Çπ„Çí‰ªò‰∏é
                if (myGames >= 10 && myRank >= 1 && myRank <= 3) {
                    cardEl.classList.add(`rank-${myRank}`);
                }
            } if (rankEl) {
                // Ëá™ÂàÜ„Åå10Ë©¶ÂêàÊú™Ê∫Ä„ÅÆÂ†¥Âêà„ÅØ„É©„É≥„ÇØÂ§ñ 
                if (myGames < 10) {
                    rankEl.textContent = '„É©„É≥„ÇØÂ§ñ'; rankEl.classList.add('no-data');
                } else if (myRank > 0) {
                    rankEl.textContent = `${myRank}/${total}‰Ωç`;
                    rankEl.classList.remove('no-data');
                } else {
                    rankEl.textContent = '-';
                    rankEl.classList.add('no-data');
                }
            }
        }

        function calculateAllPlayerStats(records) {
            const players = {};
            records.forEach(r => {
                let id = r.discord_user_id;
                if (!id || id === 'null') id = r.nickname || r.account_name
                    || 'Unknown';
                if (!id) return;

                if (!players[id]) {
                    players[id] = {
                        name: id, score: 0, sanma: 0, yonma: 0,
                        count: 0, win: 0, deal: 0, r1: 0, r2: 0, r3: 0, r4: 0,
                        max_score: -Infinity, hand_total: 0
                    };
                }

                const p = players[id];
                const mode = r.mahjong_mode || r.mode || '';

                if (r.tournament_type === 'Á¨¨‰∏ÄÂõûÈ∫ªÈõÄÂ§ß‰ºö') {
                    p.score += Number(r.score_total || 0);
                    p.count += Number(r.matches_played || 0);
                    p.r1 += Number(r.rank1_count || 0); p.r2 +=
                        Number(r.rank2_count || 0); p.r3 += Number(r.rank3_count ||
                            0); p.r4 += Number(r.rank4_count || 0);
                    p.max_score = Math.max(p.max_score, Number(r.score_max ||
                        0));
                    p.hand_total += Number(r.hands_played || 0);
                } else {
                    p.score += Number(r.final_score || 0);
                    p.count += 1;
                    const rk = Number(r.rank);
                    if (rk === 1) p.r1++; else if (rk === 2) p.r2++; else if (rk
                        === 3) p.r3++; else if (rk === 4) p.r4++;
                    p.max_score = Math.max(p.max_score, Number(r.final_score ||
                        0));
                    p.hand_total += Number(r.hand_count || 0);
                }
                p.win += Number(r.win_count || r.wins || 0);
                p.deal += Number(r.deal_in_count || r.deals || 0);
                if (mode === '‰∏âÈ∫ª') p.sanma += Number(r.final_score ||
                    r.score_total || 0);
                if (mode === 'ÂõõÈ∫ª') p.yonma += Number(r.final_score ||
                    r.score_total || 0);
            });

            return Object.values(players).map(p => {
                const count = p.count;
                const hands = p.hand_total;
                return {
                    name: p.name, total: p.score, sanma: p.sanma, yonma:
                        p.yonma,
                    avgScore: count > 0 ? p.score / count : 0,
                    maxScore: p.max_score === -Infinity ? 0 : p.max_score,
                    // Âíå‰∫ÜÁéá„ÉªÊîæÈäÉÁéá„ÅØÂ±ÄÊï∞„Éô„Éº„Çπ„ÅßË®àÁÆóÔºà%Ôºâ
                    winRate: hands > 0 ? (p.win / hands * 100) : 0,
                    dealRate: hands > 0 ? (p.deal / hands * 100) : 0,
                    // „Éê„É©„É≥„ÇπÈõÄÂäõ = (Âíå‰∫ÜÊï∞ - ÊîæÈäÉÊï∞) / Â±ÄÊï∞ * 100
                    skill: hands > 0 ? ((p.win - p.deal) / hands * 100) : 0,
                    avgRank: count > 0 ? (1 * p.r1 + 2 * p.r2 + 3 * p.r3 + 4 *
                        p.r4) / count : 0,
                    topRate: count > 0 ? (p.r1 / count) * 100 : 0,
                    avoidRate: count > 0 ? (1 - ((p.r4 === 0 && p.r3 > 0 ? p.r3
                        : p.r4) / count)) * 100 : 0,
                    games: count,
                    hands: hands
                };
            });
        }

        // Êàª„Çã„Éú„Çø„É≥
        function goBack() {
            if (document.referrer &&
                document.referrer.includes(location.hostname))
                history.back();
            else location.href = '../index.html';
        }

        function toggleLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.toggle('active', show);
        }

        document.addEventListener('DOMContentLoaded', initPage);
    </script>

    <!-- „Ç≥„Ç§„É≥ÈÄÅÈáë„Å®„É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢ -->
    <script>
        let currentSelectMode = '';
        async function openUserSelectModal(mode) {
            currentSelectMode = mode;
            const listEl = document.getElementById('transfer-user-list');
            listEl.innerHTML = '<p class="text-center text-muted py-3">Ë™≠„ÅøËæº„Åø‰∏≠...</p>';
            new bootstrap.Modal(document.getElementById('userSelectModal')).show();

            try {
                const { data: profiles, error } = await supabaseClient
                    .from('profiles')
                    .select('discord_user_id, account_name, avatar_url, equipped_badge_id, badges!equipped_badge_id(image_url)')
                    .neq('discord_user_id', targetId)
                    .order('account_name');

                if (error) throw error;
                listEl.innerHTML = profiles.map(p => `
                    <div class="user-select-item" onclick="confirmSelection('${p.discord_user_id}', '${p.account_name.replace(/'/g, "\\'")}')">
                        <img src="${p.avatar_url || 'https://cdn.discordapp.com/embed/avatars/0.png'}" class="user-select-avatar">
                        <span class="user-select-name">${p.account_name}</span>
                        ${p.badges ? `<img src="${p.badges.image_url}" class="user-select-badge">` : ''}
                    </div>
                `).join('');
            } catch (err) {
                listEl.innerHTML = '<p class="text-center text-danger py-3">Ë™≠„ÅøËæº„ÅøÂ§±Êïó</p>';
            }
        }

        let selectedToUserId = '';
        let selectedToUserName = '';
        function confirmSelection(id, name) {
            selectedToUserId = id;
            selectedToUserName = name;
            bootstrap.Modal.getInstance(document.getElementById('userSelectModal'))?.hide();
            if (currentSelectMode === 'coin_transfer') {
                document.getElementById('coin-transfer-target-name').textContent = `${name} „Åï„Çì„Å∏ÈÄÅÈáë`;
                // ÊâÄÊåÅÈáë„ÇíË°®Á§∫„Å´ÂèçÊò†
                const myProfile = allProfiles.find(p => p.discord_user_id === targetId);
                const currentCoins = (myProfile && myProfile.coins !== undefined) ? myProfile.coins : 0;
                const coinsRefEl = document.getElementById('my-coins-ref');
                if (coinsRefEl) coinsRefEl.textContent = currentCoins.toLocaleString();

                new bootstrap.Modal(document.getElementById('coinAmountModal')).show();
            } else if (currentSelectMode === 'badge_transfer') {
                const msg = `„Äå${currentActionBadgeName}„Äç„Çí ${name} „Åï„Çì„Å´Ë≠≤Ê∏°„Åó„Åæ„Åô„ÅãÔºü\n\n` +
                    (currentActionDetails || '');
                if (confirm(msg)) {
                    executeBadgeTransfer(id, name);
                }
            } else if (currentSelectMode === 'ticket_transfer') {
                executeTicketTransfer(id, name);
            } else if (currentSelectMode === 'gacha_ticket_transfer') {
                executeGachaTicketTransfer(id, name);
            }
        }

        async function executeBadgeTransfer(toUserId, toUserName) {
            toggleLoading(true);
            try {
                // 1. „Éê„ÉÉ„Ç∏„ÅÆ user_id „ÇíÂ§âÊõ¥
                const { error: updateError } = await supabaseClient
                    .from('user_badges_new')
                    .update({ user_id: toUserId })
                    .eq('uuid', currentActionUUID);

                if (updateError) throw updateError;

                // 2. Ê¥ªÂãï„É≠„Ç∞„ÇíË®òÈå≤
                if (typeof logActivity === 'function') {
                    const sender = allProfiles.find(p => p.discord_user_id === targetId);
                    const senderName = sender?.account_name || 'Ë™∞„Åã';

                    // „Éê„ÉÉ„Ç∏ID(Êï¥Êï∞)„ÇíÂèñÂæó
                    const { data: bInfo } = await supabaseClient.from('user_badges_new').select('badge_id').eq('uuid', currentActionUUID).single();
                    const bId = bInfo?.badge_id;

                    await logActivity(targetId, 'badge_transfer', {
                        badgeId: bId, // UUID„Åß„ÅØ„Å™„ÅèÊï¥Êï∞ID„ÇíÊ∏°„Åô
                        targetUserId: toUserId,
                        details: { target_name: toUserName, badge_name: currentActionBadgeName, badge_uuid: currentActionUUID }
                    });
                    await logActivity(toUserId, 'badge_receive', {
                        badgeId: bId, // UUID„Åß„ÅØ„Å™„ÅèÊï¥Êï∞ID„ÇíÊ∏°„Åô
                        targetUserId: targetId,
                        details: { sender_name: senderName, badge_name: currentActionBadgeName, badge_uuid: currentActionUUID }
                    });
                }

                alert(`${toUserName} „Åï„Çì„Å´„Éê„ÉÉ„Ç∏„ÇíË≠≤Ê∏°„Åó„Åæ„Åó„ÅüÔºÅ`);
                // „Éò„ÉÉ„ÉÄ„Éº„ÅÆÊâÄÊåÅÈáë„Éª„Éê„ÉÉ„Ç∏ÊÉÖÂ†±„ÇÇÊõ¥Êñ∞
                await loadOwnedBadges();
                await loadTargetUserInfo(); // Ë£ÖÁùÄ„Éê„ÉÉ„Ç∏„ÅåË≠≤Ê∏°„Åï„Çå„ÅüÂ†¥ÂêàËá™Âãï„ÅßÂ§ñ„Åô
                await loadActivityLogs();
                if (!isViewMode) {
                    const user = await getCurrentUser();
                    if (user) await displayMyInfo(user);
                }
            } catch (err) {
                console.error('Ë≠≤Ê∏°„Ç®„É©„Éº:', err);
                alert('Ë≠≤Ê∏°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            } finally {
                toggleLoading(false);
            }
        }

        async function executeCoinTransfer() {
            const amount = parseInt(document.getElementById('coin-transfer-amount').value);
            if (!amount || amount <= 0) return alert('ÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');

            toggleLoading(true);
            try {
                const { data, error } = await supabaseClient.rpc('transfer_coins', {
                    p_amount: amount,
                    p_from_id: targetId,
                    p_to_id: selectedToUserId
                });

                if (error) throw error;
                if (!data.ok) throw new Error(data.error || 'ÈÄÅÈáë„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');

                alert(`${selectedToUserName} „Åï„Çì„Å´ ü™ô${amount.toLocaleString()} ÈÄÅÈáë„Åó„Åæ„Åó„Åü„ÄÇ`);
                // Ê¥ªÂãï„É≠„Ç∞Ë®òÈå≤
                if (typeof logActivity === 'function') {
                    const sender = allProfiles.find(p => p.discord_user_id === targetId);
                    const senderName = sender?.account_name || 'Ë™∞„Åã';

                    await logActivity(targetId, 'transfer_send', {
                        amount: -amount, // ÈÄÅÈáë„ÅØ„Éû„Ç§„Éä„Çπ
                        targetUserId: selectedToUserId,
                        details: { target_name: selectedToUserName }
                    });
                    await logActivity(selectedToUserId, 'transfer_receive', {
                        amount: amount,
                        targetUserId: targetId,
                        details: { sender_name: senderName }
                    });
                }

                // UIÊõ¥Êñ∞
                if (!isViewMode) {
                    const user = await getCurrentUser();
                    if (user) await displayMyInfo(user);
                }
                await loadOwnedBadges();
                await loadActivityLogs();
            } catch (err) {
                console.error('ÈÄÅÈáë„Ç®„É©„Éº:', err);
                alert('ÈÄÅÈáëÂ§±Êïó: ' + (err.message || '‰∏çÊòé„Å™„Ç®„É©„Éº'));
            } finally {
                toggleLoading(false);
            }
        }

        /**
         * ÂºïÊèõÂà∏„ÅÆË≠≤Ê∏°ÂÆüË°å
         */
        async function executeTicketTransfer(toUserId, toUserName) {
            const amountStr = prompt(`„Äå${currentTicketRarity}ÂºïÊèõÂà∏„Äç„Çí‰ΩïÊûöË≠≤Ê∏°„Åó„Åæ„Åô„ÅãÔºü (ÊúÄÂ§ß: ${currentTicketMax}Êûö)`, "1");
            if (amountStr === null) return; // „Ç≠„É£„É≥„Çª„É´
            const amount = parseInt(amountStr);
            if (isNaN(amount) || amount <= 0) return alert('ÊúâÂäπ„Å™ÊûöÊï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            if (amount > currentTicketMax) return alert('ÊâÄÊåÅÊï∞‰ª•‰∏ä„ÅÆÊûöÊï∞„ÅØË≠≤Ê∏°„Åß„Åç„Åæ„Åõ„Çì');

            toggleLoading(true);
            try {
                const { data, error } = await supabaseClient.rpc('transfer_exchange_tickets', {
                    p_from_id: targetId,
                    p_to_id: toUserId,
                    p_rarity: currentTicketRarity,
                    p_amount: amount
                });

                if (error) throw error;
                if (!data.ok) throw new Error(data.error);

                alert(`${toUserName} „Åï„Çì„Å´ ${currentTicketRarity}ÂºïÊèõÂà∏ „Çí ${amount}Êûö Ë≠≤Ê∏°„Åó„Åæ„Åó„ÅüÔºÅ`);

                // Ê¥ªÂãï„É≠„Ç∞Ë®òÈå≤
                if (typeof logActivity === 'function') {
                    const sender = allProfiles.find(p => p.discord_user_id === targetId);
                    const senderName = sender?.account_name || 'Ë™∞„Åã';

                    await logActivity(targetId, 'badge_transfer', {
                        amount: 0,
                        targetUserId: toUserId,
                        details: { target_name: toUserName, badge_name: `${currentTicketRarity}ÂºïÊèõÂà∏ x${amount}` }
                    });
                    await logActivity(toUserId, 'badge_receive', {
                        amount: 0,
                        targetUserId: targetId,
                        details: { sender_name: senderName, badge_name: `${currentTicketRarity}ÂºïÊèõÂà∏ x${amount}` }
                    });
                }

                // UIÊõ¥Êñ∞
                await openPossessionsModal();
                await loadActivityLogs();
            } catch (err) {
                console.error('ÂºïÊèõÂà∏Ë≠≤Ê∏°„Ç®„É©„Éº:', err);
                alert('Ë≠≤Ê∏°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (err.message || '‰∏çÊòé„Å™„Ç®„É©„Éº'));
            } finally {
                toggleLoading(false);
            }
        }

        /**
         * Á•àÈ°òÁ¨¶„ÅÆË≠≤Ê∏°ÂÆüË°å
         */
        async function executeGachaTicketTransfer(toUserId, toUserName) {
            const amountStr = prompt(`„ÄåÁ•àÈ°òÁ¨¶„Äç„Çí‰ΩïÊûöË≠≤Ê∏°„Åó„Åæ„Åô„ÅãÔºü (ÊúÄÂ§ß: ${currentTicketMax}Êûö)`, "1");
            if (amountStr === null) return;
            const amount = parseInt(amountStr);
            if (isNaN(amount) || amount <= 0) return alert('ÊúâÂäπ„Å™ÊûöÊï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            if (amount > currentTicketMax) return alert('ÊâÄÊåÅÊï∞‰ª•‰∏ä„ÅÆÊûöÊï∞„ÅØË≠≤Ê∏°„Åß„Åç„Åæ„Åõ„Çì');

            toggleLoading(true);
            try {
                const { data, error } = await supabaseClient.rpc('transfer_gacha_tickets', {
                    p_from_id: targetId,
                    p_to_id: toUserId,
                    p_amount: amount
                });

                if (error) throw error;
                if (!data.ok) throw new Error(data.error);

                alert(`${toUserName} „Åï„Çì„Å´ Á•àÈ°òÁ¨¶ „Çí ${amount}Êûö Ë≠≤Ê∏°„Åó„Åæ„Åó„ÅüÔºÅ`);

                // Ê¥ªÂãï„É≠„Ç∞Ë®òÈå≤
                if (typeof logActivity === 'function') {
                    const sender = allProfiles.find(p => p.discord_user_id === targetId);
                    const senderName = sender?.account_name || 'Ë™∞„Åã';

                    await logActivity(targetId, 'badge_transfer', {
                        amount: 0,
                        targetUserId: toUserId,
                        details: { target_name: toUserName, badge_name: `Á•àÈ°òÁ¨¶ x${amount}` }
                    });
                    await logActivity(toUserId, 'badge_receive', {
                        amount: 0,
                        targetUserId: targetId,
                        details: { sender_name: senderName, badge_name: `Á•àÈ°òÁ¨¶ x${amount}` }
                    });
                }

                // UIÊõ¥Êñ∞
                await openPossessionsModal();
                await loadActivityLogs();
                // Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÁ•àÈ°òÁ¨¶ÊûöÊï∞„ÇÇÊõ¥Êñ∞
                const countEl = document.getElementById('user-tickets-value');
                if (countEl) {
                    const current = parseInt(countEl.textContent.replace(/,/g, '')) || 0;
                    countEl.textContent = (current - amount).toLocaleString();
                }
            } catch (err) {
                console.error('Á•àÈ°òÁ¨¶Ë≠≤Ê∏°„Ç®„É©„Éº:', err);
                alert('Ë≠≤Ê∏°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (err.message || '‰∏çÊòé„Å™„Ç®„É©„Éº'));
            } finally {
                toggleLoading(false);
            }
        }
        function openCoinTransferModal() { openUserSelectModal('coin_transfer'); }

        /**
         * ÊâÄÊåÅÂìÅ„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
         */
        async function openPossessionsModal() {
            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('gacha_tickets, exchange_tickets')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            if (error) {
                console.error('ÊâÄÊåÅÂìÅÂèñÂæó„Ç®„É©„Éº:', error);
                return;
            }

            const gachaTickets = profile?.gacha_tickets || 0;
            document.getElementById('modal-tickets-count').textContent = gachaTickets.toLocaleString();

            const ticketsParent = document.getElementById('modal-tickets-count').parentElement.parentElement;
            if (!isViewMode && gachaTickets > 0 && !document.getElementById('gacha-ticket-transfer-btn')) {
                const transferBtn = document.createElement('button');
                transferBtn.id = 'gacha-ticket-transfer-btn';
                transferBtn.className = 'btn btn-sm btn-outline-warning rounded-pill py-0 px-2 ms-2';
                transferBtn.style.fontSize = '0.65rem';
                transferBtn.textContent = 'üéÅ Ë≠≤Ê∏°';
                transferBtn.onclick = () => {
                    currentTicketMax = gachaTickets;
                    const modalEl = document.getElementById('possessionsModal');
                    bootstrap.Modal.getInstance(modalEl)?.hide();
                    openUserSelectModal('gacha_ticket_transfer');
                };
                document.getElementById('modal-tickets-count').parentElement.appendChild(transferBtn);
            } else if (gachaTickets <= 0 && document.getElementById('gacha-ticket-transfer-btn')) {
                document.getElementById('gacha-ticket-transfer-btn').remove();
            }

            const listEl = document.getElementById('exchange-tickets-list');
            const exchanges = profile?.exchange_tickets || {};

            if (Object.keys(exchanges).length === 0) {
                listEl.innerHTML = '<div class="col-12 text-center text-muted py-3">ÊâÄÊåÅ„Åó„Å¶„ÅÑ„ÇãÂºïÊèõÂà∏„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
            } else {
                listEl.innerHTML = Object.entries(exchanges).map(([rarity, count]) => {
                    if (count <= 0) return '';
                    const rarityClass = getRarityClass(rarity);
                    return `
                        <div class="col-6 mb-3">
                            <div class="card shadow-sm border-0 ${rarityClass} p-2 text-center position-relative" style="border-radius: 12px; border: 1px solid rgba(0,0,0,0.1) !important;">
                                <div class="small fw-bold opacity-75 mb-1">${rarity}ÂºïÊèõÂà∏</div>
                                <div class="d-flex align-items-center justify-content-center gap-2 mb-2">
                                    <span style="font-size: 1.2rem;">üé´</span>
                                    <div class="fs-5 fw-bold">${count}Êûö</div>
                                </div>
                                ${!isViewMode ? `
                                    <button class="btn btn-sm btn-outline-dark rounded-pill py-0 px-2" style="font-size: 0.65rem;" 
                                        onclick="initTicketTransfer('${rarity}', ${count})">
                                        üéÅ Ë≠≤Ê∏°
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            const modal = new bootstrap.Modal(document.getElementById('possessionsModal'));
            modal.show();
        }

        let currentTicketRarity = '';
        let currentTicketMax = 0;
        function initTicketTransfer(rarity, count) {
            currentTicketRarity = rarity;
            currentTicketMax = count;
            // ÊâÄÊåÅÂìÅ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            const modalEl = document.getElementById('possessionsModal');
            bootstrap.Modal.getInstance(modalEl)?.hide();
            openUserSelectModal('ticket_transfer');
        }
    </script>

    <!-- „ÉÅ„Éº„É†ÈÄöÁü•„Éê„ÉÉ„Ç∏ -->
    <script>
        async function checkTeamNotifications() {
            const user = await getCurrentUser();
            if (!user) return;
            const discordId = user.user_metadata.provider_id;
            const { data: myTeams } = await supabaseClient.from('teams').select('id').eq('creator_discord_id', discordId);
            if (!myTeams || myTeams.length === 0) return;

            const teamIds = myTeams.map(t => t.id);
            const { data: pendingRequests } = await supabaseClient.from('team_join_requests').select('id').in('team_id', teamIds).in('status', ['pending', 'leave_pending']);
            const count = pendingRequests?.length || 0;

            if (count > 0) {
                const badge = document.getElementById('team-notification-badge');
                if (badge) {
                    badge.textContent = count;
                    badge.style.display = 'inline';
                }
            }
        }
        document.addEventListener('DOMContentLoaded', checkTeamNotifications);
    </script>


    <!-- Ê±éÁî®„Ç§„É≥„Éô„É≥„Éà„É™„É¢„Éº„ÉÄ„É´ (Â£≤Âç¥„ÉªË≠≤Ê∏°ÂÖ±ÈÄö) -->
    <div class="modal fade" id="universalInventoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
                <div class="modal-header border-0 bg-white pb-0">
                    <div>
                        <h5 class="modal-title fw-bold" id="universalInventoryTitle">„Éê„ÉÉ„Ç∏ÈÅ∏Êäû</h5>
                        <p class="text-muted small mb-0" id="universalInventorySubtitle">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-light">
                    <!-- „Éï„Ç£„É´„Çø„Éº„Ç®„É™„Ç¢ -->
                    <div class="card border-0 shadow-sm mb-3" style="border-radius: 12px;">
                        <div class="card-body p-3">
                            <div class="row g-2">
                                <div class="col-12 col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0"><i
                                                class="bi bi-search"></i></span>
                                        <input type="text" id="inventory-search"
                                            class="form-control border-start-0 ps-0" placeholder="„Éê„ÉÉ„Ç∏Âêç„ÅßÊ§úÁ¥¢..."
                                            oninput="renderUniversalInventory()">
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <select class="form-select" id="inventory-sort"
                                        onchange="renderUniversalInventory()">
                                        <option value="acquired_desc">ÂÖ•Êâã: Êñ∞„Åó„ÅÑÈ†Ü</option>
                                        <option value="acquired_asc">ÂÖ•Êâã: Âè§„ÅÑÈ†Ü</option>
                                        <option value="rarity_desc">‰æ°ÂÄ§: È´ò„ÅÑÈ†Ü</option>
                                        <option value="rarity_asc">‰æ°ÂÄ§: ‰Ωé„ÅÑÈ†Ü</option>
                                        <option value="name_asc">ÂêçÂâç: ‰∫îÂçÅÈü≥È†Ü</option>
                                    </select>
                                </div>
                                <div class="col-6 col-md-4">
                                    <select class="form-select" id="inventory-filter"
                                        onchange="renderUniversalInventory()">
                                        <option value="all">„Åô„Åπ„Å¶Ë°®Á§∫</option>
                                        <option value="fixed">Âõ∫ÂÆöÂûã„ÅÆ„Åø</option>
                                        <option value="variable">Â§âÂãïÂûã„ÅÆ„Åø</option>
                                        <option value="mutant">‚ú® „Éü„É•„Éº„Çø„É≥„Éà„ÅÆ„Åø</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- „É™„Çπ„Éà„Ç®„É™„Ç¢ -->
                    <div id="inventory-list" class="vstack gap-2">
                        <!-- JS„ÅßÊèèÁîª -->
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
                <!-- „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ -->
                <div class="modal-footer border-0 bg-white justify-content-center py-2" id="inventory-pagination-area">
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="inventory-pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Â£≤Âç¥„Ç¢„ÇØ„Ç∑„Éß„É≥Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´Ôºà„Ç∑„Éß„ÉÉ„ÉóÁî®ÂÜçÂà©Áî®Ôºâ -->
    <div class="modal fade" id="shopActionModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0" style="border-radius: 20px;">
                <div class="modal-body p-4 text-center">
                    <div id="shopActionContent"></div>
                    <div class="mt-4 d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-secondary rounded-pill px-4"
                            data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                        <button type="button" id="btnShopActionExec"
                            class="btn btn-danger rounded-pill px-4">ÂÆüË°å„Åô„Çã</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // Ê±éÁî®„Ç§„É≥„Éô„É≥„Éà„É™„ÉªÂ£≤Âç¥„ÉªË≠≤Ê∏°„É≠„Ç∏„ÉÉ„ÇØ„ÅÆÂæ©Êóß
        // ==========================================
        let currentInventoryMode = 'sell'; // 'sell' | 'transfer'
        let allInventoryBadges = [];
        let currentInventoryPage = 1;
        const INVENTORY_ITEMS_PER_PAGE = 10;
        let expandedBadgeId = null;
        let currentShopActionUUID = null;

        /**
         * „É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè„Ç®„É≥„Éà„É™„Éù„Ç§„É≥„Éà
         * @param {string} mode - 'sell' or 'transfer'
         */
        async function openModernInventory(mode) {
            currentInventoryMode = mode;
            const title = document.getElementById('universalInventoryTitle');
            const subtitle = document.getElementById('universalInventorySubtitle');

            if (mode === 'sell') {
                title.textContent = '„Éê„ÉÉ„Ç∏„ÅÆÂ£≤Âç¥';
                subtitle.textContent = 'Â£≤Âç¥„Åó„Åü„ÅÑ„Éê„ÉÉ„Ç∏„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                title.className = 'modal-title fw-bold text-danger';
            } else if (mode === 'transfer') {
                title.textContent = '„Éê„ÉÉ„Ç∏„ÅÆË≠≤Ê∏°';
                subtitle.textContent = 'Ë≠≤Ê∏°„Åó„Åü„ÅÑ„Éê„ÉÉ„Ç∏„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                title.className = 'modal-title fw-bold text-primary';
            }

            const modal = new bootstrap.Modal(document.getElementById('universalInventoryModal'));
            modal.show();

            await loadInventory();
        }

        async function loadInventory() {
            const listEl = document.getElementById('inventory-list');
            listEl.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';

            try {
                const user = await getCurrentUser();
                if (!user) return;
                const myId = user.user_metadata.provider_id;

                // ÊâÄÊåÅ„Éê„ÉÉ„Ç∏ÂèñÂæó
                const { data: myBadges, error } = await supabaseClient
                    .from('user_badges_new')
                    .select('*, badges(*)')
                    .eq('user_id', myId)
                    .order('acquired_at', { ascending: false });

                if (error) throw error;

                // ÈñæÂÄ§ÂèñÂæó
                const { data: thresholds } = await supabaseClient.from('rarity_thresholds').select('*').order('threshold_value', { ascending: true });

                // „Éû„Éº„Ç±„ÉÉ„ÉàÊµÅÈÄöÊï∞ÂèñÂæó (Á∞°ÊòìÁâà: Ëá™ÂàÜ„ÅÆÊåÅ„Å°Áâ©„Å´„ÅÇ„Çã„Éê„ÉÉ„Ç∏ID„Å´„Å§„ÅÑ„Å¶„ÅÆ„ÅøÈõÜË®à)
                const badgeIds = [...new Set(myBadges.map(ub => ub.badge_id))];
                let marketCounts = {};
                if (badgeIds.length > 0) {
                    const { data: allOwned } = await supabaseClient.from('user_badges_new').select('badge_id').in('badge_id', badgeIds);
                    if (allOwned) {
                        allOwned.forEach(o => {
                            marketCounts[o.badge_id] = (marketCounts[o.badge_id] || 0) + 1;
                        });
                    }
                }

                // „Éá„Éº„ÇøÂä†Â∑•
                allInventoryBadges = myBadges.map(inventoryItem => {
                    const badge = inventoryItem.badges;
                    if (!badge) return null;
                    if (badge.sales_type === 'ÈôêÂÆöÂìÅ') return null; // ÈôêÂÆöÂìÅ„ÅØÂ£≤Âç¥„ÉªË≠≤Ê∏°„É™„Çπ„Éà„Å´Âá∫„Åï„Å™„ÅÑ

                    const count = marketCounts[badge.id] || 1;
                    const valResult = BadgeUtils.calculateBadgeValues(badge, count, thresholds || []);
                    const sellPrice = valResult.sellPrice * (inventoryItem.is_mutant ? 3 : 1);

                    return {
                        ...inventoryItem,
                        badge_name: badge.name,
                        badge_image_url: badge.image_url,
                        rarity: badge.rarity,
                        rarity_name: valResult.rarityName,
                        market_value: valResult.marketValue,
                        sell_price: sellPrice,
                        purchased_price: inventoryItem.purchased_price,
                        is_mutant: inventoryItem.is_mutant,
                        sales_type: badge.sales_type,
                        acquired_at: new Date(inventoryItem.acquired_at)
                    };
                }).filter(i => i !== null);

                renderUniversalInventory();

            } catch (err) {
                console.error('Inventory Load Error:', err);
                listEl.innerHTML = '<div class="text-center text-danger">Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº</div>';
            }
        }

        function renderUniversalInventory() {
            const listEl = document.getElementById('inventory-list');
            const searchVal = document.getElementById('inventory-search').value.toLowerCase();
            const sortVal = document.getElementById('inventory-sort').value;
            const filterVal = document.getElementById('inventory-filter').value;

            // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            let filtered = allInventoryBadges.filter(item => {
                if (searchVal && !item.badge_name.toLowerCase().includes(searchVal)) return false;
                if (filterVal === 'mutant' && !item.is_mutant) return false;
                if (filterVal === 'fixed' && item.sales_type !== 'Âõ∫ÂÆöÂûã') return false;
                if (filterVal === 'variable' && item.sales_type !== 'Â§âÂãïÂûã') return false;
                return true;
            });

            // „ÇΩ„Éº„Éà
            filtered.sort((a, b) => {
                if (sortVal === 'acquired_desc') return b.acquired_at - a.acquired_at;
                if (sortVal === 'acquired_asc') return a.acquired_at - b.acquired_at;
                if (sortVal === 'name_asc') return a.badge_name.localeCompare(b.badge_name);
                if (sortVal === 'rarity_desc') return b.market_value - a.market_value;
                if (sortVal === 'rarity_asc') return a.market_value - b.market_value;
                return 0;
            });

            // „Ç∞„É´„Éº„Éî„É≥„Ç∞
            const groups = new Map();
            filtered.forEach(item => {
                if (!groups.has(item.badge_id)) {
                    groups.set(item.badge_id, {
                        badge_id: item.badge_id,
                        badge_name: item.badge_name,
                        badge_image_url: item.badge_image_url,
                        items: []
                    });
                }
                groups.get(item.badge_id).items.push(item);
            });
            const groupArray = Array.from(groups.values());

            // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥
            const totalPages = Math.ceil(groupArray.length / INVENTORY_ITEMS_PER_PAGE);
            if (currentInventoryPage > totalPages && totalPages > 0) currentInventoryPage = totalPages;
            if (currentInventoryPage < 1) currentInventoryPage = 1;

            const start = (currentInventoryPage - 1) * INVENTORY_ITEMS_PER_PAGE;
            const end = start + INVENTORY_ITEMS_PER_PAGE;
            const pageGroups = groupArray.slice(start, end);

            // ÊèèÁîª
            if (pageGroups.length === 0) {
                listEl.innerHTML = '<div class="text-center py-4 text-muted">Ë©≤ÂΩì„Åô„Çã„Éê„ÉÉ„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                document.getElementById('inventory-pagination-area').style.display = 'none';
                return;
            }
            document.getElementById('inventory-pagination-area').style.display = 'block';

            listEl.innerHTML = pageGroups.map(group => {
                const isExpanded = expandedBadgeId === group.badge_id;
                const totalCount = group.items.length;
                const mutantCount = group.items.filter(i => i.is_mutant).length;
                const repItem = group.items[0];
                const rarityClass = getRarityClass(repItem.rarity_name || '');

                let actionArea = '';
                let detailHtml = '';

                // „Éú„Çø„É≥„ÅÆ„É©„Éô„É´„Å®„ÇØ„É©„Çπ„Çí„É¢„Éº„Éâ„Å´„Çà„Å£„Å¶Âàá„ÇäÊõø„Åà
                const btnLabel = currentInventoryMode === 'sell' ? 'Â£≤Âç¥' : 'Ë≠≤Ê∏°';
                const btnClass = currentInventoryMode === 'sell' ? 'btn-outline-danger' : 'btn-outline-primary';

                if (totalCount === 1) {
                    // Âçò‰∏Ä„Ç¢„Ç§„ÉÜ„É†
                    actionArea = `<button class="btn btn-sm ${btnClass} rounded-pill text-nowrap" 
                        onclick="confirmActionFromInventory('${repItem.uuid}')">
                        ${btnLabel}
                     </button>`;
                } else {
                    // Ë§áÊï∞„ÅÇ„Çä -> Â±ïÈñã„Éú„Çø„É≥
                    actionArea = `<button class="btn btn-sm ${isExpanded ? 'btn-secondary' : 'btn-primary'} rounded-pill text-nowrap" 
                        onclick="toggleInventoryExpand('${group.badge_id}')">
                        ${isExpanded ? 'Èñâ„Åò„Çã' : 'ÈÅ∏Êäû'}
                     </button>`;

                    if (isExpanded) {
                        const listItemsHtml = group.items.map(item => {
                            const isMutant = item.is_mutant;
                            let imgHtml = isMutant ?
                                `<div class="mutant-badge-container mini active me-3" style="width: 40px; height: 40px;">
                                    <div class="mutant-badge-shine"></div>
                                    <img src="${group.badge_image_url}" class="w-100 h-100 object-fit-contain">
                                </div>` :
                                `<img src="${group.badge_image_url}" class="rounded me-3" style="width: 40px; height: 40px; object-fit: contain;">`;

                            const itemStyle = isMutant ? 'border: 2px solid gold; background: #fffdf5;' : 'border: 1px solid #eee;';

                            return `
                                <div class="d-flex align-items-center justify-content-between p-2 rounded bg-white" style="${itemStyle}">
                                    <div class="d-flex align-items-center overflow-hidden">
                                        ${imgHtml}
                                        <div class="small">
                                            <div class="text-muted">Ë≥ºÂÖ•: ü™ô${(item.purchased_price || 0).toLocaleString()}</div>
                                            <div class="text-danger fw-bold">Â£≤Âç¥: ü™ô${Math.floor(item.sell_price).toLocaleString()}</div>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm ${btnClass} rounded-pill ms-2 text-nowrap" 
                                        onclick="confirmActionFromInventory('${item.uuid}')">
                                        ${btnLabel}
                                    </button>
                                </div>
                            `;
                        }).join('');

                        detailHtml = `<div class="mt-3 border-top pt-2"><div class="vstack gap-2">${listItemsHtml}</div></div>`;
                    }
                }

                return `
                <div class="p-2 rounded shadow-sm bg-white border mb-2">
                    <div class="d-flex align-items-center">
                        <div style="width: 50px; height: 50px; flex-shrink: 0;" class="me-3">
                             <img src="${group.badge_image_url}" class="w-100 h-100 object-fit-contain rounded">
                        </div>
                        <div class="flex-grow-1" style="min-width: 0; margin-right: 10px;">
                            <div class="fw-bold text-truncate">${group.badge_name}</div>
                            <div class="small text-muted d-flex align-items-center flex-wrap gap-2">
                                <span class="badge ${rarityClass || 'bg-light text-dark border'}">${repItem.rarity_name || '-'}</span>
                                <div>ÊâÄÊåÅ: <span class="fw-bold text-dark">${totalCount}</span>ÂÄã</div>
                                ${mutantCount > 0 ? `<span class="badge bg-warning text-dark">ÂÜÖ„Éü„É•„Éº„Çø„É≥„Éà: ${mutantCount}</span>` : ''}
                            </div>
                        </div>
                        <div style="flex-shrink: 0;">${actionArea}</div>
                    </div>
                    ${detailHtml}
                </div>`;
            }).join('');

            renderInventoryPagination(totalPages);
        }

        function toggleInventoryExpand(badgeId) {
            if (expandedBadgeId === badgeId) expandedBadgeId = null;
            else expandedBadgeId = badgeId;
            renderUniversalInventory();
        }

        function goToInventoryPage(page) {
            currentInventoryPage = page;
            renderUniversalInventory();
        }

        function renderInventoryPagination(totalPages) {
            const ul = document.getElementById('inventory-pagination');
            if (totalPages <= 1) {
                document.getElementById('inventory-pagination-area').style.display = 'none';
                return;
            }
            let html = '';
            // Á∞°Êòì„Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ÂÆüË£Ö
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentInventoryPage - 1 && i <= currentInventoryPage + 1)) {
                    html += `<li class="page-item ${i === currentInventoryPage ? 'active' : ''}">
                        <a class="page-link" href="javascript:void(0)" onclick="goToInventoryPage(${i})">${i}</a></li>`;
                } else if (i === currentInventoryPage - 2 || i === currentInventoryPage + 2) {
                    html += `<li class="page-item disabled"><a class="page-link">...</a></li>`;
                }
            }
            ul.innerHTML = html;
        }

        function confirmActionFromInventory(uuid) {
            if (currentInventoryMode === 'sell') {
                confirmSellFromList(uuid);
            } else {
                initiateTransferFromList(uuid);
            }
        }

        // Â£≤Âç¥Á¢∫Ë™ç
        function confirmSellFromList(uuid) {
            const item = allInventoryBadges.find(i => i.uuid === uuid);
            if (!item) return;

            currentShopActionUUID = uuid;
            const container = document.getElementById('shopActionContent');
            const btnExec = document.getElementById('btnShopActionExec');

            container.innerHTML = `
                <h5 class="fw-bold mb-3 text-danger">Â£≤Âç¥„ÅÆÁ¢∫Ë™ç</h5>
                <p class="mb-2">„Äå<span class="fw-bold">${item.badge_name}</span>„Äç„ÇíÂ£≤Âç¥„Åó„Åæ„Åô„ÅãÔºü</p>
                <div class="alert alert-secondary d-inline-block text-start py-2 px-4">
                    <div>Ë≥ºÂÖ•È°ç: ü™ô ${item.purchased_price?.toLocaleString() || 0}</div>
                    <div class="fw-bold text-danger fs-5">Â£≤Âç¥È°ç: ü™ô ${item.sell_price.toLocaleString()}</div>
                </div>
                <p class="text-muted small mt-2">„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ</p>
            `;

            btnExec.textContent = 'Â£≤Âç¥„Åô„Çã';
            btnExec.className = 'btn btn-danger rounded-pill px-4';
            btnExec.onclick = executeSellBadges;

            new bootstrap.Modal(document.getElementById('shopActionModal')).show();
        }

        async function executeSellBadges() {
            bootstrap.Modal.getInstance(document.getElementById('shopActionModal'))?.hide();
            // („É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫„Å™„Å©„ÅØÁúÅÁï•„ÄÅ„Ç¢„É©„Éº„Éà„ÅÆ„Åø)
            try {
                const user = await getCurrentUser();
                const { data, error } = await supabaseClient.rpc('sell_badge_v2', {
                    p_user_id: user.user_metadata.provider_id,
                    p_badge_uuid: currentShopActionUUID
                });
                if (error || !data.ok) throw error || new Error(data?.error);

                alert(`Â£≤Âç¥„Åó„Åæ„Åó„ÅüÔºÅ (ü™ô +${data.sell_price.toLocaleString()})`);

                // „É™„É≠„Éº„Éâ
                if (!isViewMode) {
                    const u = await getCurrentUser();
                    if (u) await displayMyInfo(u);
                }
                loadInventory(); // „É™„Çπ„ÉàÊõ¥Êñ∞
            } catch (e) {
                alert('Â£≤Âç¥„Ç®„É©„Éº: ' + e.message);
            }
        }

        // Ë≠≤Ê∏°ÈñãÂßã
        function initiateTransferFromList(uuid) {
            const item = allInventoryBadges.find(i => i.uuid === uuid);
            if (!item) return;

            // Ë≠≤Ê∏°ÂØæË±°„ÇíË®≠ÂÆö„Åó„Å¶„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„Å∏
            currentActionUUID = uuid;
            currentActionBadgeName = item.badge_name;
            currentActionDetails = `(Ë≥ºÂÖ•È°ç: ${item.purchased_price} C)`;

            // „É¢„Éº„ÉÄ„É´„Çí‰∏ÄÊôÇÁöÑ„Å´Èö†„ÅôÔºàbootstrap„ÅÆ‰ªïÊßò‰∏ä„ÄÅÂÖ•„ÇåÂ≠êÂõûÈÅø„ÅÆ„Åü„ÇÅÔºâ
            bootstrap.Modal.getInstance(document.getElementById('universalInventoryModal'))?.hide();

            // „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
            openUserSelectModal('badge_transfer');
        }
    </script>

    <script>
        // ==========================================
        // „É°„Ç§„É≥„Éö„Éº„Ç∏Áî®„Éê„ÉÉ„Ç∏Ë™≠„ÅøËæº„Åø„É≠„Ç∏„ÉÉ„ÇØ (Âæ©Êóß)
        // ==========================================
        // Global variables are already defined above (lines ~2090)


        async function loadOwnedBadges() {
            const list = document.getElementById('purchasable-badge-list');
            if (list) list.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div></div>';

            try {
                // targetId„ÅåÊú™Ë®≠ÂÆö„Å™„ÇâÁâπÂÆö„ÇíË©¶„Åø„Çã
                if (typeof targetId === 'undefined' || !targetId) {
                    const params = new URLSearchParams(window.location.search);
                    targetId = params.get('user');
                    if (!targetId) {
                        const user = await getCurrentUser();
                        if (user) targetId = user.user_metadata.provider_id;
                    }
                }
                if (!targetId) return;

                // „Éê„ÉÉ„Ç∏ÂèñÂæó
                const { data: owned, error } = await supabaseClient
                    .from('user_badges_new')
                    .select('*, badges(*)')
                    .eq('user_id', targetId)
                    .order('acquired_at', { ascending: false });

                if (error) throw error;

                // ÂêÑÁ®Æ„Éû„Çπ„Çø„Éá„Éº„ÇøÂèñÂæó
                const { data: thresholds } = await supabaseClient.from('rarity_thresholds').select('*').order('threshold_value', { ascending: true });
                const { data: marketCountRes } = await supabaseClient.from('user_badges_new').select('badge_id');
                let marketCounts = {};
                (marketCountRes || []).forEach(s => marketCounts[s.badge_id] = (marketCounts[s.badge_id] || 0) + 1);

                // „Ç∞„É´„Éº„Éî„É≥„Ç∞Áî®„Éû„ÉÉ„Éó
                const groups = new Map();

                owned.forEach(item => {
                    if (!item.badges) return;
                    const badge = item.badges;
                    const bId = badge.id;

                    if (!groups.has(bId)) {
                        groups.set(bId, {
                            badge: badge,
                            items: [],
                            count: 0,
                            hasMutant: false,
                            isEquippedLeft: false, // Á∞°Êòì
                            isEquippedRight: false // Á∞°Êòì
                        });
                    }
                    const g = groups.get(bId);
                    g.items.push(item);
                    g.count++;
                    if (item.is_mutant) g.hasMutant = true;
                });

                // ÂàÜÈ°û
                purchasableBadges = [];
                specialBadges = [];
                convertibleBadges = [];

                groups.forEach(group => {
                    const badge = group.badge;
                    const count = marketCounts[badge.id] || 1;
                    const valResult = BadgeUtils.calculateBadgeValues(badge, count, thresholds || []);

                    const badgeInfo = {
                        group: group,
                        badge: { ...badge, ...valResult },
                        count: group.count,
                        hasMutant: group.hasMutant,
                        rarity: valResult.rarityName,
                        pValue: valResult.marketValue,
                        mainItem: group.items[0], // ‰ª£Ë°®„Ç¢„Ç§„ÉÜ„É†
                        n: count
                    };

                    if (badge.sales_type === 'ÈôêÂÆöÂìÅ') {
                        specialBadges.push(badgeInfo);
                    } else if (badge.sales_type === 'ÊèõÈáëÂìÅ') {
                        convertibleBadges.push(badgeInfo);
                    } else {
                        purchasableBadges.push(badgeInfo);
                    }
                });

                // ÊèèÁîªÈñ¢Êï∞„ÅÆÂëº„Å≥Âá∫„Åó (Êó¢Â≠ò„ÅÆÈñ¢Êï∞„ÅåÂ≠òÂú®„Åô„Çã„Å®‰ªÆÂÆö„ÄÅ„Å™„Åë„Çå„Å∞„Ç®„É©„Éº„Å´„Å™„Çã„Åå...)
                if (typeof renderSpecialBadges === 'function') renderSpecialBadges();
                if (typeof renderConvertibleBadges === 'function') renderConvertibleBadges();
                if (typeof filterAndRenderBadges === 'function') filterAndRenderBadges();

            } catch (err) {
                console.error('loadOwnedBadges Error:', err);
                if (list) list.innerHTML = '<div class="text-center text-danger py-5">Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº</div>';
            }
        }

        // ÂàùÊúüÂåñ„Éà„É™„Ç¨„Éº
        document.addEventListener('DOMContentLoaded', () => {
            // Êó¢Â≠ò„ÅÆinitPage„ÅåËµ∞„Å£„Å¶„ÅÑ„Çã„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ„Åå„ÄÅÂøµ„ÅÆ„Åü„ÇÅÂ∞ë„ÅóÈÅÖÂª∂„Åï„Åõ„Å¶„É≠„Éº„Éâ?
            // „Åæ„Å†„É≠„Éº„Éâ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøËµ∞„Çâ„Åõ„ÇãÂà∂Âæ°„ÇíÂÖ•„Çå„Çã„ÅÆ„ÅåÁêÜÊÉ≥„Å†„Åå„ÄÅ
            // ÂçòÁ¥î„Å´Âëº„Å≥Âá∫„Åó„Å¶„ÇÇÂÜçÊèèÁîª„Åï„Çå„Çã„Å†„Åë„Å™„ÅÆ„ÅßË®±ÂÆπ„Åô„Çã„ÄÇ
            setTimeout(loadOwnedBadges, 500);
        });
    </script>
</body>

</html>