<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ã‹ã«ã‚µãƒ¼ãƒãƒ¼ - ãƒã‚¤ãƒšãƒ¼ã‚¸">
    <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ | ã‹ã«ã‚µãƒ¼ãƒãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;600;700&family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap"
        rel="stylesheet">

    <!-- Bootswatch Lux (Bootstrap 5.3.3) -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-purple: #6b5b95;
            --deep-purple: #4a3f6b;
            --cream: #faf5e8;
            --gold: #d4a853;
            --btn-gold: #c29544;
            --font-title: 'Noto Serif JP', serif;
            --font-body: 'M PLUS Rounded 1c', sans-serif;
        }

        .btn-gold {
            background-color: var(--gold);
            border: none;
        }

        .btn-gold:hover {
            background-color: var(--btn-gold);
            color: white;
        }


        body {
            font-family: var(--font-body);
            background: linear-gradient(180deg, #6b5b95 0%, #5a4d80 50%, #4a3f6b 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }

        .page-header {
            font-family: var(--font-title);
            color: var(--cream);
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
        }

        .back-button {
            font-family: var(--font-body);
            font-size: 1rem;
            padding: 10px 25px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #fff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .profile-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--gold);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .discord-badge {
            background: linear-gradient(135deg, #43b581, #3ca374);
            color: white;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(67, 181, 129, 0.4);
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid var(--gold);
        }

        .activity-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .activity-item-card {
            background: #fdfdfd;
            /* ã‚«ãƒ¼ãƒ‰ã®ä¸­ã«ã‚«ãƒ¼ãƒ‰ã§ã‚ã‚‹ã“ã¨ã‚’å¼·èª¿ã™ã‚‹ãŸã‚ã®å¾®èª¿æ•´ */
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            border: 1px solid #eff0f1;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            display: block;
        }

        .activity-item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            border-color: var(--gold);
        }

        .activity-date {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 10px;
            display: block;
            border-bottom: 1px solid #f5f5f5;
            padding-bottom: 5px;
        }

        .activity-type-badge {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 50px;
            background: #f0f2f5;
            color: #4b515d;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .activity-details {
            font-size: 0.95rem;
            color: #2c3e50;
            font-weight: 500;
        }

        .activity-amount {
            font-family: 'Inter', 'Kosugi Maru', sans-serif;
            font-weight: 800;
            font-size: 1.15rem;
            letter-spacing: -0.02em;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--deep-purple);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .login-prompt {
            text-align: center;
            padding: 60px 20px;
        }

        .login-prompt-btn {
            background: linear-gradient(135deg, #5865F2, #4752c4);
            color: white;
            padding: 15px 40px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .login-prompt-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(88, 101, 242, 0.4);
        }

        .logout-btn {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 2px solid #dc3545;
            padding: 10px 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc3545;
            color: white;
        }

        /* ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ›æ¬„ */
        .nickname-input {
            background: #fff;
            border: 2px solid #e0d8f0;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 1rem;
            transition: all 0.3s ease;
            color: #333;
        }

        .nickname-input::placeholder {
            color: #aaa;
            font-style: italic;
        }

        .nickname-input:focus {
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 4px rgba(107, 91, 149, 0.15);
            outline: none;
            background: #fff;
        }

        /* ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°ãƒœã‚¿ãƒ³ */
        .btn-avatar-update {
            background: linear-gradient(135deg, #5865F2 0%, #4752c4 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(88, 101, 242, 0.3);
        }

        .btn-avatar-update:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(88, 101, 242, 0.5);
            background: linear-gradient(135deg, #6872f4 0%, #5865F2 100%);
        }

        /* çµ±è¨ˆãƒŸãƒ‹ã‚«ãƒ¼ãƒ‰ */
        .stat-card-mini {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }

        .stat-card-mini:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-label-mini {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-value-mini {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--deep-purple);
        }

        .stat-rank {
            font-size: 0.7rem;
            color: #fff;
            background: linear-gradient(135deg, var(--gold), #b8860b);
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 5px;
            display: inline-block;
        }

        .stat-rank.no-data {
            background: #adb5bd;
        }

        /* ãƒãƒƒã‚¸ä¸€è¦§ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .badge-item {
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
            border-radius: 12px;
            padding: 8px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .badge-item:hover {
            transform: scale(1.05);
            background: #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .badge-item.equipped {
            border-color: rgba(212, 165, 116, 0.4);
            background: #fff9e6;
        }

        .badge-item.selected {
            border-color: var(--gold) !important;
            background: #fff !important;
            box-shadow: 0 0 0 3px rgba(211, 168, 83, 0.5) !important;
            transform: scale(1.05);
        }

        .badge-item img {
            width: 70px;
            height: 70px;
            object-fit: contain;
            display: block;
        }

        .badge-count-overlay {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            border: 2px solid white;
            z-index: 10;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s;
        }

        .loading-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒªã‚¹ãƒˆ */
        .user-select-item {
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
        }

        .user-select-item:hover {
            background-color: #f8f9fa;
        }


        .user-select-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 2px solid var(--gold);
        }

        .user-select-badge {
            width: 24px;
            height: 24px;
            object-fit: contain;
            margin-left: 8px;
        }

        .user-select-name {
            font-weight: 700;
            color: var(--deep-purple);
            font-size: 1rem;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
        .nav-dropdown {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .record-button {
            background: linear-gradient(135deg, var(--gold) 0%, #b8892d 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 6px 20px rgba(212, 168, 83, 0.5);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            cursor: pointer;
        }

        .record-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 168, 83, 0.6);
            color: white;
        }

        .nav-dropdown-menu {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            min-width: 200px;
            overflow: hidden;
        }

        .nav-dropdown-menu .dropdown-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            transition: background 0.2s;
        }

        .nav-dropdown-menu .dropdown-item:hover {
            background: #f5f5f5;
        }

        .nav-dropdown-menu .dropdown-divider {
            margin: 0;
        }

        .notification-badge {
            background: #dc3545;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
        }

        /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£åˆ¥èƒŒæ™¯è‰² */
        .rarity-wood {
            background: #d7ccc8 !important;
            color: #5d4037 !important;
            border-color: #8d6e63 !important;
        }

        .rarity-stone {
            background: #cfd8dc !important;
            color: #455a64 !important;
            border-color: #90a4ae !important;
        }

        .rarity-bronze {
            background: #ffe0b2 !important;
            color: #e65100 !important;
            border-color: #ffb74d !important;
        }

        .rarity-silver {
            background: #f5f5f5 !important;
            color: #616161 !important;
            border-color: #bdbdbd !important;
        }

        .rarity-gold {
            background: linear-gradient(135deg, #fff9c4 0%, #fbc02d 100%) !important;
            color: #f57f17 !important;
            border-color: #fdd835 !important;
        }

        .rarity-platinum {
            background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%) !important;
            color: #0277bd !important;
            border-color: #4fc3f7 !important;
        }

        .rarity-gem {
            background: linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%) !important;
            color: #7b1fa2 !important;
            border-color: #ba68c8 !important;
            box-shadow: 0 0 15px rgba(186, 104, 200, 0.4);
        }

        .rarity-legend {
            background: linear-gradient(135deg, #fff9c4 0%, #fbc02d 50%, #f9a825 100%) !important;
            color: #f57f17 !important;
            border-color: #ffd700 !important;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .rarity-fantasy {
            background: linear-gradient(135deg, #e1f5fe 0%, #81d4fa 50%, #4fc3f7 100%) !important;
            color: #01579b !important;
            border-color: #00bcd4 !important;
            box-shadow: 0 0 25px rgba(0, 188, 212, 0.5);
        }

        .rarity-supreme {
            background: linear-gradient(135deg, #fce4ec 0%, #f06292 50%, #e91e63 100%) !important;
            color: #880e4f !important;
            border-color: #ff4081 !important;
            box-shadow: 0 0 30px rgba(255, 64, 129, 0.6);
        }

        .rarity-mythic {
            background: linear-gradient(135deg, #fffde7 0%, #fff176 50%, #ffd600 100%) !important;
            color: #f57f17 !important;
            border-color: #ffea00 !important;
            box-shadow: 0 0 40px rgba(255, 234, 0, 0.7);
        }

        .rarity-void {
            background: #000 !important;
            color: #fff !important;
            border-color: #333 !important;
        }

        /* --- ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ³ãƒˆæ¼”å‡º (è©³ç´°ãƒšãƒ¼ã‚¸ã‹ã‚‰ç§»æ¤) --- */
        .badge-image-container {
            position: relative;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .badge-image-container.mutant-active::before,
        .badge-image-container.mutant-active::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            width: 80px;
            height: 120px;
            transform: translateX(-50%);
            z-index: 0;
            pointer-events: none;
            border-radius: 50% 50% 0 0;
            filter: blur(15px);
        }

        .badge-image-container.mutant-active::before {
            background-image:
                radial-gradient(circle at 30% 80%, rgba(180, 0, 180, 0.6) 0%, transparent 40%),
                radial-gradient(circle at 70% 60%, rgba(120, 0, 255, 0.5) 0%, transparent 45%),
                radial-gradient(circle at 40% 40%, rgba(200, 0, 255, 0.4) 0%, transparent 50%);
            animation: bubblesRiseSmall 4s linear infinite;
        }

        .badge-image-container.mutant-active::after {
            background-image:
                radial-gradient(circle at 60% 90%, rgba(255, 0, 150, 0.5) 0%, transparent 40%),
                radial-gradient(circle at 20% 70%, rgba(180, 0, 255, 0.4) 0%, transparent 45%),
                radial-gradient(circle at 80% 30%, rgba(120, 0, 255, 0.3) 0%, transparent 50%);
            animation: bubblesRiseSmall 6s linear infinite reverse;
            opacity: 0.7;
        }

        .mutant-shine-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 2;
            overflow: hidden;
            border-radius: 50% !important;
            -webkit-mask-image: radial-gradient(circle, black 65%, transparent 70%);
            mask-image: radial-gradient(circle, black 65%, transparent 70%);
        }

        .mutant-shine-overlay::before {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            width: 300%;
            height: 300%;
            background: linear-gradient(135deg,
                    transparent 40%,
                    rgba(255, 255, 255, 0.1) 44%,
                    rgba(255, 255, 255, 0.9) 45%,
                    rgba(255, 255, 255, 0.2) 46%,
                    transparent 48%,
                    transparent 50%,
                    rgba(255, 255, 255, 0.1) 51%,
                    rgba(255, 255, 255, 0.6) 52%,
                    rgba(255, 255, 255, 0.1) 53%,
                    transparent 55%);
            filter: blur(3px);
            animation: mutantShineDiagonalSmall 2s infinite ease-in-out;
        }

        @keyframes bubblesRiseSmall {
            0% {
                background-position: 0% 100%;
                transform: translateX(-50%) translateY(10px) scale(0.8);
                opacity: 0;
            }

            10% {
                opacity: 0.8;
            }

            90% {
                opacity: 0.8;
            }

            100% {
                background-position: 0% -100%;
                transform: translateX(-50%) translateY(-30px) scale(1.1);
                opacity: 0;
            }
        }

        @keyframes mutantShineDiagonalSmall {
            0% {
                transform: translate(-40%, -40%);
            }

            100% {
                transform: translate(40%, 40%);
            }
        }

        /* ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ»ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */
        .pagination-premium .page-link {
            border: none;
            margin: 0 4px;
            border-radius: 8px !important;
            color: var(--deep-purple);
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .pagination-premium .page-item.active .page-link {
            background: linear-gradient(135deg, var(--deep-purple), var(--soft-purple));
            color: white !important;
            box-shadow: 0 4px 10px rgba(106, 17, 203, 0.3);
        }

        .pagination-premium .page-link:hover {
            background: var(--gold);
            color: white !important;
            transform: translateY(-2px);
        }
    </style>
</head>

<body>
    <!-- å³ä¸Šã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
    <div class="nav-dropdown dropdown">
        <button class="record-button dropdown-toggle" type="button" id="navDropdown" data-bs-toggle="dropdown"
            aria-expanded="false">
            ğŸ“ ãƒ¡ãƒ‹ãƒ¥ãƒ¼
        </button>
        <ul class="dropdown-menu nav-dropdown-menu dropdown-menu-end" aria-labelledby="navDropdown">
            <li><a class="dropdown-item" href="../index.html">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a></li>
            <li><a class="dropdown-item" href="./index.html">ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</a></li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="../mahjong/index.html">ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a></li>
            <li><a class="dropdown-item" href="../mahjong/record.html">ğŸ“ è¨˜éŒ²ã™ã‚‹</a></li>
            <li><a class="dropdown-item" href="../mahjong/users/index.html">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a></li>
            <li><a class="dropdown-item" href="../mahjong/team/index.html">ğŸ… ãƒãƒ¼ãƒ ç®¡ç† <span id="team-notification-badge"
                        class="notification-badge" style="display:none;">0</span></a></li>
            <li><a class="dropdown-item" href="../badge/list.html">ğŸ“› ãƒãƒƒã‚¸ä¸€è¦§</a></li>
            <li><a class="dropdown-item" href="../badge/shop.html">ğŸ›’ ãƒãƒƒã‚¸ã‚·ãƒ§ãƒƒãƒ—</a></li>
            <li><a class="dropdown-item" href="../ranking/index.html">ğŸ’° è³‡ç”£ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a></li>
            <li class="admin-only" style="display:none;"><a class="dropdown-item" href="../omikuji/index.html">ğŸ‹
                    ãŠã¿ãã˜</a></li>
            <li class="admin-only" style="display:none;">
                <hr class="dropdown-divider">
            </li>
            <li class="admin-only" style="display:none;">
                <a class="dropdown-item" href="../admin/index.html">âš™ï¸ ç®¡ç†ç”»é¢</a>
            </li>
        </ul>
    </div>

    <div class="container py-5">
        <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
        <div class="mb-4">
            <a href="#" onclick="goBack(); return false;" class="back-button">
                â† æˆ»ã‚‹
            </a>
        </div>


        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="text-center mb-5">
            <h1 class="page-header display-4 fw-bold mb-3">ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
        </header>

        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">

                <!-- æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ -->
                <div id="login-prompt" class="profile-card login-prompt" style="display: none;">
                    <h3 class="mb-4" style="font-family: var(--font-title); color: var(--deep-purple);">
                        ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„
                    </h3>
                    <p class="text-muted mb-4">
                        ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯Discordã§ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚
                    </p>
                    <button onclick="loginWithDiscord()" class="login-prompt-btn">
                        <img src="https://assets-global.website-files.com/6257adef93867e50d84d30e2/636e0a69f118df70ad7828d4_icon_clyde_blurple_RGB.svg"
                            alt="Discord" style="width: 24px;">
                        Discordã§ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                </div>

                <!-- ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ï¼ˆã¾ãŸã¯é–²è¦§ãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
                <div id="profile-content" style="display: none;">
                    <div class="profile-card mb-4">
                        <!-- ä¸Šæ®µ: ãƒãƒƒã‚¸ + åå‰ + ãƒãƒƒã‚¸ + ç·¨é›†ãƒœã‚¿ãƒ³ -->
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center gap-2 flex-grow-1" style="min-width: 0;">
                                <img id="user-equipped-badge" src="" alt=""
                                    style="width: 36px; height: 36px; border-radius: 8px; display: none;" title="">
                                <h2 id="user-name" class="mb-0 text-truncate"
                                    style="font-family: var(--font-title); color: var(--deep-purple); font-size: 1.4rem;">
                                    ãƒ¦ãƒ¼ã‚¶ãƒ¼å
                                </h2>
                                <img id="user-equipped-badge-right" src="" alt=""
                                    style="width: 36px; height: 36px; border-radius: 8px; display: none;" title="">
                            </div>
                            <button id="nickname-edit-btn" onclick="openNicknameModal()"
                                class="btn btn-sm btn-outline-secondary flex-shrink-0" title="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å¤‰æ›´"
                                style="display: none; padding: 4px 10px;">
                                âœï¸
                            </button>
                        </div>

                        <!-- ä¸‹æ®µ: ã‚¢ãƒã‚¿ãƒ¼ + æƒ…å ± -->
                        <div class="row align-items-start">
                            <div class="col-auto">
                                <div class="text-center">
                                    <img id="user-avatar" src="" alt="ã‚¢ãƒã‚¿ãƒ¼" class="avatar-large">
                                    <button id="sync-btn" onclick="updateAvatar()"
                                        class="btn btn-sm btn-outline-secondary mt-2" title="Discordã‹ã‚‰æœ€æ–°ã®ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’å–å¾—"
                                        style="font-size: 0.7rem; padding: 3px 8px;">
                                        ğŸ”„ åŒæœŸ
                                    </button>
                                </div>
                            </div>
                            <div class="col">
                                <h2 id="page-title-label" class="small text-muted mb-1" style="display:none;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h2>

                                <!-- ãƒãƒ¼ãƒ å -->
                                <div id="user-team-display" class="mb-2">
                                    <span class="badge bg-secondary" style="font-size: 0.85rem;">
                                        ğŸ  <span id="user-team-name">æœªæ‰€å±</span>
                                    </span>
                                </div>

                                <!-- æ‰€æŒé‡‘ -->
                                <div id="user-coins-display" class="mb-2"
                                    style="display: none; flex-wrap: wrap; gap: 8px; align-items: center;">
                                    <span class="badge bg-light text-dark shadow-sm"
                                        style="font-size: 0.85rem; border: 1px solid var(--gold); padding: 6px 12px;">
                                        æ‰€æŒé‡‘: ğŸª™ <span id="user-coins-value">0</span>
                                    </span>
                                    <span class="badge bg-light text-dark shadow-sm"
                                        style="font-size: 0.85rem; border: 1px solid #17a2b8; padding: 6px 12px;">
                                        ç·è³‡ç”£: ğŸ“Š <span id="total-assets-value">0</span>
                                    </span>
                                    <span class="badge bg-light text-dark shadow-sm"
                                        style="font-size: 0.85rem; border: 1px solid #ffc107; padding: 6px 12px;">
                                        ç¥ˆé¡˜ç¬¦: ğŸ§§ <span id="user-tickets-value">0</span>
                                    </span>
                                    <div class="d-flex gap-2">
                                        <button id="coin-transfer-btn" onclick="openCoinTransferModal()"
                                            class="btn btn-sm btn-outline-primary"
                                            style="display: none; padding: 2px 8px; font-size: 0.75rem;">
                                            ğŸ’¸ é€é‡‘
                                        </button>
                                        <button id="possessions-btn" onclick="openPossessionsModal()"
                                            class="btn btn-sm btn-outline-warning"
                                            style="display: none; padding: 2px 8px; font-size: 0.75rem;">
                                            ğŸ æ‰€æŒå“
                                        </button>
                                    </div>
                                </div>

                                <!-- ä»–äººã®å ´åˆã®ã¿è¡¨ç¤ºã™ã‚‹è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                                <div id="view-area" class="mt-2" style="display:none;">
                                    <div class="discord-badge">
                                        ğŸ€„ éº»é›€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- éº»é›€çµ±è¨ˆ -->
                    <div class="profile-card mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0;">
                                ğŸ€„ éº»é›€çµ±è¨ˆ
                            </h4>
                            <div id="tournament-filter-container">
                                <select id="tournament-select" class="form-select form-select-sm"
                                    style="width: auto; min-width: 150px;" onchange="handleTournamentChange()">
                                    <!-- JSã§ç”Ÿæˆ -->
                                </select>
                            </div>
                        </div>

                        <div id="stats-loading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                            </div>
                        </div>

                        <div id="stats-content" style="display: none;">
                            <div id="stats-grid">
                                <!-- ã‚¹ã‚³ã‚¢ç³» -->
                                <div class="row g-3 mb-3">
                                    <div class="col-6 col-md-4">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">ç·åˆã‚¹ã‚³ã‚¢</div>
                                            <div class="stat-value-mini" id="stat-total">-</div>
                                            <div class="stat-rank" id="rank-total">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">ä¸‰éº»ã‚¹ã‚³ã‚¢</div>
                                            <div class="stat-value-mini" id="stat-sanma">-</div>
                                            <div class="stat-rank" id="rank-sanma">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">å››éº»ã‚¹ã‚³ã‚¢</div>
                                            <div class="stat-value-mini" id="stat-yonma">-</div>
                                            <div class="stat-rank" id="rank-yonma">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- å¹³å‡ãƒ»æœ€å¤§ã‚¹ã‚³ã‚¢ -->
                                <div class="row g-3 mb-3">
                                    <div class="col-6">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">å¹³å‡ã‚¹ã‚³ã‚¢</div>
                                            <div class="stat-value-mini" id="stat-avg-score">-</div>
                                            <div class="stat-rank" id="rank-avg-score">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">æœ€å¤§ã‚¹ã‚³ã‚¢</div>
                                            <div class="stat-value-mini" id="stat-max-score">-</div>
                                            <div class="stat-rank" id="rank-max-score">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ç‡ç³» -->
                                <div class="row g-3 mb-3">
                                    <div class="col-6 col-md-3">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">å’Œäº†ç‡</div>
                                            <div class="stat-value-mini" id="stat-win-rate">-</div>
                                            <div class="stat-rank" id="rank-win-rate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">æ”¾éŠƒç‡</div>
                                            <div class="stat-value-mini" id="stat-deal-rate">-</div>
                                            <div class="stat-rank" id="rank-deal-rate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">ãƒˆãƒƒãƒ—ç‡</div>
                                            <div class="stat-value-mini" id="stat-top-rate">-</div>
                                            <div class="stat-rank" id="rank-top-rate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">ãƒ©ã‚¹å›é¿</div>
                                            <div class="stat-value-mini" id="stat-avoid-rate">-</div>
                                            <div class="stat-rank" id="rank-avoid-rate">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- é †ä½ç³» -->
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">å¹³å‡é †ä½</div>
                                            <div class="stat-value-mini" id="stat-avg-rank">-</div>
                                            <div class="stat-rank" id="rank-avg-rank">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">å¯¾å±€æ•°</div>
                                            <div class="stat-value-mini" id="stat-games">-</div>
                                            <div class="stat-rank" id="rank-games">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="no-stats-msg" class="text-center text-muted py-3" style="display: none;">
                                ã¾ã éº»é›€å¤§ä¼šã«å‚åŠ ã—ã¦ã„ã¾ã›ã‚“
                            </div>
                        </div>
                    </div>

                    <!-- ãƒãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="profile-card mb-4" id="badge-collection-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0;">
                                ğŸ“› ãƒãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
                            </h4>
                            <div class="d-flex gap-2">
                                <button id="badge-transfer-btn" onclick="openBadgeSelectionModal('transfer')"
                                    class="btn btn-sm btn-outline-primary" style="display: none;">
                                    è­²æ¸¡
                                </button>
                                <button id="badge-sell-btn" onclick="openBadgeSelectionModal('sell')"
                                    class="btn btn-sm btn-outline-danger" style="display: none;">
                                    å£²å´
                                </button>
                                <button id="badge-change-btn" onclick="openBadgeChangeModal()"
                                    class="btn btn-sm btn-outline-secondary" style="display: none;">
                                    è£…ç€
                                </button>
                            </div>
                        </div>

                        <!-- éå£²å“ãƒãƒƒã‚¸ -->
                        <div id="special-badges-section" style="display: none;">
                            <h6 class="text-muted mb-2" style="font-size: 0.85rem;">ğŸ† é™å®šãƒãƒƒã‚¸</h6>
                            <div id="special-badge-list" class="row g-3 mb-4">
                                <!-- JSã§ç”Ÿæˆ -->
                            </div>
                        </div>

                        <!-- æ›é‡‘å“ï¼ˆå¾¡ç¥çŸ³ãªã©ï¼‰ -->
                        <div id="convertible-badges-section" style="display: none;">
                            <h6 class="text-muted mb-2" style="font-size: 0.85rem;">ğŸ’ æ›é‡‘å“</h6>
                            <div id="convertible-badge-list" class="row g-3 mb-4">
                                <!-- JSã§ç”Ÿæˆ -->
                            </div>
                        </div>

                        <!-- è³¼å…¥ãƒãƒƒã‚¸ -->
                        <div id="purchasable-badges-section" style="display: none;">
                            <h6 class="text-muted mb-2" style="font-size: 0.85rem;">ğŸ›’ è³¼å…¥ãƒãƒƒã‚¸</h6>
                            <div id="purchasable-badge-list" class="row g-3">
                                <!-- JSã§ç”Ÿæˆ -->
                            </div>
                        </div>

                        <div id="no-badges-msg" class="text-center text-muted py-3" style="display: none;">
                            ã¾ã ãƒãƒƒã‚¸ã‚’æŒã£ã¦ã„ã¾ã›ã‚“
                        </div>
                    </div>

                    <!-- è²©å£²å®Ÿç¸¾ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="profile-card mb-4" id="revenue-section" style="display: none;">
                        <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0 0 15px 0;">
                            ğŸ’° è²©å£²å®Ÿç¸¾
                        </h4>
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="stat-card-mini">
                                    <div class="stat-label-mini">ç´¯è¨ˆåç›Š</div>
                                    <div class="stat-value-mini" id="total-revenue" style="color: #27ae60;">0</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card-mini">
                                    <div class="stat-label-mini">è²©å£²å›æ•°</div>
                                    <div class="stat-value-mini" id="revenue-count">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æœ€è¿‘ã®æ´»å‹•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (deployed 2026-01-12 13:27) -->
                    <div class="profile-card mb-4" id="activity-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                            <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0;">
                                ğŸ“‹ æœ€è¿‘ã®æ´»å‹•
                            </h4>
                            <select id="activity-action-filter" class="form-select form-select-sm"
                                style="width: auto; font-size: 0.8rem;" onchange="loadActivityLogs(1)">
                                <option value="all">ğŸ” ã™ã¹ã¦</option>
                                <option value="mahjong">ğŸ€„ éº»é›€</option>
                                <option value="transfer">ğŸ’¸ é€é‡‘</option>
                                <option value="badge">ğŸ ãƒãƒƒã‚¸</option>
                                <option value="gacha_draw">â›©ï¸ ãŠè³½éŠ­</option>
                                <option value="omikuji">ğŸ‹ ãŠã¿ãã˜</option>
                                <option value="royalty_receive">ğŸ’ å£²ä¸Šé‚„å…ƒ</option>
                            </select>
                        </div>
                        <div id="activity-list">
                            <div class="text-center text-muted py-3">èª­ã¿è¾¼ã¿ä¸­...</div>
                        </div>
                        <nav id="activity-pagination-area" class="mt-4" style="display: none;">
                            <ul id="activity-pagination"
                                class="pagination pagination-sm justify-content-center pagination-premium"></ul>
                        </nav>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ãƒãƒƒã‚¸å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="badgeChangeModal" tabindex="-1" aria-labelledby="badgeChangeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="badgeChangeModalLabel">è£…ç€ãƒãƒƒã‚¸ã‚’å¤‰æ›´</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <span class="badge bg-primary me-2" id="badge-position-indicator">â—€ å·¦ã«è£…ç€</span>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="badge-position" id="pos-left" value="left"
                                checked>
                            <label class="btn btn-outline-primary btn-sm" for="pos-left">â—€ å·¦</label>
                            <input type="radio" class="btn-check" name="badge-position" id="pos-right" value="right">
                            <label class="btn btn-outline-primary btn-sm" for="pos-right">å³ â–¶</label>
                        </div>
                    </div>
                    <div id="badge-modal-list" class="row g-2">
                        <!-- JSã§ç”Ÿæˆ -->
                    </div>
                </div>
                <div class="text-center mt-3 d-grid gap-2">
                    <button class="btn btn-primary" id="btn-execute-equip" onclick="executeSelectedEquip()"
                        disabled>é¸æŠã—ãŸãƒãƒƒã‚¸ã‚’è£…ç€</button>
                </div>
                <div class="text-center mt-3 d-flex justify-content-center gap-2">
                    <button class="btn btn-outline-danger btn-sm" onclick="equipBadge(null, 'left')">å·¦ã‚’å¤–ã™</button>
                    <button class="btn btn-outline-danger btn-sm" onclick="equipBadge(null, 'right')">å³ã‚’å¤–ã™</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="nicknameModal" tabindex="-1" aria-labelledby="nicknameModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nicknameModalLabel">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¤‰æ›´</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label small text-muted">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç­‰ã§è¡¨ç¤ºã•ã‚Œã‚‹åå‰</label>
                    <input type="text" id="user-nickname" class="form-control mb-3" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›...">
                    <div class="d-grid gap-2">
                        <button onclick="useDiscordName()" class="btn btn-outline-secondary btn-sm">
                            Discordåã‚’ä½¿ç”¨
                        </button>
                        <button onclick="saveNickname()" class="btn btn-gold text-white fw-bold">
                            ä¿å­˜
                        </button>
                    </div>
                    <div id="save-msg" class="small mt-2 text-center" style="display:none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- æ‰€æŒå“ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="possessionsModal" tabindex="-1" aria-labelledby="possessionsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="possessionsModalLabel">ğŸ ã‚ãªãŸã®æ‰€æŒå“</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6 class="fw-bold border-bottom pb-2">ãƒã‚±ãƒƒãƒˆ</h6>
                        <div
                            class="d-flex align-items-center justify-content-between p-3 bg-light rounded shadow-sm border">
                            <div class="d-flex align-items-center gap-2">
                                <span style="font-size: 1.5rem;">ğŸ§§</span>
                                <div>
                                    <div class="fw-bold" style="color: var(--deep-purple);">ç¥ˆé¡˜ç¬¦</div>
                                    <div class="small text-muted">ãŠè³½éŠ­ï¼ˆã‚¬ãƒãƒ£ï¼‰ã‚’1å›å¼•ã‘ã¾ã™</div>
                                </div>
                            </div>
                            <div class="fs-4 fw-bold text-primary"><span id="modal-tickets-count">0</span> æš</div>
                        </div>
                    </div>

                    <div>
                        <h6 class="fw-bold border-bottom pb-2">å¼•æ›åˆ¸</h6>
                        <div id="exchange-tickets-list" class="row g-3">
                            <!-- JSã§ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase -->
    <!-- ãƒãƒƒã‚¸è­²æ¸¡ãƒ»å£²å´ç”¨ãƒãƒƒã‚¸é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="badgeActionModal" tabindex="-1" aria-labelledby="badgeActionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="badgeActionModalLabel">ãƒãƒƒã‚¸ã‚’é¸æŠ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="action-badge-list" class="row g-2">
                        <!-- JSã§ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« (è­²æ¸¡ãƒ»é€é‡‘ç”¨) -->
    <div class="modal fade" id="userSelectModal" tabindex="-1" aria-labelledby="userSelectModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userSelectModalLabel">è­²æ¸¡å…ˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="transfer-user-list" class="list-group list-group-flush">
                        <!-- JSã§ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚³ã‚¤ãƒ³é€é‡‘é‡‘é¡å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="coinAmountModal" tabindex="-1" aria-labelledby="coinAmountModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="coinAmountModalLabel">é€é‡‘é‡‘é¡ã‚’å…¥åŠ›</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="coin-transfer-target-name" class="fw-bold text-center mb-3"></p>
                    <div class="mb-3">
                        <label class="form-label">é€é‡‘ã™ã‚‹ã‚³ã‚¤ãƒ³æ•°</label>
                        <input type="number" id="coin-transfer-amount" class="form-control" placeholder="é‡‘é¡..." min="1">
                        <div class="form-text mt-2 text-center">ã‚ãªãŸã®æ‰€æŒé‡‘: ğŸª™ <span id="my-coins-ref">0</span></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-primary" onclick="executeCoinTransfer()">é€é‡‘ã™ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabaseè¨­å®š -->
    <script src="../js/supabase-config.js?v=20260112"></script>
    <script src="../js/auth-guard.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            initAccordionNav('../');
        });
    </script>

    <script>
        let isViewMode = false;
        let targetId = null;
        let allProfiles = []; // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ
        let rarityThresholds = []; // ãƒ¬ã‚¢ãƒªãƒ†ã‚£å¢ƒç•Œãƒ‡ãƒ¼ã‚¿

        /**
         * ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
         */
        async function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('user');

            // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆåå‰è§£æ±ºç”¨ï¼‰
            const [profilesRes, thresholdsRes] = await Promise.all([
                supabaseClient.from('profiles').select('discord_user_id, account_name, avatar_url, coins'),
                supabaseClient.from('rarity_thresholds').select('*').order('threshold_value', { ascending: true })
            ]);
            if (profilesRes.data) allProfiles = profilesRes.data;
            if (thresholdsRes.data) rarityThresholds = thresholdsRes.data;

            const user = await getCurrentUser();
            const myId = user?.user_metadata?.provider_id;

            // ãªã‚Šã™ã¾ã—ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
            const impersonated = getImpersonatedUser();
            const effectiveId = impersonated ? impersonated.discord_user_id : myId;

            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
            if (urlUserId) {
                targetId = urlUserId;
                // è‡ªåˆ†ã§ã‚‚ãªã‚Šã™ã¾ã—å¯¾è±¡ã§ã‚‚ãªã„å ´åˆã¯é–²è¦§ãƒ¢ãƒ¼ãƒ‰
                if (urlUserId !== myId && urlUserId !== (impersonated?.discord_user_id)) {
                    isViewMode = true;
                } else {
                    isViewMode = false;
                }
            } else {
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆãªã‚Šã™ã¾ã—å„ªå…ˆï¼‰
                targetId = effectiveId;
                isViewMode = false;
            }

            // UIã®åŸºæœ¬è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            setupUI();

            // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
            if (isViewMode) {
                await loadTargetUserInfo();
            } else {
                if (user) {
                    await displayMyInfo(user);
                } else {
                    showLoginPrompt();
                    return;
                }
            }

            // éº»é›€çµ±è¨ˆã®èª­ã¿è¾¼ã¿ï¼ˆå…±æœ‰ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
            await loadMahjongStats();

            // ãƒãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿
            await loadOwnedBadges();

            // è²©å£²å®Ÿç¸¾ã®èª­ã¿è¾¼ã¿
            await loadRevenueStats();

            // æœ€è¿‘ã®æ´»å‹•ã®èª­ã¿è¾¼ã¿
            await loadActivityLogs();
        }

        function setupUI() {
            const loginPrompt = document.getElementById('login-prompt');
            const profileContent = document.getElementById('profile-content');
            const viewArea = document.getElementById('view-area');
            const syncBtn = document.getElementById('sync-btn');
            const pageTitleLabel = document.getElementById('page-title-label');
            const pageHeader = document.querySelector('.page-header');
            const nicknameEditBtn = document.getElementById('nickname-edit-btn');

            if (profileContent) profileContent.style.display = 'block';
            if (loginPrompt) loginPrompt.style.display = 'none';

            if (isViewMode) {
                // é–²è¦§ãƒ¢ãƒ¼ãƒ‰è¨­å®š
                if (viewArea) viewArea.style.display = 'block';
                if (syncBtn) syncBtn.style.display = 'none';
                if (pageTitleLabel) pageTitleLabel.style.display = 'block';
                if (pageHeader) pageHeader.textContent = 'ğŸ‘¤ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«';
                if (nicknameEditBtn) nicknameEditBtn.style.display = 'none';
            } else {
                // ãƒã‚¤ãƒšãƒ¼ã‚¸è¨­å®š
                if (viewArea) viewArea.style.display = 'none';
                if (syncBtn) syncBtn.style.display = 'inline-block';
                if (pageTitleLabel) pageTitleLabel.style.display = 'none';
                if (pageHeader) pageHeader.textContent = 'ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸';
                if (nicknameEditBtn) nicknameEditBtn.style.display = 'inline-block';
                const coinTransferBtn = document.getElementById('coin-transfer-btn');
                if (coinTransferBtn) coinTransferBtn.style.display = 'inline-block';
                const possessionsBtn = document.getElementById('possessions-btn');
                if (possessionsBtn) possessionsBtn.style.display = 'inline-block';
            }
        }

        function showLoginPrompt() {
            document.getElementById('login-prompt').style.display = 'block';
            document.getElementById('profile-content').style.display = 'none';
        }

        /**
         * è‡ªåˆ†ï¼ˆã¾ãŸã¯ãªã‚Šã™ã¾ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã®æƒ…å ±ã‚’è¡¨ç¤º
         */
        async function displayMyInfo(user) {
            const discordUser = user.user_metadata;
            const impersonated = getImpersonatedUser();

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ï¼ˆãƒãƒƒã‚¸æƒ…å ±ãƒ»ã‚³ã‚¤ãƒ³ãƒ»ãƒãƒ¼ãƒ æƒ…å ±ã‚’å«ã‚€ï¼‰
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('account_name, avatar_url, coins, total_assets, gacha_tickets, exchange_tickets, equipped_badge_id, equipped_badge_id_right, team_id, badges!equipped_badge_id(image_url, name), badges_right:badges!equipped_badge_id_right(image_url, name), teams!team_id(team_name)')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            // allProfiles ã«ã‚‚æœ€æ–°æƒ…å ±ã‚’åŒæœŸ
            if (profile) {
                const pIdx = allProfiles.findIndex(p => p.discord_user_id === targetId);
                if (pIdx !== -1) {
                    allProfiles[pIdx] = { ...allProfiles[pIdx], ...profile };
                }
            }

            // ã‚¢ãƒã‚¿ãƒ¼ï¼ˆãªã‚Šã™ã¾ã—ä¸­ã¯DBã‹ã‚‰ã€ãã†ã§ãªã‘ã‚Œã°Discordï¼‰
            const avatarUrl = impersonated
                ? (profile?.avatar_url || 'https://via.placeholder.com/150')
                : (discordUser.avatar_url || 'https://via.placeholder.com/150');
            document.getElementById('user-avatar').src = avatarUrl;

            // åå‰ï¼ˆãªã‚Šã™ã¾ã—ä¸­ã¯ãªã‚Šã™ã¾ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å„ªå…ˆï¼‰
            const name = impersonated
                ? (impersonated.name || profile?.account_name || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼')
                : (profile?.account_name || discordUser.full_name || discordUser.name || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼');
            const coins = profile?.coins || 0;

            // åå‰ã®ã¿è¡¨ç¤ºï¼ˆãƒãƒƒã‚¸ã¯åˆ¥è¦ç´ ï¼‰
            document.getElementById('user-name').textContent = name;

            // å·¦ãƒãƒƒã‚¸ç”»åƒã‚’è¨­å®š
            const badgeImg = document.getElementById('user-equipped-badge');
            const badge = profile?.badges;
            if (badgeImg && badge) {
                badgeImg.src = badge.image_url;
                badgeImg.title = badge.name;
                badgeImg.style.display = 'block';
            } else if (badgeImg) {
                badgeImg.style.display = 'none';
            }

            // å³ãƒãƒƒã‚¸ç”»åƒã‚’è¨­å®š
            const badgeImgRight = document.getElementById('user-equipped-badge-right');
            const badgeRight = profile?.badges_right;
            if (badgeImgRight && badgeRight) {
                badgeImgRight.src = badgeRight.image_url;
                badgeImgRight.title = badgeRight.name;
                badgeImgRight.style.display = 'block';
            } else if (badgeImgRight) {
                badgeImgRight.style.display = 'none';
            }

            // ãƒãƒ¼ãƒ åã‚’è¨­å®š
            const teamNameEl = document.getElementById('user-team-name');
            if (teamNameEl) {
                const team = profile?.teams;
                teamNameEl.textContent = team?.team_name || 'æœªæ‰€å±';
            }

            // ã‚³ã‚¤ãƒ³è¡¨ç¤ºã®æ›´æ–°
            const coinsDisplay = document.getElementById('user-coins-display');
            const coinsValue = document.getElementById('user-coins-value');
            const totalAssetsValue = document.getElementById('total-assets-value');
            const ticketsValue = document.getElementById('user-tickets-value');
            if (coinsDisplay && coinsValue) {
                coinsValue.textContent = coins.toLocaleString();
                // ç·è³‡ç”£ã¯ loadBadgeCollection ã§è¨ˆç®—å¾Œã«æ›´æ–°ã•ã‚Œã‚‹ï¼ˆã“ã“ã§ã¯è¨­å®šã—ãªã„ï¼‰
                if (totalAssetsValue) {
                    totalAssetsValue.textContent = '-';
                }
                if (ticketsValue) {
                    ticketsValue.textContent = (profile?.gacha_tickets || 0).toLocaleString();
                }
                coinsDisplay.style.display = 'block';
            }

            // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const nicknameEditBtn = document.getElementById('nickname-edit-btn');
            if (nicknameEditBtn) {
                nicknameEditBtn.style.display = 'inline-block';
            }

            if (profile?.account_name) {
                document.getElementById('user-nickname').value = profile.account_name;
            }
        }

        // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openNicknameModal() {
            const modalEl = document.getElementById('nicknameModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }

        /**
         * ä»–äººã®æƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤º
         */
        async function loadTargetUserInfo() {
            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('*, badges!equipped_badge_id(image_url, name), badges_right:badges!equipped_badge_id_right(image_url, name), teams!team_id(team_name)')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            // allProfiles ã«ã‚‚æœ€æ–°æƒ…å ±ã‚’åŒæœŸ
            if (profile) {
                const pIdx = allProfiles.findIndex(p => p.discord_user_id === targetId);
                if (pIdx !== -1) {
                    allProfiles[pIdx] = { ...allProfiles[pIdx], ...profile };
                }

                // è£…ç€ãƒãƒƒã‚¸ãŒæ‰€æŒã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆæ‰€æŒã—ã¦ã„ãªã‘ã‚Œã°è‡ªå‹•ã§å¤–ã™ï¼‰
                if (!isViewMode && (profile.equipped_badge_id || profile.equipped_badge_id_right)) {
                    const { data: ownedBadges } = await supabaseClient
                        .from('user_badges_new')
                        .select('badge_id')
                        .eq('user_id', targetId);

                    const ownedIds = (ownedBadges || []).map(b => b.badge_id);
                    let updateNeeded = {};

                    if (profile.equipped_badge_id && !ownedIds.includes(profile.equipped_badge_id)) {
                        updateNeeded.equipped_badge_id = null;
                    }
                    if (profile.equipped_badge_id_right && !ownedIds.includes(profile.equipped_badge_id_right)) {
                        updateNeeded.equipped_badge_id_right = null;
                    }

                    if (Object.keys(updateNeeded).length > 0) {
                        await supabaseClient
                            .from('profiles')
                            .update(updateNeeded)
                            .eq('discord_user_id', targetId);
                        // æ›´æ–°ã—ãŸã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å†å–å¾—
                        return loadTargetUserInfo();
                    }
                }
            }

            if (profile) {
                document.getElementById('user-avatar').src = profile.avatar_url || 'https://via.placeholder.com/150';

                // åå‰ã‚’è¨­å®š
                document.getElementById('user-name').textContent = profile.account_name || 'åç§°æœªè¨­å®š';

                // å·¦ãƒãƒƒã‚¸ç”»åƒã‚’è¨­å®š
                const badgeImg = document.getElementById('user-equipped-badge');
                const badge = profile?.badges;
                if (badgeImg && badge) {
                    badgeImg.src = badge.image_url;
                    badgeImg.title = badge.name;
                    badgeImg.style.display = 'block';
                } else if (badgeImg) {
                    badgeImg.style.display = 'none';
                }

                // å³ãƒãƒƒã‚¸ç”»åƒã‚’è¨­å®š
                const badgeImgRight = document.getElementById('user-equipped-badge-right');
                const badgeRight = profile?.badges_right;
                if (badgeImgRight && badgeRight) {
                    badgeImgRight.src = badgeRight.image_url;
                    badgeImgRight.title = badgeRight.name;
                    badgeImgRight.style.display = 'block';
                } else if (badgeImgRight) {
                    badgeImgRight.style.display = 'none';
                }

                // ãƒãƒ¼ãƒ åã‚’è¨­å®š
                const teamNameEl = document.getElementById('user-team-name');
                if (teamNameEl) {
                    const team = profile?.teams;
                    teamNameEl.textContent = team?.team_name || 'æœªæ‰€å±';
                }

                // ã‚³ã‚¤ãƒ³è¡¨ç¤ºã®æ›´æ–°
                const coins = profile?.coins || 0;
                const coinsDisplay = document.getElementById('user-coins-display');
                const coinsValue = document.getElementById('user-coins-value');
                const totalAssetsValue = document.getElementById('total-assets-value');
                const ticketsValue = document.getElementById('user-tickets-value');
                if (coinsDisplay && coinsValue) {
                    coinsValue.textContent = coins.toLocaleString();
                    // ç·è³‡ç”£ã¯ loadBadgeCollection ã§è¨ˆç®—å¾Œã«æ›´æ–°ã•ã‚Œã‚‹
                    // èª­ã¿è¾¼ã¿å‰ã¯ã€Œ-ã€ã‚’è¡¨ç¤º
                    if (totalAssetsValue) {
                        totalAssetsValue.textContent = '-';
                    }
                    if (ticketsValue) {
                        ticketsValue.textContent = (profile?.gacha_tickets || 0).toLocaleString();
                    }
                    coinsDisplay.style.display = 'block';
                }
            } else {
                document.getElementById('user-name').textContent = 'Unknown Player';
            }
        }

        async function useDiscordName() {
            const user = await getCurrentUser();
            if (!user) return;
            const discordUser = user.user_metadata;
            const discordDisplayName = discordUser.custom_claims?.global_name || discordUser.full_name || discordUser.name;
            document.getElementById('user-nickname').value = discordDisplayName;
        }

        async function updateAvatar() {
            const user = await getCurrentUser();
            if (!user || isViewMode) return;

            const btn = document.getElementById('sync-btn');
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'æ›´æ–°ä¸­...';

            try {
                const discordUser = user.user_metadata;
                const avatarUrl = discordUser.avatar_url || discordUser.picture || '';

                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        avatar_url: avatarUrl,
                        updated_at: new Date().toISOString()
                    })
                    .eq('discord_user_id', targetId);

                if (error) throw error;

                alert('ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
                document.getElementById('user-avatar').src = avatarUrl;
            } catch (err) {
                console.error('Error:', err);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function saveNickname() {
            if (isViewMode) return;

            const newNickname = document.getElementById('user-nickname').value.trim();
            const msg = document.getElementById('save-msg');

            if (!newNickname) {
                msg.textContent = 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                msg.className = 'small mt-1 text-danger flex-grow-1';
                msg.style.display = 'block';
                setTimeout(() => { msg.style.display = 'none'; }, 3000);
                return;
            }

            msg.style.display = 'block';
            msg.textContent = 'ä¿å­˜ä¸­...';
            msg.className = 'small mt-1 text-muted flex-grow-1';

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        account_name: newNickname,
                        updated_at: new Date().toISOString()
                    })
                    .eq('discord_user_id', targetId);

                if (error) throw error;

                msg.textContent = 'ä¿å­˜ã—ã¾ã—ãŸï¼';
                msg.className = 'small mt-2 text-center text-success';

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modalEl = document.getElementById('nicknameModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) {
                    setTimeout(() => {
                        modal.hide();
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãƒãƒƒã‚¸ä»˜ãã®åå‰ã‚’æ›´æ–°
                        loadTargetUserInfo();
                    }, 1000);
                }
            } catch (err) {
                console.error('Error updating nickname:', err);
                msg.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                msg.className = 'small mt-2 text-center text-danger';
            }
        }

        // ============ ãƒãƒƒã‚¸ç®¡ç†æ©Ÿèƒ½ ============


        async function loadOwnedBadges() {
            const section = document.getElementById('badge-collection-section');
            const specialSection = document.getElementById('special-badges-section');
            const specialList = document.getElementById('special-badge-list');
            const convertibleSection = document.getElementById('convertible-badges-section');
            const convertibleList = document.getElementById('convertible-badge-list');
            const purchasableSection = document.getElementById('purchasable-badges-section');
            const purchasableList = document.getElementById('purchasable-badge-list');
            const noBadgesMsg = document.getElementById('no-badges-msg');
            const netWorthEl = document.getElementById('total-assets-value'); // ç·è³‡ç”£ãƒ©ãƒ™ãƒ«ã‚’æµç”¨ã¾ãŸã¯è¿½åŠ æ¤œè¨ã€‚è¦ä»¶ã¯ã€Œç´”è³‡ç”£ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€

            if (!section) return;
            section.style.display = 'block';

            try {
                // æ‰€æŒãƒãƒƒã‚¸ï¼ˆæ–°ãƒ»å€‹ä½“ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ã¨å…¨ãƒãƒƒã‚¸ã®æµé€šæ•°ã‚’å–å¾—
                const [ownedRes, marketCountRes, profileRes, thresholdsRes] = await Promise.all([
                    supabaseClient.from('user_badges_new').select('*, badges(*)').eq('user_id', targetId),
                    supabaseClient.from('user_badges_new').select('badge_id'),
                    supabaseClient.from('profiles').select('coins, equipped_badge_id, total_assets').eq('discord_user_id', targetId).maybeSingle(),
                    supabaseClient.from('rarity_thresholds').select('*').order('threshold_value', { ascending: true })
                ]);

                if (ownedRes.error) throw ownedRes.error;
                const thresholds = thresholdsRes.data || [];

                function getDynamicRarity(assetValue, fixedRarity) {
                    if (fixedRarity) return fixedRarity;
                    if (!thresholds || thresholds.length === 0) return '-';
                    let current = thresholds[0].rarity_name;
                    for (const t of thresholds) {
                        if (assetValue >= t.threshold_value) {
                            current = t.rarity_name;
                        } else {
                            break;
                        }
                    }
                    return current;
                }
                const owned = ownedRes.data;
                const profileData = profileRes.data;
                const userCoins = profileData?.coins || 0;
                const equippedId = profileData?.equipped_badge_id;

                // å„ãƒãƒƒã‚¸ã®ç¾åœ¨æµé€šæ•° n ã‚’é›†è¨ˆ
                const marketCounts = {};
                (marketCountRes.data || []).forEach(s => {
                    marketCounts[s.badge_id] = (marketCounts[s.badge_id] || 0) + 1;
                });

                // è‡ªåˆ†ã®ãƒšãƒ¼ã‚¸ãªã‚‰ç®¡ç†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                const badgeBtn = document.getElementById('badge-change-btn');
                const transferBtn = document.getElementById('badge-transfer-btn');
                const sellBtn = document.getElementById('badge-sell-btn');
                if (!isViewMode) {
                    if (badgeBtn) badgeBtn.style.display = 'inline-block';
                    if (transferBtn) transferBtn.style.display = 'inline-block';
                    if (sellBtn) sellBtn.style.display = 'inline-block';
                }

                if (!owned || owned.length === 0) {
                    if (specialSection) specialSection.style.display = 'none';
                    if (convertibleSection) convertibleSection.style.display = 'none';
                    if (purchasableSection) purchasableSection.style.display = 'none';
                    if (noBadgesMsg) noBadgesMsg.style.display = 'block';
                    // ãƒãƒƒã‚¸ãŒãªã„å ´åˆã¯æ‰€æŒé‡‘ã®ã¿ã‚’ç·è³‡ç”£ã¨ã—ã¦è¡¨ç¤º
                    const totalAssetsEl = document.getElementById('total-assets-value');
                    if (totalAssetsEl) {
                        totalAssetsEl.textContent = userCoins.toLocaleString();
                    }
                    return;
                }

                // ãƒãƒƒã‚¸ã®ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°å‡¦ç† (badge_id ã”ã¨ã«ã¾ã¨ã‚ã‚‹)
                const groupedOwned = {};
                owned.forEach(item => {
                    const bid = item.badge_id;
                    if (!groupedOwned[bid]) {
                        groupedOwned[bid] = {
                            badge: item.badges,
                            instances: [],
                            isEquipped: false
                        };
                    }
                    groupedOwned[bid].instances.push(item);
                    if (item.badge_id === equippedId) {
                        groupedOwned[bid].isEquipped = true;
                    }
                });

                let totalBadgeAssetValue = 0;
                let purchasableHtml = '';
                let specialHtml = '';
                let convertibleHtml = '';

                // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸãƒãƒƒã‚¸ã‚’æç”»
                Object.values(groupedOwned).forEach(group => {
                    const badge = group.badge;
                    if (!badge) return;

                    const count = group.instances.length;
                    const mainItem = group.instances[0]; // ä»£è¡¨å“

                    const n = marketCounts[badge.id] || 0;
                    let pValue;
                    if (badge.sales_type === 'å¤‰å‹•å‹') {
                        pValue = Math.ceil(badge.price * Math.pow(1.3, Math.max(0, n - 1)));
                    } else {
                        // å›ºå®šå‹ã€nullã€ãã®ä»–ã¯åˆæœŸä¾¡æ ¼ã®ã¾ã¾
                        pValue = badge.price;
                    }
                    const pSell = Math.ceil(pValue * 0.7 * (mainItem.is_mutant ? 3 : 1));

                    // ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ³ãƒˆã¯ä¾¡å€¤3å€ã§è¨ˆç®—ã€å„å€‹ä½“ã”ã¨ã«åˆ¤å®š
                    group.instances.forEach(inst => {
                        const multiplier = inst.is_mutant ? 3 : 1;
                        totalBadgeAssetValue += (pValue * multiplier);
                    });

                    const rarity = getDynamicRarity(pValue, badge.fixed_rarity_name);
                    const rarityClass = getRarityClass(rarity);
                    const isEquipped = group.isEquipped;
                    const hasMutant = group.instances.some(i => i.is_mutant);

                    // éå£²å“åˆ¤å®š: sales_type ãŒ 'é™å®šå“' ã®å ´åˆã¯éå£²å“
                    const isNonSaleable = (badge.sales_type === 'é™å®šå“');
                    // æ›é‡‘å“åˆ¤å®š
                    const isConvertible = (badge.sales_type === 'æ›é‡‘å“');

                    // æ›é‡‘å“ã®å ´åˆã¯ç°¡ç•¥è¡¨ç¤º
                    if (isConvertible) {
                        const fixedSellPrice = badge.price; // æ›é‡‘å“ã¯å›ºå®šä¾¡æ ¼
                        // ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã‚’å–å¾—ï¼ˆä¸€èˆ¬ã€è‰¯è³ªã€å¸Œå°‘ãªã©ï¼‰
                        const rarity = badge.fixed_rarity_name || 'ä¸€èˆ¬';
                        const rarityClass = getRarityClass(rarity);
                        convertibleHtml += `
                            <div class="col-6 col-sm-4 col-md-3 mb-3">
                                <div class="card h-100 shadow-sm border-0 ${rarityClass}" style="border-radius: 12px; overflow: hidden; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                                    <a href="../badge/index.html?id=${badge.id}" class="text-decoration-none w-100 h-100" style="color: inherit;">
                                        <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center text-center">
                                            <div class="small text-muted mb-1" style="font-size: 0.65rem;">${rarity}</div>
                                            <div class="d-flex align-items-center justify-content-center mb-2" style="gap: 8px;">
                                                <div style="width: 70px; height: 70px;">
                                                    <img src="${badge.image_url}" alt="${badge.name}" style="width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));">
                                                </div>
                                                <span class="badge bg-dark" style="font-size:0.75rem; padding: 4px 8px;">Ã—${count}</span>
                                            </div>
                                            <div class="small fw-bold text-truncate w-100" style="font-size: 0.75rem; line-height: 1.2;">${badge.name}</div>
                                            <div class="small text-muted mt-1" style="font-size: 0.7rem;">ğŸ’° ${fixedSellPrice.toLocaleString()} C</div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        `;
                        return; // æ›é‡‘å“ã¯é€šå¸¸ãƒãƒƒã‚¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«å«ã‚ãªã„
                    }

                    // ä»¥ä¸‹ã€é€šå¸¸ãƒãƒƒã‚¸ã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå¤‰æ›´ãªã—ï¼‰
                    // å³ä¸‹ã«å€‹æ•°ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ©ãƒ™ãƒ«
                    const countLabel = count > 1 ? `<span class="badge bg-dark position-absolute bottom-0 end-0 m-1" style="font-size:0.6rem; z-index:4; opacity: 0.9;">x${count}</span>` : '';

                    const cardHtml = `
                        <div class="col-4 col-sm-3 col-md-5th mb-3">
                            <div class="card h-100 shadow-sm border-0 position-relative badge-card ${rarityClass}" style="border-radius: 12px; overflow: hidden; transition: transform 0.2s; color: inherit;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                                <a href="../badge/index.html?id=${badge.id}${hasMutant ? '&view=mutant' : ''}" class="text-decoration-none w-100 h-100 d-flex flex-column align-items-center justify-content-center" style="color: inherit;">
                                    <div class="card-body p-2 d-flex flex-column align-items-center justify-content-center text-center">
                                        <div class="position-relative mb-1">
                                            <div class="badge-item ${isEquipped ? 'equipped' : ''} ${hasMutant ? 'badge-image-container mutant-active' : ''}" style="width: 70px; height: 70px; padding: 5px; background: transparent; border-width: 2px; border-radius: 50%;">
                                                <img src="${badge.image_url}" alt="${badge.name}" style="width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2)); ${hasMutant ? 'position: relative; z-index: 1;' : ''}">
                                                ${hasMutant ? '<div class="mutant-shine-overlay"></div>' : ''}
                                            </div>
                                            ${isEquipped ? '<span class="badge bg-gold position-absolute top-0 start-0" style="font-size:0.4rem; z-index:2;">è£…ç€ä¸­</span>' : ''}
                                            ${countLabel}
                                        </div>
                                        <div class="small opacity-75 text-truncate w-100 px-1" style="font-size: 0.65rem; line-height: 1.2;">${badge.name}</div>
                                        <span class="badge mt-1" style="background: rgba(0,0,0,0.2); font-size: 0.45rem; padding: 2px 5px;">${rarity}</span>
                                    </div>
                                </a>
                                
                                ${(!isViewMode && !isNonSaleable) ? `
                                    <div class="dropdown position-absolute top-0 end-0" style="z-index: 5;">
                                        <button class="btn btn-link btn-sm p-1" data-bs-toggle="dropdown" style="font-size: 0.7rem; color: inherit; opacity: 0.5;">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0" style="font-size: 0.75rem; min-width: 80px;">
                                            <li><a class="dropdown-item py-1" href="javascript:void(0)" onclick="openBadgeSelectionModal('sell')">å£²å´</a></li>
                                            <li><a class="dropdown-item py-1" href="javascript:void(0)" onclick="openBadgeSelectionModal('transfer')">è­²æ¸¡</a></li>
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;

                    if (!isNonSaleable) {
                        purchasableHtml += cardHtml;
                    } else {
                        specialHtml += cardHtml;
                    }
                });

                // è¡¨ç¤ºã®å‡ºã—åˆ†ã‘
                if (purchasableHtml) {
                    purchasableSection.style.display = 'block';
                    purchasableList.innerHTML = purchasableHtml;
                } else {
                    purchasableSection.style.display = 'none';
                }

                if (specialHtml) {
                    specialSection.style.display = 'block';
                    specialList.innerHTML = specialHtml;
                } else {
                    specialSection.style.display = 'none';
                }

                if (convertibleHtml) {
                    convertibleSection.style.display = 'block';
                    convertibleList.innerHTML = convertibleHtml;
                } else {
                    convertibleSection.style.display = 'none';
                }

                noBadgesMsg.style.display = 'none';

                // ç·è³‡ç”£ï¼ˆæ‰€æŒé‡‘ + ãƒãƒƒã‚¸ä¾¡å€¤ï¼‰ã‚’æ›´æ–°
                const calculatedTotalAssets = userCoins + totalBadgeAssetValue;
                const totalAssetsEl = document.getElementById('total-assets-value');
                if (totalAssetsEl) {
                    totalAssetsEl.textContent = calculatedTotalAssets.toLocaleString();
                }

            } catch (err) {
                console.error('ãƒãƒƒã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                if (noBadgesMsg) {
                    noBadgesMsg.textContent = 'èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                    noBadgesMsg.style.display = 'block';
                }
            }
        }

        // ============ è²©å£²å®Ÿç¸¾ã®èª­ã¿è¾¼ã¿ ============
        async function loadRevenueStats() {
            const section = document.getElementById('revenue-section');
            if (!section) return;

            try {
                // royalty_receiveï¼ˆå£²ä¸Šé‚„å…ƒï¼‰ã®ãƒ­ã‚°ã‚’å–å¾—
                const { data: logs, error } = await supabaseClient
                    .from('activity_logs')
                    .select('amount')
                    .eq('user_id', targetId)
                    .eq('action_type', 'royalty_receive');

                if (error) {
                    console.log('Activity logs table may not exist yet:', error);
                    return;
                }

                if (!logs || logs.length === 0) {
                    // è²©å£²å®Ÿç¸¾ãŒãªã„å ´åˆã¯éè¡¨ç¤ºã®ã¾ã¾
                    return;
                }

                section.style.display = 'block';

                const totalRevenue = logs.reduce((sum, log) => sum + (log.amount || 0), 0);
                document.getElementById('total-revenue').textContent = `ğŸª™ ${totalRevenue.toLocaleString()}`;
                document.getElementById('revenue-count').textContent = logs.length;

            } catch (err) {
                console.error('è²©å£²å®Ÿç¸¾å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
            }
        }

        // ============ æœ€è¿‘ã®æ´»å‹•ãƒ­ã‚°ã®èª­ã¿è¾¼ã¿ ============
        let activityPage = 0;
        const ACTIVITY_PER_PAGE = 10;

        async function loadActivityLogs(page = 1) {
            const listEl = document.getElementById('activity-list');
            const paginationEl = document.getElementById('activity-pagination');
            const section = document.getElementById('activity-section');
            if (!listEl) return;

            const pageSize = 10;
            console.log('--- loadActivityLogs start ---', { targetId, page });

            try {
                const targetProfile = allProfiles.find(u => u.discord_user_id === targetId);
                const targetName = targetProfile?.account_name;
                console.log('--- loadActivityLogs Integrated Fetch ---', { targetId, targetName });

                // ãƒãƒƒã‚¸æƒ…å ±ã®å–å¾— (gacha_drawè¡¨ç¤ºç”¨)
                let badgeMap = {};
                try {
                    const { data: badgesData } = await supabaseClient
                        .from('badges')
                        .select('id, name, image_url');
                    if (badgesData) {
                        badgesData.forEach(b => badgeMap[b.id] = b);
                    }
                } catch (e) { console.error('ãƒãƒƒã‚¸æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', e); }

                // 1. æœ€æ–°ã®æ´»å‹•ãƒ­ã‚° (é€é‡‘ãƒ»ãŠã¿ãã˜ç­‰)
                const { data: allLogs } = await supabaseClient
                    .from('activity_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(500);



                // 2. æœ€æ–°ã®éº»é›€è¨˜éŒ²
                const { data: allMatches } = await supabaseClient
                    .from('match_results')
                    .select('*')
                    .order('event_datetime', { ascending: false })
                    .limit(500);

                // 3. éå»ã®éº»é›€è¨˜éŒ² (ç¬¬ä¸€å›å¤§ä¼šãªã©)
                const { data: legacyMatches } = await supabaseClient
                    .from('tournament_player_stats_snapshot')
                    .select('*')
                    .limit(500);

                // --- ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° ---
                const actionFilter = document.getElementById('activity-action-filter')?.value || 'all';

                const logs = (allLogs || []).filter(l => {
                    // ã€ä¿®æ­£ã€‘è‡ªåˆ†ãŒã€Œä¸»ä½“ï¼ˆuser_idï¼‰ã€ã§ã‚ã‚‹ãƒ­ã‚°ã®ã¿ã‚’è¡¨ç¤ºã€‚
                    if (l.user_id !== targetId) return false;

                    // è£…ç€ãƒ­ã‚°ã‚„å†…éƒ¨ç®¡ç†ãƒ­ã‚°ã¯éè¡¨ç¤º
                    if (l.action_type === 'badge_equip') return false;
                    // éº»é›€å ±é…¬ãƒ­ã‚°ã¯ä¸‹ã«ã€Œå¯¾å±€å±¥æ­´ã€ã¨ã—ã¦åˆ¥é€”è¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚é™¤å¤–
                    if (l.action_type === 'mahjong') return false;
                    if (l.action_type === 'admin_edit') return false; // ç®¡ç†è€…ç·¨é›†ãƒ­ã‚°ã‚‚éè¡¨ç¤º

                    let details = l.details;
                    if (typeof details === 'string') { try { details = JSON.parse(details); } catch (e) { } }
                    if (details?.is_internal) return false;

                    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
                    if (actionFilter !== 'all') {
                        if (actionFilter === 'transfer') {
                            if (!['transfer_send', 'transfer_receive'].includes(l.action_type)) return false;
                        } else if (actionFilter === 'badge') {
                            if (!['badge_transfer', 'badge_receive', 'badge_sell', 'badge_purchase'].includes(l.action_type)) return false;
                        } else if (actionFilter === 'mahjong') {
                            return false; // éº»é›€ã¯ãƒãƒƒãƒå°‚ç”¨ãªã®ã§ãƒ­ã‚°ã‹ã‚‰ã¯å…¨é™¤å¤–
                        } else {
                            if (l.action_type !== actionFilter) return false;
                        }
                    }

                    return true;
                });

                // éº»é›€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ™‚ã¯ãƒãƒƒãƒã‚’è¡¨ç¤ºã€ãã‚Œä»¥å¤–ã¯ãƒ­ã‚°ã¨åˆæµ
                const showMatchesOnly = actionFilter === 'mahjong';

                const matches = showMatchesOnly || actionFilter === 'all' ? (allMatches || []).filter(m =>
                    m.discord_user_id === targetId || (targetName && (m.account_name === targetName || m.nickname === targetName || m.player_name === targetName))
                ) : [];

                // éå»å¤§ä¼šï¼ˆlegacyï¼‰ã¯ã€Œã™ã¹ã¦ã€ã¨ã€Œéº»é›€ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã¿ã«è¡¨ç¤º
                const showLegacy = actionFilter === 'all' || actionFilter === 'mahjong';
                const legacy = showLegacy ? (legacyMatches || []).filter(m =>
                    m.discord_user_id === targetId || (targetName && (m.account_name === targetName || m.nickname === targetName || m.player_name === targetName))
                ) : [];

                console.log('Filtered (Subjective Only):', { logs: logs.length, matches: matches.length, legacy: legacy.length });

                // --- ãƒãƒ¼ã‚¸ ---
                // activity_logs ã‹ã‚‰éº»é›€è¨˜éŒ²ãŒãªããªã£ãŸãŸã‚ã€å˜ç´”ãªçµåˆã¨ã‚½ãƒ¼ãƒˆã§æ¸ˆã‚€ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
                let combined = [];

                logs.forEach(l => {
                    let details = l.details;
                    if (typeof details === 'string') { try { details = JSON.parse(details); } catch (e) { } }
                    combined.push({ ...l, details, timestamp: new Date(l.created_at), isMatch: false });
                });

                matches.forEach(m => {
                    combined.push({
                        action_type: 'mahjong', amount: null, match_id: m.match_id,
                        timestamp: new Date(m.event_datetime),
                        details: {
                            rank: m.rank,
                            final_score: m.final_score,
                            mode: m.mahjong_mode,
                            tournament_type: m.tournament_type,
                            match_mode: m.match_mode
                        },
                        isMatch: true
                    });
                });

                legacy.forEach(m => {
                    combined.push({
                        action_type: 'mahjong', amount: null, match_id: 'legacy-' + Math.random(),
                        timestamp: new Date(m.created_at || m.updated_at || '2024-01-01'),
                        details: {
                            rank: null, // éå»å¤§ä¼šã¯é †ä½éè¡¨ç¤º
                            final_score: m.score_total,
                            mode: 'ã€ç¬¬ä¸€å›éº»é›€å¤§ä¼šã€‘',
                            is_legacy: true
                        },
                        isMatch: true
                    });
                });

                combined.sort((a, b) => b.timestamp - a.timestamp);

                if (combined.length === 0) {
                    const rlsHint = (allLogs && allLogs.length === 0) ? '<br><small class="text-warning">â€»é€é‡‘è¨˜éŒ²ãªã©ãŒ1ä»¶ã‚‚è¡¨ç¤ºã•ã‚Œãªã„å ´åˆã€Supabaseã®æ¨©é™è¨­å®š(RLS)ãŒå¿…è¦ã§ã™ã€‚</small>' : '';
                    listEl.innerHTML = `<div class="text-center text-muted py-3" > æ´»å‹•ãƒ­ã‚°ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“${rlsHint}</div> `;
                    section.style.display = 'block';
                    paginationEl.style.display = 'none';
                    return;
                }

                section.style.display = 'block';

                // 5. ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
                const itemsPerPage = 8;
                const totalPages = Math.ceil(combined.length / itemsPerPage);
                const pageItems = combined.slice((page - 1) * itemsPerPage, page * itemsPerPage);

                const typeNames = {
                    'mahjong': 'ğŸ€„ éº»é›€è¨˜éŒ²',
                    'transfer_send': 'ğŸ’¸ é€é‡‘(é€)',
                    'transfer_receive': 'ğŸ§§ é€é‡‘(å—)',
                    'badge_transfer': 'ğŸ ãƒãƒƒã‚¸è­²æ¸¡',
                    'badge_receive': 'ğŸ“¦ ãƒãƒƒã‚¸å—å–',
                    'badge_sell': 'ğŸ’´ ãƒãƒƒã‚¸å£²å´',
                    'badge_purchase': 'ğŸ›’ ãƒãƒƒã‚¸è³¼å…¥',
                    'omikuji': 'ğŸ‹ ãŠã¿ãã˜',
                    'royalty_receive': 'ğŸ’ å£²ä¸Šé‚„å…ƒ',
                    'admin_edit': 'âš™ï¸ ç®¡ç†è€…ä¿®æ­£',
                    'gacha_draw': 'â›©ï¸ ãŠè³½éŠ­'
                };

                listEl.innerHTML = pageItems.map(log => {
                    const date = log.timestamp.toLocaleString('ja-JP', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                    const typeName = typeNames[log.action_type] || log.action_type;
                    const isTicketOmikuji = log.action_type === 'omikuji' && log.details?.ticket_reward;
                    // ã‚¬ãƒãƒ£ã§ã‚³ã‚¤ãƒ³0ã®å ´åˆã¯ç¥ˆé¡˜ç¬¦ï¼ˆãƒã‚±ãƒƒãƒˆï¼‰ä½¿ç”¨ãªã®ã§ğŸ«-1è¡¨ç¤º
                    const isTicketGacha = log.action_type === 'gacha_draw' && log.amount === 0;
                    const amountStr = isTicketGacha ? 'ğŸ« -1' : (log.amount !== null && (!isTicketOmikuji || log.amount !== 0)) ? `ğŸª™ ${log.amount.toLocaleString()}` : '';

                    // ç›¸æ‰‹ã®æƒ…å ±ã‚’å–å¾—ï¼ˆåŸºæœ¬ã¯ target_user_idã€‚å¸¸ã«æœ€æ–°ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å‚ç…§ï¼‰
                    const otherId = log.target_user_id;
                    const otherProfile = otherId ? allProfiles.find(p => p.discord_user_id === String(otherId)) : null;

                    const otherHtml = otherProfile ? `
                        <div class="d-inline-flex align-items-center gap-1 mx-1" >
                            <img src="${otherProfile.avatar_url || 'https://cdn.discordapp.com/embed/avatars/0.png'}"
                                class="rounded-circle shadow-sm" style="width: 24px; height: 24px; object-fit: cover;">
                                <span class="fw-bold">${otherProfile.account_name || 'èª°ã‹'}</span>
                            </div>` : (otherId ? ` <span class="badge bg-secondary" > ID: ${otherId}</span> ` : '');

                    let detailsStr = '';
                    if (log.isMatch) {
                        const rank = log.details?.rank || '-';
                        const score = log.details?.final_score || '0';
                        const mode = log.details?.mode || '';
                        const tType = log.details?.tournament_type || '';
                        const mMode = log.details?.match_mode || '';

                        // å¤§ä¼šç¨®åˆ¥ã®è¡¨ç¤ºç”¨ãƒ©ãƒ™ãƒ«
                        const tLabel = mMode ? `${mMode} ` : (tType.includes('å€‹äºº') ? 'å€‹äººæˆ¦' : (tType.includes('å›£ä½“') ? 'å›£ä½“æˆ¦' : ''));
                        const tPrefix = tLabel ? `<span class="text-muted small me-1" > [${tLabel}]</span> ` : '';

                        // éå»å¤§ä¼šï¼ˆlegacyï¼‰ã®å ´åˆã¯é †ä½ã‚’éè¡¨ç¤º
                        const showRank = !log.details?.is_legacy && rank !== null;
                        detailsStr = `
                        <div class="d-inline-flex align-items-center flex-wrap" >
                            ${tPrefix}
                                <span class="fw-bold text-dark me-2">${mode}</span>
                                ${showRank ? `<span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 me-2" style="font-size: 0.8rem;">${rank}ä½</span>` : ''}
                                <span class="text-secondary small">(${score >= 0 ? '+' : ''}${score} pts)</span>
                            </div>
                        `;
                    } else if (log.action_type === 'transfer_send') {
                        detailsStr = `â¡ ${otherHtml} ã¸ã®é€é‡‘`;
                    } else if (log.action_type === 'transfer_receive') {
                        detailsStr = `â¬… ${otherHtml} ã‹ã‚‰ã®é€é‡‘`;
                    } else if (log.action_type === 'badge_transfer') {
                        detailsStr = `ğŸ ã€Œ${log.details?.badge_name || 'ãƒãƒƒã‚¸'}ã€ã‚’ ${otherHtml} ã¸è­²æ¸¡`;
                    } else if (log.action_type === 'badge_receive') {
                        detailsStr = `ğŸ“¦ ã€Œ${log.details?.badge_name || 'ãƒãƒƒã‚¸'}ã€ã‚’ ${otherHtml} ã‹ã‚‰å—å–`;
                    } else if (log.action_type === 'badge_sell') {
                        detailsStr = `ğŸ’´ ã€Œ${log.details?.badge_name || 'ãƒãƒƒã‚¸'}ã€ã‚’å£²å´`;
                    } else if (log.action_type === 'badge_purchase') {
                        detailsStr = `ğŸ›’ ã€Œ${log.details?.badge_name || 'ãƒãƒƒã‚¸'}ã€ã‚’è³¼å…¥`;
                    } else if (log.action_type === 'omikuji') {
                        const tr = log.details?.ticket_reward;
                        const rank = log.details?.rank || 'ä¸æ˜';
                        if (tr) {
                            detailsStr = `ğŸ‹ é‹å‹¢: <strong>${rank}</strong> <span class="badge bg-warning text-dark ms-1" style="font-size: 0.75rem;">ğŸ« +${tr}æš ç¥ˆé¡˜ç¬¦</span>`;
                        } else {
                            detailsStr = `ğŸ‹ é‹å‹¢: <strong>${rank}</strong>`;
                        }
                    } else if (log.action_type === 'royalty_receive') {
                        detailsStr = `ğŸ’ ã€Œ${log.details?.badge_name || 'ãƒãƒƒã‚¸'}ã€ã®å£²è²·é‚„å…ƒ ${otherId ? `(by ${otherHtml})` : ''} `;
                    } else if (log.action_type === 'admin_edit') {
                        detailsStr = `âš™ï¸ ç®¡ç†è€…ã«ã‚ˆã‚‹${log.amount >= 0 ? 'åŠ ç®—' : 'æ¸›ç®—'} `;
                    } else if (log.action_type === 'gacha_draw') {
                        const badgeId = log.badge_id;
                        const resultName = log.details?.result_name || log.details?.name || 'ã‚¢ã‚¤ãƒ†ãƒ ';
                        const resultType = log.details?.result_type || log.details?.type;

                        if (badgeId && badgeMap[badgeId]) {
                            const badge = badgeMap[badgeId];
                            detailsStr = `
                        <div class="d-inline-flex align-items-center gap-1" >
                            <img src="${badge.image_url}" style="width: 30px; height: 30px; object-fit: contain;" title="${badge.name}">
                                <span>${badge.name} ã‚’ç²å¾—</span>
                            </div>
                    `;
                        } else {
                            let icon = 'ğŸ';
                            if (resultType === 'exchange_ticket') icon = 'ğŸ«';
                            else if (resultType === 'stone') icon = 'ğŸ’ ';

                            detailsStr = `${icon} ${resultName} ã‚’ç²å¾—`;
                        }
                    }

                    return `
                        <div class="activity-item-card" >
                            <span class="activity-date">${date}</span>
                            <div class="row align-items-center g-2">
                                <div class="col">
                                    <div class="d-flex flex-wrap align-items-center gap-2">
                                        <span class="activity-type-badge">${typeName}</span>
                                        <span class="activity-details">${detailsStr}</span>
                                    </div>
                                </div>
                                <div class="col-auto text-end">
                                    <span class="activity-amount ${log.amount > 0 ? 'text-success' : log.amount < 0 ? 'text-danger' : ''}">${amountStr}</span>
                                </div>
                            </div>
                        </div>
                        `;
                }).join('');

                // 6. ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³UI
                const paginationArea = document.getElementById('activity-pagination-area');
                if (totalPages > 1) {
                    let pagHtml = '';
                    for (let i = 1; i <= totalPages; i++) {
                        pagHtml += `
                        <li class="page-item ${i === page ? 'active' : ''}">
                            <a class="page-link shadow-sm" href="javascript:void(0)" onclick="loadActivityLogs(${i})">${i}</a>
                        </li>`;
                    }
                    paginationEl.innerHTML = pagHtml;
                    if (paginationArea) paginationArea.style.display = 'block';
                } else {
                    if (paginationArea) paginationArea.style.display = 'none';
                }

            } catch (err) {
                console.error('Activity logs error:', err);
                listEl.innerHTML = '<div class="text-center text-danger py-3">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        // ============ ãƒãƒƒã‚¸è­²æ¸¡ãƒ»å£²å´ï¼šãƒãƒƒã‚¸é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« ============
        // ============ ãƒãƒƒã‚¸è­²æ¸¡ãƒ»å£²å´ï¼šãƒãƒƒã‚¸é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« ============
        async function openBadgeSelectionModal(mode) {
            const listEl = document.getElementById('action-badge-list');
            listEl.innerHTML = '<p class="text-center text-muted py-3">èª­ã¿è¾¼ã¿ä¸­...</p>';

            document.getElementById('badgeActionModalLabel').textContent = mode === 'transfer' ? 'è­²æ¸¡ã™ã‚‹ãƒãƒƒã‚¸ã‚’é¸æŠ' : 'å£²å´ã™ã‚‹ãƒãƒƒã‚¸ã‚’é¸æŠ';

            const modalEl = document.getElementById('badgeActionModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();

            try {
                // æ‰€æŒãƒãƒƒã‚¸ã®å–å¾—ï¼ˆæ–°ãƒ†ãƒ¼ãƒ–ãƒ« user_badges_new ã‚’ä½¿ç”¨ï¼‰
                const { data: owned, error } = await supabaseClient
                    .from('user_badges_new')
                    .select('*, badges(*)')
                    .eq('user_id', targetId);

                if (error) throw error;

                // å…¨ãƒãƒƒã‚¸ã®æµé€šæ•°ã‚’å–å¾—ï¼ˆä¾¡æ ¼è¨ˆç®—ç”¨ï¼‰
                const { data: marketCountRes } = await supabaseClient
                    .from('user_badges_new')
                    .select('badge_id');

                const marketCounts = {};
                (marketCountRes || []).forEach(s => {
                    marketCounts[s.badge_id] = (marketCounts[s.badge_id] || 0) + 1;
                });

                if (!owned || owned.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-muted py-3">å¯¾è±¡ã®ãƒãƒƒã‚¸ã‚’æŒã£ã¦ã„ã¾ã›ã‚“</p>';
                    return;
                }

                // éå£²å“ï¼ˆé™å®šå“ï¼‰ã‚’é™¤å¤–
                let targetBadges = owned.filter(item => item.badges && item.badges.sales_type !== 'é™å®šå“');

                // è­²æ¸¡ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿æ›é‡‘å“ã‚’é™¤å¤–
                if (mode === 'transfer') {
                    targetBadges = targetBadges.filter(item => item.badges && item.badges.sales_type !== 'æ›é‡‘å“');
                }

                if (targetBadges.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-muted py-3">è­²æ¸¡ãƒ»å£²å´å¯èƒ½ãªãƒãƒƒã‚¸ã‚’æŒã£ã¦ã„ã¾ã›ã‚“</p>';
                    return;
                }

                // æ›é‡‘å“ã¨é€šå¸¸ãƒãƒƒã‚¸ã‚’åˆ†é›¢
                const convertibleGroups = new Map();
                const normalItems = [];

                targetBadges.forEach(item => {
                    if (!item.badges) return;

                    if (item.badges.sales_type === 'æ›é‡‘å“') {
                        const badgeId = item.badges.id;
                        if (!convertibleGroups.has(badgeId)) {
                            convertibleGroups.set(badgeId, {
                                badge: item.badges,
                                count: 0
                            });
                        }
                        convertibleGroups.get(badgeId).count++;
                    } else {
                        normalItems.push(item);
                    }
                });

                let htmlParts = [];

                // æ›é‡‘å“ã®HTMLç”Ÿæˆï¼ˆã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼‰
                convertibleGroups.forEach(group => {
                    const badge = group.badge;
                    const count = group.count;
                    const sellPrice = badge.price;
                    const totalSell = sellPrice * count;

                    htmlParts.push(`
                        <div class="user-select-item" onclick="openConvertibleSellModal('${badge.id}', '${badge.name.replace(/'/g, "\\'")}', ${count}, ${sellPrice})">
                            <img src="${badge.image_url}" class="user-select-avatar" style="border-radius: 8px;">
                            <div class="flex-grow-1">
                                <div class="user-select-name">${badge.name} <span class="badge bg-dark">Ã—${count}</span></div>
                                <div class="small text-muted" style="font-size: 0.75rem;">
                                    å£²å´: ğŸª™${sellPrice.toLocaleString()} C Ã— ${count} = ğŸª™${totalSell.toLocaleString()} C
                                </div>
                            </div>
                            <div class="text-danger fw-bold">å£²å´</div>
                        </div>
                    `);
                });

                // é€šå¸¸ãƒãƒƒã‚¸ã®å‡¦ç†
                listEl.innerHTML = htmlParts.join('') + normalItems.map(item => {
                    const badge = item.badges;
                    if (!badge) return '';

                    const n = marketCounts[badge.id] || 0;

                    // ä¾¡æ ¼è¨ˆç®—: sales_type ã«åŸºã¥ã
                    let pValue;
                    if (badge.sales_type === 'å¤‰å‹•å‹') {
                        pValue = Math.ceil(badge.price * Math.pow(1.3, Math.max(0, n - 1)));
                    } else {
                        // å›ºå®šå‹ã€nullã€ãã®ä»–ã¯åˆæœŸä¾¡æ ¼ã®ã¾ã¾
                        pValue = badge.price;
                    }

                    const pSell = Math.ceil(pValue * 0.7 * (item.is_mutant ? 3 : 1));
                    const buyPrice = item.purchased_price || 0;

                    const mutantLabel = item.is_mutant ? '<span class="text-warning fw-bold">(Mutant)</span>' : '';

                    if (mode === 'transfer') {
                        return `
                    <div class="user-select-item" onclick="openUUIDTransferModal('${item.uuid}', '${badge.name.replace(/'/g, "\\'")}', ${buyPrice}, ${pValue}, ${pSell})">
                        <img src="${badge.image_url}" class="user-select-avatar" style="border-radius: 8px;">
                                <div class="flex-grow-1">
                                    <div class="user-select-name">${badge.name} ${mutantLabel}</div>
                                    <div class="small text-muted" style="font-size: 0.75rem;">
                                        è³¼å…¥: ğŸª™${buyPrice.toLocaleString()} | 
                                        æ™‚ä¾¡: ğŸª™${pValue.toLocaleString()} | 
                                        å£²å´: ğŸª™${pSell.toLocaleString()}
                                    </div>
                                </div>
                                <div class="text-primary fw-bold">é¸æŠ</div>
                            </div>
                    `;
                    } else {
                        return `
                    <div class="user-select-item" onclick="sellBadgeConfirm('${item.uuid}', '${badge.name.replace(/'/g, "\\'")}', ${buyPrice}, ${pValue}, ${pSell})">
                        <img src="${badge.image_url}" class="user-select-avatar" style="border-radius: 8px;">
                                <div class="flex-grow-1">
                                    <div class="user-select-name">${badge.name} ${mutantLabel}</div>
                                    <div class="small text-muted" style="font-size: 0.75rem;">
                                        è³¼å…¥: ğŸª™${buyPrice.toLocaleString()} | 
                                        æ™‚ä¾¡: ğŸª™${pValue.toLocaleString()} | 
                                        å£²å´: ğŸª™${pSell.toLocaleString()}
                                    </div>
                                </div>
                                <div class="text-danger fw-bold">å£²å´</div>
                            </div>
                    `;
                    }
                }).join('');
            } catch (err) {
                console.error('Error loading action badges:', err);
                listEl.innerHTML = '<p class="text-center text-danger py-3">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
            }
        }

        // ======= ãƒãƒƒã‚¸å£²å´ãƒ»è­²æ¸¡ =======
        let currentActionUUID = null;
        let currentActionBadgeName = null;
        let currentActionDetails = null;

        function sellBadgeConfirm(uuid, name, purchasedPrice, pValue, pSell) {
            currentActionUUID = uuid;
            currentActionBadgeName = name;

            // å®‰å…¨ãªæ•°å€¤å¤‰æ›ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
            const pPrice = Number(purchasedPrice) || 0;
            const pVal = Number(pValue) || 0;
            const sPrice = Number(pSell) || 0;
            const profit = sPrice - pPrice;
            const profitStr = (profit >= 0 ? '+' : '') + profit.toLocaleString();

            const msg = `ã€Œ${name}ã€ã‚’å£²å´ã—ã¾ã™ã‹ï¼Ÿ\n\n` +
                `ãƒ»è³¼å…¥æ™‚ã®é‡‘é¡: ğŸª™ ${pPrice.toLocaleString()} \n` +
                `ãƒ»ç¾åœ¨ã®å¸‚å ´ä¾¡å€¤: ğŸª™ ${pVal.toLocaleString()} \n` +
                `ãƒ»å®Ÿéš›ã®å£²å´ä¾¡æ ¼: ğŸª™ ${sPrice.toLocaleString()} \n` +
                `--------------------------\n` +
                `ãƒ»äºˆæƒ³æç›Š: ${profitStr} `;

            if (confirm(msg)) {
                // é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modalEl = document.getElementById('badgeActionModal');
                if (modalEl) {
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                }
                executeSellUUID();
            }
        }

        async function executeSellUUID() {
            toggleLoading(true);
            try {
                const { data, error } = await supabaseClient.rpc('sell_badge_v2', {
                    p_user_id: targetId,
                    p_badge_uuid: currentActionUUID
                });

                if (error) throw error;
                if (!data.ok) throw new Error(data.error);

                alert(`ãƒãƒƒã‚¸ã‚’ ğŸª™${data.sell_price.toLocaleString()} ã§å£²å´ã—ã¾ã—ãŸã€‚`);
                // æ´»å‹•ãƒ­ã‚°è¨˜éŒ²
                if (typeof logActivity === 'function') {
                    await logActivity(targetId, 'badge_sell', {
                        amount: data.sell_price,
                        details: { badge_uuid: currentActionUUID, badge_name: currentActionBadgeName }
                    });
                }
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modalEl = document.getElementById('badgeActionModal');
                if (modalEl) {
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                }
                loadOwnedBadges();
                loadActivityLogs();
                // è‡ªåˆ†ã®æƒ…å ±ã‚’å†èª­ã¿è¾¼ã¿
                const user = await getCurrentUser();
                if (user) displayMyInfo(user);
            } catch (err) {
                console.error('å£²å´ã‚¨ãƒ©ãƒ¼:', err);
                alert('å£²å´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            } finally {
                toggleLoading(false);
            }
        }

        // ============ æ›é‡‘å“ã®å£²å´ ============
        async function openConvertibleSellModal(badgeId, badgeName, totalCount, fixedPrice) {
            const quantity = prompt(`ã€Œ${badgeName}ã€ã‚’ä½•å€‹å£²å´ã—ã¾ã™ã‹ï¼Ÿï¼ˆæ‰€æŒæ•°: ${totalCount} å€‹ã€å£²å´ä¾¡æ ¼: ${fixedPrice.toLocaleString()} C / å€‹ï¼‰`, '1');

            if (!quantity) return;

            const count = parseInt(quantity);
            if (isNaN(count) || count <= 0) {
                alert('æœ‰åŠ¹ãªå€‹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (count > totalCount) {
                alert(`æ‰€æŒæ•°ï¼ˆ${totalCount} å€‹ï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`);
                return;
            }

            const totalPrice = fixedPrice * count;
            if (!confirm(`ã€Œ${badgeName}ã€ã‚’ ${count} å€‹å£²å´ã—ã¾ã™ã‹ï¼Ÿï¼ˆåˆè¨ˆ: ğŸ’°${totalPrice.toLocaleString()} Cï¼‰`)) return;

            toggleLoading(true);
            try {
                // æ‰€æŒã—ã¦ã„ã‚‹æ›é‡‘å“ã® UUID ã‚’å–å¾—
                const { data: ownedItems, error: fetchError } = await supabaseClient
                    .from('user_badges_new')
                    .select('uuid')
                    .eq('user_id', targetId)
                    .eq('badge_id', badgeId)
                    .limit(count);

                if (fetchError) throw fetchError;
                if (!ownedItems || ownedItems.length < count) throw new Error('æŒ‡å®šã—ãŸæ•°ã®ãƒãƒƒã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');

                // ä¸€ã¤ãšã¤å£²å´
                let successCount = 0;
                for (const item of ownedItems) {
                    const { data, error } = await supabaseClient.rpc('sell_badge_v2', {
                        p_user_id: targetId,
                        p_badge_uuid: item.uuid
                    });

                    if (error || !data.ok) {
                        console.error('å£²å´ã‚¨ãƒ©ãƒ¼:', error || data.error);
                        continue;
                    }
                    successCount++;
                }

                if (successCount > 0) {
                    const actualTotalPrice = fixedPrice * successCount;
                    alert(`ã€Œ${badgeName}ã€ã‚’ ${successCount} å€‹å£²å´ã—ã¾ã—ãŸã€‚ï¼ˆåˆè¨ˆ: ğŸ’°${actualTotalPrice.toLocaleString()} Cï¼‰`);

                    // æ´»å‹•ãƒ­ã‚°è¨˜éŒ²
                    if (typeof logActivity === 'function') {
                        await logActivity(targetId, 'badge_sell', {
                            amount: actualTotalPrice,
                            details: {
                                badge_id: badgeId,
                                badge_name: badgeName,
                                quantity: successCount,
                                unit_price: fixedPrice
                            }
                        });
                    }

                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    const modalEl = document.getElementById('badgeActionModal');
                    if (modalEl) {
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        if (modal) modal.hide();
                    }
                    loadOwnedBadges();
                    loadActivityLogs();
                    loadTargetUserInfo(); // è£…ç€ãƒãƒƒã‚¸ãŒå£²å´ã•ã‚ŒãŸå ´åˆè‡ªå‹•ã§å¤–ã™
                    const user = await getCurrentUser();
                    if (user) displayMyInfo(user);
                } else {
                    throw new Error('å£²å´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            } catch (err) {
                console.error('æ›é‡‘å“å£²å´ã‚¨ãƒ©ãƒ¼:', err);
                alert('å£²å´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            } finally {
                toggleLoading(false);
            }
        }

        function openUUIDTransferModal(uuid, name, purchasedPrice, pValue, pSell) {
            currentActionUUID = uuid;
            currentActionBadgeName = name;

            // è­²æ¸¡æ™‚ã«ã‚‚è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«è©³ç´°æ–‡å­—åˆ—ã‚’æ§‹ç¯‰
            currentActionDetails =
                `ãƒ»è³¼å…¥é¡: ğŸª™ ${purchasedPrice.toLocaleString()} \n` +
                `ãƒ»ç¾åœ¨ä¾¡å€¤: ğŸª™ ${pValue.toLocaleString()} \n` +
                `ãƒ»æœŸå¾…å£²å´é¡: ğŸª™ ${pSell.toLocaleString()} \n` +
                `--------------------------\n` +
                `â€»è­²æ¸¡ã™ã‚‹ã¨ã‚ãªãŸã®æ‰‹å…ƒã‹ã‚‰ã¯ãªããªã‚Šã¾ã™ã€‚`;

            // é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            const modalEl = document.getElementById('badgeActionModal');
            if (modalEl) bootstrap.Modal.getInstance(modalEl)?.hide();
            openUserSelectModal('badge_transfer');
        }

        // è­²æ¸¡å®Ÿè¡Œã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆå…±æœ‰ã•ã‚Œã¦ã„ã‚‹ openUserSelectModal ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
        // æ—¢å­˜ã® executeTransferConfirmation ã¯ badge_id ãƒ™ãƒ¼ã‚¹ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€UUIDå¯¾å¿œç‰ˆã«å·®ã—æ›¿ãˆãŒå¿…è¦ãªå ´åˆã¯
        // ã“ã“ã§å†å®šç¾©ã™ã‚‹ã‹ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«èª¿æ•´ã™ã‚‹ã€‚mypage/index.html å†…ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã‚Œã‚’ä¸Šæ›¸ãã™ã‚‹ã€‚

        // ============ ãƒãƒƒã‚¸è£…ç€ ============
        let selectedBadgeIdForEquip = null;

        function selectBadgeInModal(badgeId) {
            selectedBadgeIdForEquip = badgeId;
            document.querySelectorAll('#badge-modal-list .badge-item').forEach(el => {
                el.classList.remove('selected');
            });
            const targetEl = document.querySelector(`.badge-item[data-badge-id="${badgeId}"]`);
            if (targetEl) targetEl.classList.add('selected');
            
            const btn = document.getElementById('btn-execute-equip');
            if (btn) btn.disabled = false;
        }

        async function executeSelectedEquip() {
            if (!selectedBadgeIdForEquip) return;
            const posRadio = document.querySelector('input[name="badge-position"]:checked');
            const position = posRadio ? posRadio.value : 'left';
            
            toggleLoading(true);
            await equipBadge(selectedBadgeIdForEquip, position);
            toggleLoading(false);
            
            selectedBadgeIdForEquip = null;
        }

        async function equipBadge(badgeId, position = null) {
            if (isViewMode) return;

            // positionãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å€¤ã‚’å–å¾—
            if (!position) {
                const posRadio = document.querySelector('input[name="badge-position"]:checked');
                position = posRadio ? posRadio.value : 'left';
            }

            const columnName = position === 'right' ? 'equipped_badge_id_right' : 'equipped_badge_id';

            // ç¾åœ¨ã®è£…ç€çŠ¶æ³ã‚’ç¢ºèª
            const { data: current } = await supabaseClient
                .from('profiles')
                .select('equipped_badge_id, equipped_badge_id_right')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            // åŒã˜ãƒãƒƒã‚¸ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯å¤–ã™
            const currentBadgeId = position === 'right' ? current?.equipped_badge_id_right : current?.equipped_badge_id;
            const oppositeBadgeId = position === 'right' ? current?.equipped_badge_id : current?.equipped_badge_id_right;
            const oppositeColumn = position === 'right' ? 'equipped_badge_id' : 'equipped_badge_id_right';
            
            const newBadgeId = (currentBadgeId === badgeId) ? null : badgeId;
            
            // åå¯¾å´ã®ã‚¹ãƒ­ãƒƒãƒˆã«åŒã˜ãƒãƒƒã‚¸ãŒè£…ç€ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç§»å‹•ï¼ˆåå¯¾å´ã‚’å¤–ã™ï¼‰
            let updateData = { [columnName]: newBadgeId };
            if (badgeId && badgeId === oppositeBadgeId) {
                updateData[oppositeColumn] = null; // åå¯¾å´ã‚’å¤–ã™
            }

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update(updateData)
                    .eq('discord_user_id', targetId);

                if (error) throw error;

                await loadOwnedBadges(); // ãƒªã‚¹ãƒˆæ›´æ–°
                await loadTargetUserInfo(); // åå‰æ¨ªã®ãƒãƒƒã‚¸æ›´æ–°

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modalEl = document.getElementById('badgeChangeModal');
                bootstrap.Modal.getInstance(modalEl)?.hide();
            } catch (err) {
                console.error('è£…ç€ã‚¨ãƒ©ãƒ¼:', err);
                alert('ãƒãƒƒã‚¸ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // è£…ç€ãƒãƒƒã‚¸ã®å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«
        async function openBadgeChangeModal() {
            selectedBadgeIdForEquip = null;
            const btnExec = document.getElementById('btn-execute-equip');
            if (btnExec) btnExec.disabled = true;

            const listEl = document.getElementById('badge-modal-list');
            listEl.innerHTML = '<p class="text-center text-muted py-3">èª­ã¿è¾¼ã¿ä¸­...</p>';

            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆ1å›ã ã‘è¨­å®šï¼‰
            const posRadios = document.querySelectorAll('input[name="badge-position"]');
            posRadios.forEach(radio => {
                if (!radio.dataset.listenerAdded) {
                    radio.addEventListener('change', (e) => {
                        const indicator = document.getElementById('badge-position-indicator');
                        if (indicator) {
                            indicator.textContent = e.target.value === 'left' ? 'â—€ å·¦ã«è£…ç€' : 'å³ã«è£…ç€ â–¶';
                        }
                    });
                    radio.dataset.listenerAdded = "true";
                }
            });

            // åˆæœŸåŒ–
            const leftRadio = document.getElementById('pos-left');
            const indicator = document.getElementById('badge-position-indicator');
            if (indicator) {
                if (leftRadio && leftRadio.checked) {
                     indicator.textContent = 'â—€ å·¦ã«è£…ç€';
                } else {
                     indicator.textContent = 'å³ã«è£…ç€ â–¶';
                }
            }

            const modalEl = document.getElementById('badgeChangeModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();

            try {
                // æ‰€æŒãƒãƒƒã‚¸ï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã®ã¿æŠ½å‡ºï¼‰
                const { data: owned, error } = await supabaseClient
                    .from('user_badges_new')
                    .select('badge_id, badges(*)')
                    .eq('user_id', targetId);

                if (error) throw error;

                const uniqueBadges = [];
                const seen = new Set();
                owned.forEach(item => {
                    if (item.badges && !seen.has(item.badge_id)) {
                        uniqueBadges.push(item.badges);
                        seen.add(item.badge_id);
                    }
                });

                const { data: profile } = await supabaseClient
                    .from('profiles').select('equipped_badge_id, equipped_badge_id_right').eq('discord_user_id', targetId).maybeSingle();
                const equippedLeftId = profile?.equipped_badge_id;
                const equippedRightId = profile?.equipped_badge_id_right;

                if (uniqueBadges.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-muted py-3">ãƒãƒƒã‚¸ã‚’æŒã£ã¦ã„ã¾ã›ã‚“</p>';
                    return;
                }

                listEl.innerHTML = uniqueBadges.map(badge => {
                    const isEquippedLeft = badge.id === equippedLeftId;
                    const isEquippedRight = badge.id === equippedRightId;
                    const isEquipped = isEquippedLeft || isEquippedRight;
                    
                    let posLabel = '';
                    if (isEquippedLeft) posLabel = 'â—€å·¦';
                    if (isEquippedRight) posLabel = 'å³â–¶';
                    if (isEquippedLeft && isEquippedRight) posLabel = 'â—€å·¦å³â–¶';

                    return `
                    <div class="col-4 col-md-3 text-center" >
                            <div class="badge-item ${isEquipped ? 'equipped' : ''}"
                                data-badge-id="${badge.id}"
                                onclick="selectBadgeInModal('${badge.id}')"
                                style="cursor: pointer; position: relative;"
                                title="${badge.name}${isEquipped ? ' (è£…ç€ä¸­)' : ''}">
                                <img src="${badge.image_url}" alt="${badge.name}" style="width: 60px; height: 60px; object-fit: contain;">
                                ${isEquipped ? `<span class="position-absolute top-0 start-50 translate-middle badge bg-primary" style="font-size: 0.6rem; z-index: 10;">${posLabel}</span>` : ''}
                            </div>
                            <div class="small text-truncate mt-1" style="font-size: 0.7rem;">${badge.name}</div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('ãƒãƒƒã‚¸èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                listEl.innerHTML = '<p class="text-center text-danger py-3">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
            }
        }

        // ============ éº»é›€çµ±è¨ˆæ©Ÿèƒ½ ============
        let allMahjongRecords = [];
        let myAccountName = '';
        let currentMyTournament = 'ç¬¬äºŒå›éº»é›€å¤§ä¼š';

        async function loadMahjongStats() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const targetUserId = urlParams.get('user');

                if (targetUserId) {
                    myAccountName = targetUserId;
                } else {
                    const user = await getCurrentUser();
                    if (!user) return;
                    myAccountName = user.user_metadata.provider_id;
                }

                const { data: currentData, error: currentError } = await supabaseClient
                    .from('match_results')
                    .select('*');

                if (currentError) console.warn('ç¬¬äºŒå›ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', currentError);

                let legacyData = [];
                try {
                    const { data, error: legacyError } = await supabaseClient
                        .from('tournament_player_stats_snapshot')
                        .select('*');
                    if (!legacyError) legacyData = data || [];
                } catch (e) {
                    console.warn('ç¬¬ä¸€å›ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¹ã‚­ãƒƒãƒ—:', e);
                }

                const taggedCurrentData = (currentData || []).map(r => ({ ...r, tournament_type: r.tournament_type || 'ç¬¬äºŒå›éº»é›€å¤§ä¼š' }));
                const taggedLegacyData = (legacyData || []).map(r => ({ ...r, tournament_type: r.tournament_type || 'ç¬¬ä¸€å›éº»é›€å¤§ä¼š' }));

                allMahjongRecords = [...taggedCurrentData, ...taggedLegacyData];
                renderTournamentDropdown();
                displayMahjongStats();
            } catch (err) {
                console.error('éº»é›€çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                document.getElementById('stats-loading').style.display = 'none';
                document.getElementById('no-stats-msg').style.display = 'block';
            }
        }

        function renderTournamentDropdown() {
            const select = document.getElementById('tournament-select');
            if (!select) return;
            const tournaments = ['ç¬¬äºŒå›éº»é›€å¤§ä¼š', 'ç¬¬ä¸€å›éº»é›€å¤§ä¼š'];
            let html = tournaments.map(t => `<option value="${t}" ${currentMyTournament === t ? 'selected' : ''}>${t}</option>`).join('');
            html += `<option value="all" ${currentMyTournament === 'all' ? 'selected' : ''}>å…¨ã‚·ãƒ¼ã‚ºãƒ³</option>`;
            select.innerHTML = html;
        }

        function handleTournamentChange() {
            const select = document.getElementById('tournament-select');
            currentMyTournament = select.value;
            displayMahjongStats();
        }

        function displayMahjongStats() {
            let records = allMahjongRecords;
            if (currentMyTournament !== 'all') {
                records = allMahjongRecords.filter(r => r.tournament_type === currentMyTournament);
            }

            const playerStats = calculateAllPlayerStats(records);
            const myStats = playerStats.find(p => p.name === myAccountName);

            document.getElementById('stats-loading').style.display = 'none';
            document.getElementById('stats-content').style.display = 'block';

            const statsGrid = document.getElementById('stats-grid');
            const noStatsMsg = document.getElementById('no-stats-msg');

            if (!myStats || myStats.games === 0) {
                if (statsGrid) statsGrid.style.display = 'none';
                noStatsMsg.style.display = 'block';
                return;
            }
            if (statsGrid) statsGrid.style.display = 'block';
            noStatsMsg.style.display = 'none';

            const formatScore = (val) => (typeof val !== 'number') ? val : Math.round(val * 10) / 10;

            updateStatCard('total', formatScore(myStats.total), playerStats, 'total', true);
            updateStatCard('sanma', formatScore(myStats.sanma), playerStats, 'sanma', true);
            updateStatCard('yonma', formatScore(myStats.yonma), playerStats, 'yonma', true);
            updateStatCard('avg-score', formatScore(myStats.avgScore), playerStats, 'avgScore', true);
            updateStatCard('max-score', formatScore(myStats.maxScore), playerStats, 'maxScore', true);
            updateStatCard('win-rate', myStats.winRate.toFixed(2) + ' / è©¦åˆ', playerStats, 'winRate', true);
            updateStatCard('deal-rate', myStats.dealRate.toFixed(2) + ' / è©¦åˆ', playerStats, 'dealRate', false);
            updateStatCard('top-rate', myStats.topRate.toFixed(1) + '%', playerStats, 'topRate', true);
            updateStatCard('avoid-rate', myStats.avoidRate.toFixed(1) + '%', playerStats, 'avoidRate', true);
            updateStatCard('avg-rank', myStats.avgRank.toFixed(2), playerStats, 'avgRank', false);
            updateStatCard('games', myStats.games, playerStats, 'games', true);
        }

        function updateStatCard(id, value, allStats, key, higherIsBetter) {
            const el = document.getElementById('stat-' + id);
            if (el) el.textContent = value;

            const sorted = [...allStats].filter(p => p.games > 0).sort((a, b) => higherIsBetter ? b[key] - a[key] : a[key] - b[key]);
            const myRank = sorted.findIndex(p => p.name === myAccountName) + 1;
            const total = sorted.length;

            const rankEl = document.getElementById('rank-' + id);
            if (rankEl) {
                if (myRank > 0) {
                    rankEl.textContent = `${myRank}/${total}ä½`;
                    rankEl.classList.remove('no-data');
                } else {
                    rankEl.textContent = '-';
                    rankEl.classList.add('no-data');
                }
            }
        }

        function calculateAllPlayerStats(records) {
            const players = {};
            records.forEach(r => {
                let id = r.discord_user_id;
                if (!id || id === 'null') id = r.nickname || r.account_name || 'Unknown';
                if (!id) return;

                if (!players[id]) {
                    players[id] = { name: id, score: 0, sanma: 0, yonma: 0, count: 0, win: 0, deal: 0, r1: 0, r2: 0, r3: 0, r4: 0, max_score: -Infinity };
                }

                const p = players[id];
                const mode = r.mahjong_mode || r.mode || '';

                if (r.tournament_type === 'ç¬¬ä¸€å›éº»é›€å¤§ä¼š') {
                    p.score += Number(r.score_total || 0);
                    p.count += Number(r.matches_played || 0);
                    p.r1 += Number(r.rank1_count || 0); p.r2 += Number(r.rank2_count || 0); p.r3 += Number(r.rank3_count || 0); p.r4 += Number(r.rank4_count || 0);
                    p.max_score = Math.max(p.max_score, Number(r.score_max || 0));
                } else {
                    p.score += Number(r.final_score || 0);
                    p.count += 1;
                    const rk = Number(r.rank);
                    if (rk === 1) p.r1++; else if (rk === 2) p.r2++; else if (rk === 3) p.r3++; else if (rk === 4) p.r4++;
                    p.max_score = Math.max(p.max_score, Number(r.final_score || 0));
                }
                p.win += Number(r.win_count || r.wins || 0);
                p.deal += Number(r.deal_in_count || r.deals || 0);
                if (mode === 'ä¸‰éº»') p.sanma += Number(r.final_score || r.score_total || 0);
                if (mode === 'å››éº»') p.yonma += Number(r.final_score || r.score_total || 0);
            });

            return Object.values(players).map(p => {
                const count = p.count;
                return {
                    name: p.name, total: p.score, sanma: p.sanma, yonma: p.yonma,
                    avgScore: count > 0 ? p.score / count : 0,
                    maxScore: p.max_score === -Infinity ? 0 : p.max_score,
                    winRate: count > 0 ? p.win / count : 0, dealRate: count > 0 ? p.deal / count : 0,
                    avgRank: count > 0 ? (1 * p.r1 + 2 * p.r2 + 3 * p.r3 + 4 * p.r4) / count : 0,
                    topRate: count > 0 ? (p.r1 / count) * 100 : 0,
                    avoidRate: count > 0 ? (1 - ((p.r4 === 0 && p.r3 > 0 ? p.r3 : p.r4) / count)) * 100 : 0,
                    games: count
                };
            });
        }

        // æˆ»ã‚‹ãƒœã‚¿ãƒ³
        function goBack() {
            if (document.referrer && document.referrer.includes(location.hostname)) history.back();
            else location.href = '../index.html';
        }

        function toggleLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.toggle('active', show);
        }

        document.addEventListener('DOMContentLoaded', initPage);
    </script>

    <!-- ã‚³ã‚¤ãƒ³é€é‡‘ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ -->
    <script>
        let currentSelectMode = '';
        async function openUserSelectModal(mode) {
            currentSelectMode = mode;
            const listEl = document.getElementById('transfer-user-list');
            listEl.innerHTML = '<p class="text-center text-muted py-3">èª­ã¿è¾¼ã¿ä¸­...</p>';
            new bootstrap.Modal(document.getElementById('userSelectModal')).show();

            try {
                const { data: profiles, error } = await supabaseClient
                    .from('profiles')
                    .select('discord_user_id, account_name, avatar_url, equipped_badge_id, badges!equipped_badge_id(image_url)')
                    .neq('discord_user_id', targetId)
                    .order('account_name');

                if (error) throw error;
                listEl.innerHTML = profiles.map(p => `
                    <div class="user-select-item" onclick="confirmSelection('${p.discord_user_id}', '${p.account_name.replace(/'/g, "\\'")}')">
                        <img src="${p.avatar_url || 'https://cdn.discordapp.com/embed/avatars/0.png'}" class="user-select-avatar">
                        <span class="user-select-name">${p.account_name}</span>
                        ${p.badges ? `<img src="${p.badges.image_url}" class="user-select-badge">` : ''}
                    </div>
                `).join('');
            } catch (err) {
                listEl.innerHTML = '<p class="text-center text-danger py-3">èª­ã¿è¾¼ã¿å¤±æ•—</p>';
            }
        }

        let selectedToUserId = '';
        let selectedToUserName = '';
        function confirmSelection(id, name) {
            selectedToUserId = id;
            selectedToUserName = name;
            bootstrap.Modal.getInstance(document.getElementById('userSelectModal'))?.hide();
            if (currentSelectMode === 'coin_transfer') {
                document.getElementById('coin-transfer-target-name').textContent = `${name} ã•ã‚“ã¸é€é‡‘`;
                // æ‰€æŒé‡‘ã‚’è¡¨ç¤ºã«åæ˜ 
                const myProfile = allProfiles.find(p => p.discord_user_id === targetId);
                const currentCoins = (myProfile && myProfile.coins !== undefined) ? myProfile.coins : 0;
                const coinsRefEl = document.getElementById('my-coins-ref');
                if (coinsRefEl) coinsRefEl.textContent = currentCoins.toLocaleString();

                new bootstrap.Modal(document.getElementById('coinAmountModal')).show();
            } else if (currentSelectMode === 'badge_transfer') {
                const msg = `ã€Œ${currentActionBadgeName}ã€ã‚’ ${name} ã•ã‚“ã«è­²æ¸¡ã—ã¾ã™ã‹ï¼Ÿ\n\n` +
                    (currentActionDetails || '');
                if (confirm(msg)) {
                    executeBadgeTransfer(id, name);
                }
            } else if (currentSelectMode === 'ticket_transfer') {
                executeTicketTransfer(id, name);
            } else if (currentSelectMode === 'gacha_ticket_transfer') {
                executeGachaTicketTransfer(id, name);
            }
        }

        async function executeBadgeTransfer(toUserId, toUserName) {
            toggleLoading(true);
            try {
                // 1. ãƒãƒƒã‚¸ã® user_id ã‚’å¤‰æ›´
                const { error: updateError } = await supabaseClient
                    .from('user_badges_new')
                    .update({ user_id: toUserId })
                    .eq('uuid', currentActionUUID);

                if (updateError) throw updateError;

                // 2. æ´»å‹•ãƒ­ã‚°ã‚’è¨˜éŒ²
                if (typeof logActivity === 'function') {
                    const sender = allProfiles.find(p => p.discord_user_id === targetId);
                    const senderName = sender?.account_name || 'èª°ã‹';

                    await logActivity(targetId, 'badge_transfer', {
                        badgeId: currentActionUUID,
                        targetUserId: toUserId,
                        details: { target_name: toUserName, badge_name: currentActionBadgeName }
                    });
                    await logActivity(toUserId, 'badge_receive', {
                        badgeId: currentActionUUID,
                        targetUserId: targetId,
                        details: { sender_name: senderName, badge_name: currentActionBadgeName }
                    });
                }

                alert(`${toUserName} ã•ã‚“ã«ãƒãƒƒã‚¸ã‚’è­²æ¸¡ã—ã¾ã—ãŸï¼`);
                // ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ‰€æŒé‡‘ãƒ»ãƒãƒƒã‚¸æƒ…å ±ã‚‚æ›´æ–°
                await loadOwnedBadges();
                await loadTargetUserInfo(); // è£…ç€ãƒãƒƒã‚¸ãŒè­²æ¸¡ã•ã‚ŒãŸå ´åˆè‡ªå‹•ã§å¤–ã™
                await loadActivityLogs();
                if (!isViewMode) {
                    const user = await getCurrentUser();
                    if (user) await displayMyInfo(user);
                }
            } catch (err) {
                console.error('è­²æ¸¡ã‚¨ãƒ©ãƒ¼:', err);
                alert('è­²æ¸¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                toggleLoading(false);
            }
        }

        async function executeCoinTransfer() {
            const amount = parseInt(document.getElementById('coin-transfer-amount').value);
            if (!amount || amount <= 0) return alert('é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

            toggleLoading(true);
            try {
                const { data, error } = await supabaseClient.rpc('transfer_coins', {
                    p_amount: amount,
                    p_from_id: targetId,
                    p_to_id: selectedToUserId
                });

                if (error) throw error;
                if (!data.ok) throw new Error(data.error || 'é€é‡‘ã«å¤±æ•—ã—ã¾ã—ãŸ');

                alert(`${selectedToUserName} ã•ã‚“ã« ğŸª™${amount.toLocaleString()} é€é‡‘ã—ã¾ã—ãŸã€‚`);
                // æ´»å‹•ãƒ­ã‚°è¨˜éŒ²
                if (typeof logActivity === 'function') {
                    const sender = allProfiles.find(p => p.discord_user_id === targetId);
                    const senderName = sender?.account_name || 'èª°ã‹';

                    await logActivity(targetId, 'transfer_send', {
                        amount: -amount, // é€é‡‘ã¯ãƒã‚¤ãƒŠã‚¹
                        targetUserId: selectedToUserId,
                        details: { target_name: selectedToUserName }
                    });
                    await logActivity(selectedToUserId, 'transfer_receive', {
                        amount: amount,
                        targetUserId: targetId,
                        details: { sender_name: senderName }
                    });
                }

                // UIæ›´æ–°
                if (!isViewMode) {
                    const user = await getCurrentUser();
                    if (user) await displayMyInfo(user);
                }
                await loadOwnedBadges();
                await loadActivityLogs();
            } catch (err) {
                console.error('é€é‡‘ã‚¨ãƒ©ãƒ¼:', err);
                alert('é€é‡‘å¤±æ•—: ' + (err.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
            } finally {
                toggleLoading(false);
            }
        }

        /**
         * å¼•æ›åˆ¸ã®è­²æ¸¡å®Ÿè¡Œ
         */
        async function executeTicketTransfer(toUserId, toUserName) {
            const amountStr = prompt(`ã€Œ${currentTicketRarity}å¼•æ›åˆ¸ã€ã‚’ä½•æšè­²æ¸¡ã—ã¾ã™ã‹ï¼Ÿ (æœ€å¤§: ${currentTicketMax}æš)`, "1");
            if (amountStr === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            const amount = parseInt(amountStr);
            if (isNaN(amount) || amount <= 0) return alert('æœ‰åŠ¹ãªæšæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            if (amount > currentTicketMax) return alert('æ‰€æŒæ•°ä»¥ä¸Šã®æšæ•°ã¯è­²æ¸¡ã§ãã¾ã›ã‚“');

            toggleLoading(true);
            try {
                const { data, error } = await supabaseClient.rpc('transfer_exchange_tickets', {
                    p_from_id: targetId,
                    p_to_id: toUserId,
                    p_rarity: currentTicketRarity,
                    p_amount: amount
                });

                if (error) throw error;
                if (!data.ok) throw new Error(data.error);

                alert(`${toUserName} ã•ã‚“ã« ${currentTicketRarity}å¼•æ›åˆ¸ ã‚’ ${amount}æš è­²æ¸¡ã—ã¾ã—ãŸï¼`);

                // æ´»å‹•ãƒ­ã‚°è¨˜éŒ²
                if (typeof logActivity === 'function') {
                    const sender = allProfiles.find(p => p.discord_user_id === targetId);
                    const senderName = sender?.account_name || 'èª°ã‹';

                    await logActivity(targetId, 'badge_transfer', {
                        amount: 0,
                        targetUserId: toUserId,
                        details: { target_name: toUserName, badge_name: `${currentTicketRarity}å¼•æ›åˆ¸ x${amount}` }
                    });
                    await logActivity(toUserId, 'badge_receive', {
                        amount: 0,
                        targetUserId: targetId,
                        details: { sender_name: senderName, badge_name: `${currentTicketRarity}å¼•æ›åˆ¸ x${amount}` }
                    });
                }

                // UIæ›´æ–°
                await openPossessionsModal();
                await loadActivityLogs();
            } catch (err) {
                console.error('å¼•æ›åˆ¸è­²æ¸¡ã‚¨ãƒ©ãƒ¼:', err);
                alert('è­²æ¸¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
            } finally {
                toggleLoading(false);
            }
        }

        /**
         * ç¥ˆé¡˜ç¬¦ã®è­²æ¸¡å®Ÿè¡Œ
         */
        async function executeGachaTicketTransfer(toUserId, toUserName) {
            const amountStr = prompt(`ã€Œç¥ˆé¡˜ç¬¦ã€ã‚’ä½•æšè­²æ¸¡ã—ã¾ã™ã‹ï¼Ÿ (æœ€å¤§: ${currentTicketMax}æš)`, "1");
            if (amountStr === null) return;
            const amount = parseInt(amountStr);
            if (isNaN(amount) || amount <= 0) return alert('æœ‰åŠ¹ãªæšæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            if (amount > currentTicketMax) return alert('æ‰€æŒæ•°ä»¥ä¸Šã®æšæ•°ã¯è­²æ¸¡ã§ãã¾ã›ã‚“');

            toggleLoading(true);
            try {
                const { data, error } = await supabaseClient.rpc('transfer_gacha_tickets', {
                    p_from_id: targetId,
                    p_to_id: toUserId,
                    p_amount: amount
                });

                if (error) throw error;
                if (!data.ok) throw new Error(data.error);

                alert(`${toUserName} ã•ã‚“ã« ç¥ˆé¡˜ç¬¦ ã‚’ ${amount}æš è­²æ¸¡ã—ã¾ã—ãŸï¼`);

                // æ´»å‹•ãƒ­ã‚°è¨˜éŒ²
                if (typeof logActivity === 'function') {
                    const sender = allProfiles.find(p => p.discord_user_id === targetId);
                    const senderName = sender?.account_name || 'èª°ã‹';

                    await logActivity(targetId, 'badge_transfer', {
                        amount: 0,
                        targetUserId: toUserId,
                        details: { target_name: toUserName, badge_name: `ç¥ˆé¡˜ç¬¦ x${amount}` }
                    });
                    await logActivity(toUserId, 'badge_receive', {
                        amount: 0,
                        targetUserId: targetId,
                        details: { sender_name: senderName, badge_name: `ç¥ˆé¡˜ç¬¦ x${amount}` }
                    });
                }

                // UIæ›´æ–°
                await openPossessionsModal();
                await loadActivityLogs();
                // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ç¥ˆé¡˜ç¬¦æšæ•°ã‚‚æ›´æ–°
                const countEl = document.getElementById('user-tickets-value');
                if (countEl) {
                    const current = parseInt(countEl.textContent.replace(/,/g, '')) || 0;
                    countEl.textContent = (current - amount).toLocaleString();
                }
            } catch (err) {
                console.error('ç¥ˆé¡˜ç¬¦è­²æ¸¡ã‚¨ãƒ©ãƒ¼:', err);
                alert('è­²æ¸¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
            } finally {
                toggleLoading(false);
            }
        }
        function openCoinTransferModal() { openUserSelectModal('coin_transfer'); }

        /**
         * æ‰€æŒå“ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
         */
        async function openPossessionsModal() {
            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('gacha_tickets, exchange_tickets')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            if (error) {
                console.error('æ‰€æŒå“å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return;
            }

            const gachaTickets = profile?.gacha_tickets || 0;
            document.getElementById('modal-tickets-count').textContent = gachaTickets.toLocaleString();

            const ticketsParent = document.getElementById('modal-tickets-count').parentElement.parentElement;
            if (!isViewMode && gachaTickets > 0 && !document.getElementById('gacha-ticket-transfer-btn')) {
                const transferBtn = document.createElement('button');
                transferBtn.id = 'gacha-ticket-transfer-btn';
                transferBtn.className = 'btn btn-sm btn-outline-warning rounded-pill py-0 px-2 ms-2';
                transferBtn.style.fontSize = '0.65rem';
                transferBtn.textContent = 'ğŸ è­²æ¸¡';
                transferBtn.onclick = () => {
                    currentTicketMax = gachaTickets;
                    const modalEl = document.getElementById('possessionsModal');
                    bootstrap.Modal.getInstance(modalEl)?.hide();
                    openUserSelectModal('gacha_ticket_transfer');
                };
                document.getElementById('modal-tickets-count').parentElement.appendChild(transferBtn);
            } else if (gachaTickets <= 0 && document.getElementById('gacha-ticket-transfer-btn')) {
                document.getElementById('gacha-ticket-transfer-btn').remove();
            }

            const listEl = document.getElementById('exchange-tickets-list');
            const exchanges = profile?.exchange_tickets || {};

            if (Object.keys(exchanges).length === 0) {
                listEl.innerHTML = '<div class="col-12 text-center text-muted py-3">æ‰€æŒã—ã¦ã„ã‚‹å¼•æ›åˆ¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
            } else {
                listEl.innerHTML = Object.entries(exchanges).map(([rarity, count]) => {
                    if (count <= 0) return '';
                    const rarityClass = getRarityClass(rarity);
                    return `
                        <div class="col-6 mb-3">
                            <div class="card shadow-sm border-0 ${rarityClass} p-2 text-center position-relative" style="border-radius: 12px; border: 1px solid rgba(0,0,0,0.1) !important;">
                                <div class="small fw-bold opacity-75 mb-1">${rarity}å¼•æ›åˆ¸</div>
                                <div class="d-flex align-items-center justify-content-center gap-2 mb-2">
                                    <span style="font-size: 1.2rem;">ğŸ«</span>
                                    <div class="fs-5 fw-bold">${count}æš</div>
                                </div>
                                ${!isViewMode ? `
                                    <button class="btn btn-sm btn-outline-dark rounded-pill py-0 px-2" style="font-size: 0.65rem;" 
                                        onclick="initTicketTransfer('${rarity}', ${count})">
                                        ğŸ è­²æ¸¡
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            const modal = new bootstrap.Modal(document.getElementById('possessionsModal'));
            modal.show();
        }

        let currentTicketRarity = '';
        let currentTicketMax = 0;
        function initTicketTransfer(rarity, count) {
            currentTicketRarity = rarity;
            currentTicketMax = count;
            // æ‰€æŒå“ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            const modalEl = document.getElementById('possessionsModal');
            bootstrap.Modal.getInstance(modalEl)?.hide();
            openUserSelectModal('ticket_transfer');
        }
    </script>

    <!-- ãƒãƒ¼ãƒ é€šçŸ¥ãƒãƒƒã‚¸ -->
    <script>
        async function checkTeamNotifications() {
            const user = await getCurrentUser();
            if (!user) return;
            const discordId = user.user_metadata.provider_id;
            const { data: myTeams } = await supabaseClient.from('teams').select('id').eq('creator_discord_id', discordId);
            if (!myTeams || myTeams.length === 0) return;

            const teamIds = myTeams.map(t => t.id);
            const { data: pendingRequests } = await supabaseClient.from('team_join_requests').select('id').in('team_id', teamIds).in('status', ['pending', 'leave_pending']);
            const count = pendingRequests?.length || 0;

            if (count > 0) {
                const badge = document.getElementById('team-notification-badge');
                if (badge) {
                    badge.textContent = count;
                    badge.style.display = 'inline';
                }
            }
        }
        document.addEventListener('DOMContentLoaded', checkTeamNotifications);
    </script>
</body>

</html>
