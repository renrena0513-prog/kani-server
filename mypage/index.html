<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ã‹ã«ã‚µãƒ¼ãƒãƒ¼ - ãƒã‚¤ãƒšãƒ¼ã‚¸">
    <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ | ã‹ã«ã‚µãƒ¼ãƒãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;600;700&family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap"
        rel="stylesheet">

    <!-- Bootswatch Lux (Bootstrap 5.3.3) -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-purple: #6b5b95;
            --deep-purple: #4a3f6b;
            --cream: #faf5e8;
            --gold: #d4a853;
            --btn-gold: #c29544;
            --font-title: 'Noto Serif JP', serif;
            --font-body: 'M PLUS Rounded 1c', sans-serif;
        }

        .btn-gold {
            background-color: var(--gold);
            border: none;
        }

        .btn-gold:hover {
            background-color: var(--btn-gold);
            color: white;
        }


        body {
            font-family: var(--font-body);
            background: linear-gradient(180deg, #6b5b95 0%, #5a4d80 50%, #4a3f6b 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }

        .page-header {
            font-family: var(--font-title);
            color: var(--cream);
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
        }

        .back-button {
            font-family: var(--font-body);
            font-size: 1rem;
            padding: 10px 25px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #fff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .profile-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--gold);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .discord-badge {
            background: linear-gradient(135deg, #43b581, #3ca374);
            color: white;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(67, 181, 129, 0.4);
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid var(--gold);
        }

        .activity-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .activity-item-card {
            background: #fdfdfd;
            /* ã‚«ãƒ¼ãƒ‰ã®ä¸­ã«ã‚«ãƒ¼ãƒ‰ã§ã‚ã‚‹ã“ã¨ã‚’å¼·èª¿ã™ã‚‹ãŸã‚ã®å¾®èª¿æ•´ */
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            border: 1px solid #eff0f1;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            display: block;
        }

        .activity-item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            border-color: var(--gold);
        }

        .activity-date {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 10px;
            display: block;
            border-bottom: 1px solid #f5f5f5;
            padding-bottom: 5px;
        }

        .activity-type-badge {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 50px;
            background: #f0f2f5;
            color: #4b515d;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .activity-details {
            font-size: 0.95rem;
            color: #2c3e50;
            font-weight: 500;
        }

        .activity-amount {
            font-family: 'Inter', 'Kosugi Maru', sans-serif;
            font-weight: 800;
            font-size: 1.15rem;
            letter-spacing: -0.02em;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--deep-purple);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .login-prompt {
            text-align: center;
            padding: 60px 20px;
        }

        .login-prompt-btn {
            background: linear-gradient(135deg, #5865F2, #4752c4);
            color: white;
            padding: 15px 40px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .login-prompt-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(88, 101, 242, 0.4);
        }

        .logout-btn {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 2px solid #dc3545;
            padding: 10px 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc3545;
            color: white;
        }

        /* ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ›æ¬„ */
        .nickname-input {
            background: #fff;
            border: 2px solid #e0d8f0;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 1rem;
            transition: all 0.3s ease;
            color: #333;
        }

        .nickname-input::placeholder {
            color: #aaa;
            font-style: italic;
        }

        .nickname-input:focus {
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 4px rgba(107, 91, 149, 0.15);
            outline: none;
            background: #fff;
        }

        /* ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°ãƒœã‚¿ãƒ³ */
        .btn-avatar-update {
            background: linear-gradient(135deg, #5865F2 0%, #4752c4 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(88, 101, 242, 0.3);
        }

        .btn-avatar-update:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(88, 101, 242, 0.5);
            background: linear-gradient(135deg, #6872f4 0%, #5865F2 100%);
        }

        /* çµ±è¨ˆãƒŸãƒ‹ã‚«ãƒ¼ãƒ‰ */
        .stat-card-mini {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }

        .stat-card-mini:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-label-mini {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-value-mini {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--deep-purple);
        }

        .stat-rank {
            font-size: 0.7rem;
            color: #fff;
            background: linear-gradient(135deg, var(--gold), #b8860b);
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 5px;
            display: inline-block;
        }

        .stat-rank.no-data {
            background: #adb5bd;
        }

        /* ãƒãƒƒã‚¸ä¸€è¦§ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .badge-item {
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
            border-radius: 12px;
            padding: 8px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .badge-item:hover {
            transform: scale(1.05);
            background: #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .badge-item.equipped {
            border-color: var(--gold);
            background: #fff9e6;
            box-shadow: 0 0 0 2px rgba(212, 165, 116, 0.3);
        }

        .badge-item img {
            width: 70px;
            height: 70px;
            object-fit: contain;
            display: block;
        }

        .badge-count-overlay {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            border: 2px solid white;
            z-index: 10;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s;
        }

        .loading-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒªã‚¹ãƒˆ */
        .user-select-item {
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
        }

        .user-select-item:hover {
            background-color: #f8f9fa;
        }

        .user-select-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 2px solid var(--gold);
        }

        .user-select-badge {
            width: 24px;
            height: 24px;
            object-fit: contain;
            margin-left: 8px;
        }

        .user-select-name {
            font-weight: 700;
            color: var(--deep-purple);
            font-size: 1rem;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
        .nav-dropdown {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .record-button {
            background: linear-gradient(135deg, var(--gold) 0%, #b8892d 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 6px 20px rgba(212, 168, 83, 0.5);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            cursor: pointer;
        }

        .record-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 168, 83, 0.6);
            color: white;
        }

        .nav-dropdown-menu {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            min-width: 200px;
            overflow: hidden;
        }

        .nav-dropdown-menu .dropdown-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            transition: background 0.2s;
        }

        .nav-dropdown-menu .dropdown-item:hover {
            background: #f5f5f5;
        }

        .nav-dropdown-menu .dropdown-divider {
            margin: 0;
        }

        .notification-badge {
            background: #dc3545;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
        }
    </style>
</head>

<body>
    <!-- å³ä¸Šã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
    <div class="nav-dropdown dropdown">
        <button class="record-button dropdown-toggle" type="button" id="navDropdown" data-bs-toggle="dropdown"
            aria-expanded="false">
            ğŸ“ ãƒ¡ãƒ‹ãƒ¥ãƒ¼
        </button>
        <ul class="dropdown-menu nav-dropdown-menu dropdown-menu-end" aria-labelledby="navDropdown">
            <li><a class="dropdown-item" href="../index.html">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a></li>
            <li><a class="dropdown-item" href="./index.html">ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</a></li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="../mahjong/index.html">ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a></li>
            <li><a class="dropdown-item" href="../mahjong/record.html">ğŸ“ è¨˜éŒ²ã™ã‚‹</a></li>
            <li><a class="dropdown-item" href="../mahjong/users/index.html">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a></li>
            <li><a class="dropdown-item" href="../mahjong/team/index.html">ğŸ… ãƒãƒ¼ãƒ ç®¡ç† <span id="team-notification-badge"
                        class="notification-badge" style="display:none;">0</span></a></li>
            <li><a class="dropdown-item" href="../badge/list.html">ğŸ“› ãƒãƒƒã‚¸ä¸€è¦§</a></li>
            <li><a class="dropdown-item" href="../badge/shop.html">ğŸ›’ ãƒãƒƒã‚¸ã‚·ãƒ§ãƒƒãƒ—</a></li>
            <li><a class="dropdown-item" href="../ranking/index.html">ğŸ’° è³‡ç”£ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a></li>
            <li class="admin-only" style="display:none;"><a class="dropdown-item" href="../omikuji/index.html">ğŸ‹
                    ãŠã¿ãã˜</a></li>
            <li class="admin-only" style="display:none;">
                <hr class="dropdown-divider">
            </li>
            <li class="admin-only" style="display:none;">
                <a class="dropdown-item" href="../admin/index.html">âš™ï¸ ç®¡ç†ç”»é¢</a>
            </li>
        </ul>
    </div>

    <div class="container py-5">
        <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
        <div class="mb-4">
            <a href="#" onclick="goBack(); return false;" class="back-button">
                â† æˆ»ã‚‹
            </a>
        </div>


        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="text-center mb-5">
            <h1 class="page-header display-4 fw-bold mb-3">ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
        </header>

        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">

                <!-- æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ -->
                <div id="login-prompt" class="profile-card login-prompt" style="display: none;">
                    <h3 class="mb-4" style="font-family: var(--font-title); color: var(--deep-purple);">
                        ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„
                    </h3>
                    <p class="text-muted mb-4">
                        ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯Discordã§ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚
                    </p>
                    <button onclick="loginWithDiscord()" class="login-prompt-btn">
                        <img src="https://assets-global.website-files.com/6257adef93867e50d84d30e2/636e0a69f118df70ad7828d4_icon_clyde_blurple_RGB.svg"
                            alt="Discord" style="width: 24px;">
                        Discordã§ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                </div>

                <!-- ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ï¼ˆã¾ãŸã¯é–²è¦§ãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
                <div id="profile-content" style="display: none;">
                    <div class="profile-card mb-4">
                        <!-- ä¸Šæ®µ: ãƒãƒƒã‚¸ + åå‰ + ç·¨é›†ãƒœã‚¿ãƒ³ -->
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center gap-2 flex-grow-1" style="min-width: 0;">
                                <img id="user-equipped-badge" src="" alt=""
                                    style="width: 36px; height: 36px; border-radius: 8px; display: none;">
                                <h2 id="user-name" class="mb-0 text-truncate"
                                    style="font-family: var(--font-title); color: var(--deep-purple); font-size: 1.4rem;">
                                    ãƒ¦ãƒ¼ã‚¶ãƒ¼å
                                </h2>
                            </div>
                            <button id="nickname-edit-btn" onclick="openNicknameModal()"
                                class="btn btn-sm btn-outline-secondary flex-shrink-0" title="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å¤‰æ›´"
                                style="display: none; padding: 4px 10px;">
                                âœï¸
                            </button>
                        </div>

                        <!-- ä¸‹æ®µ: ã‚¢ãƒã‚¿ãƒ¼ + æƒ…å ± -->
                        <div class="row align-items-start">
                            <div class="col-auto">
                                <div class="text-center">
                                    <img id="user-avatar" src="" alt="ã‚¢ãƒã‚¿ãƒ¼" class="avatar-large">
                                    <button id="sync-btn" onclick="updateAvatar()"
                                        class="btn btn-sm btn-outline-secondary mt-2" title="Discordã‹ã‚‰æœ€æ–°ã®ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’å–å¾—"
                                        style="font-size: 0.7rem; padding: 3px 8px;">
                                        ğŸ”„ åŒæœŸ
                                    </button>
                                </div>
                            </div>
                            <div class="col">
                                <h2 id="page-title-label" class="small text-muted mb-1" style="display:none;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h2>

                                <!-- ãƒãƒ¼ãƒ å -->
                                <div id="user-team-display" class="mb-2">
                                    <span class="badge bg-secondary" style="font-size: 0.85rem;">
                                        ğŸ  <span id="user-team-name">æœªæ‰€å±</span>
                                    </span>
                                </div>

                                <!-- æ‰€æŒé‡‘ -->
                                <div id="user-coins-display" class="mb-2"
                                    style="display: none; flex-wrap: wrap; gap: 8px; align-items: center;">
                                    <span class="badge bg-light text-dark shadow-sm"
                                        style="font-size: 0.85rem; border: 1px solid var(--gold); padding: 6px 12px;">
                                        æ‰€æŒé‡‘: ğŸª™ <span id="user-coins-value">0</span>
                                    </span>
                                    <span class="badge bg-light text-dark shadow-sm"
                                        style="font-size: 0.85rem; border: 1px solid #17a2b8; padding: 6px 12px;">
                                        ç·è³‡ç”£: ğŸ“Š <span id="total-assets-value">0</span>
                                    </span>
                                    <button id="coin-transfer-btn" onclick="openCoinTransferModal()"
                                        class="btn btn-sm btn-outline-primary"
                                        style="display: none; padding: 2px 8px; font-size: 0.75rem;">
                                        ğŸ’¸ é€é‡‘
                                    </button>
                                </div>

                                <!-- ä»–äººã®å ´åˆã®ã¿è¡¨ç¤ºã™ã‚‹è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                                <div id="view-area" class="mt-2" style="display:none;">
                                    <div class="discord-badge">
                                        ğŸ€„ éº»é›€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- éº»é›€çµ±è¨ˆ -->
                    <div class="profile-card mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0;">
                                ğŸ€„ éº»é›€çµ±è¨ˆ
                            </h4>
                            <div id="tournament-filter-container">
                                <select id="tournament-select" class="form-select form-select-sm"
                                    style="width: auto; min-width: 150px;" onchange="handleTournamentChange()">
                                    <!-- JSã§ç”Ÿæˆ -->
                                </select>
                            </div>
                        </div>

                        <div id="stats-loading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                            </div>
                        </div>

                        <div id="stats-content" style="display: none;">
                            <div id="stats-grid">
                                <!-- ã‚¹ã‚³ã‚¢ç³» -->
                                <div class="row g-3 mb-3">
                                    <div class="col-6 col-md-4">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">ç·åˆã‚¹ã‚³ã‚¢</div>
                                            <div class="stat-value-mini" id="stat-total">-</div>
                                            <div class="stat-rank" id="rank-total">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">ä¸‰éº»ã‚¹ã‚³ã‚¢</div>
                                            <div class="stat-value-mini" id="stat-sanma">-</div>
                                            <div class="stat-rank" id="rank-sanma">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">å››éº»ã‚¹ã‚³ã‚¢</div>
                                            <div class="stat-value-mini" id="stat-yonma">-</div>
                                            <div class="stat-rank" id="rank-yonma">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- å¹³å‡ãƒ»æœ€å¤§ã‚¹ã‚³ã‚¢ -->
                                <div class="row g-3 mb-3">
                                    <div class="col-6">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">å¹³å‡ã‚¹ã‚³ã‚¢</div>
                                            <div class="stat-value-mini" id="stat-avg-score">-</div>
                                            <div class="stat-rank" id="rank-avg-score">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">æœ€å¤§ã‚¹ã‚³ã‚¢</div>
                                            <div class="stat-value-mini" id="stat-max-score">-</div>
                                            <div class="stat-rank" id="rank-max-score">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ç‡ç³» -->
                                <div class="row g-3 mb-3">
                                    <div class="col-6 col-md-3">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">å’Œäº†ç‡</div>
                                            <div class="stat-value-mini" id="stat-win-rate">-</div>
                                            <div class="stat-rank" id="rank-win-rate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">æ”¾éŠƒç‡</div>
                                            <div class="stat-value-mini" id="stat-deal-rate">-</div>
                                            <div class="stat-rank" id="rank-deal-rate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">ãƒˆãƒƒãƒ—ç‡</div>
                                            <div class="stat-value-mini" id="stat-top-rate">-</div>
                                            <div class="stat-rank" id="rank-top-rate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">ãƒ©ã‚¹å›é¿</div>
                                            <div class="stat-value-mini" id="stat-avoid-rate">-</div>
                                            <div class="stat-rank" id="rank-avoid-rate">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- é †ä½ç³» -->
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">å¹³å‡é †ä½</div>
                                            <div class="stat-value-mini" id="stat-avg-rank">-</div>
                                            <div class="stat-rank" id="rank-avg-rank">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">å¯¾å±€æ•°</div>
                                            <div class="stat-value-mini" id="stat-games">-</div>
                                            <div class="stat-rank" id="rank-games">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="no-stats-msg" class="text-center text-muted py-3" style="display: none;">
                                ã¾ã éº»é›€å¤§ä¼šã«å‚åŠ ã—ã¦ã„ã¾ã›ã‚“
                            </div>
                        </div>
                    </div>

                    <!-- ãƒãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="profile-card mb-4" id="badge-collection-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0;">
                                ğŸ“› ãƒãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
                            </h4>
                            <div class="d-flex gap-2">
                                <button id="badge-transfer-btn" onclick="openBadgeSelectionModal('transfer')"
                                    class="btn btn-sm btn-outline-primary" style="display: none;">
                                    è­²æ¸¡
                                </button>
                                <button id="badge-sell-btn" onclick="openBadgeSelectionModal('sell')"
                                    class="btn btn-sm btn-outline-danger" style="display: none;">
                                    å£²å´
                                </button>
                                <button id="badge-change-btn" onclick="openBadgeChangeModal()"
                                    class="btn btn-sm btn-outline-secondary" style="display: none;">
                                    è£…ç€
                                </button>
                            </div>
                        </div>

                        <!-- éå£²å“ãƒãƒƒã‚¸ -->
                        <div id="special-badges-section" style="display: none;">
                            <h6 class="text-muted mb-2" style="font-size: 0.85rem;">ğŸ† é™å®šãƒãƒƒã‚¸</h6>
                            <div id="special-badge-list" class="row g-3 mb-4">
                                <!-- JSã§ç”Ÿæˆ -->
                            </div>
                        </div>

                        <!-- è³¼å…¥ãƒãƒƒã‚¸ -->
                        <div id="purchasable-badges-section" style="display: none;">
                            <h6 class="text-muted mb-2" style="font-size: 0.85rem;">ğŸ›’ è³¼å…¥ãƒãƒƒã‚¸</h6>
                            <div id="purchasable-badge-list" class="row g-3">
                                <!-- JSã§ç”Ÿæˆ -->
                            </div>
                        </div>

                        <div id="no-badges-msg" class="text-center text-muted py-3" style="display: none;">
                            ã¾ã ãƒãƒƒã‚¸ã‚’æŒã£ã¦ã„ã¾ã›ã‚“
                        </div>
                    </div>

                    <!-- è²©å£²å®Ÿç¸¾ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="profile-card mb-4" id="revenue-section" style="display: none;">
                        <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0 0 15px 0;">
                            ğŸ’° è²©å£²å®Ÿç¸¾
                        </h4>
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="stat-card-mini">
                                    <div class="stat-label-mini">ç´¯è¨ˆåç›Š</div>
                                    <div class="stat-value-mini" id="total-revenue" style="color: #27ae60;">0</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card-mini">
                                    <div class="stat-label-mini">è²©å£²å›æ•°</div>
                                    <div class="stat-value-mini" id="revenue-count">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æœ€è¿‘ã®æ´»å‹•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="profile-card mb-4" id="activity-section" style="display: none;">
                        <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0 0 15px 0;">
                            ğŸ“‹ æœ€è¿‘ã®æ´»å‹•
                        </h4>
                        <div id="activity-list">
                            <div class="text-center text-muted py-3">èª­ã¿è¾¼ã¿ä¸­...</div>
                        </div>
                        <div id="activity-pagination" class="d-flex justify-content-center gap-2 mt-3"
                            style="display: none;"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ãƒãƒƒã‚¸å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="badgeChangeModal" tabindex="-1" aria-labelledby="badgeChangeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="badgeChangeModalLabel">è£…ç€ãƒãƒƒã‚¸ã‚’å¤‰æ›´</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="badge-modal-list" class="row g-2">
                        <!-- JSã§ç”Ÿæˆ -->
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-outline-danger btn-sm" onclick="equipBadge(null)">ãƒãƒƒã‚¸ã‚’å¤–ã™</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="nicknameModal" tabindex="-1" aria-labelledby="nicknameModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nicknameModalLabel">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å¤‰æ›´</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label small text-muted">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç­‰ã§è¡¨ç¤ºã•ã‚Œã‚‹åå‰</label>
                    <input type="text" id="user-nickname" class="form-control mb-3" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›...">
                    <div class="d-grid gap-2">
                        <button onclick="useDiscordName()" class="btn btn-outline-secondary btn-sm">
                            Discordåã‚’ä½¿ç”¨
                        </button>
                        <button onclick="saveNickname()" class="btn btn-gold text-white fw-bold">
                            ä¿å­˜
                        </button>
                    </div>
                    <div id="save-msg" class="small mt-2 text-center" style="display:none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase -->
    <!-- ãƒãƒƒã‚¸è­²æ¸¡ãƒ»å£²å´ç”¨ãƒãƒƒã‚¸é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="badgeActionModal" tabindex="-1" aria-labelledby="badgeActionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="badgeActionModalLabel">ãƒãƒƒã‚¸ã‚’é¸æŠ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="action-badge-list" class="row g-2">
                        <!-- JSã§ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« (è­²æ¸¡ãƒ»é€é‡‘ç”¨) -->
    <div class="modal fade" id="userSelectModal" tabindex="-1" aria-labelledby="userSelectModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userSelectModalLabel">è­²æ¸¡å…ˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="transfer-user-list" class="list-group list-group-flush">
                        <!-- JSã§ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚³ã‚¤ãƒ³é€é‡‘é‡‘é¡å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="coinAmountModal" tabindex="-1" aria-labelledby="coinAmountModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="coinAmountModalLabel">é€é‡‘é‡‘é¡ã‚’å…¥åŠ›</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="coin-transfer-target-name" class="fw-bold text-center mb-3"></p>
                    <div class="mb-3">
                        <label class="form-label">é€é‡‘ã™ã‚‹ã‚³ã‚¤ãƒ³æ•°</label>
                        <input type="number" id="coin-transfer-amount" class="form-control" placeholder="é‡‘é¡..." min="1">
                        <div class="form-text mt-2 text-center">ã‚ãªãŸã®æ‰€æŒé‡‘: ğŸª™ <span id="my-coins-ref">0</span></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-primary" onclick="executeCoinTransfer()">é€é‡‘ã™ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabaseè¨­å®š -->
    <script src="../js/supabase-config.js"></script>
    <script src="../js/auth-guard.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            initAccordionNav('../');
        });
    </script>

    <script>
        let isViewMode = false;
        let targetId = null;
        let allProfiles = []; // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ

        /**
         * ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
         */
        async function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('user');

            // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆåå‰è§£æ±ºç”¨ï¼‰
            const { data: profiles, error: profileError } = await supabaseClient
                .from('profiles')
                .select('discord_user_id, account_name, avatar_url');
            if (profiles) allProfiles = profiles;

            const user = await getCurrentUser();
            const myId = user?.user_metadata?.provider_id;

            // ãªã‚Šã™ã¾ã—ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
            const impersonated = getImpersonatedUser();
            const effectiveId = impersonated ? impersonated.discord_user_id : myId;

            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
            if (urlUserId) {
                targetId = urlUserId;
                // è‡ªåˆ†ã§ã‚‚ãªã‚Šã™ã¾ã—å¯¾è±¡ã§ã‚‚ãªã„å ´åˆã¯é–²è¦§ãƒ¢ãƒ¼ãƒ‰
                if (urlUserId !== myId && urlUserId !== (impersonated?.discord_user_id)) {
                    isViewMode = true;
                } else {
                    isViewMode = false;
                }
            } else {
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆãªã‚Šã™ã¾ã—å„ªå…ˆï¼‰
                targetId = effectiveId;
                isViewMode = false;
            }

            // UIã®åŸºæœ¬è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            setupUI();

            // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
            if (isViewMode) {
                await loadTargetUserInfo();
            } else {
                if (user) {
                    await displayMyInfo(user);
                } else {
                    showLoginPrompt();
                    return;
                }
            }

            // éº»é›€çµ±è¨ˆã®èª­ã¿è¾¼ã¿ï¼ˆå…±æœ‰ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
            await loadMahjongStats();

            // ãƒãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿
            await loadOwnedBadges();

            // è²©å£²å®Ÿç¸¾ã®èª­ã¿è¾¼ã¿
            await loadRevenueStats();

            // æœ€è¿‘ã®æ´»å‹•ã®èª­ã¿è¾¼ã¿
            await loadActivityLogs();
        }

        function setupUI() {
            const loginPrompt = document.getElementById('login-prompt');
            const profileContent = document.getElementById('profile-content');
            const viewArea = document.getElementById('view-area');
            const syncBtn = document.getElementById('sync-btn');
            const pageTitleLabel = document.getElementById('page-title-label');
            const pageHeader = document.querySelector('.page-header');
            const nicknameEditBtn = document.getElementById('nickname-edit-btn');

            if (profileContent) profileContent.style.display = 'block';
            if (loginPrompt) loginPrompt.style.display = 'none';

            if (isViewMode) {
                // é–²è¦§ãƒ¢ãƒ¼ãƒ‰è¨­å®š
                if (viewArea) viewArea.style.display = 'block';
                if (syncBtn) syncBtn.style.display = 'none';
                if (pageTitleLabel) pageTitleLabel.style.display = 'block';
                if (pageHeader) pageHeader.textContent = 'ğŸ‘¤ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«';
                if (nicknameEditBtn) nicknameEditBtn.style.display = 'none';
            } else {
                // ãƒã‚¤ãƒšãƒ¼ã‚¸è¨­å®š
                if (viewArea) viewArea.style.display = 'none';
                if (syncBtn) syncBtn.style.display = 'inline-block';
                if (pageTitleLabel) pageTitleLabel.style.display = 'none';
                if (pageHeader) pageHeader.textContent = 'ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸';
                if (nicknameEditBtn) nicknameEditBtn.style.display = 'inline-block';
                const coinTransferBtn = document.getElementById('coin-transfer-btn');
                if (coinTransferBtn) coinTransferBtn.style.display = 'inline-block';
            }
        }

        function showLoginPrompt() {
            document.getElementById('login-prompt').style.display = 'block';
            document.getElementById('profile-content').style.display = 'none';
        }

        /**
         * è‡ªåˆ†ï¼ˆã¾ãŸã¯ãªã‚Šã™ã¾ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã®æƒ…å ±ã‚’è¡¨ç¤º
         */
        async function displayMyInfo(user) {
            const discordUser = user.user_metadata;
            const impersonated = getImpersonatedUser();

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ï¼ˆãƒãƒƒã‚¸æƒ…å ±ãƒ»ã‚³ã‚¤ãƒ³ãƒ»ãƒãƒ¼ãƒ æƒ…å ±ã‚’å«ã‚€ï¼‰
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('account_name, avatar_url, coins, equipped_badge_id, team_id, badges!equipped_badge_id(image_url, name), teams!team_id(team_name)')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            // ã‚¢ãƒã‚¿ãƒ¼ï¼ˆãªã‚Šã™ã¾ã—ä¸­ã¯DBã‹ã‚‰ã€ãã†ã§ãªã‘ã‚Œã°Discordï¼‰
            const avatarUrl = impersonated
                ? (profile?.avatar_url || 'https://via.placeholder.com/150')
                : (discordUser.avatar_url || 'https://via.placeholder.com/150');
            document.getElementById('user-avatar').src = avatarUrl;

            // åå‰ï¼ˆãªã‚Šã™ã¾ã—ä¸­ã¯ãªã‚Šã™ã¾ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å„ªå…ˆï¼‰
            const name = impersonated
                ? (impersonated.name || profile?.account_name || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼')
                : (profile?.account_name || discordUser.full_name || discordUser.name || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼');
            const coins = profile?.coins || 0;

            // åå‰ã®ã¿è¡¨ç¤ºï¼ˆãƒãƒƒã‚¸ã¯åˆ¥è¦ç´ ï¼‰
            document.getElementById('user-name').textContent = name;

            // ãƒãƒƒã‚¸ç”»åƒã‚’è¨­å®š
            const badgeImg = document.getElementById('user-equipped-badge');
            const badge = profile?.badges;
            if (badgeImg && badge) {
                badgeImg.src = badge.image_url;
                badgeImg.title = badge.name;
                badgeImg.style.display = 'block';
            }

            // ãƒãƒ¼ãƒ åã‚’è¨­å®š
            const teamNameEl = document.getElementById('user-team-name');
            if (teamNameEl) {
                const team = profile?.teams;
                teamNameEl.textContent = team?.team_name || 'æœªæ‰€å±';
            }

            // ã‚³ã‚¤ãƒ³è¡¨ç¤ºã®æ›´æ–°
            const coinsDisplay = document.getElementById('user-coins-display');
            const coinsValue = document.getElementById('user-coins-value');
            if (coinsDisplay && coinsValue) {
                coinsValue.textContent = coins.toLocaleString();
                coinsDisplay.style.display = 'block';
            }

            // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const nicknameEditBtn = document.getElementById('nickname-edit-btn');
            if (nicknameEditBtn) {
                nicknameEditBtn.style.display = 'inline-block';
            }

            if (profile?.account_name) {
                document.getElementById('user-nickname').value = profile.account_name;
            }
        }

        // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openNicknameModal() {
            const modalEl = document.getElementById('nicknameModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }

        /**
         * ä»–äººã®æƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤º
         */
        async function loadTargetUserInfo() {
            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('*, badges!equipped_badge_id(image_url, name), teams!team_id(team_name)')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            if (profile) {
                document.getElementById('user-avatar').src = profile.avatar_url || 'https://via.placeholder.com/150';

                // åå‰ã‚’è¨­å®š
                document.getElementById('user-name').textContent = profile.account_name || 'åç§°æœªè¨­å®š';

                // ãƒãƒƒã‚¸ç”»åƒã‚’è¨­å®š
                const badgeImg = document.getElementById('user-equipped-badge');
                const badge = profile?.badges;
                if (badgeImg && badge) {
                    badgeImg.src = badge.image_url;
                    badgeImg.title = badge.name;
                    badgeImg.style.display = 'block';
                }

                // ãƒãƒ¼ãƒ åã‚’è¨­å®š
                const teamNameEl = document.getElementById('user-team-name');
                if (teamNameEl) {
                    const team = profile?.teams;
                    teamNameEl.textContent = team?.team_name || 'æœªæ‰€å±';
                }

                // ã‚³ã‚¤ãƒ³è¡¨ç¤ºã®æ›´æ–°
                const coins = profile?.coins || 0;
                const coinsDisplay = document.getElementById('user-coins-display');
                const coinsValue = document.getElementById('user-coins-value');
                if (coinsDisplay && coinsValue) {
                    coinsValue.textContent = coins.toLocaleString();
                    coinsDisplay.style.display = 'block';
                }
            } else {
                document.getElementById('user-name').textContent = 'Unknown Player';
            }
        }

        async function useDiscordName() {
            const user = await getCurrentUser();
            if (!user) return;
            const discordUser = user.user_metadata;
            const discordDisplayName = discordUser.custom_claims?.global_name || discordUser.full_name || discordUser.name;
            document.getElementById('user-nickname').value = discordDisplayName;
        }

        async function updateAvatar() {
            const user = await getCurrentUser();
            if (!user || isViewMode) return;

            const btn = document.getElementById('sync-btn');
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'æ›´æ–°ä¸­...';

            try {
                const discordUser = user.user_metadata;
                const avatarUrl = discordUser.avatar_url || discordUser.picture || '';

                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        avatar_url: avatarUrl,
                        updated_at: new Date().toISOString()
                    })
                    .eq('discord_user_id', targetId);

                if (error) throw error;

                alert('ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
                document.getElementById('user-avatar').src = avatarUrl;
            } catch (err) {
                console.error('Error:', err);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function saveNickname() {
            if (isViewMode) return;

            const newNickname = document.getElementById('user-nickname').value.trim();
            const msg = document.getElementById('save-msg');

            if (!newNickname) {
                msg.textContent = 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                msg.className = 'small mt-1 text-danger flex-grow-1';
                msg.style.display = 'block';
                setTimeout(() => { msg.style.display = 'none'; }, 3000);
                return;
            }

            msg.style.display = 'block';
            msg.textContent = 'ä¿å­˜ä¸­...';
            msg.className = 'small mt-1 text-muted flex-grow-1';

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        account_name: newNickname,
                        updated_at: new Date().toISOString()
                    })
                    .eq('discord_user_id', targetId);

                if (error) throw error;

                msg.textContent = 'ä¿å­˜ã—ã¾ã—ãŸï¼';
                msg.className = 'small mt-2 text-center text-success';

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modalEl = document.getElementById('nicknameModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) {
                    setTimeout(() => {
                        modal.hide();
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãƒãƒƒã‚¸ä»˜ãã®åå‰ã‚’æ›´æ–°
                        loadTargetUserInfo();
                    }, 1000);
                }
            } catch (err) {
                console.error('Error updating nickname:', err);
                msg.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                msg.className = 'small mt-2 text-center text-danger';
            }
        }

        // ============ ãƒãƒƒã‚¸ç®¡ç†æ©Ÿèƒ½ ============
        async function loadOwnedBadges() {
            const section = document.getElementById('badge-collection-section');
            const specialSection = document.getElementById('special-badges-section');
            const specialList = document.getElementById('special-badge-list');
            const purchasableSection = document.getElementById('purchasable-badges-section');
            const purchasableList = document.getElementById('purchasable-badge-list');
            const noBadgesMsg = document.getElementById('no-badges-msg');
            const totalAssetsEl = document.getElementById('total-assets-value');

            if (!section) return;

            // é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã€è£…ç€ãƒãƒƒã‚¸ã ã‘è¡¨ç¤ºã™ã‚‹ã‹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³è‡ªä½“éš ã™ï¼ˆä»Šå›ã¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºï¼‰
            section.style.display = 'block';

            try {
                // æ‰€æŒãƒãƒƒã‚¸ã®å–å¾—
                const { data: owned, error } = await supabaseClient
                    .from('user_badges')
                    .select('badge_id, badges(*)')
                    .eq('user_id', targetId);

                if (error) throw error;

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰€æŒã‚³ã‚¤ãƒ³ã‚’å–å¾—ï¼ˆç·è³‡ç”£è¨ˆç®—ç”¨ï¼‰
                const { data: profileData } = await supabaseClient
                    .from('profiles')
                    .select('coins, equipped_badge_id')
                    .eq('discord_user_id', targetId)
                    .maybeSingle();

                const userCoins = profileData?.coins || 0;
                const equippedId = profileData?.equipped_badge_id;
                let badgeAssets = 0;

                // è‡ªåˆ†ã®ãƒšãƒ¼ã‚¸ãªã‚‰ç®¡ç†ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                const badgeBtn = document.getElementById('badge-change-btn');
                const transferBtn = document.getElementById('badge-transfer-btn');
                const sellBtn = document.getElementById('badge-sell-btn');
                if (!isViewMode) {
                    if (badgeBtn) badgeBtn.style.display = 'inline-block';
                    if (transferBtn) transferBtn.style.display = 'inline-block';
                    if (sellBtn) sellBtn.style.display = 'inline-block';
                }

                if (!owned || owned.length === 0) {
                    if (specialSection) specialSection.style.display = 'none';
                    if (purchasableSection) purchasableSection.style.display = 'none';
                    if (noBadgesMsg) noBadgesMsg.style.display = 'block';
                    if (totalAssetsEl) totalAssetsEl.textContent = userCoins.toLocaleString();
                    return;
                }

                // ãƒãƒƒã‚¸ã‚’é›†è¨ˆï¼ˆé‡è¤‡ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼‰
                const badgeGroups = {};
                owned.forEach(item => {
                    const badge = item.badges;
                    if (!badge) return;

                    if (!badgeGroups[badge.id]) {
                        badgeGroups[badge.id] = {
                            badge: badge,
                            count: 0
                        };
                    }
                    badgeGroups[badge.id].count++;
                    badgeAssets += (badge.price || 0);
                });

                // ç·è³‡ç”£ã®è¡¨ç¤ºæ›´æ–°
                if (totalAssetsEl) {
                    totalAssetsEl.textContent = (userCoins + badgeAssets).toLocaleString();
                }

                // ãƒãƒƒã‚¸ã‚’é…åˆ—ã«å¤‰æ›ã—ã¦ã‚½ãƒ¼ãƒˆ (order -> name)
                const aggregatedBadges = Object.values(badgeGroups).sort((a, b) => {
                    const orderA = a.badge.order ?? 999;
                    const orderB = b.badge.order ?? 999;
                    if (orderA !== orderB) return orderA - orderB;
                    return a.badge.name.localeCompare(b.badge.name);
                });

                // éå£²å“ï¼ˆgacha_weight = 0ï¼‰ã¨è³¼å…¥å¯èƒ½ãƒãƒƒã‚¸ã«åˆ†ã‘ã‚‹
                const specialBadges = aggregatedBadges.filter(item => item.badge.gacha_weight === 0);
                const purchasableBadges = aggregatedBadges.filter(item => item.badge.gacha_weight !== 0);

                // ãƒãƒƒã‚¸HTMLç”Ÿæˆé–¢æ•°
                const renderBadge = (item) => {
                    const badge = item.badge;
                    const isEquipped = badge.id === equippedId;
                    return `
                        <div class="col-4 col-sm-3 col-md-2 text-center mb-3">
                            <div class="position-relative">
                                <a href="../badge/index.html?id=${badge.id}" class="text-decoration-none">
                                    <div class="badge-item ${isEquipped ? 'equipped' : ''}" 
                                         title="${badge.name}${isEquipped ? ' (è£…ç€ä¸­)' : ''}"
                                         style="position: relative;">
                                        <img src="${badge.image_url}" alt="${badge.name}">
                                        ${item.count > 1 ? `<span class="badge-count-overlay">${item.count}</span>` : ''}
                                    </div>
                                </a>
                            </div>
                            <div class="small text-muted text-truncate mt-1" style="font-size: 0.75rem;">${badge.name}</div>
                        </div>
                    `;
                };

                // éå£²å“ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
                if (specialBadges.length > 0) {
                    specialSection.style.display = 'block';
                    specialList.innerHTML = specialBadges.map(renderBadge).join('');
                } else {
                    specialSection.style.display = 'none';
                }

                // è³¼å…¥ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
                if (purchasableBadges.length > 0) {
                    purchasableSection.style.display = 'block';
                    purchasableList.innerHTML = purchasableBadges.map(renderBadge).join('');
                } else {
                    purchasableSection.style.display = 'none';
                }

                // ã©ã¡ã‚‰ã‚‚ãªã„å ´åˆ
                if (specialBadges.length === 0 && purchasableBadges.length === 0) {
                    noBadgesMsg.style.display = 'block';
                } else {
                    noBadgesMsg.style.display = 'none';
                }

            } catch (err) {
                console.error('ãƒãƒƒã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                if (noBadgesMsg) {
                    noBadgesMsg.textContent = 'èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                    noBadgesMsg.className = 'text-center text-danger py-3';
                    noBadgesMsg.style.display = 'block';
                }
            }
        }

        // ============ è²©å£²å®Ÿç¸¾ã®èª­ã¿è¾¼ã¿ ============
        async function loadRevenueStats() {
            const section = document.getElementById('revenue-section');
            if (!section) return;

            try {
                // revenue_shareï¼ˆå£²ä¸Šé‚„å…ƒï¼‰ã®ãƒ­ã‚°ã‚’å–å¾—
                const { data: logs, error } = await supabaseClient
                    .from('activity_logs')
                    .select('amount')
                    .eq('user_id', targetId)
                    .eq('action_type', 'revenue_share');

                if (error) {
                    console.log('Activity logs table may not exist yet:', error);
                    return;
                }

                if (!logs || logs.length === 0) {
                    // è²©å£²å®Ÿç¸¾ãŒãªã„å ´åˆã¯éè¡¨ç¤ºã®ã¾ã¾
                    return;
                }

                section.style.display = 'block';

                const totalRevenue = logs.reduce((sum, log) => sum + (log.amount || 0), 0);
                document.getElementById('total-revenue').textContent = `ğŸª™ ${totalRevenue.toLocaleString()}`;
                document.getElementById('revenue-count').textContent = logs.length;

            } catch (err) {
                console.error('è²©å£²å®Ÿç¸¾å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
            }
        }

        // ============ æœ€è¿‘ã®æ´»å‹•ãƒ­ã‚°ã®èª­ã¿è¾¼ã¿ ============
        let activityPage = 0;
        const ACTIVITY_PER_PAGE = 10;

        async function loadActivityLogs(page = 1) {
            const listEl = document.getElementById('activity-list');
            const paginationEl = document.getElementById('activity-pagination');
            const section = document.getElementById('activity-section');
            if (!listEl) return;

            const pageSize = 10;
            console.log('--- loadActivityLogs start ---', { targetId, page });

            try {
                const targetProfile = allProfiles.find(u => u.discord_user_id === targetId);
                const targetName = targetProfile?.account_name;
                console.log('--- loadActivityLogs Integrated Fetch ---', { targetId, targetName });

                // 1. æœ€æ–°ã®æ´»å‹•ãƒ­ã‚° (é€é‡‘ãƒ»ãŠã¿ãã˜ç­‰)
                const { data: allLogs } = await supabaseClient
                    .from('activity_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(500);

                // 2. æœ€æ–°ã®éº»é›€è¨˜éŒ²
                const { data: allMatches } = await supabaseClient
                    .from('match_results')
                    .select('*')
                    .order('event_datetime', { ascending: false })
                    .limit(500);

                // 3. éå»ã®éº»é›€è¨˜éŒ² (ç¬¬ä¸€å›å¤§ä¼šãªã©)
                const { data: legacyMatches } = await supabaseClient
                    .from('tournament_player_stats_snapshot')
                    .select('*')
                    .limit(500);

                // --- ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° ---
                const logs = (allLogs || []).filter(l =>
                    l.user_id === targetId || l.target_user_id === targetId
                ).filter(l => l.action_type !== 'badge_equip');

                const matches = (allMatches || []).filter(m =>
                    m.discord_user_id === targetId || (targetName && (m.account_name === targetName || m.nickname === targetName || m.player_name === targetName))
                );

                const legacy = (legacyMatches || []).filter(m =>
                    m.discord_user_id === targetId || (targetName && (m.account_name === targetName || m.nickname === targetName || m.player_name === targetName))
                );

                console.log('Fetch Results:', {
                    logs: logs.length,
                    matches: matches.length,
                    legacy: legacy.length,
                    allLogsRaw: allLogs?.length
                });

                // --- ãƒãƒ¼ã‚¸ã¨é‡è¤‡æ’é™¤ ---
                let combined = [];
                const matchIdsInLogs = new Set(logs.filter(l => l.match_id).map(l => String(l.match_id)));

                // æ´»å‹•ãƒ­ã‚°ï¼ˆé€é‡‘ãªã©ï¼‰ã‚’è¿½åŠ 
                logs.forEach(l => {
                    let details = l.details;
                    if (typeof details === 'string') { try { details = JSON.parse(details); } catch (e) { } }
                    combined.push({
                        ...l, details: details, timestamp: new Date(l.created_at), isMatch: l.action_type === 'mahjong'
                    });
                });

                // æœ€æ–°éº»é›€è¨˜éŒ²ã‚’è¿½åŠ 
                matches.forEach(m => {
                    if (!matchIdsInLogs.has(String(m.match_id))) {
                        combined.push({
                            action_type: 'mahjong', amount: null, match_id: m.match_id,
                            timestamp: new Date(m.event_datetime),
                            details: { rank: m.rank, final_score: m.final_score, mode: m.mahjong_mode },
                            isMatch: true
                        });
                    }
                });

                // éå»ã®éº»é›€è¨˜éŒ²ã‚’è¿½åŠ 
                legacy.forEach(m => {
                    combined.push({
                        action_type: 'mahjong', amount: null, match_id: 'legacy-' + Math.random(),
                        timestamp: new Date(m.created_at || m.updated_at || '2024-01-01'),
                        details: {
                            rank: m.rank1_count > 0 ? 1 : (m.rank2_count > 0 ? 2 : (m.rank3_count > 0 ? 3 : 4)),
                            final_score: m.score_total,
                            mode: 'éå»å¤§ä¼š',
                            is_legacy: true
                        },
                        isMatch: true
                    });
                });

                // 4. ã‚½ãƒ¼ãƒˆ (æ—¥æ™‚é™é †)
                combined.sort((a, b) => b.timestamp - a.timestamp);
                console.log('Final combined items:', combined.length);

                if (combined.length === 0) {
                    listEl.innerHTML = '<div class="text-center text-muted py-3">æ´»å‹•ãƒ­ã‚°ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
                    section.style.display = 'block';
                    paginationEl.style.display = 'none';
                    return;
                }

                section.style.display = 'block';

                // 5. ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
                const itemsPerPage = 10;
                const totalPages = Math.ceil(combined.length / itemsPerPage);
                const pageItems = combined.slice((page - 1) * itemsPerPage, page * itemsPerPage);

                const typeNames = {
                    'mahjong': 'ğŸ€„ éº»é›€è¨˜éŒ²',
                    'transfer_send': 'ğŸ’¸ é€é‡‘(é€)',
                    'transfer_receive': 'ğŸ§§ é€é‡‘(å—)',
                    'badge_transfer': 'ğŸ ãƒãƒƒã‚¸è­²æ¸¡',
                    'badge_receive': 'ğŸ“¦ ãƒãƒƒã‚¸å—å–',
                    'badge_sell': 'ğŸ’´ ãƒãƒƒã‚¸å£²å´',
                    'badge_purchase': 'ğŸ›’ ãƒãƒƒã‚¸è³¼å…¥',
                    'omikuji': 'ğŸ‹ ãŠã¿ãã˜',
                    'revenue_share': 'ğŸ’ å£²ä¸Šé‚„å…ƒ'
                };

                listEl.innerHTML = pageItems.map(log => {
                    const date = log.timestamp.toLocaleString('ja-JP', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                    const typeName = typeNames[log.action_type] || log.action_type;
                    const amountStr = log.amount !== null ? `ğŸª™ ${log.amount.toLocaleString()}` : '';

                    // åå‰è§£æ±ºãƒ˜ãƒ«ãƒ‘ãƒ¼
                    const getDisplayName = (uid, fallback) => {
                        if (!uid) return fallback;
                        const p = allProfiles.find(u => u.discord_user_id === String(uid));
                        if (p) return p.account_name || p.discord_user_id;
                        return fallback;
                    };

                    // è©³ç´°æ–‡å­—åˆ—ã®æ§‹ç¯‰
                    let detailsStr = '';
                    if (log.isMatch) {
                        const rank = log.details?.rank || '-';
                        const score = log.details?.final_score || '0';
                        const mode = log.details?.mode || '';
                        detailsStr = `<span class="badge bg-light text-dark">${mode} ${rank}ä½ (${score}pts)</span>`;
                    } else if (log.action_type === 'transfer_send') {
                        const name = log.details?.target_name || getDisplayName(log.target_user_id, 'ä¸æ˜ãªç›¸æ‰‹');
                        detailsStr = `â¡ ${name} ã¸ã®é€é‡‘`;
                    } else if (log.action_type === 'transfer_receive') {
                        const name = log.details?.sender_name || getDisplayName(log.user_id, 'ä¸æ˜ãªé€ã‚Šä¸»');
                        detailsStr = `â¬… ${name} ã‹ã‚‰ã®é€é‡‘`;
                    } else if (log.action_type === 'badge_transfer') {
                        const name = log.details?.target_name || getDisplayName(log.target_user_id, 'ä¸æ˜ãªç›¸æ‰‹');
                        detailsStr = `ğŸ ã€Œ${log.details?.badge_name || 'ãƒãƒƒã‚¸'}ã€ã‚’ ${name} ã¸è­²æ¸¡`;
                    } else if (log.action_type === 'badge_receive') {
                        const name = log.details?.sender_name || getDisplayName(log.user_id, 'ä¸æ˜ãªé€ã‚Šä¸»');
                        detailsStr = `ğŸ“¦ ã€Œ${log.details?.badge_name || 'ãƒãƒƒã‚¸'}ã€ã‚’ ${name} ã‹ã‚‰å—å–`;
                    } else if (log.action_type === 'badge_sell') {
                        detailsStr = `ğŸ’´ ã€Œ${log.details?.badge_name || 'ãƒãƒƒã‚¸'}ã€ã‚’å£²å´`;
                    } else if (log.action_type === 'badge_purchase') {
                        detailsStr = `ğŸ›’ ã€Œ${log.details?.badge_name || 'ãƒãƒƒã‚¸'}ã€ã‚’è³¼å…¥`;
                    } else if (log.action_type === 'omikuji') {
                        detailsStr = `ğŸ‹ é‹å‹¢: ${log.details?.rank || 'ãŠã¿ãã˜'}`;
                    } else if (log.action_type === 'revenue_share') {
                        detailsStr = `ğŸ’ ã€Œ${log.details?.badge_name || 'ãƒãƒƒã‚¸'}ã€ã®å£²ä¸Šé‚„å…ƒ`;
                    } else if (log.action_type === 'admin_edit') {
                        detailsStr = `âš™ï¸ ç®¡ç†è€…ã«ã‚ˆã‚‹${log.amount >= 0 ? 'åŠ ç®—' : 'æ¸›ç®—'}`;
                    }

                    return `
                        <div class="activity-item-card">
                            <span class="activity-date">${date}</span>
                            <div class="row align-items-center g-2">
                                <div class="col">
                                    <div class="d-flex flex-wrap align-items-center gap-2">
                                        <span class="activity-type-badge">${typeName}</span>
                                        <span class="activity-details">${detailsStr}</span>
                                    </div>
                                </div>
                                <div class="col-auto text-end">
                                    <span class="activity-amount ${log.amount > 0 ? 'text-success' : log.amount < 0 ? 'text-danger' : ''}">${amountStr}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // 6. ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³UI
                if (totalPages > 1) {
                    let pagHtml = '';
                    for (let i = 1; i <= totalPages; i++) {
                        pagHtml += `<li class="page-item ${i === page ? 'active' : ''}">
                            <a class="page-link" href="javascript:void(0)" onclick="loadActivityLogs(${i})">${i}</a>
                        </li>`;
                    }
                    paginationEl.innerHTML = pagHtml;
                    paginationEl.style.display = 'flex';
                } else {
                    paginationEl.style.display = 'none';
                }

            } catch (err) {
                console.error('Activity logs error:', err);
                listEl.innerHTML = '<div class="text-center text-danger py-3">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        // ============ ãƒãƒƒã‚¸è­²æ¸¡ãƒ»å£²å´ï¼šãƒãƒƒã‚¸é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« ============
        async function openBadgeSelectionModal(mode) {
            const listEl = document.getElementById('action-badge-list');
            listEl.innerHTML = '<p class="text-center text-muted py-3">èª­ã¿è¾¼ã¿ä¸­...</p>';

            document.getElementById('badgeActionModalLabel').textContent = mode === 'transfer' ? 'è­²æ¸¡ã™ã‚‹ãƒãƒƒã‚¸ã‚’é¸æŠ' : 'å£²å´ã™ã‚‹ãƒãƒƒã‚¸ã‚’é¸æŠ';

            const modalEl = document.getElementById('badgeActionModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();

            try {
                // æ‰€æŒãƒãƒƒã‚¸ã®å–å¾— (éå£²å“ä»¥å¤–)
                const { data: owned, error } = await supabaseClient
                    .from('user_badges')
                    .select('badge_id, badges(*)')
                    .eq('user_id', targetId);

                if (error) throw error;

                // éå£²å“ã‚’é™¤å¤–ã—ã¦ã€åŒã˜ãƒãƒƒã‚¸ã‚’ã¾ã¨ã‚ã‚‹
                const badgeGroups = {};
                owned.forEach(item => {
                    const badge = item.badges;
                    if (!badge || badge.gacha_weight === 0) return;
                    if (!badgeGroups[badge.id]) {
                        badgeGroups[badge.id] = { badge: badge, count: 0 };
                    }
                    badgeGroups[badge.id].count++;
                });

                const sortedBadges = Object.values(badgeGroups);

                if (sortedBadges.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-muted py-3">é¸æŠå¯èƒ½ãªãƒãƒƒã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                listEl.innerHTML = sortedBadges.map(item => {
                    const badge = item.badge;
                    const priceInfo = mode === 'sell' ? `<div class="small text-danger fw-bold">ğŸª™${Math.floor(badge.price * 0.5).toLocaleString()}</div>` : '';
                    return `
                        <div class="col-4 col-md-3 text-center mb-2">
                            <div class="badge-item" 
                                 onclick="onBadgeSelectedForAction('${badge.id}', '${badge.name.replace(/'/g, "\\'")}', ${badge.price}, '${mode}')"
                                 style="cursor: pointer; position: relative;"
                                 title="${badge.name}">
                                <img src="${badge.image_url}" alt="${badge.name}" style="width: 60px; height: 60px; object-fit: contain;">
                                ${item.count > 1 ? `<span class="badge-count-overlay">${item.count}</span>` : ''}
                            </div>
                            <div class="small text-truncate mt-1" style="font-size: 0.7rem;">${badge.name}</div>
                            ${priceInfo}
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('ãƒãƒƒã‚¸èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                listEl.innerHTML = '<p class="text-center text-danger py-3">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
            }
        }

        let currentActionBadgeId = null;
        let currentActionBadgeName = '';
        let currentActionBadgePrice = 0;

        function onBadgeSelectedForAction(badgeId, badgeName, price, mode) {
            currentActionBadgeId = badgeId;
            currentActionBadgeName = badgeName;
            currentActionBadgePrice = price;

            // é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            const actionModal = bootstrap.Modal.getInstance(document.getElementById('badgeActionModal'));
            actionModal.hide();

            if (mode === 'transfer') {
                openUserSelectModal('badge');
            } else {
                executeSell(badgeId, badgeName, price);
            }
        }

        // ============ å£²å´å®Ÿè¡Œ ============
        async function executeSell(badgeId, badgeName, price) {
            const sellPrice = Math.floor(price * 0.5);
            if (!confirm(`ã€Œ${badgeName}ã€ã‚’å£²å´ã—ã¦ ğŸª™${sellPrice.toLocaleString()} ã‚’å—ã‘å–ã‚Šã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼‰`)) {
                return;
            }

            try {
                toggleLoading(true);

                // 1. ãƒãƒƒã‚¸ã‚’1ã¤å‰Šé™¤
                const { data: owned, error: fetchError } = await supabaseClient
                    .from('user_badges')
                    .select('id')
                    .eq('user_id', targetId)
                    .eq('badge_id', badgeId)
                    .limit(1)
                    .single();

                if (fetchError) throw new Error('ãƒãƒƒã‚¸ã®æ‰€æŒãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');

                const { error: deleteError } = await supabaseClient
                    .from('user_badges')
                    .delete()
                    .eq('id', owned.id);

                if (deleteError) throw deleteError;

                // 2. ãƒãƒƒã‚¸ã®åœ¨åº«ã‚’æˆ»ã™ï¼ˆremaining_count ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
                const { data: badge, error: badgeFetchError } = await supabaseClient
                    .from('badges')
                    .select('remaining_count')
                    .eq('id', badgeId)
                    .single();

                if (!badgeFetchError && badge && badge.remaining_count !== null) {
                    await supabaseClient
                        .from('badges')
                        .update({ remaining_count: badge.remaining_count + 1 })
                        .eq('id', badgeId);
                }

                // 3. ã‚³ã‚¤ãƒ³ã®åŠ ç®—
                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('coins')
                    .eq('discord_user_id', targetId)
                    .single();

                if (profileError) throw profileError;

                const { error: updateError } = await supabaseClient
                    .from('profiles')
                    .update({ coins: (profile.coins || 0) + sellPrice })
                    .eq('discord_user_id', targetId);

                if (updateError) throw updateError;

                // 4. ç·è³‡ç”£ã‚’åŠ ç®—
                if (typeof addToTotalAssets === 'function') {
                    await addToTotalAssets(targetId, sellPrice);
                }

                // 5. æ´»å‹•ãƒ­ã‚°ã‚’è¨˜éŒ²
                if (typeof logActivity === 'function') {
                    await logActivity(targetId, 'badge_sell', {
                        amount: sellPrice,
                        badgeId: badgeId,
                        details: { badge_name: badgeName, original_price: price }
                    });
                }

                alert(`${badgeName} ã‚’å£²å´ã—ã¾ã—ãŸã€‚ğŸª™${sellPrice} ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚`);
                location.reload();
            } catch (err) {
                console.error('å£²å´ã‚¨ãƒ©ãƒ¼:', err);
                alert('å£²å´å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            } finally {
                toggleLoading(false);
            }
        }

        // ============ è­²æ¸¡ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ ============
        let transferType = 'badge'; // 'badge' or 'coin'
        async function openUserSelectModal(type = 'badge') {
            transferType = type;
            const listEl = document.getElementById('transfer-user-list');
            listEl.innerHTML = '<p class="text-center text-muted py-4">èª­ã¿è¾¼ã¿ä¸­...</p>';

            document.getElementById('userSelectModalLabel').textContent = type === 'coin' ? 'é€é‡‘å…ˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ' : 'è­²æ¸¡å…ˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ';

            const modal = new bootstrap.Modal(document.getElementById('userSelectModal'));
            modal.show();

            try {
                const { data: users, error } = await supabaseClient
                    .from('profiles')
                    .select('discord_user_id, account_name, avatar_url, equipped_badge_id, badges!equipped_badge_id(image_url, name)')
                    .neq('discord_user_id', targetId) // è‡ªåˆ†ä»¥å¤–
                    .order('account_name');

                if (error) throw error;

                if (!users || users.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-muted py-4">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                listEl.innerHTML = users.map(u => {
                    const avatar = u.avatar_url || 'https://via.placeholder.com/40';
                    const badgeHtml = u.badges ? `<img src="${u.badges.image_url}" class="user-select-badge" title="${u.badges.name}">` : '';
                    return `
                        <div class="user-select-item" onclick="onUserSelectedForTransfer('${u.discord_user_id}', '${u.account_name.replace(/'/g, "\\'")}')">
                            <img src="${avatar}" class="user-select-avatar" onerror="this.src='https://via.placeholder.com/40'">
                            <div class="d-flex align-items-center flex-grow-1">
                                <span class="user-select-name">${u.account_name}</span>
                                ${badgeHtml}
                            </div>
                            <div class="text-muted small">é¸æŠ â¯</div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                listEl.innerHTML = '<p class="text-center text-danger py-4">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
            }
        }

        function onUserSelectedForTransfer(userId, userName) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            const userModal = bootstrap.Modal.getInstance(document.getElementById('userSelectModal'));
            userModal.hide();

            if (transferType === 'badge') {
                executeTransferConfirmation(userId, userName);
            } else {
                openCoinAmountModal(userId, userName);
            }
        }

        // ============ ã‚³ã‚¤ãƒ³é€é‡‘ãƒ•ãƒ­ãƒ¼ ============
        let coinTransferTargetId = null;
        let coinTransferTargetName = '';

        function openCoinTransferModal() {
            openUserSelectModal('coin');
        }

        async function openCoinAmountModal(userId, userName) {
            coinTransferTargetId = userId;
            coinTransferTargetName = userName;

            document.getElementById('coin-transfer-target-name').textContent = `${userName} ã•ã‚“ã¸é€é‡‘`;

            // è‡ªåˆ†ã®ä»Šã®æ‰€æŒé‡‘ã‚’è¡¨ç¤º
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('coins')
                .eq('discord_user_id', targetId)
                .single();

            const currentCoins = profile?.coins || 0;
            document.getElementById('my-coins-ref').textContent = currentCoins.toLocaleString();
            document.getElementById('coin-transfer-amount').value = '';

            const modal = new bootstrap.Modal(document.getElementById('coinAmountModal'));
            modal.show();
        }

        async function executeCoinTransfer() {
            const amountInput = document.getElementById('coin-transfer-amount');
            const amount = parseInt(amountInput.value);

            if (isNaN(amount) || amount <= 0) {
                alert('æœ‰åŠ¹ãªé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // æœ€çµ‚ç¢ºèª
            if (!confirm(`${coinTransferTargetName} ã•ã‚“ã« ğŸª™${amount.toLocaleString()} ã‚’é€é‡‘ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }

            try {
                toggleLoading(true);

                // 1. è‡ªåˆ†ã®æ‰€æŒé‡‘ãƒã‚§ãƒƒã‚¯
                const { data: sender, error: senderError } = await supabaseClient
                    .from('profiles')
                    .select('coins')
                    .eq('discord_user_id', targetId)
                    .single();

                if (senderError) throw senderError;
                if ((sender.coins || 0) < amount) {
                    throw new Error('æ‰€æŒé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“');
                }

                // 2. ç›¸æ‰‹ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆå¿µã®ãŸã‚ï¼‰
                const { data: receiver, error: receiverError } = await supabaseClient
                    .from('profiles')
                    .select('coins')
                    .eq('discord_user_id', coinTransferTargetId)
                    .single();

                if (receiverError) throw receiverError;

                // 3. é€é‡‘å‡¦ç† (ãƒã‚¤ãƒŠã‚¹)
                const { error: updateSenderError } = await supabaseClient
                    .from('profiles')
                    .update({ coins: sender.coins - amount })
                    .eq('discord_user_id', targetId);

                if (updateSenderError) throw updateSenderError;

                // 4. å…¥é‡‘å‡¦ç† (ãƒ—ãƒ©ã‚¹)
                const { error: updateReceiverError } = await supabaseClient
                    .from('profiles')
                    .update({ coins: (receiver.coins || 0) + amount })
                    .eq('discord_user_id', coinTransferTargetId);

                if (updateReceiverError) {
                    // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯çš„ãªå‡¦ç†ãŒå¿…è¦ã ãŒã€Supabase RLS/Updateã§ã¯é›£ã—ã„ã®ã§ã‚¨ãƒ©ãƒ¼é€šçŸ¥
                    console.error('å…¥é‡‘ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé€é‡‘å…ƒã¯æ¸›é¡æ¸ˆã¿ï¼‰:', updateReceiverError);
                    alert('å…¥é‡‘å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // 5. å—ä¿¡å´ã®ç·è³‡ç”£ã‚’åŠ ç®—
                if (typeof addToTotalAssets === 'function') {
                    await addToTotalAssets(coinTransferTargetId, amount);
                }

                // 6. æ´»å‹•ãƒ­ã‚°ã‚’è¨˜éŒ²ï¼ˆé€ä¿¡å´ï¼‰
                if (typeof logActivity === 'function') {
                    await logActivity(targetId, 'transfer_send', {
                        amount: amount,
                        targetUserId: coinTransferTargetId,
                        details: { target_name: coinTransferTargetName }
                    });
                    // æ´»å‹•ãƒ­ã‚°ã‚’è¨˜éŒ²ï¼ˆå—ä¿¡å´ï¼‰
                    const senderName = document.getElementById('nickname-display')?.textContent || 'èª°ã‹';
                    await logActivity(coinTransferTargetId, 'transfer_receive', {
                        amount: amount,
                        targetUserId: targetId,
                        details: { sender_name: senderName }
                    });
                }

                alert(`${coinTransferTargetName} ã•ã‚“ã« ğŸª™${amount.toLocaleString()} ã‚’é€é‡‘ã—ã¾ã—ãŸï¼`);
                location.reload();

            } catch (err) {
                console.error('é€é‡‘ã‚¨ãƒ©ãƒ¼:', err);
                alert('é€é‡‘ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            } finally {
                toggleLoading(false);
            }
        }

        async function executeTransferConfirmation(toUserId, toUserName) {
            if (!confirm(`ã€Œ${currentActionBadgeName}ã€ã‚’ ${toUserName} ã•ã‚“ã«è­²æ¸¡ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã‚ãªãŸã®æ‰‹æŒã¡ã‹ã‚‰ã¯1ã¤ãªããªã‚Šã¾ã™ï¼‰`)) {
                return;
            }

            try {
                toggleLoading(true);

                // 1. è‡ªåˆ†ã®ãƒãƒƒã‚¸ã‚’1ã¤å‰Šé™¤
                const { data: owned, error: fetchError } = await supabaseClient
                    .from('user_badges')
                    .select('id')
                    .eq('user_id', targetId)
                    .eq('badge_id', currentActionBadgeId)
                    .limit(1)
                    .single();

                if (fetchError) throw new Error('è­²æ¸¡ã™ã‚‹ãƒãƒƒã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

                const { error: deleteError } = await supabaseClient
                    .from('user_badges')
                    .delete()
                    .eq('id', owned.id);

                if (deleteError) throw deleteError;

                // 2. ç›¸æ‰‹ã«ä»˜ä¸
                const { error: insertError } = await supabaseClient
                    .from('user_badges')
                    .insert([{ user_id: toUserId, badge_id: currentActionBadgeId }]);

                if (insertError) throw insertError;

                // 3. æ´»å‹•ãƒ­ã‚°ã‚’è¨˜éŒ²
                if (typeof logActivity === 'function') {
                    const senderName = document.getElementById('nickname-display')?.textContent || 'èª°ã‹';
                    await logActivity(targetId, 'badge_transfer', {
                        badgeId: currentActionBadgeId,
                        targetUserId: toUserId,
                        details: { target_name: toUserName, badge_name: currentActionBadgeName }
                    });
                    await logActivity(toUserId, 'badge_receive', {
                        badgeId: currentActionBadgeId,
                        targetUserId: targetId,
                        details: { sender_name: senderName, badge_name: currentActionBadgeName }
                    });
                }

                alert(`${toUserName} ã•ã‚“ã«ãƒãƒƒã‚¸ã‚’è­²æ¸¡ã—ã¾ã—ãŸï¼`);
                location.reload();
            } catch (err) {
                console.error('è­²æ¸¡ã‚¨ãƒ©ãƒ¼:', err);
                alert('è­²æ¸¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            } finally {
                toggleLoading(false);
            }
        }

        async function equipBadge(badgeId) {
            if (isViewMode) return;

            // ç¾åœ¨ã®è£…ç€çŠ¶æ³ã‚’ç¢ºèª
            const { data: current } = await supabaseClient
                .from('profiles')
                .select('equipped_badge_id')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            // åŒã˜ãƒãƒƒã‚¸ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯å¤–ã™ï¼ˆä»»æ„ï¼šä»Šå›ã¯ã€Œå¤–ã™ã€æ©Ÿèƒ½ã‚‚å…¼ã­ã‚‹ï¼‰
            const newBadgeId = (current?.equipped_badge_id === badgeId) ? null : badgeId;

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ equipped_badge_id: newBadgeId })
                    .eq('discord_user_id', targetId);

                if (error) throw error;

                await loadOwnedBadges(); // ãƒªã‚¹ãƒˆæ›´æ–°
                await loadTargetUserInfo(); // åå‰æ¨ªã®ãƒãƒƒã‚¸æ›´æ–°
                displayUserInfo(); // ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modalEl = document.getElementById('badgeChangeModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
            } catch (err) {
                console.error('ãƒãƒƒã‚¸å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', err);
                alert('ãƒãƒƒã‚¸ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒãƒƒã‚¸å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        async function openBadgeChangeModal() {
            const listEl = document.getElementById('badge-modal-list');
            listEl.innerHTML = '<p class="text-center text-muted py-3">èª­ã¿è¾¼ã¿ä¸­...</p>';

            const modalEl = document.getElementById('badgeChangeModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();

            try {
                // æ‰€æŒãƒãƒƒã‚¸ã®å–å¾—
                const { data: owned, error } = await supabaseClient
                    .from('user_badges')
                    .select('badge_id, badges(*)')
                    .eq('user_id', targetId);

                if (error) throw error;

                // è£…ç€ä¸­ã®ãƒãƒƒã‚¸IDå–å¾—
                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('equipped_badge_id')
                    .eq('discord_user_id', targetId)
                    .maybeSingle();

                const equippedId = profile?.equipped_badge_id;

                if (!owned || owned.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-muted py-3">ãƒãƒƒã‚¸ã‚’æŒã£ã¦ã„ã¾ã›ã‚“</p>';
                    return;
                }

                listEl.innerHTML = owned.map(item => {
                    const badge = item.badges;
                    if (!badge) return '';
                    const isEquipped = badge.id === equippedId;
                    return `
                        <div class="col-4 col-md-3 text-center">
                            <div class="badge-item ${isEquipped ? 'equipped' : ''}" 
                                 onclick="equipBadge('${badge.id}')"
                                 style="cursor: pointer;"
                                 title="${badge.name}${isEquipped ? ' (è£…ç€ä¸­)' : ''}">
                                <img src="${badge.image_url}" alt="${badge.name}" style="width: 60px; height: 60px; object-fit: contain;">
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('ãƒãƒƒã‚¸èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                listEl.innerHTML = '<p class="text-center text-danger py-3">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
            }
        }

        // ============ éº»é›€çµ±è¨ˆæ©Ÿèƒ½ ============
        let allMahjongRecords = [];
        let myAccountName = '';
        let currentMyTournament = 'ç¬¬äºŒå›éº»é›€å¤§ä¼š';

        async function loadMahjongStats() {
            try {
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—ï¼ˆç®¡ç†è€…ç”¨ï¼‰
                const urlParams = new URLSearchParams(window.location.search);
                const targetUserId = urlParams.get('user');

                if (targetUserId) {
                    // ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çµ±è¨ˆã‚’è¡¨ç¤º
                    myAccountName = targetUserId;
                } else {
                    // è‡ªåˆ†ã®çµ±è¨ˆã‚’è¡¨ç¤º
                    const user = await getCurrentUser();
                    if (!user) return;
                    myAccountName = user.user_metadata.provider_id;
                }

                // ç¬¬äºŒå›éº»é›€å¤§ä¼šãƒ‡ãƒ¼ã‚¿
                const { data: currentData, error: currentError } = await supabaseClient
                    .from('match_results')
                    .select('*');

                if (currentError) {
                    console.warn('ç¬¬äºŒå›ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', currentError);
                }

                // ç¬¬ä¸€å›éº»é›€å¤§ä¼šãƒ‡ãƒ¼ã‚¿
                let legacyData = [];
                try {
                    const { data, error: legacyError } = await supabaseClient
                        .from('tournament_player_stats_snapshot')
                        .select('*');

                    if (legacyError) {
                        console.warn('ç¬¬ä¸€å›ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', legacyError);
                    } else {
                        legacyData = data || [];
                    }
                } catch (e) {
                    console.warn('ç¬¬ä¸€å›ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¹ã‚­ãƒƒãƒ—:', e);
                }

                // æ–°ãƒ‡ãƒ¼ã‚¿ã«ã‚‚ tournament_type ã‚’ä¿éšœ
                const taggedCurrentData = (currentData || []).map(r => ({
                    ...r,
                    tournament_type: r.tournament_type || 'ç¬¬äºŒå›éº»é›€å¤§ä¼š'
                }));

                // éå»ãƒ‡ãƒ¼ã‚¿ã« tournament_type ã‚’ä¿éšœ
                const taggedLegacyData = (legacyData || []).map(r => ({
                    ...r,
                    tournament_type: r.tournament_type || 'ç¬¬ä¸€å›éº»é›€å¤§ä¼š'
                }));

                allMahjongRecords = [...taggedCurrentData, ...taggedLegacyData];
                console.log('ğŸ“Š å–å¾—ã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰æ•°:', allMahjongRecords.length);

                renderTournamentDropdown();
                displayMahjongStats();
            } catch (err) {
                console.error('éº»é›€çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                document.getElementById('stats-loading').style.display = 'none';
                document.getElementById('no-stats-msg').style.display = 'block';
                document.getElementById('stats-content').style.display = 'block';
            }
        }

        function renderTournamentDropdown() {
            const select = document.getElementById('tournament-select');
            if (!select) return;

            const tournaments = ['ç¬¬äºŒå›éº»é›€å¤§ä¼š', 'ç¬¬ä¸€å›éº»é›€å¤§ä¼š'];

            let html = '';
            tournaments.forEach(t => {
                html += `<option value="${t}" ${currentMyTournament === t ? 'selected' : ''}>${t}</option>`;
            });
            html += `<option value="all" ${currentMyTournament === 'all' ? 'selected' : ''}>å…¨ã‚·ãƒ¼ã‚ºãƒ³</option>`;

            select.innerHTML = html;
        }

        function handleTournamentChange() {
            const select = document.getElementById('tournament-select');
            currentMyTournament = select.value;
            displayMahjongStats();
        }

        function displayMahjongStats() {
            // å¤§ä¼šãƒ•ã‚£ãƒ«ã‚¿
            let records = allMahjongRecords;
            if (currentMyTournament !== 'all') {
                records = allMahjongRecords.filter(r => r.tournament_type === currentMyTournament);
            }

            // å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çµ±è¨ˆè¨ˆç®—
            const playerStats = calculateAllPlayerStats(records);

            // ãƒ‡ãƒãƒƒã‚°: å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’è¡¨ç¤º
            console.log('ğŸ¯ è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå:', myAccountName);
            console.log('ğŸ“‹ å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å:', playerStats.map(p => p.name));

            // è‡ªåˆ†ã®çµ±è¨ˆã‚’å–å¾—
            const myStats = playerStats.find(p => p.name === myAccountName);
            const totalPlayers = playerStats.length;

            document.getElementById('stats-loading').style.display = 'none';
            document.getElementById('stats-content').style.display = 'block';

            const statsGrid = document.getElementById('stats-grid');
            const noStatsMsg = document.getElementById('no-stats-msg');

            if (!myStats || myStats.games === 0) {
                if (statsGrid) statsGrid.style.display = 'none';
                noStatsMsg.style.display = 'block';
                return;
            }
            if (statsGrid) statsGrid.style.display = 'block';
            noStatsMsg.style.display = 'none';

            // å„çµ±è¨ˆã‚’è¡¨ç¤º
            const formatScore = (val) => {
                if (typeof val !== 'number') return val;
                // å°æ•°ç‚¹ç¬¬1ä½ã¾ã§ã«ä¸¸ã‚ã‚‹ãŒã€.0 ã®å ´åˆã¯æ•´æ•°ã«ã™ã‚‹
                return Math.round(val * 10) / 10;
            };

            updateStatCard('total', formatScore(myStats.total), playerStats, 'total', true);
            updateStatCard('sanma', formatScore(myStats.sanma), playerStats, 'sanma', true);
            updateStatCard('yonma', formatScore(myStats.yonma), playerStats, 'yonma', true);
            updateStatCard('avg-score', formatScore(myStats.avgScore), playerStats, 'avgScore', true);
            updateStatCard('max-score', formatScore(myStats.maxScore), playerStats, 'maxScore', true);
            updateStatCard('win-rate', myStats.winRate.toFixed(2) + ' / è©¦åˆ', playerStats, 'winRate', true);
            updateStatCard('deal-rate', myStats.dealRate.toFixed(2) + ' / è©¦åˆ', playerStats, 'dealRate', false);
            updateStatCard('top-rate', myStats.topRate.toFixed(1) + '%', playerStats, 'topRate', true);
            updateStatCard('avoid-rate', myStats.avoidRate.toFixed(1) + '%', playerStats, 'avoidRate', true);
            updateStatCard('avg-rank', myStats.avgRank.toFixed(2), playerStats, 'avgRank', false);
            updateStatCard('games', myStats.games, playerStats, 'games', true);
        }

        function updateStatCard(id, value, allStats, key, higherIsBetter) {
            document.getElementById('stat-' + id).textContent = value;

            // é †ä½è¨ˆç®—
            const sorted = [...allStats].filter(p => p.games > 0).sort((a, b) =>
                higherIsBetter ? b[key] - a[key] : a[key] - b[key]
            );
            const myRank = sorted.findIndex(p => p.name === myAccountName) + 1;
            const total = sorted.length;

            const rankEl = document.getElementById('rank-' + id);
            if (myRank > 0) {
                rankEl.textContent = `${myRank}/${total}ä½`;
                rankEl.classList.remove('no-data');
            } else {
                rankEl.textContent = '-';
                rankEl.classList.add('no-data');
            }
        }

        function calculateAllPlayerStats(records) {
            const players = {};

            records.forEach(r => {
                // discord_user_idã‚’ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
                let id = r.discord_user_id;
                if (!id || id === 'null') {
                    id = r.nickname || r.account_name || 'Unknown';
                }
                if (!id) return;

                if (!players[id]) {
                    players[id] = {
                        name: id,
                        score: 0, sanma: 0, yonma: 0,
                        count: 0, win: 0, deal: 0,
                        r1: 0, r2: 0, r3: 0, r4: 0,
                        max_score: -Infinity
                    };
                }

                const p = players[id];
                const mode = r.mahjong_mode || r.mode || ''; // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã«åˆã‚ã›ã¦ mahjong_mode ã‚’å„ªå…ˆ

                // ç¬¬ä¸€å›å¤§ä¼šã¨ç¬¬äºŒå›å¤§ä¼šã§ç•°ãªã‚‹ã‚«ãƒ©ãƒ åã‚’å‡¦ç†
                if (r.tournament_type === 'ç¬¬ä¸€å›éº»é›€å¤§ä¼š') {
                    p.score += Number(r.score_total || 0);
                    p.count += Number(r.matches_played || 0);
                    p.r1 += Number(r.rank1_count || 0);
                    p.r2 += Number(r.rank2_count || 0);
                    p.r3 += Number(r.rank3_count || 0);
                    p.r4 += Number(r.rank4_count || 0);
                    p.max_score = Math.max(p.max_score, Number(r.score_max || 0));
                } else {
                    p.score += Number(r.final_score || 0);
                    p.count += 1;
                    const rk = Number(r.rank);
                    if (rk === 1) p.r1++;
                    else if (rk === 2) p.r2++;
                    else if (rk === 3) p.r3++;
                    else if (rk === 4) p.r4++;
                    p.max_score = Math.max(p.max_score, Number(r.final_score || 0));
                }

                p.win += Number(r.win_count || r.wins || 0);
                p.deal += Number(r.deal_in_count || r.deals || 0);

                // ãƒ¢ãƒ¼ãƒ‰åˆ¥ã‚¹ã‚³ã‚¢ï¼ˆä¸‰éº»ã‚¹ã‚³ã‚¢ãƒ»å››éº»ã‚¹ã‚³ã‚¢è¡¨ç¤ºç”¨ï¼‰
                if (mode === 'ä¸‰éº»') p.sanma += Number(r.final_score || r.score_total || 0);
                if (mode === 'å››éº»') p.yonma += Number(r.final_score || r.score_total || 0);
            });

            // çµ±è¨ˆå€¤ã‚’è¨ˆç®—
            return Object.values(players).map(p => {
                const avgWin = p.count > 0 ? (p.win / p.count) : 0;
                const avgDeal = p.count > 0 ? (p.deal / p.count) : 0;
                const topRate = p.count > 0 ? (p.r1 / p.count) * 100 : 0;
                let lastCount = p.r4;
                if (p.r4 === 0 && p.r3 > 0) lastCount = p.r3;
                const avoidRate = p.count > 0 ? (1 - (lastCount / p.count)) * 100 : 0;
                const avgRank = p.count > 0 ? (1 * p.r1 + 2 * p.r2 + 3 * p.r3 + 4 * p.r4) / p.count : 0;
                const avgScore = p.count > 0 ? p.score / p.count : 0;

                return {
                    name: p.name,
                    total: p.score,
                    sanma: p.sanma,
                    yonma: p.yonma,
                    avgScore: avgScore,
                    maxScore: p.max_score === -Infinity ? 0 : p.max_score,
                    winRate: avgWin,
                    dealRate: avgDeal,
                    avgRank: avgRank,
                    topRate: topRate,
                    avoidRate: avoidRate,
                    games: p.count
                };
            });
        }

        // æˆ»ã‚‹ãƒœã‚¿ãƒ³ - å‰ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹ï¼ˆå±¥æ­´ãŒãªã„å ´åˆã¯ãƒ›ãƒ¼ãƒ ã¸ï¼‰
        function goBack() {
            if (document.referrer && document.referrer.includes(location.hostname)) {
                history.back();
            } else {
                location.href = '../index.html';
            }
        }

        function toggleLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }


        document.addEventListener('DOMContentLoaded', initPage);

    </script>
    <!-- ãƒãƒ¼ãƒ é€šçŸ¥ãƒãƒƒã‚¸ -->
    <script>
        async function checkTeamNotifications() {
            const user = await getCurrentUser();
            if (!user) return;

            const discordId = user.user_metadata.provider_id;

            // è‡ªåˆ†ãŒãƒªãƒ¼ãƒ€ãƒ¼ã®ãƒãƒ¼ãƒ ã‚’å–å¾—
            const { data: myTeams } = await supabaseClient
                .from('teams')
                .select('id')
                .eq('creator_discord_id', discordId);

            if (!myTeams || myTeams.length === 0) return;

            const teamIds = myTeams.map(t => t.id);

            // ä¿ç•™ä¸­ã®ç”³è«‹ï¼ˆåŠ å…¥ãƒ»è„±é€€ï¼‰ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const { data: pendingRequests } = await supabaseClient
                .from('team_join_requests')
                .select('id')
                .in('team_id', teamIds)
                .in('status', ['pending', 'leave_pending']);

            const count = pendingRequests?.length || 0;

            if (count > 0) {
                const badge = document.getElementById('team-notification-badge');
                if (badge) {
                    badge.textContent = count;
                    badge.style.display = 'inline';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', checkTeamNotifications);
    </script>
</body>

</html>