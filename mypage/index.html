<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="かにサーバー - マイページ">
    <title>マイページ | かにサーバーイベント</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;600;700&family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap"
        rel="stylesheet">

    <!-- Bootswatch Lux (Bootstrap 5.3.3) -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-purple: #6b5b95;
            --deep-purple: #4a3f6b;
            --cream: #faf5e8;
            --gold: #d4a853;
            --btn-gold: #c29544;
            --font-title: 'Noto Serif JP', serif;
            --font-body: 'M PLUS Rounded 1c', sans-serif;
        }

        .btn-gold {
            background-color: var(--gold);
            border: none;
        }

        .btn-gold:hover {
            background-color: var(--btn-gold);
            color: white;
        }


        body {
            font-family: var(--font-body);
            background: linear-gradient(180deg, #6b5b95 0%, #5a4d80 50%, #4a3f6b 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }

        .page-header {
            font-family: var(--font-title);
            color: var(--cream);
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
        }

        .back-button {
            font-family: var(--font-body);
            font-size: 1rem;
            padding: 10px 25px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #fff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .profile-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--gold);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .discord-badge {
            background: linear-gradient(135deg, #43b581, #3ca374);
            color: white;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(67, 181, 129, 0.4);
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid var(--gold);
        }

        .activity-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .activity-item-card {
            background: #fdfdfd;
            /* カードの中にカードであることを強調するための微調整 */
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            border: 1px solid #eff0f1;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            display: block;
        }

        .activity-item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            border-color: var(--gold);
        }

        .activity-date {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 10px;
            display: block;
            border-bottom: 1px solid #f5f5f5;
            padding-bottom: 5px;
        }

        .activity-type-badge {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 50px;
            background: #f0f2f5;
            color: #4b515d;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .activity-details {
            font-size: 0.95rem;
            color: #2c3e50;
            font-weight: 500;
        }

        .activity-amount {
            font-family: 'Inter', 'Kosugi Maru', sans-serif;
            font-weight: 800;
            font-size: 1.15rem;
            letter-spacing: -0.02em;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--deep-purple);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        /* 麻雀統計フィルター */
        .mahjong-filter-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .filter-label-mini {
            font-size: 0.7rem;
            color: #888;
            font-weight: bold;
        }

        .mahjong-filter-select {
            padding: 6px 12px;
            border: 2px solid #d4a853;
            border-radius: 8px;
            background: linear-gradient(135deg, #fff9e6 0%, #fff 100%);
            color: #333;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            min-width: 100px;
            transition: all 0.3s ease;
        }

        .mahjong-filter-select:hover {
            border-color: #c49743;
            box-shadow: 0 2px 8px rgba(212, 168, 83, 0.3);
        }

        .mahjong-filter-select:focus {
            outline: none;
            border-color: #b88533;
            box-shadow: 0 0 0 3px rgba(212, 168, 83, 0.2);
        }

        .login-prompt {
            text-align: center;
            padding: 60px 20px;
        }

        .login-prompt-btn {
            background: linear-gradient(135deg, #5865F2, #4752c4);
            color: white;
            padding: 15px 40px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .login-prompt-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(88, 101, 242, 0.4);
        }

        .logout-btn {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 2px solid #dc3545;
            padding: 10px 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc3545;
            color: white;
        }

        /* ニックネーム入力欄 */
        .nickname-input {
            background: #fff;
            border: 2px solid #e0d8f0;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 1rem;
            transition: all 0.3s ease;
            color: #333;
        }

        .nickname-input::placeholder {
            color: #aaa;
            font-style: italic;
        }

        .nickname-input:focus {
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 4px rgba(107, 91, 149, 0.15);
            outline: none;
            background: #fff;
        }

        /* アイコン更新ボタン */
        .btn-avatar-update {
            background: linear-gradient(135deg, #5865F2 0%, #4752c4 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(88, 101, 242, 0.3);
        }

        .btn-avatar-update:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(88, 101, 242, 0.5);
            background: linear-gradient(135deg, #6872f4 0%, #5865F2 100%);
        }

        /* 統計ミニカード */
        .stat-card-mini {
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
            cursor: pointer;
            height: 100%;
        }

        .stat-card-mini:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--gold);
        }

        .stat-card-mini.rank-1 {
            background: linear-gradient(135deg, #fff7ad 0%, #ffa700 100%) !important;
            border-left: 8px solid #ffd700 !important;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3) !important;
        }

        .stat-card-mini.rank-2 {
            background: linear-gradient(135deg, #f0f0f0 0%, #a0a0a0 100%) !important;
            border-left: 8px solid #c0c0c0 !important;
            box-shadow: 0 4px 15px rgba(192, 192, 192, 0.3) !important;
        }

        .stat-card-mini.rank-3 {
            background: linear-gradient(135deg, #f5d4b5 0%, #b87333 100%) !important;
            border-left: 8px solid #cd7f32 !important;
            box-shadow: 0 4px 15px rgba(205, 127, 50, 0.3) !important;
        }

        .stat-label-mini {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-value-mini {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--deep-purple);
        }

        .stat-rank {
            font-size: 0.7rem;
            color: #fff;
            background: linear-gradient(135deg, var(--gold), #b8860b);
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 5px;
            display: inline-block;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .stat-rank.no-data {
            background: #adb5bd;
        }

        /* バッジ一覧のスタイル */
        .badge-item {
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
            border-radius: 12px;
            padding: 8px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .badge-item:hover {
            transform: scale(1.05);
            background: #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .badge-item.equipped {
            border-color: rgba(212, 165, 116, 0.4);
            background: #fff9e6;
        }

        .badge-item.selected {
            border-color: var(--gold) !important;
            background: #fff !important;
            box-shadow: 0 0 0 3px rgba(211, 168, 83, 0.5) !important;
            transform: scale(1.05);
        }

        .badge-item img {
            width: 70px;
            height: 70px;
            object-fit: contain;
            display: block;
        }

        .badge-count-overlay {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            border: 2px solid white;
            z-index: 10;
        }

        /* ローディングオーバーレイ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s;
        }

        .loading-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        /* ユーザー選択リスト */
        .user-select-item {
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
        }

        .user-select-item:hover {
            background-color: #f8f9fa;
        }


        .user-select-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 2px solid var(--gold);
        }

        .user-select-badge {
            width: 24px;
            height: 24px;
            object-fit: contain;
            margin-left: 8px;
        }

        .user-select-name {
            font-weight: 700;
            color: var(--deep-purple);
            font-size: 1rem;
        }

        /* ナビゲーションドロップダウン */
        .nav-dropdown {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .record-button {
            background: linear-gradient(135deg, var(--gold) 0%, #b8892d 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 6px 20px rgba(212, 168, 83, 0.5);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            cursor: pointer;
        }

        .record-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 168, 83, 0.6);
            color: white;
        }

        .nav-dropdown-menu {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            min-width: 200px;
            overflow: hidden;
        }

        .nav-dropdown-menu .dropdown-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            transition: background 0.2s;
        }

        .nav-dropdown-menu .dropdown-item:hover {
            background: #f5f5f5;
        }

        .nav-dropdown-menu .dropdown-divider {
            margin: 0;
        }

        .notification-badge {
            background: #dc3545;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
        }

        /* レアリティ別背景色 */
        .rarity-wood {
            background: #d7ccc8 !important;
            color: #5d4037 !important;
            border-color: #8d6e63 !important;
        }

        .rarity-stone {
            background: #cfd8dc !important;
            color: #455a64 !important;
            border-color: #90a4ae !important;
        }

        .rarity-bronze {
            background: #ffe0b2 !important;
            color: #e65100 !important;
            border-color: #ffb74d !important;
        }

        .rarity-silver {
            background: #f5f5f5 !important;
            color: #616161 !important;
            border-color: #bdbdbd !important;
        }

        .rarity-gold {
            background: linear-gradient(135deg, #fff9c4 0%, #fbc02d 100%) !important;
            color: #f57f17 !important;
            border-color: #fdd835 !important;
        }

        .rarity-platinum {
            background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%) !important;
            color: #0277bd !important;
            border-color: #4fc3f7 !important;
        }

        .rarity-gem {
            background: linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%) !important;
            color: #7b1fa2 !important;
            border-color: #ba68c8 !important;
            box-shadow: 0 0 15px rgba(186, 104, 200, 0.4);
        }

        .rarity-legend {
            background: linear-gradient(135deg, #fff9c4 0%, #fbc02d 50%, #f9a825 100%) !important;
            color: #f57f17 !important;
            border-color: #ffd700 !important;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .rarity-fantasy {
            background: linear-gradient(135deg, #e1f5fe 0%, #81d4fa 50%, #4fc3f7 100%) !important;
            color: #01579b !important;
            border-color: #00bcd4 !important;
            box-shadow: 0 0 25px rgba(0, 188, 212, 0.5);
        }

        .rarity-supreme {
            background: linear-gradient(135deg, #fce4ec 0%, #f06292 50%, #e91e63 100%) !important;
            color: #880e4f !important;
            border-color: #ff4081 !important;
            box-shadow: 0 0 30px rgba(255, 64, 129, 0.6);
        }

        .rarity-mythic {
            background: linear-gradient(135deg, #fffde7 0%, #fff176 50%, #ffd600 100%) !important;
            color: #f57f17 !important;
            border-color: #ffea00 !important;
            box-shadow: 0 0 40px rgba(255, 234, 0, 0.7);
        }

        .rarity-void {
            background: #000 !important;
            color: #fff !important;
            border-color: #333 !important;
        }

        /* --- ミュータント演出 (詳細ページから移植) --- */
        .badge-image-container {
            position: relative;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .badge-image-container.mutant-active::before,
        .badge-image-container.mutant-active::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            width: 80px;
            height: 120px;
            transform: translateX(-50%);
            z-index: 0;
            pointer-events: none;
            border-radius: 50% 50% 0 0;
            filter: blur(15px);
        }

        .badge-image-container.mutant-active::before {
            background-image:
                radial-gradient(circle at 30% 80%, rgba(180, 0, 180, 0.6) 0%, transparent 40%),
                radial-gradient(circle at 70% 60%, rgba(120, 0, 255, 0.5) 0%, transparent 45%),
                radial-gradient(circle at 40% 40%, rgba(200, 0, 255, 0.4) 0%, transparent 50%);
            animation: bubblesRiseSmall 4s linear infinite;
        }

        .badge-image-container.mutant-active::after {
            background-image:
                radial-gradient(circle at 60% 90%, rgba(255, 0, 150, 0.5) 0%, transparent 40%),
                radial-gradient(circle at 20% 70%, rgba(180, 0, 255, 0.4) 0%, transparent 45%),
                radial-gradient(circle at 80% 30%, rgba(120, 0, 255, 0.3) 0%, transparent 50%);
            animation: bubblesRiseSmall 6s linear infinite reverse;
            opacity: 0.7;
        }

        .mutant-shine-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 2;
            overflow: hidden;
            border-radius: 50% !important;
            -webkit-mask-image: radial-gradient(circle, black 65%, transparent 70%);
            mask-image: radial-gradient(circle, black 65%, transparent 70%);
        }

        .mutant-shine-overlay::before {
            content: '';
            position: absolute;
            top: -100%;
            left: -100%;
            width: 300%;
            height: 300%;
            background: linear-gradient(135deg,
                    transparent 40%,
                    rgba(255, 255, 255, 0.1) 44%,
                    rgba(255, 255, 255, 0.9) 45%,
                    rgba(255, 255, 255, 0.2) 46%,
                    transparent 48%,
                    transparent 50%,
                    rgba(255, 255, 255, 0.1) 51%,
                    rgba(255, 255, 255, 0.6) 52%,
                    rgba(255, 255, 255, 0.1) 53%,
                    transparent 55%);
            filter: blur(3px);
            animation: mutantShineDiagonalSmall 2s infinite ease-in-out;
        }

        @keyframes bubblesRiseSmall {
            0% {
                background-position: 0% 100%;
                transform: translateX(-50%) translateY(10px) scale(0.8);
                opacity: 0;
            }

            10% {
                opacity: 0.8;
            }

            90% {
                opacity: 0.8;
            }

            100% {
                background-position: 0% -100%;
                transform: translateX(-50%) translateY(-30px) scale(1.1);
                opacity: 0;
            }
        }

        @keyframes mutantShineDiagonalSmall {
            0% {
                transform: translate(-40%, -40%);
            }

            100% {
                transform: translate(40%, 40%);
            }
        }

        /* プレミアム・ページネーション */
        .pagination-premium .page-link {
            border: none;
            margin: 0 4px;
            border-radius: 8px !important;
            color: var(--deep-purple);
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .pagination-premium .page-item.active .page-link {
            background: linear-gradient(135deg, var(--deep-purple), var(--soft-purple));
            color: white !important;
            box-shadow: 0 4px 10px rgba(106, 17, 203, 0.3);
        }

        .pagination-premium .page-link:hover {
            background: var(--gold);
            color: white !important;
            transform: translateY(-2px);
        }
    </style>
</head>

<body>
    <!-- 右上のナビゲーションドロップダウン -->
    <div class="nav-dropdown dropdown">
        <button class="record-button dropdown-toggle" type="button" id="navDropdown" data-bs-toggle="dropdown"
            aria-expanded="false">
            📝 メニュー
        </button>
        <ul class="dropdown-menu nav-dropdown-menu dropdown-menu-end" aria-labelledby="navDropdown">
            <li><a class="dropdown-item" href="../index.html">🏠 ホームに戻る</a></li>
            <li><a class="dropdown-item" href="./index.html">👤 マイページ</a></li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="../mahjong/index.html">📊 ランキング</a></li>
            <li><a class="dropdown-item" href="../mahjong/record.html">📝 記録する</a></li>
            <li><a class="dropdown-item" href="../mahjong/users/index.html">👥 ユーザー一覧</a></li>
            <li><a class="dropdown-item" href="../mahjong/team/index.html">🏅 チーム管理 <span id="team-notification-badge"
                        class="notification-badge" style="display:none;">0</span></a></li>
            <li><a class="dropdown-item" href="../badge/list.html">📛 バッジ一覧</a></li>
            <li><a class="dropdown-item" href="../badge/shop.html">🛒 バッジショップ</a></li>
            <li><a class="dropdown-item" href="../ranking/index.html">💰 資産ランキング</a></li>
            <li class="admin-only" style="display:none;"><a class="dropdown-item" href="../omikuji/index.html">🎋
                    おみくじ</a></li>
            <li class="admin-only" style="display:none;">
                <hr class="dropdown-divider">
            </li>
            <li class="admin-only" style="display:none;">
                <a class="dropdown-item" href="../admin/index.html">⚙️ 管理画面</a>
            </li>
        </ul>
    </div>

    <div class="container py-5">
        <!-- 戻るボタン -->
        <div class="mb-4">
            <a href="#" onclick="goBack(); return false;" class="back-button">
                ← 戻る
            </a>
        </div>


        <!-- ヘッダー -->
        <header class="text-center mb-5">
            <h1 class="page-header display-4 fw-bold mb-3">👤 マイページ</h1>
        </header>

        <!-- コンテンツ -->
        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">

                <!-- 未ログイン時 -->
                <div id="login-prompt" class="profile-card login-prompt" style="display: none;">
                    <h3 class="mb-4" style="font-family: var(--font-title); color: var(--deep-purple);">
                        ログインしてください
                    </h3>
                    <p class="text-muted mb-4">
                        マイページを表示するにはDiscordでログインが必要です。
                    </p>
                    <button onclick="loginWithDiscord()" class="login-prompt-btn">
                        <img src="https://assets-global.website-files.com/6257adef93867e50d84d30e2/636e0a69f118df70ad7828d4_icon_clyde_blurple_RGB.svg"
                            alt="Discord" style="width: 24px;">
                        Discordでログイン
                    </button>
                </div>

                <!-- ログイン済み（または閲覧モード） -->
                <div id="profile-content" style="display: none;">
                    <div class="profile-card mb-4">
                        <!-- 上段: バッジ + 名前 + バッジ + 編集ボタン -->
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center gap-2 flex-grow-1" style="min-width: 0;">
                                <img id="user-equipped-badge" src="" alt=""
                                    style="width: 36px; height: 36px; border-radius: 8px; display: none;" title="">
                                <h2 id="user-name" class="mb-0 text-truncate"
                                    style="font-family: var(--font-title); color: var(--deep-purple); font-size: 1.4rem;">
                                    ユーザー名
                                </h2>
                                <img id="user-equipped-badge-right" src="" alt=""
                                    style="width: 36px; height: 36px; border-radius: 8px; display: none;" title="">
                            </div>
                            <button id="nickname-edit-btn" onclick="openNicknameModal()"
                                class="btn btn-sm btn-outline-secondary flex-shrink-0" title="ニックネームを変更"
                                style="display: none; padding: 4px 10px;">
                                ✏️
                            </button>
                        </div>

                        <!-- 下段: アバター + 情報 -->
                        <div class="row align-items-start">
                            <div class="col-auto">
                                <div class="text-center">
                                    <img id="user-avatar" src="" alt="アバター" class="avatar-large">
                                    <button id="sync-btn" onclick="updateAvatar()"
                                        class="btn btn-sm btn-outline-secondary mt-2" title="Discordから最新のアバター画像を取得"
                                        style="font-size: 0.7rem; padding: 3px 8px;">
                                        🔄 同期
                                    </button>
                                </div>
                            </div>
                            <div class="col">
                                <h2 id="page-title-label" class="small text-muted mb-1" style="display:none;">プレイヤー</h2>

                                <!-- チーム名 -->
                                <div id="user-team-display" class="mb-2">
                                    <span class="badge bg-secondary" style="font-size: 0.85rem;">
                                        🏠 <span id="user-team-name">未所属</span>
                                    </span>
                                </div>

                                <!-- 所持金 -->
                                <div id="user-coins-display" class="mb-2"
                                    style="display: none; flex-wrap: wrap; gap: 8px; align-items: center;">
                                    <span class="badge bg-light text-dark shadow-sm"
                                        style="font-size: 0.85rem; border: 1px solid var(--gold); padding: 6px 12px;">
                                        所持金: 🪙 <span id="user-coins-value">0</span>
                                    </span>
                                    <span class="badge bg-light text-dark shadow-sm"
                                        style="font-size: 0.85rem; border: 1px solid #17a2b8; padding: 6px 12px;">
                                        総資産: 📊 <span id="total-assets-value">0</span>
                                    </span>
                                    <span class="badge bg-light text-dark shadow-sm"
                                        style="font-size: 0.85rem; border: 1px solid #ffc107; padding: 6px 12px;">
                                        祈願符: 🧧 <span id="user-tickets-value">0</span>
                                    </span>
                                    <div class="d-flex gap-2">
                                        <button id="coin-transfer-btn" onclick="openCoinTransferModal()"
                                            class="btn btn-sm btn-outline-primary"
                                            style="display: none; padding: 2px 8px; font-size: 0.75rem;">
                                            💸 送金
                                        </button>
                                        <button id="possessions-btn" onclick="openPossessionsModal()"
                                            class="btn btn-sm btn-outline-warning"
                                            style="display: none; padding: 2px 8px; font-size: 0.75rem;">
                                            🎁 所持品
                                        </button>
                                    </div>
                                </div>

                                <!-- 他人の場合のみ表示する表示エリア -->
                                <div id="view-area" class="mt-2" style="display:none;">
                                    <div class="discord-badge">
                                        🀄 麻雀プレイヤー
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 麻雀統計 -->
                    <div class="profile-card mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                            <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0;">
                                🀄 麻雀統計
                            </h4>
                            <div class="d-flex gap-2 flex-wrap">
                                <div class="mahjong-filter-group">
                                    <label class="filter-label-mini">🏆 大会</label>
                                    <select id="tournament-select" class="mahjong-filter-select"
                                        onchange="handleTournamentChange()">
                                        <!-- JSで生成 -->
                                    </select>
                                </div>
                                <div class="mahjong-filter-group">
                                    <label class="filter-label-mini">🀄 形式</label>
                                    <select id="mode-select" class="mahjong-filter-select"
                                        onchange="handleModeChange()">
                                        <option value="all">個人戦（総合）</option>
                                        <option value="individual_yonma">個人戦（四麻）</option>
                                        <option value="individual_sanma">個人戦（三麻）</option>
                                        <option value="team">チーム戦</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="stats-loading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">読み込み中...</span>
                            </div>
                        </div>

                        <div id="stats-content" style="display: none;">
                            <div id="stats-grid">
                                <!-- Row 1: 合計スコア　平均スコア　最大スコア -->
                                <div class="row g-3 mb-3">
                                    <div class="col-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('all')">
                                            <div class="stat-label-mini">合計スコア</div>
                                            <div class="stat-value-mini" id="stat-total">-</div>
                                            <div class="stat-rank" id="rank-total">-</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('avg_score')">
                                            <div class="stat-label-mini">平均スコア</div>
                                            <div class="stat-value-mini" id="stat-avg-score">-</div>
                                            <div class="stat-rank" id="rank-avg-score">-</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('max_score')">
                                            <div class="stat-label-mini">最大スコア</div>
                                            <div class="stat-value-mini" id="stat-max-score">-</div>
                                            <div class="stat-rank" id="rank-max-score">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 2: 和了率　放銃率　バランス雀力 -->
                                <div class="row g-3 mb-3">
                                    <div class="col-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('win')">
                                            <div class="stat-label-mini">和了率</div>
                                            <div class="stat-value-mini" id="stat-win-rate">-</div>
                                            <div class="stat-rank" id="rank-win-rate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('deal')">
                                            <div class="stat-label-mini">放銃率</div>
                                            <div class="stat-value-mini" id="stat-deal-rate">-</div>
                                            <div class="stat-rank" id="rank-deal-rate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('skill')">
                                            <div class="stat-label-mini">バランス雀力</div>
                                            <div class="stat-value-mini" id="stat-skill">-</div>
                                            <div class="stat-rank" id="rank-skill">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 3: 平均順位　トップ率　ラス回避率 -->
                                <div class="row g-3 mb-3">
                                    <div class="col-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('avg_rank')">
                                            <div class="stat-label-mini">平均順位</div>
                                            <div class="stat-value-mini" id="stat-avg-rank">-</div>
                                            <div class="stat-rank" id="rank-avg-rank">-</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('top')">
                                            <div class="stat-label-mini">トップ率</div>
                                            <div class="stat-value-mini" id="stat-top-rate">-</div>
                                            <div class="stat-rank" id="rank-top-rate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('avoid')">
                                            <div class="stat-label-mini">ラス回避率</div>
                                            <div class="stat-value-mini" id="stat-avoid-rate">-</div>
                                            <div class="stat-rank" id="rank-avoid-rate">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 4: 試合数　局数　レーティング -->
                                <div class="row g-3">
                                    <div class="col-4">
                                        <div class="stat-card-mini" onclick="redirectToRanking('match_count')">
                                            <div class="stat-label-mini">試合数</div>
                                            <div class="stat-value-mini" id="stat-games">-</div>
                                            <div class="stat-rank" id="rank-games">-</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-card-mini" style="cursor: default;">
                                            <div class="stat-label-mini">局数</div>
                                            <div class="stat-value-mini" id="stat-hands">-</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="stat-card-mini"
                                            style="background: linear-gradient(135deg, #f3e5f5, #fff); cursor: default;">
                                            <div class="stat-label-mini">📊 レーティング</div>
                                            <div class="stat-value-mini" id="stat-rating">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="no-stats-msg" class="text-center text-muted py-3" style="display: none;">
                                まだ麻雀大会に参加していません
                            </div>
                        </div>
                    </div>

                    <!-- バッジコレクション -->
                    <div class="profile-card mb-4" id="badge-collection-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0;">
                                📛 バッジコレクション
                            </h4>
                            <div class="d-flex gap-2">
                                <button id="badge-transfer-btn" onclick="openBadgeSelectionModal('transfer')"
                                    class="btn btn-sm btn-outline-primary" style="display: none;">
                                    譲渡
                                </button>
                                <button id="badge-sell-btn" onclick="openBadgeSelectionModal('sell')"
                                    class="btn btn-sm btn-outline-danger" style="display: none;">
                                    売却
                                </button>
                                <button id="badge-change-btn" onclick="openBadgeChangeModal()"
                                    class="btn btn-sm btn-outline-secondary" style="display: none;">
                                    装着
                                </button>
                            </div>
                        </div>

                        <!-- 非売品バッジ -->
                        <div id="special-badges-section" style="display: none;">
                            <h6 class="text-muted mb-2" style="font-size: 0.85rem;">🏆 限定バッジ</h6>
                            <div id="special-badge-list" class="row g-3 mb-4">
                                <!-- JSで生成 -->
                            </div>
                        </div>

                        <!-- 換金品（御神石など） -->
                        <div id="convertible-badges-section" style="display: none;">
                            <h6 class="text-muted mb-2" style="font-size: 0.85rem;">💎 換金品</h6>
                            <div id="convertible-badge-list" class="row g-3 mb-4">
                                <!-- JSで生成 -->
                            </div>
                        </div>

                        <!-- 購入バッジ -->
                        <div id="purchasable-badges-section" style="display: none;">
                            <h6 class="text-muted mb-2" style="font-size: 0.85rem;">🛒 購入バッジ</h6>
                            <div id="purchasable-badge-list" class="row g-3">
                                <!-- JSで生成 -->
                            </div>
                        </div>

                        <div id="no-badges-msg" class="text-center text-muted py-3" style="display: none;">
                            まだバッジを持っていません
                        </div>
                    </div>

                    <!-- 販売実績セクション -->
                    <div class="profile-card mb-4" id="revenue-section" style="display: none;">
                        <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0 0 15px 0;">
                            💰 販売実績
                        </h4>
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="stat-card-mini">
                                    <div class="stat-label-mini">累計収益</div>
                                    <div class="stat-value-mini" id="total-revenue" style="color: #27ae60;">0</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card-mini">
                                    <div class="stat-label-mini">販売回数</div>
                                    <div class="stat-value-mini" id="revenue-count">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 最近の活動セクション (deployed 2026-01-12 13:27) -->
                    <div class="profile-card mb-4" id="activity-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                            <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0;">
                                📋 最近の活動
                            </h4>
                            <select id="activity-action-filter" class="form-select form-select-sm"
                                style="width: auto; font-size: 0.8rem;" onchange="loadActivityLogs(1)">
                                <option value="all">🔍 すべて</option>
                                <option value="mahjong">🀄 麻雀</option>
                                <option value="transfer">💸 送金</option>
                                <option value="badge">🎁 バッジ</option>
                                <option value="gacha_draw">⛩️ お賽銭</option>
                                <option value="omikuji">🎋 おみくじ</option>
                                <option value="royalty_receive">💎 売上還元</option>
                            </select>
                        </div>
                        <div id="activity-list">
                            <div class="text-center text-muted py-3">読み込み中...</div>
                        </div>
                        <nav id="activity-pagination-area" class="mt-4" style="display: none;">
                            <ul id="activity-pagination"
                                class="pagination pagination-sm justify-content-center pagination-premium"></ul>
                        </nav>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- バッジ変更モーダル -->
    <div class="modal fade" id="badgeChangeModal" tabindex="-1" aria-labelledby="badgeChangeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="badgeChangeModalLabel">装着バッジを変更</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <span class="badge bg-primary me-2" id="badge-position-indicator">◀ 左に装着</span>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="badge-position" id="pos-left" value="left"
                                checked>
                            <label class="btn btn-outline-primary btn-sm" for="pos-left">◀ 左</label>
                            <input type="radio" class="btn-check" name="badge-position" id="pos-right" value="right">
                            <label class="btn btn-outline-primary btn-sm" for="pos-right">右 ▶</label>
                        </div>
                    </div>
                    <div id="badge-modal-list" class="row g-2">
                        <!-- JSで生成 -->
                    </div>
                </div>
                <div class="text-center mt-3 d-grid gap-2">
                    <button class="btn btn-primary" id="btn-execute-equip" onclick="executeSelectedEquip()"
                        disabled>選択したバッジを装着</button>
                </div>
                <div class="text-center mt-3 d-flex justify-content-center gap-2">
                    <button class="btn btn-outline-danger btn-sm" onclick="equipBadge(null, 'left')">左を外す</button>
                    <button class="btn btn-outline-danger btn-sm" onclick="equipBadge(null, 'right')">右を外す</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- ニックネーム編集モーダル -->
    <div class="modal fade" id="nicknameModal" tabindex="-1" aria-labelledby="nicknameModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nicknameModalLabel">ニックネーム変更</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label small text-muted">ランキング等で表示される名前</label>
                    <input type="text" id="user-nickname" class="form-control mb-3" placeholder="ニックネームを入力...">
                    <div class="d-grid gap-2">
                        <button onclick="useDiscordName()" class="btn btn-outline-secondary btn-sm">
                            Discord名を使用
                        </button>
                        <button onclick="saveNickname()" class="btn btn-gold text-white fw-bold">
                            保存
                        </button>
                    </div>
                    <div id="save-msg" class="small mt-2 text-center" style="display:none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ローディング -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- 所持品モーダル -->
    <div class="modal fade" id="possessionsModal" tabindex="-1" aria-labelledby="possessionsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="possessionsModalLabel">🎁 あなたの所持品</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6 class="fw-bold border-bottom pb-2">チケット</h6>
                        <div
                            class="d-flex align-items-center justify-content-between p-3 bg-light rounded shadow-sm border">
                            <div class="d-flex align-items-center gap-2">
                                <span style="font-size: 1.5rem;">🧧</span>
                                <div>
                                    <div class="fw-bold" style="color: var(--deep-purple);">祈願符</div>
                                    <div class="small text-muted">お賽銭（ガチャ）を1回引けます</div>
                                </div>
                            </div>
                            <div class="fs-4 fw-bold text-primary"><span id="modal-tickets-count">0</span> 枚</div>
                        </div>
                    </div>

                    <div>
                        <h6 class="fw-bold border-bottom pb-2">引換券</h6>
                        <div id="exchange-tickets-list" class="row g-3">
                            <!-- JSで生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase -->
    <!-- バッジ譲渡・売却用バッジ選択モーダル -->
    <div class="modal fade" id="badgeActionModal" tabindex="-1" aria-labelledby="badgeActionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="badgeActionModalLabel">バッジを選択</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="action-badge-list" class="row g-2">
                        <!-- JSで生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ユーザー選択モーダル (譲渡・送金用) -->
    <div class="modal fade" id="userSelectModal" tabindex="-1" aria-labelledby="userSelectModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userSelectModalLabel">譲渡先のユーザーを選択</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="transfer-user-list" class="list-group list-group-flush">
                        <!-- JSで生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- コイン送金金額入力モーダル -->
    <div class="modal fade" id="coinAmountModal" tabindex="-1" aria-labelledby="coinAmountModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="coinAmountModalLabel">送金金額を入力</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="coin-transfer-target-name" class="fw-bold text-center mb-3"></p>
                    <div class="mb-3">
                        <label class="form-label">送金するコイン数</label>
                        <input type="number" id="coin-transfer-amount" class="form-control" placeholder="金額..." min="1">
                        <div class="form-text mt-2 text-center">あなたの所持金: 🪙 <span id="my-coins-ref">0</span></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" onclick="executeCoinTransfer()">送金する</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase設定 -->
    <script src="../js/supabase-config.js?v=20260112"></script>
    <script src="../js/auth-guard.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            initAccordionNav('../');
        });
    </script>

    <script>
        let isViewMode = false;
        let targetId = null;
        let allProfiles = []; // 全ユーザーのプロファイルリスト
        let rarityThresholds = []; // レアリティ境界データ

        /**
         * ページ初期化
         */
        async function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('user');

            // 全ユーザー情報を取得（名前解決用）
            const [profilesRes, thresholdsRes] = await Promise.all([
                supabaseClient.from('profiles').select('discord_user_id, account_name, avatar_url, coins'),
                supabaseClient.from('rarity_thresholds').select('*').order('threshold_value', { ascending: true })
            ]);
            if (profilesRes.data) allProfiles = profilesRes.data;
            if (thresholdsRes.data) rarityThresholds = thresholdsRes.data;

            const user = await getCurrentUser();
            const myId = user?.user_metadata?.provider_id;

            // なりすまし中のユーザー情報を取得
            const impersonated = getImpersonatedUser();
            const effectiveId = impersonated ? impersonated.discord_user_id : myId;

            // URLパラメータがある場合
            if (urlUserId) {
                targetId = urlUserId;
                // 自分でもなりすまし対象でもない場合は閲覧モード
                if (urlUserId !== myId && urlUserId !== (impersonated?.discord_user_id)) {
                    isViewMode = true;
                } else {
                    isViewMode = false;
                }
            } else {
                // URLパラメータがない場合は有効なユーザーID（なりすまし優先）
                targetId = effectiveId;
                isViewMode = false;
            }

            // UIの基本表示切り替え
            setupUI();

            // データの読み込み
            if (isViewMode) {
                await loadTargetUserInfo();
            } else {
                if (user) {
                    await displayMyInfo(user);
                } else {
                    showLoginPrompt();
                    return;
                }
            }

            // 麻雀統計の読み込み（共有ロジック）
            await loadMahjongStats();

            // バッジコレクションの読み込み
            await loadOwnedBadges();

            // 販売実績の読み込み
            await loadRevenueStats();

            // 最近の活動の読み込み
            await loadActivityLogs();
        }

        function setupUI() {
            const loginPrompt = document.getElementById('login-prompt');
            const profileContent = document.getElementById('profile-content');
            const viewArea = document.getElementById('view-area');
            const syncBtn = document.getElementById('sync-btn');
            const pageTitleLabel = document.getElementById('page-title-label');
            const pageHeader = document.querySelector('.page-header');
            const nicknameEditBtn = document.getElementById('nickname-edit-btn');

            if (profileContent) profileContent.style.display = 'block';
            if (loginPrompt) loginPrompt.style.display = 'none';

            if (isViewMode) {
                // 閲覧モード設定
                if (viewArea) viewArea.style.display = 'block';
                if (syncBtn) syncBtn.style.display = 'none';
                if (pageTitleLabel) pageTitleLabel.style.display = 'block';
                if (pageHeader) pageHeader.textContent = '👤 プレイヤープロフィール';
                if (nicknameEditBtn) nicknameEditBtn.style.display = 'none';
            } else {
                // マイページ設定
                if (viewArea) viewArea.style.display = 'none';
                if (syncBtn) syncBtn.style.display = 'inline-block';
                if (pageTitleLabel) pageTitleLabel.style.display = 'none';
                if (pageHeader) pageHeader.textContent = '👤 マイページ';
                if (nicknameEditBtn) nicknameEditBtn.style.display = 'inline-block';
                const coinTransferBtn = document.getElementById('coin-transfer-btn');
                if (coinTransferBtn) coinTransferBtn.style.display = 'inline-block';
                const possessionsBtn = document.getElementById('possessions-btn');
                if (possessionsBtn) possessionsBtn.style.display = 'inline-block';
            }
        }

        function showLoginPrompt() {
            document.getElementById('login-prompt').style.display = 'block';
            document.getElementById('profile-content').style.display = 'none';
        }

        /**
         * 自分（またはなりすましユーザー）の情報を表示
         */
        async function displayMyInfo(user) {
            const discordUser = user.user_metadata;
            const impersonated = getImpersonatedUser();

            // ユーザー情報の取得（バッジ情報・コイン・チーム情報を含む）
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('account_name, avatar_url, coins, total_assets, gacha_tickets, exchange_tickets, equipped_badge_id, equipped_badge_id_right, team_id, badges!equipped_badge_id(image_url, name), badges_right:badges!equipped_badge_id_right(image_url, name), teams!team_id(team_name)')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            // allProfiles にも最新情報を同期
            if (profile) {
                const pIdx = allProfiles.findIndex(p => p.discord_user_id === targetId);
                if (pIdx !== -1) {
                    allProfiles[pIdx] = { ...allProfiles[pIdx], ...profile };
                }
            }

            // アバター（なりすまし中はDBから、そうでなければDiscord）
            const avatarUrl = impersonated
                ? (profile?.avatar_url || 'https://via.placeholder.com/150')
                : (discordUser.avatar_url || 'https://via.placeholder.com/150');
            document.getElementById('user-avatar').src = avatarUrl;

            // 名前（なりすまし中はなりすましユーザー名を優先）
            const name = impersonated
                ? (impersonated.name || profile?.account_name || 'ユーザー')
                : (profile?.account_name || discordUser.full_name || discordUser.name || 'ユーザー');
            const coins = profile?.coins || 0;

            // 名前のみ表示（バッジは別要素）
            document.getElementById('user-name').textContent = name;

            // 左バッジ画像を設定
            const badgeImg = document.getElementById('user-equipped-badge');
            const badge = profile?.badges;
            if (badgeImg && badge) {
                badgeImg.src = badge.image_url;
                badgeImg.title = badge.name;
                badgeImg.style.display = 'block';
            } else if (badgeImg) {
                badgeImg.style.display = 'none';
            }

            // 右バッジ画像を設定
            const badgeImgRight = document.getElementById('user-equipped-badge-right');
            const badgeRight = profile?.badges_right;
            if (badgeImgRight && badgeRight) {
                badgeImgRight.src = badgeRight.image_url;
                badgeImgRight.title = badgeRight.name;
                badgeImgRight.style.display = 'block';
            } else if (badgeImgRight) {
                badgeImgRight.style.display = 'none';
            }

            // チーム名を設定
            const teamNameEl = document.getElementById('user-team-name');
            if (teamNameEl) {
                const team = profile?.teams;
                teamNameEl.textContent = team?.team_name || '未所属';
            }

            // コイン表示の更新
            const coinsDisplay = document.getElementById('user-coins-display');
            const coinsValue = document.getElementById('user-coins-value');
            const totalAssetsValue = document.getElementById('total-assets-value');
            const ticketsValue = document.getElementById('user-tickets-value');
            if (coinsDisplay && coinsValue) {
                coinsValue.textContent = coins.toLocaleString();
                // 総資産は loadBadgeCollection で計算後に更新される（ここでは設定しない）
                if (totalAssetsValue) {
                    totalAssetsValue.textContent = '-';
                }
                if (ticketsValue) {
                    ticketsValue.textContent = (profile?.gacha_tickets || 0).toLocaleString();
                }
                coinsDisplay.style.display = 'block';
            }

            // ニックネーム編集ボタンを表示
            const nicknameEditBtn = document.getElementById('nickname-edit-btn');
            if (nicknameEditBtn) {
                nicknameEditBtn.style.display = 'inline-block';
            }

            if (profile?.account_name) {
                document.getElementById('user-nickname').value = profile.account_name;
            }
        }

        // ニックネーム編集モーダルを開く
        function openNicknameModal() {
            const modalEl = document.getElementById('nicknameModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }

        /**
         * 他人の情報を取得して表示
         */
        async function loadTargetUserInfo() {
            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('*, badges!equipped_badge_id(image_url, name), badges_right:badges!equipped_badge_id_right(image_url, name), teams!team_id(team_name)')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            // allProfiles にも最新情報を同期
            if (profile) {
                const pIdx = allProfiles.findIndex(p => p.discord_user_id === targetId);
                if (pIdx !== -1) {
                    allProfiles[pIdx] = { ...allProfiles[pIdx], ...profile };
                }

                // 装着バッジが所持されているか確認（所持していなければ自動で外す）
                if (!isViewMode && (profile.equipped_badge_id || profile.equipped_badge_id_right)) {
                    const { data: ownedBadges } = await supabaseClient
                        .from('user_badges_new')
                        .select('badge_id')
                        .eq('user_id', targetId);

                    const ownedIds = (ownedBadges || []).map(b => b.badge_id);
                    let updateNeeded = {};

                    if (profile.equipped_badge_id && !ownedIds.includes(profile.equipped_badge_id)) {
                        updateNeeded.equipped_badge_id = null;
                    }
                    if (profile.equipped_badge_id_right && !ownedIds.includes(profile.equipped_badge_id_right)) {
                        updateNeeded.equipped_badge_id_right = null;
                    }

                    if (Object.keys(updateNeeded).length > 0) {
                        await supabaseClient
                            .from('profiles')
                            .update(updateNeeded)
                            .eq('discord_user_id', targetId);
                        // 更新したらプロフィールを再取得
                        return loadTargetUserInfo();
                    }
                }
            }

            if (profile) {
                document.getElementById('user-avatar').src = profile.avatar_url || 'https://via.placeholder.com/150';

                // 名前を設定
                document.getElementById('user-name').textContent = profile.account_name || '名称未設定';

                // 左バッジ画像を設定
                const badgeImg = document.getElementById('user-equipped-badge');
                const badge = profile?.badges;
                if (badgeImg && badge) {
                    badgeImg.src = badge.image_url;
                    badgeImg.title = badge.name;
                    badgeImg.style.display = 'block';
                } else if (badgeImg) {
                    badgeImg.style.display = 'none';
                }

                // 右バッジ画像を設定
                const badgeImgRight = document.getElementById('user-equipped-badge-right');
                const badgeRight = profile?.badges_right;
                if (badgeImgRight && badgeRight) {
                    badgeImgRight.src = badgeRight.image_url;
                    badgeImgRight.title = badgeRight.name;
                    badgeImgRight.style.display = 'block';
                } else if (badgeImgRight) {
                    badgeImgRight.style.display = 'none';
                }

                // チーム名を設定
                const teamNameEl = document.getElementById('user-team-name');
                if (teamNameEl) {
                    const team = profile?.teams;
                    teamNameEl.textContent = team?.team_name || '未所属';
                }

                // コイン表示の更新
                const coins = profile?.coins || 0;
                const coinsDisplay = document.getElementById('user-coins-display');
                const coinsValue = document.getElementById('user-coins-value');
                const totalAssetsValue = document.getElementById('total-assets-value');
                const ticketsValue = document.getElementById('user-tickets-value');
                if (coinsDisplay && coinsValue) {
                    coinsValue.textContent = coins.toLocaleString();
                    // 総資産は loadBadgeCollection で計算後に更新される
                    // 読み込み前は「-」を表示
                    if (totalAssetsValue) {
                        totalAssetsValue.textContent = '-';
                    }
                    if (ticketsValue) {
                        ticketsValue.textContent = (profile?.gacha_tickets || 0).toLocaleString();
                    }
                    coinsDisplay.style.display = 'block';
                }
            } else {
                document.getElementById('user-name').textContent = 'Unknown Player';
            }
        }

        async function useDiscordName() {
            const user = await getCurrentUser();
            if (!user) return;
            const discordUser = user.user_metadata;
            const discordDisplayName = discordUser.custom_claims?.global_name || discordUser.full_name || discordUser.name;
            document.getElementById('user-nickname').value = discordDisplayName;
        }

        async function updateAvatar() {
            const user = await getCurrentUser();
            if (!user || isViewMode) return;

            const btn = document.getElementById('sync-btn');
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = '更新中...';

            try {
                const discordUser = user.user_metadata;
                const avatarUrl = discordUser.avatar_url || discordUser.picture || '';

                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        avatar_url: avatarUrl,
                        updated_at: new Date().toISOString()
                    })
                    .eq('discord_user_id', targetId);

                if (error) throw error;

                alert('アバター画像を更新しました！');
                document.getElementById('user-avatar').src = avatarUrl;
            } catch (err) {
                console.error('Error:', err);
                alert('エラーが発生しました');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function saveNickname() {
            if (isViewMode) return;

            const newNickname = document.getElementById('user-nickname').value.trim();
            const msg = document.getElementById('save-msg');

            if (!newNickname) {
                msg.textContent = 'ニックネームを入力してください';
                msg.className = 'small mt-1 text-danger flex-grow-1';
                msg.style.display = 'block';
                setTimeout(() => { msg.style.display = 'none'; }, 3000);
                return;
            }

            msg.style.display = 'block';
            msg.textContent = '保存中...';
            msg.className = 'small mt-1 text-muted flex-grow-1';

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        account_name: newNickname,
                        updated_at: new Date().toISOString()
                    })
                    .eq('discord_user_id', targetId);

                if (error) throw error;

                msg.textContent = '保存しました！';
                msg.className = 'small mt-2 text-center text-success';

                // モーダルを閉じる
                const modalEl = document.getElementById('nicknameModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) {
                    setTimeout(() => {
                        modal.hide();
                        // ユーザー情報を再読み込みしてバッジ付きの名前を更新
                        loadTargetUserInfo();
                    }, 1000);
                }
            } catch (err) {
                console.error('Error updating nickname:', err);
                msg.textContent = 'エラーが発生しました';
                msg.className = 'small mt-2 text-center text-danger';
            }
        }

        // ============ バッジ管理機能 ============


        async function loadOwnedBadges() {
            const section = document.getElementById('badge-collection-section');
            const specialSection = document.getElementById('special-badges-section');
            const specialList = document.getElementById('special-badge-list');
            const convertibleSection = document.getElementById('convertible-badges-section');
            const convertibleList = document.getElementById('convertible-badge-list');
            const purchasableSection = document.getElementById('purchasable-badges-section');
            const purchasableList = document.getElementById('purchasable-badge-list');
            const noBadgesMsg = document.getElementById('no-badges-msg');
            const netWorthEl = document.getElementById('total-assets-value'); // 総資産ラベルを流用または追加検討。要件は「純資産ランキング」

            if (!section) return;
            section.style.display = 'block';

            try {
                // 所持バッジ（新・個体管理テーブル）と全バッジの流通数を取得
                const [ownedRes, marketCountRes, profileRes, thresholdsRes] = await Promise.all([
                    supabaseClient.from('user_badges_new').select('*, badges(*)').eq('user_id', targetId),
                    supabaseClient.from('user_badges_new').select('badge_id'),
                    supabaseClient.from('profiles').select('coins, equipped_badge_id, equipped_badge_id_right, total_assets').eq('discord_user_id', targetId).maybeSingle(),
                    supabaseClient.from('rarity_thresholds').select('*').order('threshold_value', { ascending: true })
                ]);

                if (ownedRes.error) throw ownedRes.error;
                const thresholds = thresholdsRes.data || [];

                function getDynamicRarity(assetValue, fixedRarity) {
                    if (fixedRarity) return fixedRarity;
                    if (!thresholds || thresholds.length === 0) return '-';
                    let current = thresholds[0].rarity_name;
                    for (const t of thresholds) {
                        if (assetValue >= t.threshold_value) {
                            current = t.rarity_name;
                        } else {
                            break;
                        }
                    }
                    return current;
                }
                const owned = ownedRes.data;
                const profileData = profileRes.data;
                const userCoins = profileData?.coins || 0;
                const equippedId = profileData?.equipped_badge_id;
                const equippedRightId = profileData?.equipped_badge_id_right;

                // 各バッジの現在流通数 n を集計
                const marketCounts = {};
                (marketCountRes.data || []).forEach(s => {
                    marketCounts[s.badge_id] = (marketCounts[s.badge_id] || 0) + 1;
                });

                // 自分のページなら管理ボタンを表示
                const badgeBtn = document.getElementById('badge-change-btn');
                const transferBtn = document.getElementById('badge-transfer-btn');
                const sellBtn = document.getElementById('badge-sell-btn');
                if (!isViewMode) {
                    if (badgeBtn) badgeBtn.style.display = 'inline-block';
                    if (transferBtn) transferBtn.style.display = 'inline-block';
                    if (sellBtn) sellBtn.style.display = 'inline-block';
                }

                if (!owned || owned.length === 0) {
                    if (specialSection) specialSection.style.display = 'none';
                    if (convertibleSection) convertibleSection.style.display = 'none';
                    if (purchasableSection) purchasableSection.style.display = 'none';
                    if (noBadgesMsg) noBadgesMsg.style.display = 'block';
                    // バッジがない場合は所持金のみを総資産として表示
                    const totalAssetsEl = document.getElementById('total-assets-value');
                    if (totalAssetsEl) {
                        totalAssetsEl.textContent = userCoins.toLocaleString();
                    }
                    return;
                }

                // バッジのグルーピング処理 (badge_id ごとにまとめる)
                const groupedOwned = {};
                owned.forEach(item => {
                    const bid = item.badge_id;
                    if (!groupedOwned[bid]) {
                        groupedOwned[bid] = {
                            badge: item.badges,
                            instances: [],
                            isEquippedLeft: false,
                            isEquippedRight: false
                        };
                    }
                    groupedOwned[bid].instances.push(item);
                    if (item.badge_id === equippedId) {
                        groupedOwned[bid].isEquippedLeft = true;
                    }
                    if (item.badge_id === equippedRightId) {
                        groupedOwned[bid].isEquippedRight = true;
                    }
                });

                let totalBadgeAssetValue = 0;
                let purchasableHtml = '';
                let specialHtml = '';
                let convertibleHtml = '';

                // グループ化されたバッジを描画
                Object.values(groupedOwned).forEach(group => {
                    const badge = group.badge;
                    if (!badge) return;

                    const count = group.instances.length;
                    const mainItem = group.instances[0]; // 代表品

                    const n = marketCounts[badge.id] || 0;
                    let pValue;
                    if (badge.sales_type === '変動型') {
                        pValue = Math.ceil(badge.price * Math.pow(1.3, Math.max(0, n - 1)));
                    } else {
                        // 固定型、null、その他は初期価格のまま
                        pValue = badge.price;
                    }
                    const pSell = Math.ceil(pValue * 0.7 * (mainItem.is_mutant ? 3 : 1));

                    // ミュータントは価値3倍で計算、各個体ごとに判定
                    group.instances.forEach(inst => {
                        const multiplier = inst.is_mutant ? 3 : 1;
                        totalBadgeAssetValue += (pValue * multiplier);
                    });

                    const rarity = getDynamicRarity(pValue, badge.fixed_rarity_name);
                    const rarityClass = getRarityClass(rarity);
                    const isEquippedLeft = group.isEquippedLeft;
                    const isEquippedRight = group.isEquippedRight;
                    const isEquipped = isEquippedLeft || isEquippedRight;
                    const hasMutant = group.instances.some(i => i.is_mutant);

                    // 非売品判定: sales_type が '限定品' の場合は非売品
                    const isNonSaleable = (badge.sales_type === '限定品');
                    // 換金品判定
                    const isConvertible = (badge.sales_type === '換金品');

                    // 換金品の場合は簡略表示
                    if (isConvertible) {
                        const fixedSellPrice = badge.price; // 換金品は固定価格
                        // レアリティを取得（一般、良質、希少など）
                        const rarity = badge.fixed_rarity_name || '一般';
                        const rarityClass = getRarityClass(rarity);
                        convertibleHtml += `
                            <div class="col-6 col-sm-4 col-md-3 mb-3">
                                <div class="card h-100 shadow-sm border-0 ${rarityClass}" style="border-radius: 12px; overflow: hidden; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                                    <a href="../badge/index.html?id=${badge.id}" class="text-decoration-none w-100 h-100" style="color: inherit;">
                                        <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center text-center">
                                            <div class="small text-muted mb-1" style="font-size: 0.65rem;">${rarity}</div>
                                            <div class="d-flex align-items-center justify-content-center mb-2" style="gap: 8px;">
                                                <div style="width: 70px; height: 70px;">
                                                    <img src="${badge.image_url}" alt="${badge.name}" style="width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));">
                                                </div>
                                                <span class="badge bg-dark" style="font-size:0.75rem; padding: 4px 8px;">×${count}</span>
                                            </div>
                                            <div class="small fw-bold text-truncate w-100" style="font-size: 0.75rem; line-height: 1.2;">${badge.name}</div>
                                            <div class="small text-muted mt-1" style="font-size: 0.7rem;">💰 ${fixedSellPrice.toLocaleString()} C</div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        `;
                        return; // 換金品は通常バッジセクションに含めない
                    }

                    // 以下、通常バッジの表示ロジック（変更なし）
                    // 右下に個数を表示するためのラベル
                    const countLabel = count > 1 ? `<span class="badge bg-dark position-absolute bottom-0 end-0 m-1" style="font-size:0.6rem; z-index:4; opacity: 0.9;">x${count}</span>` : '';

                    const cardHtml = `
                        <div class="col-4 col-sm-3 col-md-5th mb-3">
                            <div class="card h-100 shadow-sm border-0 position-relative badge-card ${rarityClass}" style="border-radius: 12px; overflow: hidden; transition: transform 0.2s; color: inherit;" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
                                <a href="../badge/index.html?id=${badge.id}${hasMutant ? '&view=mutant' : ''}" class="text-decoration-none w-100 h-100 d-flex flex-column align-items-center justify-content-center" style="color: inherit;">
                                    <div class="card-body p-2 d-flex flex-column align-items-center justify-content-center text-center">
                                        <div class="position-relative mb-1">
                                            <div class="badge-item ${isEquipped ? 'equipped' : ''} ${hasMutant ? 'badge-image-container mutant-active' : ''}" style="width: 70px; height: 70px; padding: 5px; background: transparent; border-width: 2px; border-radius: 50%;">
                                                <img src="${badge.image_url}" alt="${badge.name}" style="width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2)); ${hasMutant ? 'position: relative; z-index: 1;' : ''}">
                                                ${hasMutant ? '<div class="mutant-shine-overlay"></div>' : ''}
                                            </div>
                                            ${isEquipped ? `
                                                <span class="badge bg-gold position-absolute top-0 start-0 d-flex align-items-center justify-content-center" style="font-size:0.4rem; z-index:2; min-width: 45px; height: 16px; transform: translate(-10%, -10%);">
                                                    ${isEquippedLeft && isEquippedRight ? '◀左右▶' : (isEquippedLeft ? '◀左 装着' : '右 装着▶')}
                                                </span>` : ''}
                                            ${countLabel}
                                        </div>
                                        <div class="small opacity-75 text-truncate w-100 px-1" style="font-size: 0.65rem; line-height: 1.2;">${badge.name}</div>
                                        <span class="badge mt-1" style="background: rgba(0,0,0,0.2); font-size: 0.45rem; padding: 2px 5px;">${rarity}</span>
                                    </div>
                                </a>
                                
                                ${(!isViewMode && !isNonSaleable) ? `
                                    <div class="dropdown position-absolute top-0 end-0" style="z-index: 5;">
                                        <button class="btn btn-link btn-sm p-1" data-bs-toggle="dropdown" style="font-size: 0.7rem; color: inherit; opacity: 0.5;">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0" style="font-size: 0.75rem; min-width: 80px;">
                                            <li><a class="dropdown-item py-1" href="javascript:void(0)" onclick="openBadgeSelectionModal('sell')">売却</a></li>
                                            <li><a class="dropdown-item py-1" href="javascript:void(0)" onclick="openBadgeSelectionModal('transfer')">譲渡</a></li>
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;

                    if (!isNonSaleable) {
                        purchasableHtml += cardHtml;
                    } else {
                        specialHtml += cardHtml;
                    }
                });

                // 表示の出し分け
                if (purchasableHtml) {
                    purchasableSection.style.display = 'block';
                    purchasableList.innerHTML = purchasableHtml;
                } else {
                    purchasableSection.style.display = 'none';
                }

                if (specialHtml) {
                    specialSection.style.display = 'block';
                    specialList.innerHTML = specialHtml;
                } else {
                    specialSection.style.display = 'none';
                }

                if (convertibleHtml) {
                    convertibleSection.style.display = 'block';
                    convertibleList.innerHTML = convertibleHtml;
                } else {
                    convertibleSection.style.display = 'none';
                }

                noBadgesMsg.style.display = 'none';

                // 総資産（所持金 + バッジ価値）を更新
                const calculatedTotalAssets = userCoins + totalBadgeAssetValue;
                const totalAssetsEl = document.getElementById('total-assets-value');
                if (totalAssetsEl) {
                    totalAssetsEl.textContent = calculatedTotalAssets.toLocaleString();
                }

            } catch (err) {
                console.error('バッジ取得エラー:', err);
                if (noBadgesMsg) {
                    noBadgesMsg.textContent = '読み込み中にエラーが発生しました';
                    noBadgesMsg.style.display = 'block';
                }
            }
        }

        // ============ 販売実績の読み込み ============
        async function loadRevenueStats() {
            const section = document.getElementById('revenue-section');
            if (!section) return;

            try {
                // royalty_receive（売上還元）のログを取得
                const { data: logs, error } = await supabaseClient
                    .from('activity_logs')
                    .select('amount')
                    .eq('user_id', targetId)
                    .eq('action_type', 'royalty_receive');

                if (error) {
                    console.log('Activity logs table may not exist yet:', error);
                    return;
                }

                if (!logs || logs.length === 0) {
                    // 販売実績がない場合は非表示のまま
                    return;
                }

                section.style.display = 'block';

                const totalRevenue = logs.reduce((sum, log) => sum + (log.amount || 0), 0);
                document.getElementById('total-revenue').textContent = `🪙 ${totalRevenue.toLocaleString()}`;
                document.getElementById('revenue-count').textContent = logs.length;

            } catch (err) {
                console.error('販売実績取得エラー:', err);
            }
        }

        // ============ 最近の活動ログの読み込み ============
        let activityPage = 0;
        const ACTIVITY_PER_PAGE = 10;

        async function loadActivityLogs(page = 1) {
            const listEl = document.getElementById('activity-list');
            const paginationEl = document.getElementById('activity-pagination');
            const section = document.getElementById('activity-section');
            if (!listEl) return;

            const itemsPerPage = 10;
            const from = (page - 1) * itemsPerPage;
            const to = from + itemsPerPage - 1;

            console.log('--- loadActivityLogs start ---', { targetId, page, from, to });

            try {
                const targetProfile = allProfiles.find(u => u.discord_user_id === targetId);
                const targetName = targetProfile?.account_name;
                const actionFilter = document.getElementById('activity-action-filter')?.value || 'all';

                // バッジ情報の取得 (gacha_draw表示用) - これはキャッシュしてもいいが一旦そのまま
                let badgeMap = {};
                try {
                    const { data: badgesData } = await supabaseClient
                        .from('badges')
                        .select('id, name, image_url');
                    if (badgesData) {
                        badgesData.forEach(b => badgeMap[b.id] = b);
                    }
                } catch (e) { console.error('バッジ情報取得エラー:', e); }

                // サーバーサイド・フィルタリングを適用
                // 1. 活動ログ (送金・おみくじ等)
                let logsQuery = supabaseClient
                    .from('activity_logs')
                    .select('*', { count: 'exact' })
                    .eq('user_id', targetId) // 最初から本人のみ
                    .order('created_at', { ascending: false });

                // 不要なログを除外（queryで除外できるものはここでする）
                // mahjong(DB用), admin_edit は表示しない
                logsQuery = logsQuery.not('action_type', 'in', '("mahjong","admin_edit","badge_equip")');

                // フィルター適用
                if (actionFilter !== 'all') {
                    if (actionFilter === 'transfer') {
                        logsQuery = logsQuery.in('action_type', ['transfer_send', 'transfer_receive']);
                    } else if (actionFilter === 'badge') {
                        logsQuery = logsQuery.in('action_type', ['badge_transfer', 'badge_receive', 'badge_sell', 'badge_purchase']);
                    } else if (actionFilter === 'mahjong') {
                        // 麻雀記録はここでは取得しない（matchesで取得）
                        logsQuery = logsQuery.eq('action_type', 'none_xyz');
                    } else {
                        logsQuery = logsQuery.eq('action_type', actionFilter);
                    }
                }

                // 2. 麻雀記録
                let matchesQuery = supabaseClient
                    .from('match_results')
                    .select('*', { count: 'exact' })
                    .or(`discord_user_id.eq.${targetId}${targetName ? `,account_name.eq.${targetName},nickname.eq.${targetName},player_name.eq.${targetName}` : ''}`)
                    .order('event_datetime', { ascending: false });

                // 麻雀フィルター時はログを取得しない
                const showMatches = actionFilter === 'all' || actionFilter === 'mahjong';

                // 3. 過去大会
                let legacyQuery = supabaseClient
                    .from('tournament_player_stats_snapshot')
                    .select('*', { count: 'exact' })
                    .or(`discord_user_id.eq.${targetId}${targetName ? `,account_name.eq.${targetName},nickname.eq.${targetName},player_name.eq.${targetName}` : ''}`);

                // 同時実行して結果をマージするが、ページネーションのためにある程度多めに取得する。
                // 複数のテーブルをマージする場合、正確なページネーションは難しいが、
                // 本人のデータのみに絞っているため、以前の500件よりは全件に近いデータが取得できる。
                const [logsRes, matchesRes, legacyRes] = await Promise.all([
                    logsQuery.limit(200),
                    showMatches ? matchesQuery.limit(200) : Promise.resolve({ data: [] }),
                    showMatches ? legacyQuery.limit(100) : Promise.resolve({ data: [] })
                ]);

                let combined = [];

                if (logsRes.data) {
                    logsRes.data.forEach(l => {
                        let details = l.details;
                        if (typeof details === 'string') { try { details = JSON.parse(details); } catch (e) { } }
                        if (details?.is_internal) return; // 内部的なものは除外
                        combined.push({ ...l, details, timestamp: new Date(l.created_at), isMatch: false });
                    });
                }

                if (matchesRes.data) {
                    matchesRes.data.forEach(m => {
                        combined.push({
                            action_type: 'mahjong', amount: null, match_id: m.match_id,
                            timestamp: new Date(m.event_datetime),
                            details: {
                                rank: m.rank,
                                final_score: m.final_score,
                                mode: m.mahjong_mode,
                                tournament_type: m.tournament_type,
                                match_mode: m.match_mode
                            },
                            isMatch: true
                        });
                    });
                }

                if (legacyRes.data) {
                    legacyRes.data.forEach(m => {
                        combined.push({
                            action_type: 'mahjong', amount: null, match_id: 'legacy-' + Math.random(),
                            timestamp: new Date(m.created_at || m.updated_at || '2024-01-01'),
                            details: {
                                rank: null,
                                final_score: m.score_total,
                                mode: '【第一回麻雀大会】',
                                is_legacy: true
                            },
                            isMatch: true
                        });
                    });
                }

                combined.sort((a, b) => b.timestamp - a.timestamp);

                if (combined.length === 0) {
                    listEl.innerHTML = `<div class="text-center text-muted py-3" > 活動ログはまだありません</div> `;
                    section.style.display = 'block';
                    paginationEl.style.display = 'none';
                    return;
                }

                section.style.display = 'block';

                // ページネーション（マージした後の仮想ページネーション）
                const totalPages = Math.ceil(combined.length / itemsPerPage);
                const pageItems = combined.slice((page - 1) * itemsPerPage, page * itemsPerPage);

                const typeNames = {
                    'mahjong': '🀄 麻雀記録',
                    'transfer_send': '💸 送金(送)',
                    'transfer_receive': '🧧 送金(受)',
                    'badge_transfer': '🎁 バッジ譲渡',
                    'badge_receive': '📦 バッジ受取',
                    'badge_sell': '💴 バッジ売却',
                    'badge_purchase': '🛒 バッジ購入',
                    'omikuji': '🎋 おみくじ',
                    'royalty_receive': '💎 売上還元',
                    'gacha_draw': '⛩️ お賽銭'
                };

                listEl.innerHTML = pageItems.map(log => {
                    const date = log.timestamp.toLocaleString('ja-JP', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                    const typeName = typeNames[log.action_type] || log.action_type;

                    // 金額表示の構築
                    let amountStr = '';
                    if (log.isMatch) {
                        // 麻雀の場合はスコアを右側に表示
                        const score = log.details?.final_score || 0;
                        const scoreFormatted = Number(score) >= 0 ? `+${score}` : `${score}`;
                        amountStr = `<span class="text-secondary">${scoreFormatted} pts</span>`;
                    } else {
                        const isTicketOmikuji = log.action_type === 'omikuji' && log.details?.ticket_reward;
                        // ガチャでコイン0の場合は祈願符（チケット）使用なので🎫-1表示
                        const isTicketGacha = log.action_type === 'gacha_draw' && log.amount === 0;
                        amountStr = isTicketGacha ? '🎫 -1' : (log.amount !== null && (!isTicketOmikuji || log.amount !== 0)) ? `🪙 ${log.amount.toLocaleString()}` : '';
                    }

                    // 相手の情報を取得（基本は target_user_id。常に最新のプロフィールを参照）
                    const otherId = log.target_user_id;
                    const otherProfile = otherId ? allProfiles.find(p => p.discord_user_id === String(otherId)) : null;

                    const otherHtml = otherProfile ? `
                        <div class="d-inline-flex align-items-center gap-1 mx-1" >
                            <img src="${otherProfile.avatar_url || 'https://cdn.discordapp.com/embed/avatars/0.png'}"
                                class="rounded-circle shadow-sm" style="width: 24px; height: 24px; object-fit: cover;">
                                <span class="fw-bold">${otherProfile.account_name || '誰か'}</span>
                            </div>` : (otherId ? ` <span class="badge bg-secondary" > ID: ${otherId}</span> ` : '');

                    let detailsStr = '';
                    if (log.isMatch) {
                        const rank = log.details?.rank;
                        const mode = log.details?.mode || ''; // mahjong_mode
                        const tType = log.details?.tournament_type || '';
                        const mMode = log.details?.match_mode || '';

                        // 大会種別の表示用ラベル
                        const tLabel = mMode ? `${mMode} ` : (tType.includes('個人') ? '個人戦' : (tType.includes('団体') ? '団体戦' : tType));
                        const tPrefix = tLabel ? `<span class="text-muted small me-1" > [${tLabel}]</span> ` : '';

                        // 過去大会（legacy）の場合は順位を非表示
                        const showRank = !log.details?.is_legacy && rank !== null && rank !== undefined;

                        detailsStr = `
                        <div class="d-inline-flex align-items-center flex-wrap" >
                            ${tPrefix}
                            <span class="fw-bold text-dark me-2">${mode}</span>
                            ${showRank ? `<span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-25 me-2" style="font-size: 0.8rem;">${rank}位</span>` : ''}
                        </div>
                        `;
                    } else if (log.action_type === 'transfer_send') {
                        detailsStr = `➡ ${otherHtml} への送金`;
                    } else if (log.action_type === 'transfer_receive') {
                        detailsStr = `⬅ ${otherHtml} からの送金`;
                    } else if (log.action_type === 'badge_transfer') {
                        detailsStr = `🎁 「${log.details?.badge_name || 'バッジ'}」を ${otherHtml} へ譲渡`;
                    } else if (log.action_type === 'badge_receive') {
                        detailsStr = `📦 「${log.details?.badge_name || 'バッジ'}」を ${otherHtml} から受取`;
                    } else if (log.action_type === 'badge_sell') {
                        detailsStr = `💴 「${log.details?.badge_name || 'バッジ'}」を売却`;
                    } else if (log.action_type === 'badge_purchase') {
                        detailsStr = `🛒 「${log.details?.badge_name || 'バッジ'}」を購入`;
                    } else if (log.action_type === 'omikuji') {
                        const tr = log.details?.ticket_reward;
                        const rank = log.details?.rank || '不明';
                        if (tr) {
                            detailsStr = `🎋 運勢: <strong>${rank}</strong> <span class="badge bg-warning text-dark ms-1" style="font-size: 0.75rem;">🎫 +${tr}枚 祈願符</span>`;
                        } else {
                            detailsStr = `🎋 運勢: <strong>${rank}</strong>`;
                        }
                    } else if (log.action_type === 'royalty_receive') {
                        detailsStr = `💎 「${log.details?.badge_name || 'バッジ'}」の売買還元 ${otherId ? `(by ${otherHtml})` : ''} `;
                    } else if (log.action_type === 'admin_edit') {
                        detailsStr = `⚙️ 管理者による${log.amount >= 0 ? '加算' : '減算'} `;
                    } else if (log.action_type === 'gacha_draw') {
                        const bId = log.badge_id;
                        const resultName = log.details?.result_name || log.details?.name || 'アイテム';
                        const resultType = log.details?.result_type || log.details?.type;

                        if (bId && badgeMap[bId]) {
                            const badge = badgeMap[bId];
                            detailsStr = `
                        <div class="d-inline-flex align-items-center gap-1" >
                            <img src="${badge.image_url}" style="width: 30px; height: 30px; object-fit: contain;" title="${badge.name}">
                                <span>${badge.name} を獲得</span>
                            </div>
                    `;
                        } else {
                            let icon = '🎁';
                            if (resultType === 'exchange_ticket') icon = '🎫';
                            else if (resultType === 'stone') icon = '💠';

                            detailsStr = `${icon} ${resultName} を獲得`;
                        }
                    }

                    // バッジ関連のログで、detailsにbadge_idがないがlog本体にある場合のアイコン表示
                    const bId = log.badge_id;
                    if (['badge_transfer', 'badge_receive', 'badge_sell', 'badge_purchase'].includes(log.action_type) && bId && badgeMap[bId]) {
                        const badge = badgeMap[bId];
                        const originalDetails = detailsStr;
                        detailsStr = `
                            <div class="d-inline-flex align-items-center gap-1">
                                <img src="${badge.image_url}" style="width: 24px; height: 24px; object-fit: contain;" title="${badge.name}">
                                <span>${originalDetails}</span>
                            </div>
                        `;
                    }

                    return `
                        <div class="activity-item-card" >
                            <span class="activity-date">${date}</span>
                            <div class="row align-items-center g-2">
                                <div class="col">
                                    <div class="d-flex flex-wrap align-items-center gap-2">
                                        <span class="activity-type-badge">${typeName}</span>
                                        <span class="activity-details">${detailsStr}</span>
                                    </div>
                                </div>
                                <div class="col-auto text-end">
                                    <span class="activity-amount ${log.amount > 0 ? 'text-success' : log.amount < 0 ? 'text-danger' : ''}">${amountStr}</span>
                                </div>
                            </div>
                        </div>
                        `;
                }).join('');

                // 6. ページネーションUI
                const paginationArea = document.getElementById('activity-pagination-area');
                if (totalPages > 1) {
                    let pagHtml = '';
                    for (let i = 1; i <= totalPages; i++) {
                        pagHtml += `
                        <li class="page-item ${i === page ? 'active' : ''}">
                            <a class="page-link shadow-sm" href="javascript:void(0)" onclick="loadActivityLogs(${i})">${i}</a>
                        </li>`;
                    }
                    paginationEl.innerHTML = pagHtml;
                    if (paginationArea) paginationArea.style.display = 'block';
                } else {
                    if (paginationArea) paginationArea.style.display = 'none';
                }

            } catch (err) {
                console.error('Activity logs error:', err);
                listEl.innerHTML = '<div class="text-center text-danger py-3">エラーが発生しました</div>';
            }
        }

        // ============ バッジ譲渡・売却：バッジ選択モーダル ============
        // ============ バッジ譲渡・売却：バッジ選択モーダル ============
        async function openBadgeSelectionModal(mode) {
            const listEl = document.getElementById('action-badge-list');
            listEl.innerHTML = '<p class="text-center text-muted py-3">読み込み中...</p>';

            document.getElementById('badgeActionModalLabel').textContent = mode === 'transfer' ? '譲渡するバッジを選択' : '売却するバッジを選択';

            const modalEl = document.getElementById('badgeActionModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();

            try {
                // 所持バッジの取得（新テーブル user_badges_new を使用）
                const { data: owned, error } = await supabaseClient
                    .from('user_badges_new')
                    .select('*, badges(*)')
                    .eq('user_id', targetId);

                if (error) throw error;

                // 全バッジの流通数を取得（価格計算用）
                const { data: marketCountRes } = await supabaseClient
                    .from('user_badges_new')
                    .select('badge_id');

                const marketCounts = {};
                (marketCountRes || []).forEach(s => {
                    marketCounts[s.badge_id] = (marketCounts[s.badge_id] || 0) + 1;
                });

                if (!owned || owned.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-muted py-3">対象のバッジを持っていません</p>';
                    return;
                }

                // 非売品（限定品）を除外
                let targetBadges = owned.filter(item => item.badges && item.badges.sales_type !== '限定品');

                // 譲渡モードの場合のみ換金品を除外
                if (mode === 'transfer') {
                    targetBadges = targetBadges.filter(item => item.badges && item.badges.sales_type !== '換金品');
                }

                if (targetBadges.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-muted py-3">譲渡・売却可能なバッジを持っていません</p>';
                    return;
                }

                // 換金品と通常バッジを分離
                const convertibleGroups = new Map();
                const normalItems = [];

                targetBadges.forEach(item => {
                    if (!item.badges) return;

                    if (item.badges.sales_type === '換金品') {
                        const badgeId = item.badges.id;
                        if (!convertibleGroups.has(badgeId)) {
                            convertibleGroups.set(badgeId, {
                                badge: item.badges,
                                count: 0
                            });
                        }
                        convertibleGroups.get(badgeId).count++;
                    } else {
                        normalItems.push(item);
                    }
                });

                let htmlParts = [];

                // 換金品のHTML生成（グループ化）
                convertibleGroups.forEach(group => {
                    const badge = group.badge;
                    const count = group.count;
                    const sellPrice = badge.price;
                    const totalSell = sellPrice * count;

                    htmlParts.push(`
                        <div class="user-select-item" onclick="openConvertibleSellModal('${badge.id}', '${badge.name.replace(/'/g, "\\'")}', ${count}, ${sellPrice})">
                            <img src="${badge.image_url}" class="user-select-avatar" style="border-radius: 8px;">
                            <div class="flex-grow-1">
                                <div class="user-select-name">${badge.name} <span class="badge bg-dark">×${count}</span></div>
                                <div class="small text-muted" style="font-size: 0.75rem;">
                                    売却: 🪙${sellPrice.toLocaleString()} C × ${count} = 🪙${totalSell.toLocaleString()} C
                                </div>
                            </div>
                            <div class="text-danger fw-bold">売却</div>
                        </div>
                    `);
                });

                // 通常バッジの処理
                listEl.innerHTML = htmlParts.join('') + normalItems.map(item => {
                    const badge = item.badges;
                    if (!badge) return '';

                    const n = marketCounts[badge.id] || 0;

                    // 価格計算: sales_type に基づく
                    let pValue;
                    if (badge.sales_type === '変動型') {
                        pValue = Math.ceil(badge.price * Math.pow(1.3, Math.max(0, n - 1)));
                    } else {
                        // 固定型、null、その他は初期価格のまま
                        pValue = badge.price;
                    }

                    const pSell = Math.ceil(pValue * 0.7 * (item.is_mutant ? 3 : 1));
                    const buyPrice = item.purchased_price || 0;

                    const mutantLabel = item.is_mutant ? '<span class="text-warning fw-bold">(Mutant)</span>' : '';

                    if (mode === 'transfer') {
                        return `
                    <div class="user-select-item" onclick="openUUIDTransferModal('${item.uuid}', '${badge.name.replace(/'/g, "\\'")}', ${buyPrice}, ${pValue}, ${pSell})">
                        <img src="${badge.image_url}" class="user-select-avatar" style="border-radius: 8px;">
                                <div class="flex-grow-1">
                                    <div class="user-select-name">${badge.name} ${mutantLabel}</div>
                                    <div class="small text-muted" style="font-size: 0.75rem;">
                                        購入: 🪙${buyPrice.toLocaleString()} | 
                                        時価: 🪙${pValue.toLocaleString()} | 
                                        売却: 🪙${pSell.toLocaleString()}
                                    </div>
                                </div>
                                <div class="text-primary fw-bold">選択</div>
                            </div>
                    `;
                    } else {
                        return `
                    <div class="user-select-item" onclick="sellBadgeConfirm('${item.uuid}', '${badge.name.replace(/'/g, "\\'")}', ${buyPrice}, ${pValue}, ${pSell})">
                        <img src="${badge.image_url}" class="user-select-avatar" style="border-radius: 8px;">
                                <div class="flex-grow-1">
                                    <div class="user-select-name">${badge.name} ${mutantLabel}</div>
                                    <div class="small text-muted" style="font-size: 0.75rem;">
                                        購入: 🪙${buyPrice.toLocaleString()} | 
                                        時価: 🪙${pValue.toLocaleString()} | 
                                        売却: 🪙${pSell.toLocaleString()}
                                    </div>
                                </div>
                                <div class="text-danger fw-bold">売却</div>
                            </div>
                    `;
                    }
                }).join('');
            } catch (err) {
                console.error('Error loading action badges:', err);
                listEl.innerHTML = '<p class="text-center text-danger py-3">エラーが発生しました</p>';
            }
        }

        // ======= バッジ売却・譲渡 =======
        let currentActionUUID = null;
        let currentActionBadgeName = null;
        let currentActionDetails = null;

        function sellBadgeConfirm(uuid, name, purchasedPrice, pValue, pSell) {
            currentActionUUID = uuid;
            currentActionBadgeName = name;

            // 安全な数値変換とデフォルト値設定
            const pPrice = Number(purchasedPrice) || 0;
            const pVal = Number(pValue) || 0;
            const sPrice = Number(pSell) || 0;
            const profit = sPrice - pPrice;
            const profitStr = (profit >= 0 ? '+' : '') + profit.toLocaleString();

            const msg = `「${name}」を売却しますか？\n\n` +
                `・購入時の金額: 🪙 ${pPrice.toLocaleString()} \n` +
                `・現在の市場価値: 🪙 ${pVal.toLocaleString()} \n` +
                `・実際の売却価格: 🪙 ${sPrice.toLocaleString()} \n` +
                `--------------------------\n` +
                `・予想損益: ${profitStr} `;

            if (confirm(msg)) {
                // 選択モーダルを閉じる
                const modalEl = document.getElementById('badgeActionModal');
                if (modalEl) {
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                }
                executeSellUUID();
            }
        }

        async function executeSellUUID() {
            toggleLoading(true);
            try {
                const { data, error } = await supabaseClient.rpc('sell_badge_v2', {
                    p_user_id: targetId,
                    p_badge_uuid: currentActionUUID
                });

                if (error) throw error;
                if (!data.ok) throw new Error(data.error);

                alert(`バッジを 🪙${data.sell_price.toLocaleString()} で売却しました。`);
                // 活動ログ記録
                if (typeof logActivity === 'function') {
                    // バッジID(整数)を取得
                    const { data: bInfo } = await supabaseClient.from('user_badges_new').select('badge_id').eq('uuid', currentActionUUID).single();
                    const bId = bInfo?.badge_id;

                    await logActivity(targetId, 'badge_sell', {
                        amount: data.sell_price,
                        badgeId: bId, // 整数IDを追加
                        details: { badge_uuid: currentActionUUID, badge_name: currentActionBadgeName }
                    });
                }
                // モーダルを閉じる
                const modalEl = document.getElementById('badgeActionModal');
                if (modalEl) {
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                }
                loadOwnedBadges();
                loadActivityLogs();
                // 自分の情報を再読み込み
                const user = await getCurrentUser();
                if (user) displayMyInfo(user);
            } catch (err) {
                console.error('売却エラー:', err);
                alert('売却に失敗しました: ' + err.message);
            } finally {
                toggleLoading(false);
            }
        }

        // ============ 換金品の売却 ============
        async function openConvertibleSellModal(badgeId, badgeName, totalCount, fixedPrice) {
            const quantity = prompt(`「${badgeName}」を何個売却しますか？（所持数: ${totalCount} 個、売却価格: ${fixedPrice.toLocaleString()} C / 個）`, '1');

            if (!quantity) return;

            const count = parseInt(quantity);
            if (isNaN(count) || count <= 0) {
                alert('有効な個数を入力してください。');
                return;
            }

            if (count > totalCount) {
                alert(`所持数（${totalCount} 個）を超えています。`);
                return;
            }

            const totalPrice = fixedPrice * count;
            if (!confirm(`「${badgeName}」を ${count} 個売却しますか？（合計: 💰${totalPrice.toLocaleString()} C）`)) return;

            toggleLoading(true);
            try {
                // 所持している換金品の UUID を取得
                const { data: ownedItems, error: fetchError } = await supabaseClient
                    .from('user_badges_new')
                    .select('uuid')
                    .eq('user_id', targetId)
                    .eq('badge_id', badgeId)
                    .limit(count);

                if (fetchError) throw fetchError;
                if (!ownedItems || ownedItems.length < count) throw new Error('指定した数のバッジが見つかりません。');

                // 一つずつ売却
                let successCount = 0;
                for (const item of ownedItems) {
                    const { data, error } = await supabaseClient.rpc('sell_badge_v2', {
                        p_user_id: targetId,
                        p_badge_uuid: item.uuid
                    });

                    if (error || !data.ok) {
                        console.error('売却エラー:', error || data.error);
                        continue;
                    }
                    successCount++;
                }

                if (successCount > 0) {
                    const actualTotalPrice = fixedPrice * successCount;
                    alert(`「${badgeName}」を ${successCount} 個売却しました。（合計: 💰${actualTotalPrice.toLocaleString()} C）`);

                    // 活動ログ記録
                    if (typeof logActivity === 'function') {
                        await logActivity(targetId, 'badge_sell', {
                            amount: actualTotalPrice,
                            details: {
                                badge_id: badgeId,
                                badge_name: badgeName,
                                quantity: successCount,
                                unit_price: fixedPrice
                            }
                        });
                    }

                    // モーダルを閉じる
                    const modalEl = document.getElementById('badgeActionModal');
                    if (modalEl) {
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        if (modal) modal.hide();
                    }
                    loadOwnedBadges();
                    loadActivityLogs();
                    loadTargetUserInfo(); // 装着バッジが売却された場合自動で外す
                    const user = await getCurrentUser();
                    if (user) displayMyInfo(user);
                } else {
                    throw new Error('売却に失敗しました。');
                }
            } catch (err) {
                console.error('換金品売却エラー:', err);
                alert('売却に失敗しました: ' + err.message);
            } finally {
                toggleLoading(false);
            }
        }

        function openUUIDTransferModal(uuid, name, purchasedPrice, pValue, pSell) {
            currentActionUUID = uuid;
            currentActionBadgeName = name;

            // 譲渡時にも詳細情報を表示するために詳細文字列を構築
            currentActionDetails =
                `・購入額: 🪙 ${purchasedPrice.toLocaleString()} \n` +
                `・現在価値: 🪙 ${pValue.toLocaleString()} \n` +
                `・期待売却額: 🪙 ${pSell.toLocaleString()} \n` +
                `--------------------------\n` +
                `※譲渡するとあなたの手元からはなくなります。`;

            // 選択モーダルを閉じる
            const modalEl = document.getElementById('badgeActionModal');
            if (modalEl) bootstrap.Modal.getInstance(modalEl)?.hide();
            openUserSelectModal('badge_transfer');
        }

        // 譲渡実行のオーバーライド（共有されている openUserSelectModal から呼ばれる）
        // 既存の executeTransferConfirmation は badge_id ベースの可能性があるため、UUID対応版に差し替えが必要な場合は
        // ここで再定義するか、グローバルに調整する。mypage/index.html 内に定義されている場合、それを上書きする。

        // ============ バッジ装着 ============
        let selectedBadgeIdForEquip = null;

        function selectBadgeInModal(badgeId) {
            selectedBadgeIdForEquip = badgeId;
            document.querySelectorAll('#badge-modal-list .badge-item').forEach(el => {
                el.classList.remove('selected');
            });
            const targetEl = document.querySelector(`.badge-item[data-badge-id="${badgeId}"]`);
            if (targetEl) targetEl.classList.add('selected');

            const btn = document.getElementById('btn-execute-equip');
            if (btn) btn.disabled = false;
        }

        async function executeSelectedEquip() {
            if (!selectedBadgeIdForEquip) return;
            const posRadio = document.querySelector('input[name="badge-position"]:checked');
            const position = posRadio ? posRadio.value : 'left';

            toggleLoading(true);
            await equipBadge(selectedBadgeIdForEquip, position);
            toggleLoading(false);

            selectedBadgeIdForEquip = null;
        }

        async function equipBadge(badgeId, position = null) {
            if (isViewMode) return;

            // positionが指定されていない場合はラジオボタンの値を取得
            if (!position) {
                const posRadio = document.querySelector('input[name="badge-position"]:checked');
                position = posRadio ? posRadio.value : 'left';
            }

            const columnName = position === 'right' ? 'equipped_badge_id_right' : 'equipped_badge_id';

            // 現在の装着状況を確認
            const { data: current } = await supabaseClient
                .from('profiles')
                .select('equipped_badge_id, equipped_badge_id_right')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            // 同じバッジをクリックした場合は外す
            const currentBadgeId = position === 'right' ? current?.equipped_badge_id_right : current?.equipped_badge_id;
            const oppositeBadgeId = position === 'right' ? current?.equipped_badge_id : current?.equipped_badge_id_right;
            const oppositeColumn = position === 'right' ? 'equipped_badge_id' : 'equipped_badge_id_right';

            const newBadgeId = (currentBadgeId === badgeId) ? null : badgeId;

            // 反対側のスロットに同じバッジが装着されている場合は移動（反対側を外す）
            let updateData = { [columnName]: newBadgeId };
            if (badgeId && badgeId === oppositeBadgeId) {
                updateData[oppositeColumn] = null; // 反対側を外す
            }

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update(updateData)
                    .eq('discord_user_id', targetId);

                if (error) throw error;

                await loadOwnedBadges(); // リスト更新
                await loadTargetUserInfo(); // 名前横のバッジ更新

                // モーダルを閉じる
                const modalEl = document.getElementById('badgeChangeModal');
                bootstrap.Modal.getInstance(modalEl)?.hide();
            } catch (err) {
                console.error('装着エラー:', err);
                alert('バッジの変更に失敗しました');
            }
        }

        // 装着バッジの変更モーダル
        async function openBadgeChangeModal() {
            selectedBadgeIdForEquip = null;
            const btnExec = document.getElementById('btn-execute-equip');
            if (btnExec) btnExec.disabled = true;

            const listEl = document.getElementById('badge-modal-list');
            listEl.innerHTML = '<p class="text-center text-muted py-3">読み込み中...</p>';

            // ラジオボタンのイベントリスナー（1回だけ設定）
            const posRadios = document.querySelectorAll('input[name="badge-position"]');
            posRadios.forEach(radio => {
                if (!radio.dataset.listenerAdded) {
                    radio.addEventListener('change', (e) => {
                        const indicator = document.getElementById('badge-position-indicator');
                        if (indicator) {
                            indicator.textContent = e.target.value === 'left' ? '◀ 左に装着' : '右に装着 ▶';
                        }
                    });
                    radio.dataset.listenerAdded = "true";
                }
            });

            // 初期化
            const leftRadio = document.getElementById('pos-left');
            const indicator = document.getElementById('badge-position-indicator');
            if (indicator) {
                if (leftRadio && leftRadio.checked) {
                    indicator.textContent = '◀ 左に装着';
                } else {
                    indicator.textContent = '右に装着 ▶';
                }
            }

            const modalEl = document.getElementById('badgeChangeModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();

            try {
                // 所持バッジ（ユニークなIDのみ抽出）
                const { data: owned, error } = await supabaseClient
                    .from('user_badges_new')
                    .select('badge_id, badges(*)')
                    .eq('user_id', targetId);

                if (error) throw error;

                const uniqueBadges = [];
                const seen = new Set();
                owned.forEach(item => {
                    if (item.badges && !seen.has(item.badge_id)) {
                        uniqueBadges.push(item.badges);
                        seen.add(item.badge_id);
                    }
                });

                const { data: profile } = await supabaseClient
                    .from('profiles').select('equipped_badge_id, equipped_badge_id_right').eq('discord_user_id', targetId).maybeSingle();
                const equippedLeftId = profile?.equipped_badge_id;
                const equippedRightId = profile?.equipped_badge_id_right;

                if (uniqueBadges.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-muted py-3">バッジを持っていません</p>';
                    return;
                }

                listEl.innerHTML = uniqueBadges.map(badge => {
                    const isEquippedLeft = badge.id === equippedLeftId;
                    const isEquippedRight = badge.id === equippedRightId;
                    const isEquipped = isEquippedLeft || isEquippedRight;

                    let posLabel = '';
                    if (isEquippedLeft) posLabel = '◀左';
                    if (isEquippedRight) posLabel = '右▶';
                    if (isEquippedLeft && isEquippedRight) posLabel = '◀左右▶';

                    return `
                    <div class="col-4 col-md-3 text-center" >
                            <div class="badge-item ${isEquipped ? 'equipped' : ''}"
                                data-badge-id="${badge.id}"
                                onclick="selectBadgeInModal('${badge.id}')"
                                style="cursor: pointer; position: relative;"
                                title="${badge.name}${isEquipped ? ' (装着中)' : ''}">
                                <img src="${badge.image_url}" alt="${badge.name}" style="width: 60px; height: 60px; object-fit: contain;">
                                ${isEquipped ? `<span class="position-absolute top-0 start-50 translate-middle badge bg-primary" style="font-size: 0.6rem; z-index: 10;">${posLabel}</span>` : ''}
                            </div>
                            <div class="small text-truncate mt-1" style="font-size: 0.7rem;">${badge.name}</div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('バッジ読み込みエラー:', err);
                listEl.innerHTML = '<p class="text-center text-danger py-3">エラーが発生しました</p>';
            }
        }

        // ============ 麻雀統計機能 ============
        let allMahjongRecords = [];
        let myAccountName = '';
        let currentMyTournament = '第二回麻雀大会';

        async function loadMahjongStats() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const targetUserId = urlParams.get('user');

                if (targetUserId) {
                    myAccountName = targetUserId;
                } else {
                    const user = await getCurrentUser();
                    if (!user) return;
                    myAccountName = user.user_metadata.provider_id;
                }

                const { data: currentData, error: currentError } = await supabaseClient
                    .from('match_results')
                    .select('*');

                if (currentError) console.warn('第二回データ取得エラー:', currentError);

                let legacyData = [];
                try {
                    const { data, error: legacyError } = await supabaseClient
                        .from('tournament_player_stats_snapshot')
                        .select('*');
                    if (!legacyError) legacyData = data || [];
                } catch (e) {
                    console.warn('第一回データ取得スキップ:', e);
                }

                const taggedCurrentData = (currentData || []).map(r => ({ ...r, tournament_type: r.tournament_type || '第二回麻雀大会' }));
                const taggedLegacyData = (legacyData || []).map(r => ({ ...r, tournament_type: r.tournament_type || '第一回麻雀大会' }));

                allMahjongRecords = [...taggedCurrentData, ...taggedLegacyData];
                renderTournamentDropdown();
                displayMahjongStats();
            } catch (err) {
                console.error('麻雀統計取得エラー:', err);
                document.getElementById('stats-loading').style.display = 'none';
                document.getElementById('no-stats-msg').style.display = 'block';
            }
        }

        function renderTournamentDropdown() {
            const select = document.getElementById('tournament-select');
            if (!select) return;
            const tournaments = ['第二回麻雀大会', '第一回麻雀大会'];
            let html = tournaments.map(t => `<option value="${t}" ${currentMyTournament === t ? 'selected' : ''}>${t}</option>`).join('');
            html += `<option value="all" ${currentMyTournament === 'all' ? 'selected' : ''}>全シーズン</option>`;
            select.innerHTML = html;
        }

        function handleTournamentChange() {
            const select = document.getElementById('tournament-select');
            currentMyTournament = select.value;
            displayMahjongStats();
        }

        let currentMahjongMode = 'all'; // 総合/四麻/三麻

        function handleModeChange() {
            const select = document.getElementById('mode-select');
            currentMahjongMode = select.value;
            displayMahjongStats();
        }

        function displayMahjongStats() {
            let records = allMahjongRecords;

            // 大会フィルター
            if (currentMyTournament !== 'all') {
                records = records.filter(r => r.tournament_type === currentMyTournament);
            }

            // メインフィルター（対戦形式）
            if (currentMahjongMode === 'team') {
                // チーム戦はまだデータがないので空配列にする
                records = [];
            } else if (currentMahjongMode === 'individual_yonma') {
                records = records.filter(r => (r.mahjong_mode || r.mode) === '四麻');
            } else if (currentMahjongMode === 'individual_sanma') {
                records = records.filter(r => (r.mahjong_mode || r.mode) === '三麻');
            }
            // 'all' の場合は全ての個人戦データ

            const playerStats = calculateAllPlayerStats(records);
            const myStats = playerStats.find(p => p.name === myAccountName);

            document.getElementById('stats-loading').style.display = 'none';
            document.getElementById('stats-content').style.display = 'block';

            const statsGrid = document.getElementById('stats-grid');
            const noStatsMsg = document.getElementById('no-stats-msg');

            if (!myStats || myStats.games === 0) {
                if (statsGrid) statsGrid.style.display = 'none';
                noStatsMsg.style.display = 'block';
                return;
            }
            if (statsGrid) statsGrid.style.display = 'block';
            noStatsMsg.style.display = 'none';

            const formatScore = (val) => (typeof val !== 'number') ? val : Math.round(val * 10) / 10;
            const games = myStats.games;

            updateStatCard('total', formatScore(myStats.total), playerStats, 'total', true, games);
            updateStatCard('avg-score', formatScore(myStats.avgScore), playerStats, 'avgScore', true, games);
            updateStatCard('max-score', formatScore(myStats.maxScore), playerStats, 'maxScore', true, games);
            updateStatCard('win-rate', myStats.winRate.toFixed(1) + '%', playerStats, 'winRate', true, games);
            updateStatCard('deal-rate', myStats.dealRate.toFixed(1) + '%', playerStats, 'dealRate', false, games);
            updateStatCard('skill', myStats.skill.toFixed(1) + '%', playerStats, 'skill', true, games);
            updateStatCard('avg-rank', myStats.avgRank.toFixed(2), playerStats, 'avgRank', false, games);
            updateStatCard('top-rate', myStats.topRate.toFixed(1) + '%', playerStats, 'topRate', true, games);
            updateStatCard('avoid-rate', myStats.avoidRate.toFixed(1) + '%', playerStats, 'avoidRate', true, games);
            updateStatCard('games', myStats.games, playerStats, 'games', true, games);

            // 局数とレーティング（順位なし）
            const handsEl = document.getElementById('stat-hands');
            if (handsEl) handsEl.textContent = myStats.hands || 0;

            const ratingEl = document.getElementById('stat-rating');
            if (ratingEl) ratingEl.textContent = '-'; // 未実装
        }

        function redirectToRanking(subFilter) {
            // 現在のフィルター設定を取得
            const tournament = currentMyTournament;
            const main = currentMahjongMode;

            // 自分のIDを取得（アンカー用）
            // myAccountName は DiscordID または ニックネームが入っている
            const anchor = `#rank-player-${myAccountName}`;

            // URL構築
            const url = `../mahjong/index.html?tournament=${encodeURIComponent(tournament)}&main=${encodeURIComponent(main)}&sub=${encodeURIComponent(subFilter)}${anchor}`;

            // 遷移
            window.location.href = url;
        }

        function updateStatCard(id, value, allStats, key, higherIsBetter, myGames) {
            const el = document.getElementById('stat-' + id);
            if (el) el.textContent = value;

            // 10試合以上のプレイヤーのみをランキング対象にする
            const qualified = [...allStats].filter(p => p.games >= 10);
            const sorted = qualified.sort((a, b) => higherIsBetter ? b[key] - a[key] : a[key] - b[key]);
            const myRank = sorted.findIndex(p => p.name === myAccountName) + 1;
            const total = sorted.length;

            const rankEl = document.getElementById('rank-' + id);
            const cardEl = el ? el.closest('.stat-card-mini') : null;

            if (cardEl) {
                // 既存のランククラスを削除
                cardEl.classList.remove('rank-1', 'rank-2', 'rank-3');
                // 10試合以上かつ3位以内の場合にクラスを付与
                if (myGames >= 10 && myRank >= 1 && myRank <= 3) {
                    cardEl.classList.add(`rank-${myRank}`);
                }
            }

            if (rankEl) {
                // 自分が10試合未満の場合はランク外
                if (myGames < 10) {
                    rankEl.textContent = 'ランク外';
                    rankEl.classList.add('no-data');
                } else if (myRank > 0) {
                    rankEl.textContent = `${myRank}/${total}位`;
                    rankEl.classList.remove('no-data');
                } else {
                    rankEl.textContent = '-';
                    rankEl.classList.add('no-data');
                }
            }
        }

        function calculateAllPlayerStats(records) {
            const players = {};
            records.forEach(r => {
                let id = r.discord_user_id;
                if (!id || id === 'null') id = r.nickname || r.account_name || 'Unknown';
                if (!id) return;

                if (!players[id]) {
                    players[id] = { name: id, score: 0, sanma: 0, yonma: 0, count: 0, win: 0, deal: 0, r1: 0, r2: 0, r3: 0, r4: 0, max_score: -Infinity, hand_total: 0 };
                }

                const p = players[id];
                const mode = r.mahjong_mode || r.mode || '';

                if (r.tournament_type === '第一回麻雀大会') {
                    p.score += Number(r.score_total || 0);
                    p.count += Number(r.matches_played || 0);
                    p.r1 += Number(r.rank1_count || 0); p.r2 += Number(r.rank2_count || 0); p.r3 += Number(r.rank3_count || 0); p.r4 += Number(r.rank4_count || 0);
                    p.max_score = Math.max(p.max_score, Number(r.score_max || 0));
                    p.hand_total += Number(r.hands_played || 0);
                } else {
                    p.score += Number(r.final_score || 0);
                    p.count += 1;
                    const rk = Number(r.rank);
                    if (rk === 1) p.r1++; else if (rk === 2) p.r2++; else if (rk === 3) p.r3++; else if (rk === 4) p.r4++;
                    p.max_score = Math.max(p.max_score, Number(r.final_score || 0));
                    p.hand_total += Number(r.hand_count || 0);
                }
                p.win += Number(r.win_count || r.wins || 0);
                p.deal += Number(r.deal_in_count || r.deals || 0);
                if (mode === '三麻') p.sanma += Number(r.final_score || r.score_total || 0);
                if (mode === '四麻') p.yonma += Number(r.final_score || r.score_total || 0);
            });

            return Object.values(players).map(p => {
                const count = p.count;
                const hands = p.hand_total;
                return {
                    name: p.name, total: p.score, sanma: p.sanma, yonma: p.yonma,
                    avgScore: count > 0 ? p.score / count : 0,
                    maxScore: p.max_score === -Infinity ? 0 : p.max_score,
                    // 和了率・放銃率は局数ベースで計算（%）
                    winRate: hands > 0 ? (p.win / hands * 100) : 0,
                    dealRate: hands > 0 ? (p.deal / hands * 100) : 0,
                    // バランス雀力 = (和了数 - 放銃数) / 局数 * 100
                    skill: hands > 0 ? ((p.win - p.deal) / hands * 100) : 0,
                    avgRank: count > 0 ? (1 * p.r1 + 2 * p.r2 + 3 * p.r3 + 4 * p.r4) / count : 0,
                    topRate: count > 0 ? (p.r1 / count) * 100 : 0,
                    avoidRate: count > 0 ? (1 - ((p.r4 === 0 && p.r3 > 0 ? p.r3 : p.r4) / count)) * 100 : 0,
                    games: count,
                    hands: hands
                };
            });
        }

        // 戻るボタン
        function goBack() {
            if (document.referrer && document.referrer.includes(location.hostname)) history.back();
            else location.href = '../index.html';
        }

        function toggleLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.classList.toggle('active', show);
        }

        document.addEventListener('DOMContentLoaded', initPage);
    </script>

    <!-- コイン送金とユーザー検索 -->
    <script>
        let currentSelectMode = '';
        async function openUserSelectModal(mode) {
            currentSelectMode = mode;
            const listEl = document.getElementById('transfer-user-list');
            listEl.innerHTML = '<p class="text-center text-muted py-3">読み込み中...</p>';
            new bootstrap.Modal(document.getElementById('userSelectModal')).show();

            try {
                const { data: profiles, error } = await supabaseClient
                    .from('profiles')
                    .select('discord_user_id, account_name, avatar_url, equipped_badge_id, badges!equipped_badge_id(image_url)')
                    .neq('discord_user_id', targetId)
                    .order('account_name');

                if (error) throw error;
                listEl.innerHTML = profiles.map(p => `
                    <div class="user-select-item" onclick="confirmSelection('${p.discord_user_id}', '${p.account_name.replace(/'/g, "\\'")}')">
                        <img src="${p.avatar_url || 'https://cdn.discordapp.com/embed/avatars/0.png'}" class="user-select-avatar">
                        <span class="user-select-name">${p.account_name}</span>
                        ${p.badges ? `<img src="${p.badges.image_url}" class="user-select-badge">` : ''}
                    </div>
                `).join('');
            } catch (err) {
                listEl.innerHTML = '<p class="text-center text-danger py-3">読み込み失敗</p>';
            }
        }

        let selectedToUserId = '';
        let selectedToUserName = '';
        function confirmSelection(id, name) {
            selectedToUserId = id;
            selectedToUserName = name;
            bootstrap.Modal.getInstance(document.getElementById('userSelectModal'))?.hide();
            if (currentSelectMode === 'coin_transfer') {
                document.getElementById('coin-transfer-target-name').textContent = `${name} さんへ送金`;
                // 所持金を表示に反映
                const myProfile = allProfiles.find(p => p.discord_user_id === targetId);
                const currentCoins = (myProfile && myProfile.coins !== undefined) ? myProfile.coins : 0;
                const coinsRefEl = document.getElementById('my-coins-ref');
                if (coinsRefEl) coinsRefEl.textContent = currentCoins.toLocaleString();

                new bootstrap.Modal(document.getElementById('coinAmountModal')).show();
            } else if (currentSelectMode === 'badge_transfer') {
                const msg = `「${currentActionBadgeName}」を ${name} さんに譲渡しますか？\n\n` +
                    (currentActionDetails || '');
                if (confirm(msg)) {
                    executeBadgeTransfer(id, name);
                }
            } else if (currentSelectMode === 'ticket_transfer') {
                executeTicketTransfer(id, name);
            } else if (currentSelectMode === 'gacha_ticket_transfer') {
                executeGachaTicketTransfer(id, name);
            }
        }

        async function executeBadgeTransfer(toUserId, toUserName) {
            toggleLoading(true);
            try {
                // 1. バッジの user_id を変更
                const { error: updateError } = await supabaseClient
                    .from('user_badges_new')
                    .update({ user_id: toUserId })
                    .eq('uuid', currentActionUUID);

                if (updateError) throw updateError;

                // 2. 活動ログを記録
                if (typeof logActivity === 'function') {
                    const sender = allProfiles.find(p => p.discord_user_id === targetId);
                    const senderName = sender?.account_name || '誰か';

                    // バッジID(整数)を取得
                    const { data: bInfo } = await supabaseClient.from('user_badges_new').select('badge_id').eq('uuid', currentActionUUID).single();
                    const bId = bInfo?.badge_id;

                    await logActivity(targetId, 'badge_transfer', {
                        badgeId: bId, // UUIDではなく整数IDを渡す
                        targetUserId: toUserId,
                        details: { target_name: toUserName, badge_name: currentActionBadgeName, badge_uuid: currentActionUUID }
                    });
                    await logActivity(toUserId, 'badge_receive', {
                        badgeId: bId, // UUIDではなく整数IDを渡す
                        targetUserId: targetId,
                        details: { sender_name: senderName, badge_name: currentActionBadgeName, badge_uuid: currentActionUUID }
                    });
                }

                alert(`${toUserName} さんにバッジを譲渡しました！`);
                // ヘッダーの所持金・バッジ情報も更新
                await loadOwnedBadges();
                await loadTargetUserInfo(); // 装着バッジが譲渡された場合自動で外す
                await loadActivityLogs();
                if (!isViewMode) {
                    const user = await getCurrentUser();
                    if (user) await displayMyInfo(user);
                }
            } catch (err) {
                console.error('譲渡エラー:', err);
                alert('譲渡に失敗しました');
            } finally {
                toggleLoading(false);
            }
        }

        async function executeCoinTransfer() {
            const amount = parseInt(document.getElementById('coin-transfer-amount').value);
            if (!amount || amount <= 0) return alert('金額を入力してください');

            toggleLoading(true);
            try {
                const { data, error } = await supabaseClient.rpc('transfer_coins', {
                    p_amount: amount,
                    p_from_id: targetId,
                    p_to_id: selectedToUserId
                });

                if (error) throw error;
                if (!data.ok) throw new Error(data.error || '送金に失敗しました');

                alert(`${selectedToUserName} さんに 🪙${amount.toLocaleString()} 送金しました。`);
                // 活動ログ記録
                if (typeof logActivity === 'function') {
                    const sender = allProfiles.find(p => p.discord_user_id === targetId);
                    const senderName = sender?.account_name || '誰か';

                    await logActivity(targetId, 'transfer_send', {
                        amount: -amount, // 送金はマイナス
                        targetUserId: selectedToUserId,
                        details: { target_name: selectedToUserName }
                    });
                    await logActivity(selectedToUserId, 'transfer_receive', {
                        amount: amount,
                        targetUserId: targetId,
                        details: { sender_name: senderName }
                    });
                }

                // UI更新
                if (!isViewMode) {
                    const user = await getCurrentUser();
                    if (user) await displayMyInfo(user);
                }
                await loadOwnedBadges();
                await loadActivityLogs();
            } catch (err) {
                console.error('送金エラー:', err);
                alert('送金失敗: ' + (err.message || '不明なエラー'));
            } finally {
                toggleLoading(false);
            }
        }

        /**
         * 引換券の譲渡実行
         */
        async function executeTicketTransfer(toUserId, toUserName) {
            const amountStr = prompt(`「${currentTicketRarity}引換券」を何枚譲渡しますか？ (最大: ${currentTicketMax}枚)`, "1");
            if (amountStr === null) return; // キャンセル
            const amount = parseInt(amountStr);
            if (isNaN(amount) || amount <= 0) return alert('有効な枚数を入力してください');
            if (amount > currentTicketMax) return alert('所持数以上の枚数は譲渡できません');

            toggleLoading(true);
            try {
                const { data, error } = await supabaseClient.rpc('transfer_exchange_tickets', {
                    p_from_id: targetId,
                    p_to_id: toUserId,
                    p_rarity: currentTicketRarity,
                    p_amount: amount
                });

                if (error) throw error;
                if (!data.ok) throw new Error(data.error);

                alert(`${toUserName} さんに ${currentTicketRarity}引換券 を ${amount}枚 譲渡しました！`);

                // 活動ログ記録
                if (typeof logActivity === 'function') {
                    const sender = allProfiles.find(p => p.discord_user_id === targetId);
                    const senderName = sender?.account_name || '誰か';

                    await logActivity(targetId, 'badge_transfer', {
                        amount: 0,
                        targetUserId: toUserId,
                        details: { target_name: toUserName, badge_name: `${currentTicketRarity}引換券 x${amount}` }
                    });
                    await logActivity(toUserId, 'badge_receive', {
                        amount: 0,
                        targetUserId: targetId,
                        details: { sender_name: senderName, badge_name: `${currentTicketRarity}引換券 x${amount}` }
                    });
                }

                // UI更新
                await openPossessionsModal();
                await loadActivityLogs();
            } catch (err) {
                console.error('引換券譲渡エラー:', err);
                alert('譲渡に失敗しました: ' + (err.message || '不明なエラー'));
            } finally {
                toggleLoading(false);
            }
        }

        /**
         * 祈願符の譲渡実行
         */
        async function executeGachaTicketTransfer(toUserId, toUserName) {
            const amountStr = prompt(`「祈願符」を何枚譲渡しますか？ (最大: ${currentTicketMax}枚)`, "1");
            if (amountStr === null) return;
            const amount = parseInt(amountStr);
            if (isNaN(amount) || amount <= 0) return alert('有効な枚数を入力してください');
            if (amount > currentTicketMax) return alert('所持数以上の枚数は譲渡できません');

            toggleLoading(true);
            try {
                const { data, error } = await supabaseClient.rpc('transfer_gacha_tickets', {
                    p_from_id: targetId,
                    p_to_id: toUserId,
                    p_amount: amount
                });

                if (error) throw error;
                if (!data.ok) throw new Error(data.error);

                alert(`${toUserName} さんに 祈願符 を ${amount}枚 譲渡しました！`);

                // 活動ログ記録
                if (typeof logActivity === 'function') {
                    const sender = allProfiles.find(p => p.discord_user_id === targetId);
                    const senderName = sender?.account_name || '誰か';

                    await logActivity(targetId, 'badge_transfer', {
                        amount: 0,
                        targetUserId: toUserId,
                        details: { target_name: toUserName, badge_name: `祈願符 x${amount}` }
                    });
                    await logActivity(toUserId, 'badge_receive', {
                        amount: 0,
                        targetUserId: targetId,
                        details: { sender_name: senderName, badge_name: `祈願符 x${amount}` }
                    });
                }

                // UI更新
                await openPossessionsModal();
                await loadActivityLogs();
                // 表示されている祈願符枚数も更新
                const countEl = document.getElementById('user-tickets-value');
                if (countEl) {
                    const current = parseInt(countEl.textContent.replace(/,/g, '')) || 0;
                    countEl.textContent = (current - amount).toLocaleString();
                }
            } catch (err) {
                console.error('祈願符譲渡エラー:', err);
                alert('譲渡に失敗しました: ' + (err.message || '不明なエラー'));
            } finally {
                toggleLoading(false);
            }
        }
        function openCoinTransferModal() { openUserSelectModal('coin_transfer'); }

        /**
         * 所持品モーダルを開く
         */
        async function openPossessionsModal() {
            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('gacha_tickets, exchange_tickets')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            if (error) {
                console.error('所持品取得エラー:', error);
                return;
            }

            const gachaTickets = profile?.gacha_tickets || 0;
            document.getElementById('modal-tickets-count').textContent = gachaTickets.toLocaleString();

            const ticketsParent = document.getElementById('modal-tickets-count').parentElement.parentElement;
            if (!isViewMode && gachaTickets > 0 && !document.getElementById('gacha-ticket-transfer-btn')) {
                const transferBtn = document.createElement('button');
                transferBtn.id = 'gacha-ticket-transfer-btn';
                transferBtn.className = 'btn btn-sm btn-outline-warning rounded-pill py-0 px-2 ms-2';
                transferBtn.style.fontSize = '0.65rem';
                transferBtn.textContent = '🎁 譲渡';
                transferBtn.onclick = () => {
                    currentTicketMax = gachaTickets;
                    const modalEl = document.getElementById('possessionsModal');
                    bootstrap.Modal.getInstance(modalEl)?.hide();
                    openUserSelectModal('gacha_ticket_transfer');
                };
                document.getElementById('modal-tickets-count').parentElement.appendChild(transferBtn);
            } else if (gachaTickets <= 0 && document.getElementById('gacha-ticket-transfer-btn')) {
                document.getElementById('gacha-ticket-transfer-btn').remove();
            }

            const listEl = document.getElementById('exchange-tickets-list');
            const exchanges = profile?.exchange_tickets || {};

            if (Object.keys(exchanges).length === 0) {
                listEl.innerHTML = '<div class="col-12 text-center text-muted py-3">所持している引換券はありません</div>';
            } else {
                listEl.innerHTML = Object.entries(exchanges).map(([rarity, count]) => {
                    if (count <= 0) return '';
                    const rarityClass = getRarityClass(rarity);
                    return `
                        <div class="col-6 mb-3">
                            <div class="card shadow-sm border-0 ${rarityClass} p-2 text-center position-relative" style="border-radius: 12px; border: 1px solid rgba(0,0,0,0.1) !important;">
                                <div class="small fw-bold opacity-75 mb-1">${rarity}引換券</div>
                                <div class="d-flex align-items-center justify-content-center gap-2 mb-2">
                                    <span style="font-size: 1.2rem;">🎫</span>
                                    <div class="fs-5 fw-bold">${count}枚</div>
                                </div>
                                ${!isViewMode ? `
                                    <button class="btn btn-sm btn-outline-dark rounded-pill py-0 px-2" style="font-size: 0.65rem;" 
                                        onclick="initTicketTransfer('${rarity}', ${count})">
                                        🎁 譲渡
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            const modal = new bootstrap.Modal(document.getElementById('possessionsModal'));
            modal.show();
        }

        let currentTicketRarity = '';
        let currentTicketMax = 0;
        function initTicketTransfer(rarity, count) {
            currentTicketRarity = rarity;
            currentTicketMax = count;
            // 所持品モーダルを閉じる
            const modalEl = document.getElementById('possessionsModal');
            bootstrap.Modal.getInstance(modalEl)?.hide();
            openUserSelectModal('ticket_transfer');
        }
    </script>

    <!-- チーム通知バッジ -->
    <script>
        async function checkTeamNotifications() {
            const user = await getCurrentUser();
            if (!user) return;
            const discordId = user.user_metadata.provider_id;
            const { data: myTeams } = await supabaseClient.from('teams').select('id').eq('creator_discord_id', discordId);
            if (!myTeams || myTeams.length === 0) return;

            const teamIds = myTeams.map(t => t.id);
            const { data: pendingRequests } = await supabaseClient.from('team_join_requests').select('id').in('team_id', teamIds).in('status', ['pending', 'leave_pending']);
            const count = pendingRequests?.length || 0;

            if (count > 0) {
                const badge = document.getElementById('team-notification-badge');
                if (badge) {
                    badge.textContent = count;
                    badge.style.display = 'inline';
                }
            }
        }
        document.addEventListener('DOMContentLoaded', checkTeamNotifications);
    </script>
</body>

</html>