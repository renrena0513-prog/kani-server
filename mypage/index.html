<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="„Åã„Å´„Çµ„Éº„Éê„Éº - „Éû„Ç§„Éö„Éº„Ç∏">
    <title>„Éû„Ç§„Éö„Éº„Ç∏ | „Åã„Å´„Çµ„Éº„Éê„Éº„Ç§„Éô„É≥„Éà</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;600;700&family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap"
        rel="stylesheet">

    <!-- Bootswatch Lux (Bootstrap 5.3.3) -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-purple: #6b5b95;
            --deep-purple: #4a3f6b;
            --cream: #faf5e8;
            --gold: #d4a853;
            --btn-gold: #c29544;
            --font-title: 'Noto Serif JP', serif;
            --font-body: 'M PLUS Rounded 1c', sans-serif;
        }

        .btn-gold {
            background-color: var(--gold);
            border: none;
        }

        .btn-gold:hover {
            background-color: var(--btn-gold);
            color: white;
        }


        body {
            font-family: var(--font-body);
            background: linear-gradient(180deg, #6b5b95 0%, #5a4d80 50%, #4a3f6b 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }

        .page-header {
            font-family: var(--font-title);
            color: var(--cream);
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
        }

        .back-button {
            font-family: var(--font-body);
            font-size: 1rem;
            padding: 10px 25px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #fff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .profile-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--gold);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .discord-badge {
            background: linear-gradient(135deg, #43b581, #3ca374);
            color: white;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(67, 181, 129, 0.4);
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid var(--gold);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--deep-purple);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .login-prompt {
            text-align: center;
            padding: 60px 20px;
        }

        .login-prompt-btn {
            background: linear-gradient(135deg, #5865F2, #4752c4);
            color: white;
            padding: 15px 40px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .login-prompt-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(88, 101, 242, 0.4);
        }

        .logout-btn {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 2px solid #dc3545;
            padding: 10px 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc3545;
            color: white;
        }

        /* „Éã„ÉÉ„ÇØ„Éç„Éº„É†ÂÖ•ÂäõÊ¨Ñ */
        .nickname-input {
            background: #fff;
            border: 2px solid #e0d8f0;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 1rem;
            transition: all 0.3s ease;
            color: #333;
        }

        .nickname-input::placeholder {
            color: #aaa;
            font-style: italic;
        }

        .nickname-input:focus {
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 4px rgba(107, 91, 149, 0.15);
            outline: none;
            background: #fff;
        }

        /* „Ç¢„Ç§„Ç≥„É≥Êõ¥Êñ∞„Éú„Çø„É≥ */
        .btn-avatar-update {
            background: linear-gradient(135deg, #5865F2 0%, #4752c4 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(88, 101, 242, 0.3);
        }

        .btn-avatar-update:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(88, 101, 242, 0.5);
            background: linear-gradient(135deg, #6872f4 0%, #5865F2 100%);
        }

        /* Áµ±Ë®à„Éü„Éã„Ç´„Éº„Éâ */
        .stat-card-mini {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }

        .stat-card-mini:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-label-mini {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-value-mini {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--deep-purple);
        }

        .stat-rank {
            font-size: 0.7rem;
            color: #fff;
            background: linear-gradient(135deg, var(--gold), #b8860b);
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 5px;
            display: inline-block;
        }

        .stat-rank.no-data {
            background: #adb5bd;
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <!-- Êàª„Çã„Éú„Çø„É≥ -->
        <div class="mb-4">
            <a href="../index.html" class="back-button">
                ‚Üê „Éõ„Éº„É†„Å´Êàª„Çã
            </a>
        </div>


        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <header class="text-center mb-5">
            <h1 class="page-header display-4 fw-bold mb-3">üë§ „Éû„Ç§„Éö„Éº„Ç∏</h1>
        </header>

        <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">

                <!-- Êú™„É≠„Ç∞„Ç§„É≥ÊôÇ -->
                <div id="login-prompt" class="profile-card login-prompt" style="display: none;">
                    <h3 class="mb-4" style="font-family: var(--font-title); color: var(--deep-purple);">
                        „É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                    </h3>
                    <p class="text-muted mb-4">
                        „Éû„Ç§„Éö„Éº„Ç∏„ÇíË°®Á§∫„Åô„Çã„Å´„ÅØDiscord„Åß„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ
                    </p>
                    <button onclick="loginWithDiscord()" class="login-prompt-btn">
                        <img src="https://assets-global.website-files.com/6257adef93867e50d84d30e2/636e0a69f118df70ad7828d4_icon_clyde_blurple_RGB.svg"
                            alt="Discord" style="width: 24px;">
                        Discord„Åß„É≠„Ç∞„Ç§„É≥
                    </button>
                </div>

                <!-- „É≠„Ç∞„Ç§„É≥Ê∏à„Åø -->
                <div id="profile-content" style="display: none;">
                    <div class="profile-card mb-4">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <div class="text-center">
                                    <img id="user-avatar" src="" alt="„Ç¢„Éê„Çø„Éº" class="avatar-large">
                                    <button onclick="updateAvatar()" class="btn-avatar-update mt-2"
                                        title="Discord„Åã„ÇâÊúÄÊñ∞„ÅÆ„Ç¢„Éê„Çø„ÉºÁîªÂÉè„ÇíÂèñÂæó">
                                        üîÑ ÂêåÊúü
                                    </button>
                                </div>
                            </div>
                            <div class="col">
                                <h2 id="user-name" class="mb-2"
                                    style="font-family: var(--font-title); color: var(--deep-purple);">
                                    „É¶„Éº„Ç∂„ÉºÂêç
                                </h2>
                                <div class="mt-3">
                                    <label class="small text-muted mb-2">„Éã„ÉÉ„ÇØ„Éç„Éº„É† („É©„É≥„Ç≠„É≥„Ç∞Á≠â„ÅßË°®Á§∫)</label>
                                    <input type="text" id="user-nickname" class="form-control nickname-input mb-2"
                                        placeholder="„Çø„ÉÉ„Éó„Åó„Å¶ÂÖ•Âäõ...">
                                    <div class="d-flex gap-2">
                                        <button onclick="useDiscordName()" class="btn btn-outline-secondary btn-sm"
                                            title="Discord„ÅÆË°®Á§∫Âêç„ÇíÂÖ•„Çå„Çã">
                                            <small>DiscordÂêç„Çí‰ΩøÁî®</small>
                                        </button>
                                        <button onclick="saveNickname()"
                                            class="btn btn-gold text-white fw-bold btn-sm">‰øùÂ≠ò</button>
                                    </div>
                                    <div id="save-msg" class="small mt-1" style="display:none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- È∫ªÈõÄÁµ±Ë®à -->
                    <div class="profile-card mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0;">
                                üÄÑ È∫ªÈõÄÁµ±Ë®à
                            </h4>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-primary"
                                    onclick="toggleMySeason('current')">‰ªä„Ç∑„Éº„Ç∫„É≥</button>
                                <button type="button" class="btn btn-outline-primary"
                                    onclick="toggleMySeason('all')">ÂÖ®„Ç∑„Éº„Ç∫„É≥</button>
                            </div>
                        </div>

                        <div id="stats-loading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
                            </div>
                        </div>

                        <div id="stats-content" style="display: none;">
                            <!-- „Çπ„Ç≥„Ç¢Á≥ª -->
                            <div class="row g-3 mb-3">
                                <div class="col-6 col-md-4">
                                    <div class="stat-card-mini">
                                        <div class="stat-label-mini">Á∑èÂêà„Çπ„Ç≥„Ç¢</div>
                                        <div class="stat-value-mini" id="stat-total">-</div>
                                        <div class="stat-rank" id="rank-total">-</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="stat-card-mini">
                                        <div class="stat-label-mini">‰∏âÈ∫ª„Çπ„Ç≥„Ç¢</div>
                                        <div class="stat-value-mini" id="stat-sanma">-</div>
                                        <div class="stat-rank" id="rank-sanma">-</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-4">
                                    <div class="stat-card-mini">
                                        <div class="stat-label-mini">ÂõõÈ∫ª„Çπ„Ç≥„Ç¢</div>
                                        <div class="stat-value-mini" id="stat-yonma">-</div>
                                        <div class="stat-rank" id="rank-yonma">-</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Âπ≥Âùá„ÉªÊúÄÂ§ß„Çπ„Ç≥„Ç¢ -->
                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <div class="stat-card-mini">
                                        <div class="stat-label-mini">Âπ≥Âùá„Çπ„Ç≥„Ç¢</div>
                                        <div class="stat-value-mini" id="stat-avg-score">-</div>
                                        <div class="stat-rank" id="rank-avg-score">-</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-card-mini">
                                        <div class="stat-label-mini">ÊúÄÂ§ß„Çπ„Ç≥„Ç¢</div>
                                        <div class="stat-value-mini" id="stat-max-score">-</div>
                                        <div class="stat-rank" id="rank-max-score">-</div>
                                    </div>
                                </div>
                            </div>

                            <!-- ÁéáÁ≥ª -->
                            <div class="row g-3 mb-3">
                                <div class="col-6 col-md-3">
                                    <div class="stat-card-mini">
                                        <div class="stat-label-mini">Âíå‰∫ÜÁéá</div>
                                        <div class="stat-value-mini" id="stat-win-rate">-</div>
                                        <div class="stat-rank" id="rank-win-rate">-</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="stat-card-mini">
                                        <div class="stat-label-mini">ÊîæÈäÉÁéá</div>
                                        <div class="stat-value-mini" id="stat-deal-rate">-</div>
                                        <div class="stat-rank" id="rank-deal-rate">-</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="stat-card-mini">
                                        <div class="stat-label-mini">„Éà„ÉÉ„ÉóÁéá</div>
                                        <div class="stat-value-mini" id="stat-top-rate">-</div>
                                        <div class="stat-rank" id="rank-top-rate">-</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="stat-card-mini">
                                        <div class="stat-label-mini">„É©„ÇπÂõûÈÅø</div>
                                        <div class="stat-value-mini" id="stat-avoid-rate">-</div>
                                        <div class="stat-rank" id="rank-avoid-rate">-</div>
                                    </div>
                                </div>
                            </div>

                            <!-- È†Ü‰ΩçÁ≥ª -->
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="stat-card-mini">
                                        <div class="stat-label-mini">Âπ≥ÂùáÈ†Ü‰Ωç</div>
                                        <div class="stat-value-mini" id="stat-avg-rank">-</div>
                                        <div class="stat-rank" id="rank-avg-rank">-</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-card-mini">
                                        <div class="stat-label-mini">ÂØæÂ±ÄÊï∞</div>
                                        <div class="stat-value-mini" id="stat-games">-</div>
                                        <div class="stat-rank" id="rank-games">-</div>
                                    </div>
                                </div>
                            </div>

                            <div id="no-stats-msg" class="text-center text-muted py-3" style="display: none;">
                                „Åæ„Å†È∫ªÈõÄÂ§ß‰ºö„Å´ÂèÇÂä†„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- SupabaseË®≠ÂÆö -->
    <script src="../js/supabase-config.js"></script>
    <script src="../js/auth-guard.js"></script>

    <script>
        // „Éû„Ç§„Éö„Éº„Ç∏Áî®„ÅÆË°®Á§∫Âá¶ÁêÜ
        async function displayMyPage() {
            const user = await getCurrentUser();
            const loginPrompt = document.getElementById('login-prompt');
            const profileContent = document.getElementById('profile-content');

            if (user) {
                // „É≠„Ç∞„Ç§„É≥Ê∏à„Åø
                loginPrompt.style.display = 'none';
                profileContent.style.display = 'block';

                const discordUser = user.user_metadata;

                // „Ç¢„Éê„Çø„Éº
                const avatarUrl = discordUser.avatar_url ||
                    `https://cdn.discordapp.com/avatars/${discordUser.provider_id}/${discordUser.avatar}`;
                document.getElementById('user-avatar').src = avatarUrl;

                // „É¶„Éº„Ç∂„ÉºÂêç
                document.getElementById('user-name').textContent =
                    discordUser.full_name || discordUser.name || '„É¶„Éº„Ç∂„Éº';

                // „Éã„ÉÉ„ÇØ„Éç„Éº„É†ÂèñÂæó
                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('account_name')
                    .eq('discord_user_id', discordUser.provider_id)
                    .maybeSingle();
                if (!profileError && profile && profile.account_name) {
                    document.getElementById('user-nickname').value = profile.account_name;
                }

            } else {

                // Êú™„É≠„Ç∞„Ç§„É≥
                loginPrompt.style.display = 'block';
                profileContent.style.display = 'none';
            }
        }

        async function displayUserInfo() {
            const user = await getCurrentUser();
            if (!user) {
                window.location.href = '../index.html';
                return;
            }

            const discordUser = user.user_metadata;
            const discordUserId = discordUser.provider_id;

            // „Ç¢„Éê„Çø„ÉºÁîªÂÉè„Å®Discord ID„ÇíË°®Á§∫
            document.getElementById('user-avatar').src = discordUser.avatar_url || 'https://via.placeholder.com/150';
            // Note: There is no element with id 'discord-id' in the provided HTML.
            // document.getElementById('discord-id').textContent = discordUserId;

            // profiles„ÉÜ„Éº„Éñ„É´„Åã„Çâaccount_name„ÇíÂèñÂæó
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('account_name')
                .eq('discord_user_id', discordUserId)
                .maybeSingle();

            const currentNickname = profile?.account_name || discordUser.full_name || '';
            document.getElementById('user-nickname').value = currentNickname; // Changed from nickname-input to user-nickname
        }

        displayUserInfo();


        async function useDiscordName() {
            const user = await getCurrentUser();
            if (!user) return;
            const discordUser = user.user_metadata;
            // Ë°®Á§∫Âêç„ÇíÂèñÂæó (global_name -> full_name -> name)
            const discordDisplayName = discordUser.custom_claims?.global_name || discordUser.full_name || discordUser.name;
            document.getElementById('user-nickname').value = discordDisplayName;
        }

        async function updateAvatar() {
            const user = await getCurrentUser();
            if (!user) return;

            const btn = document.querySelector('button[onclick="updateAvatar()"]');
            if (!btn) return;

            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Êõ¥Êñ∞‰∏≠...';

            try {
                const discordUser = user.user_metadata;
                const discordUserId = discordUser.provider_id;
                const avatarUrl = discordUser.avatar_url || discordUser.picture || '';

                // profiles„ÉÜ„Éº„Éñ„É´„ÅÆavatar_url„ÇíÊõ¥Êñ∞
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        avatar_url: avatarUrl,
                        updated_at: new Date().toISOString()
                    })
                    .eq('discord_user_id', discordUserId);

                if (error) {
                    console.error('Error updating avatar:', error);
                    alert('„Ç®„É©„Éº: ' + error.message);
                } else {
                    alert('„Ç¢„Éê„Çø„ÉºÁîªÂÉè„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ');
                    // „Ç¢„Éê„Çø„ÉºÁîªÂÉè„ÇíÂÜçË™≠„ÅøËæº„Åø
                    document.getElementById('user-avatar').src = avatarUrl;
                }
            } catch (err) {
                console.error('Error:', err);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // „Éã„ÉÉ„ÇØ„Éç„Éº„É†‰øùÂ≠ò
        document.getElementById('profile-content').addEventListener('click', async (event) => {
            if (event.target.closest('.btn-gold')) { // Check if the clicked element or its parent is the save button
                const user = await getCurrentUser();
                if (!user) return;

                const newNickname = document.getElementById('user-nickname').value.trim(); // Changed from nickname-input to user-nickname
                const msg = document.getElementById('save-msg');

                if (!newNickname) {
                    msg.textContent = '„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                    msg.className = 'small mt-1 text-danger';
                    msg.style.display = 'block';
                    setTimeout(() => { msg.style.display = 'none'; }, 3000);
                    return;
                }

                const discordUserId = user.user_metadata.provider_id;

                msg.style.display = 'block';
                msg.textContent = '‰øùÂ≠ò‰∏≠...';
                msg.className = 'small mt-1 text-muted';

                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ account_name: newNickname, updated_at: new Date().toISOString() })
                    .eq('discord_user_id', discordUserId);

                if (error) {
                    console.error('Error updating nickname:', error);
                    msg.textContent = '„Ç®„É©„Éº: ' + error.message;
                    msg.className = 'small mt-1 text-danger';
                } else {
                    msg.textContent = '‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ';
                    msg.className = 'small mt-1 text-success';
                    displayUserInfo(); // Refresh info after saving
                    setTimeout(() => { msg.style.display = 'none'; }, 2000);
                }
            }
        });

        // ============ È∫ªÈõÄÁµ±Ë®àÊ©üËÉΩ ============
        let allMahjongRecords = [];
        let myAccountName = '';
        let mySeasonMode = 'current'; // 'current' or 'all'

        async function loadMahjongStats() {
            try {
                // URL„Éë„É©„É°„Éº„Çø„Åã„ÇâÁâπÂÆö„É¶„Éº„Ç∂„ÉºID„ÇíÂèñÂæóÔºàÁÆ°ÁêÜËÄÖÁî®Ôºâ
                const urlParams = new URLSearchParams(window.location.search);
                const targetUserId = urlParams.get('user');

                if (targetUserId) {
                    // ÁâπÂÆö„É¶„Éº„Ç∂„Éº„ÅÆÁµ±Ë®à„ÇíË°®Á§∫
                    myAccountName = targetUserId;
                } else {
                    // Ëá™ÂàÜ„ÅÆÁµ±Ë®à„ÇíË°®Á§∫
                    const user = await getCurrentUser();
                    if (!user) return;
                    myAccountName = user.user_metadata.provider_id;
                }

                // Á¨¨‰∫åÂõûÈ∫ªÈõÄÂ§ß‰ºö„Éá„Éº„Çø
                const { data: currentData, error: currentError } = await supabaseClient
                    .from('match_results')
                    .select('*');

                if (currentError) {
                    console.warn('Á¨¨‰∫åÂõû„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', currentError);
                }

                // Á¨¨‰∏ÄÂõûÈ∫ªÈõÄÂ§ß‰ºö„Éá„Éº„Çø
                let legacyData = [];
                try {
                    const { data, error: legacyError } = await supabaseClient
                        .from('tournament_player_stats_snapshot')
                        .select('*');

                    if (legacyError) {
                        console.warn('Á¨¨‰∏ÄÂõû„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', legacyError);
                    } else {
                        legacyData = data || [];
                    }
                } catch (e) {
                    console.warn('Á¨¨‰∏ÄÂõû„Éá„Éº„ÇøÂèñÂæó„Çπ„Ç≠„ÉÉ„Éó:', e);
                }

                allMahjongRecords = [...(currentData || []), ...legacyData];
                console.log('üìä ÂèñÂæó„Åó„Åü„É¨„Ç≥„Éº„ÉâÊï∞:', allMahjongRecords.length);

                displayMahjongStats();
            } catch (err) {
                console.error('È∫ªÈõÄÁµ±Ë®àÂèñÂæó„Ç®„É©„Éº:', err);
                document.getElementById('stats-loading').style.display = 'none';
                document.getElementById('no-stats-msg').style.display = 'block';
                document.getElementById('stats-content').style.display = 'block';
            }
        }

        function toggleMySeason(season) {
            mySeasonMode = season;

            // „Éú„Çø„É≥„Çπ„Çø„Ç§„É´Êõ¥Êñ∞
            const btns = document.querySelectorAll('.profile-card .btn-group .btn');
            btns.forEach(btn => {
                if (btn.textContent === '‰ªä„Ç∑„Éº„Ç∫„É≥' && season === 'current') {
                    btn.classList.replace('btn-outline-primary', 'btn-primary');
                } else if (btn.textContent === 'ÂÖ®„Ç∑„Éº„Ç∫„É≥' && season === 'all') {
                    btn.classList.replace('btn-outline-primary', 'btn-primary');
                } else {
                    btn.classList.replace('btn-primary', 'btn-outline-primary');
                }
            });

            displayMahjongStats();
        }

        function displayMahjongStats() {
            // „Ç∑„Éº„Ç∫„É≥„Éï„Ç£„É´„Çø
            let records = allMahjongRecords;
            if (mySeasonMode === 'current') {
                records = records.filter(r => r.tournament_name === 'Á¨¨‰∫åÂõûÈ∫ªÈõÄÂ§ß‰ºö' || !r.tournament_name);
            }

            // ÂÖ®„Éó„É¨„Ç§„É§„Éº„ÅÆÁµ±Ë®àË®àÁÆó
            const playerStats = calculateAllPlayerStats(records);

            // „Éá„Éê„ÉÉ„Ç∞: ÂÖ®„Éó„É¨„Ç§„É§„ÉºÂêç„ÇíË°®Á§∫
            console.log('üéØ Ëá™ÂàÜ„ÅÆ„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç:', myAccountName);
            console.log('üìã ÂÖ®„Éó„É¨„Ç§„É§„ÉºÂêç:', playerStats.map(p => p.name));

            // Ëá™ÂàÜ„ÅÆÁµ±Ë®à„ÇíÂèñÂæó
            const myStats = playerStats.find(p => p.name === myAccountName);
            const totalPlayers = playerStats.length;

            document.getElementById('stats-loading').style.display = 'none';
            document.getElementById('stats-content').style.display = 'block';

            if (!myStats || myStats.games === 0) {
                document.getElementById('no-stats-msg').style.display = 'block';
                return;
            }
            document.getElementById('no-stats-msg').style.display = 'none';

            // ÂêÑÁµ±Ë®à„ÇíË°®Á§∫
            updateStatCard('total', myStats.total, playerStats, 'total', true);
            updateStatCard('sanma', myStats.sanma, playerStats, 'sanma', true);
            updateStatCard('yonma', myStats.yonma, playerStats, 'yonma', true);
            updateStatCard('avg-score', myStats.avgScore.toFixed(0), playerStats, 'avgScore', true);
            updateStatCard('max-score', myStats.maxScore, playerStats, 'maxScore', true);
            updateStatCard('win-rate', myStats.winRate.toFixed(1) + '%', playerStats, 'winRate', true);
            updateStatCard('deal-rate', myStats.dealRate.toFixed(1) + '%', playerStats, 'dealRate', false);
            updateStatCard('top-rate', myStats.topRate.toFixed(1) + '%', playerStats, 'topRate', true);
            updateStatCard('avoid-rate', myStats.avoidRate.toFixed(1) + '%', playerStats, 'avoidRate', true);
            updateStatCard('avg-rank', myStats.avgRank.toFixed(2), playerStats, 'avgRank', false);
            updateStatCard('games', myStats.games, playerStats, 'games', true);
        }

        function updateStatCard(id, value, allStats, key, higherIsBetter) {
            document.getElementById('stat-' + id).textContent = value;

            // È†Ü‰ΩçË®àÁÆó
            const sorted = [...allStats].filter(p => p.games > 0).sort((a, b) =>
                higherIsBetter ? b[key] - a[key] : a[key] - b[key]
            );
            const myRank = sorted.findIndex(p => p.name === myAccountName) + 1;
            const total = sorted.length;

            const rankEl = document.getElementById('rank-' + id);
            if (myRank > 0) {
                rankEl.textContent = `${myRank}/${total}‰Ωç`;
                rankEl.classList.remove('no-data');
            } else {
                rankEl.textContent = '-';
                rankEl.classList.add('no-data');
            }
        }

        function calculateAllPlayerStats(records) {
            const players = {};

            records.forEach(r => {
                // discord_user_id„Çí„Ç≠„Éº„Å®„Åó„Å¶‰ΩøÁî®Ôºà„É©„É≥„Ç≠„É≥„Ç∞„Å®Âêå„Åò„É≠„Ç∏„ÉÉ„ÇØÔºâ
                let id = r.discord_user_id;
                if (!id || id === 'null') {
                    id = r.nickname || r.account_name || 'Unknown';
                }
                if (!id) return;

                if (!players[id]) {
                    players[id] = {
                        name: id,
                        score: 0, sanma: 0, yonma: 0,
                        count: 0, win: 0, deal: 0,
                        r1: 0, r2: 0, r3: 0, r4: 0,
                        max_score: -Infinity
                    };
                }

                const p = players[id];
                const mode = r.mode || '';

                // Á¨¨‰∏ÄÂõûÂ§ß‰ºö„Å®Á¨¨‰∫åÂõûÂ§ß‰ºö„ÅßÁï∞„Å™„Çã„Ç´„É©„É†Âêç„ÇíÂá¶ÁêÜ
                if (r.tournament_type === 'Á¨¨‰∏ÄÂõûÈ∫ªÈõÄÂ§ß‰ºö') {
                    p.score += Number(r.score_total || 0);
                    p.count += Number(r.matches_played || 0);
                    p.r1 += Number(r.rank1_count || 0);
                    p.r2 += Number(r.rank2_count || 0);
                    p.r3 += Number(r.rank3_count || 0);
                    p.r4 += Number(r.rank4_count || 0);
                    p.max_score = Math.max(p.max_score, Number(r.score_max || 0));
                } else {
                    p.score += Number(r.final_score || 0);
                    p.count += 1;
                    const rk = Number(r.rank);
                    if (rk === 1) p.r1++;
                    else if (rk === 2) p.r2++;
                    else if (rk === 3) p.r3++;
                    else if (rk === 4) p.r4++;
                    p.max_score = Math.max(p.max_score, Number(r.final_score || 0));
                }

                p.win += (r.win_count || 0);
                p.deal += (r.deal_in_count || 0);

                // „É¢„Éº„ÉâÂà•„Çπ„Ç≥„Ç¢
                if (mode === '‰∏âÈ∫ª') p.sanma += Number(r.final_score || r.score_total || 0);
                if (mode === 'ÂõõÈ∫ª') p.yonma += Number(r.final_score || r.score_total || 0);
            });

            // Áµ±Ë®àÂÄ§„ÇíË®àÁÆó
            return Object.values(players).map(p => {
                const avgWin = p.count > 0 ? (p.win / p.count) : 0;
                const avgDeal = p.count > 0 ? (p.deal / p.count) : 0;
                const topRate = p.count > 0 ? (p.r1 / p.count) * 100 : 0;
                let lastCount = p.r4;
                if (p.r4 === 0 && p.r3 > 0) lastCount = p.r3;
                const avoidRate = p.count > 0 ? (1 - (lastCount / p.count)) * 100 : 0;
                const avgRank = p.count > 0 ? (1 * p.r1 + 2 * p.r2 + 3 * p.r3 + 4 * p.r4) / p.count : 0;
                const avgScore = p.count > 0 ? p.score / p.count : 0;

                return {
                    name: p.name,
                    total: p.score,
                    sanma: p.sanma,
                    yonma: p.yonma,
                    avgScore: avgScore,
                    maxScore: p.max_score === -Infinity ? 0 : p.max_score,
                    winRate: avgWin * 100,
                    dealRate: avgDeal * 100,
                    avgRank: avgRank,
                    topRate: topRate,
                    avoidRate: avoidRate,
                    games: p.count
                };
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            displayMyPage();
            loadMahjongStats();
        });

    </script>
</body>

</html>