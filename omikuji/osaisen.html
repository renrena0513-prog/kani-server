<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠè³½éŠ­ç®± - ã‹ã«é¯–</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../styles.css">
    /* ã‚¬ãƒãƒ£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes shake {
    0% { transform: translate(1px, 1px) rotate(0deg); }
    10% { transform: translate(-1px, -2px) rotate(-1deg); }
    20% { transform: translate(-3px, 0px) rotate(1deg); }
    30% { transform: translate(3px, 2px) rotate(0deg); }
    40% { transform: translate(1px, -1px) rotate(1deg); }
    50% { transform: translate(-1px, 2px) rotate(-1deg); }
    60% { transform: translate(-3px, 1px) rotate(0deg); }
    70% { transform: translate(3px, 1px) rotate(-1deg); }
    80% { transform: translate(-1px, -1px) rotate(1deg); }
    90% { transform: translate(1px, 2px) rotate(0deg); }
    100% { transform: translate(1px, -2px) rotate(-1deg); }
    }

    .shaking {
    animation: shake 0.5s infinite;
    }

    @keyframes coin-toss {
    0% { transform: translateY(0) scale(1); opacity: 1; }
    50% { transform: translateY(-100px) scale(1.5); opacity: 1; }
    100% { transform: translateY(150px) scale(0.5); opacity: 0; }
    }

    .coin-animation {
    position: absolute;
    font-size: 2rem;
    z-index: 10;
    top: 50%;
    left: 50%;
    margin-left: -1rem;
    pointer-events: none;
    display: none;
    }

    .coin-animation.active {
    display: block;
    animation: coin-toss 0.8s ease-in forwards;
    }

    /* çµæœãƒ¢ãƒ¼ãƒ€ãƒ«ã®è£…é£¾ */
    #resultModal .modal-content {
    background: radial-gradient(circle at center, #fff 0%, #f0f0f0 100%);
    border: 5px solid var(--gold);
    border-radius: 24px;
    }

    .result-badge-img {
    width: 150px;
    height: 150px;
    object-fit: contain;
    margin: 20px auto;
    filter: drop-shadow(0 0 20px rgba(212, 168, 83, 0.4));
    }

    .result-rarity {
    font-weight: bold;
    padding: 4px 15px;
    border-radius: 20px;
    display: inline-block;
    margin-bottom: 10px;
    font-size: 0.8rem;
    }

    /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£åˆ¥èƒŒæ™¯ï¼ˆstyles.cssã‹ã‚‰ã‚³ãƒ”ãƒ¼/æ‹¡å¼µï¼‰ */
    .rarity-wood { background: #d7ccc8; color: #5d4037; }
    .rarity-stone { background: #cfd8dc; color: #455a64; }
    .rarity-bronze { background: #ffe0b2; color: #e65100; }
    .rarity-silver { background: #f5f5f5; color: #616161; }
    .rarity-gold { background: linear-gradient(135deg, #fff9c4 0%, #fbc02d 100%); color: #f57f17; }
    .rarity-platinum { background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%); color: #0277bd; }
    .rarity-gem { background: linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%); color: #7b1fa2; }
    </style>
</head>

<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆJSã§æŒ¿å…¥ï¼‰ -->
    <div class="nav-dropdown"></div>

    <div class="container py-5">
        <header class="text-center">
            <h1 class="page-header display-4 fw-bold">â›©ï¸ ãŠè³½éŠ­ç®±</h1>
            <p class="text-white-50">ç¥ˆé¡˜ç¬¦ã‚’æ§ã’ã¦ã€ç¸ã‚’æˆã‹ã‚Šã¾ã—ã‚‡ã†</p>
        </header>

        <div class="gacha-container">
            <div id="osaisen-box-area" class="osaisen-box-wrapper">
                <div id="coin" class="coin-animation">ğŸª™</div>
                <div id="osaisen-box" style="font-size: 100px; cursor: default;">ğŸ§§</div>
            </div>

            <div class="mb-4">
                <h3 class="fw-bold" style="color: var(--crimson);">å¹¸é‹ã‚’é¡˜ã£ã¦ã€ãŠè³½éŠ­ã‚’å¥‰ç´ã—ã¾ã—ã‚‡ã†</h3>
                <p class="text-muted">ç¥ˆé¡˜ç¬¦1æšã§1å›ã€ãŠè³½éŠ­ã‚’æŠ•ã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
            </div>

            <div class="ticket-balance">
                <span class="ticket-icon">ğŸ§§</span>
                <span>æ‰€æŒä¸­ã®ç¥ˆé¡˜ç¬¦:</span>
                <span id="ticket-count" class="ticket-count">- æš</span>
            </div>

            <div class="mt-4">
                <button id="draw-btn" class="gacha-btn" onclick="handleDraw()">
                    ğŸ™ ãŠè³½éŠ­ã‚’å¥‰ç´ã™ã‚‹
                </button>
            </div>

            <!-- æä¾›å‰²åˆè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="mt-4 text-center">
                <a href="javascript:void(0)" class="text-white-50 small text-decoration-none" onclick="toggleOdds()">
                    <i class="bi bi-info-circle me-1"></i>æä¾›å‰²åˆã‚’ç¢ºèªã™ã‚‹
                </a>
                <div id="odds-area" class="mt-3 p-3 rounded" style="background: rgba(0,0,0,0.2); display: none;">
                    <div id="odds-list" class="row g-2 justify-content-center">
                        <!-- JSã§å‹•çš„ã«æŒ¿å…¥ -->
                    </div>
                    <div class="mt-2 x-small text-white-50">
                        â€»ä¸Šè¨˜ã¯ãƒãƒƒã‚¸æŠ½é¸ï¼ˆ30%ï¼‰æ™‚ã®å†…è¨³ã§ã™ã€‚æ®‹ã‚Š70%ã¯å¾¡ç¥çŸ³ï¼ˆçŸ³ï¼‰ã¨ãªã‚Šã¾ã™ã€‚
                    </div>
                </div>
            </div>

            <div class="admin-debug mt-4">
                <p>ç®¡ç†è€…ã¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ä¸­</p>
                <p class="small text-white-50">ãƒãƒƒã‚¸æ’å‡ºã€é‡è¤‡æ‰€æŒã®è¨±å¯ã€ãƒ¬ã‚¢ãƒªãƒ†ã‚£åˆ¥é‡ã¿ã«å¯¾å¿œæ¸ˆã¿ã§ã™ã€‚</p>
            </div>
        </div>
    </div>

    <!-- çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <div id="result-header" class="mb-2">
                    <span class="fs-4 fw-bold">â›©ï¸ ã”ç¸ãŒã‚ã‚Šã¾ã—ãŸ</span>
                </div>
                <div id="result-rarity-badge" class="result-rarity">ãƒ¬ã‚¢ãƒªãƒ†ã‚£</div>
                <div class="result-body">
                    <img id="result-img" src="" class="result-badge-img" alt="ãƒãƒƒã‚¸">
                    <h3 id="result-name" class="fw-bold mb-3">ãƒãƒƒã‚¸å</h3>
                    <p id="result-msg" class="text-muted mb-4">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
                </div>
                <button type="button" class="btn btn-primary rounded-pill px-5" data-bs-dismiss="modal">
                    ã‚ã‚ŠãŒãŸãå—ã‘å–ã‚‹
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        let currentUser = null;
        let isDrawing = false;

        document.addEventListener('DOMContentLoaded', async function () {
            initAccordionNav('../');

            const user = await getCurrentUser();
            if (!user) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚');
                window.location.href = '../index.html';
                return;
            }
            currentUser = user;
            const discordId = user.user_metadata.provider_id;

            if (!ADMIN_DISCORD_IDS.includes(discordId)) {
                alert('ã“ã®ãƒšãƒ¼ã‚¸ã¯ç®¡ç†è€…å°‚ç”¨ã§ã™ã€‚');
                window.location.href = '../index.html';
                return;
            }

            fetchTicketCount();
        });

        async function fetchTicketCount() {
            const discordId = currentUser.user_metadata.provider_id;
            const { data, error } = await supabaseClient
                .from('profiles')
                .select('gacha_tickets')
                .eq('discord_user_id', discordId)
                .maybeSingle();

            if (error) {
                console.error('ãƒã‚±ãƒƒãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return;
            }

            const count = data?.gacha_tickets || 0;
            const countEl = document.getElementById('ticket-count');
            countEl.textContent = `${count.toLocaleString()} æš`;

            const btn = document.getElementById('draw-btn');
            btn.disabled = count <= 0;
        }

        async function handleDraw() {
            if (isDrawing) return;
            isDrawing = true;

            const btn = document.getElementById('draw-btn');
            const box = document.getElementById('osaisen-box');
            const coin = document.getElementById('coin');

            btn.disabled = true;

            try {
                // 1. ã‚³ã‚¤ãƒ³æŠ•ã’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                coin.classList.add('active');

                // 2. è³½éŠ­ç®±ã®æºã‚Œ
                setTimeout(() => {
                    box.classList.add('shaking');
                }, 400);

                // 3. RPCå‘¼ã³å‡ºã—ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã«ä¸¦è¡Œã—ã¦å®Ÿè¡Œï¼‰
                const { data, error } = await supabaseClient.rpc('draw_gacha', {
                    p_user_id: currentUser.user_metadata.provider_id
                });

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å°‘ã—è¦‹ã›ã‚‹ãŸã‚ã«å¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 1500));

                if (error) throw error;
                if (!data.ok) throw new Error(data.error);

                // çµæœã®è¡¨ç¤º
                showResult(data);

            } catch (err) {
                console.error('ã‚¬ãƒãƒ£ã‚¨ãƒ©ãƒ¼:', err);
                alert('å¥‰ç´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
            } finally {
                // ãƒªã‚»ãƒƒãƒˆ
                isDrawing = false;
                coin.classList.remove('active');
                box.classList.remove('shaking');
                fetchTicketCount();
            }
        }

        let rarityOdds = [];

        async function fetchOdds() {
            const { data, error } = await supabaseClient
                .from('rarity_thresholds')
                .select('rarity_name, gacha_weight')
                .gt('gacha_weight', 0)
                .order('threshold_value', { ascending: true });

            if (error) {
                console.error('æ’å‡ºç‡å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return;
            }

            rarityOdds = data;
            renderOdds();
        }

        function renderOdds() {
            const listEl = document.getElementById('odds-list');
            const totalWeight = rarityOdds.reduce((sum, r) => sum + r.gacha_weight, 0);

            if (totalWeight === 0) {
                listEl.innerHTML = '<div class="text-white-50">è¨­å®šãªã—</div>';
                return;
            }

            listEl.innerHTML = rarityOdds.map(r => {
                const percent = ((r.gacha_weight / totalWeight) * 100).toFixed(1);
                return `
                    <div class="col-6 col-md-4">
                        <div class="d-flex justify-content-between small px-2">
                            <span class="text-white">${r.rarity_name}</span>
                            <span style="color: var(--gold);">${percent}%</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleOdds() {
            const area = document.getElementById('odds-area');
            if (area.style.display === 'none') {
                area.style.display = 'block';
                if (rarityOdds.length === 0) fetchOdds();
            } else {
                area.style.display = 'none';
            }
        }

        function showResult(result) {
            const imgEl = document.getElementById('result-img');
            const nameEl = document.getElementById('result-name');
            const msgEl = document.getElementById('result-msg');
            const rarityEl = document.getElementById('result-rarity-badge');
            const headerEl = document.getElementById('result-header');

            imgEl.src = result.image_url || '../images/placeholder-badge.png';
            nameEl.textContent = result.name;

            // ãƒ¬ã‚¢ãƒªãƒ†ã‚£æ¼”å‡º
            const rarity = result.rarity || 'ä¸€èˆ¬';
            rarityEl.textContent = rarity;
            rarityEl.className = 'result-rarity ' + getRarityClass(rarity);

            if (result.type === 'stone') {
                headerEl.innerHTML = '<span class="fs-4 fw-bold">ğŸ’  æ›é‡‘ã§ãã‚‹çŸ³ã‚’æˆã‹ã‚Šã¾ã—ãŸ</span>';
                msgEl.textContent = 'æ›é‡‘ç”¨ã®ä¾¡å€¤ã‚ã‚‹çŸ³ã§ã™ã€‚æ‰€æŒå“ã‹ã‚‰ç¢ºèªãƒ»å£²å´ã§ãã¾ã™ã€‚';
            } else if (result.type === 'exchange_ticket') {
                headerEl.innerHTML = '<span class="fs-4 fw-bold">ğŸ« å¼•æ›åˆ¸ã‚’æˆã‹ã‚Šã¾ã—ãŸ</span>';
                msgEl.textContent = `è©²å½“ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã®ãƒãƒƒã‚¸ãŒä¸åœ¨ã®ãŸã‚ã€${rarity}å¼•æ›åˆ¸ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚`;
                imgEl.src = 'https://cdn-icons-png.flaticon.com/512/812/812328.png'; // ãƒã‚±ãƒƒãƒˆç”¨ã‚¢ã‚¤ã‚³ãƒ³
            } else {
                headerEl.innerHTML = '<span class="fs-4 fw-bold">âœ¨ æ–°ã—ã„ç¸ã‚’æˆã‹ã‚Šã¾ã—ãŸ</span>';
                msgEl.textContent = 'æ–°ã—ã„ãƒãƒƒã‚¸ã‚’ç²å¾—ã—ã¾ã—ãŸï¼ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚„æ‰€æŒå“ã‹ã‚‰ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            }

            const modal = new bootstrap.Modal(document.getElementById('resultModal'));
            modal.show();
        }
    </script>
</body>

</html>