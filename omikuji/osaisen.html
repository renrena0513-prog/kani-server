<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠè³½éŠ­ç®± - ã‹ã«é¯–</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../styles.css">
    <style>
        /* ã‚¬ãƒãƒ£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shake {
            0% {
                transform: translate(1px, 1px) rotate(0deg);
            }

            10% {
                transform: translate(-1px, -2px) rotate(-1deg);
            }

            20% {
                transform: translate(-3px, 0px) rotate(1deg);
            }

            30% {
                transform: translate(3px, 2px) rotate(0deg);
            }

            40% {
                transform: translate(1px, -1px) rotate(1deg);
            }

            50% {
                transform: translate(-1px, 2px) rotate(-1deg);
            }

            60% {
                transform: translate(-3px, 1px) rotate(0deg);
            }

            70% {
                transform: translate(3px, 1px) rotate(-1deg);
            }

            80% {
                transform: translate(-1px, -1px) rotate(1deg);
            }

            90% {
                transform: translate(1px, 2px) rotate(0deg);
            }

            100% {
                transform: translate(1px, -2px) rotate(-1deg);
            }
        }

        .shaking {
            animation: shake 0.5s infinite;
        }

        @keyframes coin-toss {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            50% {
                transform: translateY(-100px) scale(1.5);
                opacity: 1;
            }

            100% {
                transform: translateY(150px) scale(0.5);
                opacity: 0;
            }
        }

        .coin-animation {
            position: absolute;
            font-size: 2rem;
            z-index: 10;
            top: 50%;
            left: 50%;
            margin-left: -1rem;
            pointer-events: none;
            display: none;
        }

        .coin-animation.active {
            display: block;
            animation: coin-toss 0.8s ease-in forwards;
        }

        /* çµæœãƒ¢ãƒ¼ãƒ€ãƒ«ã®è£…é£¾ */
        #resultModal .modal-content {
            background: radial-gradient(circle at center, #fff 0%, #f0f0f0 100%);
            border: 5px solid var(--gold);
            border-radius: 24px;
        }

        .result-badge-img {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin: 20px auto;
            filter: drop-shadow(0 0 20px rgba(212, 168, 83, 0.4));
        }

        .result-rarity {
            font-weight: bold;
            padding: 4px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 10px;
            font-size: 0.8rem;
        }

        /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£åˆ¥èƒŒæ™¯ */
        .rarity-wood {
            background: #d7ccc8;
            color: #5d4037;
        }

        .rarity-stone {
            background: #cfd8dc;
            color: #455a64;
        }

        .rarity-bronze {
            background: #ffe0b2;
            color: #e65100;
        }

        .rarity-silver {
            background: #f5f5f5;
            color: #616161;
        }

        .rarity-gold {
            background: linear-gradient(135deg, #fff9c4 0%, #fbc02d 100%);
            color: #f57f17;
        }

        .rarity-platinum {
            background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%);
            color: #0277bd;
        }

        .rarity-gem {
            background: linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%);
            color: #7b1fa2;
        }

        .odds-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .odds-category {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            text-align: left;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* æ”¯æ‰•ã„æ–¹æ³•é¸æŠã‚«ãƒ¼ãƒ‰ */
        .payment-option {
            cursor: pointer;
        }

        .payment-option input[type="radio"] {
            display: none;
        }

        .payment-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #fff;
            transition: all 0.3s ease;
        }

        .payment-option input:checked+.payment-card {
            background: rgba(212, 168, 83, 0.3);
            border-color: var(--gold);
            box-shadow: 0 0 15px rgba(212, 168, 83, 0.4);
        }

        .payment-card:hover {
            transform: translateY(-3px);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .badge-fade {
            animation: badgeFade 5s ease-in-out infinite;
        }

        @keyframes badgeFade {
            0% { opacity: 0; transform: translateY(6px) scale(0.98); }
            15% { opacity: 1; transform: translateY(0) scale(1); }
            85% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-6px) scale(0.98); }
        }

        .mutant-label {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(255, 215, 0, 0.2);
            color: #ffeaa7;
            font-weight: 700;
            font-size: 0.75rem;
            border: 1px solid rgba(255, 215, 0, 0.5);
        }

        .draw-mode-toggle {
            display: inline-flex;
            gap: 8px;
            padding: 6px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .draw-mode-btn {
            border: none;
            background: transparent;
            color: #fff;
            font-weight: 700;
            padding: 6px 16px;
            border-radius: 999px;
            transition: all 0.2s ease;
            opacity: 0.7;
        }

        .draw-mode-btn.active {
            background: rgba(255, 255, 255, 0.22);
            opacity: 1;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
        }

        .draw-mode-note {
            color: #fff;
            font-weight: 600;
            margin-top: 10px;
        }

        .ten-result-item {
            cursor: pointer;
            border-radius: 10px;
            padding: 6px;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .ten-result-item.selected {
            border-color: var(--gold);
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.35);
            background: rgba(255, 215, 0, 0.08);
        }

        .gacha-tabs {
            display: inline-flex;
            gap: 10px;
            padding: 6px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .gacha-tab-btn {
            border: none;
            background: transparent;
            color: #fff;
            font-weight: 700;
            padding: 8px 18px;
            border-radius: 999px;
            transition: all 0.2s ease;
            opacity: 0.7;
        }

        .gacha-tab-btn.active {
            background: rgba(255, 255, 255, 0.18);
            opacity: 1;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
        }

        .gacha-tab-btn.disabled {
            cursor: not-allowed;
            opacity: 0.4;
        }

        .gacha-mode-note {
            color: #f8f9fa;
            font-weight: 600;
            margin-top: 12px;
        }
    </style>
</head>

<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆJSã§æŒ¿å…¥ï¼‰ -->
    <div class="nav-dropdown"></div>

    <div class="container py-5">
        <header class="text-center">
            <h1 class="page-header display-4 fw-bold">â›©ï¸ ãŠè³½éŠ­ç®±</h1>
            <p class="text-white-50">ç¥ˆé¡˜ç¬¦ã‚’æ§ã’ã¦ã€ç¸ã‚’æˆã‹ã‚Šã¾ã—ã‚‡ã†</p>
        </header>

        <div class="gacha-container text-center">
            <div class="mb-4">
                <div class="gacha-tabs mx-auto">
                    <button class="gacha-tab-btn active" data-mode="coin" onclick="setGachaMode('coin')">ğŸª™ ã‚³ã‚¤ãƒ³ã§å›ã™</button>
                    <button class="gacha-tab-btn disabled" data-mode="ticket" onclick="setGachaMode('ticket')">ğŸ« ãƒã‚±ãƒƒãƒˆã§å›ã™</button>
                </div>
                <div id="gacha-mode-note" class="gacha-mode-note">ãƒã‚±ãƒƒãƒˆã§å›ã™æ©Ÿèƒ½ã¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå¾…ã¡ã§ã™</div>
            </div>
            <div id="osaisen-box-area" class="osaisen-box-wrapper mx-auto mb-4"
                style="position: relative; width: fit-content;">
                <div id="coin" class="coin-animation">ğŸª™</div>
                <div id="osaisen-box" style="cursor: default;">
                    <img id="osaisen-badge" src="../images/placeholder-badge.png" alt="æ’å‡ºãƒãƒƒã‚¸" style="width: min(480px, 90vw); height: min(480px, 90vw); object-fit: contain;">
                </div>
            </div>

            <div class="mb-4">
                <h3 class="fw-bold" style="color: var(--crimson);">å¹¸é‹ã‚’é¡˜ã£ã¦ã€ãŠè³½éŠ­ã‚’å¥‰ç´ã—ã¾ã—ã‚‡ã†</h3>
                <p class="text-muted" id="gacha-price-note">ã‚³ã‚¤ãƒ³ã§ãŠè³½éŠ­ã‚’æŠ•ã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
            </div>

            <div
                class="ticket-balance d-inline-flex align-items-center bg-dark bg-opacity-25 px-4 py-2 rounded-pill mb-3 border border-secondary border-opacity-25">
                <span class="fs-4 me-2">ğŸª™</span>
                <span class="me-2 text-white-50">ã‚³ã‚¤ãƒ³:</span>
                <span id="coin-count" class="fw-bold text-white fs-5">- C</span>
            </div>

            <div class="mb-4 d-flex justify-content-center">
                <div class="payment-card">
                    <span class="fs-3">ğŸª™</span>
                    <span class="fw-bold" id="coin-price-label">ã‚³ã‚¤ãƒ³ - æš</span>
                </div>
            </div>

            <div class="mt-2" id="draw-area">
                <div class="d-flex flex-column align-items-center gap-3">
                    <div class="draw-mode-toggle">
                        <button class="draw-mode-btn active" data-mode="single" onclick="setDrawMode('single')">1å›</button>
                        <button class="draw-mode-btn" data-mode="ten" onclick="setDrawMode('ten')">10é€£</button>
                    </div>
                    <div id="draw-mode-note" class="draw-mode-note" style="display:none;">
                        10é€£ã¯ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ³ãƒˆç¢ºç‡ãŒ5%ã«ãªã‚Šã¾ã™
                    </div>
                    <button id="draw-btn" class="gacha-btn" onclick="handleDraw()">
                        ğŸ™ ãŠè³½éŠ­ã‚’å¥‰ç´ã™ã‚‹
                    </button>
                </div>
                <div id="not-started-msg" class="alert alert-warning mt-3 mx-auto"
                    style="display: none; max-width: 400px;">
                    âœ¨ ç¾åœ¨ã€ç¥äº‹ã®æº–å‚™ã‚’ã—ã¦ã„ã¾ã™ã€‚ãŠè³½éŠ­ç®±ã¯ã¾ã é–‹ã„ã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚r
                </div>
            </div>

            <!-- æä¾›å‰²åˆã¯éè¡¨ç¤ºï¼ˆã‚³ã‚¤ãƒ³ã‚¬ãƒãƒ£å°‚ç”¨ï¼‰ -->

            <!-- æ’å‡ºãƒãƒƒã‚¸ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="mt-4 text-center">
                <a href="javascript:void(0)" class="text-white-50 small text-decoration-none"
                    onclick="toggleBadgePool()">
                    <i class="bi bi-collection me-1"></i> æ’å‡ºãƒãƒƒã‚¸ä¸€è¦§ã‚’è¦‹ã‚‹
                </a>
                <div id="badge-pool-area" class="mt-4 p-4 rounded shadow-lg mx-auto"
                    style="background: rgba(0,0,0,0.3); display: none; max-width: 800px; border: 1px solid rgba(255,255,255,0.1);">
                    <div id="badge-pool-list">
                        <p class="text-white-50">èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <!-- çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <div id="result-header" class="mb-2">
                    <span class="fs-4 fw-bold">â›©ï¸ ã”ç¸ãŒã‚ã‚Šã¾ã—ãŸ</span>
                </div>
                <div id="result-rarity-badge" class="result-rarity">ãƒ¬ã‚¢ãƒªãƒ†ã‚£</div>
                <div class="result-body">
                    <img id="result-img" src="" class="result-badge-img" alt="ãƒãƒƒã‚¸">
                    <h3 id="result-name" class="fw-bold mb-3">ãƒãƒƒã‚¸å</h3>
                    <p id="result-msg" class="text-muted mb-4">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
                </div>
                <button type="button" class="btn btn-primary rounded-pill px-5" data-bs-dismiss="modal">
                    ã‚ã‚ŠãŒãŸãå—ã‘å–ã‚‹
                </button>
                <button type="button" class="btn btn-outline-danger rounded-pill px-5 mt-2" id="result-sell-btn" style="display:none;">
                    ãã®å ´ã§å£²å´ã™ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- 10é€£çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="resultModalTen" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content text-center p-4">
                <div class="mb-2">
                    <span class="fs-4 fw-bold">âœ¨ 10é€£ã®çµæœ</span>
                </div>
                <div id="result-ten-total" class="text-dark fw-bold mb-2"></div>
                <div id="result-ten-list" class="d-grid gap-2" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
                    <!-- JSã§æŒ¿å…¥ -->
                </div>
                <button type="button" class="btn btn-outline-danger rounded-pill px-5 mt-3" id="result-ten-sell-btn" style="display:none;">
                    é¸æŠã—ãŸã‚‚ã®ã‚’ã¾ã¨ã‚ã¦å£²å´
                </button>
                <button type="button" class="btn btn-primary rounded-pill px-5 mt-3" data-bs-dismiss="modal">
                    ã‚ã‚ŠãŒãŸãå—ã‘å–ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- å£²å´çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="sellResultModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <div class="fs-4 fw-bold mb-2">å£²å´å®Œäº†</div>
                <div id="sell-result-message" class="text-muted mb-3">å£²å´ã—ã¾ã—ãŸ</div>
                <button type="button" class="btn btn-primary rounded-pill px-5" data-bs-dismiss="modal">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/badge-utils.js"></script>
    <script src="../js/effects/mutant-badge.js"></script>
    <script src="../js/auth-guard.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        let currentUser = null;
        let isDrawing = false;
        let provisionData = null;
        let osaisenBadgeList = [];
        let osaisenBadgeTimer = null;
        let currentDrawMode = 'single';
        let rarityValueMap = {};
        let lastDrawnBadgeUuid = null;
        let lastDrawnBadgeMeta = null;
        let lastTenResults = [];
        let currentGachaMode = 'coin';
        let gachaCoinPrice = 50;

        document.addEventListener('DOMContentLoaded', async function () {
            initAccordionNav('../');

            const user = await getCurrentUser();
            if (!user) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚');
                window.location.href = '../index.html';
                return;
            }
            currentUser = user;
            fetchTicketCount();
            fetchGachaCoinPrice();
            initOsaisenBadgeShowcase();
        });

        async function fetchTicketCount() {
            const discordId = currentUser.user_metadata.provider_id;
            const { data, error } = await supabaseClient
                .from('profiles')
                .select('coins')
                .eq('discord_user_id', discordId)
                .maybeSingle();

            if (error) {
                console.error('æ®‹é«˜å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return;
            }

            const coinCount = data?.coins || 0;

            const coinEl = document.getElementById('coin-count');

            if (coinEl) coinEl.textContent = `${coinCount.toLocaleString()} C`;
        }

        // æä¾›å‰²åˆã¯éè¡¨ç¤ºï¼ˆã‚³ã‚¤ãƒ³ã‚¬ãƒãƒ£å°‚ç”¨ï¼‰

        let badgePoolData = null;

        function toggleBadgePool() {
            const area = document.getElementById('badge-pool-area');
            if (area.style.display === 'none') {
                area.style.display = 'block';
                if (!badgePoolData) fetchBadgePool();
            } else {
                area.style.display = 'none';
            }
        }

        async function fetchBadgePool() {
            try {
                // ãƒ¬ã‚¢ãƒªãƒ†ã‚£é–¾å€¤ã€ãƒãƒƒã‚¸ã€æµé€šæ•°ã€ã‚¬ãƒãƒ£é‡ã¿ã‚’å–å¾—
                const [badgesRes, thresholdsRes, circulationRes] = await Promise.all([
                    supabaseClient.from('badges').select('id, name, image_url, price, fixed_rarity_name, sales_type, is_gacha_eligible, remaining_count').eq('is_gacha_eligible', true),
                    fetchRarityThresholds(),
                    supabaseClient.from('user_badges_new').select('badge_id')
                ]);

                if (badgesRes.error) throw badgesRes.error;

                // ã‚¬ãƒãƒ£å¯¾è±¡ãƒãƒƒã‚¸ã¯ is_gacha_eligible ã®ã¿ï¼ˆåœ¨åº«åˆ¶é™ã¯ç„¡è¦–ï¼‰
                const badges = badgesRes.data || [];
                const thresholds = thresholdsRes || [];
                if (thresholds.length === 0) {
                    document.getElementById('badge-pool-list').innerHTML = '<p class="text-danger">ãƒ¬ã‚¢ãƒªãƒ†ã‚£æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“</p>';
                    return;
                }
                // æµé€šæ•°ã‚«ã‚¦ãƒ³ãƒˆ
                const circulation = {};
                (circulationRes.data || []).forEach(r => {
                    circulation[r.badge_id] = (circulation[r.badge_id] || 0) + 1;
                });

                // å‹•çš„ãƒ¬ã‚¢ãƒªãƒ†ã‚£è¨ˆç®—ï¼ˆBadgeUtilsä½¿ç”¨ï¼‰
                function getDynamicRarity(badge) {
                    const n = circulation[badge.id] || 0;
                    if (typeof BadgeUtils !== 'undefined' && BadgeUtils.calculateBadgeValues) {
                        const result = BadgeUtils.calculateBadgeValues(badge, n, thresholds);
                        return result.rarityName;
                    }
                    return badge.fixed_rarity_name || thresholds[0]?.rarity_name || 'ä¸æ˜';
                }

                // ãƒ¬ã‚¢ãƒªãƒ†ã‚£åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const grouped = {};
                badges.forEach(b => {
                    const rarity = getDynamicRarity(b);
                    if (!grouped[rarity]) grouped[rarity] = [];
                    grouped[rarity].push(b);
                });

                // ãƒ¬ã‚¢ãƒªãƒ†ã‚£é †åºï¼ˆé–¾å€¤é †ã®é€†ï¼‰
                const rarityOrder = [...thresholds].sort((a, b) => a.threshold_value - b.threshold_value).map(t => t.rarity_name).reverse();

                // HTMLç”Ÿæˆ
                const listEl = document.getElementById('badge-pool-list');
                let html = '';

                for (const rarity of rarityOrder) {
                    if (!grouped[rarity] || grouped[rarity].length === 0) continue;
                    const badgesInRarity = grouped[rarity];
                    const rarityPercent = (badgesInRarity.length / badges.length) * 100;
                    const perBadgePercent = badgesInRarity.length > 0 ? (rarityPercent / badgesInRarity.length) : 0;
                    const rarityClass = getRarityClass(rarity);

                    html += `
                        <div class="mb-3">
                            <div class="text-start mb-2">
                                <span class="badge ${rarityClass} text-white">${rarity}</span>
                                <span class="small text-white-50">(${badgesInRarity.length}ç¨®)</span>
                            </div>
                            <div class="d-flex flex-wrap gap-2 justify-content-start">
                                ${badgesInRarity.map(b => `
                                    <div class="text-center" style="width: 70px; cursor: pointer;" onclick="window.location.href='../badge/index.html?id=${b.id}'">
                                        <img src="${b.image_url}" style="width: 50px; height: 50px; object-fit: contain; border-radius: 8px; background: rgba(255,255,255,0.1);">
                                        <div class="small text-truncate" style="font-size: 0.65rem; color: #ffc107;">${perBadgePercent.toFixed(2)}%</div>
                                        <div class="small text-white-50 text-truncate" style="font-size: 0.6rem;">${b.name}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                if (!html) html = '<p class="text-white-50">æ’å‡ºå¯¾è±¡ã®ãƒãƒƒã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                listEl.innerHTML = html;
                badgePoolData = grouped;

            } catch (err) {
                console.error('æ’å‡ºãƒãƒƒã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                document.getElementById('badge-pool-list').innerHTML = '<p class="text-danger">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
            }
        }

        async function initOsaisenBadgeShowcase() {
            try {
                const { data, error } = await supabaseClient
                    .from('badges')
                    .select('id, image_url')
                    .eq('is_gacha_eligible', true);
                if (error) throw error;
                osaisenBadgeList = (data || []).filter(b => b.image_url);
                if (osaisenBadgeList.length === 0) return;

                const imgEl = document.getElementById('osaisen-badge');
                if (!imgEl) return;
                imgEl.classList.add('badge-fade');

                let idx = Math.floor(Math.random() * osaisenBadgeList.length);
                imgEl.src = osaisenBadgeList[idx].image_url;

                if (osaisenBadgeTimer) clearInterval(osaisenBadgeTimer);
                osaisenBadgeTimer = setInterval(() => {
                    if (osaisenBadgeList.length === 0) return;
                    idx = (idx + 1) % osaisenBadgeList.length;
                    imgEl.src = osaisenBadgeList[idx].image_url;
                }, 5000);
            } catch (err) {
                console.error('ãƒãƒƒã‚¸è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', err);
            }
        }

        async function fetchGachaCoinPrice() {
            try {
                const [badgesRes, thresholdsRes, circulationRes] = await Promise.all([
                    supabaseClient.from('badges').select('id, price, fixed_rarity_name, sales_type, is_gacha_eligible').eq('is_gacha_eligible', true),
                    fetchRarityThresholds(),
                    supabaseClient.from('user_badges_new').select('badge_id')
                ]);

                if (badgesRes.error) throw badgesRes.error;

                const badges = badgesRes.data || [];
                const thresholds = thresholdsRes || [];
                rarityValueMap = {};
                thresholds.forEach(t => {
                    rarityValueMap[t.rarity_name] = Number(t.threshold_value || 0);
                });
                const circulation = {};
                (circulationRes.data || []).forEach(r => {
                    circulation[r.badge_id] = (circulation[r.badge_id] || 0) + 1;
                });

                if (badges.length === 0) {
                    updateGachaPriceUI();
                    return;
                }

                let total = 0;
                if (thresholds.length > 0 && typeof BadgeUtils !== 'undefined' && BadgeUtils.calculateBadgeValues) {
                    badges.forEach(badge => {
                        const count = circulation[badge.id] || 0;
                        const values = BadgeUtils.calculateBadgeValues(badge, count, thresholds);
                        const nextIdx = Math.min(values.starLevel, thresholds.length - 1);
                        const nextValue = Number(thresholds[nextIdx]?.threshold_value || values.marketValue);
                        total += nextValue;
                    });
                } else {
                    badges.forEach(badge => {
                        total += Number(badge.price || 0);
                    });
                }

                gachaCoinPrice = Math.max(1, Math.round(total / badges.length));
                updateGachaPriceUI();
            } catch (err) {
                console.error('ã‚¬ãƒãƒ£ä¾¡æ ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                updateGachaPriceUI();
            }
        }

        function updateGachaPriceUI() {
            const coinLabel = document.getElementById('coin-price-label');
            const note = document.getElementById('gacha-price-note');
            const price = currentDrawMode === 'ten' ? gachaCoinPrice * 10 : gachaCoinPrice;
            if (coinLabel) coinLabel.textContent = `ã‚³ã‚¤ãƒ³ ${price.toLocaleString()}æš`;
            if (note) note.textContent = `ã‚³ã‚¤ãƒ³${price.toLocaleString()}æšã§ãŠè³½éŠ­ã‚’æŠ•ã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚`;
        }

        async function fetchRarityThresholds() {
            const { data, error } = await supabaseClient
                .from('rarity_thresholds')
                .select('rarity_name, threshold_value')
                .order('threshold_value', { ascending: true });
            if (error) throw error;
            return data || [];
        }

        function setGachaMode(mode) {
            if (mode === 'ticket') {
                return;
            }
            currentGachaMode = mode;
            document.querySelectorAll('.gacha-tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
        }

        function setDrawMode(mode) {
            currentDrawMode = mode;
            document.querySelectorAll('.draw-mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            const note = document.getElementById('draw-mode-note');
            if (note) note.style.display = mode === 'ten' ? 'block' : 'none';
            updateGachaPriceUI();
        }

        async function handleDraw() {
            if (isDrawing) return;

            if (currentGachaMode === 'ticket') {
                alert('ãƒã‚±ãƒƒãƒˆã§å›ã™æ©Ÿèƒ½ã¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå¾…ã¡ã§ã™ã€‚');
                return;
            }

            // ãŠè³½éŠ­ã®åˆ¶é™ã‚’è§£é™¤ - å…¨å“¡ãŒã‚¬ãƒãƒ£ã‚’å›ã›ã‚‹ã‚ˆã†ã«
            // const discordId = currentUser.user_metadata.provider_id;
            // const isAdmin = ADMIN_DISCORD_IDS.includes(discordId);
            // const notStartedMsg = document.getElementById('not-started-msg');
            // if (!isAdmin) {
            //     notStartedMsg.style.display = 'block';
            //     setTimeout(() => { notStartedMsg.style.display = 'none'; }, 5000);
            //     return;
            // }

            // æ”¯æ‰•ã„æ–¹æ³•ã‚’å–å¾—
            const paymentType = currentGachaMode === 'coin' ? 'coin' : 'ticket';

            isDrawing = true;

            const btn = document.getElementById('draw-btn');
            const box = document.getElementById('osaisen-box');
            const coin = document.getElementById('coin');

            btn.disabled = true;

            try {
                // 1. ã‚³ã‚¤ãƒ³æŠ•ã’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                coin.classList.add('active');

                // 2. è³½éŠ­ç®±ã®æºã‚Œ
                setTimeout(() => {
                    box.classList.add('shaking');
                }, 400);

                let data, error;
                if (currentDrawMode === 'ten') {
                    ({ data, error } = await supabaseClient.rpc('draw_gacha_multi', {
                        p_user_id: currentUser.user_metadata.provider_id,
                        p_draw_count: 10
                    }));
                } else {
                    ({ data, error } = await supabaseClient.rpc('draw_gacha', {
                        p_user_id: currentUser.user_metadata.provider_id,
                        p_payment_type: paymentType
                    }));
                }

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¦‹ã›ã‚‹ãŸã‚ã®å¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 1500));

                if (error) throw error;
                if (!data.ok) throw new Error(data.error);

                if (currentDrawMode === 'ten') {
                    showTenResults(data.results || []);
                } else {
                    showResult(data);
                }

            } catch (err) {
                console.error('ã‚¬ãƒãƒ£ã‚¨ãƒ©ãƒ¼:', err);
                alert('å¥‰ç´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
            } finally {
                isDrawing = false;
                coin.classList.remove('active');
                box.classList.remove('shaking');
                btn.disabled = false;
                fetchTicketCount();
            }
        }

        function showTenResults(results) {
            const list = document.getElementById('result-ten-list');
            if (!list) return;
            list.innerHTML = '';
            const modal = new bootstrap.Modal(document.getElementById('resultModalTen'));
            modal.show();
            lastTenResults = results || [];

            const totalValue = results.reduce((sum, r) => {
                const base = rarityValueMap[r.rarity] || 0;
                const multiplier = r.is_mutant ? 3 : 1;
                return sum + (base * multiplier);
            }, 0);
            const totalEl = document.getElementById('result-ten-total');
            if (totalEl) totalEl.textContent = '';
            const sellBtn = document.getElementById('result-ten-sell-btn');
            if (sellBtn) sellBtn.style.display = 'none';

            // ã¾ãšå…¨ã¦ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã®ã¿è¡¨ç¤º
            results.forEach((r) => {
                const card = document.createElement('div');
                card.className = 'text-center ten-result-item';
                card.style.opacity = '0';
                card.style.transform = 'translateY(8px)';
                const rarityText = r.rarity || 'ãƒ¬ã‚¢ãƒªãƒ†ã‚£ä¸æ˜';
                const rarityClass = getRarityClass(rarityText);
                card.innerHTML = `
                    <div class="fw-bold ${rarityClass} text-dark mb-2">${rarityText}</div>
                `;
                list.appendChild(card);
            });

            // ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã‚’å…ˆã«è¦‹ã›ã¦ã‹ã‚‰ã€1ç§’ã”ã¨ã«ãƒãƒƒã‚¸ç”»åƒã¸å¤‰æ›
            Array.from(list.children).forEach((card, idx) => {
                const r = results[idx];
                const rarityText = r?.rarity || 'ãƒ¬ã‚¢ãƒªãƒ†ã‚£ä¸æ˜';
                const rarityClass = getRarityClass(rarityText);
                setTimeout(() => {
                    card.style.transition = 'all 0.3s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                    card.innerHTML = `
                        <div class="fw-bold ${rarityClass} text-dark mb-2">${rarityText}</div>
                        <div class="mutant-badge-container mini ${r?.is_mutant ? 'active' : ''}" style="width: 96px; height: 96px; margin: 0 auto;">
                            <img src="${r?.image_url || '../images/placeholder-badge.png'}" alt="${r?.name || ''}" style="width: 100%; height: 100%; object-fit: contain;">
                            ${window.MutantBadge ? window.MutantBadge.renderShine(!!r?.is_mutant) : '<div class=\"mutant-badge-shine\"></div>'}
                        </div>
                    `;
                    card.dataset.uuid = r?.uuid || '';
                    card.addEventListener('click', () => {
                        card.classList.toggle('selected');
                        updateTenSellButtonState();
                    });
                    if (idx === results.length - 1 && totalEl) {
                        totalEl.textContent = `åˆè¨ˆä¾¡å€¤: ğŸª™ ${totalValue.toLocaleString()}`;
                    }
                }, (idx + 1) * 1000);
            });
        }

        function showResult(result) {
            const rarityEl = document.getElementById('result-rarity-badge');
            const headerEl = document.getElementById('result-header');
            const rarity = result.rarity || 'ãƒ¬ã‚¢ãƒªãƒ†ã‚£ä¸æ˜';
            rarityEl.textContent = rarity;
            rarityEl.className = 'result-rarity ' + getRarityClass(rarity);
            const isMutant = !!result.is_mutant;
            const resultBody = document.querySelector('#resultModal .result-body');
            if (resultBody) {
                resultBody.innerHTML = `
                    <div class="mutant-badge-container large ${isMutant ? 'active' : ''}" style="width: 140px; height: 140px; margin: 0 auto;">
                        <img src="${result.image_url || '../images/placeholder-badge.png'}" alt="${result.name || ''}" style="width: 100%; height: 100%; object-fit: contain;">
                        ${window.MutantBadge ? window.MutantBadge.renderShine(isMutant) : '<div class=\"mutant-badge-shine\"></div>'}
                    </div>
                    <h3 id="result-name" class="fw-bold mb-3">${result.name || ''}</h3>
                    <p id="result-msg" class="text-muted mb-4"></p>
                `;
            }
            const msgEl = document.getElementById('result-msg');
            lastDrawnBadgeUuid = result.uuid || null;
            lastDrawnBadgeMeta = {
                uuid: result.uuid || null,
                badgeId: result.badge_id || null,
                name: result.name || null
            };
            const sellBtn = document.getElementById('result-sell-btn');
            if (sellBtn) sellBtn.style.display = lastDrawnBadgeUuid ? 'inline-block' : 'none';

            if (result.type === 'stone') {
                headerEl.innerHTML = '<span class="fs-4 fw-bold">ğŸ’  æ›é‡‘ã§ãã‚‹çŸ³ã‚’æˆã‹ã‚Šã¾ã—ãŸ</span>';
                msgEl.textContent = 'æ›é‡‘ç”¨ã®ä¾¡å€¤ã‚ã‚‹çŸ³ã§ã™ã€‚æ‰€æŒå“ã‹ã‚‰ç¢ºèªãƒ»å£²å´ã§ãã¾ã™ã€‚';
            } else if (result.type === 'exchange_ticket') {
                headerEl.innerHTML = '<span class="fs-4 fw-bold">ğŸ« å¼•æ›åˆ¸ã‚’æˆã‹ã‚Šã¾ã—ãŸ</span>';
                msgEl.textContent = `è©²å½“ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã®ãƒãƒƒã‚¸ãŒä¸åœ¨ã ã£ãŸãŸã‚ã€${rarity}å¼•æ›åˆ¸ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚`;
            } else {
                headerEl.innerHTML = '<span class="fs-4 fw-bold">âœ¨ æ–°ã—ã„ç¸ã‚’æˆã‹ã‚Šã¾ã—ãŸ</span>';
                const value = rarityValueMap[rarity] || 0;
                const mutantLabel = result.is_mutant ? ' <span class="mutant-label">ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ³ãƒˆ</span>' : '';
                msgEl.innerHTML = `æ–°ã—ã„ãƒãƒƒã‚¸ã‚’ç²å¾—ã—ã¾ã—ãŸï¼${mutantLabel}<br>ä¾¡å€¤: ğŸª™ ${value.toLocaleString()}`;
            }

            const modal = new bootstrap.Modal(document.getElementById('resultModal'));
            modal.show();
        }

        function updateTenSellButtonState() {
            const sellBtn = document.getElementById('result-ten-sell-btn');
            if (!sellBtn) return;
            const selected = Array.from(document.querySelectorAll('.ten-result-item.selected'));
            sellBtn.style.display = selected.length > 0 ? 'inline-block' : 'none';
        }

        async function sellBadgeByUuid(badgeUuid) {
            const { data, error } = await supabaseClient.rpc('sell_badge_v2', {
                p_user_id: currentUser.user_metadata.provider_id,
                p_badge_uuid: badgeUuid
            });
            if (error || (data && data.error)) {
                throw new Error(error?.message || data?.error || 'å£²å´ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            return data;
        }

        async function handleSellSingle() {
            if (!lastDrawnBadgeUuid) return;
            if (!confirm('ã“ã®ãƒãƒƒã‚¸ã‚’å£²å´ã—ã¾ã™ã‹ï¼Ÿ')) return;
            try {
                const data = await sellBadgeByUuid(lastDrawnBadgeUuid);
                await logActivity(currentUser.user_metadata.provider_id, 'badge_sell', {
                    amount: data.sell_price,
                    badgeId: lastDrawnBadgeMeta?.badgeId || null,
                    details: { badge_name: lastDrawnBadgeMeta?.name || null, source: 'osaisen' }
                });
                showSellResult(`å£²å´ã—ã¾ã—ãŸï¼ (ğŸª™ +${data.sell_price.toLocaleString()})`);
                lastDrawnBadgeUuid = null;
                lastDrawnBadgeMeta = null;
                const sellBtn = document.getElementById('result-sell-btn');
                if (sellBtn) sellBtn.style.display = 'none';
                bootstrap.Modal.getOrCreateInstance(document.getElementById('resultModal')).hide();
            } catch (err) {
                showSellResult('å£²å´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            }
        }

        async function handleSellTenSelected() {
            const selected = Array.from(document.querySelectorAll('.ten-result-item.selected'))
                .map(el => el.dataset.uuid)
                .filter(Boolean);
            if (selected.length === 0) return;
            if (!confirm(`é¸æŠã—ãŸ ${selected.length} å€‹ã‚’å£²å´ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            try {
                let total = 0;
                for (const uuid of selected) {
                    const data = await sellBadgeByUuid(uuid);
                    total += data.sell_price || 0;
                    const meta = lastTenResults.find(r => r.uuid === uuid);
                    await logActivity(currentUser.user_metadata.provider_id, 'badge_sell', {
                        amount: data.sell_price,
                        badgeId: meta?.badge_id || null,
                        details: { badge_name: meta?.name || null, source: 'osaisen' }
                    });
                }
                showSellResult(`å£²å´ã—ã¾ã—ãŸï¼ (ğŸª™ +${total.toLocaleString()})`);
                selected.forEach(uuid => {
                    const el = document.querySelector(`.ten-result-item[data-uuid="${uuid}"]`);
                    if (el) el.classList.remove('selected');
                });
                updateTenSellButtonState();
                bootstrap.Modal.getOrCreateInstance(document.getElementById('resultModalTen')).hide();
            } catch (err) {
                showSellResult('å£²å´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            }
        }

        function showSellResult(message) {
            const msg = document.getElementById('sell-result-message');
            if (msg) msg.textContent = message;
            bootstrap.Modal.getOrCreateInstance(document.getElementById('sellResultModal')).show();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const sellBtn = document.getElementById('result-sell-btn');
            if (sellBtn) sellBtn.addEventListener('click', handleSellSingle);
            const sellTenBtn = document.getElementById('result-ten-sell-btn');
            if (sellTenBtn) sellTenBtn.addEventListener('click', handleSellTenSelected);
        });
    </script>
</body>

</html>
