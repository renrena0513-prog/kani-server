<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠè³½éŠ­ç®± - ã‹ã«é¯–</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../styles.css">
    <style>
        /* ã‚¬ãƒãƒ£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shake {
            0% {
                transform: translate(1px, 1px) rotate(0deg);
            }

            10% {
                transform: translate(-1px, -2px) rotate(-1deg);
            }

            20% {
                transform: translate(-3px, 0px) rotate(1deg);
            }

            30% {
                transform: translate(3px, 2px) rotate(0deg);
            }

            40% {
                transform: translate(1px, -1px) rotate(1deg);
            }

            50% {
                transform: translate(-1px, 2px) rotate(-1deg);
            }

            60% {
                transform: translate(-3px, 1px) rotate(0deg);
            }

            70% {
                transform: translate(3px, 1px) rotate(-1deg);
            }

            80% {
                transform: translate(-1px, -1px) rotate(1deg);
            }

            90% {
                transform: translate(1px, 2px) rotate(0deg);
            }

            100% {
                transform: translate(1px, -2px) rotate(-1deg);
            }
        }

        .shaking {
            animation: shake 0.5s infinite;
        }

        @keyframes coin-toss {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            50% {
                transform: translateY(-100px) scale(1.5);
                opacity: 1;
            }

            100% {
                transform: translateY(150px) scale(0.5);
                opacity: 0;
            }
        }

        .coin-animation {
            position: absolute;
            font-size: 2rem;
            z-index: 10;
            top: 50%;
            left: 50%;
            margin-left: -1rem;
            pointer-events: none;
            display: none;
        }

        .coin-animation.active {
            display: block;
            animation: coin-toss 0.8s ease-in forwards;
        }

        /* çµæœãƒ¢ãƒ¼ãƒ€ãƒ«ã®è£…é£¾ */
        #resultModal .modal-content {
            background: radial-gradient(circle at center, #fff 0%, #f0f0f0 100%);
            border: 5px solid var(--gold);
            border-radius: 24px;
        }

        .result-badge-img {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin: 20px auto;
            filter: drop-shadow(0 0 20px rgba(212, 168, 83, 0.4));
        }

        .result-rarity {
            font-weight: bold;
            padding: 4px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 10px;
            font-size: 0.8rem;
        }

        /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£åˆ¥èƒŒæ™¯ */
        .rarity-wood {
            background: #d7ccc8;
            color: #5d4037;
        }

        .rarity-stone {
            background: #cfd8dc;
            color: #455a64;
        }

        .rarity-bronze {
            background: #ffe0b2;
            color: #e65100;
        }

        .rarity-silver {
            background: #f5f5f5;
            color: #616161;
        }

        .rarity-gold {
            background: linear-gradient(135deg, #fff9c4 0%, #fbc02d 100%);
            color: #f57f17;
        }

        .rarity-platinum {
            background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%);
            color: #0277bd;
        }

        .rarity-gem {
            background: linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%);
            color: #7b1fa2;
        }

        .odds-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .odds-category {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            text-align: left;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* æ”¯æ‰•ã„æ–¹æ³•é¸æŠã‚«ãƒ¼ãƒ‰ */
        .payment-option {
            cursor: pointer;
        }

        .payment-option input[type="radio"] {
            display: none;
        }

        .payment-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #fff;
            transition: all 0.3s ease;
        }

        .payment-option input:checked+.payment-card {
            background: rgba(212, 168, 83, 0.3);
            border-color: var(--gold);
            box-shadow: 0 0 15px rgba(212, 168, 83, 0.4);
        }

        .payment-card:hover {
            transform: translateY(-3px);
            border-color: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>

<body>
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆJSã§æŒ¿å…¥ï¼‰ -->
    <div class="nav-dropdown"></div>

    <div class="container py-5">
        <header class="text-center">
            <h1 class="page-header display-4 fw-bold">â›©ï¸ ãŠè³½éŠ­ç®±</h1>
            <p class="text-white-50">ç¥ˆé¡˜ç¬¦ã‚’æ§ã’ã¦ã€ç¸ã‚’æˆã‹ã‚Šã¾ã—ã‚‡ã†</p>
        </header>

        <div class="gacha-container text-center">
            <div id="osaisen-box-area" class="osaisen-box-wrapper mx-auto mb-4"
                style="position: relative; width: fit-content;">
                <div id="coin" class="coin-animation">ğŸª™</div>
                <div id="osaisen-box" style="font-size: 100px; cursor: default;">ğŸ«</div>
            </div>

            <div class="mb-4">
                <h3 class="fw-bold" style="color: var(--crimson);">å¹¸é‹ã‚’é¡˜ã£ã¦ã€ãŠè³½éŠ­ã‚’å¥‰ç´ã—ã¾ã—ã‚‡ã†</h3>
                <p class="text-muted">ç¥ˆé¡˜ç¬¦1æšã€ã¾ãŸã¯ã‚³ã‚¤ãƒ³50æšã§ãŠè³½éŠ­ã‚’æŠ•ã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
            </div>

            <div
                class="ticket-balance d-inline-flex align-items-center bg-dark bg-opacity-25 px-4 py-2 rounded-pill mb-3 border border-secondary border-opacity-25">
                <span class="fs-4 me-2">ğŸ«</span>
                <span class="me-2 text-white-50">ç¥ˆé¡˜ç¬¦:</span>
                <span id="ticket-count" class="fw-bold text-white fs-5">- æš</span>
                <span class="mx-3 text-white-50">|</span>
                <span class="fs-4 me-2">ğŸª™</span>
                <span class="me-2 text-white-50">ã‚³ã‚¤ãƒ³:</span>
                <span id="coin-count" class="fw-bold text-white fs-5">- C</span>
            </div>

            <!-- æ”¯æ‰•ã„æ–¹æ³•é¸æŠ -->
            <div class="mb-4">
                <div class="d-flex justify-content-center gap-3">
                    <label class="payment-option">
                        <input type="radio" name="payment-type" value="ticket" checked>
                        <div class="payment-card">
                            <span class="fs-3">ğŸ«</span>
                            <span class="fw-bold">ç¥ˆé¡˜ç¬¦ 1æš</span>
                        </div>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="payment-type" value="coin">
                        <div class="payment-card">
                            <span class="fs-3">ğŸª™</span>
                            <span class="fw-bold">ã‚³ã‚¤ãƒ³ 50æš</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="mt-2" id="draw-area">
                <button id="draw-btn" class="gacha-btn" onclick="handleDraw()">
                    ğŸ™ ãŠè³½éŠ­ã‚’å¥‰ç´ã™ã‚‹
                </button>
                <div id="not-started-msg" class="alert alert-warning mt-3 mx-auto"
                    style="display: none; max-width: 400px;">
                    âœ¨ ç¾åœ¨ã€ç¥äº‹ã®æº–å‚™ã‚’ã—ã¦ã„ã¾ã™ã€‚ãŠè³½éŠ­ç®±ã¯ã¾ã é–‹ã„ã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚r
                </div>
            </div>

            <!-- æä¾›å‰²åˆè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="mt-5 text-center">
                <a href="javascript:void(0)" class="text-white-50 small text-decoration-none" onclick="toggleOdds()">
                    <i class="bi bi-info-circle me-1"></i> æä¾›å‰²åˆã‚’ç¢ºèªã™ã‚‹
                </a>
                <div id="odds-area" class="mt-4 p-4 rounded shadow-lg mx-auto"
                    style="background: rgba(0,0,0,0.3); display: none; max-width: 600px; border: 1px solid rgba(255,255,255,0.1);">
                    <div id="odds-list-badges" class="row g-2 mb-4">
                        <div class="col-12 odds-category">ğŸ“¿ ãƒãƒƒã‚¸ãƒ»å¼•æ›åˆ¸</div>
                        <!-- JSã§ãƒãƒƒã‚¸ç³»ã‚’æŒ¿å…¥ -->
                    </div>
                    <div id="odds-list-stones" class="row g-2">
                        <div class="col-12 odds-category">ğŸ’  å¾¡ç¥çŸ³ï¼ˆæ›é‡‘ç”¨ãƒãƒƒã‚¸ï¼‰</div>
                        <!-- JSã§çŸ³ç³»ã‚’æŒ¿å…¥ -->
                    </div>
                </div>
            </div>

            <!-- æ’å‡ºãƒãƒƒã‚¸ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="mt-4 text-center">
                <a href="javascript:void(0)" class="text-white-50 small text-decoration-none"
                    onclick="toggleBadgePool()">
                    <i class="bi bi-collection me-1"></i> æ’å‡ºãƒãƒƒã‚¸ä¸€è¦§ã‚’è¦‹ã‚‹
                </a>
                <div id="badge-pool-area" class="mt-4 p-4 rounded shadow-lg mx-auto"
                    style="background: rgba(0,0,0,0.3); display: none; max-width: 800px; border: 1px solid rgba(255,255,255,0.1);">
                    <div id="badge-pool-list">
                        <p class="text-white-50">èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <!-- çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <div id="result-header" class="mb-2">
                    <span class="fs-4 fw-bold">â›©ï¸ ã”ç¸ãŒã‚ã‚Šã¾ã—ãŸ</span>
                </div>
                <div id="result-rarity-badge" class="result-rarity">ãƒ¬ã‚¢ãƒªãƒ†ã‚£</div>
                <div class="result-body">
                    <img id="result-img" src="" class="result-badge-img" alt="ãƒãƒƒã‚¸">
                    <h3 id="result-name" class="fw-bold mb-3">ãƒãƒƒã‚¸å</h3>
                    <p id="result-msg" class="text-muted mb-4">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
                </div>
                <button type="button" class="btn btn-primary rounded-pill px-5" data-bs-dismiss="modal">
                    ã‚ã‚ŠãŒãŸãå—ã‘å–ã‚‹
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/badge-utils.js"></script>
    <script src="../js/auth-guard.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        let currentUser = null;
        let isDrawing = false;
        let provisionData = null;

        document.addEventListener('DOMContentLoaded', async function () {
            initAccordionNav('../');

            const user = await getCurrentUser();
            if (!user) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚');
                window.location.href = '../index.html';
                return;
            }
            currentUser = user;
            fetchTicketCount();
        });

        async function fetchTicketCount() {
            const discordId = currentUser.user_metadata.provider_id;
            const { data, error } = await supabaseClient
                .from('profiles')
                .select('gacha_tickets, coins')
                .eq('discord_user_id', discordId)
                .maybeSingle();

            if (error) {
                console.error('æ®‹é«˜å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return;
            }

            const ticketCount = data?.gacha_tickets || 0;
            const coinCount = data?.coins || 0;

            const ticketEl = document.getElementById('ticket-count');
            const coinEl = document.getElementById('coin-count');

            if (ticketEl) ticketEl.textContent = `${ticketCount.toLocaleString()} æš`;
            if (coinEl) coinEl.textContent = `${coinCount.toLocaleString()} C`;
        }

        async function fetchProvisionRatio() {
            try {
                // 1. ãƒ¡ã‚¤ãƒ³é‡ã¿ (çŸ³ vs ãƒãƒƒã‚¸)
                const { data: mainConfigs } = await supabaseClient.from('gacha_configs').select('name, weight').eq('category', 'main');
                // 2. çŸ³ã®å†…è¨³
                const { data: stoneConfigs } = await supabaseClient.from('gacha_configs').select('name, weight').eq('category', 'stone_type');
                // 3. ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã®å†…è¨³ï¼ˆé–¾å€¤é †ã§ã‚½ãƒ¼ãƒˆæ¸ˆã¿ï¼‰
                const { data: rarityThresholds } = await supabaseClient.from('rarity_thresholds').select('rarity_name, gacha_weight, threshold_value').gt('gacha_weight', 0).order('threshold_value', { ascending: true });

                const totalMain = mainConfigs.reduce((s, c) => s + c.weight, 0);
                const badgeTotalWeight = mainConfigs.find(c => c.name === 'badge')?.weight || 0;
                const stoneTotalWeight = mainConfigs.find(c => c.name === 'stone')?.weight || 0;

                const badgeRatio = badgeTotalWeight / totalMain; // ä¾‹: 0.3
                const stoneRatio = stoneTotalWeight / totalMain; // ä¾‹: 0.7

                const totalRarityWeight = rarityThresholds.reduce((s, r) => s + r.gacha_weight, 0);
                const totalStoneTypeWeight = stoneConfigs.reduce((s, c) => s + c.weight, 0);

                provisionData = {
                    badges: rarityThresholds.map(r => ({
                        name: r.rarity_name,
                        percent: ((r.gacha_weight / totalRarityWeight) * badgeRatio * 100).toFixed(2)
                    })),
                    stones: stoneConfigs
                        .map(c => ({
                            name: c.name,
                            percent: ((c.weight / totalStoneTypeWeight) * stoneRatio * 100).toFixed(2),
                            // ã‚½ãƒ¼ãƒˆç”¨ã®å„ªå…ˆåº¦
                            order: c.name.includes('éŠ…') ? 1 : c.name.includes('éŠ€') ? 2 : c.name.includes('é‡‘') ? 3 : 4
                        }))
                        .sort((a, b) => a.order - b.order)
                };

                renderOdds();
            } catch (err) {
                console.error('æä¾›å‰²åˆå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
            }
        }

        function renderOdds() {
            if (!provisionData) return;

            const badgeList = document.getElementById('odds-list-badges');
            const stoneList = document.getElementById('odds-list-stones');

            // æ—¢å­˜ã®ã‚«ãƒ†ã‚´ãƒªãƒ©ãƒ™ãƒ«ä»¥å¤–ã‚’ã‚¯ãƒªã‚¢
            Array.from(badgeList.children).slice(1).forEach(el => el.remove());
            Array.from(stoneList.children).slice(1).forEach(el => el.remove());

            provisionData.badges.forEach(b => {
                const div = document.createElement('div');
                div.className = 'col-6 col-md-4';
                div.innerHTML = `
                    <div class="odds-item d-flex justify-content-between">
                        <span class="text-white-50">${b.name}</span>
                        <span style="color: var(--gold);">${b.percent}%</span>
                    </div>`;
                badgeList.appendChild(div);
            });

            provisionData.stones.forEach(s => {
                const div = document.createElement('div');
                div.className = 'col-6 col-md-4';
                div.innerHTML = `
                    <div class="odds-item d-flex justify-content-between">
                        <span class="text-white-50">${s.name}</span>
                        <span style="color: var(--gold);">${s.percent}%</span>
                    </div>`;
                stoneList.appendChild(div);
            });
        }

        function toggleOdds() {
            const area = document.getElementById('odds-area');
            if (area.style.display === 'none') {
                area.style.display = 'block';
                if (!provisionData) fetchProvisionRatio();
            } else {
                area.style.display = 'none';
            }
        }

        let badgePoolData = null;

        function toggleBadgePool() {
            const area = document.getElementById('badge-pool-area');
            if (area.style.display === 'none') {
                area.style.display = 'block';
                if (!badgePoolData) fetchBadgePool();
            } else {
                area.style.display = 'none';
            }
        }

        async function fetchBadgePool() {
            try {
                // ãƒ¬ã‚¢ãƒªãƒ†ã‚£é–¾å€¤ã€ãƒãƒƒã‚¸ã€æµé€šæ•°ã€ã‚¬ãƒãƒ£é‡ã¿ã‚’å–å¾—
                const [badgesRes, thresholdsRes, circulationRes, mainConfigRes] = await Promise.all([
                    supabaseClient.from('badges').select('id, name, image_url, price, fixed_rarity_name, sales_type, is_gacha_eligible, remaining_count').eq('is_gacha_eligible', true),
                    supabaseClient.from('rarity_thresholds').select('rarity_name, threshold_value, gacha_weight').order('threshold_value', { ascending: true }),
                    supabaseClient.from('user_badges_new').select('badge_id'),
                    supabaseClient.from('gacha_configs').select('name, weight').eq('category', 'main')
                ]);

                if (badgesRes.error) throw badgesRes.error;
                if (thresholdsRes.error) throw thresholdsRes.error;

                // remaining_count ãŒ 0 ã®ãƒãƒƒã‚¸ã‚’é™¤å¤–ï¼ˆnull ã¯ç„¡åˆ¶é™ã¨ã—ã¦æ‰±ã†ï¼‰
                const badges = (badgesRes.data || []).filter(b => b.remaining_count === null || b.remaining_count > 0);
                const thresholds = thresholdsRes.data || [];
                const mainConfigs = mainConfigRes.data || [];

                // ãƒãƒƒã‚¸å½“é¸ç¢ºç‡ï¼ˆçŸ³ vs ãƒãƒƒã‚¸ã®æ¯”ç‡ï¼‰
                const totalMainWeight = mainConfigs.reduce((s, c) => s + c.weight, 0);
                const badgeWeight = mainConfigs.find(c => c.name === 'badge')?.weight || 0;
                const badgeRatio = badgeWeight / totalMainWeight; // ãƒãƒƒã‚¸ãŒå½“ãŸã‚‹ç¢ºç‡

                // ãƒ¬ã‚¢ãƒªãƒ†ã‚£åˆ¥é‡ã¿ã®åˆè¨ˆ
                const totalRarityWeight = thresholds.reduce((s, t) => s + (t.gacha_weight || 0), 0);

                // ãƒ¬ã‚¢ãƒªãƒ†ã‚£åˆ¥æ’å‡ºç‡ãƒãƒƒãƒ—
                const rarityPercentMap = {};
                thresholds.forEach(t => {
                    rarityPercentMap[t.rarity_name] = (t.gacha_weight / totalRarityWeight) * badgeRatio * 100;
                });

                // æµé€šæ•°ã‚«ã‚¦ãƒ³ãƒˆ
                const circulation = {};
                (circulationRes.data || []).forEach(r => {
                    circulation[r.badge_id] = (circulation[r.badge_id] || 0) + 1;
                });

                // å‹•çš„ãƒ¬ã‚¢ãƒªãƒ†ã‚£è¨ˆç®—ï¼ˆBadgeUtilsä½¿ç”¨ï¼‰
                function getDynamicRarity(badge) {
                    if (badge.fixed_rarity_name) return badge.fixed_rarity_name;
                    if (badge.sales_type !== 'å¤‰å‹•å‹') return badge.fixed_rarity_name || 'ä¸€èˆ¬';

                    const n = circulation[badge.id] || 0;
                    const result = BadgeUtils.calculateBadgeValues(badge, n, thresholds);
                    return result.rarityName;
                }

                // ãƒ¬ã‚¢ãƒªãƒ†ã‚£åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const grouped = {};
                badges.forEach(b => {
                    const rarity = getDynamicRarity(b);
                    if (!grouped[rarity]) grouped[rarity] = [];
                    grouped[rarity].push(b);
                });

                // ãƒ¬ã‚¢ãƒªãƒ†ã‚£é †åº
                const rarityOrder = ['æ¸¬å®šä¸èƒ½', 'ç¥è©±', 'è‡³é«˜', 'å¹»æƒ³', 'ä¼èª¬', 'æ¥µä¸Š', 'ç‰¹ä¸Š', 'è²´é‡', 'å¸Œå°‘ãƒ»â…¡', 'å¸Œå°‘ãƒ»â… ', 'è‰¯è³ª', 'ä¸€èˆ¬'];

                // HTMLç”Ÿæˆ
                const listEl = document.getElementById('badge-pool-list');
                let html = '';

                for (const rarity of rarityOrder) {
                    if (!grouped[rarity] || grouped[rarity].length === 0) continue;
                    const badgesInRarity = grouped[rarity];
                    const rarityPercent = rarityPercentMap[rarity] || 0;
                    const perBadgePercent = rarityPercent / badgesInRarity.length;

                    html += `
                        <div class="mb-3">
                            <div class="text-start mb-2">
                                <span class="badge bg-light text-dark">${rarity}</span>
                                <span class="small text-white-50">(${badgesInRarity.length}ç¨® / è¨ˆ${rarityPercent.toFixed(2)}%)</span>
                            </div>
                            <div class="d-flex flex-wrap gap-2 justify-content-start">
                                ${badgesInRarity.map(b => `
                                    <div class="text-center" style="width: 70px; cursor: pointer;" onclick="window.location.href='../badge/index.html?id=${b.id}'">
                                        <img src="${b.image_url}" style="width: 50px; height: 50px; object-fit: contain; border-radius: 8px; background: rgba(255,255,255,0.1);">
                                        <div class="small text-truncate" style="font-size: 0.65rem; color: #ffc107;">${perBadgePercent.toFixed(2)}%</div>
                                        <div class="small text-white-50 text-truncate" style="font-size: 0.6rem;">${b.name}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                if (!html) html = '<p class="text-white-50">æ’å‡ºå¯¾è±¡ã®ãƒãƒƒã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                listEl.innerHTML = html;
                badgePoolData = grouped;

            } catch (err) {
                console.error('æ’å‡ºãƒãƒƒã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                document.getElementById('badge-pool-list').innerHTML = '<p class="text-danger">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
            }
        }

        async function handleDraw() {
            if (isDrawing) return;

            // ãŠè³½éŠ­ã®åˆ¶é™ã‚’è§£é™¤ - å…¨å“¡ãŒã‚¬ãƒãƒ£ã‚’å›ã›ã‚‹ã‚ˆã†ã«
            // const discordId = currentUser.user_metadata.provider_id;
            // const isAdmin = ADMIN_DISCORD_IDS.includes(discordId);
            // const notStartedMsg = document.getElementById('not-started-msg');
            // if (!isAdmin) {
            //     notStartedMsg.style.display = 'block';
            //     setTimeout(() => { notStartedMsg.style.display = 'none'; }, 5000);
            //     return;
            // }

            // æ”¯æ‰•ã„æ–¹æ³•ã‚’å–å¾—
            const paymentType = document.querySelector('input[name="payment-type"]:checked')?.value || 'ticket';

            isDrawing = true;

            const btn = document.getElementById('draw-btn');
            const box = document.getElementById('osaisen-box');
            const coin = document.getElementById('coin');

            btn.disabled = true;

            try {
                // 1. ã‚³ã‚¤ãƒ³æŠ•ã’ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                coin.classList.add('active');

                // 2. è³½éŠ­ç®±ã®æºã‚Œ
                setTimeout(() => {
                    box.classList.add('shaking');
                }, 400);

                // 3. RPCå‘¼ã³å‡ºã—ï¼ˆæ”¯æ‰•ã„æ–¹æ³•ã‚’æ¸¡ã™ï¼‰
                const { data, error } = await supabaseClient.rpc('draw_gacha', {
                    p_user_id: currentUser.user_metadata.provider_id,
                    p_payment_type: paymentType
                });

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¦‹ã›ã‚‹ãŸã‚ã®å¾…æ©Ÿ
                await new Promise(resolve => setTimeout(resolve, 1500));

                if (error) throw error;
                if (!data.ok) throw new Error(data.error);

                showResult(data);

            } catch (err) {
                console.error('ã‚¬ãƒãƒ£ã‚¨ãƒ©ãƒ¼:', err);
                alert('å¥‰ç´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
            } finally {
                isDrawing = false;
                coin.classList.remove('active');
                box.classList.remove('shaking');
                btn.disabled = false;
                fetchTicketCount();
            }
        }

        function showResult(result) {
            const imgEl = document.getElementById('result-img');
            const nameEl = document.getElementById('result-name');
            const msgEl = document.getElementById('result-msg');
            const rarityEl = document.getElementById('result-rarity-badge');
            const headerEl = document.getElementById('result-header');

            imgEl.src = result.image_url || '../images/placeholder-badge.png';
            nameEl.textContent = result.name;

            const rarity = result.rarity || 'ä¸€èˆ¬';
            rarityEl.textContent = rarity;
            rarityEl.className = 'result-rarity ' + getRarityClass(rarity);

            if (result.type === 'stone') {
                headerEl.innerHTML = '<span class="fs-4 fw-bold">ğŸ’  æ›é‡‘ã§ãã‚‹çŸ³ã‚’æˆã‹ã‚Šã¾ã—ãŸ</span>';
                msgEl.textContent = 'æ›é‡‘ç”¨ã®ä¾¡å€¤ã‚ã‚‹çŸ³ã§ã™ã€‚æ‰€æŒå“ã‹ã‚‰ç¢ºèªãƒ»å£²å´ã§ãã¾ã™ã€‚';
            } else if (result.type === 'exchange_ticket') {
                headerEl.innerHTML = '<span class="fs-4 fw-bold">ğŸ« å¼•æ›åˆ¸ã‚’æˆã‹ã‚Šã¾ã—ãŸ</span>';
                msgEl.textContent = `è©²å½“ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã®ãƒãƒƒã‚¸ãŒä¸åœ¨ã ã£ãŸãŸã‚ã€${rarity}å¼•æ›åˆ¸ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚`;
                imgEl.src = 'https://cdn-icons-png.flaticon.com/512/812/812328.png';
            } else {
                headerEl.innerHTML = '<span class="fs-4 fw-bold">âœ¨ æ–°ã—ã„ç¸ã‚’æˆã‹ã‚Šã¾ã—ãŸ</span>';
                msgEl.textContent = 'æ–°ã—ã„ãƒãƒƒã‚¸ã‚’ç²å¾—ã—ã¾ã—ãŸï¼ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚„æ‰€æŒå“ã‹ã‚‰ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            }

            const modal = new bootstrap.Modal(document.getElementById('resultModal'));
            modal.show();
        }
    </script>
</body>

</html>
