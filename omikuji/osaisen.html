<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠè³½éŠ­ç®± - ã‹ã«é¯–</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../styles.css">
    <style>
        /* ã‚¬ãƒãƒ£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .shaking {
            animation: shake 0.5s infinite;
        }

        @keyframes coin-toss {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-100px) scale(1.5); opacity: 1; }
            100% { transform: translateY(150px) scale(0.5); opacity: 0; }
        }

        .coin-animation {
            position: absolute;
            font-size: 2rem;
            z-index: 10;
            top: 50%;
            left: 50%;
            margin-left: -1rem;
            pointer-events: none;
            display: none;
        }

        .coin-animation.active {
            display: block;
            animation: coin-toss 0.8s ease-in forwards;
        }

        /* çµæœãƒ¢ãƒ¼ãƒ€ãƒ«ã®è£…é£¾ */
        #resultModal .modal-content {
            background: radial-gradient(circle at center, #fff 0%, #f0f0f0 100%);
            border: 5px solid var(--gold);
            border-radius: 24px;
        }

        .result-badge-img {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin: 20px auto;
            filter: drop-shadow(0 0 20px rgba(212, 168, 83, 0.4));
        }

        .result-rarity {
            font-weight: bold;
            padding: 4px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 10px;
            font-size: 0.8rem;
        }

        /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£åˆ¥èƒŒæ™¯ */
        .rarity-wood { background: #d7ccc8; color: #5d4037; }
        .rarity-stone { background: #cfd8dc; color: #455a64; }
        .rarity-bronze { background: #ffe0b2; color: #e65100; }
        .rarity-silver { background: #f5f5f5; color: #616161; }
        .rarity-gold { background: linear-gradient(135deg, #fff9c4 0%, #fbc02d 100%); color: #f57f17; }
        .rarity-platinum { background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%); color: #0277bd; }
        .rarity-gem { background: linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%); color: #7b1fa2; }

        .odds-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .odds-category {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            text-align: left;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* æ”¯æ‰•ã„æ–¹æ³•é¸æŠã‚«ãƒ¼ãƒ‰ */
        .payment-option { cursor: pointer; }
        .payment-option input[type="radio"] { display: none; }

        .payment-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #fff;
            transition: all 0.3s ease;
        }

        .payment-option input:checked + .payment-card {
            background: rgba(212, 168, 83, 0.3);
            border-color: var(--gold);
            box-shadow: 0 0 15px rgba(212, 168, 83, 0.4);
        }

        .payment-card:hover {
            transform: translateY(-3px);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .badge-fade {
            animation: badgeFade 5s ease-in-out infinite;
        }

        @keyframes badgeFade {
            0% { opacity: 0; transform: translateY(6px) scale(0.98); }
            15% { opacity: 1; transform: translateY(0) scale(1); }
            85% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-6px) scale(0.98); }
        }

        .mutant-label {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(255, 215, 0, 0.2);
            color: #ffeaa7;
            font-weight: 700;
            font-size: 0.75rem;
            border: 1px solid rgba(255, 215, 0, 0.5);
        }

        .draw-mode-toggle {
            display: inline-flex;
            gap: 8px;
            padding: 6px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .draw-mode-btn {
            border: none;
            background: transparent;
            color: #fff;
            font-weight: 700;
            padding: 6px 16px;
            border-radius: 999px;
            transition: all 0.2s ease;
            opacity: 0.7;
        }

        .draw-mode-btn.active {
            background: rgba(255, 255, 255, 0.22);
            opacity: 1;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
        }

        .draw-mode-note {
            color: #fff;
            font-weight: 600;
            margin-top: 10px;
        }

        .draw-option-btn {
            border-radius: 999px;
            font-weight: 700;
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.12);
            color: #fff;
        }

        .draw-option-btn.active {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.95), rgba(255, 145, 0, 0.95));
            border-color: rgba(255, 214, 102, 0.95);
            color: #2b1b00;
            box-shadow: 0 8px 18px rgba(255, 193, 7, 0.35), 0 4px 10px rgba(0, 0, 0, 0.35);
        }

        .ten-result-item {
            cursor: pointer;
            border-radius: 10px;
            padding: 6px;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .ten-result-item.selected {
            border-color: var(--gold);
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.35);
            background: rgba(255, 215, 0, 0.08);
        }

        .gacha-tabs {
            display: inline-flex;
            gap: 10px;
            padding: 6px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .badge-pool-toggle {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.25);
            background: rgba(255, 255, 255, 0.08);
            color: #f8f9fa;
            font-weight: 700;
            letter-spacing: 0.01em;
            transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, border-color 0.15s ease;
        }

        .badge-pool-toggle:hover {
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 0.16);
            border-color: rgba(255, 255, 255, 0.45);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
            color: #fff;
        }

        .badge-pool-toggle:active {
            transform: translateY(0);
        }

        .gacha-tab-btn {
            border: none;
            background: transparent;
            color: #fff;
            font-weight: 700;
            padding: 8px 18px;
            border-radius: 999px;
            transition: all 0.2s ease;
            opacity: 0.7;
        }

        .gacha-tab-btn.active {
            background: rgba(255, 255, 255, 0.18);
            opacity: 1;
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
        }

        .gacha-mode-note {
            color: #f8f9fa;
            font-weight: 600;
            margin-top: 12px;
        }

        #gacha-price-note.emphasis {
            color: #ff2d2d;
            font-weight: 900;
            font-size: 1.15rem;
            text-shadow: 0 3px 10px rgba(0, 0, 0, 0.45);
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #fff;
            border-radius: 999px;
            padding: 4px 10px;
            display: inline-block;
        }

        .balance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .balance-card {
            background: rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .balance-card .label {
            color: rgba(255, 255, 255, 0.65);
            font-size: 0.85rem;
        }

        .balance-card .value {
            color: #fff;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .ticket-badge {
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 999px;
            padding: 2px 10px;
        }

        .badge-pool-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 12px;
        }

        @media (min-width: 992px) {
            .badge-pool-grid {
                grid-template-columns: repeat(6, minmax(0, 1fr));
            }
        }

        .badge-pool-item {
            text-align: center;
            cursor: pointer;
        }

        .badge-pool-item img {
            width: clamp(58px, 8vw, 78px);
            height: clamp(58px, 8vw, 78px);
            object-fit: contain;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }

        .jarebon-links-wrap {
            max-width: 520px;
            margin: 0 auto;
        }

        .jarebon-links-wrap .btn {
            width: 100%;
            max-width: 520px;
            white-space: normal;
        }

        /* notice dialog (shopæº–æ‹ ) */
        #notice-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        #notice-modal.active { display: flex; }

        .notice-dialog {
            background: #fff;
            border-radius: 12px;
            min-width: min(480px, 90vw);
            padding: 18px;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.25);
        }

        .notice-title {
            font-weight: 700;
            margin-bottom: 6px;
        }

        .notice-message {
            color: #333;
            margin-bottom: 14px;
        }

        .notice-actions {
            text-align: right;
        }

        .notice-dialog.success .notice-title { color: #2e7d32; }
        .notice-dialog.warning .notice-title { color: #b26a00; }
        .notice-dialog.error .notice-title { color: #b3261e; }

        #loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
            color: #fff;
            z-index: 2100;
        }

        #loading-overlay.active { display: flex; }

        .gacha-hero {
            width: min(720px, 92vw);
            border-radius: 18px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.35);
            overflow: hidden;
            background: rgba(0, 0, 0, 0.35);
        }

        body.gacha-loading #draw-options {
            display: none !important;
        }

        body.gacha-loading #osaisen-box {
            opacity: 0 !important;
        }

        body.gacha-loading .gacha-tab-btn {
            pointer-events: none;
            opacity: 0.6;
        }

        .gacha-hero img {
            width: 100%;
            height: auto;
            display: block;
        }

        .gacha-hero-emoji {
            font-size: clamp(3rem, 9vw, 7rem);
            padding: 28px 12px;
            text-align: center;
            color: #fff;
            text-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }

        .gacha-main-btn {
            font-size: 1.2rem;
            font-weight: 800;
            padding: 16px 46px;
            border-radius: 999px;
            border: none;
            color: #2b0c00;
            background: linear-gradient(135deg, #ffd86b 0%, #ff9f1a 100%);
            box-shadow: 0 18px 35px rgba(255, 154, 33, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.6);
            transition: transform 0.15s ease, box-shadow 0.2s ease;
        }

        .gacha-main-btn:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 24px 40px rgba(255, 154, 33, 0.45), inset 0 1px 0 rgba(255, 255, 255, 0.7);
        }

        .gacha-main-btn:disabled {
            opacity: 0.6;
            box-shadow: none;
            transform: none;
        }
    </style>
</head>

<body class="gacha-loading">
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loading-overlay">
        <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status"></div>
        <div class="h4">å‡¦ç†ä¸­...</div>
    </div>
    <div id="notice-modal" role="dialog" aria-modal="true" aria-labelledby="notice-title">
        <div class="notice-dialog info" id="notice-dialog">
            <div class="notice-title" id="notice-title">ãŠçŸ¥ã‚‰ã›</div>
            <div class="notice-message" id="notice-message">-</div>
            <div class="notice-actions">
                <button class="btn btn-outline-dark" type="button" onclick="closeNotice()">OK</button>
            </div>
        </div>
    </div>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆJSã§æŒ¿å…¥ï¼‰ -->
    <div class="nav-dropdown"></div>

    <div class="container py-5">
        <header class="text-center mb-4">
            <h1 class="page-header display-4 fw-bold">â›©ï¸ ãŠè³½éŠ­ç®±</h1>
            <p class="text-white-50">ãƒã‚±ãƒƒãƒˆã‚¬ãƒãƒ£ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚ã‚¬ãƒãƒ£ç¨®åˆ¥ã¯ã„ã¤ã§ã‚‚åˆ‡æ›¿ã§ãã¾ã™ã€‚</p>
            <div class="d-flex flex-column align-items-center gap-3 mt-3">
                <div class="d-inline-flex flex-wrap justify-content-center gap-3 mt-1">
                    <button class="btn btn-sm btn-outline-dark" style="border-radius: 20px; font-weight: bold;"
                        onclick="openPriceListModal()">
                        ğŸ“Š ãƒ¬ã‚¢ãƒªãƒ†ã‚£ä¾¡æ ¼è¡¨ã‚’è¦‹ã‚‹
                    </button>
                    <button class="btn btn-sm btn-outline-primary" style="border-radius: 20px; font-weight: bold;"
                        onclick="openInventoryModal()">
                        ğŸ’ æ‰€æŒãƒãƒƒã‚¸
                    </button>
                </div>
            </div>
        </header>

        <div class="mb-4">
            <div class="balance-grid">
                <div class="balance-card">
                    <div>
                        <div class="label">ã‚³ã‚¤ãƒ³</div>
                        <div class="value" id="coin-count">-</div>
                    </div>
                    <div class="fs-3">ğŸª™</div>
                </div>
                <div class="balance-card">
                    <div>
                        <div class="label">ç¥ˆé¡˜ç¬¦</div>
                        <div class="value" id="ticket-gacha-count">-</div>
                    </div>
                    <div class="fs-3">ğŸ«</div>
                </div>
                <div class="balance-card">
                    <div>
                        <div class="label">æº€é¡˜ç¬¦</div>
                        <div class="value" id="ticket-mangan-count">-</div>
                    </div>
                    <div class="fs-3">ğŸŸï¸</div>
                </div>
            </div>
        </div>

        <div class="gacha-container text-center">
            <div class="mb-4">
                <div class="gacha-tabs mx-auto">
                    <button class="gacha-tab-btn active" data-type="å¦–æ€ª" onclick="setGachaType('å¦–æ€ª')">ğŸ‘¹ å¦–æ€ª</button>
                    <button class="gacha-tab-btn" data-type="ã˜ã‚ƒã‚Œæœ¬" onclick="setGachaType('ã˜ã‚ƒã‚Œæœ¬')">ğŸ“˜ ã˜ã‚ƒã‚Œæœ¬</button>
                </div>
                <div id="gacha-type-note" class="gacha-mode-note"></div>
            </div>

            <div id="osaisen-box-area" class="osaisen-box-wrapper mx-auto mb-4"
                style="position: relative; width: fit-content;">
                <div id="coin" class="coin-animation">ğŸª™</div>
                <div id="osaisen-box" class="gacha-hero" style="cursor: default; opacity: 0;">
                    <img id="gacha-hero-image" src="../images/å¦–æ€ªã‚·ãƒªãƒ¼ã‚ºãƒãƒŠãƒ¼.png" alt="å¦–æ€ªã‚¬ãƒãƒ£">
                    <div id="gacha-hero-emoji" class="gacha-hero-emoji" style="display:none;">ğŸ“˜âœ¨</div>
                </div>
            </div>

            <div class="mb-4">
                <h3 class="fw-bold" style="color: var(--crimson);">å¹¸é‹ã‚’é¡˜ã£ã¦ã€ãŠè³½éŠ­ã‚’å¥‰ç´ã—ã¾ã—ã‚‡ã†</h3>
                <p class="" id="gacha-price-note">ãƒã‚±ãƒƒãƒˆã§å¥‰ç´ã§ãã¾ã™ã€‚</p>
            </div>

            <div class="mt-2" id="draw-area">
                <div class="d-flex flex-column align-items-center gap-3">
                    <div class="d-flex flex-wrap justify-content-center gap-2" id="draw-options" style="display: none;">
                        <button class="draw-option-btn active" data-payment="gacha_ticket" data-count="1"
                            onclick="setDrawOption('gacha_ticket', 1)">ğŸ« ç¥ˆé¡˜ç¬¦ 1æš</button>
                        <button class="draw-option-btn" data-payment="gacha_ticket" data-count="10"
                            onclick="setDrawOption('gacha_ticket', 10)">ğŸ« ç¥ˆé¡˜ç¬¦ 10æš</button>
                        <button class="draw-option-btn" data-payment="mangan_ticket" data-count="1"
                            onclick="setDrawOption('mangan_ticket', 1)">ğŸŸï¸ æº€é¡˜ç¬¦ 1æš</button>
                        <button class="draw-option-btn" data-payment="coin" data-count="1" id="coin-btn-1"
                            onclick="setDrawOption('coin', 1)">ğŸª™ ã‚³ã‚¤ãƒ³ 1å›</button>
                        <button class="draw-option-btn" data-payment="coin" data-count="10" id="coin-btn-10"
                            onclick="setDrawOption('coin', 10)">ğŸª™ ã‚³ã‚¤ãƒ³ 10å›</button>
                    </div>
                    <button id="draw-btn" class="gacha-btn gacha-main-btn" onclick="handleDraw()">
                        ğŸ™ ãŠè³½éŠ­ã‚’å¥‰ç´ã™ã‚‹
                    </button>
                </div>
            </div>

            <!-- æ’å‡ºãƒãƒƒã‚¸ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="mt-4 text-center">
                <a href="javascript:void(0)" class="badge-pool-toggle text-decoration-none"
                    onclick="toggleBadgePool()">
                    <i class="bi bi-collection me-1"></i> æä¾›å‰²åˆã‚’è¦‹ã‚‹
                </a>
                <div id="badge-pool-area" class="mt-4 p-4 rounded shadow-lg mx-auto"
                    style="background: rgba(0,0,0,0.3); display: none; max-width: 800px; border: 1px solid rgba(255,255,255,0.1);">
                    <div id="badge-pool-list">
                        <p class="text-white-50">èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <div id="result-header" class="mb-2">
                    <span class="fs-4 fw-bold">â›©ï¸ ã”ç¸ãŒã‚ã‚Šã¾ã—ãŸ</span>
                </div>
                <div id="result-rarity-badge" class="result-rarity">ãƒ¬ã‚¢ãƒªãƒ†ã‚£</div>
                <div class="result-body">
                    <img id="result-img" src="" class="result-badge-img" alt="ãƒãƒƒã‚¸">
                    <h3 id="result-name" class="fw-bold mb-3">ãƒãƒƒã‚¸å</h3>
                    <p id="result-msg" class="text-muted mb-4">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
                </div>
                <button type="button" class="btn btn-primary rounded-pill px-5" data-bs-dismiss="modal">
                    ã‚ã‚ŠãŒãŸãå—ã‘å–ã‚‹
                </button>
                <button type="button" class="btn btn-outline-danger rounded-pill px-5 mt-2" id="result-sell-btn"
                    style="display:none;">
                    ãã®å ´ã§å£²å´ã™ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- 10é€£çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="resultModalTen" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content text-center p-4">
                <div class="mb-2">
                    <span class="fs-4 fw-bold">âœ¨ 10é€£ã®çµæœ</span>
                </div>
                <div id="result-ten-total" class="text-dark fw-bold mb-2"></div>
                <div id="result-ten-list" class="d-grid gap-2"
                    style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
                    <!-- JSã§æŒ¿å…¥ -->
                </div>
                <button type="button" class="btn btn-outline-danger rounded-pill px-5 mt-3" id="result-ten-sell-btn"
                    style="display:none;">
                    é¸æŠã—ãŸã‚‚ã®ã‚’ã¾ã¨ã‚ã¦å£²å´
                </button>
                <button type="button" class="btn btn-primary rounded-pill px-5 mt-3" data-bs-dismiss="modal">
                    ã‚ã‚ŠãŒãŸãå—ã‘å–ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- å£²å´çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="sellResultModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <div class="fs-4 fw-bold mb-2">å£²å´å®Œäº†</div>
                <div id="sell-result-message" class="text-muted mb-3">å£²å´ã—ã¾ã—ãŸ</div>
                <button type="button" class="btn btn-primary rounded-pill px-5" data-bs-dismiss="modal">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- ä¾¡æ ¼ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="priceListModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
                <div class="modal-header border-0 bg-light" style="border-radius: 20px 20px 0 0;">
                    <h5 class="modal-title fw-bold">ğŸ“Š ãƒ¬ã‚¢ãƒªãƒ†ã‚£ä¾¡æ ¼ä¸€è¦§è¡¨</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 text-center align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col">ãƒ¬ã‚¢ãƒªãƒ†ã‚£å</th>
                                    <th scope="col">åŸºæº–ä¾¡æ ¼ (è³‡ç”£ä¾¡å€¤)</th>
                                    <th scope="col">é€šå¸¸å£²å´ç›®å®‰ (2æ®µéšä¸‹)</th>
                                </tr>
                            </thead>
                            <tbody id="price-list-tbody">
                                <!-- JSã§æç”» -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <small class="text-muted w-100 text-start">
                        â€» å¤‰å‹•å‹ãƒãƒƒã‚¸ã®ã€Œãƒ©ãƒ³ã‚¯ã€ã¯ã€åŸºæœ¬ãƒ©ãƒ³ã‚¯ + (æµé€šæ•° - 1) ã§æ±ºã¾ã‚Šã¾ã™ã€‚<br>
                        â€» å£²å´ä¾¡æ ¼ã¯ã€ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯ã®2æ®µéšä¸‹ã®ä¾¡æ ¼ã«ãªã‚Šã¾ã™ï¼ˆä¸‹é™â˜…1ï¼‰ã€‚<br>
                        â€» ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ³ãƒˆã¯å£²å´ä¾¡æ ¼ãŒ3å€ã«ãªã‚Šã¾ã™ã€‚
                    </small>
                    <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰€æŒå“ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="inventoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
                <div class="modal-header border-bottom-0 pb-0">
                    <h5 class="modal-title" id="inventoryModalLabel">ğŸ’ ã‚ãªãŸã®æ‰€æŒãƒãƒƒã‚¸</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-2 bg-light">
                    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UI -->
                    <div class="row g-2 mb-3">
                        <div class="col-12 col-md-5">
                            <input type="text" id="inventory-search" class="form-control form-control-sm"
                                placeholder="ãƒãƒƒã‚¸åã§æ¤œç´¢..." oninput="filterAndRenderInventoryBadges()">
                        </div>
                        <div class="col-6 col-md-4">
                            <select id="inventory-sort" class="form-select form-select-sm"
                                onchange="filterAndRenderInventoryBadges()">
                                <option value="acquired_desc">å…¥æ‰‹é †ï¼ˆæ–°â†’å¤ï¼‰</option>
                                <option value="acquired_asc">å…¥æ‰‹é †ï¼ˆå¤â†’æ–°ï¼‰</option>
                                <option value="rarity_desc">ãƒ¬ã‚¢ãƒªãƒ†ã‚£ï¼ˆé«˜â†’ä½ï¼‰</option>
                                <option value="rarity_asc">ãƒ¬ã‚¢ãƒªãƒ†ã‚£ï¼ˆä½â†’é«˜ï¼‰</option>
                                <option value="name_asc">åå‰ï¼ˆAâ†’Zï¼‰</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-3">
                            <select id="inventory-filter" class="form-select form-select-sm"
                                onchange="filterAndRenderInventoryBadges()">
                                <option value="all">ã™ã¹ã¦</option>
                                <option value="fixed">å›ºå®šå‹</option>
                                <option value="variable">å¤‰å‹•å‹</option>
                                <option value="shrine">ãŠè³½éŠ­é™å®š</option>
                                <option value="mutant">âœ¨ ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ³ãƒˆ</option>
                            </select>
                        </div>
                    </div>

                    <div id="inventory-list" class="vstack gap-2">
                        <!-- JSã§æç”» -->
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    </div>

                    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <nav aria-label="Page navigation" class="mt-3" id="inventory-pagination-area"
                        style="display: none;">
                        <ul class="pagination pagination-sm justify-content-center mb-0" id="inventory-pagination"></ul>
                    </nav>
                </div>
                <div class="modal-footer border-0 bg-light" style="border-radius: 0 0 20px 20px;">
                    <div class="small text-muted w-100">
                        â€» ã“ã“ã‹ã‚‰ç›´æ¥å£²å´ã—ã¦ã€è³‡é‡‘ã«å……ã¦ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚·ãƒ§ãƒƒãƒ—ç”¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå£²å´ç¢ºèªãªã©ï¼‰ -->
    <div class="modal fade" id="shopActionModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0" style="border-radius: 20px;">
                <div class="modal-body p-4 text-center">
                    <div id="shopActionContent"></div>
                    <div class="mt-4 d-flex justify-content-center gap-2">
                        <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button type="button" id="btnShopActionExec" class="btn btn-danger rounded-pill px-4">å®Ÿè¡Œ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/badge-utils.js"></script>
    <script src="../js/badge-sell-ui.js"></script>
    <script src="../js/effects/mutant-badge.js"></script>
    <script src="../js/auth-guard.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        let currentUser = null;
        let currentUserId = null;
        let isDrawing = false;
        let provisionData = null;
        let currentDrawCount = 1;
        let rarityValueMap = {};
        let lastDrawnBadgeUuid = null;
        let lastDrawnBadgeMeta = null;
        let lastDrawnBadgeResult = null;
        let lastTenResults = [];
        let isSelling = false;
        let currentGachaType = 'å¦–æ€ª';
        let currentPaymentType = 'gacha_ticket';
        let gachaCoinPrice = null;
        let gachaConfigMap = new Map();
        let cachedThresholds = [];
        let gachaLoading = false;

        document.addEventListener('DOMContentLoaded', async function () {
            initAccordionNav('../');

            const user = await getCurrentUser();
            if (!user) {
                showNotice('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚', 'warning');
                window.location.href = '../index.html';
                return;
            }
            currentUser = user;
            currentUserId = user.user_metadata.provider_id;

            cachedThresholds = await safeFetchThresholds();
            await fetchGachaConfigs();
            await fetchBalances();
            await refreshGachaContext();
        });

        function showNotice(message, type = 'info') {
            const modal = document.getElementById('notice-modal');
            const dialog = document.getElementById('notice-dialog');
            const title = document.getElementById('notice-title');
            const body = document.getElementById('notice-message');
            if (!modal || !dialog || !title || !body) return;
            dialog.classList.remove('success', 'warning', 'error', 'info');
            dialog.classList.add(type);
            title.textContent = type === 'success' ? 'å®Œäº†' : type === 'warning' ? 'æ³¨æ„' : type === 'error' ? 'ã‚¨ãƒ©ãƒ¼' : 'ãŠçŸ¥ã‚‰ã›';
            body.textContent = message;
            modal.classList.add('active');
        }

        function closeNotice() {
            const modal = document.getElementById('notice-modal');
            if (modal) modal.classList.remove('active');
        }

        function openGachaConfirm(message) {
            return new Promise(resolve => {
                const modalEl = document.getElementById('shopActionModal');
                const content = document.getElementById('shopActionContent');
                const btnExec = document.getElementById('btnShopActionExec');
                if (!modalEl || !content || !btnExec) {
                    resolve(false);
                    return;
                }
                let settled = false;
                content.innerHTML = `
                    <div class="fw-bold mb-2">å¥‰ç´ã®ç¢ºèª</div>
                    <div class="text-muted">${message}</div>
                `;
                btnExec.textContent = 'å¥‰ç´ã™ã‚‹';
                btnExec.className = 'btn btn-warning rounded-pill px-4';
                btnExec.onclick = () => {
                    if (settled) return;
                    settled = true;
                    bootstrap.Modal.getInstance(modalEl)?.hide();
                    resolve(true);
                };
                modalEl.addEventListener('hidden.bs.modal', () => {
                    if (settled) return;
                    settled = true;
                    resolve(false);
                }, { once: true });
                new bootstrap.Modal(modalEl).show();
            });
        }

        function openSellConfirm(message) {
            return new Promise(resolve => {
                const modalEl = document.getElementById('shopActionModal');
                const content = document.getElementById('shopActionContent');
                const btnExec = document.getElementById('btnShopActionExec');
                if (!modalEl || !content || !btnExec) {
                    resolve(false);
                    return;
                }
                let settled = false;
                content.innerHTML = `
                    <div class="fw-bold mb-2">å£²å´ã®ç¢ºèª</div>
                    <div class="text-muted">${message}</div>
                `;
                btnExec.textContent = 'å£²å´ã™ã‚‹';
                btnExec.className = 'btn btn-danger rounded-pill px-4';
                btnExec.onclick = () => {
                    if (settled) return;
                    settled = true;
                    bootstrap.Modal.getInstance(modalEl)?.hide();
                    resolve(true);
                };
                modalEl.addEventListener('hidden.bs.modal', () => {
                    if (settled) return;
                    settled = true;
                    resolve(false);
                }, { once: true });
                new bootstrap.Modal(modalEl).show();
            });
        }

        async function fetchBalances() {
            const { data, error } = await supabaseClient
                .from('profiles')
                .select('coins, gacha_tickets, mangan_tickets')
                .eq('discord_user_id', currentUserId)
                .maybeSingle();

            if (error) {
                console.error('æ®‹é«˜å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return;
            }

            const coinCount = data?.coins || 0;
            const gachaTickets = data?.gacha_tickets || 0;
            const manganTickets = data?.mangan_tickets || 0;

            const coinEl = document.getElementById('coin-count');
            const gachaEl = document.getElementById('ticket-gacha-count');
            const manganEl = document.getElementById('ticket-mangan-count');

            if (coinEl) coinEl.textContent = `${coinCount.toLocaleString()} C`;
            if (gachaEl) gachaEl.textContent = `${gachaTickets.toLocaleString()} æš`;
            if (manganEl) manganEl.textContent = `${manganTickets.toLocaleString()} æš`;
        }

        async function safeFetchThresholds() {
            try {
                const thresholds = await fetchRarityThresholds();
                const map = {};
                thresholds.forEach(t => { map[t.rarity_name] = Number(t.threshold_value || 0); });
                rarityValueMap = map;
                return thresholds;
            } catch (err) {
                console.error('ãƒ¬ã‚¢ãƒªãƒ†ã‚£å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                return [];
            }
        }

        async function fetchGachaConfigs() {
            try {
                const { data, error } = await supabaseClient
                    .from('gacha_configs')
                    .select('gacha_type, allowed_payment_types, coin_price');
                if (error) throw error;
                gachaConfigMap = new Map((data || []).map(row => [row.gacha_type, row]));
            } catch (err) {
                console.error('ã‚¬ãƒãƒ£è¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                gachaConfigMap = new Map();
            }
        }

        function applyGachaTypeUI() {
            const availableTypes = Array.from(gachaConfigMap.keys());
            document.querySelectorAll('.gacha-tab-btn').forEach(btn => {
                const type = btn.dataset.type;
                const enabled = availableTypes.length === 0 || availableTypes.includes(type);
                btn.style.display = enabled ? '' : 'none';
                btn.classList.toggle('active', enabled && type === currentGachaType);
            });

            if (availableTypes.length > 0 && !availableTypes.includes(currentGachaType)) {
                currentGachaType = availableTypes[0];
            }

            const noteEl = document.getElementById('gacha-type-note');
            if (noteEl) {
                if (currentGachaType === 'å¦–æ€ª') {
                    noteEl.textContent = 'å¦–æ€ªã‚¬ãƒãƒ£ã¯ãƒã‚±ãƒƒãƒˆå°‚ç”¨ï¼ˆç¥ˆé¡˜ç¬¦ / æº€é¡˜ç¬¦ï¼‰ã§ã™';
                } else {
                    noteEl.textContent = 'ã˜ã‚ƒã‚Œæœ¬ã‚¬ãƒãƒ£ã¯ã‚³ã‚¤ãƒ³å°‚ç”¨ã§ã™';
                }
            }

            const jarebonLinks = document.getElementById('jarebon-links');
            if (jarebonLinks) {
                jarebonLinks.style.display = currentGachaType === 'ã˜ã‚ƒã‚Œæœ¬' ? '' : 'none';
            }

            const cfg = gachaConfigMap.get(currentGachaType);
            const allowed = cfg?.allowed_payment_types || [];
            const options = document.querySelectorAll('.draw-option-btn');
            options.forEach(btn => {
                const payment = btn.dataset.payment;
                const count = Number(btn.dataset.count || 1);
                const allowedPayment = allowed.includes(payment);
                const allowedCount = !(payment === 'mangan_ticket' && count === 10);
                btn.style.display = allowedPayment && allowedCount ? '' : 'none';
            });

            if (!allowed.includes(currentPaymentType)) {
                currentPaymentType = allowed[0] || 'coin';
            }
            if (currentPaymentType === 'mangan_ticket' && currentDrawCount === 10) {
                currentDrawCount = 1;
            }
            syncDrawOptionButtons();
        }

        async function refreshGachaContext() {
            if (gachaLoading) return;
            gachaLoading = true;
            setGachaLoadingState(true);
            applyGachaTypeUI();
            updateGachaPriceUI();
            await fetchGachaCoinPrice();
            await updateGachaHero();
            if (document.getElementById('badge-pool-area').style.display === 'block') {
                await fetchBadgePool();
            }
            setGachaLoadingState(false);
            gachaLoading = false;
        }

        function syncDrawOptionButtons() {
            document.querySelectorAll('.draw-option-btn').forEach(btn => {
                const payment = btn.dataset.payment;
                const count = Number(btn.dataset.count || 1);
                btn.classList.toggle('active', payment === currentPaymentType && count === currentDrawCount);
            });
        }

        function setGachaType(type) {
            if (!type) return;
            if (gachaLoading) return;
            currentGachaType = type;
            refreshGachaContext();
        }

        function setDrawOption(paymentType, count) {
            const cfg = gachaConfigMap.get(currentGachaType);
            const allowed = cfg?.allowed_payment_types || [];
            if (!allowed.includes(paymentType)) return;
            if (paymentType === 'mangan_ticket' && count === 10) return;
            currentPaymentType = paymentType;
            currentDrawCount = count;
            syncDrawOptionButtons();
            updateGachaPriceUI();
            const area = document.getElementById('badge-pool-area');
            if (area && area.style.display === 'block') {
                fetchBadgePool();
            }
        }

        function setGachaLoadingState(loading) {
            const drawOptions = document.getElementById('draw-options');
            const hero = document.getElementById('osaisen-box');
            if (drawOptions) drawOptions.style.display = loading ? 'none' : 'flex';
            if (hero) hero.style.opacity = loading ? '0' : '1';
            document.body.classList.toggle('gacha-loading', loading);
        }

        function updateGachaPriceUI() {
            const note = document.getElementById('gacha-price-note');
            const coinBtn1 = document.getElementById('coin-btn-1');
            const coinBtn10 = document.getElementById('coin-btn-10');

            if (currentGachaType === 'å¦–æ€ª') {
                if (note) {
                    if (currentPaymentType === 'mangan_ticket') {
                        note.textContent = 'ãƒãƒƒã‚¸ç¢ºå®šï¼æº€é¡˜ç¬¦1æšã§å¥‰ç´ã§ãã¾ã™';
                        note.classList.add('emphasis');
                    } else {
                        note.textContent = currentDrawCount === 10 ? 'ç¥ˆé¡˜ç¬¦10æšã§å¥‰ç´ã§ãã¾ã™' : 'ç¥ˆé¡˜ç¬¦1æšã§å¥‰ç´ã§ãã¾ã™';
                        note.classList.remove('emphasis');
                    }
                }
            } else {
                if (note) note.classList.remove('emphasis');
                if (!gachaCoinPrice || gachaCoinPrice < 1) {
                    if (note) note.textContent = 'ã‚³ã‚¤ãƒ³ä¾¡æ ¼ãŒæœªè¨­å®šã§ã™';
                    return;
                }
                const price1 = gachaCoinPrice;
                const price10 = gachaCoinPrice * 10;
                if (coinBtn1) coinBtn1.textContent = `ğŸª™ ã‚³ã‚¤ãƒ³ ${price1.toLocaleString()}æš 1å›ç¥ˆã‚‹`;
                if (coinBtn10) coinBtn10.textContent = `ğŸª™ ã‚³ã‚¤ãƒ³ ${price10.toLocaleString()}æš 10å›ç¥ˆã‚‹`;
                if (note) note.textContent = `ã‚³ã‚¤ãƒ³${(currentDrawCount === 10 ? price10 : price1).toLocaleString()}æšã§å¥‰ç´ã§ãã¾ã™ã€‚`;
            }
        }

        async function fetchGachaCoinPrice() {
            if (!gachaConfigMap.get(currentGachaType)?.allowed_payment_types?.includes('coin')) return;
            try {
                const { data, error } = await supabaseClient
                    .from('gacha_configs')
                    .select('coin_price')
                    .eq('gacha_type', currentGachaType)
                    .maybeSingle();
                if (error) throw error;
                gachaCoinPrice = data?.coin_price ?? null;
                updateGachaPriceUI();
            } catch (err) {
                console.error('ã‚¬ãƒãƒ£ä¾¡æ ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                updateGachaPriceUI();
            }
        }

        async function fetchRarityThresholds() {
            const { data, error } = await supabaseClient
                .from('rarity_thresholds')
                .select('rarity_name, threshold_value')
                .order('threshold_value', { ascending: true });
            if (error) throw error;
            return data || [];
        }

        function toggleBadgePool() {
            const area = document.getElementById('badge-pool-area');
            if (area.style.display === 'none') {
                area.style.display = 'block';
                fetchBadgePool();
            } else {
                area.style.display = 'none';
            }
        }

        async function fetchBadgePool() {
            try {
                const [badgesRes, thresholdsRes, circulationRes] = await Promise.all([
                    supabaseClient
                        .from('badges')
                        .select('id, name, image_url, price, fixed_rarity_name, sales_type, is_gacha_eligible, remaining_count, gacha_weight, sort_order')
                        .eq('is_gacha_eligible', currentGachaType),
                    fetchRarityThresholds(),
                    supabaseClient.from('user_badges_new').select('badge_id')
                ]);

                if (badgesRes.error) throw badgesRes.error;

                let badges = badgesRes.data || [];
                const thresholds = thresholdsRes || [];
                if (currentPaymentType === 'mangan_ticket') {
                    badges = badges.filter(b => b.sales_type !== 'æ›é‡‘å“');
                }

                if (thresholds.length === 0) {
                    document.getElementById('badge-pool-list').innerHTML = '<p class="text-danger">ãƒ¬ã‚¢ãƒªãƒ†ã‚£æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“</p>';
                    return;
                }

                const circulation = {};
                (circulationRes.data || []).forEach(r => {
                    circulation[r.badge_id] = (circulation[r.badge_id] || 0) + 1;
                });

                function getDynamicRarity(badge) {
                    const n = circulation[badge.id] || 0;
                    if (typeof BadgeUtils !== 'undefined' && BadgeUtils.calculateBadgeValues) {
                        const result = BadgeUtils.calculateBadgeValues(badge, n, thresholds);
                        return result.rarityName;
                    }
                    return badge.fixed_rarity_name || thresholds[0]?.rarity_name || 'ä¸æ˜';
                }

                const grouped = {};
                let totalWeight = 0;
                const rarityStarMap = {};
                thresholds
                    .sort((a, b) => a.threshold_value - b.threshold_value)
                    .forEach((t, idx) => {
                        rarityStarMap[t.rarity_name] = idx + 1;
                    });

                const getRarityGroupLabel = (star) => {
                    if (!star || star <= 0) return 'ä¸æ˜';
                    if (star <= 5) return 'â˜…1ã€œâ˜…5 ä¸¦å“';
                    if (star <= 10) return 'â˜…6ã€œâ˜…10 åå“';
                    if (star <= 15) return 'â˜…11ã€œâ˜…15 é€¸å“';
                    if (star <= 20) return 'â˜…16ã€œâ˜…20 çµ¶å“';
                    if (star <= 25) return 'â˜…21ã€œâ˜…25 è‡³é«˜';
                    if (star <= 30) return 'â˜…26ã€œâ˜…30 å›½å®';
                    if (star <= 35) return 'â˜…31ã€œâ˜…35 ç§˜å®';
                    if (star <= 40) return 'â˜…36ã€œâ˜…40 ç¥ç§˜';
                    if (star <= 45) return 'â˜…41ã€œâ˜…45 è‹±é›„';
                    return 'â˜…46 ä¼èª¬';
                };

                badges.forEach(b => {
                    const weight = Number(b.gacha_weight ?? 1);
                    totalWeight += weight > 0 ? weight : 0;
                    const rarity = b.sales_type === 'æ›é‡‘å“' ? 'æ›é‡‘å“' : getDynamicRarity(b);
                    const star = rarityStarMap[rarity];
                    const groupKey = rarity === 'æ›é‡‘å“' ? 'æ›é‡‘å“' : getRarityGroupLabel(star);
                    if (!grouped[groupKey]) grouped[groupKey] = [];
                    grouped[groupKey].push({ ...b, _rarity: rarity, _star: star });
                });

                const rarityOrder = [
                    'â˜…46 ä¼èª¬',
                    'â˜…41ã€œâ˜…45 è‹±é›„',
                    'â˜…36ã€œâ˜…40 ç¥ç§˜',
                    'â˜…31ã€œâ˜…35 ç§˜å®',
                    'â˜…26ã€œâ˜…30 å›½å®',
                    'â˜…21ã€œâ˜…25 è‡³é«˜',
                    'â˜…16ã€œâ˜…20 çµ¶å“',
                    'â˜…11ã€œâ˜…15 é€¸å“',
                    'â˜…6ã€œâ˜…10 åå“',
                    'â˜…1ã€œâ˜…5 ä¸¦å“'
                ];
                if (grouped['æ›é‡‘å“']) rarityOrder.unshift('æ›é‡‘å“');

                const listEl = document.getElementById('badge-pool-list');
                let html = '';

                for (const rarity of rarityOrder) {
                    if (!grouped[rarity] || grouped[rarity].length === 0) continue;
                    const badgesInRarity = grouped[rarity];
                    badgesInRarity.sort((a, b) => {
                        const pA = Number(a.price || 0);
                        const pB = Number(b.price || 0);
                        if (pA !== pB) return pA - pB;
                        const sA = Number(a.sort_order);
                        const sB = Number(b.sort_order);
                        const aHas = Number.isFinite(sA);
                        const bHas = Number.isFinite(sB);
                        if (aHas && bHas && sA !== sB) return sA - sB;
                        if (aHas !== bHas) return aHas ? -1 : 1;
                        return (a.name || '').localeCompare(b.name || '');
                    });
                    const rarityWeight = badgesInRarity.reduce((sum, b) => {
                        const w = Number(b.gacha_weight ?? 1);
                        return sum + (w > 0 ? w : 0);
                    }, 0);
                    const rarityPercent = totalWeight > 0 ? (rarityWeight / totalWeight) * 100 : 0;
                    const representative = badgesInRarity[0];
                    const rarityClass = getRarityClass(representative?._rarity || rarity);
                    const rarityLabel = rarity;

                    html += `
                        <div class="mb-3">
                            <div class="text-start mb-2">
                                <span class="badge ${rarityClass} text-white">${rarityLabel}</span>
                                <span class="small text-white-50">(${badgesInRarity.length}ç¨® / åˆè¨ˆ ${rarityPercent.toFixed(2)}%)</span>
                            </div>
                            <div class="badge-pool-grid">
                                ${badgesInRarity.map(b => `
                                    ${(() => {
                                        const w = Number(b.gacha_weight ?? 1);
                                        const pct = totalWeight > 0 && w > 0 ? (w / totalWeight) * 100 : 0;
                                        return `
                                    <div class="badge-pool-item" onclick="window.location.href='../badge/index.html?id=${b.id}'">
                                        <img src="${b.image_url}">
                                        <div class="small text-truncate" style="font-size: 0.7rem; color: #ffc107;">${pct.toFixed(2)}%</div>
                                        <div class="small text-white-50 text-truncate" style="font-size: 0.65rem;">${b.name}</div>
                                    </div>
                                        `;
                                    })()}
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                if (!html) html = '<p class="text-white-50">æ’å‡ºå¯¾è±¡ã®ãƒãƒƒã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                listEl.innerHTML = html;
            } catch (err) {
                console.error('æ’å‡ºãƒãƒƒã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                document.getElementById('badge-pool-list').innerHTML = '<p class="text-danger">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
            }
        }

        function updateGachaHero() {
            const img = document.getElementById('gacha-hero-image');
            const emoji = document.getElementById('gacha-hero-emoji');
            if (!img || !emoji) return;

            if (currentGachaType === 'å¦–æ€ª') {
                return swapHeroImage('../images/å¦–æ€ªã‚·ãƒªãƒ¼ã‚ºãƒãƒŠãƒ¼.png');
            } else {
                return swapHeroImage('../images/ã˜ã‚ƒã‚Œæœ¬ã‚·ãƒªãƒ¼ã‚ºãƒãƒŠãƒ¼.png');
            }
        }

        function swapHeroImage(src) {
            const img = document.getElementById('gacha-hero-image');
            const emoji = document.getElementById('gacha-hero-emoji');
            if (!img) return Promise.resolve();
            return new Promise(resolve => {
                const loader = new Image();
                loader.onload = () => {
                    img.style.display = 'block';
                    img.src = src;
                    if (emoji) emoji.style.display = 'none';
                    resolve();
                };
                loader.onerror = () => resolve();
                loader.src = src;
            });
        }

        async function handleDraw() {
            if (isDrawing) return;

            const count = currentDrawCount || 1;
            let paymentType = currentPaymentType;
            if (currentGachaType === 'ã˜ã‚ƒã‚Œæœ¬') {
                paymentType = 'coin';
            }

            if (currentGachaType === 'å¦–æ€ª' && paymentType === 'coin') {
                showNotice('å¦–æ€ªã‚¬ãƒãƒ£ã¯ãƒã‚±ãƒƒãƒˆå°‚ç”¨ã§ã™', 'warning');
                return;
            }

            if (currentGachaType === 'ã˜ã‚ƒã‚Œæœ¬' && (!gachaCoinPrice || gachaCoinPrice < 1)) {
                showNotice('ã‚³ã‚¤ãƒ³ä¾¡æ ¼ãŒæœªè¨­å®šã§ã™', 'warning');
                return;
            }

            const confirmLabel = (() => {
                if (paymentType === 'coin') {
                    const price = gachaCoinPrice ? gachaCoinPrice * count : 0;
                    return `ã‚³ã‚¤ãƒ³${price.toLocaleString()}æšã‚’æ¶ˆè²»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
                }
                if (paymentType === 'mangan_ticket') {
                    return `æº€é¡˜ç¬¦${count}æšã‚’æ¶ˆè²»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
                }
                return `ç¥ˆé¡˜ç¬¦${count}æšã‚’æ¶ˆè²»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
            })();

            const confirmed = await openGachaConfirm(confirmLabel);
            if (!confirmed) return;

            isDrawing = true;

            const btn = document.getElementById('draw-btn');
            const box = document.getElementById('osaisen-box');
            const coin = document.getElementById('coin');

            btn.disabled = true;

            try {
                coin.classList.add('active');
                setTimeout(() => { box.classList.add('shaking'); }, 400);

                const { data, error } = await supabaseClient.rpc('draw_gacha_v2', {
                    p_user_id: currentUserId,
                    p_gacha_type: currentGachaType,
                    p_payment_type: paymentType,
                    p_count: count
                });

                await new Promise(resolve => setTimeout(resolve, 1500));

                if (error) throw error;
                if (!data || !data.ok) throw new Error(data?.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');

                const results = data.results || [];

                if (count === 10) {
                    showTenResults(results);
                } else {
                    showResult(results[0]);
                }

                if (typeof logActivity === 'function') {
                    const coinCost = paymentType === 'coin' ? (data.coin_cost || 0) : 0;
                    const resultUuids = results.map(r => r?.uuid).filter(Boolean);
                    const resultBadgeIds = results.map(r => r?.badge_id).filter(Boolean);
                    await logActivity(currentUserId, 'gacha_draw', {
                        amount: coinCost,
                        badgeId: results?.length === 1 ? (results[0]?.badge_id || null) : null,
                        details: {
                            gacha_type: currentGachaType,
                            payment_type: paymentType,
                            count,
                            source: 'osaisen',
                            coin_cost: coinCost,
                            result_uuids: resultUuids,
                            result_badge_ids: resultBadgeIds
                        }
                    });
                }

            } catch (err) {
                console.error('ã‚¬ãƒãƒ£ã‚¨ãƒ©ãƒ¼:', err);
                showNotice('å¥‰ç´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
            } finally {
                isDrawing = false;
                coin.classList.remove('active');
                box.classList.remove('shaking');
                btn.disabled = false;
                await fetchBalances();
            }
        }

        function showTenResults(results) {
            const list = document.getElementById('result-ten-list');
            if (!list) return;
            list.innerHTML = '';
            const modal = new bootstrap.Modal(document.getElementById('resultModalTen'));
            modal.show();
            lastTenResults = results || [];

            const totalValue = results.reduce((sum, r) => {
                const base = rarityValueMap[r.rarity] || 0;
                const multiplier = r.is_mutant ? 3 : 1;
                return sum + (base * multiplier);
            }, 0);
            const totalEl = document.getElementById('result-ten-total');
            if (totalEl) totalEl.textContent = '';
            const sellBtn = document.getElementById('result-ten-sell-btn');
            if (sellBtn) sellBtn.style.display = 'none';

            results.forEach((r, idx) => {
                const card = document.createElement('div');
                card.className = 'text-center ten-result-item';
                card.style.opacity = '0';
                card.style.transform = 'translateY(8px)';
                list.appendChild(card);
                const rarityText = r?.rarity || 'ãƒ¬ã‚¢ãƒªãƒ†ã‚£ä¸æ˜';
                const rarityClass = getRarityClass(rarityText);
                setTimeout(() => {
                    card.style.transition = 'all 0.3s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                    card.innerHTML = `
                        <div class="fw-bold ${rarityClass} text-dark mb-2">${rarityText}</div>
                        <div class="mutant-badge-container mini ${r?.is_mutant ? 'active' : ''}" style="width: 96px; height: 96px; margin: 0 auto;">
                            <img src="${r?.image_url || '../images/placeholder-badge.png'}" alt="${r?.name || ''}" style="width: 100%; height: 100%; object-fit: contain;">
                            ${window.MutantBadge ? window.MutantBadge.renderShine(!!r?.is_mutant) : '<div class="mutant-badge-shine"></div>'}
                        </div>
                    `;
                    card.dataset.uuid = r?.uuid || '';
                    card.addEventListener('click', () => {
                        card.classList.toggle('selected');
                        updateTenSellButtonState();
                    });
                    if (idx === results.length - 1 && totalEl) {
                        totalEl.textContent = `åˆè¨ˆä¾¡å€¤: ğŸª™ ${totalValue.toLocaleString()}`;
                    }
                }, (idx + 1) * 1000);
            });
        }

        function showResult(result) {
            if (!result) return;
            const rarityEl = document.getElementById('result-rarity-badge');
            const headerEl = document.getElementById('result-header');
            const rarity = result.rarity || 'ãƒ¬ã‚¢ãƒªãƒ†ã‚£ä¸æ˜';
            rarityEl.textContent = rarity;
            rarityEl.className = 'result-rarity ' + getRarityClass(rarity);
            const isMutant = !!result.is_mutant;
            const resultBody = document.querySelector('#resultModal .result-body');
            if (resultBody) {
                resultBody.innerHTML = `
                    <div class="mutant-badge-container large ${isMutant ? 'active' : ''}" style="width: 140px; height: 140px; margin: 0 auto;">
                        <img src="${result.image_url || '../images/placeholder-badge.png'}" alt="${result.name || ''}" style="width: 100%; height: 100%; object-fit: contain;">
                        ${window.MutantBadge ? window.MutantBadge.renderShine(isMutant) : '<div class="mutant-badge-shine"></div>'}
                    </div>
                    <h3 id="result-name" class="fw-bold mb-3">${result.name || ''}</h3>
                    <p id="result-msg" class="text-muted mb-4"></p>
                `;
            }
            const msgEl = document.getElementById('result-msg');
            lastDrawnBadgeUuid = result.uuid || null;
            lastDrawnBadgeMeta = {
                uuid: result.uuid || null,
                badgeId: result.badge_id || null,
                name: result.name || null
            };
            lastDrawnBadgeResult = result;
            const sellBtn = document.getElementById('result-sell-btn');
            if (sellBtn) sellBtn.style.display = lastDrawnBadgeUuid ? 'inline-block' : 'none';

            headerEl.innerHTML = '<span class="fs-4 fw-bold">âœ¨ æ–°ã—ã„ç¸ã‚’æˆã‹ã‚Šã¾ã—ãŸ</span>';
            const value = rarityValueMap[rarity] || 0;
            const mutantLabel = result.is_mutant ? ' <span class="mutant-label">ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ³ãƒˆ</span>' : '';
            msgEl.innerHTML = `æ–°ã—ã„ãƒãƒƒã‚¸ã‚’ç²å¾—ã—ã¾ã—ãŸï¼${mutantLabel}<br>ä¾¡å€¤: ğŸª™ ${value.toLocaleString()}`;

            const modal = new bootstrap.Modal(document.getElementById('resultModal'));
            modal.show();
        }

        function updateTenSellButtonState() {
            const sellBtn = document.getElementById('result-ten-sell-btn');
            if (!sellBtn) return;
            const selected = Array.from(document.querySelectorAll('.ten-result-item.selected'));
            sellBtn.style.display = selected.length > 0 ? 'inline-block' : 'none';
        }

        async function sellBadgeByUuid(badgeUuid) {
            const { data, error } = await supabaseClient.rpc('sell_badge_v2', {
                p_user_id: currentUserId,
                p_badge_uuid: badgeUuid
            });
            if (error || (data && data.error)) {
                throw new Error(error?.message || data?.error || 'å£²å´ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            return data;
        }

        async function buildSellItemFromResult(result) {
            if (!result?.badge_id) return null;
            const thresholds = cachedThresholds?.length ? cachedThresholds : await safeFetchThresholds();
            const [badgeRes, countRes, ownRes] = await Promise.all([
                supabaseClient
                    .from('badges')
                    .select('id, name, image_url, price, fixed_rarity_name, sales_type, is_gacha_eligible, sort_order')
                    .eq('id', result.badge_id)
                    .maybeSingle(),
                supabaseClient
                    .from('user_badges_new')
                    .select('badge_id', { count: 'exact', head: true })
                    .eq('badge_id', result.badge_id),
                supabaseClient
                    .from('user_badges_new')
                    .select('purchased_price, is_mutant')
                    .eq('uuid', result.uuid)
                    .maybeSingle()
            ]);
            if (badgeRes.error) throw badgeRes.error;
            const badge = badgeRes.data;
            if (!badge) return null;
            const circulationCount = countRes.count || 0;
            const valResult = BadgeUtils.calculateBadgeValues(badge, circulationCount, thresholds || []);
            const isMutant = ownRes?.data?.is_mutant ?? result?.is_mutant ?? false;
            const sellPrice = valResult.sellPrice * (isMutant ? 3 : 1);
            const sellStar = Math.max((valResult.starLevel || 1) - 2, 1);
            const sellRarity = thresholds?.[sellStar - 1]?.rarity_name || valResult.rarityName || '';
            const isConvertible = badge.sales_type === 'æ›é‡‘å“';
            const marketValue = isConvertible ? badge.price : valResult.marketValue;
            const sellValue = isConvertible ? badge.price * (isMutant ? 3 : 1) : sellPrice;
            const displayRarity = isConvertible ? '' : valResult.rarityName;
            const displaySellRarity = isConvertible ? '' : sellRarity;

            return {
                uuid: result.uuid,
                badge_id: badge.id,
                badge_name: badge.name,
                badge_image_url: badge.image_url,
                rarity: badge.rarity,
                rarity_name: displayRarity,
                sell_rarity_name: displaySellRarity,
                price: badge.price,
                fixed_rarity_name: badge.fixed_rarity_name,
                sales_type: badge.sales_type,
                is_gacha_eligible: badge.is_gacha_eligible,
                market_value: marketValue,
                sell_price: sellValue,
                purchased_price: ownRes?.data?.purchased_price ?? 0,
                creator_name: '',
                creator_avatar: '',
                market_count: circulationCount,
                is_mutant: isMutant
            };
        }

        async function confirmSellSingle() {
            if (isSelling) return;
            if (!lastDrawnBadgeUuid || !lastDrawnBadgeResult) return;
            try {
                const item = await buildSellItemFromResult(lastDrawnBadgeResult);
                if (!item) {
                    showNotice('å£²å´æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
                    return;
                }
                currentShopActionUUID = lastDrawnBadgeUuid;
                currentShopActionBadgeId = item.badge_id || null;
                currentShopActionBadgeName = item.badge_name || '';
                BadgeSellUI.renderSellConfirmModal(item, () => executeSellSingleFromGacha(), {
                    confirmLabel: 'å£²å´ã™ã‚‹',
                    confirmClass: 'btn-warning'
                });
            } catch (err) {
                showNotice('å£²å´æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
            }
        }

        async function executeSellSingleFromGacha() {
            if (isSelling) return;
            if (!lastDrawnBadgeUuid) return;
            try {
                isSelling = true;
                const shopModalEl = document.getElementById('shopActionModal');
                if (shopModalEl) {
                    bootstrap.Modal.getInstance(shopModalEl)?.hide();
                }
                const sellBtn = document.getElementById('result-sell-btn');
                if (sellBtn) sellBtn.disabled = true;
                const data = await sellBadgeByUuid(lastDrawnBadgeUuid);
                await logActivity(currentUserId, 'badge_sell', {
                    amount: data.sell_price,
                    badgeId: currentShopActionBadgeId || lastDrawnBadgeMeta?.badgeId || null,
                    details: { badge_name: currentShopActionBadgeName || lastDrawnBadgeMeta?.name || null, source: 'osaisen' }
                });
                showSellResult(`å£²å´ã—ã¾ã—ãŸï¼ (ğŸª™ +${data.sell_price.toLocaleString()})`);
                lastDrawnBadgeUuid = null;
                lastDrawnBadgeMeta = null;
                lastDrawnBadgeResult = null;
                if (sellBtn) sellBtn.style.display = 'none';
                bootstrap.Modal.getOrCreateInstance(document.getElementById('resultModal')).hide();
            } catch (err) {
                showSellResult('å£²å´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            } finally {
                isSelling = false;
                const sellBtn = document.getElementById('result-sell-btn');
                if (sellBtn) sellBtn.disabled = false;
            }
        }

        async function handleSellTenSelected() {
            if (isSelling) return;
            const selected = Array.from(document.querySelectorAll('.ten-result-item.selected'))
                .map(el => el.dataset.uuid)
                .filter(Boolean);
            if (selected.length === 0) return;
            const confirmed = await openSellConfirm(`é¸æŠã—ãŸ ${selected.length} å€‹ã‚’å£²å´ã—ã¾ã™ã‹ï¼Ÿ`);
            if (!confirmed) return;
            try {
                isSelling = true;
                const sellTenBtn = document.getElementById('result-ten-sell-btn');
                if (sellTenBtn) sellTenBtn.disabled = true;
                document.querySelectorAll('.ten-result-item').forEach(el => {
                    el.style.pointerEvents = 'none';
                    el.style.opacity = el.classList.contains('selected') ? '1' : '0.6';
                });
                let total = 0;
                for (const uuid of selected) {
                    const data = await sellBadgeByUuid(uuid);
                    total += data.sell_price || 0;
                    const meta = lastTenResults.find(r => r.uuid === uuid);
                    await logActivity(currentUserId, 'badge_sell', {
                        amount: data.sell_price,
                        badgeId: meta?.badge_id || null,
                        details: { badge_name: meta?.name || null, source: 'osaisen' }
                    });
                }
                showSellResult(`å£²å´ã—ã¾ã—ãŸï¼ (ğŸª™ +${total.toLocaleString()})`);
                selected.forEach(uuid => {
                    const el = document.querySelector(`.ten-result-item[data-uuid="${uuid}"]`);
                    if (el) el.classList.remove('selected');
                });
                updateTenSellButtonState();
                bootstrap.Modal.getOrCreateInstance(document.getElementById('resultModalTen')).hide();
            } catch (err) {
                showSellResult('å£²å´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
            } finally {
                isSelling = false;
                const sellTenBtn = document.getElementById('result-ten-sell-btn');
                if (sellTenBtn) sellTenBtn.disabled = false;
                document.querySelectorAll('.ten-result-item').forEach(el => {
                    el.style.pointerEvents = '';
                    el.style.opacity = '';
                });
            }
        }

        function showSellResult(message) {
            const msg = document.getElementById('sell-result-message');
            if (msg) msg.textContent = message;
            bootstrap.Modal.getOrCreateInstance(document.getElementById('sellResultModal')).show();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const sellBtn = document.getElementById('result-sell-btn');
        if (sellBtn) sellBtn.addEventListener('click', confirmSellSingle);
            const sellTenBtn = document.getElementById('result-ten-sell-btn');
            if (sellTenBtn) sellTenBtn.addEventListener('click', handleSellTenSelected);
        });

        // ======= ä¾¡æ ¼è¡¨ãƒ¢ãƒ¼ãƒ€ãƒ« =======
        function openPriceListModal() {
            const thresholds = cachedThresholds || [];
            const tbody = document.getElementById('price-list-tbody');

            if (thresholds.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>';
                new bootstrap.Modal(document.getElementById('priceListModal')).show();
                return;
            }

            const rows = thresholds.map((t, index) => {
                const star = index + 1;
                const sellStar = Math.max(star - 2, 1);
                let sellPrice = thresholds[sellStar - 1]?.threshold_value || 50;
                if (star === 1) sellPrice = 30;
                const rarityName = t.rarity_name;
                const rarityClass = getRarityClass(rarityName);

                return `
                    <tr>
                        <td>
                            <span class="badge rounded-pill ${rarityClass}" style="font-size: 0.9rem; padding: 6px 12px;">
                                ${rarityName}
                            </span>
                        </td>
                        <td class="fw-bold">ğŸª™ ${t.threshold_value.toLocaleString()}</td>
                        <td class="text-muted">ğŸª™ ${sellPrice.toLocaleString()}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = rows.reverse().join('');
            new bootstrap.Modal(document.getElementById('priceListModal')).show();
        }

        // ======= æ‰€æŒå“ãƒ»å£²å´æ©Ÿèƒ½ =======
        let currentShopActionUUID = null;
        let currentShopActionBadgeId = null;
        let currentShopActionBadgeName = null;

        async function openInventoryModal() {
            const modal = new bootstrap.Modal(document.getElementById('inventoryModal'));
            modal.show();
            await loadInventory();
        }

        let allInventoryBadges = [];
        let groupedInventory = [];
        let currentInventoryPage = 1;
        const INVENTORY_ITEMS_PER_PAGE = 10;
        let expandedBadgeId = null;

        async function loadInventory() {
            const listEl = document.getElementById('inventory-list');
            try {
                const { data: myBadges, error } = await supabaseClient
                    .from('user_badges_new')
                    .select('*, badges(*)')
                    .eq('user_id', currentUserId)
                    .order('acquired_at', { ascending: false });

                if (error) throw error;

                const { data: thresholds } = await supabaseClient
                    .from('rarity_thresholds')
                    .select('*')
                    .order('threshold_value', { ascending: true });

                const badgeIds = [...new Set(myBadges.map(ub => ub.badge_id))];
                let marketCounts = {};

                if (badgeIds.length > 0) {
                    const { data: allOwned } = await supabaseClient.from('user_badges_new').select('badge_id');
                    if (allOwned) {
                        allOwned.forEach(o => {
                            marketCounts[o.badge_id] = (marketCounts[o.badge_id] || 0) + 1;
                        });
                    }
                }

                const creatorIds = [...new Set((myBadges || []).map(ub => ub.badges?.discord_user_id).filter(Boolean))];
                const creatorMap = new Map();
                if (creatorIds.length > 0) {
                    const { data: creators } = await supabaseClient
                        .from('profiles')
                        .select('discord_user_id, account_name, avatar_url')
                        .in('discord_user_id', creatorIds);
                    (creators || []).forEach(c => creatorMap.set(c.discord_user_id, {
                        name: c.account_name || c.discord_user_id,
                        avatar: c.avatar_url || ''
                    }));
                }

                allInventoryBadges = myBadges.map(inventoryItem => {
                    const badge = inventoryItem.badges;
                    if (!badge) return null;
                    if (badge.sales_type === 'é™å®šå“') return null;

                    const count = marketCounts[badge.id] || 1;
                    const circulationCount = marketCounts[badge.id] || 0;
                    const valResult = BadgeUtils.calculateBadgeValues(badge, count, thresholds || []);
                    const sellPrice = valResult.sellPrice * (inventoryItem.is_mutant ? 3 : 1);
                    const sellStar = Math.max((valResult.starLevel || 1) - 2, 1);
                    const sellRarity = thresholds?.[sellStar - 1]?.rarity_name || valResult.rarityName || '';
                    const creatorInfo = creatorMap.get(badge.discord_user_id) || { name: 'ä¸æ˜', avatar: '' };
                    const isConvertible = badge.sales_type === 'æ›é‡‘å“';
                    const marketValue = isConvertible ? badge.price : valResult.marketValue;
                    const sellValue = isConvertible ? badge.price * (inventoryItem.is_mutant ? 3 : 1) : sellPrice;
                    const displayRarity = isConvertible ? '' : valResult.rarityName;
                    const displaySellRarity = isConvertible ? '' : sellRarity;

                    return {
                        ...inventoryItem,
                        badge_name: badge.name,
                        badge_image_url: badge.image_url,
                        rarity: badge.rarity,
                        rarity_name: displayRarity,
                        sell_rarity_name: displaySellRarity,
                        price: badge.price,
                        fixed_rarity_name: badge.fixed_rarity_name,
                        sales_type: badge.sales_type,
                        is_gacha_eligible: badge.is_gacha_eligible,
                        market_value: marketValue,
                        sell_price: sellValue,
                        purchased_price: inventoryItem.purchased_price,
                        creator_name: creatorInfo.name,
                        creator_avatar: creatorInfo.avatar,
                        market_count: circulationCount,
                        acquired_at: new Date(inventoryItem.acquired_at)
                    };
                }).filter(i => i !== null);

                filterAndRenderInventoryBadges();

            } catch (err) {
                console.error('Error loading inventory:', err);
                listEl.innerHTML = '<div class="text-center py-4 text-danger">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        function filterAndRenderInventoryBadges() {
            const listEl = document.getElementById('inventory-list');
            const searchVal = document.getElementById('inventory-search').value.toLowerCase();
            const sortVal = document.getElementById('inventory-sort').value;
            const filterVal = document.getElementById('inventory-filter').value;

            let filtered = allInventoryBadges.filter(item => {
                if (searchVal && !item.badge_name.toLowerCase().includes(searchVal)) return false;

                switch (filterVal) {
                    case 'fixed':
                        return item.sales_type === 'å›ºå®šå‹';
                    case 'variable':
                        return item.sales_type === 'å¤‰å‹•å‹';
                    case 'shrine':
                        return !!item.is_gacha_eligible;
                    case 'mutant':
                        return item.is_mutant;
                    case 'all':
                    default:
                        return true;
                }
            });

            filtered.sort((a, b) => {
                if (sortVal === 'acquired_desc') return b.acquired_at - a.acquired_at;
                if (sortVal === 'acquired_asc') return a.acquired_at - b.acquired_at;
                if (sortVal === 'name_asc') return a.badge_name.localeCompare(b.badge_name);
                if (sortVal === 'rarity_desc' || sortVal === 'rarity_asc') {
                    const pA = a.market_value || 0;
                    const pB = b.market_value || 0;
                    return sortVal === 'rarity_desc' ? pB - pA : pA - pB;
                }
                return 0;
            });

            const groups = new Map();
            filtered.forEach(item => {
                if (!groups.has(item.badge_id)) {
                    groups.set(item.badge_id, {
                        badge_id: item.badge_id,
                        badge_name: item.badge_name,
                        badge_image_url: item.badge_image_url,
                        items: []
                    });
                }
                groups.get(item.badge_id).items.push(item);
            });

            const groupArray = Array.from(groups.values());
            const totalPages = Math.ceil(groupArray.length / INVENTORY_ITEMS_PER_PAGE);
            if (currentInventoryPage > totalPages && totalPages > 0) currentInventoryPage = totalPages;
            if (currentInventoryPage < 1) currentInventoryPage = 1;

            const start = (currentInventoryPage - 1) * INVENTORY_ITEMS_PER_PAGE;
            const end = start + INVENTORY_ITEMS_PER_PAGE;
            const pageGroups = groupArray.slice(start, end);

            if (pageGroups.length === 0) {
                listEl.innerHTML = '<div class="text-center py-4 text-muted">è©²å½“ã™ã‚‹ãƒãƒƒã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                document.getElementById('inventory-pagination-area').style.display = 'none';
                return;
            }

            listEl.innerHTML = pageGroups.map(group => {
                const isExpanded = expandedBadgeId === group.badge_id;
                const totalCount = group.items.length;
                const mutantCount = group.items.filter(i => i.is_mutant).length;
                const repItem = group.items[0];

                let actionArea = '';
                let detailHtml = '';

                if (totalCount === 1) {
                    const item = repItem;
                    if (item.sales_type === 'é™å®šå“') {
                        actionArea = '<span class="badge bg-secondary text-nowrap">å£²å´ä¸å¯</span>';
                    } else if (item.sales_type === 'æ›é‡‘å“') {
                        actionArea = `<button class="btn btn-sm btn-outline-success rounded-pill text-nowrap" style="flex-shrink: 0;"
                            onclick="confirmSellFromShop('${item.uuid}')">æ›é‡‘</button>`;
                    } else {
                        actionArea = `<button class="btn btn-sm btn-outline-danger rounded-pill text-nowrap" style="flex-shrink: 0;"
                            onclick="confirmSellFromShop('${item.uuid}')">å£²å´</button>`;
                    }
                } else {
                    if (repItem.sales_type === 'æ›é‡‘å“') {
                        actionArea = `
                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn btn-sm ${isExpanded ? 'btn-secondary' : 'btn-primary'} rounded-pill text-nowrap" style="flex-shrink: 0;"
                                    onclick="toggleInventoryExpand('${group.badge_id}')">${isExpanded ? 'é–‰ã˜ã‚‹' : 'é¸æŠ'}</button>
                                <button class="btn btn-sm btn-outline-success rounded-pill text-nowrap" style="flex-shrink: 0;"
                                    onclick="confirmSellAllConvertibleFromShop('${group.badge_id}')">ä¸€æ‹¬å£²å´</button>
                            </div>
                        `;
                    } else {
                        actionArea = `<button class="btn btn-sm ${isExpanded ? 'btn-secondary' : 'btn-primary'} rounded-pill text-nowrap" style="flex-shrink: 0;"
                            onclick="toggleInventoryExpand('${group.badge_id}')">${isExpanded ? 'é–‰ã˜ã‚‹' : 'é¸æŠ'}</button>`;
                    }

                    if (isExpanded) {
                        const listItemsHtml = group.items.map(item => {
                            if (item.sales_type === 'é™å®šå“') return '';

                            const isMutant = item.is_mutant;
                            let imgHtml = '';
                            if (isMutant) {
                                imgHtml = `
                                    <div class="mutant-badge-container mini active me-3" style="width: 40px; height: 40px;">
                                        <div class="mutant-badge-shine"></div>
                                        <img src="${group.badge_image_url}" class="w-100 h-100 object-fit-contain">
                                    </div>
                                `;
                            } else {
                                imgHtml = `<img src="${group.badge_image_url}" class="rounded me-3" style="width: 40px; height: 40px; object-fit: contain;">`;
                            }

                            const mutantStyle = isMutant ? 'border: 2px solid gold; background: #fffdf5;' : 'border: 1px solid #eee;';
                            const pPrice = item.purchased_price || 0;
                            const sPrice = item.sell_price;

                            return `
                                <div class="d-flex align-items-center justify-content-between p-2 rounded bg-white" style="${mutantStyle}">
                                    <div class="d-flex align-items-center overflow-hidden">
                                        ${imgHtml}
                                        <div class="small">
                                            <div class="text-muted">è³¼å…¥: ğŸª™${pPrice.toLocaleString()}</div>
                                            <div class="text-danger fw-bold">å£²å´: ğŸª™${Math.floor(sPrice).toLocaleString()}</div>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger rounded-pill ms-2 text-nowrap" style="font-size: 0.8rem; flex-shrink: 0;"
                                        onclick="confirmSellFromShop('${item.uuid}')">å£²å´</button>
                                </div>
                            `;
                        }).join('');

                        detailHtml = `
                            <div class="mt-3 border-top pt-2">
                                <div class="small fw-bold text-muted mb-2">æ‰€æŒãƒªã‚¹ãƒˆ (${totalCount}å€‹)</div>
                                <div class="vstack gap-2">
                                    ${listItemsHtml}
                                </div>
                            </div>
                        `;
                    }
                }

                const rarityClass = getRarityClass(repItem.rarity_name || '');

                return `
                <div class="p-2 rounded shadow-sm bg-white border mb-2">
                    <div class="d-flex align-items-center">
                        <div style="width: 50px; height: 50px; flex-shrink: 0;" class="me-3">
                             <img src="${group.badge_image_url}" class="w-100 h-100 object-fit-contain rounded">
                        </div>
                        <div class="flex-grow-1" style="min-width: 0; margin-right: 10px;">
                            <div class="fw-bold text-truncate">${group.badge_name}</div>
                            <div class="small text-muted d-flex align-items-center flex-wrap gap-2">
                                <span class="badge ${rarityClass || 'bg-light text-dark border'}">${repItem.rarity_name || '-'}</span>
                                <div>æ‰€æŒ: <span class="fw-bold text-dark">${totalCount}</span>å€‹</div>
                                ${mutantCount > 0 ? `<span class="badge bg-warning text-dark">å†…ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ³ãƒˆ: ${mutantCount}</span>` : ''}
                            </div>
                        </div>
                        <div style="flex-shrink: 0;">
                             ${actionArea}
                        </div>
                    </div>
                    ${detailHtml}
                </div>
                `;
            }).join('');

            renderInventoryPagination(totalPages);
        }

        function toggleInventoryExpand(badgeId) {
            if (expandedBadgeId === badgeId) {
                expandedBadgeId = null;
            } else {
                expandedBadgeId = badgeId;
            }
            filterAndRenderInventoryBadges();
        }

        function goToInventoryPage(page) {
            currentInventoryPage = page;
            filterAndRenderInventoryBadges();
        }

        function renderInventoryPagination(totalPages) {
            const nav = document.getElementById('inventory-pagination-area');
            const ul = document.getElementById('inventory-pagination');

            if (totalPages <= 1) {
                nav.style.display = 'none';
                return;
            }

            nav.style.display = 'block';
            let html = '';

            html += `<li class="page-item ${currentInventoryPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="javascript:void(0)" onclick="goToInventoryPage(${currentInventoryPage - 1})">â€¹</a></li>`;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentInventoryPage - 1 && i <= currentInventoryPage + 1)) {
                    html += `<li class="page-item ${i === currentInventoryPage ? 'active' : ''}">
                        <a class="page-link" href="javascript:void(0)" onclick="goToInventoryPage(${i})">${i}</a></li>`;
                } else if (i === currentInventoryPage - 2 || i === currentInventoryPage + 2) {
                    html += `<li class="page-item disabled"><a class="page-link">...</a></li>`;
                }
            }

            html += `<li class="page-item ${currentInventoryPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="javascript:void(0)" onclick="goToInventoryPage(${currentInventoryPage + 1})">â€º</a></li>`;

            ul.innerHTML = html;
        }

        async function executeSellFromShop() {
            bootstrap.Modal.getInstance(document.getElementById('shopActionModal')).hide();
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) loadingOverlay.classList.add('active');

            try {
                const { data, error } = await supabaseClient.rpc('sell_badge_v2', {
                    p_user_id: currentUserId,
                    p_badge_uuid: currentShopActionUUID
                });

                if (error) throw error;
                if (!data.ok) throw new Error(data.error);

                showNotice(`å£²å´ã—ã¾ã—ãŸï¼ (ğŸª™ +${data.sell_price.toLocaleString()})`, 'success');

                if (typeof logActivity === 'function') {
                    await logActivity(currentUserId, 'badge_sell', {
                        amount: data.sell_price,
                        badgeId: currentShopActionBadgeId,
                        details: {
                            badge_uuid: currentShopActionUUID,
                            badge_name: currentShopActionBadgeName
                        }
                    });
                }

                await fetchBalances();
                await loadInventory();

            } catch (err) {
                showNotice('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message, 'error');
            } finally {
                if (loadingOverlay) loadingOverlay.classList.remove('active');
            }
        }

        function confirmSellFromShop(uuid) {
            const item = allInventoryBadges.find(i => i.uuid === uuid);
            if (!item) {
                console.error('Item not found for uuid:', uuid);
                return;
            }

            const name = item.badge_name;
            currentShopActionUUID = uuid;
            currentShopActionBadgeId = item.badge_id || null;
            currentShopActionBadgeName = name || '';
            BadgeSellUI.renderSellConfirmModal(item, () => executeSellFromShop(), {
                confirmLabel: 'å£²å´ã™ã‚‹',
                confirmClass: 'btn-warning'
            });
        }

        let isBulkSellingConvertible = false;
        async function confirmSellAllConvertibleFromShop(badgeId) {
            const targets = allInventoryBadges.filter(i => i.badge_id === badgeId && i.sales_type === 'æ›é‡‘å“');
            if (!targets.length) {
                showNotice('ä¸€æ‹¬å£²å´ã§ãã‚‹æ›é‡‘å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'warning');
                return;
            }

            const badgeName = targets[0].badge_name || '';
            const total = targets.reduce((sum, item) => sum + (item.sell_price || 0), 0);
            const confirmed = confirm(`ã€Œ${badgeName}ã€ã‚’ ${targets.length} å€‹ä¸€æ‹¬å£²å´ã—ã¾ã™ã‹ï¼Ÿï¼ˆåˆè¨ˆ: ğŸª™${Math.floor(total).toLocaleString()}ï¼‰`);
            if (!confirmed) return;

            if (isBulkSellingConvertible) return;
            isBulkSellingConvertible = true;
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) loadingOverlay.classList.add('active');

            try {
                let successCount = 0;
                let actualTotal = 0;
                for (const item of targets) {
                    const { data, error } = await supabaseClient.rpc('sell_badge_v2', {
                        p_user_id: currentUserId,
                        p_badge_uuid: item.uuid
                    });
                    if (error || !data.ok) {
                        console.error('ä¸€æ‹¬å£²å´ã‚¨ãƒ©ãƒ¼:', error || data.error);
                        continue;
                    }
                    successCount++;
                    actualTotal += data.sell_price || 0;
                }

                if (successCount > 0) {
                    showNotice(`ã€Œ${badgeName}ã€ã‚’ ${successCount} å€‹ä¸€æ‹¬å£²å´ã—ã¾ã—ãŸã€‚ï¼ˆåˆè¨ˆ: ğŸª™${Math.floor(actualTotal).toLocaleString()}ï¼‰`, 'success');
                    if (typeof logActivity === 'function') {
                        await logActivity(currentUserId, 'badge_sell', {
                            amount: actualTotal,
                            badgeId: badgeId,
                            details: {
                                badge_id: badgeId,
                                badge_name: badgeName,
                                quantity: successCount
                            }
                        });
                    }
                }

                await fetchBalances();
                await loadInventory();
            } catch (err) {
                showNotice('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message, 'error');
            } finally {
                if (loadingOverlay) loadingOverlay.classList.remove('active');
                isBulkSellingConvertible = false;
            }
        }
    </script>

    <div id="jarebon-links" class="container pb-5 jarebon-links-wrap" style="display: none;">
        <div class="text-white fw-bold mb-3" style="font-size: 1.1rem;">ã¿ã‚“ãªã®ã˜ã‚ƒã‚Œæœ¬ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã¯ã“ã¡ã‚‰</div>

        <div class="text-white-50 mb-2">ãƒ¼ãƒ¼Aãƒãƒ¼ãƒ ã®ä½œå“ãƒ¼ãƒ¼</div>
        <div class="d-flex flex-column gap-2 mb-4">
            <a class="btn btn-sm btn-outline-light rounded-pill" href="https://kanisaba.my.canva.site/03-a">æŸã‚„ã¶ã‚Šå§«~ãã‚“ãªäº‹ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã‚·ãƒ³ãƒ‡ãƒ¬ãƒ©ï½§ï¼~</a>
            <a class="btn btn-sm btn-outline-light rounded-pill" href="https://kanisaba.my.canva.site/05-a">æ³¨æ„â€»ã“ã®ã˜ã‚ƒã‚Œæœ¬ã‚’èª­ã‚“ã§ã¯ã„ã‘ã¾ã›ã‚“</a>
            <a class="btn btn-sm btn-outline-light rounded-pill" href="https://kanisaba.my.canva.site/07-a">æ¯æœåŒã˜é›»è»Šã€‚æ°—ã«ãªã‚‹ã€ã‚ã®ã‚³ã€‚</a>
        </div>

        <div class="text-white-50 mb-2">ãƒ¼ãƒ¼Bãƒãƒ¼ãƒ ã®ä½œå“ãƒ¼ãƒ¼</div>
        <div class="d-flex flex-column gap-2 mb-4">
            <a class="btn btn-sm btn-outline-light rounded-pill" href="https://kanisaba.my.canva.site/04-b">æŸã‚„ã¶ã‚Šå§«~ãã‚“ãªäº‹ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã‚·ãƒ³ãƒ‡ãƒ¬ãƒ©ï½§ï¼~</a>
            <a class="btn btn-sm btn-outline-light rounded-pill" href="https://kanisaba.my.canva.site/06-b">æ³¨æ„â€»ã“ã®ã˜ã‚ƒã‚Œæœ¬ã‚’èª­ã‚“ã§ã¯ã„ã‘ã¾ã›ã‚“</a>
            <a class="btn btn-sm btn-outline-light rounded-pill" href="https://kanisaba.my.canva.site/08-b">æ¯æœåŒã˜é›»è»Šã€‚æ°—ã«ãªã‚‹ã€ã‚ã®ã‚³ã€‚</a>
        </div>

        <div class="text-white-50 mb-2">ãƒ¼ãƒ¼ã¿ã‚“ãªã®ä½œå“ãƒ¼ãƒ¼</div>
        <div class="d-flex flex-column gap-2">
            <a class="btn btn-sm btn-outline-light rounded-pill" href="https://kanisaba.my.canva.site/01">ã‚„ã¾ãŠã‹ã®ãŸã¾ã”æ‹¾ã„ã¾ã—ãŸã€‚ã†ã‚†ã‚†ã ã‚ˆã€‚</a>
            <a class="btn btn-sm btn-outline-light rounded-pill" href="https://kanisaba.my.canva.site/02">ã‚«ãƒ‹é¯–ç‰ˆã€é–¢ãƒ¶åŸã®æˆ¦ã„ğŸ¦€</a>
        </div>
    </div>
</body>

</html>
