<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠã¿ãã˜ - ã‹ã«é¯–</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <style>
        :root {
            --deep-purple: #5a4a7a;
            --gold: #d4a574;
            --font-title: 'Kosugi Maru', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            min-height: 100vh;
        }

        .page-header {
            color: #fff;
            font-family: var(--font-title);
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .omikuji-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .fortune-box {
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .fortune-rank {
            font-size: 3rem;
            font-weight: bold;
            font-family: var(--font-title);
            color: var(--deep-purple);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .fortune-reward {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 10px;
        }

        .fortune-reward.positive {
            color: #27ae60;
        }

        .fortune-reward.negative {
            color: #e74c3c;
        }

        .fortune-message {
            margin-top: 20px;
            font-size: 1.1rem;
            color: #555;
            line-height: 1.8;
        }

        .draw-button {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.4);
        }

        .draw-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.5);
        }

        .draw-button:disabled {
            background: #aaa;
            cursor: not-allowed;
            box-shadow: none;
        }

        .already-drawn {
            color: #999;
            font-size: 1.1rem;
        }

        .access-denied {
            color: #e74c3c;
            font-size: 1.2rem;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-5px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(5px);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .shaking {
            animation: shake 0.8s ease-in-out;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
        .nav-dropdown {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .record-button {
            background: linear-gradient(135deg, var(--gold) 0%, #b8892d 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 6px 20px rgba(212, 168, 83, 0.5);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            cursor: pointer;
        }

        .record-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 168, 83, 0.6);
            color: white;
        }

        .nav-dropdown-menu {
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            min-width: 200px;
            overflow: hidden;
            border: none;
        }

        .dropdown-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            transition: background 0.2s;
        }
    </style>
</head>

<body>
    <!-- å³ä¸Šã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
    <div class="nav-dropdown dropdown">
        <button class="record-button dropdown-toggle" type="button" id="navDropdown" data-bs-toggle="dropdown"
            aria-expanded="false">
            ğŸ“ ãƒ¡ãƒ‹ãƒ¥ãƒ¼
        </button>
        <ul class="dropdown-menu nav-dropdown-menu dropdown-menu-end" aria-labelledby="navDropdown">
            <li><a class="dropdown-item" href="../index.html">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a></li>
            <li><a class="dropdown-item" href="../mypage/index.html">ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</a></li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="../mahjong/index.html">ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a></li>
            <li><a class="dropdown-item" href="../mahjong/record.html">ğŸ“ è¨˜éŒ²ã™ã‚‹</a></li>
            <li><a class="dropdown-item" href="../mahjong/users/index.html">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a></li>
            <li><a class="dropdown-item" href="../mahjong/team/index.html">ğŸ… ãƒãƒ¼ãƒ ç®¡ç†</a></li>
            <li><a class="dropdown-item" href="../badge/list.html">ğŸ“› ãƒãƒƒã‚¸ä¸€è¦§</a></li>
            <li><a class="dropdown-item" href="../badge/shop.html">ğŸ›’ ãƒãƒƒã‚¸ã‚·ãƒ§ãƒƒãƒ—</a></li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="./index.html">ğŸ‹ ãŠã¿ãã˜</a></li>
            <li class="admin-only" style="display:none;">
                <hr class="dropdown-divider">
            </li>
            <li class="admin-only" style="display:none;">
                <a class="dropdown-item" href="../admin/index.html">âš™ï¸ ç®¡ç†ç”»é¢</a>
            </li>
        </ul>
    </div>

    <div class="container py-5">
        <header class="text-center">
            <h1 class="page-header display-4 fw-bold">ğŸ‹ ãŠã¿ãã˜</h1>
            <p class="text-white-50">1æ—¥1å›ã®é‹è©¦ã—ï¼</p>
        </header>

        <div class="omikuji-card">
            <!-- ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦è¡¨ç¤º -->
            <div id="access-denied" style="display: none;">
                <div class="access-denied mb-4">
                    <p>ğŸš« ã“ã®ãƒšãƒ¼ã‚¸ã¯ç®¡ç†è€…é™å®šã§ã™</p>
                </div>
                <a href="../index.html" class="btn btn-outline-secondary">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
            </div>

            <!-- ãƒ­ã‚°ã‚¤ãƒ³ä¿ƒé€² -->
            <div id="login-prompt" style="display: none;">
                <p class="mb-4">ãŠã¿ãã˜ã‚’å¼•ãã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
                <button onclick="loginWithDiscord()" class="btn btn-primary">Discordã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>

            <!-- ãŠã¿ãã˜UI -->
            <div id="omikuji-ui" style="display: none;">
                <!-- å¼•ãå‰ -->
                <div id="before-draw">
                    <p class="mb-4" style="font-size: 1.1rem;">ä»Šæ—¥ã®é‹å‹¢ã‚’å ã„ã¾ã—ã‚‡ã†ï¼</p>
                    <button id="draw-button" class="draw-button" onclick="drawOmikuji()">
                        ğŸ‹ ãŠã¿ãã˜ã‚’å¼•ã
                    </button>
                </div>

                <!-- å¼•ã„ãŸå¾Œ -->
                <div id="after-draw" style="display: none;">
                    <div id="result-box" class="fortune-box fade-in">
                        <div id="fortune-rank" class="fortune-rank"></div>
                        <div id="fortune-reward" class="fortune-reward"></div>
                    </div>
                    <div id="fortune-message" class="fortune-message"></div>
                    <button id="pay-penalty-btn" class="btn btn-danger mt-3" style="display: none;" onclick="payOmikujiPenalty()">
                        ğŸª™ æ”¯æ‰•ã†
                    </button>
                    <button id="mypage-confirm-btn" class="btn btn-outline-secondary mt-4" onclick="location.href='../mypage/index.html'">
                        ãƒã‚¤ãƒšãƒ¼ã‚¸ã§ç¢ºèª
                    </button>
                </div>

                <!-- æ—¢ã«å¼•ã„ãŸ -->
                <div id="already-drawn" style="display: none;">
                    <p class="already-drawn">ğŸŒ™ æœ¬æ—¥ã¯æ—¢ã«ãŠã¿ãã˜ã‚’å¼•ã„ã¦ã„ã¾ã™</p>
                    <p class="text-muted mt-3">æ¬¡ã®ãŠã¿ãã˜ã¯æ˜æ—¥ã®0æ™‚ä»¥é™ã«å¼•ã‘ã¾ã™</p>
                    <a href="../mypage/index.html" class="btn btn-outline-primary mt-3">ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/auth-guard.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            initAccordionNav('../');
        });
    </script>
    <script>
        let currentUserId = null;
        let omikujiSettings = [];

        async function initOmikuji() {
            const user = await getCurrentUser();

            // ãªã‚Šã™ã¾ã—å¯¾å¿œ
            currentUserId = await getEffectiveUserId();

            if (!user && !currentUserId) {
                document.getElementById('login-prompt').style.display = 'block';
                return;
            }

            // ãŠã¿ãã˜è¨­å®šã‚’å–å¾—
            const { data: settings, error: settingsError } = await supabaseClient
                .from('omikuji_settings')
                .select('*');

            if (settingsError || !settings || settings.length === 0) {
                document.getElementById('omikuji-ui').style.display = 'block';
                document.getElementById('before-draw').innerHTML = '<p class="text-danger">ãŠã¿ãã˜ã®è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</p>';
                return;
            }

            omikujiSettings = settings;

            // æœ¬æ—¥æ—¢ã«å¼•ã„ãŸã‹ãƒã‚§ãƒƒã‚¯
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('last_omikuji_at')
                .eq('discord_user_id', currentUserId)
                .single();

            document.getElementById('omikuji-ui').style.display = 'block';

            if (profile?.last_omikuji_at && hasDrawnOmikujiToday(profile.last_omikuji_at)) {
                document.getElementById('before-draw').style.display = 'none';
                document.getElementById('already-drawn').style.display = 'block';
            }
        }

                let baseRewardHtml = '';

        async function drawOmikuji() {
            const button = document.getElementById('draw-button');
            button.disabled = true;
            button.textContent = 'å ã„ä¸­...';
            button.classList.add('shaking');

            try {
                // é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ é¸æŠ
                const totalWeight = omikujiSettings.reduce((sum, s) => sum + s.weight, 0);
                let random = Math.random() * totalWeight;
                let selected = omikujiSettings[0];

                for (const setting of omikujiSettings) {
                    random -= setting.weight;
                    if (random <= 0) {
                        selected = setting;
                        break;
                    }
                }

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
                const messages = selected.messages || ['ä»Šæ—¥ã‚‚è‰¯ã„ä¸€æ—¥ã‚’ï¼'];
                const message = messages[Math.floor(Math.random() * messages.length)];

                // ç¾åœ¨ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—
                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('coins, total_assets, gacha_tickets, mangan_tickets')
                    .eq('discord_user_id', currentUserId)
                    .single();

                if (profileError) throw profileError;

                let coinReward = selected.reward || 0;
                const ticketReward = selected.ticket_reward || 0;
                const manganReward = selected.mangan_ticket_reward || 0;
                const isMusumeKyo = selected.rank === 'ã‚€ã™ã‚å‡¶';
                const displayPenalty = isMusumeKyo ? -999 : null;

                let newCoins = (profile.coins || 0) + coinReward;
                let newTotalAssets = profile.total_assets || 0;
                let newTickets = (profile.gacha_tickets || 0) + ticketReward;
                let newManganTickets = (profile.mangan_tickets || 0) + manganReward;

                // ãƒã‚¤ãƒŠã‚¹ã®å ´åˆã¯0ä»¥ä¸‹ã«ã—ãªã„
                if (newCoins < 0) newCoins = 0;
                if (newTickets < 0) newTickets = 0;
                if (newManganTickets < 0) newManganTickets = 0;

                // ã‚³ã‚¤ãƒ³ãƒ—ãƒ©ã‚¹åˆ†ã‚’ç·è³‡ç”£ã«åŠ ç®—
                if (coinReward > 0) {
                    newTotalAssets += coinReward;
                }

                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°
                const { error: updateError } = await supabaseClient
                    .from('profiles')
                    .update({
                        coins: newCoins,
                        total_assets: newTotalAssets,
                        gacha_tickets: newTickets,
                        mangan_tickets: newManganTickets,
                        last_omikuji_at: new Date().toISOString()
                    })
                    .eq('discord_user_id', currentUserId);

                if (updateError) throw updateError;

                // æ´»å‹•ãƒ­ã‚°ã‚’è¨˜éŒ²
                if (typeof logActivity === 'function') {
                    await logActivity(currentUserId, 'omikuji', {
                        amount: coinReward,
                        details: {
                            rank: selected.rank,
                            message: message,
                            ticket_reward: ticketReward,
                            mangan_ticket_reward: manganReward
                        }
                    });
                }

                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰çµæœã‚’è¡¨ç¤º
                await new Promise(resolve => setTimeout(resolve, 1000));

                // çµæœã‚’è¡¨ç¤º
                document.getElementById('before-draw').style.display = 'none';
                document.getElementById('after-draw').style.display = 'block';

                document.getElementById('fortune-rank').textContent = selected.rank;

                const rewardEl = document.getElementById('fortune-reward');
                let rewardHtml = '';
                if (coinReward !== 0) {
                    rewardHtml += `<span class="${coinReward > 0 ? 'text-success' : 'text-danger'}">ğŸª™ ${coinReward >= 0 ? '+' : ''}${coinReward.toLocaleString()}</span> `;
                }
                if (displayPenalty !== null) {
                    rewardHtml += `<span class="text-danger">ğŸª™ ${displayPenalty.toLocaleString()}</span> `;
                }
                if (ticketReward !== 0) {
                    rewardHtml += `<span style="color: #d4a574;">ğŸ« ${ticketReward >= 0 ? '+' : ''}${ticketReward}æš</span>`;
                }
                if (manganReward !== 0) {
                    rewardHtml += ` <span style="color: #d4a574;">ğŸ§§ ${manganReward >= 0 ? '+' : ''}${manganReward}æš</span>`;
                }

                let baseHtml = '';
                if (coinReward !== 0) {
                    baseHtml += `<span class="${coinReward > 0 ? 'text-success' : 'text-danger'}">ğŸª™ ${coinReward >= 0 ? '+' : ''}${coinReward.toLocaleString()}</span> `;
                }
                if (ticketReward !== 0) {
                    baseHtml += `<span style="color: #d4a574;">ğŸ« ${ticketReward >= 0 ? '+' : ''}${ticketReward}æš</span>`;
                }
                if (manganReward !== 0) {
                    baseHtml += ` <span style="color: #d4a574;">ğŸ§§ ${manganReward >= 0 ? '+' : ''}${manganReward}æš</span>`;
                }
                baseRewardHtml = baseHtml || '<span class="text-muted">å ±é…¬ãªã—</span>';

                if (isMusumeKyo) {
                    rewardEl.innerHTML = `<span class="text-danger">ğŸª™ ${displayPenalty.toLocaleString()}</span>`;
                } else {
                    rewardEl.innerHTML = rewardHtml || '<span class="text-muted">å ±é…¬ãªã—</span>';
                }
                rewardEl.className = 'fortune-reward'; // å€‹åˆ¥ã«è‰²ã‚’æŒ‡å®šã™ã‚‹ã®ã§ã‚¯ãƒ©ã‚¹ã¯ãƒªã‚»ãƒƒãƒˆ

                document.getElementById('fortune-message').textContent = message;
                const payBtn = document.getElementById('pay-penalty-btn');
                const mypageBtn = document.getElementById('mypage-confirm-btn');
                if (payBtn) {
                    payBtn.style.display = isMusumeKyo ? 'inline-block' : 'none';
                    payBtn.disabled = false;
                }
                if (mypageBtn) {
                    mypageBtn.style.display = isMusumeKyo ? 'none' : 'inline-block';
                }

            } catch (err) {
                console.error('Omikuji error:', err);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message);
                button.disabled = false;
                button.textContent = 'ğŸ‹ ãŠã¿ãã˜ã‚’å¼•ã';
            } finally {
                button.classList.remove('shaking');
            }
        }

        function payOmikujiPenalty() {
            const payBtn = document.getElementById('pay-penalty-btn');
            if (payBtn) {
                payBtn.disabled = true;
                payBtn.textContent = 'ãƒã‚¤ãƒšãƒ¼ã‚¸ã§ç¢ºèª';
                payBtn.classList.remove('btn-danger');
                payBtn.classList.add('btn-outline-secondary');
                payBtn.onclick = () => {
                    location.href = '../mypage/index.html';
                };
            }
            const rewardEl = document.getElementById('fortune-reward');
            if (rewardEl) {
                rewardEl.innerHTML = baseRewardHtml || '<span class="text-muted">å ±é…¬ãªã—</span>';
            }
            document.getElementById('fortune-message').textContent = 'ã¡ã£ã€æŒã£ã¦ã­ãƒ¼ã®ã‹ã‚ˆï¼ã—ã‘ã¦ã‚“ãªãƒ¼ã€‚ã—ã‚ƒãƒ¼ãªã—ã“ã‚Œã‚„ã‚‹ã‚ˆ';
        }

        document.addEventListener('DOMContentLoaded', initOmikuji);
    </script>
</body>

</html>
