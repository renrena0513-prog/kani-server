<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ¼ãƒ ç®¡ç† | ã‹ã«ã‚µãƒ¼ãƒãƒ¼</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=M+PLUS+Rounded+1c:wght@400;700&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-green: #2d8a5e;
            --deep-green: #1e6b47;
            --cream: #faf5e8;
            --gold: #d4a853;
            --font-title: 'Noto Serif JP', serif;
            --font-body: 'M PLUS Rounded 1c', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background: linear-gradient(180deg, #2d8a5e 0%, #256b4a 50%, #1e5538 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }

        .page-header {
            font-family: var(--font-title);
            color: var(--cream);
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            text-decoration: none;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 18px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--gold);
        }

        .content-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .section-title {
            font-family: var(--font-title);
            color: var(--deep-green);
            border-bottom: 2px solid var(--gold);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .member-card {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .member-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-right: 15px;
            border: 2px solid var(--gold);
        }

        .member-name {
            font-weight: 600;
            color: #333;
            flex-grow: 1;
        }

        .member-role {
            font-size: 0.8rem;
            color: #666;
            background: #e9ecef;
            padding: 4px 10px;
            border-radius: 15px;
        }

        .request-card {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .request-actions {
            display: flex;
            gap: 10px;
        }

        .btn-approve {
            background: var(--deep-green);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
        }

        .btn-reject {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .btn-leave-team {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <a href="../index.html" class="back-button">â† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æˆ»ã‚‹</a>

    <div class="container py-5 mt-4">
        <header class="text-center mb-4">
            <h1 class="page-header display-4 fw-bold">ğŸ… ãƒãƒ¼ãƒ ç®¡ç†</h1>
        </header>

        <div id="loading" class="content-card text-center py-5">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
        </div>

        <!-- æœªãƒ­ã‚°ã‚¤ãƒ³ -->
        <div id="not-logged-in" class="content-card" style="display: none;">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ”’</div>
                <h3>ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</h3>
                <p class="text-muted">ãƒãƒ¼ãƒ ç®¡ç†æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯Discordã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
                <button onclick="loginWithDiscord()" class="btn btn-success btn-lg">Discordã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>
        </div>

        <!-- æœªæ‰€å± -->
        <div id="no-team" class="content-card" style="display: none;">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸš«</div>
                <h3>ãƒãƒ¼ãƒ ã«æ‰€å±ã—ã¦ã„ã¾ã›ã‚“</h3>
                <p class="text-muted">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‹ã‚‰ãƒãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹ã‹ã€æ—¢å­˜ã®ãƒãƒ¼ãƒ ã«åŠ å…¥ç”³è«‹ã—ã¦ãã ã•ã„</p>
                <a href="./users/index.html" class="btn btn-success btn-lg">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã¸</a>
            </div>
        </div>

        <!-- ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼è¡¨ç¤º -->
        <div id="team-content" style="display: none;">
            <div class="content-card">
                <h2 id="team-name-header" class="section-title">ğŸ… ãƒãƒ¼ãƒ å</h2>

                <!-- åŠ å…¥ç”³è«‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ -->
                <div id="join-requests-section" style="display: none;">
                    <h4 class="mb-3">ğŸ“¬ åŠ å…¥ç”³è«‹</h4>
                    <div id="join-requests-list"></div>
                </div>

                <!-- ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ -->
                <h4 class="mb-3 mt-4">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</h4>
                <div id="members-list"></div>

                <!-- è„±é€€ãƒœã‚¿ãƒ³ -->
                <div class="text-center mt-4">
                    <button onclick="leaveTeam()" class="btn-leave-team">ãƒãƒ¼ãƒ ã‚’è„±é€€ã™ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../js/supabase-config.js"></script>

    <script>
        let currentUser = null;
        let myProfile = null;
        let myTeam = null;
        let isTeamAdmin = false;

        document.addEventListener('DOMContentLoaded', initTeamPage);

        async function initTeamPage() {
            currentUser = await getCurrentUser();

            if (!currentUser) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('not-logged-in').style.display = 'block';
                return;
            }

            const discordId = currentUser.user_metadata.provider_id;

            // è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('discord_user_id', discordId)
                .maybeSingle();

            myProfile = profile;

            if (!profile || !profile.team_id) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('no-team').style.display = 'block';
                return;
            }

            // ãƒãƒ¼ãƒ æƒ…å ±å–å¾—
            const { data: team } = await supabaseClient
                .from('teams')
                .select('*')
                .eq('id', profile.team_id)
                .single();

            myTeam = team;
            isTeamAdmin = team.creator_discord_id === discordId;

            await renderTeamContent();

            document.getElementById('loading').style.display = 'none';
            document.getElementById('team-content').style.display = 'block';
        }

        async function renderTeamContent() {
            document.getElementById('team-name-header').textContent = `ğŸ… ${myTeam.team_name}`;

            // ç®¡ç†è€…ã®å ´åˆã€åŠ å…¥ç”³è«‹ã‚’è¡¨ç¤º
            if (isTeamAdmin) {
                document.getElementById('join-requests-section').style.display = 'block';
                await loadJoinRequests();
            }

            // ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§å–å¾—
            const { data: members } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('team_id', myTeam.id)
                .order('account_name');

            const membersList = document.getElementById('members-list');
            if (!members || members.length === 0) {
                membersList.innerHTML = '<p class="text-muted">ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</p>';
                return;
            }

            membersList.innerHTML = members.map(member => {
                const isAdmin = member.discord_user_id === myTeam.creator_discord_id;
                const avatarUrl = member.avatar_url || 'https://via.placeholder.com/48';
                const name = member.account_name || 'åç§°æœªè¨­å®š';

                return `
                    <div class="member-card">
                        <img src="${avatarUrl}" alt="${name}" class="member-avatar" onerror="this.src='https://via.placeholder.com/48'">
                        <span class="member-name">${name}</span>
                        ${isAdmin ? '<span class="member-role">ğŸ‘‘ ãƒªãƒ¼ãƒ€ãƒ¼</span>' : ''}
                    </div>
                `;
            }).join('');
        }

        async function loadJoinRequests() {
            const { data: requests } = await supabaseClient
                .from('team_join_requests')
                .select('*')
                .eq('team_id', myTeam.id)
                .eq('status', 'pending');

            const container = document.getElementById('join-requests-list');

            if (!requests || requests.length === 0) {
                container.innerHTML = '<p class="text-muted">æ–°ã—ã„åŠ å…¥ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // ç”³è«‹è€…ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
            const requesterIds = requests.map(r => r.requester_discord_id);
            const { data: profiles } = await supabaseClient
                .from('profiles')
                .select('*')
                .in('discord_user_id', requesterIds);

            const profileMap = {};
            profiles?.forEach(p => profileMap[p.discord_user_id] = p);

            container.innerHTML = requests.map(req => {
                const profile = profileMap[req.requester_discord_id] || {};
                const avatarUrl = profile.avatar_url || 'https://via.placeholder.com/48';
                const name = profile.account_name || 'åç§°æœªè¨­å®š';

                return `
                    <div class="request-card" id="request-${req.id}">
                        <img src="${avatarUrl}" alt="${name}" class="member-avatar" onerror="this.src='https://via.placeholder.com/48'">
                        <span class="member-name">${name}</span>
                        <div class="request-actions">
                            <button class="btn-approve" onclick="approveRequest('${req.id}', '${req.requester_discord_id}')">âœ“ è¨±å¯</button>
                            <button class="btn-reject" onclick="rejectRequest('${req.id}')">âœ— æ‹’å¦</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function approveRequest(requestId, requesterDiscordId) {
            try {
                // ç”³è«‹ã‚’æ‰¿èªæ¸ˆã¿ã«æ›´æ–°
                await supabaseClient
                    .from('team_join_requests')
                    .update({ status: 'approved' })
                    .eq('id', requestId);

                // ç”³è«‹è€…ã‚’ãƒãƒ¼ãƒ ã«è¿½åŠ 
                await supabaseClient
                    .from('profiles')
                    .update({ team_id: myTeam.id })
                    .eq('discord_user_id', requesterDiscordId);

                alert('åŠ å…¥ã‚’è¨±å¯ã—ã¾ã—ãŸï¼');
                location.reload();
            } catch (err) {
                console.error('æ‰¿èªã‚¨ãƒ©ãƒ¼:', err);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        async function rejectRequest(requestId) {
            if (!confirm('ã“ã®ç”³è«‹ã‚’æ‹’å¦ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                await supabaseClient
                    .from('team_join_requests')
                    .update({ status: 'rejected' })
                    .eq('id', requestId);

                document.getElementById(`request-${requestId}`).remove();
            } catch (err) {
                console.error('æ‹’å¦ã‚¨ãƒ©ãƒ¼:', err);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        async function leaveTeam() {
            if (!confirm('æœ¬å½“ã«ãƒãƒ¼ãƒ ã‚’è„±é€€ã—ã¾ã™ã‹ï¼Ÿ')) return;

            const discordId = currentUser.user_metadata.provider_id;

            // ãƒªãƒ¼ãƒ€ãƒ¼ã¯è„±é€€ã§ããªã„
            if (isTeamAdmin) {
                alert('ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ã¯è„±é€€ã§ãã¾ã›ã‚“ã€‚ãƒãƒ¼ãƒ ã‚’è§£æ•£ã™ã‚‹ã‹ã€ãƒªãƒ¼ãƒ€ãƒ¼ã‚’è­²æ¸¡ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                await supabaseClient
                    .from('profiles')
                    .update({ team_id: null })
                    .eq('discord_user_id', discordId);

                alert('ãƒãƒ¼ãƒ ã‚’è„±é€€ã—ã¾ã—ãŸ');
                location.reload();
            } catch (err) {
                console.error('è„±é€€ã‚¨ãƒ©ãƒ¼:', err);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
    </script>
</body>

</html>