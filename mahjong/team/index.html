<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ¼ãƒ ç®¡ç† | ã‹ã«ã‚µãƒ¼ãƒãƒ¼</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=M+PLUS+Rounded+1c:wght@400;700&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../styles.css">
    <style>
        :root {
            --primary-green: #2d8a5e;
            --deep-green: #1e6b47;
            --cream: #faf5e8;
            --gold: #d4a853;
            --font-title: 'Noto Serif JP', serif;
            --font-body: 'M PLUS Rounded 1c', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background: linear-gradient(180deg, #2d8a5e 0%, #256b4a 50%, #1e5538 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }

        .page-header {
            font-family: var(--font-title);
            color: var(--cream);
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            text-decoration: none;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 18px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--gold);
        }

        .content-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .section-title {
            font-family: var(--font-title);
            color: var(--deep-green);
            border-bottom: 2px solid var(--gold);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .member-card {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }

        .member-card:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .member-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-right: 15px;
            border: 2px solid var(--gold);
        }

        .member-name {
            font-weight: 600;
            color: #333;
            /* flex-grow: 1;Removed to prevent badge separation */
            margin-right: 8px;
            margin-left: 8px;
        }

        .member-role {
            font-size: 0.8rem;
            color: #666;
            background: #e9ecef;
            padding: 4px 10px;
            border-radius: 15px;
        }

        .request-card {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .stat-card-mini {
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
            height: 100%;
        }

        .stat-card-mini:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--gold);
        }

        .stat-card-mini.rank-1 {
            background: linear-gradient(135deg, #fff7ad 0%, #ffa700 100%) !important;
            border-left: 8px solid #ffd700 !important;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3) !important;
        }

        .stat-card-mini.rank-2 {
            background: linear-gradient(135deg, #f0f0f0 0%, #a0a0a0 100%) !important;
            border-left: 8px solid #c0c0c0 !important;
            box-shadow: 0 4px 15px rgba(192, 192, 192, 0.3) !important;
        }

        .stat-card-mini.rank-3 {
            background: linear-gradient(135deg, #f5d4b5 0%, #b87333 100%) !important;
            border-left: 8px solid #cd7f32 !important;
            box-shadow: 0 4px 15px rgba(205, 127, 50, 0.3) !important;
        }
        .stat-card-mini.clickable {
            cursor: pointer;
        }

        .stat-rank {
            font-size: 0.7rem;
            color: #fff;
            background: linear-gradient(135deg, var(--gold), #b8860b);
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 5px;
            display: inline-block;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .stat-rank.no-data {
            background: #adb5bd;
        }

        .stat-label-mini {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-value-mini {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--deep-purple);
        }

        @media (max-width: 767px) {
            .stat-card-mini {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 10px 15px;
                text-align: left;
            }

            .stat-label-mini {
                margin-bottom: 0;
                flex: 1;
            }

            .stat-value-mini {
                font-size: 1.1rem;
                margin: 0 10px;
                flex: 1;
                text-align: right;
            }

            .stat-rank {
                margin-top: 0;
                font-size: 0.65rem;
                min-width: 60px;
                text-align: center;
            }
        }

        .matchup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }

        .matchup-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 12px 14px;
            border: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        @media (max-width: 767px) {
            .member-score-table thead {
                display: none;
            }

            .member-score-table,
            .member-score-table tbody,
            .member-score-table tr,
            .member-score-table td {
                display: block;
                width: 100%;
            }

            .member-score-table tr {
                border: 1px solid #e9ecef;
                border-radius: 12px;
                padding: 12px;
                margin-bottom: 12px;
                background: #fff;
                display: flex;
                flex-direction: column;
                gap: 6px;
            }

            .member-score-table tr.rank-1 {
                background: linear-gradient(135deg, #fff7ad 0%, #ffa700 100%);
                border-left: 6px solid #ffd700;
                box-shadow: 0 4px 12px rgba(255, 215, 0, 0.25);
            }

            .member-score-table tr.rank-2 {
                background: linear-gradient(135deg, #f0f0f0 0%, #a0a0a0 100%);
                border-left: 6px solid #c0c0c0;
                box-shadow: 0 4px 12px rgba(192, 192, 192, 0.25);
            }

            .member-score-table tr.rank-3 {
                background: linear-gradient(135deg, #f5d4b5 0%, #b87333 100%);
                border-left: 6px solid #cd7f32;
                box-shadow: 0 4px 12px rgba(205, 127, 50, 0.25);
            }

            .member-score-table tr.rank-1 td,
            .member-score-table tr.rank-2 td,
            .member-score-table tr.rank-3 td {
                background: transparent;
            }

            .member-score-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 4px 0;
                border: none;
            }

            .member-score-table td::before {
                content: attr(data-label);
                font-size: 0.75rem;
                color: #6c757d;
                font-weight: 600;
                margin-right: 10px;
            }

            .member-score-table td[data-label="é †ä½"] {
                display: none;
            }

            .member-score-table td[data-label="ãƒ¡ãƒ³ãƒãƒ¼"] {
                order: 1;
                justify-content: flex-start;
                gap: 8px;
                flex-direction: column;
                align-items: flex-start;
            }

            .member-score-table td[data-label="ãƒ¡ãƒ³ãƒãƒ¼"] .rank-badge-inline {
                display: inline-flex;
            }

            .member-score-table td[data-label="ãƒ¡ãƒ³ãƒãƒ¼"]::before {
                content: '';
                display: none;
            }

            .member-score-table td[data-label="åˆè¨ˆã‚¹ã‚³ã‚¢"] { order: 2; }
            .member-score-table td[data-label="24æ™‚é–“æ¯”"] { order: 3; }
            .member-score-table td[data-label="è©¦åˆæ•°"] { order: 4; }
            .member-score-table td[data-label="å››éº»å›æ•°"] { order: 5; }
            .member-score-table td[data-label="ä¸‰éº»å›æ•°"] { order: 6; }

            .member-score-table td[data-label="åˆè¨ˆã‚¹ã‚³ã‚¢"],
            .member-score-table td[data-label="24æ™‚é–“æ¯”"],
            .member-score-table td[data-label="è©¦åˆæ•°"],
            .member-score-table td[data-label="å››éº»å›æ•°"],
            .member-score-table td[data-label="ä¸‰éº»å›æ•°"] {
                display: none;
            }

            .member-score-mobile-stats {
                display: flex;
                flex-direction: column;
                gap: 6px;
                margin-top: 6px;
                width: 100%;
                align-items: flex-start;
            }

            .member-score-mobile-row {
                display: flex;
                justify-content: flex-start;
                gap: 16px;
                font-size: 0.9rem;
                font-weight: 600;
                color: #2b2f36;
                flex-wrap: wrap;
                align-items: center;
            }

            .member-score-mobile-row span {
                min-width: 0;
                text-align: left;
            }

            .member-score-mobile-row .label {
                font-size: 0.7rem;
                color: #6c757d;
                font-weight: 600;
                margin-right: 6px;
            }
        }

        .rank-badge-mini {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #f1f3f5;
            color: #495057;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .member-score-table td[data-label="ãƒ¡ãƒ³ãƒãƒ¼"] .rank-badge-mini {
            display: none;
        }

        .member-score-mobile-stats {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 6px;
            width: 100%;
        }

        .member-score-table tr.rank-1 {
            background: linear-gradient(135deg, #fff7ad 0%, #ffa700 100%);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.18) inset;
        }

        .member-score-table tr.rank-2 {
            background: linear-gradient(135deg, #f0f0f0 0%, #a0a0a0 100%);
            box-shadow: 0 4px 12px rgba(192, 192, 192, 0.18) inset;
        }

        .member-score-table tr.rank-3 {
            background: linear-gradient(135deg, #f5d4b5 0%, #b87333 100%);
            box-shadow: 0 4px 12px rgba(205, 127, 50, 0.18) inset;
        }

        .member-score-table tr.rank-1 td,
        .member-score-table tr.rank-2 td,
        .member-score-table tr.rank-3 td {
            background: transparent;
        }

        @media (min-width: 768px) {
            .member-score-mobile-stats {
                display: none;
            }
        }

        .member-score-header {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .rank-badge-inline {
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2px 8px;
            border-radius: 999px;
            background: #f1f3f5;
            color: #495057;
            font-weight: 700;
            font-size: 0.75rem;
        }

        .member-score-header .member-name {
            font-weight: 700;
            color: #2b2f36;
        }

        .team-log-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .team-log-filters .form-select {
            min-width: 220px;
        }

        .custom-dropdown-container {
            position: relative;
            min-width: 240px;
        }

        .custom-dropdown-list {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            max-height: 320px;
            overflow-y: auto;
            z-index: 2000;
            display: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        .dropdown-item-flex {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #f1f3f5;
        }

        .dropdown-item-flex:last-child {
            border-bottom: none;
        }

        .dropdown-item-flex:hover {
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
        }

        .dropdown-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .player-entry {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .player-team-row {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: #6c757d;
        }

        .team-logo-mini {
            width: 18px;
            height: 18px;
            object-fit: contain;
            border-radius: 4px;
        }

        .player-info-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mahjong-filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .mahjong-filter-select {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 10px 14px;
            font-size: 0.9rem;
            min-width: 280px;
            transition: all 0.2s;
        }

        .mahjong-filter-select:focus {
            border-color: var(--gold);
            box-shadow: 0 0 0 0.2rem rgba(212, 165, 83, 0.25);
        }

        .filter-label-mini {
            font-size: 0.7rem;
            color: #6c757d;
            font-weight: 600;
        }

        .leave-request-card {
            background: #f8d7da;
            border: 1px solid #dc3545;
        }

        .request-actions {
            display: flex;
            gap: 10px;
        }

        .btn-approve {
            background: var(--deep-green);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
        }

        .btn-reject {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .admin-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn-danger-outline {
            background: transparent;
            color: #dc3545;
            border: 2px solid #dc3545;
            padding: 10px 20px;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .btn-danger-outline:hover {
            background: #dc3545;
            color: white;
        }

        .btn-warning-outline {
            background: transparent;
            color: #ffc107;
            border: 2px solid #ffc107;
            padding: 10px 20px;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .btn-warning-outline:hover {
            background: #ffc107;
            color: #333;
        }

        .member-select {
            cursor: pointer;
            transition: all 0.2s;
        }

        .member-select:hover {
            background: #e9ecef;
        }

        .member-select.selected {
            background: rgba(45, 138, 94, 0.1);
            border: 2px solid var(--deep-green);
        }
    </style>
</head>

<body>
    <!-- å³ä¸Šã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
    <div class="nav-dropdown dropdown" style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
        <button class="btn dropdown-toggle" type="button" id="navDropdown" data-bs-toggle="dropdown"
            aria-expanded="false"
            style="background: linear-gradient(135deg, var(--gold) 0%, #b8892d 100%); color: white; padding: 12px 24px; border-radius: 25px; font-weight: bold;">
            ğŸ“ ãƒ¡ãƒ‹ãƒ¥ãƒ¼
        </button>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navDropdown">
            <li><a class="dropdown-item" href="../../index.html">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a></li>
            <li><a class="dropdown-item" href="../../mypage/index.html">ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</a></li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="../index.html">ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a></li>
            <li><a class="dropdown-item" href="../record.html">ğŸ“ è¨˜éŒ²ã™ã‚‹</a></li>
            <li><a class="dropdown-item" href="../users/index.html">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a></li>
            <li><a class="dropdown-item" href="./index.html">ğŸ… ãƒãƒ¼ãƒ ç®¡ç†</a></li>
            <li><a class="dropdown-item" href="../../badge/list.html">ğŸ“› ãƒãƒƒã‚¸ä¸€è¦§</a></li>
            <li><a class="dropdown-item" href="../../badge/shop.html">ğŸ›’ ãƒãƒƒã‚¸ã‚·ãƒ§ãƒƒãƒ—</a></li>
            <li><a class="dropdown-item" href="../../ranking/index.html">ğŸ’° è³‡ç”£ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a></li>
            <li class="admin-only" style="display:none;"><a class="dropdown-item" href="../../omikuji/index.html">ğŸ‹
                    ãŠã¿ãã˜</a></li>
            <li class="admin-only" style="display:none;">
                <hr class="dropdown-divider">
            </li>
            <li class="admin-only" style="display:none;">
                <a class="dropdown-item" href="../../admin/index.html">âš™ï¸ ç®¡ç†ç”»é¢</a>
            </li>
        </ul>
    </div>

    <div class="container py-5 mt-4">
        <header class="text-center mb-4">
            <h1 class="page-header display-4 fw-bold">ğŸ… ãƒãƒ¼ãƒ ç®¡ç†</h1>
        </header>

        <div id="loading" class="content-card text-center py-5">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
        </div>

        <!-- æœªãƒ­ã‚°ã‚¤ãƒ³ -->
        <div id="not-logged-in" class="content-card" style="display: none;">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ”’</div>
                <h3>ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</h3>
                <p class="text-muted">ãƒãƒ¼ãƒ ç®¡ç†æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯Discordã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
                <button onclick="loginWithDiscord()" class="btn btn-success btn-lg">Discordã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>
        </div>

        <!-- æœªæ‰€å± -->
        <div id="no-team" class="content-card" style="display: none;">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ…</div>
                <h3>ãƒãƒ¼ãƒ ã«æ‰€å±ã—ã¦ã„ã¾ã›ã‚“</h3>
                <p class="text-muted">æ–°ã—ã„ãƒãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹ã‹ã€æ—¢å­˜ã®ãƒãƒ¼ãƒ ã«åŠ å…¥ç”³è«‹ã—ã¦ãã ã•ã„</p>
                <div class="d-flex gap-3 justify-content-center flex-wrap">
                    <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#createTeamModal">
                        â• ãƒãƒ¼ãƒ ã‚’ä½œæˆ
                    </button>
                    <button class="btn btn-outline-success btn-lg" data-bs-toggle="modal"
                        data-bs-target="#joinTeamModal">
                        ğŸ¤ ãƒãƒ¼ãƒ ã«åŠ å…¥
                    </button>
                </div>
            </div>
        </div>

        <!-- ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼è¡¨ç¤º -->
        <div id="team-content" style="display: none;">
            <div class="content-card">
                <h2 id="team-name-header" class="section-title">ğŸ… ãƒãƒ¼ãƒ å</h2>

                <!-- åŠ å…¥ç”³è«‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ -->
                <div id="join-requests-section" style="display: none;">
                    <h4 class="mb-3">ğŸ“¬ åŠ å…¥ç”³è«‹</h4>
                    <div id="join-requests-list"></div>
                </div>

                <!-- è„±é€€ç”³è«‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰ -->
                <div id="leave-requests-section" style="display: none;">
                    <h4 class="mb-3 mt-4">ğŸšª è„±é€€ç”³è«‹</h4>
                    <div id="leave-requests-list"></div>
                </div>

                <!-- ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ -->
                <h4 class="mb-3 mt-4">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</h4>
                <div id="members-list"></div>

                <!-- ãƒ¡ãƒ³ãƒãƒ¼ç”¨ãƒœã‚¿ãƒ³ -->
                <div id="member-actions" class="text-center mt-4" style="display: none;">
                    <button onclick="requestLeave()" class="btn-danger-outline">ğŸšª è„±é€€ç”³è«‹ã‚’é€ã‚‹</button>
                </div>

                <!-- è„±é€€ç”³è«‹ä¸­è¡¨ç¤º -->
                <div id="leave-pending" class="text-center mt-4" style="display: none;">
                    <div class="alert alert-warning">
                        <strong>â³ è„±é€€ç”³è«‹ä¸­</strong><br>
                        ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚
                    </div>
                </div>

                <!-- ç®¡ç†è€…ç”¨ãƒœã‚¿ãƒ³ -->
                <div id="admin-actions" class="admin-actions" style="display: none;">
                    <button class="btn-warning-outline" data-bs-toggle="modal" data-bs-target="#transferModal">
                        ğŸ‘‘ ãƒªãƒ¼ãƒ€ãƒ¼ã‚’è­²æ¸¡
                    </button>
                    <button class="btn-danger-outline" onclick="dissolveTeam()">
                        ğŸ’¥ ãƒãƒ¼ãƒ ã‚’è§£æ•£
                    </button>
                </div>
            </div>

            <!-- ãƒ¡ãƒ³ãƒãƒ¼ã‚¹ã‚³ã‚¢ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
            <div class="content-card mt-4">
                <h3 class="section-title">ğŸ† ãƒ¡ãƒ³ãƒãƒ¼ã‚¹ã‚³ã‚¢ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                <div id="member-scores" class="mb-2">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        èª­ã¿è¾¼ã¿ä¸­...
                    </div>
                </div>
            </div>

            <!-- ãƒãƒ¼ãƒ æˆ¦ç¸¾ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="content-card mt-4">
                <h3 class="section-title">ğŸ“Š ãƒãƒ¼ãƒ æˆ¦ç¸¾</h3>

                <!-- ãƒãƒ¼ãƒ çµ±è¨ˆ -->
                <h4 class="mb-3">ğŸ§® ãƒãƒ¼ãƒ çµ±è¨ˆ</h4>
                <div class="team-log-filters mb-3">
                    <div class="mahjong-filter-group">
                        <label class="filter-label-mini">ğŸ‘¤ ãƒ¡ãƒ³ãƒãƒ¼</label>
                        <div class="custom-dropdown-container">
                            <input type="hidden" id="team-stats-member-filter" value="all">
                            <div class="mahjong-filter-select d-flex align-items-center justify-content-between"
                                style="cursor: pointer;" onclick="toggleTeamStatsMemberDropdown()">
                                <div class="d-flex align-items-center gap-2" id="team-stats-member-display" style="flex-grow: 1; overflow: hidden;">
                                    <span class="text-muted small">ãƒãƒ¼ãƒ å…¨ä½“</span>
                                </div>
                                <span class="small text-muted">â–¼</span>
                            </div>
                            <div class="custom-dropdown-list" id="team-stats-member-menu"></div>
                        </div>
                    </div>
                    <div class="mahjong-filter-group">
                        <label class="filter-label-mini">ğŸ€„ è©¦åˆå½¢å¼</label>
                        <select id="team-stats-mode-filter" class="mahjong-filter-select">
                            <option value="all">ã™ã¹ã¦</option>
                            <option value="å››éº»">å››éº»</option>
                            <option value="ä¸‰éº»">ä¸‰éº»</option>
                        </select>
                    </div>
                </div>
                <div id="team-stats-grid" class="row g-3 mb-4">
                    <div class="col-12 col-md-4">
                        <div class="stat-card-mini clickable" data-rank-key="total" onclick="redirectToTeamRanking('all')">
                            <div class="stat-label-mini">åˆè¨ˆã‚¹ã‚³ã‚¢</div>
                            <div class="stat-value-mini" id="team-stat-total">-</div>
                            <div class="stat-rank" id="team-rank-total">-</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="stat-card-mini clickable" data-rank-key="avgScore" onclick="redirectToTeamRanking('avg_score')">
                            <div class="stat-label-mini">å¹³å‡ã‚¹ã‚³ã‚¢</div>
                            <div class="stat-value-mini" id="team-stat-avg">-</div>
                            <div class="stat-rank" id="team-rank-avg">-</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="stat-card-mini clickable" data-rank-key="maxScore" onclick="redirectToTeamRanking('max_score')">
                            <div class="stat-label-mini">æœ€å¤§ã‚¹ã‚³ã‚¢</div>
                            <div class="stat-value-mini" id="team-stat-max">-</div>
                            <div class="stat-rank" id="team-rank-max">-</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="stat-card-mini clickable" data-rank-key="winRate" onclick="redirectToTeamRanking('win')">
                            <div class="stat-label-mini">å’Œäº†ç‡</div>
                            <div class="stat-value-mini" id="team-stat-win">-</div>
                            <div class="stat-rank" id="team-rank-win">-</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="stat-card-mini clickable" data-rank-key="dealRate" onclick="redirectToTeamRanking('deal')">
                            <div class="stat-label-mini">æ”¾éŠƒç‡</div>
                            <div class="stat-value-mini" id="team-stat-deal">-</div>
                            <div class="stat-rank" id="team-rank-deal">-</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="stat-card-mini clickable" data-rank-key="skill" onclick="redirectToTeamRanking('skill')">
                            <div class="stat-label-mini">ãƒãƒ©ãƒ³ã‚¹é›€åŠ›</div>
                            <div class="stat-value-mini" id="team-stat-skill">-</div>
                            <div class="stat-rank" id="team-rank-skill">-</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="stat-card-mini clickable" data-rank-key="avgRank" onclick="redirectToTeamRanking('avg_rank')">
                            <div class="stat-label-mini">å¹³å‡é †ä½</div>
                            <div class="stat-value-mini" id="team-stat-avg-rank">-</div>
                            <div class="stat-rank" id="team-rank-avg-rank">-</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="stat-card-mini clickable" data-rank-key="topRate" onclick="redirectToTeamRanking('top')">
                            <div class="stat-label-mini">ãƒˆãƒƒãƒ—ç‡</div>
                            <div class="stat-value-mini" id="team-stat-top">-</div>
                            <div class="stat-rank" id="team-rank-top">-</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="stat-card-mini clickable" data-rank-key="avoidRate" onclick="redirectToTeamRanking('avoid')">
                            <div class="stat-label-mini">ãƒ©ã‚¹å›é¿</div>
                            <div class="stat-value-mini" id="team-stat-avoid">-</div>
                            <div class="stat-rank" id="team-rank-avoid">-</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="stat-card-mini clickable" data-rank-key="games" onclick="redirectToTeamRanking('match_count')">
                            <div class="stat-label-mini">è©¦åˆæ•°</div>
                            <div class="stat-value-mini" id="team-stat-count">-</div>
                            <div class="stat-rank" id="team-rank-count">-</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="stat-card-mini" data-rank-key="hands" style="cursor: default;">
                            <div class="stat-label-mini">å±€æ•°</div>
                            <div class="stat-value-mini" id="team-stat-hands">-</div>
                            <div class="stat-rank" id="team-rank-hands">-</div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="stat-card-mini" data-rank-key="rating" style="cursor: default;">
                            <div class="stat-label-mini">ğŸ“Š ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</div>
                            <div class="stat-value-mini" id="team-stat-rating">-</div>
                            <div class="stat-rank no-data" id="team-rank-rating">-</div>
                        </div>
                    </div>
                </div>

                <!-- å¯¾æˆ¦ç›¸æ€§ -->
                <h4 class="mb-3">âš”ï¸ å¯¾æˆ¦ç›¸æ€§</h4>
                <div id="team-matchup-list" class="matchup-grid mb-4">
                    <div class="text-muted small">-</div>
                </div>

                <!-- æœ€è¿‘ã®å¯¾å±€ãƒ­ã‚° -->
                <h4 class="mb-3 mt-4">ğŸ“ æœ€è¿‘ã®ãƒãƒ¼ãƒ æˆ¦</h4>
                <!-- ãƒãƒ¼ãƒ çµ±è¨ˆã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å…±ç”¨ -->
                <div id="team-battle-log">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        èª­ã¿è¾¼ã¿ä¸­...
                    </div>
                </div>
                <div id="team-log-pagination" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- ãƒªãƒ¼ãƒ€ãƒ¼è­²æ¸¡ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="transferModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--deep-green); color: white;">
                    <h5 class="modal-title">ğŸ‘‘ ãƒªãƒ¼ãƒ€ãƒ¼ã‚’è­²æ¸¡</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">æ–°ã—ã„ãƒªãƒ¼ãƒ€ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                    <div id="transfer-member-list"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-success" id="confirmTransferBtn" onclick="confirmTransfer()"
                        disabled>è­²æ¸¡ã™ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="createTeamModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--deep-green); color: white;">
                    <h5 class="modal-title">â• ãƒãƒ¼ãƒ ã‚’ä½œæˆ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newTeamName" class="form-label">ãƒãƒ¼ãƒ å</label>
                        <input type="text" class="form-control" id="newTeamName" placeholder="ãƒãƒ¼ãƒ åã‚’å…¥åŠ›">
                    </div>
                    <div id="create-team-error" class="text-danger" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-success" onclick="createTeam()">ä½œæˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒãƒ¼ãƒ åŠ å…¥ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="joinTeamModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--deep-green); color: white;">
                    <h5 class="modal-title">ğŸ¤ ãƒãƒ¼ãƒ ã«åŠ å…¥</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">åŠ å…¥ã—ãŸã„ãƒãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                    <div id="team-list-for-join">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            èª­ã¿è¾¼ã¿ä¸­...
                        </div>
                    </div>
                    <div id="join-team-error" class="text-danger mt-2" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-success" id="sendJoinRequestBtn" onclick="sendJoinRequest()"
                        disabled>åŠ å…¥ç”³è«‹ã‚’é€ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../js/supabase-config.js"></script>
    <script src="../../js/auth-guard.js"></script>
    <script src="../../js/navigation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            initAccordionNav('../../');
        });
    </script>


    <script>
        let currentUser = null;
        let myProfile = null;
        let myTeam = null;
        let isTeamAdmin = false;
        let teamMembers = [];
        let teamLogPage = 1;
        const TEAM_LOG_PER_PAGE = 10;
        let teamLogMatches = [];
        let teamLogPlayers = [];
        let teamLogoMap = {};
        let teamStatsRecords = [];
        let selectedNewLeader = null;
        let effectiveDiscordId = null; // ãªã‚Šã™ã¾ã—ä¸­ã¯ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€é€šå¸¸ã¯è‡ªåˆ†ã®ID

        document.addEventListener('DOMContentLoaded', initTeamPage);

        async function initTeamPage() {
            currentUser = await getCurrentUser();

            if (!currentUser) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('not-logged-in').style.display = 'block';
                return;
            }

            // ãªã‚Šã™ã¾ã—ä¸­ãªã‚‰ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€ãã†ã§ãªã‘ã‚Œã°è‡ªåˆ†ã®ID
            const impersonated = getImpersonatedUser();
            effectiveDiscordId = impersonated
                ? impersonated.discord_user_id
                : currentUser.user_metadata.provider_id;

            // å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('discord_user_id', effectiveDiscordId)
                .maybeSingle();

            myProfile = profile;

            if (!profile || !profile.team_id) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('no-team').style.display = 'block';
                return;
            }

            // ãƒãƒ¼ãƒ æƒ…å ±å–å¾—
            const { data: team } = await supabaseClient
                .from('teams')
                .select('*, logo_badge:badges!logo_badge_id(image_url)')
                .eq('id', profile.team_id)
                .single();

            myTeam = team;
            isTeamAdmin = team.creator_discord_id === effectiveDiscordId;

            const { data: teamsData } = await supabaseClient
                .from('teams')
                .select('team_name, logo_badge:badges!logo_badge_id(image_url)');
            teamLogoMap = {};
            (teamsData || []).forEach(t => {
                if (t.team_name && t.logo_badge?.image_url) {
                    teamLogoMap[t.team_name] = t.logo_badge.image_url;
                }
            });

            await renderTeamContent();

            document.getElementById('loading').style.display = 'none';
            document.getElementById('team-content').style.display = 'block';
        }

        async function renderTeamContent() {
            const logoUrl = (myTeam.logo_badge && myTeam.logo_badge.image_url) ? myTeam.logo_badge.image_url : null;
            const logoHtml = logoUrl
                ? `<img src="${logoUrl}" style="width: 32px; height: 32px; object-fit: contain; margin-right: 8px;">`
                : 'ğŸ… ';

            const headerEl = document.getElementById('team-name-header');
            headerEl.innerHTML = ``; // Clear first
            headerEl.insertAdjacentHTML('beforeend', logoHtml);
            headerEl.insertAdjacentText('beforeend', myTeam.team_name);

            // ç®¡ç†è€…ã®å ´åˆ
            if (isTeamAdmin) {
                document.getElementById('join-requests-section').style.display = 'block';
                document.getElementById('leave-requests-section').style.display = 'block';
                document.getElementById('admin-actions').style.display = 'flex';
                await loadJoinRequests();
                await loadLeaveRequests();
            } else {
                // ãƒ¡ãƒ³ãƒãƒ¼ã®å ´åˆ - è„±é€€ç”³è«‹ãƒœã‚¿ãƒ³ã¾ãŸã¯ç”³è«‹ä¸­è¡¨ç¤º
                await checkMyLeaveRequest();
            }

            // ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§å–å¾—ï¼ˆãƒãƒƒã‚¸æƒ…å ±å«ã‚€ï¼‰
            const { data: members } = await supabaseClient
                .from('profiles')
                .select('*, badges!equipped_badge_id(id, image_url, name), badges_right:badges!equipped_badge_id_right(id, image_url, name)')
                .eq('team_id', myTeam.id)
                .order('account_name');

            // ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—
            const { data: userBadges } = await supabaseClient
                .from('user_badges_new')
                .select('user_id, badge_id')
                .eq('is_mutant', true);

            const userMutantMap = {};
            (userBadges || []).forEach(ub => {
                userMutantMap[`${ub.user_id}_${ub.badge_id}`] = true;
            });

            teamMembers = members || [];

            const membersList = document.getElementById('members-list');
            if (!members || members.length === 0) {
                membersList.innerHTML = '<p class="text-muted">ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</p>';
                return;
            }

            membersList.innerHTML = members.map(member => {
                const isAdmin = member.discord_user_id === myTeam.creator_discord_id;
                const avatarUrl = member.avatar_url || 'https://via.placeholder.com/48';
                const name = member.account_name || 'åç§°æœªè¨­å®š';
                const badge = member.badges;
                const badgeRight = member.badges_right;
                let badgeHtmlLeft = '';
                let badgeHtmlRight = '';

                if (badge) {
                    const isMutant = userMutantMap[`${member.discord_user_id}_${badge.id}`];
                    badgeHtmlLeft = `
                        <div class="mutant-badge-container mini ${isMutant ? 'active' : ''}" style="margin-right: 8px;">
                            <img src="${badge.image_url}" title="${badge.name}" 
                                 style="width: 32px; height: 32px; object-fit: contain; border-radius: 4px;">
                            <div class="mutant-badge-shine" style="display: ${isMutant ? 'block' : 'none'};"></div>
                        </div>`;
                }

                if (badgeRight) {
                    const isMutant = userMutantMap[`${member.discord_user_id}_${badgeRight.id}`];
                    badgeHtmlRight = `
                        <div class="mutant-badge-container mini ${isMutant ? 'active' : ''}" style="margin-left: 8px;">
                            <img src="${badgeRight.image_url}" title="${badgeRight.name}" 
                                 style="width: 32px; height: 32px; object-fit: contain; border-radius: 4px;">
                            <div class="mutant-badge-shine" style="display: ${isMutant ? 'block' : 'none'};"></div>
                        </div>`;
                }

                const kickButton = (!isAdmin && isTeamAdmin)
                    ? `<button class="btn btn-outline-danger btn-sm ms-2" onclick="requestKick('${member.discord_user_id}', '${name.replace(/'/g, "\\'")}')">è¿½æ”¾</button>`
                    : '';

                return `
                    <div class="member-card">
                        <a href="../../mypage/index.html?user=${member.discord_user_id}" class="d-flex align-items-center text-decoration-none text-dark flex-grow-1">
                            <img src="${avatarUrl}" alt="${name}" class="member-avatar" onerror="this.src='https://via.placeholder.com/48'">
                            ${badgeHtmlLeft}
                            <span class="member-name hover-underline">${name}</span>
                            ${badgeHtmlRight}
                        </a>
                        ${isAdmin ? '<span class="member-role">ğŸ‘‘ ãƒªãƒ¼ãƒ€ãƒ¼</span>' : ''}
                        ${kickButton}
                    </div>
                `;
            }).join('');

            // è­²æ¸¡ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆä½œæˆ
            renderTransferList();

            // ãƒãƒ¼ãƒ æˆ¦ç¸¾ã‚’èª­ã¿è¾¼ã‚€
            await loadTeamStats();
        }

        function renderTransferList() {
            const container = document.getElementById('transfer-member-list');
            const otherMembers = teamMembers.filter(m => m.discord_user_id !== myTeam.creator_discord_id);

            if (otherMembers.length === 0) {
                container.innerHTML = '<p class="text-muted">ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</p>';
                return;
            }

            container.innerHTML = otherMembers.map(member => {
                const avatarUrl = member.avatar_url || 'https://via.placeholder.com/48';
                const name = member.account_name || 'åç§°æœªè¨­å®š';
                return `
                    <div class="member-card member-select" onclick="selectNewLeader('${member.discord_user_id}', this)">
                        <img src="${avatarUrl}" alt="${name}" class="member-avatar" onerror="this.src='https://via.placeholder.com/48'">
                        <span class="member-name">${name}</span>
                    </div>
                `;
            }).join('');
        }

        function selectNewLeader(discordId, element) {
            document.querySelectorAll('.member-select').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedNewLeader = discordId;
            document.getElementById('confirmTransferBtn').disabled = false;
        }

        async function confirmTransfer() {
            if (!selectedNewLeader || !confirm('æœ¬å½“ã«ãƒªãƒ¼ãƒ€ãƒ¼ã‚’è­²æ¸¡ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                await supabaseClient
                    .from('teams')
                    .update({ creator_discord_id: selectedNewLeader })
                    .eq('id', myTeam.id);

                alert('ãƒªãƒ¼ãƒ€ãƒ¼ã‚’è­²æ¸¡ã—ã¾ã—ãŸï¼');
                location.reload();
            } catch (err) {
                console.error('è­²æ¸¡ã‚¨ãƒ©ãƒ¼:', err);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        async function loadJoinRequests() {
            const { data: requests } = await supabaseClient
                .from('team_join_requests')
                .select('*')
                .eq('team_id', myTeam.id)
                .eq('status', 'pending');

            const container = document.getElementById('join-requests-list');

            if (!requests || requests.length === 0) {
                container.innerHTML = '<p class="text-muted">æ–°ã—ã„åŠ å…¥ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            const requesterIds = requests.map(r => r.requester_discord_id);
            const { data: profiles } = await supabaseClient
                .from('profiles')
                .select('*')
                .in('discord_user_id', requesterIds);

            const profileMap = {};
            profiles?.forEach(p => profileMap[p.discord_user_id] = p);

            container.innerHTML = requests.map(req => {
                const profile = profileMap[req.requester_discord_id] || {};
                const avatarUrl = profile.avatar_url || 'https://via.placeholder.com/48';
                const name = profile.account_name || 'åç§°æœªè¨­å®š';

                return `
                    <div class="request-card" id="join-request-${req.id}">
                        <img src="${avatarUrl}" alt="${name}" class="member-avatar" onerror="this.src='https://via.placeholder.com/48'">
                        <span class="member-name">${name}</span>
                        <div class="request-actions">
                            <button class="btn-approve" onclick="approveJoin('${req.id}', '${req.requester_discord_id}')">âœ“ è¨±å¯</button>
                            <button class="btn-reject" onclick="rejectJoin('${req.id}')">âœ— æ‹’å¦</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadLeaveRequests() {
            const { data: requests } = await supabaseClient
                .from('team_join_requests')
                .select('*')
                .eq('team_id', myTeam.id)
                .eq('status', 'leave_pending');

            const container = document.getElementById('leave-requests-list');

            if (!requests || requests.length === 0) {
                container.innerHTML = '<p class="text-muted">è„±é€€ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            const requesterIds = requests.map(r => r.requester_discord_id);
            const { data: profiles } = await supabaseClient
                .from('profiles')
                .select('*')
                .in('discord_user_id', requesterIds);

            const profileMap = {};
            profiles?.forEach(p => profileMap[p.discord_user_id] = p);

            container.innerHTML = requests.map(req => {
                const profile = profileMap[req.requester_discord_id] || {};
                const avatarUrl = profile.avatar_url || 'https://via.placeholder.com/48';
                const name = profile.account_name || 'åç§°æœªè¨­å®š';

                return `
                    <div class="request-card leave-request-card" id="leave-request-${req.id}">
                        <img src="${avatarUrl}" alt="${name}" class="member-avatar" onerror="this.src='https://via.placeholder.com/48'">
                        <span class="member-name">${name}</span>
                        <div class="request-actions">
                            <button class="btn-approve" onclick="approveLeave('${req.id}', '${req.requester_discord_id}')">âœ“ è¨±å¯</button>
                            <button class="btn-reject" onclick="rejectLeave('${req.id}')">âœ— æ‹’å¦</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function checkMyLeaveRequest() {
            const discordId = effectiveDiscordId;
            const { data: pending } = await supabaseClient
                .from('team_join_requests')
                .select('*')
                .eq('team_id', myTeam.id)
                .eq('requester_discord_id', discordId)
                .eq('status', 'leave_pending')
                .maybeSingle();

            if (pending) {
                document.getElementById('leave-pending').style.display = 'block';
            } else {
                document.getElementById('member-actions').style.display = 'block';
            }
        }

        async function requestLeave() {
            if (!confirm('ãƒãƒ¼ãƒ ã‹ã‚‰ã®è„±é€€ã‚’ç”³è«‹ã—ã¾ã™ã‹ï¼Ÿãƒªãƒ¼ãƒ€ãƒ¼ã®æ‰¿èªãŒå¿…è¦ã§ã™ã€‚')) return;

            const discordId = effectiveDiscordId;

            try {
                await supabaseClient
                    .from('team_join_requests')
                    .insert({
                        team_id: myTeam.id,
                        requester_discord_id: discordId,
                        status: 'leave_pending'
                    });

                alert('è„±é€€ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒªãƒ¼ãƒ€ãƒ¼ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚');
                location.reload();
            } catch (err) {
                console.error('è„±é€€ç”³è«‹ã‚¨ãƒ©ãƒ¼:', err);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        async function approveJoin(requestId, requesterDiscordId) {
            try {
                await supabaseClient
                    .from('team_join_requests')
                    .update({ status: 'approved' })
                    .eq('id', requestId);

                await supabaseClient
                    .from('profiles')
                    .update({ team_id: myTeam.id })
                    .eq('discord_user_id', requesterDiscordId);

                alert('åŠ å…¥ã‚’è¨±å¯ã—ã¾ã—ãŸï¼');
                location.reload();
            } catch (err) {
                console.error('æ‰¿èªã‚¨ãƒ©ãƒ¼:', err);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        async function rejectJoin(requestId) {
            if (!confirm('ã“ã®ç”³è«‹ã‚’æ‹’å¦ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                await supabaseClient
                    .from('team_join_requests')
                    .update({ status: 'rejected' })
                    .eq('id', requestId);

                document.getElementById(`join-request-${requestId}`).remove();
            } catch (err) {
                console.error('æ‹’å¦ã‚¨ãƒ©ãƒ¼:', err);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        async function approveLeave(requestId, requesterDiscordId) {
            try {
                await supabaseClient
                    .from('team_join_requests')
                    .update({ status: 'left' })
                    .eq('id', requestId);

                await supabaseClient
                    .from('profiles')
                    .update({ team_id: null })
                    .eq('discord_user_id', requesterDiscordId);

                alert('è„±é€€ã‚’è¨±å¯ã—ã¾ã—ãŸ');
                location.reload();
            } catch (err) {
                console.error('è„±é€€æ‰¿èªã‚¨ãƒ©ãƒ¼:', err);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        async function rejectLeave(requestId) {
            if (!confirm('ã“ã®è„±é€€ç”³è«‹ã‚’æ‹’å¦ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                await supabaseClient
                    .from('team_join_requests')
                    .update({ status: 'leave_rejected' })
                    .eq('id', requestId);

                document.getElementById(`leave-request-${requestId}`).remove();
            } catch (err) {
                console.error('æ‹’å¦ã‚¨ãƒ©ãƒ¼:', err);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        async function dissolveTeam() {
            if (!confirm('ãƒãƒ¼ãƒ ã®è§£æ•£ã‚’ã‚µã‚¤ãƒˆç®¡ç†è€…ã«ç”³è«‹ã—ã¾ã™ã‹ï¼Ÿ')) return;

            try {
                // å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’ä½¿ç”¨
                const accountName = myProfile?.account_name || 'ä¸æ˜';

                await supabaseClient
                    .from('team_admin_requests')
                    .insert({
                        type: 'dissolution',
                        team_id: myTeam.id,
                        team_name: myTeam.team_name,
                        requester_discord_id: effectiveDiscordId,
                        requester_name: accountName,
                        status: 'pending'
                    });

                alert('è§£æ•£ç”³è«‹ã‚’ã‚µã‚¤ãƒˆç®¡ç†è€…ã«é€ä¿¡ã—ã¾ã—ãŸã€‚æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚');
            } catch (err) {
                console.error('è§£æ•£ç”³è«‹ã‚¨ãƒ©ãƒ¼:', err);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ãƒãƒ¼ãƒ æˆ¦ç¸¾ã‚’èª­ã¿è¾¼ã‚€
        async function loadTeamStats() {
            const memberIds = teamMembers.map(m => m.discord_user_id).filter(id => id);

            // ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ãªã„å ´åˆã¯çµ‚äº†
            if (memberIds.length === 0) {
                document.getElementById('member-scores').innerHTML = '<p class="text-muted">ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</p>';
                document.getElementById('team-battle-log').innerHTML = '<p class="text-muted">ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</p>';
                return;
            }

            // ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã®å¯¾å±€çµæœã‚’å–å¾—
            const { data: results, error } = await supabaseClient
                .from('match_results')
                .select('*')
                .in('discord_user_id', memberIds)
                .eq('match_mode', 'ãƒãƒ¼ãƒ æˆ¦')
                .order('event_datetime', { ascending: false });

            console.log('Team stats query result:', results, error);

            if (error || !results || results.length === 0) {
                document.getElementById('member-scores').innerHTML = '<p class="text-muted">ã¾ã å¯¾å±€è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                document.getElementById('team-battle-log').innerHTML = '<p class="text-muted">ã¾ã å¯¾å±€è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            // ãƒãƒ¼ãƒ çµ±è¨ˆ
            teamStatsRecords = results || [];
            setupTeamStatsFilter();
            applyTeamStatsFilter();
            await renderTeamRanks();

            // ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ã«ã‚¹ã‚³ã‚¢ã‚’é›†è¨ˆ
            const memberScores = {};
            teamMembers.forEach(m => {
                memberScores[m.discord_user_id] = {
                    name: m.account_name || 'åç§°æœªè¨­å®š',
                    avatar: m.avatar_url || 'https://via.placeholder.com/32',
                    totalScore: 0,
                    games: 0,
                    yonmaCount: 0,
                    sanmaCount: 0,
                    recentScore: 0
                };
            });

            const nowTs = Date.now();
            const isRecent = (r) => {
                if (!r.event_datetime) return false;
                const ts = new Date(r.event_datetime).getTime();
                if (Number.isNaN(ts)) return false;
                return (nowTs - ts) < (24 * 60 * 60 * 1000);
            };

            results.forEach(r => {
                if (memberScores[r.discord_user_id]) {
                    const score = Number(r.final_score || r.score || 0);
                    memberScores[r.discord_user_id].totalScore += score;
                    memberScores[r.discord_user_id].games += 1;
                    if (r.mahjong_mode === 'ä¸‰éº»') memberScores[r.discord_user_id].sanmaCount += 1;
                    if (r.mahjong_mode === 'å››éº»') memberScores[r.discord_user_id].yonmaCount += 1;
                    if (!isRecent(r)) {
                        memberScores[r.discord_user_id].recentScore += score;
                    }
                }
            });

            // ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆ
            const sortedMembers = Object.values(memberScores)
                .filter(m => m.games > 0)
                .map(m => ({
                    ...m,
                    deltaScore: m.totalScore - m.recentScore
                }))
                .sort((a, b) => b.totalScore - a.totalScore);

            // ãƒ¡ãƒ³ãƒãƒ¼ã‚¹ã‚³ã‚¢ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
            const scoresContainer = document.getElementById('member-scores');
            if (sortedMembers.length === 0) {
                scoresContainer.innerHTML = '<p class="text-muted">ã¾ã å¯¾å±€è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            } else {
            scoresContainer.innerHTML = `
                    <table class="table table-hover member-score-table">
                        <thead>
                            <tr>
                                <th>é †ä½</th>
                                <th>ãƒ¡ãƒ³ãƒãƒ¼</th>
                                <th>åˆè¨ˆã‚¹ã‚³ã‚¢</th>
                                <th>24æ™‚é–“æ¯”</th>
                                <th>è©¦åˆæ•°</th>
                                <th>å››éº»å›æ•°</th>
                                <th>ä¸‰éº»å›æ•°</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedMembers.map((m, i) => `
                                <tr class="${i < 3 ? `rank-${i + 1}` : ''}">
                                    <td data-label="é †ä½"><span class="rank-badge-mini">${i + 1}</span></td>
                                    <td data-label="ãƒ¡ãƒ³ãƒãƒ¼">
                                        <div class="member-score-header">
                                            <span class="rank-badge-inline">é †ä½${i + 1}</span>
                                            <img src="${m.avatar}" class="rounded-circle" width="24" height="24" onerror="this.src='https://via.placeholder.com/24'">
                                            <span class="member-name">${m.name}</span>
                                        </div>
                                        <div class="member-score-mobile-stats">
                                            <div class="member-score-mobile-row">
                                                <span>åˆè¨ˆã‚¹ã‚³ã‚¢ ${m.totalScore >= 0 ? '+' : ''}${m.totalScore.toLocaleString()}</span>
                                                <span class="${m.deltaScore === 0 ? 'text-muted' : (m.deltaScore > 0 ? 'text-success' : 'text-danger')}">24æ™‚é–“æ¯” ${m.deltaScore === 0 ? 'â€•' : (m.deltaScore > 0 ? '+' : '') + m.deltaScore.toFixed(1)}</span>
                                            </div>
                                            <div class="member-score-mobile-row">
                                                <span>è©¦åˆæ•° ${m.games}</span>
                                                <span>å››éº» ${m.yonmaCount}</span>
                                                <span>ä¸‰éº» ${m.sanmaCount}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td data-label="åˆè¨ˆã‚¹ã‚³ã‚¢" class="${m.totalScore >= 0 ? 'text-success' : 'text-danger'}">${m.totalScore >= 0 ? '+' : ''}${m.totalScore.toLocaleString()}</td>
                                    <td data-label="24æ™‚é–“æ¯”" class="${m.deltaScore === 0 ? 'text-muted' : (m.deltaScore > 0 ? 'text-success' : 'text-danger')}">${m.deltaScore === 0 ? 'â€•' : (m.deltaScore > 0 ? '+' : '') + m.deltaScore.toFixed(1)}</td>
                                    <td data-label="è©¦åˆæ•°">${m.games}</td>
                                    <td data-label="å››éº»å›æ•°">${m.yonmaCount}</td>
                                    <td data-label="ä¸‰éº»å›æ•°">${m.sanmaCount}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            // æœ€è¿‘ã®å¯¾å±€ãƒ­ã‚°ç”¨ã«match_idã‚’å–å¾—
            const matchIds = [...new Set(results.map(r => r.match_id))];

            let allMatchPlayers = [];
            let participantProfiles = [];
            if (matchIds.length > 0) {
                const { data: participants } = await supabaseClient
                    .from('match_results')
                    .select('*')
                    .in('match_id', matchIds)
                    .eq('match_mode', 'ãƒãƒ¼ãƒ æˆ¦') // ã“ã“ã§ã‚‚å¿µã®ãŸã‚ãƒãƒ¼ãƒ æˆ¦ã«çµã‚‹
                    .order('event_datetime', { ascending: false });
                allMatchPlayers = participants || [];

                // å…¨å‚åŠ è€…ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆã‚¢ãƒã‚¿ãƒ¼ç”¨ï¼‰ã‚’å–å¾—
                const participantIds = [...new Set(allMatchPlayers.map(p => p.discord_user_id).filter(id => id))];
                if (participantIds.length > 0) {
                    const { data: profiles } = await supabaseClient
                        .from('profiles')
                        .select('discord_user_id, avatar_url')
                        .in('discord_user_id', participantIds);
                    participantProfiles = profiles || [];
                }
            }

            const profileMap = {};
            participantProfiles.forEach(p => profileMap[p.discord_user_id] = p.avatar_url);

            const logContainer = document.getElementById('team-battle-log');
            if (matchIds.length === 0) {
                logContainer.innerHTML = '<p class="text-muted">ã¾ã å¯¾æˆ¦è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            teamLogPlayers = allMatchPlayers || [];
            teamLogMatches = buildTeamLogMatches(teamLogPlayers, memberIds, profileMap);
            applyTeamLogFilters(...Object.values(getCurrentTeamFilters()));

            // å¯¾æˆ¦ç›¸æ€§
            const matchupList = calculateTeamMatchupFiltered(teamLogPlayers, myTeam?.team_name || '', ...Object.values(getCurrentTeamFilters()));
            renderTeamMatchups(matchupList);
        }

        function calculateTeamAggregate(records) {
            const agg = { score: 0, count: 0, win: 0, deal: 0, r1: 0, r2: 0, r3: 0, r4: 0, max_score: -Infinity, hand_total: 0 };
            records.forEach(r => {
                if (r.tournament_type === 'ç¬¬ä¸€å›éº»é›€å¤§ä¼š') {
                    agg.score += Number(r.score_total || 0);
                    agg.count += Number(r.matches_played || 0);
                    agg.r1 += Number(r.rank1_count || 0);
                    agg.r2 += Number(r.rank2_count || 0);
                    agg.r3 += Number(r.rank3_count || 0);
                    agg.r4 += Number(r.rank4_count || 0);
                    agg.max_score = Math.max(agg.max_score, Number(r.score_max || 0));
                    agg.hand_total += Number(r.hands_played || 0);
                } else {
                    agg.score += Number(r.final_score || 0);
                    agg.count += 1;
                    const rk = Number(r.rank);
                    if (rk === 1) agg.r1++;
                    else if (rk === 2) agg.r2++;
                    else if (rk === 3) agg.r3++;
                    else if (rk === 4) agg.r4++;
                    agg.max_score = Math.max(agg.max_score, Number(r.final_score || 0));
                    agg.hand_total += Number(r.hand_count || 0);
                }
                agg.win += Number(r.win_count || r.wins || 0);
                agg.deal += Number(r.deal_in_count || r.deals || 0);
            });
            const count = agg.count || 0;
            const hands = agg.hand_total || 0;
            return {
                total: agg.score,
                avgScore: count > 0 ? agg.score / count : 0,
                maxScore: agg.max_score === -Infinity ? 0 : agg.max_score,
                winRate: hands > 0 ? (agg.win / hands * 100) : 0,
                dealRate: hands > 0 ? (agg.deal / hands * 100) : 0,
                skill: hands > 0 ? ((agg.win - agg.deal) / hands * 100) : 0,
                avgRank: count > 0 ? (1 * agg.r1 + 2 * agg.r2 + 3 * agg.r3 + 4 * agg.r4) / count : 0,
                topRate: count > 0 ? (agg.r1 / count) * 100 : 0,
                avoidRate: count > 0 ? (1 - ((agg.r4 === 0 && agg.r3 > 0 ? agg.r3 : agg.r4) / count)) * 100 : 0,
                games: count,
                hands: hands
            };
        }

        function renderTeamStats(stats) {
            const set = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.textContent = val;
            };
            set('team-stat-total', stats.total.toLocaleString());
            set('team-stat-avg', stats.avgScore.toFixed(1));
            set('team-stat-max', stats.maxScore.toLocaleString());
            set('team-stat-count', stats.games.toLocaleString());
            set('team-stat-win', stats.winRate.toFixed(1) + '%');
            set('team-stat-deal', stats.dealRate.toFixed(1) + '%');
            set('team-stat-skill', stats.skill.toFixed(1) + '%');
            set('team-stat-avg-rank', stats.avgRank.toFixed(2));
            set('team-stat-top', stats.topRate.toFixed(1) + '%');
            set('team-stat-avoid', stats.avoidRate.toFixed(1) + '%');
            set('team-stat-hands', stats.hands.toLocaleString());
            const ratingEl = document.getElementById('team-stat-rating');
            if (ratingEl) ratingEl.textContent = '-';
        }

        async function renderTeamRanks() {
            if (!myTeam?.team_name) return;
            try {
                const { data: allTeamRecords, error } = await supabaseClient
                    .from('match_results')
                    .select('*')
                    .eq('match_mode', 'ãƒãƒ¼ãƒ æˆ¦')
                    .not('team_name', 'is', null);
                if (error) throw error;

                const teamMap = {};
                (allTeamRecords || []).forEach(r => {
                    const key = r.team_name;
                    if (!teamMap[key]) teamMap[key] = [];
                    teamMap[key].push(r);
                });
                const teamStatsList = Object.entries(teamMap).map(([team, records]) => {
                    const stats = calculateTeamAggregate(records);
                    return { team, stats };
                });

                const rankOf = (key, higherIsBetter = true) => {
                    const sorted = teamStatsList
                        .filter(t => t.stats.games > 0)
                        .sort((a, b) => higherIsBetter ? (b.stats[key] - a.stats[key]) : (a.stats[key] - b.stats[key]));
                    const idx = sorted.findIndex(t => t.team === myTeam.team_name);
                    return idx >= 0 ? `${idx + 1}/${sorted.length}ä½` : '-';
                };

                const setRank = (id, value, key) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = value;
                        el.classList.toggle('no-data', value === '-');
                    }
                    if (key) {
                        const card = document.querySelector(`.stat-card-mini[data-rank-key="${key}"]`);
                        if (card) {
                            card.classList.remove('rank-1', 'rank-2', 'rank-3');
                            const rankNum = parseInt(String(value).split('/')[0], 10);
                            if (rankNum === 1 || rankNum === 2 || rankNum === 3) {
                                card.classList.add(`rank-${rankNum}`);
                            }
                        }
                    }
                };

                setRank('team-rank-total', rankOf('total', true), 'total');
                setRank('team-rank-avg', rankOf('avgScore', true), 'avgScore');
                setRank('team-rank-max', rankOf('maxScore', true), 'maxScore');
                setRank('team-rank-count', rankOf('games', true), 'games');
                setRank('team-rank-win', rankOf('winRate', true), 'winRate');
                setRank('team-rank-deal', rankOf('dealRate', false), 'dealRate');
                setRank('team-rank-skill', rankOf('skill', true), 'skill');
                setRank('team-rank-avg-rank', rankOf('avgRank', false), 'avgRank');
                setRank('team-rank-top', rankOf('topRate', true), 'topRate');
                setRank('team-rank-avoid', rankOf('avoidRate', true), 'avoidRate');
                setRank('team-rank-hands', rankOf('hands', true), 'hands');
                setRank('team-rank-rating', '-', 'rating');
            } catch (err) {
                console.error('ãƒãƒ¼ãƒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
            }
        }

        function setupTeamStatsFilter() {
            const menu = document.getElementById('team-stats-member-menu');
            if (!menu || menu.dataset.bound) return;
            menu.dataset.bound = 'true';
            const rows = ['<div class="dropdown-item-flex" onclick="selectTeamStatsMemberFilter(\'all\', \'ãƒãƒ¼ãƒ å…¨ä½“\')"><span class="small">ãƒãƒ¼ãƒ å…¨ä½“</span></div>'];
            teamMembers.forEach(m => {
                const avatar = m.avatar_url || 'https://cdn.discordapp.com/embed/avatars/0.png';
                const name = m.account_name || m.discord_user_id;
                rows.push(`
                    <div class="dropdown-item-flex" onclick="selectTeamStatsMemberFilter('${m.discord_user_id}', '${name}', '${avatar}')">
                        <img src="${avatar}" class="dropdown-avatar" onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'">
                        <span class="small">${name}</span>
                    </div>
                `);
            });
            menu.innerHTML = rows.join('');

            const modeSelect = document.getElementById('team-stats-mode-filter');
            if (modeSelect && !modeSelect.dataset.bound) {
                modeSelect.dataset.bound = 'true';
                modeSelect.addEventListener('change', () => applyTeamStatsFilter());
            }
        }

        function getCurrentTeamFilters() {
            const select = document.getElementById('team-stats-member-filter');
            const memberId = select ? select.value : 'all';
            const modeSelect = document.getElementById('team-stats-mode-filter');
            const mode = modeSelect ? modeSelect.value : 'all';
            return { memberId, mode };
        }

        function applyTeamStatsFilter() {
            const { memberId, mode } = getCurrentTeamFilters();
            let target = teamStatsRecords || [];
            if (memberId && memberId !== 'all') {
                target = target.filter(r => r.discord_user_id === memberId);
            }
            if (mode && mode !== 'all') {
                target = target.filter(r => (r.mahjong_mode || '') === mode);
            }
            const stats = calculateTeamAggregate(target);
            renderTeamStats(stats);

            const matchupList = calculateTeamMatchupFiltered(teamLogPlayers, myTeam?.team_name || '', memberId, mode);
            renderTeamMatchups(matchupList);

            teamLogPage = 1;
            applyTeamLogFilters(memberId, mode);
        }

        function calculateTeamMatchupFiltered(players, myTeamName, memberId, mode) {
            const matchMap = {};
            const memberMatchSet = new Set();

            players.forEach(p => {
                if (!p.match_id) return;
                if (mode && mode !== 'all' && (p.mahjong_mode || '') !== mode) return;
                if (memberId && memberId !== 'all' && p.discord_user_id === memberId) {
                    memberMatchSet.add(p.match_id);
                }
                if (!matchMap[p.match_id]) matchMap[p.match_id] = {};
                const team = p.team_name;
                if (!team) return;
                matchMap[p.match_id][team] = (matchMap[p.match_id][team] || 0) + Number(p.final_score || p.score || 0);
            });

            const diffMap = {};
            Object.entries(matchMap).forEach(([matchId, teams]) => {
                if (memberId && memberId !== 'all' && !memberMatchSet.has(matchId)) return;
                const myScore = teams[myTeamName];
                if (typeof myScore !== 'number') return;
                Object.entries(teams).forEach(([team, score]) => {
                    if (team === myTeamName) return;
                    const diff = myScore - score;
                    if (!diffMap[team]) diffMap[team] = { team, diff: 0 };
                    diffMap[team].diff += diff;
                });
            });
            return Object.values(diffMap).sort((a, b) => b.diff - a.diff);
        }

        function renderTeamMatchups(list) {
            const container = document.getElementById('team-matchup-list');
            if (!container) return;
            if (!list || list.length === 0) {
                container.innerHTML = '<div class="text-muted small">-</div>';
                return;
            }
            container.innerHTML = list.map(item => {
                const cls = item.diff > 0 ? 'text-success' : item.diff < 0 ? 'text-danger' : 'text-muted';
                const prefix = item.diff > 0 ? '+' : '';
                const logo = teamLogoMap[item.team] ? `<img src="${teamLogoMap[item.team]}" class="team-logo-mini" onerror="this.remove()">` : '';
                return `
                    <div class="matchup-card">
                        <span class="d-flex align-items-center gap-2 fw-bold">${logo}${item.team}</span>
                        <span class="${cls} fw-bold">${prefix}${item.diff.toFixed(1)}</span>
                    </div>
                `;
            }).join('');
        }

        function buildTeamLogMatches(players, memberIds, profileMap) {
            const matchesMap = {};
            players.forEach(p => {
                if (!matchesMap[p.match_id]) {
                    const ts = new Date(p.event_datetime || p.created_at).getTime();
                    matchesMap[p.match_id] = {
                        id: p.match_id,
                        ts: Number.isNaN(ts) ? 0 : ts,
                        date: new Date(p.event_datetime || p.created_at).toLocaleDateString('ja-JP'),
                        mode: p.mahjong_mode || 'å››éº»',
                        players: []
                    };
                }
                matchesMap[p.match_id].players.push(p);
            });
            return Object.values(matchesMap)
                .sort((a, b) => b.ts - a.ts)
                .map(match => {
                    const sortedPlayers = [...match.players].sort((a, b) => {
                        const aIsMember = memberIds.includes(a.discord_user_id);
                        const bIsMember = memberIds.includes(b.discord_user_id);
                        if (aIsMember && !bIsMember) return -1;
                        if (!aIsMember && bIsMember) return 1;
                        return (b.final_score || 0) - (a.final_score || 0);
                    }).map(p => ({
                        ...p,
                        avatar_url: profileMap[p.discord_user_id] || 'https://via.placeholder.com/32'
                    }));
                    return { ...match, players: sortedPlayers };
                });
        }


        function applyTeamLogFilters(memberId = 'all', mode = 'all') {
            let filtered = teamLogMatches.slice();
            if (memberId && memberId !== 'all') {
                filtered = filtered.filter(m => m.players.some(p => p.discord_user_id === memberId));
            }
            if (mode && mode !== 'all') {
                filtered = filtered.filter(m => (m.mode || 'å››éº»') === mode);
            }
            renderTeamBattleLog(filtered);
        }

        function renderTeamBattleLog(matches) {
            const logContainer = document.getElementById('team-battle-log');
            const pagination = document.getElementById('team-log-pagination');
            const totalPages = Math.max(1, Math.ceil(matches.length / TEAM_LOG_PER_PAGE));
            if (teamLogPage > totalPages) teamLogPage = totalPages;
            const start = (teamLogPage - 1) * TEAM_LOG_PER_PAGE;
            const pageItems = matches.slice(start, start + TEAM_LOG_PER_PAGE);

            if (!pageItems.length) {
                logContainer.innerHTML = '<p class="text-muted">ã¾ã å¯¾æˆ¦è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            } else {
                const memberIds = teamMembers.map(m => m.discord_user_id);
                logContainer.innerHTML = pageItems.map(match => `
                    <div class="match-log-row p-3 border-bottom hover-bg-light transition-all">
                        <div class="date-badge small text-muted mb-2">${match.date}ï¼ˆ${match.mode}ï¼‰</div>
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            ${match.players.map(p => {
                                const isMember = memberIds.includes(p.discord_user_id);
                                const score = p.final_score || p.score || 0;
                                const scoreClass = score >= 0 ? 'text-success' : 'text-danger';
                                const scorePrefix = score >= 0 ? '+' : '';
                                const rankEmoji = getRankEmoji(p.rank);
                                const teamLogo = teamLogoMap[p.team_name] ? `<img src="${teamLogoMap[p.team_name]}" class="team-logo-mini" onerror="this.remove()">` : '';
                                return `
                                    <div class="player-entry ${isMember ? 'fw-bold border-start border-3 ps-2 border-success' : ''}" 
                                         style="flex: 1 1 180px; max-width: 280px; min-width: 140px; padding: 4px;">
                                        <div class="player-team-row">
                                            ${teamLogo}
                                            <span class="text-truncate">${p.team_name || ''}</span>
                                        </div>
                                        <div class="player-info-row">
                                            <img src="${p.avatar_url}" class="rounded-circle" width="22" height="22" onerror="this.src='https://via.placeholder.com/22'">
                                            <span class="rank-emoji">${rankEmoji}</span>
                                            <span class="player-name text-truncate" style="flex-grow: 1;">${p.account_name}</span>
                                            <span class="fw-bold ${scoreClass} ms-2" style="font-size: 0.95rem; min-width: 45px; text-align: right;">${scorePrefix}${Number(score).toLocaleString()}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `).join('');
            }

            if (pagination) {
                if (matches.length <= TEAM_LOG_PER_PAGE) {
                    pagination.innerHTML = '';
                    return;
                }
                const prevDisabled = teamLogPage <= 1 ? 'disabled' : '';
                const nextDisabled = teamLogPage >= totalPages ? 'disabled' : '';
                pagination.innerHTML = `
                    <div class="d-flex justify-content-center gap-2">
                        <button class="btn btn-sm btn-outline-secondary" ${prevDisabled} onclick="changeTeamLogPage(-1)">å‰ã¸</button>
                        <div class="align-self-center small text-muted">${teamLogPage} / ${totalPages}</div>
                        <button class="btn btn-sm btn-outline-secondary" ${nextDisabled} onclick="changeTeamLogPage(1)">æ¬¡ã¸</button>
                    </div>
                `;
            }
        }

        function changeTeamLogPage(delta) {
            teamLogPage += delta;
            if (teamLogPage < 1) teamLogPage = 1;
            applyTeamLogFilters();
        }

        function toggleTeamStatsMemberDropdown() {
            const list = document.getElementById('team-stats-member-menu');
            if (!list) return;
            list.style.display = list.style.display === 'block' ? 'none' : 'block';
        }

        function selectTeamStatsMemberFilter(id, name, avatarUrl = '') {
            const input = document.getElementById('team-stats-member-filter');
            const display = document.getElementById('team-stats-member-display');
            const list = document.getElementById('team-stats-member-menu');
            if (input) input.value = id;
            if (display) {
                if (avatarUrl) {
                    display.innerHTML = `<img src="${avatarUrl}" class="dropdown-avatar" onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'"><span class="small">${name}</span>`;
                } else {
                    display.innerHTML = `<span class="small">${name}</span>`;
                }
            }
            if (list) list.style.display = 'none';
            applyTeamStatsFilter();
        }


        function getRankEmoji(rank) {
            if (rank === 1) return 'ğŸ¥‡';
            if (rank === 2) return 'ğŸ¥ˆ';
            if (rank === 3) return 'ğŸ¥‰';
            return 'ğŸ”¹';
        }

        function redirectToTeamRanking(subFilter) {
            if (!myTeam?.team_name) return;
            const anchor = `#rank-team-${encodeURIComponent(myTeam.team_name)}`;
            const url = `../index.html?main=team&sub=${encodeURIComponent(subFilter || 'all')}${anchor}`;
            window.location.href = url;
        }

        // ãƒ¡ãƒ³ãƒãƒ¼è¿½æ”¾ç”³è«‹ï¼ˆç®¡ç†è€…ã¸ç”³è«‹ï¼‰
        async function requestKick(discordId, memberName) {
            if (!confirm(`${memberName}ã®è¿½æ”¾ã‚’ã‚µã‚¤ãƒˆç®¡ç†è€…ã«ç”³è«‹ã—ã¾ã™ã‹ï¼Ÿ`)) return;

            try {
                // å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’ä½¿ç”¨
                const accountName = myProfile?.account_name || 'ä¸æ˜';

                await supabaseClient
                    .from('team_admin_requests')
                    .insert({
                        type: 'kick',
                        team_id: myTeam.id,
                        team_name: myTeam.team_name,
                        target_discord_id: discordId,
                        target_name: memberName,
                        requester_discord_id: effectiveDiscordId,
                        requester_name: accountName,
                        status: 'pending'
                    });

                alert('è¿½æ”¾ç”³è«‹ã‚’ã‚µã‚¤ãƒˆç®¡ç†è€…ã«é€ä¿¡ã—ã¾ã—ãŸã€‚æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚');
            } catch (err) {
                console.error('è¿½æ”¾ç”³è«‹ã‚¨ãƒ©ãƒ¼:', err);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ãƒãƒ¼ãƒ ä½œæˆ
        async function createTeam() {
            const teamName = document.getElementById('newTeamName').value.trim();
            const errorDiv = document.getElementById('create-team-error');
            errorDiv.style.display = 'none';

            if (!teamName) {
                errorDiv.textContent = 'ãƒãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const discordId = effectiveDiscordId;

                // ãƒãƒ¼ãƒ ä½œæˆ
                const { data: newTeam, error: teamError } = await supabaseClient
                    .from('teams')
                    .insert({
                        team_name: teamName,
                        creator_discord_id: discordId
                    })
                    .select()
                    .single();

                if (teamError) throw teamError;

                // è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«ãƒãƒ¼ãƒ ã‚’ç´ã¥ã‘
                await supabaseClient
                    .from('profiles')
                    .update({ team_id: newTeam.id })
                    .eq('discord_user_id', discordId);

                alert('ãƒãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸï¼');
                bootstrap.Modal.getInstance(document.getElementById('createTeamModal')).hide();
                location.reload();
            } catch (err) {
                console.error('ãƒãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', err);
                errorDiv.textContent = 'ãƒãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ';
                errorDiv.style.display = 'block';
            }
        }

        // åŠ å…¥ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨å¤‰æ•°
        let allTeamsForJoin = [];
        let selectedTeamId = null;

        // åŠ å…¥ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã‹ã‚ŒãŸã¨ãã«ãƒãƒ¼ãƒ ä¸€è¦§ã‚’ãƒ­ãƒ¼ãƒ‰
        document.getElementById('joinTeamModal')?.addEventListener('show.bs.modal', loadTeamsForJoin);

        async function loadTeamsForJoin() {
            const container = document.getElementById('team-list-for-join');
            container.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div> èª­ã¿è¾¼ã¿ä¸­...</div>';

            try {
                const { data: teams } = await supabaseClient.from('teams').select('*').order('team_name');
                allTeamsForJoin = teams || [];

                if (allTeamsForJoin.length === 0) {
                    container.innerHTML = '<p class="text-muted">å‚åŠ å¯èƒ½ãªãƒãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                container.innerHTML = allTeamsForJoin.map(t => `
                    <div class="team-join-item p-2 mb-2 border rounded" 
                         style="cursor: pointer;" 
                         onclick="selectTeamForJoin('${t.id}', this)">
                        <strong>ğŸ… ${t.team_name}</strong>
                    </div>
                `).join('');
            } catch (err) {
                console.error('ãƒãƒ¼ãƒ ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                container.innerHTML = '<p class="text-danger">å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }

        function selectTeamForJoin(teamId, element) {
            document.querySelectorAll('.team-join-item').forEach(el => {
                el.classList.remove('bg-success', 'text-white');
            });
            element.classList.add('bg-success', 'text-white');
            selectedTeamId = teamId;
            document.getElementById('sendJoinRequestBtn').disabled = false;
        }

        async function sendJoinRequest() {
            if (!selectedTeamId) return;

            const errorDiv = document.getElementById('join-team-error');
            errorDiv.style.display = 'none';

            try {
                const discordId = effectiveDiscordId;

                // æ—¢å­˜ã®ç”³è«‹ã‚’ãƒã‚§ãƒƒã‚¯
                const { data: existingRequest } = await supabaseClient
                    .from('team_join_requests')
                    .select('*')
                    .eq('requester_discord_id', discordId)
                    .eq('status', 'pending')
                    .maybeSingle();

                if (existingRequest) {
                    errorDiv.textContent = 'æ—¢ã«ç”³è«‹ä¸­ã®ãƒãƒ¼ãƒ ãŒã‚ã‚Šã¾ã™';
                    errorDiv.style.display = 'block';
                    return;
                }

                // åŠ å…¥ç”³è«‹ã‚’é€ä¿¡
                await supabaseClient
                    .from('team_join_requests')
                    .insert({
                        team_id: selectedTeamId,
                        requester_discord_id: discordId,
                        status: 'pending'
                    });

                alert('åŠ å…¥ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ãƒãƒ¼ãƒ ç®¡ç†è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚');
                bootstrap.Modal.getInstance(document.getElementById('joinTeamModal')).hide();
                location.reload();
            } catch (err) {
                console.error('åŠ å…¥ç”³è«‹ã‚¨ãƒ©ãƒ¼:', err);
                errorDiv.textContent = 'ç”³è«‹ã«å¤±æ•—ã—ã¾ã—ãŸ';
                errorDiv.style.display = 'block';
            }
        }
    </script>
</body>

</html>
