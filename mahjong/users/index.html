<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ | ã‹ã«ã‚µãƒ¼ãƒãƒ¼</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=M+PLUS+Rounded+1c:wght@400;700&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-green: #2d8a5e;
            --deep-green: #1e6b47;
            --cream: #faf5e8;
            --gold: #d4a853;
            --font-title: 'Noto Serif JP', serif;
            --font-body: 'M PLUS Rounded 1c', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background: linear-gradient(180deg, #2d8a5e 0%, #256b4a 50%, #1e5538 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }

        .page-header {
            font-family: var(--font-title);
            color: var(--cream);
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            text-decoration: none;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 18px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--gold);
        }

        .content-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .team-section {
            margin-bottom: 30px;
        }

        .team-header {
            font-family: var(--font-title);
            color: var(--deep-green);
            border-bottom: 2px solid var(--gold);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .user-card {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }

        .user-card:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-right: 15px;
            border: 2px solid var(--gold);
        }

        .user-name {
            font-weight: 600;
            color: #333;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn-gold {
            background: linear-gradient(135deg, var(--gold) 0%, #b8892d 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-gold:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(212, 168, 83, 0.5);
            color: white;
        }

        .modal-header {
            background: var(--deep-green);
            color: white;
        }

        .team-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .team-list-item:hover {
            background: #f8f9fa;
            border-color: var(--gold);
        }

        .team-list-item.selected {
            border-color: var(--deep-green);
            background: rgba(45, 138, 94, 0.1);
        }
    </style>
</head>

<body>
    <a href="../index.html" class="back-button">â† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æˆ»ã‚‹</a>

    <div class="container py-5 mt-4">
        <header class="text-center mb-4">
            <h1 class="page-header display-4 fw-bold">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h1>
        </header>

        <div class="content-card">
            <div id="users-loading" class="text-center py-5">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
            </div>

            <div id="users-content" style="display: none;">
                <!-- ãƒãƒ¼ãƒ åˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º -->
                <div id="teams-container"></div>

                <!-- æœªæ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼ -->
                <div class="team-section">
                    <h3 class="team-header">ğŸš« æœªæ‰€å±</h3>
                    <div id="unaffiliated-users"></div>
                </div>
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆæœªæ‰€å±è€…ã®ã¿è¡¨ç¤ºï¼‰ -->
            <div id="action-buttons" class="action-buttons" style="display: none;">
                <button class="btn-gold" data-bs-toggle="modal" data-bs-target="#createTeamModal">
                    â• ãƒãƒ¼ãƒ ã‚’ä½œæˆ
                </button>
                <button class="btn-gold" data-bs-toggle="modal" data-bs-target="#joinTeamModal">
                    ğŸ¤ ãƒãƒ¼ãƒ ã«åŠ å…¥
                </button>
            </div>

            <!-- ç”³è«‹ä¸­è¡¨ç¤º -->
            <div id="pending-status" class="text-center py-3" style="display: none;">
                <div class="alert alert-warning">
                    <strong>â³ ãƒãƒ¼ãƒ åŠ å…¥ç”³è«‹ä¸­</strong><br>
                    <span id="pending-team-name"></span>ã¸ã®åŠ å…¥ç”³è«‹ã‚’é€ä¿¡æ¸ˆã¿ã§ã™ã€‚ç®¡ç†è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚
                </div>
            </div>

            <!-- æ‰€å±æ¸ˆã¿è¡¨ç¤º -->
            <div id="team-member-status" class="text-center py-3" style="display: none;">
                <div class="alert alert-success">
                    <strong>ğŸ… ãƒãƒ¼ãƒ æ‰€å±ä¸­</strong><br>
                    <span id="my-team-name"></span>ã«æ‰€å±ã—ã¦ã„ã¾ã™ã€‚
                    <a href="../team/index.html" class="btn btn-outline-success btn-sm ms-2">ãƒãƒ¼ãƒ ç®¡ç†ã¸</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒãƒ¼ãƒ ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="createTeamModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">â• ãƒãƒ¼ãƒ ã‚’ä½œæˆ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="teamName" class="form-label">ãƒãƒ¼ãƒ å</label>
                        <input type="text" class="form-control" id="teamName" placeholder="ãƒãƒ¼ãƒ åã‚’å…¥åŠ›">
                    </div>
                    <div id="create-team-error" class="text-danger" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-success" onclick="createTeam()">ä½œæˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒãƒ¼ãƒ åŠ å…¥ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="joinTeamModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ¤ ãƒãƒ¼ãƒ ã«åŠ å…¥</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">åŠ å…¥ã—ãŸã„ãƒãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                    <div id="team-list-for-join">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            èª­ã¿è¾¼ã¿ä¸­...
                        </div>
                    </div>
                    <div id="join-team-error" class="text-danger mt-2" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-success" id="sendJoinRequestBtn" onclick="sendJoinRequest()"
                        disabled>åŠ å…¥ç”³è«‹ã‚’é€ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../js/supabase-config.js"></script>

    <script>
        let allTeams = [];
        let allProfiles = [];
        let selectedTeamId = null;
        let myProfile = null;

        document.addEventListener('DOMContentLoaded', loadUsersData);

        async function loadUsersData() {
            try {
                // ãƒãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å–å¾—
                const { data: teams, error: teamsError } = await supabaseClient
                    .from('teams')
                    .select('*')
                    .order('team_name');

                if (teamsError) throw teamsError;
                allTeams = teams || [];

                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿å–å¾—
                const { data: profiles, error: profilesError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .order('account_name');

                if (profilesError) throw profilesError;
                allProfiles = profiles || [];

                renderUsers();

                // ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
                await checkUserStatus();

                document.getElementById('users-loading').style.display = 'none';
                document.getElementById('users-content').style.display = 'block';
            } catch (err) {
                console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                document.getElementById('users-loading').innerHTML = '<p class="text-danger">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }

        async function checkUserStatus() {
            const user = await getCurrentUser();
            if (!user) {
                // æœªãƒ­ã‚°ã‚¤ãƒ³ã§ã‚‚ãƒœã‚¿ãƒ³ã¯è¡¨ç¤ºï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¿ƒã™ï¼‰
                document.getElementById('action-buttons').style.display = 'flex';
                return;
            }

            const discordId = user.user_metadata.provider_id;
            myProfile = allProfiles.find(p => p.discord_user_id === discordId);

            if (myProfile && myProfile.team_id) {
                // ãƒãƒ¼ãƒ æ‰€å±æ¸ˆã¿
                const myTeam = allTeams.find(t => t.id === myProfile.team_id);
                document.getElementById('my-team-name').textContent = myTeam?.team_name || 'ãƒãƒ¼ãƒ ';
                document.getElementById('team-member-status').style.display = 'block';
            } else {
                // æœªæ‰€å± - ç”³è«‹ä¸­ã‹ãƒã‚§ãƒƒã‚¯
                const { data: pendingRequest } = await supabaseClient
                    .from('team_join_requests')
                    .select('*, teams(*)')
                    .eq('requester_discord_id', discordId)
                    .eq('status', 'pending')
                    .maybeSingle();

                if (pendingRequest) {
                    // ç”³è«‹ä¸­
                    document.getElementById('pending-team-name').textContent = pendingRequest.teams?.team_name || 'ãƒãƒ¼ãƒ ';
                    document.getElementById('pending-status').style.display = 'block';
                } else {
                    // æœªæ‰€å±ãƒ»æœªç”³è«‹ - ãƒœã‚¿ãƒ³è¡¨ç¤º
                    document.getElementById('action-buttons').style.display = 'flex';
                }
            }
        }

        function renderUsers() {
            const teamsContainer = document.getElementById('teams-container');
            const unaffiliatedContainer = document.getElementById('unaffiliated-users');

            teamsContainer.innerHTML = '';
            unaffiliatedContainer.innerHTML = '';

            // ãƒãƒ¼ãƒ åˆ¥ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¡¨ç¤º
            allTeams.forEach(team => {
                const teamMembers = allProfiles.filter(p => p.team_id === team.id);
                if (teamMembers.length === 0) return;

                const section = document.createElement('div');
                section.className = 'team-section';
                section.innerHTML = `
                    <h3 class="team-header">ğŸ… ${team.team_name}</h3>
                    <div class="team-members">
                        ${teamMembers.map(user => createUserCard(user)).join('')}
                    </div>
                `;
                teamsContainer.appendChild(section);
            });

            // æœªæ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼
            const unaffiliatedUsers = allProfiles.filter(p => !p.team_id);
            if (unaffiliatedUsers.length === 0) {
                unaffiliatedContainer.innerHTML = '<p class="text-muted">æœªæ‰€å±ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“</p>';
            } else {
                unaffiliatedContainer.innerHTML = unaffiliatedUsers.map(user => createUserCard(user)).join('');
            }
        }

        function createUserCard(user) {
            const avatarUrl = user.avatar_url || 'https://via.placeholder.com/48';
            const name = user.account_name || 'åç§°æœªè¨­å®š';
            return `
                <a href="../../mypage/index.html?user=${user.discord_user_id}" class="user-card text-decoration-none">
                    <img src="${avatarUrl}" alt="${name}" class="user-avatar" onerror="this.src='https://via.placeholder.com/48'">
                    <span class="user-name">${name}</span>
                </a>
            `;
        }

        // ãƒãƒ¼ãƒ ä½œæˆ
        async function createTeam() {
            const teamName = document.getElementById('teamName').value.trim();
            const errorDiv = document.getElementById('create-team-error');

            if (!teamName) {
                errorDiv.textContent = 'ãƒãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                errorDiv.style.display = 'block';
                return;
            }

            const user = await getCurrentUser();
            if (!user) {
                errorDiv.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™';
                errorDiv.style.display = 'block';
                return;
            }

            const discordId = user.user_metadata.provider_id;

            try {
                // ãƒãƒ¼ãƒ ä½œæˆ
                const { data: newTeam, error: createError } = await supabaseClient
                    .from('teams')
                    .insert({
                        team_name: teamName,
                        creator_discord_id: discordId
                    })
                    .select()
                    .single();

                if (createError) {
                    if (createError.code === '23505') {
                        errorDiv.textContent = 'ã“ã®ãƒãƒ¼ãƒ åã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™';
                    } else {
                        errorDiv.textContent = 'ãƒãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + createError.message;
                    }
                    errorDiv.style.display = 'block';
                    return;
                }

                // ä½œæˆè€…ã‚’è‡ªå‹•çš„ã«ãƒãƒ¼ãƒ ã«è¿½åŠ 
                await supabaseClient
                    .from('profiles')
                    .update({ team_id: newTeam.id })
                    .eq('discord_user_id', discordId);

                alert('ãƒãƒ¼ãƒ ã‚’ä½œæˆã—ã¾ã—ãŸï¼');
                bootstrap.Modal.getInstance(document.getElementById('createTeamModal')).hide();
                location.reload();
            } catch (err) {
                console.error('ãƒãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', err);
                errorDiv.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                errorDiv.style.display = 'block';
            }
        }

        // ãƒãƒ¼ãƒ ä¸€è¦§ã‚’åŠ å…¥ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤º
        document.getElementById('joinTeamModal').addEventListener('show.bs.modal', loadTeamsForJoin);

        async function loadTeamsForJoin() {
            const container = document.getElementById('team-list-for-join');

            if (allTeams.length === 0) {
                container.innerHTML = '<p class="text-muted">ã¾ã ãƒãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            container.innerHTML = allTeams.map(team => `
                <div class="team-list-item" onclick="selectTeamForJoin('${team.id}', this)">
                    <span>ğŸ… ${team.team_name}</span>
                </div>
            `).join('');
        }

        function selectTeamForJoin(teamId, element) {
            document.querySelectorAll('.team-list-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedTeamId = teamId;
            document.getElementById('sendJoinRequestBtn').disabled = false;
        }

        // åŠ å…¥ç”³è«‹é€ä¿¡
        async function sendJoinRequest() {
            const errorDiv = document.getElementById('join-team-error');

            if (!selectedTeamId) {
                errorDiv.textContent = 'ãƒãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„';
                errorDiv.style.display = 'block';
                return;
            }

            const user = await getCurrentUser();
            if (!user) {
                errorDiv.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™';
                errorDiv.style.display = 'block';
                return;
            }

            const discordId = user.user_metadata.provider_id;

            try {
                // æ—¢å­˜ã®ç”³è«‹ç¢ºèª
                const { data: existing } = await supabaseClient
                    .from('team_join_requests')
                    .select('*')
                    .eq('team_id', selectedTeamId)
                    .eq('requester_discord_id', discordId)
                    .eq('status', 'pending')
                    .maybeSingle();

                if (existing) {
                    errorDiv.textContent = 'æ—¢ã«ã“ã®ãƒãƒ¼ãƒ ã«ç”³è«‹ä¸­ã§ã™';
                    errorDiv.style.display = 'block';
                    return;
                }

                // ç”³è«‹ä½œæˆ
                const { error } = await supabaseClient
                    .from('team_join_requests')
                    .insert({
                        team_id: selectedTeamId,
                        requester_discord_id: discordId
                    });

                if (error) throw error;

                alert('åŠ å…¥ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ãƒãƒ¼ãƒ ç®¡ç†è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚');
                bootstrap.Modal.getInstance(document.getElementById('joinTeamModal')).hide();
            } catch (err) {
                console.error('ç”³è«‹é€ä¿¡ã‚¨ãƒ©ãƒ¼:', err);
                errorDiv.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                errorDiv.style.display = 'block';
            }
        }
    </script>
</body>

</html>