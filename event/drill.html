<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã»ã‚Šã»ã‚Šãƒ‰ãƒªãƒ« | ã‹ã«ã‚µãƒ¼ãƒãƒ¼</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=M+PLUS+Rounded+1c:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- Bootswatch Lux -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <style>
        :root {
            --primary-drill: #8b4513;
            --secondary-drill: #d2b48c;
            --font-title: 'Noto Serif JP', serif;
            --font-body: 'M PLUS Rounded 1c', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            min-height: 100vh;
            color: #eee;
        }

        .page-header {
            font-family: var(--font-title);
            color: #fff;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            margin-bottom: 0.5rem;
        }

        .luck-level-badge {
            display: inline-block;
            background: linear-gradient(90deg, #ffc107, #ff8c00);
            color: #000;
            padding: 4px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
            margin-bottom: 2rem;
        }

        .drill-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 1000px;
            margin: 0 auto;
            text-align: center;
        }

        /* ãƒ­ã‚°ãƒ»ç¢ºç‡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .info-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: left;
            font-size: 0.9rem;
            height: 100%;
        }

        .log-item {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .log-item.milestone {
            background: rgba(255, 193, 7, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 4px 0;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .log-item:last-child {
            border-bottom: none;
        }

        .stat-card {
            background: #333;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: none;
        }

        .stat-card.primary {
            background: #f6b253;
            color: #222;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 0.9rem;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .reward-table {
            width: 100%;
            font-size: 0.85rem;
        }

        .reward-table td {
            padding: 4px 0;
        }

        .prob-bar-container {
            background: rgba(255, 255, 255, 0.1);
            height: 8px;
            border-radius: 4px;
            flex-grow: 1;
        }

        .prob-bar {
            height: 100%;
            border-radius: 4px;
            background: #ffc107;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®è¡¨ç¤ºã‚»ãƒƒãƒˆ */
        .user-cell {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            vertical-align: middle;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .user-badge {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .mutant-badge-container.mini {
            position: relative;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .mutant-badge-shine {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0) 30%,
                    rgba(255, 255, 255, 0.8) 50%,
                    rgba(255, 255, 255, 0) 70%,
                    rgba(255, 255, 255, 0) 100%);
            background-size: 200% 200%;
            animation: mutant-shine 3s infinite linear;
            border-radius: 50%;
            z-index: 1;
        }

        @keyframes mutant-shine {
            0% {
                background-position: -200% -200%;
            }

            100% {
                background-position: 200% 200%;
            }
        }

        .rank-gold {
            color: #ffd700;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }

        .rank-silver {
            color: #c0c0c0;
            text-shadow: 0 0 5px rgba(192, 192, 192, 0.5);
        }

        .rank-bronze {
            color: #cd7f32;
            text-shadow: 0 0 5px rgba(205, 127, 50, 0.5);
        }
    </style>
</head>

<body>
    <div id="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-warning mb-3"></div>
            <div>èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <div class="nav-dropdown"></div>

    <div class="container py-5 mt-5">
        <div class="drill-container">
            <h1 class="page-header">ğŸ—ï¸ ã»ã‚Šã»ã‚Šãƒ‰ãƒªãƒ«</h1>
            <div id="luck-level-display" class="luck-level-badge">ç¾åœ¨ã®åœ°ç›¤ãƒ¬ãƒ™ãƒ«: Lv0 (é€šå¸¸)</div>

            <div class="row g-4 mb-4">
                <div class="col-md-7">
                    <!-- ãƒ«ãƒ¼ãƒ«èª¬æ˜ -->
                    <div class="card bg-dark bg-opacity-50 border-secondary mb-3 text-start h-100">
                        <div class="card-body">
                            <h5 class="card-title text-warning">ğŸ“œ ã»ã‚Šã»ã‚Šãƒ‰ãƒªãƒ«ã¨ã¯ï¼Ÿ</h5>
                            <p class="small mb-1">ã¿ã‚“ãªã§åŠ›ã‚’åˆã‚ã›ã¦åœ°é¢ã‚’æ˜ã‚Šé€²ã‚ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã§ã™ï¼<br>æ˜ã‚Œã°æ˜ã‚‹ã»ã©ã€ã‚ˆã‚Šè‰¯ã„ãŠå®ãŒå‡ºã‚„ã™ããªã‚Šã¾ã™ã€‚</p>
                            <p class="small mb-2 text-info"><strong>â€»è¡¨ç¤ºã«ã¯æœ€å¤§3åˆ†é–“ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚°ãŒã‚ã‚Šã¾ã™</strong></p>
                            <p class="small mb-2 text-danger"><strong>ğŸ—“ï¸ æœŸé–“é™å®šï¼š1æœˆæœ« éº»é›€å¤§ä¼šæœ¬æˆ¦é–‹å§‹ã¾ã§</strong></p>
                            <hr class="border-secondary my-2">
                            <h6 class="text-info small">ğŸ® åŸºæœ¬ãƒ«ãƒ¼ãƒ«</h6>
                            <ul class="mb-2 small" style="line-height: 1.8;">
                                <li>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ <span class="badge bg-secondary">1M (ãƒ¡ãƒ¼ãƒˆãƒ«)</span> æ˜ã‚Œã¾ã™</li>
                                <li>1æ—¥æœ€å¤§ <span class="badge bg-warning text-dark">100å›</span> ã¾ã§ç„¡æ–™</li>
                                <li>ä¸Šé™ã«é”ã—ãŸã‚‰ <span class="text-info">ã‚³ã‚¤ãƒ³ã§ä¿®ç†</span> å¯èƒ½ (åœ°ç›¤ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦å¤‰å‹•)</li>
                                <li>æ¯æ—¥0æ™‚ã«ãƒªã‚»ãƒƒãƒˆ</li>
                            </ul>
                            <h6 class="text-info small">ğŸ ã‚­ãƒªç•ªãƒœãƒ¼ãƒŠã‚¹</h6>
                            <ul class="mb-2 small" style="line-height: 1.8;">
                                <li><span class="text-warning fw-bold">100Mã”ã¨</span> â†’ ç¥ˆé¡˜ç¬¦ 1æš</li>
                                <li><span class="text-warning fw-bold">1,000Mã”ã¨</span> â†’ ç¥ˆé¡˜ç¬¦ 5æš</li>
                                <li><span class="text-warning fw-bold">10,000Måˆ°é”</span> â†’ é™å®šãƒãƒƒã‚¸ï¼</li>
                            </ul>
                            <h6 class="text-info small">ğŸ“ˆ åœ°ç›¤ãƒ¬ãƒ™ãƒ«</h6>
                            <ul class="mb-0 small" style="line-height: 1.8;">
                                <li>åˆè¨ˆ <span class="text-warning">1,000M</span> ã”ã¨ã«ãƒ¬ãƒ™ãƒ«UPï¼</li>
                                <li>ãƒ¬ãƒ™ãƒ«ãŒä¸ŠãŒã‚‹ã¨å ±é…¬ãŒè±ªè¯ã«ï¼ˆæœ€å¤§ <span class="badge bg-warning text-dark">Lv10</span>ï¼‰</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <!-- æ˜ã£ãŸæ·±ã•ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
                    <div class="info-panel h-100">
                        <h6 class="text-warning mb-3">ğŸ† æ˜å‰Šç‹ãƒ©ãƒ³ã‚­ãƒ³ã‚° (TOP 10)</h6>
                        <div id="user-ranking-list">
                            <div class="text-center text-muted py-4">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å…¨ä½“ãƒ»å€‹äººã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="stat-card primary">
                        <div class="stat-label">å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆè¨ˆ</div>
                        <div id="global-total-meters" class="stat-value">- M</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-label">ä»Šæ—¥ã®æ®‹ã‚Š</div>
                        <div id="daily-remaining-container">
                            <span id="daily-remaining" class="stat-value">-</span>
                        </div>
                        <div id="repair-area" class="mt-2" style="display: none;">
                            <button id="repair-button" class="btn btn-warning w-100 fw-bold" onclick="handleRepair()">
                                ğŸ› ï¸ ãƒ‰ãƒªãƒ«ã‚’ä¿®ç† (ã‚³ã‚¤ãƒ³ä½¿ç”¨)
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-label">è‡ªåˆ†ãŒæ˜ã£ãŸæ·±ã•</div>
                        <div id="total-taps" class="stat-value">- M</div>
                    </div>
                </div>
            </div>

            <!-- æ˜å‰Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="dig-area my-5">
                <div id="drill-visual" class="drill-visual">
                    <span class="drill-emoji">ğŸ—ï¸</span>
                    <div id="dirt-effect" class="dirt-effect"></div>
                </div>

                <button id="dig-button" class="btn btn-warning btn-lg rounded-pill px-5 py-3 fw-bold shadow-lg mt-4"
                    onclick="handleDig()">
                    æ˜ã‚‹ï¼
                </button>
            </div>

            <div id="result-message" class="mt-3 h5 fw-bold" style="min-height: 1.5rem;"></div>

            <div class="row mt-5 text-start">
                <div class="col-md-8">
                    <h6 class="text-white-50 mb-3">ğŸ“ æœ€è¿‘ã®æ˜ã‚Šå‡ºã—ãƒ­ã‚°</h6>
                    <div id="recent-logs" class="info-panel"
                        style="min-height: 300px; max-height: 400px; overflow-y: auto;">
                        <p class="text-center text-muted py-5">ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-white-50 m-0">ğŸ“Š æä¾›å‰²åˆ (<span id="preview-level-label">ç¾åœ¨</span>)</h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-warning" onclick="changePreviewLevel(-1)">â—€</button>
                            <span id="preview-level-number" class="btn btn-outline-warning disabled fw-bold"
                                style="min-width: 60px;">Lv-</span>
                            <button class="btn btn-outline-warning" onclick="changePreviewLevel(1)">â–¶</button>
                        </div>
                    </div>
                    <div class="info-panel">
                        <table id="probability-table" class="reward-table"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å ±é…¬ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div id="reward-modal" class="modal fade" tabindex="-1" aria-hidden="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-warning">
                <div class="modal-body text-center py-5">
                    <h2 class="text-warning mb-4">âœ¨ ãŠå®ç™ºè¦‹ï¼ âœ¨</h2>
                    <div id="reward-content" class="h3 mb-4"></div>
                    <button type="button" class="btn btn-warning rounded-pill px-4"
                        data-bs-dismiss="modal">ã‚„ã£ãŸãƒ¼ï¼</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å…±é€šæ¼”å‡ºã‚¹ã‚¿ã‚¤ãƒ« -->
    <style>
        .drill-visual {
            font-size: 6rem;
            position: relative;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 2rem;
        }

        .drill-emoji {
            display: inline-block;
            transition: transform 0.1s;
        }

        .digging .drill-emoji {
            animation: vibrate 0.1s infinite, descend 1s ease-in-out;
        }

        @keyframes vibrate {
            0% {
                transform: translate(1px, 1px) rotate(0deg);
            }

            10% {
                transform: translate(-1px, -2px) rotate(-1deg);
            }

            20% {
                transform: translate(-3px, 0px) rotate(1deg);
            }

            30% {
                transform: translate(3px, 2px) rotate(0deg);
            }

            40% {
                transform: translate(1px, -1px) rotate(1deg);
            }

            50% {
                transform: translate(-1px, 2px) rotate(-1deg);
            }

            60% {
                transform: translate(-3px, 1px) rotate(0deg);
            }

            70% {
                transform: translate(3px, 1px) rotate(-1deg);
            }

            80% {
                transform: translate(-1px, -1px) rotate(1deg);
            }

            90% {
                transform: translate(1px, 2px) rotate(0deg);
            }

            100% {
                transform: translate(1px, -2px) rotate(-1deg);
            }
        }

        @keyframes descend {
            0% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(20px);
            }

            100% {
                transform: translateY(0);
            }
        }

        .dirt-effect {
            position: absolute;
            bottom: 0;
            width: 100px;
            height: 20px;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: #8b4513;
            border-radius: 50%;
            opacity: 0;
            animation: particle-fly 0.5s ease-out forwards;
        }

        @keyframes particle-fly {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }

            100% {
                transform: translate(var(--tx), var(--ty));
                opacity: 0;
            }
        }
    </style>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        let currentUserId = null;
        let isAdmin = false;
        let isDigging = false;
        let currentLuckLevel = 0;
        let viewLuckLevel = 0; // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®ãƒ¬ãƒ™ãƒ«

        async function checkAuth() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            const overlay = document.getElementById('loading-overlay');
            if (!user) { window.location.href = '../index.html'; return; }
            currentUserId = user.user_metadata.provider_id;
            isAdmin = ADMIN_DISCORD_IDS.includes(currentUserId);
            overlay.style.display = 'none';

            if (!isAdmin) {
                const notice = document.createElement('div');
                notice.className = 'alert alert-danger text-center fw-bold mb-4';
                notice.innerHTML = 'ğŸ”¥ çš†ã•ã‚“ã®å°½åŠ›ã§å²©ç›¤ã‚’è²«ãã€ãƒ‰ãƒªãƒ«ã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ’ãƒ¼ãƒˆã—ã¾ã—ãŸã€‚<br>ä¿®ç†ã•ã‚Œã‚‹ã¾ã§ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚';
                document.querySelector('.drill-container').insertBefore(notice, document.querySelector('.page-header').nextSibling);
            }

            initAccordionNav('../');
            loadStats();
        }

        async function loadStats() {
            try {
                const threeMinutesAgo = new Date(Date.now() - 3 * 60 * 1000).toISOString();

                const [userRes, globalUsersRes, logsRes, delayedDepthRes, mutantRes, recentTapsRes] = await Promise.all([
                    supabaseClient.from('event_drill_user_stats').select('*').eq('user_id', currentUserId).maybeSingle(),
                    supabaseClient.from('event_drill_user_stats').select('total_taps, user_id, profiles(account_name, avatar_url, discord_user_id, equipped_badge_id, equipped_badge_id_right, badges!equipped_badge_id(image_url, name), badges_right:badges!equipped_badge_id_right(image_url, name))').order('total_taps', { ascending: false }),
                    supabaseClient.from('event_drill_logs').select(`created_at, reward_type, reward_name, depth, profiles!user_id(discord_user_id, account_name, avatar_url, equipped_badge_id, equipped_badge_id_right, badges!equipped_badge_id(image_url, name), badges_right:badges!equipped_badge_id_right(image_url, name))`).neq('reward_type', 'nothing').lte('created_at', threeMinutesAgo).order('created_at', { ascending: false }).limit(50),
                    supabaseClient.from('event_drill_logs').select('depth').lte('created_at', threeMinutesAgo).order('created_at', { ascending: false }).limit(1).maybeSingle(),
                    supabaseClient.from('user_badges_new').select('user_id, badge_id, is_mutant').eq('is_mutant', true),
                    supabaseClient.from('event_drill_logs').select('user_id').gte('created_at', threeMinutesAgo)
                ]);

                const mutantMap = {};
                (mutantRes.data || []).forEach(m => { mutantMap[`${m.user_id}_${m.badge_id}`] = true; });
                window.drillMutantMap = mutantMap;

                const globalData = globalUsersRes.data || [];

                // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®é…å»¶è¨ˆç®—
                const recentTapCountMap = {};
                (recentTapsRes.data || []).forEach(log => {
                    recentTapCountMap[log.user_id] = (recentTapCountMap[log.user_id] || 0) + 1;
                });

                const delayedRankingData = globalData.map(u => ({
                    ...u,
                    delayedTotal: Math.max(0, (u.total_taps || 0) - (recentTapCountMap[u.user_id] || 0))
                })).sort((a, b) => b.delayedTotal - a.delayedTotal);

                // 5åˆ†é–“ã®é…å»¶ã‚’é©ç”¨ (ç¾åœ¨ã¯3åˆ†)
                // const realGlobalTotal = globalData.reduce((acc, curr) => acc + (parseInt(curr.total_taps) || 0), 0);

                // 5åˆ†é–“ã®é…å»¶ã‚’é©ç”¨
                // 5åˆ†ä»¥ä¸Šå‰ã®æœ€æ–°ã®ãƒ­ã‚°ã® depth ã‚’è¡¨ç¤ºç”¨åˆè¨ˆå€¤ã¨ã—ã¦æ¡ç”¨ã™ã‚‹
                const displayedGlobalTotal = delayedDepthRes.data?.depth || 0;
                document.getElementById('global-total-meters').textContent = displayedGlobalTotal.toLocaleString() + ' M';

                currentLuckLevel = Math.min(Math.floor(displayedGlobalTotal / 1000), 10);
                document.getElementById('luck-level-display').textContent = `ç¾åœ¨ã®åœ°ç›¤ãƒ¬ãƒ™ãƒ«: Lv${currentLuckLevel} ${currentLuckLevel === 10 ? '(æœ€å¤§)' : ''}`;

                if (userRes.data) {
                    const lastTap = new Date(userRes.data.last_tap_at);
                    const midnightJST = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Tokyo" }));
                    midnightJST.setHours(0, 0, 0, 0);
                    const dailyTaps = (lastTap < midnightJST) ? 0 : userRes.data.daily_taps;
                    document.getElementById('daily-remaining').textContent = Math.max(0, 100 - dailyTaps);
                    document.getElementById('total-taps').textContent = userRes.data.total_taps.toLocaleString() + ' M';
                    document.getElementById('repair-area').style.display = (dailyTaps >= 100) ? 'block' : 'none';
                } else {
                    document.getElementById('daily-remaining').textContent = '100';
                    document.getElementById('total-taps').textContent = '0 M';
                    document.getElementById('repair-area').style.display = 'none';
                }

                renderRanking(delayedRankingData.slice(0, 10));

                viewLuckLevel = currentLuckLevel;
                updatePreviewUI();
                await fetchProbabilities(viewLuckLevel);

                renderLogs(logsRes.data || []);

            } catch (err) { console.error('Stats load error:', err); }
        }

        function renderRanking(topUsers) {
            const container = document.getElementById('user-ranking-list');
            if (!topUsers || topUsers.length === 0) { container.innerHTML = '<div class="text-center text-muted">ãƒ‡ãƒ¼ã‚¿ãªã—</div>'; return; }
            const rankClasses = ['rank-gold', 'rank-silver', 'rank-bronze', '', '', '', '', '', '', ''];
            const rankEmojis = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ğŸ”Ÿ'];

            container.innerHTML = topUsers.map((u, i) => {
                const profile = u.profiles;
                return `
                    <div class="d-flex align-items-center mb-2 p-2 rounded overflow-hidden" style="background: rgba(255,255,255,0.05);">
                        <span class="me-2 fw-bold ${rankClasses[i]}">${rankEmojis[i] || (i + 1)}</span>
                        <img src="${profile?.avatar_url || 'https://via.placeholder.com/32'}" class="user-avatar" style="width:24px; height:24px;">
                        <span class="ms-2 small text-truncate text-warning fw-bold" style="flex-grow:1;">${profile?.account_name || 'ä¸æ˜'}</span>
                        <span class="small fw-bold text-info">${u.delayedTotal}M</span>
                    </div>
                `;
            }).join('');
        }

        function renderProbabilities(rewards) {
            const table = document.getElementById('probability-table');
            if (!rewards || rewards.length === 0) { table.innerHTML = '<tr><td>ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>'; return; }

            const totalWeight = rewards.reduce((acc, r) => acc + (r.probability_weight || 0), 0);

            table.innerHTML = rewards.map(r => {
                const prob = ((r.probability_weight / totalWeight) * 100);
                const probStr = prob < 0.01 ? prob.toFixed(5) : prob < 1 ? prob.toFixed(3) : prob.toFixed(2);
                return `<tr><td style="width:45%">${r.reward_name}</td><td style="width:18%; text-align:right; padding-right:8px;">${probStr}%</td>
                    <td><div class="prob-bar-container"><div class="prob-bar" style="width: ${Math.min(prob, 100)}%"></div></div></td></tr>`;
            }).join('');
        }

        function renderLogs(logs) {
            const container = document.getElementById('recent-logs');
            if (!logs || logs.length === 0) { container.innerHTML = '<p class="text-center text-muted py-5">ã¾ã æ˜ã‚Šå‡ºã—ç‰©ã¯ã‚ã‚Šã¾ã›ã‚“</p>'; return; }

            container.innerHTML = logs.map(log => {
                const profile = log.profiles;
                const name = profile?.account_name || 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼';
                const avatar = profile?.avatar_url || 'https://via.placeholder.com/32';
                const time = new Date(log.created_at).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

                const renderBadge = (badge, id, userId) => {
                    if (!badge) return '';
                    const isMutant = window.drillMutantMap[`${userId}_${id}`];
                    return `<div class="mutant-badge-container mini ${isMutant ? 'active' : ''}"><img src="${badge.image_url}" class="user-badge" title="${badge.name}"><div class="mutant-badge-shine" style="display:${isMutant ? 'block' : 'none'};"></div></div>`;
                };

                const badgeLeft = renderBadge(profile?.badges, profile?.equipped_badge_id, profile?.discord_user_id);
                const badgeRight = renderBadge(profile?.badges_right, profile?.equipped_badge_id_right, profile?.discord_user_id);

                if (log.reward_type === 'milestone') {
                    return `<div class="log-item milestone d-flex align-items-center gap-2">
                        <span class="text-white-50 small">${time}</span>
                        <div class="user-cell"><img src="${avatar}" class="user-avatar">${badgeLeft}<span class="fw-bold text-warning">${name}</span>${badgeRight}</div>
                        <div class="ms-1 fw-bold text-info">ğŸ‰ ${log.reward_name}</div>
                    </div>`;
                }

                return `<div class="log-item d-flex align-items-center gap-2 py-2">
                    <span class="text-white-50 small" style="min-width:45px;">${time}</span>
                    <div class="user-cell"><img src="${avatar}" class="user-avatar">${badgeLeft}<span class="fw-bold text-warning">${name}</span>${badgeRight}</div>
                    <div class="ms-1"><span>ãŒ</span><span class="text-info">${log.depth}M</span><span>ã§</span><span class="fw-bold">${log.reward_name}</span><span>ã‚’ã‚²ãƒƒãƒˆï¼</span></div>
                </div>`;
            }).join('');
        }

        async function changePreviewLevel(delta) {
            const next = viewLuckLevel + delta;
            if (next < 0 || next > 10) return;
            viewLuckLevel = next;
            updatePreviewUI();
            await fetchProbabilities(viewLuckLevel);
        }

        function updatePreviewUI() {
            document.getElementById('preview-level-number').textContent = `Lv${viewLuckLevel}`;
            document.getElementById('preview-level-label').textContent = (viewLuckLevel === currentLuckLevel) ? 'ç¾åœ¨' : 'ç¢ºèªç”¨';
        }

        async function fetchProbabilities(level) {
            try {
                const { data: rewardsData } = await supabaseClient
                    .from('event_drill_rewards')
                    .select('reward_name, probability_weight')
                    .eq('level_id', level)
                    .eq('is_active', true)
                    .order('id');
                renderProbabilities(rewardsData || []);
            } catch (err) { console.error('Fetch probabilities error:', err); }
        }

        async function handleDig() {
            if (!isAdmin) {
                alert('çš†ã•ã‚“ã®å°½åŠ›ã§å²©ç›¤ã‚’è²«ãã€ãƒ‰ãƒªãƒ«ã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ’ãƒ¼ãƒˆã—ã¾ã—ãŸã€‚\nä¿®ç†ã•ã‚Œã‚‹ã¾ã§ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
                return;
            }
            if (isDigging) return;
            isDigging = true;
            const btn = document.getElementById('dig-button');
            const visual = document.getElementById('drill-visual');
            const resultMsg = document.getElementById('result-message');
            btn.disabled = true; visual.classList.add('digging');
            resultMsg.textContent = 'æ˜å‰Šä¸­...'; createParticles();

            try {
                const { data, error } = await supabaseClient.rpc('process_drill_tap', { target_user_id: currentUserId });
                if (error) throw error;
                await new Promise(r => setTimeout(r, 1000));

                if (data.success) {
                    document.getElementById('daily-remaining').textContent = (100 - data.new_daily_taps);
                    document.getElementById('total-taps').textContent = data.total_taps.toLocaleString() + ' M';
                    // document.getElementById('global-total-meters').textContent = data.global_total_meters.toLocaleString() + ' M'; // é…å»¶è¡¨ç¤ºã®ãŸã‚å³æ™‚æ›´æ–°ã—ãªã„

                    if (data.new_daily_taps >= 100) document.getElementById('repair-area').style.display = 'block';

                    if (data.reward.type === 'nothing') {
                        resultMsg.innerHTML = '<span class="text-white-50">ä½•ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸ...</span>';
                    } else if (data.reward.type === 'milestone') {
                        resultMsg.innerHTML = `<span class="text-info fw-bold">ğŸ ${data.reward.name}</span>`;
                        showReward(data.reward);
                        setTimeout(loadStats, 500);
                    } else {
                        showReward(data.reward);
                        resultMsg.innerHTML = `<span class="text-warning">ã€Œ${data.reward.name}ã€ã‚’ã‚²ãƒƒãƒˆï¼</span>`;
                        setTimeout(loadStats, 500);
                    }
                } else {
                    if (data.error === 'DAILY_LIMIT_REACHED') {
                        resultMsg.innerHTML = '<span class="text-danger">ãƒ‰ãƒªãƒ«ãŒå£Šã‚Œã¾ã—ãŸï¼ä¿®ç†ãŒå¿…è¦ã§ã™ã€‚</span>';
                    } else { resultMsg.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚'; }
                }
            } catch (err) {
                console.error('Dig error:', err); resultMsg.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
            } finally { visual.classList.remove('digging'); btn.disabled = false; isDigging = false; }
        }

        async function handleRepair() {
            if (!isAdmin) {
                alert('çš†ã•ã‚“ã®å°½åŠ›ã§å²©ç›¤ã‚’è²«ãã€ãƒ‰ãƒªãƒ«ã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ’ãƒ¼ãƒˆã—ã¾ã—ãŸã€‚\nä¿®ç†ã•ã‚Œã‚‹ã¾ã§ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
                return;
            }
            const repairCost = 100 + (currentLuckLevel * 20);
            if (!confirm(`ä¿®ç†ã—ã¾ã™ã‹ï¼Ÿ\n(è²»ç”¨: ${repairCost} ã‚³ã‚¤ãƒ³)`)) return;

            try {
                const { data, error } = await supabaseClient.rpc('repair_drill', { target_user_id: currentUserId });
                if (error) throw error;
                if (!data.success) {
                    if (data.error === 'INSUFFICIENT_COINS') alert(`ã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚\n(å¿…è¦: ${data.cost || repairCost} ã‚³ã‚¤ãƒ³)`);
                    else alert('ä¿®ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    return;
                }
                alert(`ä¿®ç†å®Œäº†ï¼\n(æ¶ˆè²»: ${data.cost} ã‚³ã‚¤ãƒ³)`);
                loadStats();
            } catch (err) { console.error('Repair error:', err); }
        }

        async function showReward(reward) {
            const content = document.getElementById('reward-content');
            let rewardHtml = '';
            if (reward.type === 'coin') {
                rewardHtml = `<div class="display-4">ğŸ’°</div><div>${reward.amount} ã‚³ã‚¤ãƒ³</div>`;
            } else if (reward.type === 'gacha_ticket') {
                rewardHtml = `<div class="display-4">ğŸ«</div><div>${reward.name}</div>`;
            } else if (reward.type === 'exchange_ticket') {
                rewardHtml = `<div class="display-4">ğŸ·ï¸</div><div>${reward.name}</div>`;
            } else if (reward.type === 'badge' || reward.type === 'milestone') {
                // ãƒãƒƒã‚¸ç”»åƒã‚’å–å¾—
                let badgeImage = '';
                if (reward.reward_id) {
                    const { data: badge } = await supabaseClient.from('badges').select('image_url, name').eq('id', reward.reward_id).maybeSingle();
                    if (badge) {
                        badgeImage = `<img src="${badge.image_url}" style="width:100px; height:100px; object-fit:contain; margin-bottom:10px;">`;
                    }
                }
                rewardHtml = `${badgeImage}<div class="fw-bold text-warning">${reward.name}</div><div class="small text-info">(é™å®šãƒãƒƒã‚¸)</div>`;
            }
            content.innerHTML = rewardHtml;
            bootstrap.Modal.getOrCreateInstance(document.getElementById('reward-modal')).show();
        }

        function createParticles() {
            const container = document.getElementById('dirt-effect');
            for (let i = 0; i < 15; i++) {
                const p = document.createElement('div'); p.className = 'particle';
                const size = Math.random() * 8 + 4; p.style.width = size + 'px'; p.style.height = size + 'px'; p.style.left = '50%';
                const tx = (Math.random() - 0.5) * 200; const ty = -Math.random() * 100 - 50;
                p.style.setProperty('--tx', tx + 'px'); p.style.setProperty('--ty', ty + 'px');
                container.appendChild(p); setTimeout(() => p.remove(), 600);
            }
        }

        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>

</html>