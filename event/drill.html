<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã»ã‚Šã»ã‚Šãƒ‰ãƒªãƒ« | ã‹ã«ã‚µãƒ¼ãƒãƒ¼</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=M+PLUS+Rounded+1c:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- Bootswatch Lux -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <style>
        :root {
            --primary-drill: #8b4513;
            --secondary-drill: #d2b48c;
            --font-title: 'Noto Serif JP', serif;
            --font-body: 'M PLUS Rounded 1c', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
            min-height: 100vh;
            color: #eee;
        }

        .page-header {
            font-family: var(--font-title);
            color: #fff;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            margin-bottom: 2rem;
        }

        .drill-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        .drill-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            display: block;
        }

        .coming-soon {
            font-size: 1.5rem;
            color: #ffc107;
            font-weight: bold;
            letter-spacing: 2px;
        }

        /* ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯ä¸­ã®è¡¨ç¤º */
        #admin-check-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }
    </style>
</head>

<body>
    <div id="admin-check-overlay">
        <div class="text-center">
            <div class="spinner-border text-warning mb-3"></div>
            <div>ç®¡ç†è€…æ¨©é™ã‚’ç¢ºèªä¸­...</div>
        </div>
    </div>

    <div class="container py-5 mt-5">
        <div class="drill-container">
            <h1 class="page-header">ğŸ—ï¸ ã»ã‚Šã»ã‚Šãƒ‰ãƒªãƒ«</h1>

            <!-- ãƒ«ãƒ¼ãƒ«èª¬æ˜ -->
            <div class="card bg-dark bg-opacity-50 border-secondary mb-4 text-start">
                <div class="card-body">
                    <h5 class="card-title text-warning">ğŸ“œ ãƒ«ãƒ¼ãƒ«èª¬æ˜</h5>
                    <ul class="mb-0 small">
                        <li>1æ—¥æœ€å¤§ <span class="badge bg-warning text-dark">100å›</span> æ˜ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</li>
                        <li>æ˜ã‚‹ãŸã³ã« <span class="text-info">ã‚³ã‚¤ãƒ³</span>ã€<span class="text-info">å¼•æ›åˆ¸</span>ã€<span
                                class="text-info">é™å®šãƒãƒƒã‚¸</span> ãŒå‡ºç¾ã™ã‚‹ã‹ã‚‚ï¼ï¼Ÿ</li>
                        <li>ã‚«ã‚¦ãƒ³ãƒˆã¯æ¯æ—¥ <span class="text-warning">åˆå‰0æ™‚ (JST)</span> ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚</li>
                    </ul>
                </div>
            </div>

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
            <div class="row g-3 mb-4">
                <div class="col-6">
                    <div class="p-3 rounded bg-white bg-opacity-10">
                        <div class="small text-white-50">ä»Šæ—¥ã®æ®‹ã‚Š</div>
                        <div id="daily-remaining" class="h3 mb-0 fw-bold">-</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="p-3 rounded bg-white bg-opacity-10">
                        <div class="small text-white-50">ç´¯è¨ˆã‚¿ãƒƒãƒ—</div>
                        <div id="total-taps" class="h3 mb-0 fw-bold">-</div>
                    </div>
                </div>
            </div>

            <!-- æ˜å‰Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="dig-area my-5">
                <div id="drill-visual" class="drill-visual">
                    <span class="drill-emoji">ğŸ—ï¸</span>
                    <div id="dirt-effect" class="dirt-effect"></div>
                </div>

                <button id="dig-button" class="btn btn-warning btn-lg rounded-pill px-5 py-3 fw-bold shadow-lg mt-4"
                    onclick="handleDig()">
                    æ˜ã‚‹ï¼
                </button>
            </div>

            <div id="result-message" class="mt-3 h5 fw-bold" style="min-height: 1.5rem;"></div>

            <div class="mt-5 pt-4 border-top border-secondary">
                <a href="../index.html" class="btn btn-outline-light rounded-pill px-4">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
            </div>
        </div>
    </div>

    <!-- å ±é…¬ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div id="reward-modal" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-warning">
                <div class="modal-body text-center py-5">
                    <h2 class="text-warning mb-4">âœ¨ ãŠå®ç™ºè¦‹ï¼ âœ¨</h2>
                    <div id="reward-content" class="h3 mb-4"></div>
                    <button type="button" class="btn btn-warning rounded-pill px-4"
                        data-bs-dismiss="modal">ã‚„ã£ãŸãƒ¼ï¼</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .drill-visual {
            font-size: 6rem;
            position: relative;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 2rem;
        }

        .drill-emoji {
            display: inline-block;
            transition: transform 0.1s;
        }

        /* æ˜å‰Šä¸­ã®æŒ¯å‹•ã¨ä¸‹é™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .digging .drill-emoji {
            animation: vibrate 0.1s infinite, descend 1s ease-in-out;
        }

        @keyframes vibrate {
            0% {
                transform: translate(1px, 1px) rotate(0deg);
            }

            10% {
                transform: translate(-1px, -2px) rotate(-1deg);
            }

            20% {
                transform: translate(-3px, 0px) rotate(1deg);
            }

            30% {
                transform: translate(3px, 2px) rotate(0deg);
            }

            40% {
                transform: translate(1px, -1px) rotate(1deg);
            }

            50% {
                transform: translate(-1px, 2px) rotate(-1deg);
            }

            60% {
                transform: translate(-3px, 1px) rotate(0deg);
            }

            70% {
                transform: translate(3px, 1px) rotate(-1deg);
            }

            80% {
                transform: translate(-1px, -1px) rotate(1deg);
            }

            90% {
                transform: translate(1px, 2px) rotate(0deg);
            }

            100% {
                transform: translate(1px, -2px) rotate(-1deg);
            }
        }

        @keyframes descend {
            0% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(20px);
            }

            100% {
                transform: translateY(0);
            }
        }

        .dirt-effect {
            position: absolute;
            bottom: 0;
            width: 100px;
            height: 20px;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: #8b4513;
            border-radius: 50%;
            opacity: 0;
            animation: particle-fly 0.5s ease-out forwards;
        }

        @keyframes particle-fly {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }

            100% {
                transform: translate(var(--tx), var(--ty));
                opacity: 0;
            }
        }
    </style>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        let currentUserId = null;
        let isDigging = false;

        // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯
        async function checkAdmin() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            const overlay = document.getElementById('admin-check-overlay');

            if (!user) {
                window.location.href = '../index.html';
                return;
            }

            currentUserId = user.user_metadata.provider_id;

            if (!ADMIN_DISCORD_IDS.includes(currentUserId)) {
                alert('ç®¡ç†è€…æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                window.location.href = '../index.html';
                return;
            }

            // ç®¡ç†è€…ãªã‚‰è¡¨ç¤º
            overlay.style.display = 'none';
            initAccordionNav('../');
            loadStats();
        }

        // çµ±è¨ˆèª­ã¿è¾¼ã¿
        async function loadStats() {
            try {
                const { data, error } = await supabaseClient
                    .from('event_drill_user_stats')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .maybeSingle();

                if (error) throw error;

                if (data) {
                    // JSTã§ã®æœ€çµ‚ã‚¿ãƒƒãƒ—æ—¥ç¢ºèª
                    const lastTap = new Date(data.last_tap_at);
                    const now = new Date();
                    const yesterdayJST = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Tokyo" }));
                    yesterdayJST.setHours(0, 0, 0, 0);

                    const dailyTaps = (lastTap < yesterdayJST) ? 0 : data.daily_taps;

                    document.getElementById('daily-remaining').textContent = (100 - dailyTaps);
                    document.getElementById('total-taps').textContent = data.total_taps.toLocaleString();
                } else {
                    document.getElementById('daily-remaining').textContent = '100';
                    document.getElementById('total-taps').textContent = '0';
                }
            } catch (err) {
                console.error('Stats load error:', err);
            }
        }

        // æ˜ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        async function handleDig() {
            if (isDigging) return;
            isDigging = true;

            const btn = document.getElementById('dig-button');
            const visual = document.getElementById('drill-visual');
            const resultMsg = document.getElementById('result-message');

            btn.disabled = true;
            visual.classList.add('digging');
            resultMsg.textContent = 'æ˜å‰Šä¸­...';
            createParticles();

            try {
                const { data, error } = await supabaseClient.rpc('process_drill_tap', {
                    target_user_id: currentUserId
                });

                if (error) throw error;

                // 2ç§’é–“å¾…æ©Ÿï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰
                await new Promise(r => setTimeout(r, 1000));

                if (data.success) {
                    // UIæ›´æ–°
                    document.getElementById('daily-remaining').textContent = (100 - data.new_daily_taps);
                    document.getElementById('total-taps').textContent = data.total_taps.toLocaleString();

                    if (data.reward.type === 'nothing') {
                        resultMsg.innerHTML = '<span class="text-white-50">ä½•ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸ...</span>';
                    } else {
                        showReward(data.reward);
                        resultMsg.innerHTML = `<span class="text-warning">ã€Œ${data.reward.name}ã€ã‚’ã‚²ãƒƒãƒˆï¼</span>`;
                    }
                } else {
                    if (data.error === 'DAILY_LIMIT_REACHED') {
                        resultMsg.innerHTML = '<span class="text-danger">ä»Šæ—¥ã®é™ç•Œï¼ˆ100å›ï¼‰ã«é”ã—ã¾ã—ãŸï¼</span>';
                    } else {
                        resultMsg.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    }
                }
            } catch (err) {
                console.error('Dig error:', err);
                resultMsg.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
            } finally {
                visual.classList.remove('digging');
                btn.disabled = false;
                isDigging = false;
            }
        }

        // å ±é…¬è¡¨ç¤º
        function showReward(reward) {
            const content = document.getElementById('reward-content');
            let rewardHtml = '';

            if (reward.type === 'coin') {
                rewardHtml = `<div class="display-4">ğŸ’°</div><div>${reward.amount} ã‚³ã‚¤ãƒ³</div>`;
            } else if (reward.type === 'ticket') {
                rewardHtml = `<div class="display-4">ğŸ«</div><div>${reward.name}</div>`;
            } else if (reward.type === 'badge') {
                rewardHtml = `<div class="display-4">ğŸ“›</div><div>${reward.name} (é™å®šãƒãƒƒã‚¸)</div>`;
            }

            content.innerHTML = rewardHtml;
            const modal = new bootstrap.Modal(document.getElementById('reward-modal'));
            modal.show();
        }

        // åœŸç…™ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function createParticles() {
            const container = document.getElementById('dirt-effect');
            for (let i = 0; i < 15; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                const size = Math.random() * 8 + 4;
                p.style.width = size + 'px';
                p.style.height = size + 'px';
                p.style.left = '50%';

                // é£›ã³æ•£ã‚‹æ–¹å‘ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«
                const tx = (Math.random() - 0.5) * 200;
                const ty = -Math.random() * 100 - 50;
                p.style.setProperty('--tx', tx + 'px');
                p.style.setProperty('--ty', ty + 'px');

                container.appendChild(p);
                setTimeout(() => p.remove(), 600);
            }
        }

        document.addEventListener('DOMContentLoaded', checkAdmin);
    </script>
</body>

</html>