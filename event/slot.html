<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒ­ãƒƒãƒˆ | ã‹ã«ã‚µãƒ¼ãƒãƒ¼</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&family=IBM+Plex+Sans+JP:wght@400;600&display=swap"
        rel="stylesheet">
    <!-- Bootswatch Lux -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <style>
        :root {
            --slot-bg: #0f141a;
            --slot-panel: #1a2230;
            --slot-accent: #f6c453;
            --slot-muted: #9aa4b2;
            --slot-font-title: 'Zen Maru Gothic', sans-serif;
            --slot-font-body: 'IBM Plex Sans JP', sans-serif;
        }

        body {
            font-family: var(--slot-font-body);
            background: radial-gradient(circle at top, #1b2433 0%, #0b0f14 60%, #07090c 100%);
            color: #e7ecf3;
            min-height: 100vh;
        }

        .slot-header {
            font-family: var(--slot-font-title);
            letter-spacing: 0.04em;
        }

        .slot-panel {
            background: var(--slot-panel);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
        }

        .slot-status {
            background: rgba(246, 196, 83, 0.12);
            border: 1px solid rgba(246, 196, 83, 0.35);
            color: #ffd36b;
            border-radius: 12px;
            padding: 10px 14px;
            font-size: 0.95rem;
        }

        .slot-muted {
            color: var(--slot-muted);
        }

        .slot-burst {
            background: rgba(220, 53, 69, 0.15);
            border: 1px solid rgba(220, 53, 69, 0.5);
            color: #ffb3b3;
            border-radius: 12px;
            padding: 12px 16px;
            font-weight: 600;
        }

        .reel-stop img {
            width: 90%;
            height: 90%;
            object-fit: contain;
            filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.5));
        }

        .free-spin-stock-bar {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 10px 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(120, 80, 220, 0.25), rgba(80, 140, 255, 0.2));
            border: 1px solid rgba(120, 80, 220, 0.4);
        }

        .free-spin-stock-bar.active {
            display: flex;
        }

        .free-spin-stock-bar .stock-label {
            font-weight: 700;
            color: #c4a1ff;
            font-size: 0.9rem;
        }

        .free-spin-stock-bar .stock-icons {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .free-spin-stock-bar .stock-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 2px solid rgba(120, 80, 220, 0.5);
            padding: 3px;
            background: rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .free-spin-stock-bar .stock-icon.filled {
            border-color: #c4a1ff;
            background: rgba(120, 80, 220, 0.4);
            box-shadow: 0 0 10px rgba(120, 80, 220, 0.5);
        }

        .free-spin-stock-bar .stock-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .free-spin-stock-bar .stock-bonus {
            color: #f6c453;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .free-spin-cutin {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            background: radial-gradient(circle at center, rgba(246, 196, 83, 0.35), rgba(9, 12, 18, 0.85));
            backdrop-filter: blur(2px);
        }

        .free-spin-cutin.show {
            display: flex;
            animation: cutin-fade 1.6s ease forwards;
        }

        .free-spin-cutin .cutin-card {
            padding: 22px 32px;
            border-radius: 18px;
            background: linear-gradient(135deg, #f8d47c 0%, #f0b741 50%, #d98c0d 100%);
            color: #1a1306;
            font-family: var(--slot-font-title);
            font-size: clamp(1.4rem, 4vw, 2.2rem);
            letter-spacing: 0.12em;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            transform: scale(0.9);
            animation: cutin-pop 0.6s ease forwards;
        }

        @keyframes cutin-pop {
            to {
                transform: scale(1);
            }
        }

        @keyframes cutin-fade {
            0% {
                opacity: 0;
            }

            15% {
                opacity: 1;
            }

            85% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        .win-popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .win-popup-overlay.show {
            display: flex;
            opacity: 1;
        }

        .win-popup-content {
            background: linear-gradient(145deg, #1f2937, #111827);
            border: 2px solid #f6c453;
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 0 40px rgba(246, 196, 83, 0.3), inset 0 0 20px rgba(246, 196, 83, 0.1);
            transform: scale(0.8) translateY(20px);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .win-popup-overlay.show .win-popup-content {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .win-popup-title {
            font-family: var(--slot-font-title);
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(to bottom, #fff6d9, #f6c453, #d98c0d);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 20px;
            filter: drop-shadow(0 4px 12px rgba(246, 196, 83, 0.5));
            letter-spacing: 0.05em;
        }

        .win-popup-rewards {
            font-size: 1.8rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .win-popup-close {
            background: linear-gradient(135deg, #f6c453 0%, #d99a29 100%);
            color: #1a1306;
            border: none;
            padding: 12px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(246, 196, 83, 0.4);
        }

        .win-popup-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(246, 196, 83, 0.6);
        }

        .reel-stage {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: clamp(10px, 1.4vw, 20px);
            width: 100%;
            --reel-size: clamp(80px, 10vw, 140px);
            margin-top: 8px;
        }

        .reel-col {
            background: rgba(255, 255, 255, 0.04);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: clamp(8px, 1.2vw, 14px) clamp(6px, 1vw, 12px);
            display: grid;
            gap: 10px;
            text-align: center;
            min-width: 0;
        }

        .reel-window {
            background: #0b0f14;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: var(--reel-size);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(2.6rem, 6vw, 5rem);
            font-weight: 700;
            position: relative;
            overflow: hidden;
        }

        .reel-symbols {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            opacity: 0;
        }

        .reel-symbols span {
            display: block;
            height: var(--reel-size);
            line-height: var(--reel-size);
            color: #cbd5e1;
            font-weight: 700;
        }

        .reel-symbols span img {
            width: 70%;
            height: 70%;
            object-fit: contain;
            vertical-align: middle;
            filter: drop-shadow(0 1px 4px rgba(0, 0, 0, 0.4));
        }

        .reel-window.spinning .reel-symbols {
            animation: reel-spin 1.6s linear infinite;
            opacity: 1;
        }

        .reel-window.stopped .reel-symbols {
            opacity: 0;
            animation: none;
        }

        .reel-stop {
            position: relative;
            z-index: 2;
            font-size: inherit;
            line-height: 1;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .reel-window.stopped .reel-stop {
            opacity: 1;
        }

        .reel-col.done .reel-window {
            box-shadow: inset 0 0 0 1px rgba(246, 196, 83, 0.5);
        }

        .reel-col.bust .reel-window {
            box-shadow: inset 0 0 0 1px rgba(220, 53, 69, 0.6);
            color: #ffb3b3;
        }

        .reel-stage.free-spin .reel-col {
            border: 1px solid rgba(246, 196, 83, 0.45);
            background: linear-gradient(160deg, rgba(246, 196, 83, 0.08), rgba(255, 255, 255, 0.04));
            box-shadow: 0 12px 26px rgba(246, 196, 83, 0.12);
        }

        .reel-stage.free-spin .reel-window {
            box-shadow: 0 0 18px rgba(246, 196, 83, 0.4), inset 0 0 12px rgba(246, 196, 83, 0.25);
            border-color: rgba(246, 196, 83, 0.5);
            animation: free-glow 2.2s ease-in-out infinite;
        }

        @keyframes free-glow {

            0%,
            100% {
                filter: drop-shadow(0 0 0 rgba(246, 196, 83, 0.2));
            }

            50% {
                filter: drop-shadow(0 0 8px rgba(246, 196, 83, 0.6));
            }
        }

        .reel-label {
            font-size: 0.8rem;
            color: var(--slot-muted);
        }

        .reel-result {
            font-size: 0.85rem;
            min-height: 1.1rem;
            color: var(--slot-muted);
        }

        .reel-btn {
            width: 100%;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid rgba(246, 196, 83, 0.6);
            background: transparent;
            color: #f6c453;
        }

        .reel-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        @keyframes reel-spin {
            0% {
                transform: translateY(calc(var(--reel-size) * -10));
            }

            100% {
                transform: translateY(0);
            }
        }

        .btn-slot {
            background: linear-gradient(135deg, #f6c453 0%, #d99a29 100%);
            color: #1a1306;
            border: none;
            font-weight: 700;
        }

        .btn-slot:disabled {
            opacity: 0.6;
        }

        .btn-slot-secondary {
            border: 1px solid rgba(246, 196, 83, 0.6);
            color: #f6c453;
            background: transparent;
            font-weight: 600;
        }

        .slot-mobile-summary {
            display: none;
        }

        @media (max-width: 768px) {
            .slot-desktop-actions {
                display: none !important;
            }

            .reel-stage {
                grid-template-columns: repeat(3, minmax(0, 1fr));
                gap: 12px;
                padding-bottom: 0;
                overflow-x: hidden;
                scroll-snap-type: none;
            }

            .reel-col {
                padding: 10px 8px;
            }

            .reel-window {
                height: clamp(88px, 24vw, 110px);
                font-size: clamp(1.9rem, 6.5vw, 2.4rem);
            }

            .reel-label {
                font-size: 0.75rem;
            }

            .reel-result {
                font-size: 0.8rem;
            }

            .slot-mobile-summary {
                display: grid;
                align-content: center;
                gap: 6px;
                padding: 12px;
                border-radius: 14px;
                background: rgba(246, 196, 83, 0.12);
                border: 1px dashed rgba(246, 196, 83, 0.35);
                color: #f7d07d;
                min-height: clamp(88px, 24vw, 110px);
                text-align: center;
                font-weight: 700;
                grid-column: 2 / span 2;
            }

            .slot-mobile-summary .slot-muted {
                color: rgba(247, 208, 125, 0.8);
                font-size: 0.75rem;
            }

            .slot-mobile-summary .slot-mobile-multiplier {
                font-size: 1.05rem;
            }

            .slot-mobile-summary .slot-mobile-total {
                font-size: 0.95rem;
            }

            .slot-mobile-actions {
                display: grid;
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 8px;
                margin-top: 4px;
            }

            .slot-mobile-actions .btn {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>

<body>
    <div class="nav-dropdown"></div>
    <div class="container-fluid py-4 px-3 px-lg-5">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
            <div>
                <h1 class="slot-header mb-2">ğŸ° æœŸé–“é™å®šã‚¤ãƒ™ãƒ³ãƒˆï¼šã‚¹ãƒ­ãƒƒãƒˆ</h1>
                <div class="slot-muted">1å›100ã‚³ã‚¤ãƒ³ã€‚æ­¢ã¾ã£ãŸåˆ†ã ã‘å ±é…¬ç¢ºå®šã€ã¯ãšã‚Œã§ãƒãƒ¼ã‚¹ãƒˆã€‚</div>
            </div>
            <div class="slot-status" id="event-status">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <div class="slot-panel p-4 mb-4">
            <div class="d-flex flex-wrap justify-content-between gap-3 align-items-center">
                <div class="d-flex flex-wrap gap-4 align-items-center">
                    <div>
                        <div class="slot-muted">æ‰€æŒã‚³ã‚¤ãƒ³</div>
                        <div class="fs-3 fw-bold" id="coin-balance">-</div>
                    </div>
                    <div>
                        <div class="slot-muted">ç¾åœ¨ãƒªãƒ¼ãƒ«</div>
                        <div class="fs-4 fw-bold" id="current-reel">-</div>
                    </div>
                    <div class="slot-muted">
                        <div>ã‚³ã‚¹ãƒˆ: <span id="slot-cost">100</span>ã‚³ã‚¤ãƒ³ / å›</div>
                        <div>ãƒªãƒ¼ãƒ«: 7æœ¬ / åœæ­¢ä½ç½® 10</div>
                    </div>
                </div>
                <div class="text-center flex-grow-1" style="min-width: 220px;">
                    <div class="slot-muted">åˆè¨ˆå€ç‡</div>
                    <div class="fs-5 fw-semibold" id="total-multiplier">Ã—1.0</div>
                    <div class="slot-muted mt-1">ç²å¾—åˆè¨ˆ</div>
                    <div class="fs-2 fw-bold" id="reward-total">ğŸª™ 0 / ğŸ« 0 / ğŸ§§ 0</div>
                </div>
                <div class="d-flex flex-wrap gap-2 slot-desktop-actions">
                    <button class="btn btn-slot" id="btn-start" onclick="startSession()">é–‹å§‹ï¼ˆ100ã‚³ã‚¤ãƒ³æ¶ˆè²»ï¼‰</button>
                    <button class="btn btn-slot d-none" id="btn-jackpot-confirm" onclick="confirmJackpot()"
                        disabled>ãƒ•ãƒªãƒ¼ã‚¹ãƒ”ãƒ³ã¸ç¢ºå®š</button>
                    <button class="btn btn-slot-secondary" id="btn-stop" onclick="cashout()" disabled>ã‚¹ãƒˆãƒƒãƒ—ï¼ˆç²¾ç®—ï¼‰</button>
                </div>
            </div>
            <div class="mt-3 slot-muted" id="session-message"></div>
        </div>

        <div class="slot-panel p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">åœæ­¢çµæœ</h5>
                <span class="slot-muted" id="session-status">å¾…æ©Ÿä¸­</span>
            </div>
            <div class="free-spin-stock-bar" id="free-spin-stock-bar">
                <span class="stock-label">FREE SPIN ã‚¹ãƒˆãƒƒã‚¯</span>
                <div class="stock-icons" id="free-spin-stock-icons"></div>
                <span class="stock-bonus" id="free-spin-stock-bonus"></span>
            </div>
            <div class="reel-stage" id="reel-stage">
                <div class="slot-mobile-summary" id="mobile-summary">
                    <div class="slot-muted">åˆè¨ˆå€ç‡</div>
                    <div class="slot-mobile-multiplier" id="mobile-total-multiplier">Ã—1.0</div>
                    <div class="slot-muted">ç²å¾—åˆè¨ˆ</div>
                    <div class="slot-mobile-total" id="mobile-reward-total">ğŸª™ 0 / ğŸ« 0 / ğŸ§§ 0</div>
                    <div class="slot-mobile-actions">
                        <button class="btn btn-slot" id="mobile-btn-start" type="button"
                            onclick="startSession()">é–‹å§‹</button>
                        <button class="btn btn-slot-secondary" id="mobile-btn-stop" type="button" onclick="cashout()"
                            disabled>ã‚¹ãƒˆãƒƒãƒ—</button>
                    </div>
                </div>
            </div>
            <div class="mt-4" id="payout-summary" style="display:none;">
                <h6 class="mb-2">ç²¾ç®—çµæœ</h6>
                <div class="slot-panel p-3" id="payout-list"></div>
            </div>
            <div class="mt-4 slot-burst" id="burst-banner" style="display:none;">ãƒãƒ¼ã‚¹ãƒˆï¼å ±é…¬ã¯ã™ã¹ã¦æ²¡åã•ã‚Œã¾ã—ãŸã€‚</div>
        </div>

        <div class="win-popup-overlay" id="win-popup">
            <div class="win-popup-content">
                <div class="win-popup-title">WIN!</div>
                <div class="win-popup-rewards" id="win-popup-rewards"></div>
                <button class="win-popup-close" onclick="closeWinPopup()">é–‰ã˜ã‚‹</button>
            </div>
        </div>

        <div class="slot-panel p-4 mt-4 admin-only" id="slot-admin-panel" style="display:none;">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                <h5 class="mb-0">ç®¡ç†è€…: ãƒªãƒ¼ãƒ«ç·¨é›†</h5>
                <span class="slot-muted">ç®¡ç†è€…ã®ã¿è¡¨ç¤º</span>
            </div>
            <div class="d-flex flex-wrap align-items-center gap-2">
                <label class="slot-muted" for="admin-reel-mode">ç¨®åˆ¥</label>
                <select id="admin-reel-mode" class="form-select form-select-sm" style="width: 150px;">
                    <option value="normal">é€šå¸¸ãƒªãƒ¼ãƒ«</option>
                    <option value="free">ãƒ•ãƒªãƒ¼ã‚¹ãƒ”ãƒ³</option>
                </select>
                <label class="slot-muted" for="admin-reel-select">å¯¾è±¡ãƒªãƒ¼ãƒ«</label>
                <select id="admin-reel-select" class="form-select form-select-sm" style="width: 120px;"></select>
                <button class="btn btn-sm btn-outline-light" id="admin-reel-load" type="button">èª­ã¿è¾¼ã¿</button>
                <button class="btn btn-sm btn-slot" id="admin-reel-save" type="button">ä¿å­˜</button>
                <span class="slot-muted" id="admin-reel-status"></span>
            </div>
            <div class="table-responsive mt-3">
                <table class="table table-sm table-dark align-middle mb-0">
                    <thead>
                        <tr>
                            <th style="width: 70px;">ä½ç½®</th>
                            <th style="width: 80px;">æœ‰åŠ¹</th>
                            <th style="width: 90px;" data-admin-col="bust">ãƒãƒ¼ã‚¹ãƒˆ</th>
                            <th style="width: 110px;" data-admin-col="jackpot">ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆ</th>
                            <th style="width: 90px;" data-admin-col="fsstock">FS Stock</th>
                            <th style="width: 160px;">å ±é…¬ã‚¿ã‚¤ãƒ—</th>
                            <th>å ±é…¬å</th>
                            <th style="width: 110px;">æ•°é‡</th>
                            <th style="width: 160px;">å ±é…¬ID</th>
                        </tr>
                    </thead>
                    <tbody id="admin-reel-body"></tbody>
                </table>
            </div>
            <div class="slot-muted mt-2">â€» ãƒãƒ¼ã‚¹ãƒˆONã®è¡Œã¯å ±é…¬ãŒç„¡è¦–ã•ã‚Œã¾ã™ã€‚</div>
        </div>

        <div class="slot-panel p-4 mt-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                <h5 class="mb-0">å…¨ä½“çµ±è¨ˆ</h5>
                <span class="slot-muted" id="slot-stats-updated">é›†è¨ˆä¸­...</span>
            </div>
            <div class="row g-3 mb-3">
                <div class="col-12">
                    <h6 class="mb-2">ã‚ãªãŸã®æˆç¸¾</h6>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="slot-muted">å›è»¢æ•°</div>
                    <div class="fs-5 fw-semibold" id="slot-user-spins">-</div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="slot-muted">ç´¯è¨ˆã‚³ã‚¤ãƒ³</div>
                    <div class="fs-5 fw-semibold" id="slot-user-coin">-</div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="slot-muted">ç´¯è¨ˆãƒã‚±ãƒƒãƒˆ</div>
                    <div class="fs-5 fw-semibold" id="slot-user-tickets">-</div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="slot-muted">FSçªå…¥å›æ•°</div>
                    <div class="fs-5 fw-semibold" id="slot-user-fs">-</div>
                </div>
            </div>
            <div class="row g-3 mb-3">
                <div class="col-6 col-lg-3">
                    <div class="slot-muted">ç´¯è¨ˆå›è»¢æ•°</div>
                    <div class="fs-5 fw-semibold" id="slot-total-spins">-</div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="slot-muted">FSå›è»¢æ•°</div>
                    <div class="fs-5 fw-semibold" id="slot-fs-spins">-</div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="slot-muted">ç´¯è¨ˆã‚³ã‚¤ãƒ³</div>
                    <div class="fs-5 fw-semibold" id="slot-total-coin">-</div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="slot-muted">ç´¯è¨ˆãƒã‚±ãƒƒãƒˆ</div>
                    <div class="fs-5 fw-semibold" id="slot-total-tickets">-</div>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-12 col-lg-6">
                    <h6 class="mb-2">JPå ±é…¬ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h6>
                    <div class="slot-muted mb-2">JPã§ç²å¾—ã—ãŸå ±é…¬åˆè¨ˆï¼ˆã‚³ã‚¤ãƒ³æ›ç®—ã¯è¡Œã„ã¾ã›ã‚“ï¼‰</div>
                    <ol class="mb-0" id="slot-jp-ranking"></ol>
                </div>
                <div class="col-12 col-lg-6">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">JPä¸€æ’ƒç²å¾—TOP3</h6>
                        <div class="btn-group btn-group-sm" role="group" id="slot-jp-top-toggle">
                            <button type="button" class="btn btn-outline-light active" data-jp-type="coin">ã‚³ã‚¤ãƒ³</button>
                            <button type="button" class="btn btn-outline-light" data-jp-type="gacha_ticket">ç¥ˆé¡˜ç¬¦</button>
                            <button type="button" class="btn btn-outline-light" data-jp-type="mangan_ticket">æº€é¡˜ç¬¦</button>
                        </div>
                    </div>
                    <ol class="mb-0" id="slot-jp-top3"></ol>
                </div>
            </div>
        </div>
    </div>

    <div class="free-spin-cutin" id="free-spin-cutin">
        <div class="cutin-card">FREE SPIN!!</div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/auth-guard.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        let currentUserId = null;
        let isAdmin = false;
        let currentSession = null;
        let eventSettings = null;
        let isProcessing = false;
        let wasFreeSpinActive = false;
        let pendingFreeSpinCutin = false;
        let freeSpinDisplayActive = false;
        let lastFreeSpinSummary = null;
        let lastFreeSpinSessionId = null;
        let lastFreeSpinsRemaining = null;
        let pendingFreeSpinPlusCutin = false;
        let pendingFreeSpinPlusAmount = 0;
        let displayedFreeSpinsRemaining = null;
        const CUTIN_DURATION_MS = 1600;
        const JACKPOT_SYMBOL = '<img src="../images/slot/JACKPOT.png" alt="JACKPOT">';
        const BURST_SYMBOL = '<img src="../images/slot/Burst.png" alt="Burst">';
        const FREESPIN_SYMBOL = '<img src="../images/slot/FreeSpin.png" alt="FreeSpin">';

        function getMultiplierEmoji(amount) {
            const val = Number(amount) || 0;
            if (val >= 1.0) return 'ğŸŒˆ';
            if (val >= 0.7) return 'ğŸ’';
            if (val >= 0.4) return 'ğŸ‰';
            return 'ğŸ‡';
        }

        const reelSymbols = [
            'ğŸª™',
            JACKPOT_SYMBOL,
            'ï¿½',
            BURST_SYMBOL,
            'ğŸ‰',
            FREESPIN_SYMBOL,
            'ğŸ’',
            'ğŸŒˆ',
            'ğŸ«',
            JACKPOT_SYMBOL
        ];

        async function initSlotPage() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) {
                window.location.href = '../index.html';
                return;
            }

            currentUserId = user.user_metadata.provider_id;
            isAdmin = typeof ADMIN_DISCORD_IDS !== 'undefined' && ADMIN_DISCORD_IDS.includes(currentUserId);
            initAccordionNav('../');
            buildReelStage();
            setupAdminReelEditor();

            await loadEventSettings();
            await refreshCoinBalance();
            await loadActiveSession();
            updateUI();
            await loadSlotGlobalStats();
        }

        async function loadEventSettings() {
            const statusEl = document.getElementById('event-status');
            try {
                const { data, error } = await supabaseClient
                    .from('page_settings')
                    .select('is_active, config')
                    .eq('path', '/event/slot.html')
                    .maybeSingle();
                if (error) throw error;

                const config = data?.config || {};
                eventSettings = {
                    page_active: data?.is_active ?? false,
                    cost: config.slot_cost ?? 100
                };

                const label = eventSettings.page_active ? 'ã‚¤ãƒ™ãƒ³ãƒˆé–‹å‚¬ä¸­' : 'ã‚¤ãƒ™ãƒ³ãƒˆåœæ­¢ä¸­';
                statusEl.textContent = label;
                document.getElementById('slot-cost').textContent = eventSettings.cost;
            } catch (err) {
                statusEl.textContent = 'è¨­å®šå–å¾—ã«å¤±æ•—';
                console.error(err);
            }
        }

        async function refreshCoinBalance() {
            const coinEl = document.getElementById('coin-balance');
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('coins')
                    .eq('discord_user_id', currentUserId)
                    .maybeSingle();
                if (error) throw error;
                coinEl.textContent = `${(data?.coins ?? 0).toLocaleString()} C`;
            } catch (err) {
                coinEl.textContent = 'å–å¾—å¤±æ•—';
                console.error(err);
            }
        }

        async function loadActiveSession() {
            try {
                const { data, error } = await supabaseClient.rpc('slot_get_state', {
                    p_user_id: currentUserId
                });
                if (error) throw error;
                if (data?.session) {
                    currentSession = {
                        ...data.session,
                        reels: data.reels || []
                    };
                } else {
                    currentSession = null;
                }
            } catch (err) {
                console.error(err);
            }
        }

        function setProcessing(state) {
            isProcessing = state;
            document.getElementById('btn-start').disabled = state;
            document.getElementById('btn-stop').disabled = state || !currentSession || currentSession.status !== 'active' || currentSession.free_spin_active || (currentSession.reels || []).length === 0;
            const jackpotBtn = document.getElementById('btn-jackpot-confirm');
            if (jackpotBtn) jackpotBtn.disabled = state || !currentSession || !currentSession.jackpot_unlocked || currentSession.free_spin_confirmed;
            const mobileStart = document.getElementById('mobile-btn-start');
            const mobileStop = document.getElementById('mobile-btn-stop');
            if (mobileStart) mobileStart.disabled = state || !isEventActiveNow() || (currentSession && currentSession.status === 'active');
            if (mobileStop) mobileStop.disabled = state || !currentSession || currentSession.status !== 'active' || currentSession.free_spin_active || (currentSession.reels || []).length === 0;
            updateReelButtons();
        }

        function isEventActiveNow() {
            if (isAdmin) return true;
            if (!eventSettings) return false;
            if (eventSettings.page_active) return true;
            if (!eventSettings.is_active) return false;
            return true;
        }

        function isSpinLocked() {
            return lastSpinReel !== null && Date.now() < spinLockUntil;
        }

        function updateUI() {
            const reels = currentSession?.reels || [];
            const currentReelEl = document.getElementById('current-reel');
            const sessionStatusEl = document.getElementById('session-status');
            const stageEl = document.getElementById('reel-stage');
            const payoutSummary = document.getElementById('payout-summary');
            const payoutList = document.getElementById('payout-list');
            const burstBanner = document.getElementById('burst-banner');
            const messageEl = document.getElementById('session-message');
            const totalEl = document.getElementById('reward-total');
            const multiplierEl = document.getElementById('total-multiplier');
            const mobileMultiplierEl = document.getElementById('mobile-total-multiplier');
            const mobileTotalEl = document.getElementById('mobile-reward-total');
            const spinLocked = isSpinLocked();

            if (!currentSession) {
                currentReelEl.textContent = '-';
                sessionStatusEl.textContent = 'å¾…æ©Ÿä¸­';
                messageEl.textContent = '';
                payoutSummary.style.display = 'none';
                burstBanner.style.display = 'none';
                if (stageEl) stageEl.classList.remove('free-spin');
                wasFreeSpinActive = false;
                pendingFreeSpinCutin = false;
                freeSpinDisplayActive = false;
                lastFreeSpinSummary = null;
                lastFreeSpinSessionId = null;
                lastFreeSpinsRemaining = null;
                pendingFreeSpinPlusCutin = false;
                pendingFreeSpinPlusAmount = 0;
                displayedFreeSpinsRemaining = null;
                // no jackpot stage
                setProcessing(false);
                document.getElementById('btn-start').disabled = !isEventActiveNow();
                const mobileStart = document.getElementById('mobile-btn-start');
                const mobileStop = document.getElementById('mobile-btn-stop');
                if (mobileStart) mobileStart.disabled = !isEventActiveNow();
                if (mobileStop) mobileStop.disabled = true;
                document.getElementById('btn-stop').disabled = true;
                const jackpotBtn = document.getElementById('btn-jackpot-confirm');
                if (jackpotBtn) jackpotBtn.disabled = true;
                renderReelState(reels);
                updateReelButtons();
                if (multiplierEl) multiplierEl.textContent = 'Ã—1.0';
                if (mobileMultiplierEl) mobileMultiplierEl.textContent = 'Ã—1.0';
                if (totalEl) totalEl.textContent = 'ğŸª™ 0 / ğŸ« 0 / ğŸ§§ 0';
                if (mobileTotalEl) mobileTotalEl.textContent = 'ğŸª™ 0 / ğŸ« 0 / ğŸ§§ 0';
                return;
            }

            if (!spinLocked) {
                if (currentSession.status === 'active') {
                    if (currentSession.free_spin_active && freeSpinDisplayActive) {
                        currentReelEl.textContent = `ãƒ•ãƒªãƒ¼ã‚¹ãƒ”ãƒ³ ${currentSession.free_spin_round} / æ®‹ã‚Š ${currentSession.free_spins_remaining} å›`;
                    } else {
                        currentReelEl.textContent = `ç¬¬ ${currentSession.current_reel} ãƒªãƒ¼ãƒ«`;
                    }
                } else {
                    currentReelEl.textContent = 'çµ‚äº†';
                }
                sessionStatusEl.textContent = currentSession.status === 'active' ? 'é€²è¡Œä¸­' : (currentSession.status === 'bust' ? 'ãƒãƒ¼ã‚¹ãƒˆ' : 'ç²¾ç®—æ¸ˆã¿');
            }

            renderReelState(reels);

            burstBanner.style.display = currentSession.status === 'bust' ? 'block' : 'none';
            payoutSummary.style.display = 'none';
            payoutList.innerHTML = '';

            if (!wasFreeSpinActive && currentSession.free_spin_active) {
                if (spinLocked) {
                    pendingFreeSpinCutin = true;
                } else {
                    pendingFreeSpinCutin = true;
                }
            }

            if (lastFreeSpinsRemaining !== null && currentSession.free_spins_remaining > lastFreeSpinsRemaining) {
                const delta = currentSession.free_spins_remaining - lastFreeSpinsRemaining;
                if (spinLocked) {
                    pendingFreeSpinPlusCutin = true;
                    pendingFreeSpinPlusAmount = delta;
                } else if (!pendingFreeSpinPlusCutin) {
                    showFreeSpinPlusCutin(delta);
                }
            }

            if (!spinLocked && pendingFreeSpinCutin && currentSession.free_spin_active && !freeSpinDisplayActive) {
                showFreeSpinCutin();
                pendingFreeSpinCutin = false;
                setTimeout(() => {
                    freeSpinDisplayActive = true;
                    const stage = document.getElementById('reel-stage');
                    if (stage) stage.classList.add('free-spin');
                }, CUTIN_DURATION_MS);
            }

            if (!spinLocked && pendingFreeSpinPlusCutin) {
                const amount = pendingFreeSpinPlusAmount || 1;
                showFreeSpinPlusCutin(amount);
                pendingFreeSpinPlusCutin = false;
                pendingFreeSpinPlusAmount = 0;
            }

            if (!currentSession.free_spin_active) {
                freeSpinDisplayActive = false;
                if (stageEl) stageEl.classList.remove('free-spin');
            } else if (freeSpinDisplayActive && stageEl) {
                stageEl.classList.add('free-spin');
            }

            if (lastFreeSpinSessionId && currentSession.id !== lastFreeSpinSessionId) {
                lastFreeSpinSummary = null;
                lastFreeSpinSessionId = null;
                lastFreeSpinsRemaining = null;
            }

            wasFreeSpinActive = !!currentSession.free_spin_active;
            lastFreeSpinsRemaining = currentSession.free_spins_remaining ?? lastFreeSpinsRemaining;

            if (!currentSession.free_spin_active && lastFreeSpinSessionId === currentSession.id) {
                const freeReels = (currentSession.reels || []).filter(reel => reel.is_free_spin || Number(reel.free_spin_round || 0) > 0);
                if (freeReels.length) {
                    let multiplierSum = 0;
                    const totals = { coin: 0, gacha_ticket: 0, mangan_ticket: 0 };
                    freeReels.forEach(reel => {
                        if (reel.reward_type === 'multiplier') {
                            multiplierSum += Number.parseFloat(reel.amount || 0) || 0;
                        } else if (!reel.is_bust) {
                            if (reel.reward_type === 'coin') totals.coin += Number(reel.amount || 0);
                            if (reel.reward_type === 'gacha_ticket') totals.gacha_ticket += Number(reel.amount || 0);
                            if (reel.reward_type === 'mangan_ticket') totals.mangan_ticket += Number(reel.amount || 0);
                        }
                    });
                    const mult = 1 + multiplierSum;
                    const formatted = mult.toFixed(2).replace(/\.0+$/, '').replace(/(\.\d*[1-9])0+$/, '$1');
                    lastFreeSpinSummary = {
                        multiplierText: `Ã—${formatted}`,
                        totalsText: `ğŸª™ ${totals.coin} / ğŸ« ${totals.gacha_ticket} / ğŸ§§ ${totals.mangan_ticket}`
                    };
                }
            }

            if (spinLocked) {
                sessionStatusEl.textContent = 'å›è»¢ä¸­';
                burstBanner.style.display = 'none';
            }

            if (currentSession.status === 'cashed_out' && !spinLocked) {
                payoutSummary.style.display = 'block';
                const payoutItems = currentSession.payout || [];
                const totals = { coin: 0, gacha_ticket: 0, mangan_ticket: 0, exchange_ticket: 0 };
                let multiplierLabel = '';
                payoutItems.forEach(item => {
                    if (!item?.type) return;
                    if (item.type === 'multiplier') {
                        multiplierLabel = item.reward_name || `${item.amount || ''}å€`;
                        return;
                    }
                    totals[item.type] = (totals[item.type] || 0) + Number(item.amount || 0);
                });
                const parts = [];
                if (multiplierLabel) parts.push(`âœ¨ ${multiplierLabel}`);
                if (totals.coin) parts.push(`ğŸª™ +${totals.coin}`);
                if (totals.gacha_ticket) parts.push(`ğŸ« +${totals.gacha_ticket}`);
                if (totals.mangan_ticket) parts.push(`ğŸ§§ +${totals.mangan_ticket}`);
                if (totals.exchange_ticket) parts.push(`ğŸ« +${totals.exchange_ticket}`);
                if (!parts.length) {
                    const freeReels = (currentSession.reels || []).filter(reel => reel.is_free_spin || Number(reel.free_spin_round || 0) > 0);
                    if (freeReels.length) {
                        let multiplierSum = 0;
                        const fallTotals = { coin: 0, gacha_ticket: 0, mangan_ticket: 0 };
                        freeReels.forEach(reel => {
                            if (reel.reward_type === 'multiplier') {
                                multiplierSum += Number.parseFloat(reel.amount || 0) || 0;
                            } else if (!reel.is_bust) {
                                if (reel.reward_type === 'coin') fallTotals.coin += Number(reel.amount || 0);
                                if (reel.reward_type === 'gacha_ticket') fallTotals.gacha_ticket += Number(reel.amount || 0);
                                if (reel.reward_type === 'mangan_ticket') fallTotals.mangan_ticket += Number(reel.amount || 0);
                            }
                        });
                        const fallParts = [];
                        if (multiplierSum > 0) {
                            const mult = 1 + multiplierSum;
                            const formatted = mult.toFixed(2).replace(/\.0+$/, '').replace(/(\.\d*[1-9])0+$/, '$1');
                            fallParts.push(`âœ¨ Ã—${formatted}`);
                        }
                        if (fallTotals.coin) fallParts.push(`ğŸª™ +${fallTotals.coin}`);
                        if (fallTotals.gacha_ticket) fallParts.push(`ğŸ« +${fallTotals.gacha_ticket}`);
                        if (fallTotals.mangan_ticket) fallParts.push(`ğŸ§§ +${fallTotals.mangan_ticket}`);
                        payoutList.innerHTML = fallParts.length ? fallParts.join(' / ') : 'å ±é…¬ãªã—';
                    } else if (lastFreeSpinSummary && lastFreeSpinSessionId === currentSession.id) {
                        const fallbackParts = [];
                        if (lastFreeSpinSummary.multiplierText) fallbackParts.push(`âœ¨ ${lastFreeSpinSummary.multiplierText}`);
                        if (lastFreeSpinSummary.totalsText) fallbackParts.push(lastFreeSpinSummary.totalsText);
                        payoutList.innerHTML = fallbackParts.length ? fallbackParts.join(' / ') : 'å ±é…¬ãªã—';
                    } else {
                        payoutList.innerHTML = 'å ±é…¬ãªã—';
                    }
                } else {
                    payoutList.innerHTML = parts.length ? parts.join(' / ') : 'å ±é…¬ãªã—';
                }

                if (!sessionCashedOutDisplayed) {
                    if (parts.length) {
                        showWinPopup(parts);
                        sessionCashedOutDisplayed = true;
                    }
                }
            } else {
                sessionCashedOutDisplayed = false;
            }

            if (!currentSession.free_spin_active && !spinLocked) {
                messageEl.textContent = '';
            }
            const stopBtn = document.getElementById('btn-stop');
            const mobileStopBtn = document.getElementById('mobile-btn-stop');
            const hideStop = !!currentSession.free_spin_active;
            if (stopBtn) stopBtn.style.display = hideStop ? 'none' : '';
            if (mobileStopBtn) mobileStopBtn.style.display = hideStop ? 'none' : '';
            if (spinLocked) {
                setProcessing(true);
                document.getElementById('btn-start').disabled = true;
                const jackpotBtn = document.getElementById('btn-jackpot-confirm');
                if (jackpotBtn) jackpotBtn.disabled = true;
                const mobileStart = document.getElementById('mobile-btn-start');
                const mobileStop = document.getElementById('mobile-btn-stop');
                if (mobileStart) mobileStart.disabled = true;
                if (mobileStop) mobileStop.disabled = true;
                updateReelButtons();
            } else {
                setProcessing(false);
                document.getElementById('btn-start').disabled = currentSession.status === 'active' || !isEventActiveNow();
                const jackpotBtn = document.getElementById('btn-jackpot-confirm');
                if (jackpotBtn) jackpotBtn.disabled = !currentSession.jackpot_unlocked || currentSession.free_spin_confirmed;
                const mobileStart = document.getElementById('mobile-btn-start');
                const mobileStop = document.getElementById('mobile-btn-stop');
                if (mobileStart) mobileStart.disabled = currentSession.status === 'active' || !isEventActiveNow();
                if (mobileStop) mobileStop.disabled = currentSession.status !== 'active' || currentSession.free_spin_active || (currentSession.reels || []).length === 0;
                updateReelButtons();
            }

            if (!spinLocked) {
                const enteringFreeSpin = !!currentSession.free_spin_active && !freeSpinDisplayActive;
                if (enteringFreeSpin) {
                    if (multiplierEl) multiplierEl.textContent = 'Ã—1.0';
                    if (mobileMultiplierEl) mobileMultiplierEl.textContent = 'Ã—1.0';
                    const resetText = 'ğŸª™ 0 / ğŸ« 0 / ğŸ§§ 0';
                    if (totalEl) totalEl.textContent = resetText;
                    if (mobileTotalEl) mobileTotalEl.textContent = resetText;
                } else {
                    const displayFreeSpin = !!currentSession.free_spin_active && freeSpinDisplayActive;
                    const displayReels = displayFreeSpin ? reels.filter(reel => reel.is_free_spin) : reels.filter(reel => !reel.is_free_spin);

                    const multiplierSum = displayReels.reduce((sum, reel) => {
                        if (reel.reward_type !== 'multiplier') return sum;
                        return sum + (Number.parseFloat(reel.amount || 0) || 0);
                    }, 0);
                    const totalMultiplier = 1 + multiplierSum;
                    const formatted = totalMultiplier.toFixed(2).replace(/\.0+$/, '').replace(/(\.\d*[1-9])0+$/, '$1');
                    if (displayFreeSpin) {
                        lastFreeSpinSummary = {
                            multiplierText: `Ã—${formatted}`,
                            totalsText: null
                        };
                        lastFreeSpinSessionId = currentSession.id;
                    }

                    const totals = { coin: 0, gacha_ticket: 0, mangan_ticket: 0 };
                    displayReels.forEach(reel => {
                        if (reel.is_bust) return;
                        if (reel.reward_type === 'coin') totals.coin += Number(reel.amount || 0);
                        if (reel.reward_type === 'gacha_ticket') totals.gacha_ticket += Number(reel.amount || 0);
                        if (reel.reward_type === 'mangan_ticket') totals.mangan_ticket += Number(reel.amount || 0);
                    });
                    const totalText = `ğŸª™ ${totals.coin} / ğŸ« ${totals.gacha_ticket} / ğŸ§§ ${totals.mangan_ticket}`;
                    if (displayFreeSpin) {
                        if (lastFreeSpinSummary) lastFreeSpinSummary.totalsText = totalText;
                    }

                    if (!currentSession.free_spin_active && lastFreeSpinSummary && lastFreeSpinSessionId === currentSession.id) {
                        if (multiplierEl) multiplierEl.textContent = lastFreeSpinSummary.multiplierText || 'Ã—1.0';
                        if (mobileMultiplierEl) mobileMultiplierEl.textContent = lastFreeSpinSummary.multiplierText || 'Ã—1.0';
                        if (totalEl) totalEl.textContent = lastFreeSpinSummary.totalsText || 'ğŸª™ 0 / ğŸ« 0 / ğŸ§§ 0';
                        if (mobileTotalEl) mobileTotalEl.textContent = lastFreeSpinSummary.totalsText || 'ğŸª™ 0 / ğŸ« 0 / ğŸ§§ 0';
                    } else {
                        if (multiplierEl) multiplierEl.textContent = `Ã—${formatted}`;
                        if (mobileMultiplierEl) mobileMultiplierEl.textContent = `Ã—${formatted}`;
                        if (totalEl) totalEl.textContent = totalText;
                        if (mobileTotalEl) mobileTotalEl.textContent = totalText;
                    }
                }
            }

            if (currentSession.free_spin_active && freeSpinDisplayActive && !spinLocked) {
                if (displayedFreeSpinsRemaining === null || displayedFreeSpinsRemaining !== currentSession.free_spins_remaining) {
                    displayedFreeSpinsRemaining = currentSession.free_spins_remaining;
                }
                messageEl.textContent = `ğŸ° ãƒ•ãƒªãƒ¼ã‚¹ãƒ”ãƒ³æ®‹ã‚Š ${displayedFreeSpinsRemaining} å›`;
            }
            updateFreeSpinStockBar();
        }

        let previousStocks = 0;

        function updateFreeSpinStockBar() {
            const bar = document.getElementById('free-spin-stock-bar');
            const icons = document.getElementById('free-spin-stock-icons');
            const bonus = document.getElementById('free-spin-stock-bonus');
            if (!bar || !icons) return;

            const isFree = currentSession?.free_spin_active;
            if (!isFree || !freeSpinDisplayActive) {
                bar.classList.remove('active');
                if (!isFree) previousStocks = 0;
                return;
            }
            bar.classList.add('active');

            const spinLocked = isSpinLocked();
            const targetStocks = currentSession?.free_spin_stocks ?? 0;
            const displayStocks = spinLocked ? previousStocks : targetStocks;
            if (!spinLocked) previousStocks = targetStocks;

            let html = '';
            for (let i = 0; i < 3; i++) {
                const filled = i < displayStocks ? 'filled' : '';
                html += `<div class="stock-icon ${filled}"><img src="../images/slot/FreeSpin.png" alt="FS"></div>`;
            }
            icons.innerHTML = html;
            if (bonus) bonus.textContent = displayStocks >= 3 ? 'â†’ +1 ã‚¹ãƒ”ãƒ³ï¼' : `${displayStocks} / 3`;
        }

        let sessionCashedOutDisplayed = false;

        function showWinPopup(parts) {
            const popup = document.getElementById('win-popup');
            const rewardsContainer = document.getElementById('win-popup-rewards');
            if (!popup || !rewardsContainer) return;

            if (parts.length === 0) {
                rewardsContainer.innerHTML = '<div>å ±é…¬ãªã—</div>';
            } else {
                rewardsContainer.innerHTML = parts.map(p => `<div>${p}</div>`).join('');
            }
            popup.classList.add('show');
        }

        async function loadSlotGlobalStats() {
            const updatedEl = document.getElementById('slot-stats-updated');
            const totalSpinsEl = document.getElementById('slot-total-spins');
            const fsSpinsEl = document.getElementById('slot-fs-spins');
            const totalCoinEl = document.getElementById('slot-total-coin');
            const totalTicketsEl = document.getElementById('slot-total-tickets');
            const jpRankingEl = document.getElementById('slot-jp-ranking');
            const jpTopEl = document.getElementById('slot-jp-top3');
            const userSpinsEl = document.getElementById('slot-user-spins');
            const userCoinEl = document.getElementById('slot-user-coin');
            const userTicketsEl = document.getElementById('slot-user-tickets');
            const userFsEl = document.getElementById('slot-user-fs');

            try {
                if (updatedEl) updatedEl.textContent = 'é›†è¨ˆä¸­...';
                const { data, error } = await supabaseClient
                    .from('slot_sessions')
                    .select('user_id, account_name, reels_state, payout_summary, jackpot_hits, status');
                if (error) throw error;

                let totalSpins = 0;
                let fsSpins = 0;
                let totalCoin = 0;
                let totalGacha = 0;
                let totalMangan = 0;

                let userSpins = 0;
                let userFs = 0;
                let userCoin = 0;
                let userGacha = 0;
                let userMangan = 0;

                const jpUserTotals = new Map();
                const jpTopByType = { coin: [], gacha_ticket: [], mangan_ticket: [] };

                (data || []).forEach(row => {
                    const reels = Array.isArray(row.reels_state) ? row.reels_state : [];
                    totalSpins += reels.length;
                    fsSpins += reels.filter(r => r.is_free_spin || Number(r.free_spin_round || 0) > 0).length;

                    const payout = Array.isArray(row.payout_summary) ? row.payout_summary : [];
                    let rowCoin = 0;
                    let rowGacha = 0;
                    let rowMangan = 0;
                    payout.forEach(item => {
                        if (!item?.type) return;
                        const amount = Number(item.amount || 0);
                        if (item.type === 'coin') rowCoin += amount;
                        if (item.type === 'gacha_ticket') rowGacha += amount;
                        if (item.type === 'mangan_ticket') rowMangan += amount;
                    });
                    totalCoin += rowCoin;
                    totalGacha += rowGacha;
                    totalMangan += rowMangan;

                    if (row.user_id === currentUserId) {
                        userSpins += reels.length;
                        userFs += reels.some(r => r.is_free_spin || Number(r.free_spin_round || 0) > 0) ? 1 : 0;
                        userCoin += rowCoin;
                        userGacha += rowGacha;
                        userMangan += rowMangan;
                    }

                    if ((row.jackpot_hits || 0) >= 3 && row.status === 'cashed_out') {
                        const key = row.user_id || 'unknown';
                        const prev = jpUserTotals.get(key) || { name: row.account_name || row.user_id || 'unknown', coin: 0, gacha: 0, mangan: 0 };
                        prev.coin += rowCoin;
                        prev.gacha += rowGacha;
                        prev.mangan += rowMangan;
                        jpUserTotals.set(key, prev);

                        if (rowCoin > 0) jpTopByType.coin.push({ name: prev.name, amount: rowCoin });
                        if (rowGacha > 0) jpTopByType.gacha_ticket.push({ name: prev.name, amount: rowGacha });
                        if (rowMangan > 0) jpTopByType.mangan_ticket.push({ name: prev.name, amount: rowMangan });
                    }
                });

                if (totalSpinsEl) totalSpinsEl.textContent = totalSpins.toLocaleString();
                if (fsSpinsEl) fsSpinsEl.textContent = fsSpins.toLocaleString();
                if (totalCoinEl) totalCoinEl.textContent = `ğŸª™ ${totalCoin.toLocaleString()}`;
                if (totalTicketsEl) totalTicketsEl.textContent = `ğŸ« ${totalGacha.toLocaleString()} / ğŸ§§ ${totalMangan.toLocaleString()}`;
                if (userSpinsEl) userSpinsEl.textContent = userSpins.toLocaleString();
                if (userCoinEl) userCoinEl.textContent = `ğŸª™ ${userCoin.toLocaleString()}`;
                if (userTicketsEl) userTicketsEl.textContent = `ğŸ« ${userGacha.toLocaleString()} / ğŸ§§ ${userMangan.toLocaleString()}`;
                if (userFsEl) userFsEl.textContent = userFs.toLocaleString();

                const jpSorted = Array.from(jpUserTotals.values()).sort((a, b) => (b.coin + b.gacha + b.mangan) - (a.coin + a.gacha + a.mangan)).slice(0, 5);
                if (jpRankingEl) {
                    jpRankingEl.innerHTML = jpSorted.length
                        ? jpSorted.map(user => `<li>${user.name}ï¼šğŸª™ ${user.coin} / ğŸ« ${user.gacha} / ğŸ§§ ${user.mangan}</li>`).join('')
                        : '<li>ãƒ‡ãƒ¼ã‚¿ãªã—</li>';
                }

                const renderTop3 = (type) => {
                    const list = (jpTopByType[type] || []).sort((a, b) => b.amount - a.amount).slice(0, 3);
                    if (jpTopEl) {
                        jpTopEl.innerHTML = list.length
                            ? list.map(item => `<li>${item.name}ï¼š${item.amount}</li>`).join('')
                            : '<li>ãƒ‡ãƒ¼ã‚¿ãªã—</li>';
                    }
                };

                renderTop3('coin');
                const toggle = document.getElementById('slot-jp-top-toggle');
                if (toggle) {
                    toggle.querySelectorAll('button[data-jp-type]').forEach(btn => {
                        btn.addEventListener('click', () => {
                            toggle.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            renderTop3(btn.getAttribute('data-jp-type'));
                        });
                    });
                }

                if (updatedEl) updatedEl.textContent = `æ›´æ–°: ${new Date().toLocaleString('ja-JP')}`;
            } catch (err) {
                console.error(err);
                if (updatedEl) updatedEl.textContent = 'é›†è¨ˆã«å¤±æ•—';
            }
        }

        function closeWinPopup() {
            const popup = document.getElementById('win-popup');
            if (popup) popup.classList.remove('show');
        }

        async function startSession() {
            if (isProcessing) return;
            setProcessing(true);
            try {
                const { data, error } = await supabaseClient.rpc('slot_start_session', {
                    p_user_id: currentUserId
                });
                if (error) throw error;
                if (!data.ok) {
                    document.getElementById('session-message').textContent = `é–‹å§‹ã§ãã¾ã›ã‚“: ${data.error}`;
                    setProcessing(false);
                    return;
                }
                currentSession = {
                    ...data.session,
                    reels: data.reels || []
                };
                await refreshCoinBalance();
                updateUI();
            } catch (err) {
                console.error(err);
                document.getElementById('session-message').textContent = 'é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                setProcessing(false);
            }
        }

        const SPIN_DURATION_MS = 1600;
        let spinLockUntil = 0;
        let lastSpinReel = null;

        async function spinReel(reelIndex) {
            if (isProcessing || !currentSession) return;
            if (currentSession.status !== 'active') return;
            if (typeof reelIndex === 'number' && reelIndex !== currentSession.current_reel) return;
            setProcessing(true);
            animateSpinSequence(currentSession.current_reel);
            try {
                const { data, error } = await supabaseClient.rpc('slot_spin_reel', {
                    p_user_id: currentUserId,
                    p_session_id: currentSession.id
                });
                if (error) throw error;
                if (!data.ok) {
                    if (data.error === 'JACKPOT_CONFIRM_REQUIRED') {
                        document.getElementById('session-message').textContent = 'âš ï¸ ãƒ•ãƒªãƒ¼ã‚¹ãƒ”ãƒ³ç¢ºå®šãŒå¿…è¦ã§ã™ã€‚';
                    } else {
                        document.getElementById('session-message').textContent = `å›ã›ã¾ã›ã‚“: ${data.error}`;
                    }
                    setProcessing(false);
                    return;
                }
                currentSession = {
                    ...data.session,
                    reels: data.reels || []
                };

                if (data.auto_cashout) {
                    currentSession.status = 'cashed_out';
                    currentSession.payout = data.payout || [];
                    await refreshCoinBalance();
                }

                updateUI();
            } catch (err) {
                console.error(err);
                document.getElementById('session-message').textContent = 'ãƒªãƒ¼ãƒ«åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                setProcessing(false);
                updateUI();
            }
        }

        async function cashout() {
            if (isProcessing || !currentSession) return;
            setProcessing(true);
            try {
                const { data, error } = await supabaseClient.rpc('slot_cashout', {
                    p_user_id: currentUserId,
                    p_session_id: currentSession.id
                });
                if (error) throw error;
                if (!data.ok) {
                    document.getElementById('session-message').textContent = `ç²¾ç®—ã«å¤±æ•—: ${data.error}`;
                    setProcessing(false);
                    return;
                }
                currentSession = {
                    ...data.session,
                    reels: currentSession.reels || [],
                    payout: data.payout || []
                };
                await refreshCoinBalance();
                updateUI();
            } catch (err) {
                console.error(err);
                document.getElementById('session-message').textContent = 'ç²¾ç®—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                setProcessing(false);
            }
        }

        async function confirmJackpot() {
            if (isProcessing || !currentSession) return;
            if (!currentSession.jackpot_unlocked || currentSession.free_spin_confirmed) return;
            setProcessing(true);
            try {
                const { data, error } = await supabaseClient.rpc('slot_confirm_jackpot', {
                    p_user_id: currentUserId,
                    p_session_id: currentSession.id
                });
                if (error) throw error;
                if (!data.ok) {
                    document.getElementById('session-message').textContent = `ç¢ºå®šã«å¤±æ•—: ${data.error}`;
                    setProcessing(false);
                    return;
                }
                currentSession = {
                    ...data.session,
                    reels: data.reels || currentSession.reels || []
                };
                updateUI();
            } catch (err) {
                console.error(err);
                document.getElementById('session-message').textContent = 'ç¢ºå®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                setProcessing(false);
            }
        }

        window.addEventListener('DOMContentLoaded', initSlotPage);

        function buildReelStage() {
            const stageEl = document.getElementById('reel-stage');
            const mobileSummary = stageEl.querySelector('#mobile-summary');
            const summaryHtml = mobileSummary ? mobileSummary.outerHTML : '';
            stageEl.innerHTML = Array.from({ length: 7 }).map((_, idx) => {
                const reelIndex = idx + 1;
                const symbols = reelSymbols.concat(reelSymbols).map(symbol => `<span>${symbol}</span>`).join('');
                return `
                    <div class="reel-col" data-reel-index="${reelIndex}">
                        <div class="reel-label">REEL ${reelIndex}</div>
                        <div class="reel-window">
                            <div class="reel-symbols">${symbols}</div>
                            <div class="reel-stop"></div>
                        </div>
                        <div class="reel-result">æœªåœæ­¢</div>
                        <button class="reel-btn" data-reel-btn="${reelIndex}" onclick="spinReel(${reelIndex})" disabled>å›ã™</button>
                    </div>
                `;
            }).join('') + summaryHtml;
        }

        function renderReelState(reels) {
            const reelMap = new Map();
            const displayFreeSpin = !!currentSession?.free_spin_active && freeSpinDisplayActive;
            let displayRound = null;
            if (displayFreeSpin) {
                displayRound = (reels || []).reduce((maxRound, reel) => {
                    if (!reel.is_free_spin) return maxRound;
                    const round = Number(reel.free_spin_round || 0);
                    return round > maxRound ? round : maxRound;
                }, 0);
            }
            (reels || []).forEach(reel => {
                if (displayFreeSpin) {
                    const round = Number(reel.free_spin_round || 0);
                    if (round !== displayRound) {
                        return;
                    }
                }
                reelMap.set(reel.reel_index, reel);
            });
            document.querySelectorAll('.reel-col').forEach(col => {
                const reelIndex = Number(col.getAttribute('data-reel-index'));
                const reel = reelMap.get(reelIndex);
                const windowEl = col.querySelector('.reel-window');
                const resultEl = col.querySelector('.reel-result');
                const stopEl = col.querySelector('.reel-stop');

                col.classList.remove('done', 'bust');
                windowEl.classList.remove('spinning');
                windowEl.classList.remove('stopped');
                const stillSpinning = lastSpinReel === reelIndex && Date.now() < spinLockUntil;
                if (stillSpinning) {
                    windowEl.classList.add('spinning');
                    resultEl.textContent = 'å›è»¢ä¸­';
                    if (stopEl) stopEl.textContent = '';
                    return;
                }
                if (!reel) {
                    resultEl.textContent = 'æœªåœæ­¢';
                    if (stopEl) stopEl.textContent = '';
                    return;
                }

                resultEl.textContent = reel.is_bust
                    ? 'ãƒãƒ¼ã‚¹ãƒˆ'
                    : reel.is_free_spin_stock
                        ? `FS + ${reel.reward_name || 'å ±é…¬'}`
                        : reel.is_jackpot
                            ? `JP + ${reel.reward_name || 'ã‚¸ãƒ£ãƒƒã‚¯ãƒãƒƒãƒˆ'}`
                            : (reel.reward_name || 'å ±é…¬ãªã—');
                col.classList.add('done');
                if (reel.is_bust) col.classList.add('bust');
                if (stopEl) {
                    if (reel.is_bust) {
                        stopEl.innerHTML = BURST_SYMBOL;
                    } else if (reel.is_free_spin_stock) {
                        stopEl.innerHTML = FREESPIN_SYMBOL;
                    } else if (reel.is_jackpot) {
                        stopEl.innerHTML = JACKPOT_SYMBOL;
                    } else if (reel.reward_type === 'coin') {
                        stopEl.textContent = 'ğŸª™';
                    } else if (reel.reward_type === 'gacha_ticket') {
                        stopEl.textContent = 'ğŸ«';
                    } else if (reel.reward_type === 'mangan_ticket') {
                        stopEl.textContent = 'ğŸ§§';
                    } else if (reel.reward_type === 'multiplier') {
                        stopEl.textContent = getMultiplierEmoji(reel.amount);
                    } else {
                        stopEl.textContent = 'ğŸ';
                    }
                }
                if (!stillSpinning) {
                    windowEl.classList.add('stopped');
                }
            });
        }

        function animateSpinSequence(targetReel) {
            const index = Math.max(1, Math.min(7, targetReel));
            spinLockUntil = Date.now() + SPIN_DURATION_MS;
            lastSpinReel = index;
            for (let i = 1; i <= 7; i++) {
                const col = document.querySelector(`.reel-col[data-reel-index="${i}"]`);
                if (!col) continue;
                const windowEl = col.querySelector('.reel-window');
                const stopEl = col.querySelector('.reel-stop');
                windowEl.classList.remove('spinning');
                if (i === index) {
                    if (stopEl) stopEl.textContent = '';
                    windowEl.classList.add('spinning');
                    setTimeout(() => {
                        windowEl.classList.remove('spinning');
                        updateUI();
                    }, SPIN_DURATION_MS);
                }
            }
        }

        function updateReelButtons() {
            const current = currentSession?.current_reel;
            document.querySelectorAll('[data-reel-btn]').forEach(btn => {
                const reelIndex = Number(btn.getAttribute('data-reel-btn'));
                btn.disabled = isProcessing || !currentSession || currentSession.status !== 'active' || reelIndex !== current;
            });
        }

        function showFreeSpinCutin() {
            const cutin = document.getElementById('free-spin-cutin');
            if (!cutin) return;
            const card = cutin.querySelector('.cutin-card');
            if (card) card.textContent = 'FREE SPIN!!';
            cutin.classList.remove('show');
            void cutin.offsetWidth;
            cutin.classList.add('show');
            setTimeout(() => {
                cutin.classList.remove('show');
            }, 1600);
        }

        function showFreeSpinPlusCutin(amount) {
            const cutin = document.getElementById('free-spin-cutin');
            if (!cutin) return;
            const card = cutin.querySelector('.cutin-card');
            const value = Number.isFinite(amount) && amount > 0 ? amount : 1;
            if (card) card.textContent = `FREE SPIN +${value}`;
            cutin.classList.remove('show');
            void cutin.offsetWidth;
            cutin.classList.add('show');
            setTimeout(() => {
                cutin.classList.remove('show');
            }, 1200);
        }

        function setupAdminReelEditor() {
            const panel = document.getElementById('slot-admin-panel');
            if (!panel) return;
            panel.style.display = isAdmin ? 'block' : 'none';
            if (!isAdmin) return;

            const selectEl = document.getElementById('admin-reel-select');
            selectEl.innerHTML = Array.from({ length: 7 }).map((_, i) => {
                const idx = i + 1;
                return `<option value="${idx}">REEL ${idx}</option>`;
            }).join('');

            document.getElementById('admin-reel-load').addEventListener('click', () => loadAdminReel());
            document.getElementById('admin-reel-save').addEventListener('click', () => saveAdminReel());
            selectEl.addEventListener('change', () => loadAdminReel());
            const modeEl = document.getElementById('admin-reel-mode');
            if (modeEl) {
                modeEl.addEventListener('change', () => {
                    updateAdminColumnVisibility(getAdminMode());
                    loadAdminReel();
                });
            }
            updateAdminColumnVisibility(getAdminMode());
            loadAdminReel();
        }

        function getAdminMode() {
            return document.getElementById('admin-reel-mode')?.value || 'normal';
        }

        function updateAdminColumnVisibility(mode) {
            const showNormal = mode === 'normal';
            document.querySelectorAll('[data-admin-col="bust"], [data-admin-col="jackpot"]').forEach(el => {
                el.style.display = showNormal ? '' : 'none';
            });
            document.querySelectorAll('[data-admin-col="fsstock"]').forEach(el => {
                el.style.display = mode === 'free' ? '' : 'none';
            });
        }

        function setAdminStatus(message) {
            const statusEl = document.getElementById('admin-reel-status');
            if (statusEl) statusEl.textContent = message || '';
        }

        async function loadAdminReel() {
            const selectEl = document.getElementById('admin-reel-select');
            const reelIndex = Number(selectEl?.value || 1);
            const mode = getAdminMode();
            setAdminStatus('èª­ã¿è¾¼ã¿ä¸­...');
            try {
                const { data, error } = await supabaseClient
                    .from('slot_reel_positions')
                    .select('*')
                    .eq('mode', mode)
                    .eq('reel_index', reelIndex)
                    .order('position_index', { ascending: true });
                if (error) throw error;
                renderAdminReelRows(data || [], mode);
                setAdminStatus('èª­ã¿è¾¼ã¿å®Œäº†');
            } catch (err) {
                console.error(err);
                setAdminStatus('èª­ã¿è¾¼ã¿å¤±æ•—');
            }
        }

        function renderAdminReelRows(rows, mode) {
            const body = document.getElementById('admin-reel-body');
            if (!body) return;
            body.innerHTML = (rows || []).map(row => {
                const rewardType = row.reward_type || '';
                const rewardName = row.reward_name || '';
                const rewardId = row.reward_id || '';
                const amount = row.amount ?? '';
                const isBust = row.is_bust || false;
                const isJackpot = row.is_jackpot || false;
                const isFsStock = row.is_free_spin_stock || false;
                const hideNormal = mode === 'free' ? 'style="display:none;"' : '';
                const hideFree = mode !== 'free' ? 'style="display:none;"' : '';
                return `
                    <tr data-position="${row.position_index}">
                        <td class="text-muted">#${row.position_index}</td>
                        <td><input type="checkbox" class="form-check-input admin-active" ${row.is_active ? 'checked' : ''}></td>
                        <td data-admin-col="bust" ${hideNormal}><input type="checkbox" class="form-check-input admin-bust" ${isBust ? 'checked' : ''}></td>
                        <td data-admin-col="jackpot" ${hideNormal}><input type="checkbox" class="form-check-input admin-jackpot" ${isJackpot ? 'checked' : ''}></td>
                        <td data-admin-col="fsstock" ${hideFree}><input type="checkbox" class="form-check-input admin-fsstock" ${isFsStock ? 'checked' : ''}></td>
                        <td>
                            <select class="form-select form-select-sm admin-reward-type">
                                <option value="">ãªã—</option>
                                <option value="coin" ${rewardType === 'coin' ? 'selected' : ''}>coin</option>
                                <option value="gacha_ticket" ${rewardType === 'gacha_ticket' ? 'selected' : ''}>gacha_ticket</option>
                                <option value="mangan_ticket" ${rewardType === 'mangan_ticket' ? 'selected' : ''}>mangan_ticket</option>
                                <option value="exchange_ticket" ${rewardType === 'exchange_ticket' ? 'selected' : ''}>exchange_ticket</option>
                                <option value="badge" ${rewardType === 'badge' ? 'selected' : ''}>badge</option>
                                <option value="multiplier" ${rewardType === 'multiplier' ? 'selected' : ''}>multiplier</option>
                            </select>
                        </td>
                        <td><input type="text" class="form-control form-control-sm admin-reward-name" value="${rewardName}"></td>
                        <td><input type="number" min="0" step="0.1" class="form-control form-control-sm admin-amount" value="${amount}"></td>
                        <td><input type="text" class="form-control form-control-sm admin-reward-id" value="${rewardId}"></td>
                    </tr>
                `;
            }).join('');

            body.querySelectorAll('tr').forEach(row => {
                const bustEl = row.querySelector('.admin-bust');
                const jackpotEl = row.querySelector('.admin-jackpot');
                const rewardTypeEl = row.querySelector('.admin-reward-type');
                const rewardNameEl = row.querySelector('.admin-reward-name');
                const amountEl = row.querySelector('.admin-amount');
                const rewardIdEl = row.querySelector('.admin-reward-id');

                const applyRowState = () => {
                    const isBustChecked = bustEl?.checked;
                    if (isBustChecked && jackpotEl) jackpotEl.checked = false;
                    const disableRewards = mode === 'free' ? false : !!isBustChecked;
                    if (rewardTypeEl) rewardTypeEl.disabled = disableRewards;
                    if (rewardNameEl) rewardNameEl.disabled = disableRewards;
                    if (amountEl) amountEl.disabled = disableRewards;
                    if (rewardIdEl) rewardIdEl.disabled = disableRewards;
                };

                const clearBust = () => {
                    if (bustEl?.checked) bustEl.checked = false;
                    applyRowState();
                };

                if (bustEl) bustEl.addEventListener('change', applyRowState);
                if (jackpotEl) jackpotEl.addEventListener('change', clearBust);
                applyRowState();
            });
        }

        async function saveAdminReel() {
            const selectEl = document.getElementById('admin-reel-select');
            const reelIndex = Number(selectEl?.value || 1);
            const mode = getAdminMode();
            const body = document.getElementById('admin-reel-body');
            if (!body) return;

            const payload = [];
            body.querySelectorAll('tr').forEach(row => {
                const positionIndex = Number(row.getAttribute('data-position'));
                const isActive = row.querySelector('.admin-active')?.checked ?? false;
                const isBust = mode === 'free' ? false : (row.querySelector('.admin-bust')?.checked ?? false);
                const isJackpot = mode === 'free' ? false : (!isBust && (row.querySelector('.admin-jackpot')?.checked ?? false));
                const isFsStock = mode === 'free' ? (row.querySelector('.admin-fsstock')?.checked ?? false) : false;
                const rewardTypeRaw = row.querySelector('.admin-reward-type')?.value || '';
                const rewardType = isBust ? null : (rewardTypeRaw || null);
                const rewardNameRaw = row.querySelector('.admin-reward-name')?.value?.trim() || '';
                const rewardName = isBust ? null : (rewardNameRaw || null);
                const rewardIdRaw = row.querySelector('.admin-reward-id')?.value?.trim() || '';
                const rewardId = isBust ? null : (rewardIdRaw || null);
                const amountRaw = row.querySelector('.admin-amount')?.value;
                const amountVal = isBust ? 0 : Number.parseFloat(amountRaw || 0);

                const rowData = {
                    mode: mode,
                    reel_index: reelIndex,
                    position_index: positionIndex,
                    is_active: isActive,
                    is_bust: mode === 'free' ? false : isBust,
                    is_jackpot: mode === 'free' ? false : isJackpot,
                    is_free_spin_stock: isFsStock,
                    reward_type: rewardType,
                    reward_name: rewardName,
                    reward_id: rewardId,
                    amount: amountVal
                };
                payload.push(rowData);
            });

            setAdminStatus('ä¿å­˜ä¸­...');
            try {
                const { error } = await supabaseClient
                    .from('slot_reel_positions')
                    .upsert(payload, { onConflict: 'mode,reel_index,position_index' });
                if (error) throw error;
                setAdminStatus('ä¿å­˜å®Œäº†');
            } catch (err) {
                console.error(err);
                setAdminStatus('ä¿å­˜å¤±æ•—');
            }
        }
    </script>
</body>

</html>
