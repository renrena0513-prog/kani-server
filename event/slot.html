<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒ­ãƒƒãƒˆ | ã‹ã«ã‚µãƒ¼ãƒãƒ¼</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&family=IBM+Plex+Sans+JP:wght@400;600&display=swap" rel="stylesheet">
    <!-- Bootswatch Lux -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <style>
        :root {
            --slot-bg: #0f141a;
            --slot-panel: #1a2230;
            --slot-accent: #f6c453;
            --slot-muted: #9aa4b2;
            --slot-font-title: 'Zen Maru Gothic', sans-serif;
            --slot-font-body: 'IBM Plex Sans JP', sans-serif;
        }

        body {
            font-family: var(--slot-font-body);
            background: radial-gradient(circle at top, #1b2433 0%, #0b0f14 60%, #07090c 100%);
            color: #e7ecf3;
            min-height: 100vh;
        }

        .slot-header {
            font-family: var(--slot-font-title);
            letter-spacing: 0.04em;
        }

        .slot-panel {
            background: var(--slot-panel);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
        }

        .slot-status {
            background: rgba(246, 196, 83, 0.12);
            border: 1px solid rgba(246, 196, 83, 0.35);
            color: #ffd36b;
            border-radius: 12px;
            padding: 10px 14px;
            font-size: 0.95rem;
        }

        .slot-muted {
            color: var(--slot-muted);
        }

        .slot-burst {
            background: rgba(220, 53, 69, 0.15);
            border: 1px solid rgba(220, 53, 69, 0.5);
            color: #ffb3b3;
            border-radius: 12px;
            padding: 12px 16px;
            font-weight: 600;
        }

        .reel-stage {
            display: grid;
            grid-template-columns: repeat(7, minmax(90px, 1fr));
            gap: 16px;
        }

        .reel-col {
            background: rgba(255, 255, 255, 0.04);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 14px 12px;
            display: grid;
            gap: 10px;
            text-align: center;
        }

        .reel-window {
            background: #0b0f14;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: 96px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: 700;
            position: relative;
            overflow: hidden;
        }

        .reel-symbols {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
        }

        .reel-symbols span {
            display: block;
            height: 96px;
            line-height: 96px;
            color: #cbd5e1;
            font-weight: 700;
        }

        .reel-window.spinning .reel-symbols {
            animation: reel-spin 1.6s linear infinite;
        }

        .reel-col.done .reel-window {
            box-shadow: inset 0 0 0 1px rgba(246, 196, 83, 0.5);
        }

        .reel-col.bust .reel-window {
            box-shadow: inset 0 0 0 1px rgba(220, 53, 69, 0.6);
            color: #ffb3b3;
        }

        .reel-label {
            font-size: 0.8rem;
            color: var(--slot-muted);
        }

        .reel-result {
            font-size: 0.95rem;
            min-height: 1.2rem;
        }

        @keyframes reel-spin {
            0% { transform: translateY(0); }
            100% { transform: translateY(-960px); }
        }

        .btn-slot {
            background: linear-gradient(135deg, #f6c453 0%, #d99a29 100%);
            color: #1a1306;
            border: none;
            font-weight: 700;
        }

        .btn-slot:disabled {
            opacity: 0.6;
        }

        .btn-slot-secondary {
            border: 1px solid rgba(246, 196, 83, 0.6);
            color: #f6c453;
            background: transparent;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="nav-dropdown"></div>
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
            <div>
                <h1 class="slot-header mb-2">ğŸ° æœŸé–“é™å®šã‚¤ãƒ™ãƒ³ãƒˆï¼šã‚¹ãƒ­ãƒƒãƒˆ</h1>
                <div class="slot-muted">1å›100ã‚³ã‚¤ãƒ³ã€‚æ­¢ã¾ã£ãŸåˆ†ã ã‘å ±é…¬ç¢ºå®šã€ã¯ãšã‚Œã§ãƒãƒ¼ã‚¹ãƒˆã€‚</div>
            </div>
            <div class="slot-status" id="event-status">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <div class="row g-4">
            <div class="col-12 col-lg-4">
                <div class="slot-panel p-4 h-100">
                    <div class="mb-3">
                        <div class="slot-muted">æ‰€æŒã‚³ã‚¤ãƒ³</div>
                        <div class="fs-3 fw-bold" id="coin-balance">-</div>
                    </div>
                    <div class="mb-3">
                        <div class="slot-muted">ç¾åœ¨ãƒªãƒ¼ãƒ«</div>
                        <div class="fs-4 fw-bold" id="current-reel">-</div>
                    </div>
                    <div class="mb-3 slot-muted">
                        <div>ã‚³ã‚¹ãƒˆ: <span id="slot-cost">100</span>ã‚³ã‚¤ãƒ³ / å›</div>
                        <div>ãƒªãƒ¼ãƒ«: 7æœ¬ / åœæ­¢ä½ç½® 10</div>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-slot" id="btn-start" onclick="startSession()">é–‹å§‹ï¼ˆ100ã‚³ã‚¤ãƒ³æ¶ˆè²»ï¼‰</button>
                        <button class="btn btn-slot" id="btn-spin" onclick="spinReel()" disabled>æ¬¡ã®ãƒªãƒ¼ãƒ«ã‚’å›ã™</button>
                        <button class="btn btn-slot-secondary" id="btn-stop" onclick="cashout()" disabled>ã‚¹ãƒˆãƒƒãƒ—ï¼ˆç²¾ç®—ï¼‰</button>
                    </div>
                    <div class="mt-3 slot-muted" id="session-message"></div>
                </div>
            </div>

            <div class="col-12 col-lg-8">
                <div class="slot-panel p-4 h-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">åœæ­¢çµæœ</h5>
                        <span class="slot-muted" id="session-status">å¾…æ©Ÿä¸­</span>
                    </div>
                    <div class="reel-stage" id="reel-stage"></div>
                    <div class="mt-4" id="payout-summary" style="display:none;">
                        <h6 class="mb-2">ç²¾ç®—çµæœ</h6>
                        <div class="slot-panel p-3" id="payout-list"></div>
                    </div>
                    <div class="mt-4 slot-burst" id="burst-banner" style="display:none;">ãƒãƒ¼ã‚¹ãƒˆï¼å ±é…¬ã¯ã™ã¹ã¦æ²¡åã•ã‚Œã¾ã—ãŸã€‚</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/auth-guard.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        let currentUserId = null;
        let isAdmin = false;
        let currentSession = null;
        let eventSettings = null;
        let isProcessing = false;
        const reelSymbols = ['ğŸª™', 'ğŸ«', 'ğŸ§§', 'ğŸª™', 'ğŸ«', 'ğŸ§§', 'ğŸª™', 'ğŸ«', 'â˜ ', 'ğŸª™'];

        async function initSlotPage() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) {
                window.location.href = '../index.html';
                return;
            }

            currentUserId = user.user_metadata.provider_id;
            isAdmin = typeof ADMIN_DISCORD_IDS !== 'undefined' && ADMIN_DISCORD_IDS.includes(currentUserId);
            initAccordionNav('../');
            buildReelStage();

            await loadEventSettings();
            await refreshCoinBalance();
            await loadActiveSession();
            updateUI();
        }

        async function loadEventSettings() {
            const statusEl = document.getElementById('event-status');
            try {
                const { data, error } = await supabaseClient
                    .from('slot_event_settings')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .maybeSingle();

                if (error) throw error;
                eventSettings = data;

                const now = new Date();
                const startAt = data?.start_at ? new Date(data.start_at) : null;
                const endAt = data?.end_at ? new Date(data.end_at) : null;

                let label = 'ã‚¤ãƒ™ãƒ³ãƒˆæº–å‚™ä¸­';
                if (!data || !data.is_active) {
                    label = 'ã‚¤ãƒ™ãƒ³ãƒˆåœæ­¢ä¸­';
                } else if (startAt && now < startAt) {
                    label = `é–‹å§‹å¾…ã¡: ${startAt.toLocaleString('ja-JP')}`;
                } else if (endAt && now > endAt) {
                    label = `çµ‚äº†: ${endAt.toLocaleString('ja-JP')}`;
                } else {
                    label = 'ã‚¤ãƒ™ãƒ³ãƒˆé–‹å‚¬ä¸­';
                }
                statusEl.textContent = label;
                document.getElementById('slot-cost').textContent = data?.cost ?? 100;
            } catch (err) {
                statusEl.textContent = 'è¨­å®šå–å¾—ã«å¤±æ•—';
                console.error(err);
            }
        }

        async function refreshCoinBalance() {
            const coinEl = document.getElementById('coin-balance');
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('coins')
                    .eq('discord_user_id', currentUserId)
                    .maybeSingle();
                if (error) throw error;
                coinEl.textContent = `${(data?.coins ?? 0).toLocaleString()} C`;
            } catch (err) {
                coinEl.textContent = 'å–å¾—å¤±æ•—';
                console.error(err);
            }
        }

        async function loadActiveSession() {
            try {
                const { data, error } = await supabaseClient.rpc('slot_get_state', {
                    p_user_id: currentUserId
                });
                if (error) throw error;
                if (data?.session) {
                    currentSession = {
                        ...data.session,
                        reels: data.reels || []
                    };
                } else {
                    currentSession = null;
                }
            } catch (err) {
                console.error(err);
            }
        }

        function setProcessing(state) {
            isProcessing = state;
            document.getElementById('btn-start').disabled = state;
            document.getElementById('btn-spin').disabled = state || !currentSession || currentSession.status !== 'active';
            document.getElementById('btn-stop').disabled = state || !currentSession || currentSession.status !== 'active' || (currentSession.reels || []).length === 0;
        }

        function isEventActiveNow() {
            if (isAdmin) return true;
            if (!eventSettings || !eventSettings.is_active) return false;
            const now = new Date();
            const startAt = eventSettings.start_at ? new Date(eventSettings.start_at) : null;
            const endAt = eventSettings.end_at ? new Date(eventSettings.end_at) : null;
            if (startAt && now < startAt) return false;
            if (endAt && now > endAt) return false;
            return true;
        }

        function updateUI() {
            const reels = currentSession?.reels || [];
            const currentReelEl = document.getElementById('current-reel');
            const sessionStatusEl = document.getElementById('session-status');
            const stageEl = document.getElementById('reel-stage');
            const payoutSummary = document.getElementById('payout-summary');
            const payoutList = document.getElementById('payout-list');
            const burstBanner = document.getElementById('burst-banner');
            const messageEl = document.getElementById('session-message');

            if (!currentSession) {
                currentReelEl.textContent = '-';
                sessionStatusEl.textContent = 'å¾…æ©Ÿä¸­';
                messageEl.textContent = '';
                payoutSummary.style.display = 'none';
                burstBanner.style.display = 'none';
                setProcessing(false);
                document.getElementById('btn-start').disabled = !isEventActiveNow();
                document.getElementById('btn-spin').disabled = true;
                document.getElementById('btn-stop').disabled = true;
                renderReelState(reels);
                return;
            }

            currentReelEl.textContent = currentSession.status === 'active' ? `ç¬¬ ${currentSession.current_reel} ãƒªãƒ¼ãƒ«` : 'çµ‚äº†';
            sessionStatusEl.textContent = currentSession.status === 'active' ? 'é€²è¡Œä¸­' : (currentSession.status === 'bust' ? 'ãƒãƒ¼ã‚¹ãƒˆ' : 'ç²¾ç®—æ¸ˆã¿');

            renderReelState(reels);

            burstBanner.style.display = currentSession.status === 'bust' ? 'block' : 'none';
            payoutSummary.style.display = 'none';
            payoutList.innerHTML = '';

            if (currentSession.status === 'cashed_out') {
                payoutSummary.style.display = 'block';
                const payoutItems = currentSession.payout || [];
                const items = payoutItems.length
                    ? payoutItems.map(item => `${item.reward_name || item.type} +${item.amount}`).join('<br>')
                    : 'å ±é…¬ãªã—';
                payoutList.innerHTML = items;
            }

            messageEl.textContent = '';
            setProcessing(false);
            document.getElementById('btn-start').disabled = currentSession.status === 'active' || !isEventActiveNow();
        }

        async function startSession() {
            if (isProcessing) return;
            setProcessing(true);
            try {
                const { data, error } = await supabaseClient.rpc('slot_start_session', {
                    p_user_id: currentUserId
                });
                if (error) throw error;
                if (!data.ok) {
                    document.getElementById('session-message').textContent = `é–‹å§‹ã§ãã¾ã›ã‚“: ${data.error}`;
                    setProcessing(false);
                    return;
                }
                currentSession = {
                    ...data.session,
                    reels: data.reels || []
                };
                await refreshCoinBalance();
                updateUI();
            } catch (err) {
                console.error(err);
                document.getElementById('session-message').textContent = 'é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                setProcessing(false);
            }
        }

        async function spinReel() {
            if (isProcessing || !currentSession) return;
            setProcessing(true);
            animateSpinSequence(currentSession.current_reel);
            try {
                const { data, error } = await supabaseClient.rpc('slot_spin_reel', {
                    p_user_id: currentUserId,
                    p_session_id: currentSession.id
                });
                if (error) throw error;
                if (!data.ok) {
                    document.getElementById('session-message').textContent = `å›ã›ã¾ã›ã‚“: ${data.error}`;
                    setProcessing(false);
                    return;
                }
                currentSession = {
                    ...data.session,
                    reels: data.reels || []
                };

                if (data.auto_cashout) {
                    currentSession.status = 'cashed_out';
                    currentSession.payout = data.payout || [];
                    await refreshCoinBalance();
                }

                updateUI();
            } catch (err) {
                console.error(err);
                document.getElementById('session-message').textContent = 'ãƒªãƒ¼ãƒ«åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                setProcessing(false);
            }
        }

        async function cashout() {
            if (isProcessing || !currentSession) return;
            setProcessing(true);
            try {
                const { data, error } = await supabaseClient.rpc('slot_cashout', {
                    p_user_id: currentUserId,
                    p_session_id: currentSession.id
                });
                if (error) throw error;
                if (!data.ok) {
                    document.getElementById('session-message').textContent = `ç²¾ç®—ã«å¤±æ•—: ${data.error}`;
                    setProcessing(false);
                    return;
                }
                currentSession = {
                    ...data.session,
                    reels: currentSession.reels || [],
                    payout: data.payout || []
                };
                await refreshCoinBalance();
                updateUI();
            } catch (err) {
                console.error(err);
                document.getElementById('session-message').textContent = 'ç²¾ç®—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                setProcessing(false);
            }
        }

        window.addEventListener('DOMContentLoaded', initSlotPage);

        function buildReelStage() {
            const stageEl = document.getElementById('reel-stage');
            stageEl.innerHTML = Array.from({ length: 7 }).map((_, idx) => {
                const reelIndex = idx + 1;
                const symbols = reelSymbols.concat(reelSymbols).map(symbol => `<span>${symbol}</span>`).join('');
                return `
                    <div class="reel-col" data-reel-index="${reelIndex}">
                        <div class="reel-label">REEL ${reelIndex}</div>
                        <div class="reel-window">
                            <div class="reel-symbols">${symbols}</div>
                        </div>
                        <div class="reel-result slot-muted">æœªåœæ­¢</div>
                    </div>
                `;
            }).join('');
        }

        function renderReelState(reels) {
            const reelMap = new Map((reels || []).map(reel => [reel.reel_index, reel]));
            document.querySelectorAll('.reel-col').forEach(col => {
                const reelIndex = Number(col.getAttribute('data-reel-index'));
                const reel = reelMap.get(reelIndex);
                const windowEl = col.querySelector('.reel-window');
                const resultEl = col.querySelector('.reel-result');

                col.classList.remove('done', 'bust');
                windowEl.classList.remove('spinning');
                if (!reel) {
                    resultEl.textContent = 'æœªåœæ­¢';
                    resultEl.classList.add('slot-muted');
                    return;
                }

                const label = reel.is_bust ? 'â˜  ãƒãƒ¼ã‚¹ãƒˆ' : (reel.reward_name || 'å ±é…¬ãªã—');
                resultEl.textContent = label;
                resultEl.classList.remove('slot-muted');
                col.classList.add('done');
                if (reel.is_bust) col.classList.add('bust');
            });
        }

        function animateSpinSequence(targetReel) {
            const index = Math.max(1, Math.min(7, targetReel));
            for (let i = 1; i <= 7; i++) {
                const col = document.querySelector(`.reel-col[data-reel-index="${i}"]`);
                if (!col) continue;
                const windowEl = col.querySelector('.reel-window');
                windowEl.classList.remove('spinning');
                if (i === index) {
                    windowEl.classList.add('spinning');
                    setTimeout(() => windowEl.classList.remove('spinning'), 1600);
                }
            }
        }
    </script>
</body>

</html>
