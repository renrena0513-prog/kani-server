<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="list-build" content="2026-02-07-03">
    <title>ãƒãƒƒã‚¸å›³é‘‘ - ã‹ã«é¯–</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../styles.css">
    <style>
        :root {
            --deep-purple: #5a4a7a;
            --gold: #d4a574;
            --font-title: 'Kosugi Maru', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: white;
            text-decoration: none;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.15);
            transition: all 0.3s;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.25);
            color: white;
        }

        .page-header {
            color: #fff;
            font-family: var(--font-title);
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .badge-list-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            min-height: 500px;
        }

        .filter-controls {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #eee;
        }

        .category-tabs {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 8px 18px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #555;
            transition: all 0.2s;
            cursor: pointer;
        }

        .tab-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        .tab-btn.active {
            background: var(--gold);
            color: white;
            border-color: var(--gold);
            box-shadow: 0 4px 10px rgba(212, 165, 116, 0.3);
        }

        .badge-item-large {
            background: #fff;
            border-radius: 16px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid #eee;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            text-decoration: none;
            color: inherit;
        }

        .badge-item-large:hover {
            transform: translateY(-5px);
            border-color: var(--gold);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .badge-number-label {
            font-size: 0.65rem;
            font-weight: bold;
            color: #bbb;
            margin-bottom: 5px;
        }

        .badge-img-large {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 12px;
        }

        .badge-name-large {
            font-family: var(--font-title);
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--deep-purple);
            margin-bottom: 8px;
            line-height: 1.2;
            height: 2.4em;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .badge-tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            justify-content: center;
            font-size: 0.7rem;
            color: #6c757d;
            margin-top: 4px;
        }

        .badge-tag {
            background: #f1f3f5;
            border-radius: 10px;
            padding: 1px 6px;
        }

        .badge-tag-link {
            text-decoration: none;
            color: inherit;
            cursor: pointer;
        }

        .rarity-pill {
            font-size: 0.6rem;
            padding: 2px 10px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
        .nav-dropdown {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .record-button {
            background: linear-gradient(135deg, var(--gold) 0%, #b8892d 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 6px 20px rgba(212, 168, 83, 0.5);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            cursor: pointer;
        }

        .search-input {
            border-radius: 12px;
            padding-left: 40px;
            border: 1px solid #ddd;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
        }

        .filter-controls .form-select,
        .filter-controls .form-control,
        .filter-controls .creator-dropdown-btn {
            border-radius: 12px;
            border: 1px solid #d9dde3;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.04);
            background: #fff;
            min-height: 38px;
        }

        .filter-controls .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='%236c757d'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px 12px;
            padding-right: 34px;
        }

        .creator-dropdown-btn .bi-caret-down-fill {
            color: #6c757d;
        }

        .filter-active {
            background: #f6ead6 !important;
            border-color: var(--gold) !important;
        }

        .filter-label {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 600;
            letter-spacing: 0.02em;
            margin-bottom: 4px;
        }

        .filter-row-top {
            align-items: end;
        }

        .creator-dropdown {
            position: relative;
        }

        .creator-dropdown-btn {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 6px 10px;
            background: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .creator-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            object-fit: cover;
            display: none;
        }

        .creator-menu {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 10px;
            max-height: 280px;
            overflow-y: auto;
            z-index: 2000;
            display: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .creator-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
        }

        .creator-item:hover {
            background: #f8f9fa;
        }

        .rarity-unknown {
            background: #495057;
            color: #fff;
        }
    </style>
</head>

<body>
    <!-- å³ä¸Šã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
    <div class="nav-dropdown dropdown">
        <button class="record-button dropdown-toggle" type="button" id="navDropdown" data-bs-toggle="dropdown"
            aria-expanded="false">
            ğŸ“ ãƒ¡ãƒ‹ãƒ¥ãƒ¼
        </button>
        <ul class="dropdown-menu nav-dropdown-menu dropdown-menu-end" aria-labelledby="navDropdown">
            <!-- JSã§ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ -->
        </ul>
    </div>

    <div class="container py-5">
        <div class="mb-4" id="back-to-shop-wrap" style="display:none;">
            <a href="#" onclick="goBack(); return false;" class="back-button">
                â† æˆ»ã‚‹
            </a>
        </div>
        <header class="text-center">
            <h1 class="page-header display-4 fw-bold">ğŸ“› ãƒãƒƒã‚¸å›³é‘‘</h1>
            <p class="text-white-50 mb-4">ã‹ã«é¯–ã§ç²å¾—ãƒ»è³¼å…¥ã§ãã‚‹ãƒãƒƒã‚¸ã®ä¸€è¦§ã§ã™</p>
        </header>

        <div class="badge-list-card">
            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
            <div class="filter-controls">
                <div class="row g-3 filter-row-top">
                    <!-- æ¤œç´¢ -->
                    <div class="col-12 col-md-5">
                        <div class="position-relative">
                            <i class="bi bi-search search-icon"></i>
                            <input type="text" id="search-box" class="form-control search-input"
                                placeholder="ãƒãƒƒã‚¸åã§æ¤œç´¢..." oninput="filterAndRender()">
                        </div>
                    </div>
                    <!-- ã‚½ãƒ¼ãƒˆ -->
                    <div class="col-12 col-md-3">
                        <div class="d-flex align-items-center gap-2">
                            <label class="filter-label flex-shrink-0">ä¸¦ã³æ›¿ãˆ</label>
                            <select id="sort-select" class="form-select form-select-sm" onchange="filterAndRender()">
                                <option value="price_asc">ä¾¡æ ¼é †ï¼ˆä½â†’é«˜ï¼‰</option>
                                <option value="price_desc">ä¾¡æ ¼é †ï¼ˆé«˜â†’ä½ï¼‰</option>
                                <option value="circulation_asc">æµé€šæ•°é †ï¼ˆä½â†’é«˜ï¼‰</option>
                                <option value="circulation_desc">æµé€šæ•°é †ï¼ˆé«˜â†’ä½ï¼‰</option>
                                <option value="id_asc">ãƒãƒƒã‚¸IDé †ï¼ˆä½â†’é«˜ï¼‰</option>
                                <option value="id_desc">ãƒãƒƒã‚¸IDé †ï¼ˆé«˜â†’ä½ï¼‰</option>
                                <option value="name">åå‰é †</option>
                            </select>
                        </div>
                    </div>
                    <!-- è¡¨ç¤ºçµ±è¨ˆ -->
                    <div class="col-12 col-md-2 d-flex align-items-center justify-content-md-end">
                        <span class="badge bg-secondary" id="badge-count-status">0 / 0 ä»¶</span>
                    </div>
                </div>

                <hr class="my-3">

                <!-- è¿½åŠ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div class="row g-3">
                    <div class="col-12 col-md-3">
                        <label class="filter-label">ãƒ¬ã‚¢ãƒªãƒ†ã‚£</label>
                        <div class="creator-dropdown">
                            <button class="creator-dropdown-btn" type="button" id="rarity-filter-btn">
                                <span id="rarity-filter-label">ã™ã¹ã¦</span>
                                <i class="bi bi-caret-down-fill ms-auto"></i>
                            </button>
                            <input type="hidden" id="rarity-filter" value="">
                            <div class="creator-menu" id="rarity-filter-menu"></div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="filter-label">ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼</label>
                        <div class="creator-dropdown">
                            <button class="creator-dropdown-btn" type="button" id="creator-filter-btn">
                                <img src="" class="creator-avatar" id="creator-filter-avatar" alt="">
                                <span id="creator-filter-label">ã™ã¹ã¦</span>
                                <i class="bi bi-caret-down-fill ms-auto"></i>
                            </button>
                            <input type="hidden" id="creator-filter" value="">
                            <div class="creator-menu" id="creator-filter-menu"></div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="filter-label">ãƒãƒƒã‚¸ã‚¿ã‚¤ãƒ—</label>
                        <select id="type-filter" class="form-select form-select-sm" onchange="filterAndRender()">
                            <option value="">ã™ã¹ã¦</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="filter-label">ãƒ©ãƒ™ãƒ«</label>
                        <select id="label-filter" class="form-select form-select-sm" onchange="filterAndRender()">
                            <option value="">ã™ã¹ã¦</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="filter-label">ã‚¿ã‚°</label>
                        <select id="tag-filter" class="form-select form-select-sm" onchange="filterAndRender()">
                            <option value="">ã™ã¹ã¦</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="filter-label">å…¥æ‰‹æ–¹æ³•</label>
                        <select id="method-filter" class="form-select form-select-sm" onchange="filterAndRender()">
                            <option value="">ã™ã¹ã¦</option>
                            <option value="shop">ã‚·ãƒ§ãƒƒãƒ—è²©å£²ä¸­</option>
                            <option value="gacha">ã‚¬ãƒãƒ£æ’å‡º</option>
                            <option value="not_for_sale">éå£²å“</option>
                        </select>
                    </div>
                    <div class="col-12 d-flex align-items-center gap-2">
                        <button id="unowned-toggle" class="btn btn-outline-secondary btn-sm" type="button"
                            onclick="toggleUnownedFilter()" style="display:none;">
                            æœªæ‰€æŒã®ã¿è¡¨ç¤º
                        </button>
                    </div>
                </div>

                <!-- å…¥æ‰‹æ–¹æ³•ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div class="row g-3 mt-1">
                    <div class="col-12 col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-secondary btn-sm w-100" type="button"
                            onclick="resetAllFilters()">
                            ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- ã‚°ãƒªãƒƒãƒ‰ -->
            <div id="badge-list-grid" class="row g-3">
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                    </div>
                </div>
            </div>
            <nav aria-label="Page navigation" class="mt-3" id="badge-pagination-area" style="display:none;">
                <div class="small text-muted text-center mb-2" id="badge-page-info"></div>
                <ul class="pagination pagination-sm justify-content-center mb-0" id="badge-pagination"></ul>
            </nav>
        </div>
    </div>

    <!-- Supabase & Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/auth-guard.js"></script>
    <script src="../js/badge-utils.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        console.log('badge/list build 2026-02-07-03');
        document.addEventListener('DOMContentLoaded', function () {
            initAccordionNav('../');
        });

        let allBadges = [];
        let rarityThresholds = [];
        let rarityOrder = getRarityOrder();
        let creatorMap = new Map();
        let ownedBadgeIds = new Set();
        let currentPage = 1;
        const filters = {
            rarity: '',
            creator: '',
            type: '',
            label: '',
            tag: '',
            method: '',
            unownedOnly: false
        };
        const FILTER_STORAGE_KEY = 'badge_list_filters_v1';

        let cachedCirculationCounts = {}; // ãƒãƒƒã‚¸ã”ã¨ã®æµé€šæ•°

        async function initBadgeList() {
            try {
                // ãƒ¬ã‚¢ãƒªãƒ†ã‚£é–¾å€¤ã¨ãƒãƒƒã‚¸æƒ…å ±ã®å–å¾—
                const [badgesRes, thresholdsRes] = await Promise.all([
                    supabaseClient.from('badges').select('*').order('sort_order', { ascending: true }),
                    supabaseClient.from('rarity_thresholds').select('*').order('threshold_value', { ascending: true })
                ]);

                if (badgesRes.error) throw badgesRes.error;
                if (thresholdsRes.error) throw thresholdsRes.error;

                allBadges = badgesRes.data || [];
                rarityThresholds = thresholdsRes.data || [];
                rarityOrder = getRarityOrder();

                cachedCirculationCounts = await fetchCirculationCounts();

                await hydrateCreators();
                await hydrateOwnedBadges();
                buildFilterOptions();
                const restored = loadFilterState();
                applyTagFromUrl(restored);
                clearStaleCreatorFilter(restored);
                filterAndRender();
            } catch (err) {
                console.error('Error fetching badges:', err);
                document.getElementById('badge-list-grid').innerHTML = '<div class="col-12 text-center text-danger py-5">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        async function fetchCirculationCounts() {
            const counts = {};
            const pageSize = 1000;
            let from = 0;
            while (true) {
                const { data, error } = await supabaseClient
                    .from('user_badges_new')
                    .select('badge_id')
                    .range(from, from + pageSize - 1);
                if (error) throw error;

                (data || []).forEach(item => {
                    counts[item.badge_id] = (counts[item.badge_id] || 0) + 1;
                });

                if (!data || data.length < pageSize) break;
                from += pageSize;
            }
            return counts;
        }

        function getDynamicRarity(assetValue, fixedRarity) {
            if (fixedRarity) return fixedRarity;
            if (!rarityThresholds || rarityThresholds.length === 0) return '-';
            let current = rarityThresholds[0].rarity_name;
            for (const t of rarityThresholds) {
                if (assetValue >= t.threshold_value) {
                    current = t.rarity_name;
                } else {
                    break;
                }
            }
            return current;
        }

        function getRarityOrder() {
            if (rarityThresholds && rarityThresholds.length) {
                return rarityThresholds.map(r => r.rarity_name).concat(['-']);
            }
            return ['æ¸¬å®šä¸èƒ½', 'ç¥è©±', 'è‡³é«˜', 'å¹»æƒ³', 'ä¼èª¬', 'æ¥µä¸Š', 'ç‰¹ä¸Š', 'è²´é‡', 'å¸Œå°‘ãƒ»â…¡', 'å¸Œå°‘ãƒ»â… ', 'è‰¯è³ª', 'ä¸€èˆ¬', '-'];
        }

        function toggleUnownedFilter() {
            filters.unownedOnly = !filters.unownedOnly;
            const btn = document.getElementById('unowned-toggle');
            if (btn) {
                btn.classList.toggle('btn-primary', filters.unownedOnly);
                btn.classList.toggle('btn-outline-secondary', !filters.unownedOnly);
                btn.textContent = filters.unownedOnly ? 'æœªæ‰€æŒã®ã¿è¡¨ç¤ºä¸­' : 'æœªæ‰€æŒã®ã¿è¡¨ç¤º';
            }
            currentPage = 1;
            filterAndRender();
        }

        function getPageSize() {
            return window.innerWidth < 768 ? 20 : 48;
        }

        function renderPagination(total) {
            const area = document.getElementById('badge-pagination-area');
            const info = document.getElementById('badge-page-info');
            const pagination = document.getElementById('badge-pagination');
            const pageSize = getPageSize();
            if (!area || !info || !pagination) return;

            if (total <= pageSize) {
                area.style.display = 'none';
                pagination.innerHTML = '';
                info.textContent = '';
                return;
            }

            const totalPages = Math.ceil(total / pageSize);
            if (currentPage > totalPages) currentPage = totalPages;
            area.style.display = 'block';
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, total);
            info.textContent = `${start} - ${end} / ${total} ä»¶`;

            const pages = [];
            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) pages.push(i);
            } else {
                pages.push(1);
                let startPage = Math.max(2, currentPage - 1);
                let endPage = Math.min(totalPages - 1, currentPage + 1);
                if (startPage > 2) pages.push('...');
                for (let i = startPage; i <= endPage; i++) pages.push(i);
                if (endPage < totalPages - 1) pages.push('...');
                pages.push(totalPages);
            }

            const buildItem = (label, page, disabled = false, active = false) => `
                <li class="page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}">
                    <button class="page-link" type="button" ${disabled ? 'disabled' : ''} data-page="${page}">${label}</button>
                </li>
            `;

            let html = '';
            html += buildItem('â€¹', currentPage - 1, currentPage === 1);
            html += pages.map(p => {
                if (p === '...') {
                    return buildItem('â€¦', 'ellipsis', true);
                }
                return buildItem(p, p, false, p === currentPage);
            }).join('');
            html += buildItem('â€º', currentPage + 1, currentPage === totalPages);
            pagination.innerHTML = html;
            pagination.querySelectorAll('button[data-page]').forEach(btn => {
                const page = btn.getAttribute('data-page');
                if (page === 'ellipsis') return;
                btn.addEventListener('click', () => {
                    const nextPage = parseInt(page, 10);
                    if (!Number.isNaN(nextPage)) {
                        currentPage = nextPage;
                        filterAndRender();
                    }
                });
            });
        }

        async function hydrateCreators() {
            const creatorIds = [...new Set(allBadges.map(b => b.discord_user_id).filter(Boolean))];
            if (creatorIds.length === 0) return;
            const { data } = await supabaseClient
                .from('profiles')
                .select('discord_user_id, account_name, avatar_url, is_hidden')
                .in('discord_user_id', creatorIds);
            (data || []).filter(c => !c.is_hidden).forEach(c => {
                creatorMap.set(c.discord_user_id, { name: c.account_name || c.discord_user_id, avatar: c.avatar_url || '' });
            });
        }

        async function hydrateOwnedBadges() {
            const user = await getCurrentUser();
            const btn = document.getElementById('unowned-toggle');
            if (!user) {
                if (btn) btn.style.display = 'none';
                return;
            }
            const targetId = user.user_metadata.provider_id;
            const { data } = await supabaseClient
                .from('user_badges_new')
                .select('badge_id')
                .eq('user_id', targetId);
            (data || []).forEach(r => ownedBadgeIds.add(r.badge_id));
            if (btn) btn.style.display = 'inline-block';
        }

        // fail-safe: avoid ReferenceError if script order/cached build is stale
        if (typeof window.updateDynamicFilterOptions !== 'function') {
            window.updateDynamicFilterOptions = function () { };
        }

        function buildFilterOptions() {
            const raritySelect = document.getElementById('rarity-filter');
            const labelSelect = document.getElementById('label-filter');
            const methodSelect = document.getElementById('method-filter');
            if (raritySelect) {
                // handled by custom menu
            }
            if (typeof updateDynamicFilterOptions === 'function') {
                updateDynamicFilterOptions(allBadges);
            }
        }

        function isValidAvatarUrl(url) {
            return typeof url === 'string' && /^https?:\/\//.test(url);
        }

        function setRarityFilter(value, name) {
            const input = document.getElementById('rarity-filter');
            const label = document.getElementById('rarity-filter-label');
            if (input) input.value = value || '';
            if (label) label.textContent = name || 'ã™ã¹ã¦';
            currentPage = 1;
            filterAndRender();
        }

        function setCreatorFilter(id, name, avatar) {
            const input = document.getElementById('creator-filter');
            const label = document.getElementById('creator-filter-label');
            const img = document.getElementById('creator-filter-avatar');
            if (input) input.value = id || '';
            if (label) label.textContent = name || 'ã™ã¹ã¦';
            if (img) {
                if (avatar && /^https?:\/\//.test(avatar)) {
                    img.src = avatar;
                    img.style.display = 'block';
                } else {
                    img.style.display = 'none';
                }
            }
            currentPage = 1;
            filterAndRender();
        }

        function saveFilterState() {
            try {
                const state = {
                    search: document.getElementById('search-box')?.value || '',
                    sort: document.getElementById('sort-select')?.value || 'price_asc',
                    rarity: document.getElementById('rarity-filter')?.value || '',
                    rarityLabel: document.getElementById('rarity-filter-label')?.textContent || 'ã™ã¹ã¦',
                    creator: document.getElementById('creator-filter')?.value || '',
                    creatorLabel: document.getElementById('creator-filter-label')?.textContent || 'ã™ã¹ã¦',
                    creatorAvatar: document.getElementById('creator-filter-avatar')?.src || '',
                    type: document.getElementById('type-filter')?.value || '',
                    label: document.getElementById('label-filter')?.value || '',
                    tag: document.getElementById('tag-filter')?.value || '',
                    method: document.getElementById('method-filter')?.value || '',
                    unownedOnly: !!filters.unownedOnly,
                    page: currentPage
                };
                sessionStorage.setItem(FILTER_STORAGE_KEY, JSON.stringify(state));
            } catch (err) {
                console.warn('Failed to save filter state', err);
            }
        }

        function loadFilterState() {
            try {
                const raw = sessionStorage.getItem(FILTER_STORAGE_KEY);
                if (!raw) return false;
                const state = JSON.parse(raw);
                const search = document.getElementById('search-box');
                const sort = document.getElementById('sort-select');
                const rarityInput = document.getElementById('rarity-filter');
                const rarityLabel = document.getElementById('rarity-filter-label');
                const creatorInput = document.getElementById('creator-filter');
                const creatorLabel = document.getElementById('creator-filter-label');
                const creatorAvatar = document.getElementById('creator-filter-avatar');
                const type = document.getElementById('type-filter');
                const label = document.getElementById('label-filter');
                const tag = document.getElementById('tag-filter');
                const method = document.getElementById('method-filter');
                const unownedBtn = document.getElementById('unowned-toggle');

                if (search) search.value = state.search || '';
                if (sort) sort.value = state.sort || 'price_asc';
                if (rarityInput) rarityInput.value = state.rarity || '';
                if (rarityLabel) rarityLabel.textContent = state.rarityLabel || (state.rarity ? state.rarity : 'ã™ã¹ã¦');
                if (creatorInput) creatorInput.value = state.creator || '';
                if (creatorLabel) creatorLabel.textContent = state.creatorLabel || (state.creator ? state.creator : 'ã™ã¹ã¦');
                if (creatorAvatar) {
                    if (state.creatorAvatar && /^https?:\/\//.test(state.creatorAvatar)) {
                        creatorAvatar.src = state.creatorAvatar;
                        creatorAvatar.style.display = 'block';
                    } else {
                        creatorAvatar.src = '';
                        creatorAvatar.style.display = 'none';
                    }
                }
                if (creatorInput && !creatorInput.value) {
                    if (creatorAvatar) {
                        creatorAvatar.src = '';
                        creatorAvatar.style.display = 'none';
                    }
                    if (creatorLabel) creatorLabel.textContent = 'ã™ã¹ã¦';
                }
                if (type) type.value = state.type || '';
                if (label) label.value = state.label || '';
                if (tag) tag.value = state.tag || '';
                if (method) method.value = state.method || '';
                filters.unownedOnly = !!state.unownedOnly;
                if (unownedBtn) {
                    unownedBtn.classList.toggle('btn-primary', filters.unownedOnly);
                    unownedBtn.classList.toggle('btn-outline-secondary', !filters.unownedOnly);
                    unownedBtn.textContent = filters.unownedOnly ? 'æœªæ‰€æŒã®ã¿è¡¨ç¤ºä¸­' : 'æœªæ‰€æŒã®ã¿è¡¨ç¤º';
                }
                currentPage = Number(state.page) || 1;
                return true;
            } catch (err) {
                console.warn('Failed to load filter state', err);
                return false;
            }
        }

        function filterAndRender() {
            const grid = document.getElementById('badge-list-grid');
            const searchVal = document.getElementById('search-box').value.toLowerCase();
            const sortBy = document.getElementById('sort-select').value;
            filters.rarity = document.getElementById('rarity-filter')?.value || '';
            filters.creator = document.getElementById('creator-filter')?.value || '';
            filters.type = document.getElementById('type-filter')?.value || '';
            filters.label = document.getElementById('label-filter')?.value || '';
            filters.tag = document.getElementById('tag-filter')?.value || '';
            filters.method = document.getElementById('method-filter')?.value || '';
            updateDynamicFilterOptions(allBadges);

            // 1. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filtered = allBadges.filter(b => {
                // åå‰æ¤œç´¢
                if (searchVal && !b.name.toLowerCase().includes(searchVal)) return false;

                // å…¥æ‰‹æ–¹æ³•ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                switch (filters.method) {
                    case 'shop':
                        if (!b.is_shop_listed) return false;
                        break;
                    case 'gacha':
                        if (!b.is_gacha_eligible) return false;
                        break;
                    case 'not_for_sale':
                        if (b.is_shop_listed || b.is_gacha_eligible) return false;
                        if (b.sales_type === 'é™å®šå“' || b.sales_type === 'æ›é‡‘å“') return false;
                        break;
                    default:
                        break;
                }

                if (filters.rarity) {
                    const circulationCount = cachedCirculationCounts[b.id] || 0;
                    const result = BadgeUtils.calculateBadgeValues(b, circulationCount, rarityThresholds);
                    if (result.rarityName !== filters.rarity) return false;
                }

                if (filters.creator && b.discord_user_id !== filters.creator) return false;
                if (filters.type && b.sales_type !== filters.type) return false;
                if (filters.label && (b.label || '').trim() !== filters.label) return false;
                if (filters.tag) {
                    const tags = getBadgeTags(b);
                    if (!tags.includes(filters.tag)) return false;
                }
                if (filters.unownedOnly && ownedBadgeIds.size > 0 && ownedBadgeIds.has(b.id)) return false;

                return true;
            });

            // å„ãƒãƒƒã‚¸ã«è³‡ç”£ä¾¡å€¤ã¨å‹•çš„ãƒ¬ã‚¢ãƒªãƒ†ã‚£æƒ…å ±ã‚’ä»˜åŠ ï¼ˆã‚½ãƒ¼ãƒˆç”¨ï¼‰
            filtered.forEach(b => {
                const circulationCount = cachedCirculationCounts[b.id] || 0;
                const result = BadgeUtils.calculateBadgeValues(b, circulationCount, rarityThresholds);
                b._assetValue = result.marketValue;
                b._rarity = result.rarityName;
                b._starLevel = result.starLevel;
            });

            // 2. ã‚½ãƒ¼ãƒˆ
            if (sortBy === 'number') {
                filtered.sort((a, b) => (a.sort_order ?? 9999) - (b.sort_order ?? 9999));
            } else if (sortBy === 'rarity') {
                filtered.sort((a, b) => {
                    // 1. fixed_rarity_name ãŒã‚ã‚‹ã‚‚ã®ã¯ä¸€ç•ªä¸‹ã«ã™ã‚‹
                    if (a.fixed_rarity_name && !b.fixed_rarity_name) return 1;
                    if (!a.fixed_rarity_name && b.fixed_rarity_name) return -1;

                    // 2. â˜…ãƒ¬ãƒ™ãƒ«ã§æ¯”è¼ƒï¼ˆé«˜ã„é †ï¼‰
                    if (b._starLevel !== a._starLevel) return b._starLevel - a._starLevel;

                    // 3. åŒã˜ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãªã‚‰è³‡ç”£ä¾¡å€¤é †ï¼ˆé«˜ã„é †ï¼‰
                    if ((b._assetValue || 0) !== (a._assetValue || 0)) {
                        return (b._assetValue || 0) - (a._assetValue || 0);
                    }

                    // 4. ã¾ã åŒã˜ãªã‚‰ãƒŠãƒ³ãƒãƒ¼é †
                    return (a.sort_order ?? 9999) - (b.sort_order ?? 9999);
                });
            } else if (sortBy === 'price_asc') {
                filtered.sort((a, b) => (a._assetValue || 0) - (b._assetValue || 0));
            } else if (sortBy === 'price_desc') {
                filtered.sort((a, b) => (b._assetValue || 0) - (a._assetValue || 0));
            } else if (sortBy === 'circulation_asc') {
                filtered.sort((a, b) => (cachedCirculationCounts[a.id] || 0) - (cachedCirculationCounts[b.id] || 0));
            } else if (sortBy === 'circulation_desc') {
                filtered.sort((a, b) => (cachedCirculationCounts[b.id] || 0) - (cachedCirculationCounts[a.id] || 0));
            } else if (sortBy === 'id_asc') {
                filtered.sort((a, b) => (a.sort_order ?? 9999) - (b.sort_order ?? 9999));
            } else if (sortBy === 'id_desc') {
                filtered.sort((a, b) => (b.sort_order ?? 9999) - (a.sort_order ?? 9999));
            } else if (sortBy === 'name') {
                filtered.sort((a, b) => a.name.localeCompare(b.name));
            }

            // 3. æç”»
            document.getElementById('badge-count-status').textContent = `${filtered.length} / ${allBadges.length} ä»¶`;

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center text-muted py-5">è©²å½“ã™ã‚‹ãƒãƒƒã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            renderPagination(filtered.length);
            const pageSize = getPageSize();
            const startIdx = (currentPage - 1) * pageSize;
            const endIdx = startIdx + pageSize;
            const pageItems = filtered.slice(startIdx, endIdx);

            grid.innerHTML = pageItems.map(badge => {
                const rarity = badge._rarity;
                const rarityClass = getRarityClass(rarity);
                const tags = getBadgeTags(badge);
                const tagHtml = tags.length
                    ? `<div class="badge-tag-list">${tags.map(t => `<span class="badge-tag badge-tag-link" role="button" tabindex="0" onclick="event.preventDefault(); event.stopPropagation(); window.location.href='./list.html?tag=${encodeURIComponent(t)}';">#${escapeHtml(t)}</span>`).join('')}</div>`
                    : '';
                return `
                    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
                        <a href="./index.html?id=${badge.id}" class="badge-item-large badge-card ${rarityClass}" style="color: inherit;">
                            <div class="badge-number-label" style="color: inherit; opacity: 0.6;">#${badge.sort_order ?? '???'}</div>
                            <div class="rarity-pill mb-2" style="background: rgba(0,0,0,0.2);">${rarity}</div>
                            <img src="${badge.image_url}" class="badge-img-large" alt="${badge.name}" style="filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));">
                            <div class="badge-name-large" style="color: inherit;">${badge.name}</div>
                            ${tagHtml}
                        </a>
                    </div>
                `;
            }).join('');

            saveFilterState();
        }

        function resetAllFilters() {
            document.getElementById('search-box').value = '';
            document.getElementById('sort-select').value = 'price_asc';
            document.getElementById('type-filter').value = '';
            document.getElementById('label-filter').value = '';
            document.getElementById('tag-filter').value = '';
            document.getElementById('method-filter').value = '';
            const rarityInput = document.getElementById('rarity-filter');
            if (rarityInput) rarityInput.value = '';
            const rarityLabel = document.getElementById('rarity-filter-label');
            if (rarityLabel) rarityLabel.textContent = 'ã™ã¹ã¦';
            setCreatorFilter('', 'ã™ã¹ã¦', '');
            filters.unownedOnly = false;
            const btn = document.getElementById('unowned-toggle');
            if (btn) {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-secondary');
                btn.textContent = 'æœªæ‰€æŒã®ã¿è¡¨ç¤º';
            }
            currentPage = 1;
            filterAndRender();
        }

        document.addEventListener('DOMContentLoaded', initBadgeList);

        function getRarityForBadge(badge) {
            const circulationCount = cachedCirculationCounts[badge.id] || 0;
            const result = BadgeUtils.calculateBadgeValues(badge, circulationCount, rarityThresholds);
            return result.rarityName;
        }

        function getBadgeTags(badge) {
            if (!badge) return [];
            const tags = badge.tags;
            if (!Array.isArray(tags)) return [];
            return tags.map(t => (t || '').trim()).filter(Boolean);
        }

        function applyTagFromUrl(hasRestored) {
            const params = new URLSearchParams(window.location.search);
            const tag = (params.get('tag') || '').trim();
            if (!tag) return;
            const tagSelect = document.getElementById('tag-filter');
            if (!tagSelect) return;
            if (![...tagSelect.options].some(o => o.value === tag)) {
                const opt = document.createElement('option');
                opt.value = tag;
                opt.textContent = tag;
                tagSelect.appendChild(opt);
            }
            tagSelect.value = tag;
            filters.tag = tag;
            currentPage = 1;
            // ã‚¿ã‚°é·ç§»æ™‚ã¯ã€ä¿å­˜æ¸ˆã¿ã®ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¦æ··åœ¨ã‚’é˜²ã
            const creatorInput = document.getElementById('creator-filter');
            const creatorLabel = document.getElementById('creator-filter-label');
            const creatorAvatar = document.getElementById('creator-filter-avatar');
            if (creatorInput) creatorInput.value = '';
            if (creatorLabel) creatorLabel.textContent = 'ã™ã¹ã¦';
            if (creatorAvatar) {
                creatorAvatar.src = '';
                creatorAvatar.style.display = 'none';
            }
            filters.creator = '';
            saveFilterState();
        }

        function clearStaleCreatorFilter(hasRestored) {
            if (!hasRestored) return;
            const params = new URLSearchParams(window.location.search);
            const hasTag = !!(params.get('tag') || '').trim();
            if (hasTag) return;

            const ref = document.referrer || '';
            const sameOrigin = ref.includes(window.location.hostname);
            const isReturnFromBadgePage = sameOrigin && (
                ref.includes('/badge/list.html') ||
                ref.includes('/badge/index.html')
            );

            if (isReturnFromBadgePage) return;

            const creatorInput = document.getElementById('creator-filter');
            const creatorLabel = document.getElementById('creator-filter-label');
            const creatorAvatar = document.getElementById('creator-filter-avatar');
            if (creatorInput) creatorInput.value = '';
            if (creatorLabel) creatorLabel.textContent = 'ã™ã¹ã¦';
            if (creatorAvatar) creatorAvatar.style.display = 'none';
            filters.creator = '';
            saveFilterState();
        }

        function goBack() {
            if (document.referrer && document.referrer.includes(window.location.hostname)) {
                history.back();
            } else {
                window.location.href = '../badge/shop.html';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const tag = (params.get('tag') || '').trim();
            const wrap = document.getElementById('back-to-shop-wrap');
            if (wrap && tag) wrap.style.display = 'block';
        });

        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function matchesMethodFilter(badge, method) {
            if (!method) return true;
            if (method === 'shop') return badge.is_shop_listed;
            if (method === 'gacha') return badge.is_gacha_eligible;
            if (method === 'not_for_sale') {
                if (badge.is_shop_listed || badge.is_gacha_eligible) return false;
                if (badge.sales_type === 'é™å®šå“' || badge.sales_type === 'æ›é‡‘å“') return false;
                return true;
            }
            return true;
        }

        function matchesFilters(b, opts, excludeKey = '') {
            if (opts.searchVal && !b.name.toLowerCase().includes(opts.searchVal)) return false;
            if (excludeKey !== 'method' && opts.method && !matchesMethodFilter(b, opts.method)) return false;
            if (excludeKey !== 'rarity' && opts.rarity) {
                const r = getRarityForBadge(b);
                if (r !== opts.rarity) return false;
            }
            if (excludeKey !== 'creator' && opts.creator && b.discord_user_id !== opts.creator) return false;
            if (excludeKey !== 'type' && opts.type && b.sales_type !== opts.type) return false;
            if (excludeKey !== 'label' && opts.label && (b.label || '').trim() !== opts.label) return false;
            if (excludeKey !== 'tag' && opts.tag) {
                const tags = getBadgeTags(b);
                if (!tags.includes(opts.tag)) return false;
            }
            if (excludeKey !== 'unownedOnly' && opts.unownedOnly && ownedBadgeIds.size > 0 && ownedBadgeIds.has(b.id)) return false;
            return true;
        }

        function updateDynamicFilterOptions(sourceBadges) {
            const searchVal = document.getElementById('search-box')?.value.toLowerCase() || '';
            const currentType = document.getElementById('type-filter')?.value || '';
            const currentLabel = document.getElementById('label-filter')?.value || '';
            const currentTag = document.getElementById('tag-filter')?.value || '';
            const currentMethod = document.getElementById('method-filter')?.value || '';
            const baseOpts = {
                searchVal,
                rarity: filters.rarity,
                creator: filters.creator,
                type: filters.type,
                label: filters.label,
                tag: filters.tag,
                method: filters.method,
                unownedOnly: filters.unownedOnly
            };

            const baseForRarity = sourceBadges.filter(b => matchesFilters(b, baseOpts, 'rarity'));
            const baseForCreator = sourceBadges.filter(b => matchesFilters(b, baseOpts, 'creator'));
            const baseForType = sourceBadges.filter(b => matchesFilters(b, baseOpts, 'type'));
            const baseForLabel = sourceBadges.filter(b => matchesFilters(b, baseOpts, 'label'));
            const baseForTag = sourceBadges.filter(b => matchesFilters(b, baseOpts, 'tag'));
            const baseForMethod = sourceBadges.filter(b => matchesFilters(b, baseOpts, 'method'));

            // ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            const rarityCounts = {};
            baseForRarity.forEach(b => {
                const r = getRarityForBadge(b) || '-';
                rarityCounts[r] = (rarityCounts[r] || 0) + 1;
            });
            buildRarityMenuFromCounts(rarityCounts);

            // ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼
            buildCreatorMenuFromBase(baseForCreator);

            // ã‚¿ã‚¤ãƒ—
            const typeSelect = document.getElementById('type-filter');
            if (typeSelect) {
                const counts = {};
                baseForType.forEach(b => {
                    if (!b.sales_type) return;
                    counts[b.sales_type] = (counts[b.sales_type] || 0) + 1;
                });
                const options = Object.entries(counts)
                    .filter(([, c]) => c > 0)
                    .map(([t, c]) => `<option value="${t}">${t} (${c})</option>`)
                    .join('');
                typeSelect.innerHTML = `<option value="">ã™ã¹ã¦</option>${options}`;
                if ([...typeSelect.options].some(o => o.value === currentType)) {
                    typeSelect.value = currentType;
                } else {
                    typeSelect.value = '';
                }
            }

            // ãƒ©ãƒ™ãƒ«
            const labelSelect = document.getElementById('label-filter');
            if (labelSelect) {
                const counts = {};
                baseForLabel.forEach(b => {
                    const label = (b.label || '').trim();
                    if (!label) return;
                    counts[label] = (counts[label] || 0) + 1;
                });
                const options = Object.entries(counts)
                    .filter(([, c]) => c > 0)
                    .map(([l, c]) => `<option value="${l}">${l} (${c})</option>`)
                    .join('');
                labelSelect.innerHTML = `<option value="">ã™ã¹ã¦</option>${options}`;
                if ([...labelSelect.options].some(o => o.value === currentLabel)) {
                    labelSelect.value = currentLabel;
                } else {
                    labelSelect.value = '';
                }
            }

            // ã‚¿ã‚°
            const tagSelect = document.getElementById('tag-filter');
            if (tagSelect) {
                const counts = {};
                baseForTag.forEach(b => {
                    getBadgeTags(b).forEach(tag => {
                        counts[tag] = (counts[tag] || 0) + 1;
                    });
                });
                const options = Object.entries(counts)
                    .filter(([, c]) => c > 0)
                    .sort((a, b) => a[0].localeCompare(b[0], 'ja'))
                    .map(([t, c]) => `<option value="${t}">${t} (${c})</option>`)
                    .join('');
                tagSelect.innerHTML = `<option value="">ã™ã¹ã¦</option>${options}`;
                if ([...tagSelect.options].some(o => o.value === currentTag)) {
                    tagSelect.value = currentTag;
                } else {
                    tagSelect.value = '';
                }
            }

            // å…¥æ‰‹æ–¹æ³•
            const methodSelect = document.getElementById('method-filter');
            if (methodSelect) {
                const counts = {
                    shop: baseForMethod.filter(b => b.is_shop_listed).length,
                    gacha: baseForMethod.filter(b => b.is_gacha_eligible).length,
                    not_for_sale: baseForMethod.filter(b => !b.is_shop_listed && !b.is_gacha_eligible && b.sales_type !== 'é™å®šå“' && b.sales_type !== 'æ›é‡‘å“').length
                };
                const options = [];
                if (counts.shop > 0) options.push(`<option value="shop">ã‚·ãƒ§ãƒƒãƒ—è²©å£²ä¸­ (${counts.shop})</option>`);
                if (counts.gacha > 0) options.push(`<option value="gacha">ã‚¬ãƒãƒ£æ’å‡º (${counts.gacha})</option>`);
                if (counts.not_for_sale > 0) options.push(`<option value="not_for_sale">éå£²å“ (${counts.not_for_sale})</option>`);
                methodSelect.innerHTML = `<option value="">ã™ã¹ã¦</option>${options.join('')}`;
                if ([...methodSelect.options].some(o => o.value === currentMethod)) {
                    methodSelect.value = currentMethod;
                } else {
                    methodSelect.value = '';
                }
            }
        }

        function buildCreatorMenuFromBase(baseBadges) {
            const menu = document.getElementById('creator-filter-menu');
            const btn = document.getElementById('creator-filter-btn');
            if (!menu || !btn) return;
            const counts = {};
            baseBadges.forEach(b => {
                if (!b.discord_user_id) return;
                counts[b.discord_user_id] = (counts[b.discord_user_id] || 0) + 1;
            });
            const creatorIds = new Set(Object.keys(counts));
            const items = [{ id: '', name: 'ã™ã¹ã¦', avatar: '' }]
                .concat(
                    [...creatorIds].map(id => {
                        const info = creatorMap.get(id) || { name: id, avatar: '' };
                        return { id, name: info.name, avatar: info.avatar, count: counts[id] };
                    }).sort((a, b) => a.name.localeCompare(b.name))
                );
            menu.innerHTML = items.map(item => `
                <div class="creator-item" data-id="${item.id}" data-name="${item.name}" data-avatar="${item.avatar || ''}">
                    ${isValidAvatarUrl(item.avatar) ? `<img src="${item.avatar}" class="creator-avatar" style="display:block;">` : '<span class="creator-avatar" style="display:inline-block;"></span>'}
                    <span>${item.name}</span>
                    ${item.id ? `<span class="ms-auto text-muted small">(${item.count})</span>` : ''}
                </div>
            `).join('');
            menu.querySelectorAll('.creator-item').forEach(el => {
                el.addEventListener('click', () => {
                    setCreatorFilter(el.dataset.id, el.dataset.name, el.dataset.avatar);
                    menu.style.display = 'none';
                });
            });
            if (!btn.dataset.bound) {
                btn.addEventListener('click', () => {
                    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
                });
                document.addEventListener('click', (e) => {
                    if (!menu.contains(e.target) && !btn.contains(e.target)) {
                        menu.style.display = 'none';
                    }
                });
                btn.dataset.bound = '1';
            }
        }

        function buildRarityMenuFromCounts(rarityCounts) {
            const menu = document.getElementById('rarity-filter-menu');
            const btn = document.getElementById('rarity-filter-btn');
            if (!menu || !btn) return;
            const items = [{ name: 'ã™ã¹ã¦', value: '' }]
                .concat(Object.keys(rarityCounts).map(r => ({ name: r, value: r, count: rarityCounts[r] })))
                .sort((a, b) => {
                    if (a.value === '') return -1;
                    if (b.value === '') return 1;
                    const aIdx = rarityOrder.indexOf(a.name);
                    const bIdx = rarityOrder.indexOf(b.name);
                    if (aIdx === -1 && bIdx === -1) return a.name.localeCompare(b.name);
                    if (aIdx === -1) return 1;
                    if (bIdx === -1) return -1;
                    return aIdx - bIdx;
                });
            menu.innerHTML = items.map(item => {
                if (item.value === '') {
                    return `<div class="creator-item" data-value="" data-name="ã™ã¹ã¦"><span>ã™ã¹ã¦</span></div>`;
                }
                const cls = getRarityClass(item.name);
                const displayName = cls ? item.name : 'â˜…???';
                const badgeClass = cls ? cls : 'rarity-unknown';
                return `
                    <div class="creator-item" data-value="${item.value}" data-name="${item.name}">
                        <span class="badge ${badgeClass} text-white" title="${item.name}">${displayName}</span>
                        <span class="ms-auto text-muted small">(${item.count})</span>
                    </div>
                `;
            }).join('');
            menu.querySelectorAll('.creator-item').forEach(el => {
                el.addEventListener('click', () => {
                    setRarityFilter(el.dataset.value, el.dataset.name);
                    menu.style.display = 'none';
                });
            });
            if (!btn.dataset.bound) {
                btn.addEventListener('click', () => {
                    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
                });
                document.addEventListener('click', (e) => {
                    if (!menu.contains(e.target) && !btn.contains(e.target)) {
                        menu.style.display = 'none';
                    }
                });
                btn.dataset.bound = '1';
            }
        }
    </script>
</body>

</html>
