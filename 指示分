# 追加修正（FS回数増加時の不整合）— event/slot.html / Codex依頼用

## 現象
FSの回転数（残り回数）が増えたタイミングで、状態復元/遷移がうまく処理できず、以下の壊れた初期状態になることがある（致命的ではないが体験が崩れる）：

- 「フリースピンを開始」ボタンが押せない（押下不可/分岐不整合）
- カットインが出ない
- 回転アニメが始まらない
- しかし **1リール目のSTOPボタンだけ押せる**状態から始まる
  - ※STOPボタンは常時表示で正しい。問題は「押せる/強調が付く」状態が部分的になること。

=> UI（FS開始待ち）と `reelState`（一部spinning）が矛盾している。

---

## 正しい挙動（必須）
### FS開始待ち（fs_ready）状態のとき
- 「フリースピンを開始」ボタン：**必ず押せる**
- リール：**全リール停止表示**（回転しない）
- STOPボタン：常時表示。ただし
  - **全リール押せない**
  - **強調（光/色）なし**

### FS開始ボタン押下時（毎回）
- カットイン表示（`FreeSpin 残り〇` を必ず表示）
- 図柄リセット（空表示は作らない）
- 全リール `spinning` に遷移し回転開始
- STOPボタン：spinning のリールのみ押下可能 + 強調ON

### 禁止状態
- fs_ready なのに一部リールが spinning（=STOP押下可能/強調ON）になっている
- fs_ready なのにFS開始ボタンが押せない
- カットインも回転もないのに、どれかのSTOPだけ押せる

---

## 実装指針（最重要）
### 1) FS状態の「正規化（normalize）」を必ず通す
FS残り回数が増えたタイミング（サーバー返却で remaining が増えた/更新されたタイミング）で、
UIと `reelState` を必ず正しい形に矯正する関数を作って適用する。

例：`normalizeFreeSpinState()`
- 入力：`currentSession`（FS関連フラグ＋remaining）、`displayReels`（停止データ）、`phase`、`reelState`
- 出力：矛盾のない `phase` と `reelState` と UI状態

#### 正規化ルール（例）
- 条件A：FS開始待ち（例：free_spin_confirmed=true かつ free_spin_active=false 等）
  - `phase = 'fs_ready'`
  - `reelState = 全リール 'stopped'`（部分spinning禁止）
  - FS開始ボタン enabled
- 条件B：FS回転中（free_spin_active=true）
  - `phase = 'fs_spinning'`
  - `reelState = spinning のリールのみ spinning`（通常は全リール）
  - FS開始ボタン disabled/非活性（表示は仕様に合わせる）

※判定条件は実データのFSフラグに合わせて実装すること。

### 2) FS開始ボタンの enabled 判定は phase 基準に統一
- `phase === 'fs_ready'` のときは必ず押下可能にする（例外を作らない）
- 逆に `fs_spinning` 等では押下不可

### 3) STOPボタンは常時表示、押下可否＋強調だけ制御
- STOPボタンは常時表示のまま
- 押下可能条件：`reelState[i] === 'spinning'` のときのみ
- UI制御（例）：
  - `stopBtn.disabled = (reelState[i] !== 'spinning')`
  - `stopBtn.classList.toggle('is-active', reelState[i] === 'spinning')`（強調ON/OFF）
  - `stopBtn.classList.toggle('is-disabled', reelState[i] !== 'spinning')`

### 4) 正規化の適用タイミング（必須）
以下のタイミングで必ず `normalizeFreeSpinState()` → `renderReelState()` を呼ぶ：
- ページロード後に `currentSession` を取得した直後
- FS残り回数（remaining）が増えた/更新された直後
- FS開始ボタン描画直前（ボタンenable/disable決定前）

---

## 受け入れ条件
- FS回数（remaining）が増えたケースでも、復帰時に必ず fs_ready に正規化され
  - FS開始ボタンが押せる
  - 全リール停止（回転なし）
  - STOPは常時表示だが全リール押せず強調なし
- FS開始ボタン押下で必ず
  - カットイン（FreeSpin 残り〇）
  - 全リール回転開始
  - spinning のリールのみ STOP押下可能＋強調ON
- 「1リール目だけSTOP可で開始」する不整合が再現しない