# スロット修正まとめ（event/slot.html / Codex依頼用）

対象ファイル
- event/slot.html

目的
- STOP/通常→FS遷移/FS演出/リロード復元/UI進行不能バグをまとめて修正し、空リールや二度押し、リロード詰みを完全に無くす。

---

## 要件一覧（1〜5）

### 1) 通常時にバースト成立したら「残りのリール」もBURST表示にする（空表示NG）
- バースト成立が確定した瞬間（サーバー応答時点）から、画面上は **全リールがBURST図柄** に揃って見えること。
- 実装手段はどれでもOK：
  - 残りリールのdisplayデータにBURSTを格納
  - displayがNULLなら NULL=BURST として描画
  - バースト成立時のレンダリングで未確定箇所をBURSTへ置換
- 受け入れ条件：BURST成立後に「何も表示されていないリール」が一切存在しない。

---

### 2) FS開始ボタン1回押下で「カットイン＋図柄リセット＋全リール回転開始」まで完結させる（2回押しNG / 空リールNG）
理想シーケンス（必須）
- 全リール停止（BURST表示）
→ 「フリースピンを開始」押下
→ **カットイン表示 + 図柄リセット + 全リール回転開始**（1回の押下で完結）

現状のNG
- 全リール停止 → FS開始押下 → カットイン＋図柄リセット（回らない/空になる）
→ もう一度FS開始押下 → カットイン＋回転開始

実装指針
- FS開始ボタンのonClick（例：startFreeSpinRoundFromButton）で同一フローにまとめる：
  1) カットイン表示（残り回数もここで表示：要件3）
  2) 表示図柄をFS開始状態へリセット（ただし「空」を作らない）
  3) 全reelStateをspinningへ
  4) 回転アニメ開始（STOP待ちへ遷移）
- 受け入れ条件：FS開始は1回押しで回転開始、押下後に空リールが一瞬も出ない。

---

### 3) カットインでFS残り回数を必ず表示（FreeSpin 残り〇）
- カットイン表示時に必ず `FreeSpin 残り〇`（〇は残り回数）を表示する。
- 表示タイミング：
  - FS開始ボタン押下時（毎回）
  - FS各ラウンドの開始ボタン押下時（毎回）
- 実装指針：showCutIn(type, remaining) のように remaining を渡してDOMを確実更新。
- 受け入れ条件：すべてのFSカットインに残り回数が正しく表示される。

---

### 4) リロード復元と回転アニメ適用範囲の修正（DB確認前に勝手に回さない）
問題
- リロード直後、DBに停止図柄データがあるのに STOP押すまで回転アニメが走る。
- 停止済みリールにも回転アニメが被ることがある。

要求
- 初期ロード時は **回転アニメ適用前にDB/セッションデータ取得** を完了し、reelStateを確定してからrenderする。
- 停止データがあるなら停止表示（回転アニメなし）。ユーザー操作（通常開始/再開/FS開始など）があるまで勝手に回さない。
- 回転アニメは spinning のリールにのみ適用。stoppedには絶対適用しない。

実装指針
- 初期化順序を統一：
  - await loadSessionAndReels()
  - applyInitialReelState()
  - renderReelState()
- データ未取得中はアニメ開始しない（ローディング可）
- 受け入れ条件：リロード直後に勝手に回らず、停止データがあれば即停止図柄が出る／停止リールにアニメが被らない。

---

### 5) 【致命的】通常モード：リロード復帰後に開始/再開できず永久進行不可になるバグを修正（DB削除不要に）
現状
- 通常モード中にリロードして戻ると、再開/開始ボタンが押せず、DBデータを削除しないと永久に進行不可。

要求（必須）
- 通常モードのリロード復帰後でも、必ずユーザーが進行できる導線を提供すること：
  - 「再開（続きから）」または「スロットを開始（新規）」のどちらかが必ず押せる
  - どちらも出ない状態は禁止
- サーバーがactiveセッションを拒否する仕様なら、フロントで必ずresume導線を出すこと。
- 最終防衛として、通常モードで “操作不能（開始/再開/STOPのいずれも不可）” を検知したら
  - クライアント側phase/pendingフラグ/reelStateを安全なidleへフォールバックして復帰可能にする。

受け入れ条件（最重要）
- 通常モードでリロードしてもDB削除なしで必ず進行できる（永久詰みがなくなる）。

---

## 付随（既存修正方針の維持）
- STOP要求中も回転アニメを維持し、サーバー応答時に該当リールだけ停止表示へ切替（pendingStopReels / reelState 等）。
- FSカットインは「開始ボタン押下時のみ」発火（自動発火ロジックは削除済み/維持）。
- FSラウンド終了直後に図柄を消さず、次開始ボタン押下まで保持。次開始でリセット。

---

## 最低限の手動テスト観点
- 通常バースト成立で全リールBURST表示（空なし）
- FS開始ボタン1回でカットイン+リセット+全回転開始（2回押し不要・空なし）
- カットインに `FreeSpin 残り〇` が常に表示
- リロード直後に勝手に回らず、停止データがあれば停止図柄が即表示
- 通常モードでリロードしても開始/再開でき、DB削除不要で進行可能
- 停止済みリールに回転アニメが被らない