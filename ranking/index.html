<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡ç”£ãƒ©ãƒ³ã‚­ãƒ³ã‚° - ã‹ã«é¯–</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <style>
        :root {
            --deep-purple: #5a4a7a;
            --gold: #d4a574;
            --font-title: 'Kosugi Maru', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .page-header {
            color: #fff;
            font-family: var(--font-title);
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .ranking-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .ranking-table {
            width: 100%;
        }

        .ranking-table th {
            background: var(--deep-purple);
            color: white;
            padding: 15px 10px;
            font-weight: 600;
            text-align: center;
        }

        .ranking-table td {
            padding: 15px 10px;
            text-align: center;
            vertical-align: middle;
            border-bottom: 1px solid #eee;
        }

        .ranking-table tr:hover {
            background: #f8f9fa;
        }

        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .rank-1 {
            background: linear-gradient(135deg, #ffd700, #ffb347);
            color: #333;
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.5);
        }

        .rank-2 {
            background: linear-gradient(135deg, #c0c0c0, #a0a0a0);
            color: #333;
        }

        .rank-3 {
            background: linear-gradient(135deg, #cd7f32, #b87333);
            color: white;
        }

        .rank-other {
            background: #e9ecef;
            color: #666;
        }

        .user-cell {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
        }

        .user-main {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: nowrap;
            min-width: 0;
            white-space: nowrap;
        }

        .user-main .user-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 220px;
        }

        .user-meta {
            font-size: 0.8rem;
            color: #6c757d;
            display: none;
            flex-wrap: wrap;
            gap: 10px;
        }

        .user-meta .meta-main {
            font-weight: 700;
            color: #9b59b6;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-badge {
            width: 24px;
            height: 24px;
            object-fit: contain;
            flex-shrink: 0;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
        .nav-dropdown {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .record-button {
            background: linear-gradient(135deg, var(--gold) 0%, #b8892d 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 6px 20px rgba(212, 168, 83, 0.5);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            cursor: pointer;
        }

        .record-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 168, 83, 0.6);
            color: white;
        }

        .nav-dropdown-menu {
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            min-width: 200px;
            overflow: hidden;
            border: none;
        }

        .dropdown-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            transition: background 0.2s;
        }

        .notification-badge {
            background: #dc3545;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
        }

        @media (max-width: 768px) {

            .ranking-table th,
            .ranking-table td {
                padding: 10px 5px;
                font-size: 0.85rem;
            }

            .ranking-table th:nth-child(n+3),
            .ranking-table td:nth-child(n+3) {
                display: none;
            }

            .rank-badge {
                width: 32px;
                height: 32px;
                font-size: 0.95rem;
            }

            .user-main .user-name {
                max-width: 140px;
            }

            .user-meta {
                display: flex;
            }

            .creator-meta .meta-main {
                color: #e67e22;
            }
        }
    </style>
</head>

<body>
    <!-- å³ä¸Šã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
    <div class="nav-dropdown dropdown">
        <button class="record-button dropdown-toggle" type="button" id="navDropdown" data-bs-toggle="dropdown"
            aria-expanded="false">
            ğŸ“ ãƒ¡ãƒ‹ãƒ¥ãƒ¼
        </button>
        <ul class="dropdown-menu nav-dropdown-menu dropdown-menu-end" aria-labelledby="navDropdown">
            <li><a class="dropdown-item" href="../index.html">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a></li>
            <li><a class="dropdown-item" href="../mypage/index.html">ğŸ‘¤ ãƒã‚¤ãƒšãƒ¼ã‚¸</a></li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="../mahjong/index.html">ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a></li>
            <li><a class="dropdown-item" href="../mahjong/record.html">ğŸ“ è¨˜éŒ²ã™ã‚‹</a></li>
            <li><a class="dropdown-item" href="../mahjong/users/index.html">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</a></li>
            <li><a class="dropdown-item" href="../mahjong/team/index.html">ğŸ… ãƒãƒ¼ãƒ ç®¡ç†</a></li>
            <li><a class="dropdown-item" href="../badge/list.html">ğŸ“› ãƒãƒƒã‚¸ä¸€è¦§</a></li>
            <li><a class="dropdown-item" href="../badge/shop.html">ğŸ›’ ãƒãƒƒã‚¸ã‚·ãƒ§ãƒƒãƒ—</a></li>
            <li class="admin-only" style="display:none;">
                <hr class="dropdown-divider">
            </li>
            <li class="admin-only" style="display:none;">
                <a class="dropdown-item" href="../admin/index.html">âš™ï¸ ç®¡ç†ç”»é¢</a>
            </li>
        </ul>
    </div>

    <div class="container py-5">
        <header class="text-center">
            <h1 class="page-header display-4 fw-bold">ğŸ’° è³‡ç”£ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1>

            <div class="d-flex justify-content-center mb-4">
                <div class="btn-group ranking-tabs" role="group">
                    <button type="button" class="btn btn-outline-light active" id="tab-networth"
                        onclick="switchRanking('networth')">
                        ğŸ’ ç´”è³‡ç”£ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                    </button>
                    <button type="button" class="btn btn-outline-light" id="tab-totalassets"
                        onclick="switchRanking('totalassets')">
                        ğŸ“Š ç´¯è¨ˆè³‡ç”£ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                    </button>
                    <button type="button" class="btn btn-outline-light" id="tab-creator"
                        onclick="switchRanking('creator')">
                        ğŸ·ï¸ ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                    </button>
                </div>
            </div>

            <p id="ranking-description" class="text-white-50">ã€Œæ‰‹æŒã¡ã‚³ã‚¤ãƒ³ ï¼‹ æ‰€æŒãƒãƒƒã‚¸ã®ç¾åœ¨ä¾¡å€¤ã€ã®åˆè¨ˆé †</p>
        </header>

        <div class="ranking-card">
            <div class="table-responsive">
                <table class="ranking-table">
                    <thead>
                        <tr id="table-header">
                            <th style="width: 60px;">é †ä½</th>
                            <th>åå‰</th>
                            <th id="main-stat-header">ç´”è³‡ç”£</th>
                            <th>è³‡é‡‘ï¼ˆæ‰‹æŒã¡ï¼‰</th>
                            <th>ãƒãƒƒã‚¸ä¾¡å€¤</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ  -->
    <style>
        .ranking-tabs .btn {
            border-width: 2px;
            font-weight: bold;
            padding: 10px 20px;
        }

        .ranking-tabs .btn.active {
            background-color: white !important;
            color: var(--deep-purple) !important;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/supabase-config.js"></script>
    <script src="../js/badge-utils.js"></script>
    <script src="../js/auth-guard.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            initAccordionNav('../');
        });

        let currentMode = 'networth';
        const EXCLUDED_RANKING_USERS = new Set(['1184908452959621233']);

        function switchRanking(mode) {
            if (currentMode === mode) return;
            currentMode = mode;

            // UIæ›´æ–°
            document.getElementById('tab-networth').classList.toggle('active', mode === 'networth');
            document.getElementById('tab-totalassets').classList.toggle('active', mode === 'totalassets');
            document.getElementById('tab-creator').classList.toggle('active', mode === 'creator');

            const desc = document.getElementById('ranking-description');
            const mainHeader = document.getElementById('main-stat-header');

            if (mode === 'networth') {
                desc.textContent = 'ã€Œæ‰‹æŒã¡ã‚³ã‚¤ãƒ³ ï¼‹ æ‰€æŒãƒãƒƒã‚¸ã®ç¾åœ¨ä¾¡å€¤ã€ã®åˆè¨ˆé †';
                mainHeader.textContent = 'ç´”è³‡ç”£';
            } else if (mode === 'totalassets') {
                desc.textContent = 'ã€Œç”Ÿæ¶¯ã§ç²å¾—ã—ãŸç´¯è¨ˆé‡‘é¡ï¼ˆå£²å´ç›Šãƒ»è³é‡‘å«ã‚€ï¼‰ã€ã®åˆè¨ˆé †';
                mainHeader.textContent = 'ç´¯è¨ˆè³‡ç”£';
            } else {
                desc.textContent = 'ã€Œãƒãƒƒã‚¸è²©å£²ã§å¾—ãŸç´¯è¨ˆåç›Šã€ã®åˆè¨ˆé †';
                mainHeader.textContent = 'ç´¯è¨ˆåç›Š';
            }

            loadRanking();
        }

        function setTableHeader(mode) {
            const header = document.getElementById('table-header');
            if (!header) return;
            if (mode === 'creator') {
                header.innerHTML = `
                    <th style="width: 60px;">é †ä½</th>
                    <th>ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼</th>
                    <th id="main-stat-header">ç´¯è¨ˆåç›Š</th>
                    <th>å‡ºå“æ•°</th>
                    <th>è²©å£²å›æ•°</th>
                `;
            } else {
                header.innerHTML = `
                    <th style="width: 60px;">é †ä½</th>
                    <th>åå‰</th>
                    <th id="main-stat-header">${mode === 'totalassets' ? 'ç´¯è¨ˆè³‡ç”£' : 'ç´”è³‡ç”£'}</th>
                    <th>è³‡é‡‘ï¼ˆæ‰‹æŒã¡ï¼‰</th>
                    <th>ãƒãƒƒã‚¸ä¾¡å€¤</th>
                `;
            }
        }

        async function loadRanking() {
            const tbody = document.getElementById('ranking-body');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary"></div></td></tr>';

            try {
                setTableHeader(currentMode);

                if (currentMode === 'creator') {
                    const { data: badges, error: bError } = await supabaseClient
                        .from('badges')
                        .select('id, discord_user_id');
                    if (bError) throw bError;

                    const badgeIds = (badges || []).map(b => b.id);
                    const creatorCounts = {};
                    const badgeToCreator = {};
                    (badges || []).forEach(b => {
                        if (!b.discord_user_id) return;
                        badgeToCreator[b.id] = b.discord_user_id;
                        creatorCounts[b.discord_user_id] = (creatorCounts[b.discord_user_id] || 0) + 1;
                    });

                    const { data: logs, error: lError } = await supabaseClient
                        .from('activity_logs')
                        .select('action_type, badge_id, amount')
                        .in('action_type', ['badge_purchase', 'royalty_receive'])
                        .in('badge_id', badgeIds.length ? badgeIds : ['00000000-0000-0000-0000-000000000000']);
                    if (lError) throw lError;

                    const revenueMap = {};
                    const salesMap = {};
                    (logs || []).forEach(log => {
                        const creatorId = badgeToCreator[log.badge_id];
                        if (!creatorId) return;
                        if (log.action_type === 'badge_purchase') {
                            salesMap[creatorId] = (salesMap[creatorId] || 0) + 1;
                        } else if (log.action_type === 'royalty_receive') {
                            revenueMap[creatorId] = (revenueMap[creatorId] || 0) + (log.amount || 0);
                        }
                    });

                    const creatorIds = Object.keys(creatorCounts);
                    const filteredCreatorIds = creatorIds.filter(id => !EXCLUDED_RANKING_USERS.has(id));
                    const { data: profiles, error: pError } = await supabaseClient
                        .from('profiles')
                        .select('discord_user_id, account_name, avatar_url, is_hidden')
                        .in('discord_user_id', filteredCreatorIds);
                    if (pError) throw pError;

                    const visibleProfiles = (profiles || []).filter(p => !p.is_hidden);
                    const visibleCreatorIds = filteredCreatorIds.filter(id => visibleProfiles.some(p => p.discord_user_id === id));

                    const rankingData = visibleCreatorIds.map(id => {
                        const profile = visibleProfiles.find(p => p.discord_user_id === id) || {};
                        return {
                            discord_user_id: id,
                            account_name: profile.account_name || id,
                            avatar_url: profile.avatar_url || 'https://via.placeholder.com/40',
                            revenue: revenueMap[id] || 0,
                            listings: creatorCounts[id] || 0,
                            sales: salesMap[id] || 0
                        };
                    });

                    rankingData.sort((a, b) => b.revenue - a.revenue);

                    if (rankingData.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                        return;
                    }

                    tbody.innerHTML = rankingData.map((item, index) => {
                        const rank = index + 1;
                        const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';
                        const displayStat = `ğŸª™ ${item.revenue.toLocaleString()}`;

                        return `
                            <tr>
                                <td><span class="rank-badge ${rankClass}">${rank}</span></td>
                                <td>
                                    <div class="user-cell">
                                        <div class="user-main">
                                            <img src="${item.avatar_url}" class="user-avatar" onerror="this.src='https://via.placeholder.com/40'">
                                            <a href="../mypage/index.html?user=${item.discord_user_id}" class="text-decoration-none text-dark fw-bold user-name">
                                                ${item.account_name || 'åç§°æœªè¨­å®š'}
                                            </a>
                                        </div>
                                    <div class="user-meta creator-meta">
                                        <span class="meta-main">ç´¯è¨ˆåç›Š: ${displayStat}</span>
                                        <span>å‡ºå“æ•°: ${item.listings}ä»¶</span>
                                        <span>è²©å£²å›æ•°: ${item.sales}å›</span>
                                    </div>
                                </div>
                            </td>
                                <td class="fw-bold" style="color: #e67e22; font-size: 1.1rem;">${displayStat}</td>
                                <td>${item.listings}</td>
                                <td>${item.sales}</td>
                            </tr>
                        `;
                    }).join('');

                    return;
                }

                // 1. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—
                const { data: profiles, error: pError } = await supabaseClient
                    .from('profiles')
                    .select('discord_user_id, account_name, avatar_url, coins, total_assets, is_hidden, equipped_badge_id, equipped_badge_id_right, badges!equipped_badge_id(image_url, name), badges_right:badges!equipped_badge_id_right(image_url, name)');
                if (pError) throw pError;
                const filteredProfiles = (profiles || []).filter(p => !EXCLUDED_RANKING_USERS.has(p.discord_user_id) && !p.is_hidden);

                // 2. å…¨ãƒãƒƒã‚¸å€‹ä½“ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆè³‡ç”£ä¾¡å€¤è¨ˆç®—ç”¨ï¼‰
                const { data: userBadges, error: bError } = await supabaseClient
                    .from('user_badges_new')
                    .select('user_id, badge_id, is_mutant, badges(price, sales_type)');
                if (bError) throw bError;

                // 3. ãƒãƒƒã‚¸ãƒã‚¹ã‚¿ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆå›ºå®šä¾¡æ ¼å¯¾å¿œï¼‰
                const { data: masterBadges } = await supabaseClient.from('badges').select('id, price, sales_type');

                // 4. ãƒ¬ã‚¢ãƒªãƒ†ã‚£é–¾å€¤ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼ä¿®æ­£ï¼šã“ã‚ŒãŒä¸è¶³ã—ã¦ã„ãŸï¼‰
                const { data: thresholds } = await supabaseClient.from('rarity_thresholds').select('*').order('threshold_value', { ascending: true });


                // UUID -> discord_user_id ã®ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒãƒƒãƒ—ã‚’ä½œæˆ
                const uuidToDiscordMap = {};
                profiles.forEach(p => {
                    // profiles ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯ id (UUID) ã¨ discord_user_id ã®ä¸¡æ–¹ãŒã‚ã‚‹ã¯ãš
                    // ãŸã ã—ã“ã“ã§ã¯ id ã‚’å–å¾—ã—ã¦ã„ãªã„ã®ã§ã€å¾Œã§å–å¾—ã™ã‚‹ã‹åˆ¥ã®æ–¹æ³•ã‚’å–ã‚‹
                    // å®Ÿéš›ã«ã¯ user_badges_new.user_id ã¯ discord_user_id ã‚’æ ¼ç´ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
                    // ç¢ºèªã®ãŸã‚ã€ä¸€æ—¦ discord_user_id ã‚’ãã®ã¾ã¾ä½¿ã†
                });

                // ãƒãƒƒã‚¸ã”ã¨ã®æµé€šæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ & ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ³ãƒˆæ‰€æœ‰è¡¨ã‚’æ§‹ç¯‰
                const marketCounts = {};
                const userMutantMap = {}; // (discordUserId_badgeId) -> boolean

                (userBadges || []).forEach(ub => {
                    marketCounts[ub.badge_id] = (marketCounts[ub.badge_id] || 0) + 1;
                    if (ub.is_mutant) {
                        // user_badges_new.user_id ã¯ discord_user_id æ–‡å­—åˆ—ã§ã‚ã‚‹ã¨ä»®å®š
                        userMutantMap[`${ub.user_id}_${ub.badge_id}`] = true;
                    }
                });

                // å„ãƒãƒƒã‚¸ã®ã€Œç¾åœ¨ä¾¡å€¤(P_value)ã€ã‚’äº‹å‰ã«è¨ˆç®—
                const badgeValues = {};
                masterBadges.forEach(mb => {
                    const n = marketCounts[mb.id] || 0;
                    const result = BadgeUtils.calculateBadgeValues(mb, n, thresholds);
                    badgeValues[mb.id] = result.marketValue;
                });

                // å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒƒã‚¸ä¾¡å€¤åˆè¨ˆã¨å€‹æ•°ã‚’è¨ˆç®—
                const userFinances = {};
                filteredProfiles.forEach(p => {
                    userFinances[p.discord_user_id] = { badgeCount: 0, badgeValue: 0 };
                });

                userBadges.forEach(ub => {
                    const baseValue = badgeValues[ub.badge_id] || 0;
                    // ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ³ãƒˆã¯è³‡ç”£ä¾¡å€¤3å€
                    const value = baseValue * (ub.is_mutant ? 3 : 1);

                    if (userFinances[ub.user_id]) {
                        userFinances[ub.user_id].badgeCount++;
                        userFinances[ub.user_id].badgeValue += value;
                    }
                });

                // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰
                const rankingData = filteredProfiles.map(p => {
                    const finances = userFinances[p.discord_user_id] || { badgeCount: 0, badgeValue: 0 };
                    return {
                        ...p,
                        badgeCount: finances.badgeCount,
                        badgeValue: finances.badgeValue,
                        netWorth: p.coins + finances.badgeValue
                    };
                });

                // ã‚½ãƒ¼ãƒˆ
                if (currentMode === 'networth') {
                    rankingData.sort((a, b) => b.netWorth - a.netWorth);
                } else {
                    rankingData.sort((a, b) => (b.total_assets || 0) - (a.total_assets || 0));
                }

                if (rankingData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                    return;
                }

                tbody.innerHTML = rankingData.map((item, index) => {
                    const rank = index + 1;
                    const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';
                    const avatar = item.avatar_url || 'https://via.placeholder.com/40';

                    // å·¦ãƒãƒƒã‚¸ã®ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ³ãƒˆåˆ¤å®šã¨HTMLç”Ÿæˆ
                    let badgeImgLeft = '';
                    if (item.badges) {
                        const isMutant = userMutantMap[`${item.discord_user_id}_${item.equipped_badge_id}`];
                        badgeImgLeft = `
                            <div class="mutant-badge-container mini ${isMutant ? 'active' : ''}">
                                <img src="${item.badges.image_url}" class="user-badge" title="${item.badges.name}">
                                <div class="mutant-badge-shine" style="display: ${isMutant ? 'block' : 'none'};"></div>
                            </div>`;
                    }

                    // å³ãƒãƒƒã‚¸ã®ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ³ãƒˆåˆ¤å®šã¨HTMLç”Ÿæˆ
                    let badgeImgRight = '';
                    if (item.badges_right) {
                        const isMutant = userMutantMap[`${item.discord_user_id}_${item.equipped_badge_id_right}`];
                        badgeImgRight = `
                            <div class="mutant-badge-container mini ${isMutant ? 'active' : ''}">
                                <img src="${item.badges_right.image_url}" class="user-badge" title="${item.badges_right.name}">
                                <div class="mutant-badge-shine" style="display: ${isMutant ? 'block' : 'none'};"></div>
                            </div>`;
                    }

                    const displayStat = currentMode === 'networth'
                        ? `ğŸ’ ${item.netWorth.toLocaleString()}`
                        : `ğŸ“Š ${(item.total_assets || 0).toLocaleString()}`;

                    const statColor = currentMode === 'networth' ? '#9b59b6' : '#e67e22';

                    return `
                        <tr>
                            <td><span class="rank-badge ${rankClass}">${rank}</span></td>
                            <td>
                                <div class="user-cell">
                                    <div class="user-main">
                                        <img src="${avatar}" class="user-avatar" onerror="this.src='https://via.placeholder.com/40'">
                                        ${badgeImgLeft}
                                        <a href="../mypage/index.html?user=${item.discord_user_id}" class="text-decoration-none text-dark fw-bold user-name">
                                            ${item.account_name || 'åç§°æœªè¨­å®š'}
                                        </a>
                                        ${badgeImgRight}
                                    </div>
                                    <div class="user-meta">
                                        ${currentMode === 'networth'
                            ? `
                                            <span class="meta-main">ç´”è³‡ç”£: ${displayStat}</span>
                                            <span>æ‰€æŒé‡‘: ğŸª™ ${item.coins.toLocaleString()}</span>
                                            <span>æ‰€æŒãƒãƒƒã‚¸: ğŸ“› ${item.badgeCount}å€‹</span>
                                            <span>ãƒãƒƒã‚¸ä¾¡å€¤: ğŸ“ˆ ${item.badgeValue.toLocaleString()}</span>
                                        `
                            : `
                                            <span class="meta-main">ç´¯è¨ˆè³‡ç”£: ${displayStat}</span>
                                            <span>æ‰€æŒé‡‘: ğŸª™ ${item.coins.toLocaleString()}</span>
                                            <span>æ‰€æŒãƒãƒƒã‚¸: ğŸ“› ${item.badgeCount}å€‹</span>
                                            <span>ãƒãƒƒã‚¸ä¾¡å€¤: ğŸ“ˆ ${item.badgeValue.toLocaleString()}</span>
                                        `}
                                    </div>
                                </div>
                            </td>
                            <td class="fw-bold" style="color: ${statColor}; font-size: 1.1rem;">${displayStat}</td>
                            <td>ğŸª™ ${item.coins.toLocaleString()}</td>
                            <td class="text-muted small">ğŸ“› ${item.badgeCount}å€‹ / ğŸ“ˆ ${item.badgeValue.toLocaleString()}</td>
                        </tr>
                    `;
                }).join('');

            } catch (err) {
                console.error('Error loading ranking:', err);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger py-4">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</td></tr>';
            }
        }

        document.addEventListener('DOMContentLoaded', loadRanking);
    </script>
</body>

</html>
