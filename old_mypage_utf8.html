<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="縺九↓繧ｵ繝ｼ繝舌・ - 繝槭う繝壹・繧ｸ">
    <title>繝槭う繝壹・繧ｸ | 縺九↓繧ｵ繝ｼ繝舌・繧､繝吶Φ繝・/title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;600;700&family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap"
        rel="stylesheet">

    <!-- Bootswatch Lux (Bootstrap 5.3.3) -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/lux/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-purple: #6b5b95;
            --deep-purple: #4a3f6b;
            --cream: #faf5e8;
            --gold: #d4a853;
            --btn-gold: #c29544;
            --font-title: 'Noto Serif JP', serif;
            --font-body: 'M PLUS Rounded 1c', sans-serif;
        }

        .btn-gold {
            background-color: var(--gold);
            border: none;
        }

        .btn-gold:hover {
            background-color: var(--btn-gold);
            color: white;
        }


        body {
            font-family: var(--font-body);
            background: linear-gradient(180deg, #6b5b95 0%, #5a4d80 50%, #4a3f6b 100%);
            min-height: 100vh;
            background-attachment: fixed;
        }

        .page-header {
            font-family: var(--font-title);
            color: var(--cream);
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
        }

        .back-button {
            font-family: var(--font-body);
            font-size: 1rem;
            padding: 10px 25px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #fff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .profile-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--gold);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .discord-badge {
            background: linear-gradient(135deg, #43b581, #3ca374);
            color: white;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(67, 181, 129, 0.4);
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid var(--gold);
        }

        .activity-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .activity-item-card {
            background: #fdfdfd;
            /* 繧ｫ繝ｼ繝峨・荳ｭ縺ｫ繧ｫ繝ｼ繝峨〒縺ゅｋ縺薙→繧貞ｼｷ隱ｿ縺吶ｋ縺溘ａ縺ｮ蠕ｮ隱ｿ謨ｴ */
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            border: 1px solid #eff0f1;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            display: block;
        }

        .activity-item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            border-color: var(--gold);
        }

        .activity-date {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 10px;
            display: block;
            border-bottom: 1px solid #f5f5f5;
            padding-bottom: 5px;
        }

        .activity-type-badge {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 50px;
            background: #f0f2f5;
            color: #4b515d;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .activity-details {
            font-size: 0.95rem;
            color: #2c3e50;
            font-weight: 500;
        }

        .activity-amount {
            font-family: 'Inter', 'Kosugi Maru', sans-serif;
            font-weight: 800;
            font-size: 1.15rem;
            letter-spacing: -0.02em;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--deep-purple);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .login-prompt {
            text-align: center;
            padding: 60px 20px;
        }

        .login-prompt-btn {
            background: linear-gradient(135deg, #5865F2, #4752c4);
            color: white;
            padding: 15px 40px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .login-prompt-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(88, 101, 242, 0.4);
        }

        .logout-btn {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 2px solid #dc3545;
            padding: 10px 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc3545;
            color: white;
        }

        /* 繝九ャ繧ｯ繝阪・繝蜈･蜉帶ｬ・*/
        .nickname-input {
            background: #fff;
            border: 2px solid #e0d8f0;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 1rem;
            transition: all 0.3s ease;
            color: #333;
        }

        .nickname-input::placeholder {
            color: #aaa;
            font-style: italic;
        }

        .nickname-input:focus {
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 4px rgba(107, 91, 149, 0.15);
            outline: none;
            background: #fff;
        }

        /* 繧｢繧､繧ｳ繝ｳ譖ｴ譁ｰ繝懊ち繝ｳ */
        .btn-avatar-update {
            background: linear-gradient(135deg, #5865F2 0%, #4752c4 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(88, 101, 242, 0.3);
        }

        .btn-avatar-update:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(88, 101, 242, 0.5);
            background: linear-gradient(135deg, #6872f4 0%, #5865F2 100%);
        }

        /* 邨ｱ險医Α繝九き繝ｼ繝・*/
        .stat-card-mini {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }

        .stat-card-mini:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-label-mini {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-value-mini {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--deep-purple);
        }

        .stat-rank {
            font-size: 0.7rem;
            color: #fff;
            background: linear-gradient(135deg, var(--gold), #b8860b);
            padding: 2px 8px;
            border-radius: 10px;
            margin-top: 5px;
            display: inline-block;
        }

        .stat-rank.no-data {
            background: #adb5bd;
        }

        /* 繝舌ャ繧ｸ荳隕ｧ縺ｮ繧ｹ繧ｿ繧､繝ｫ */
        .badge-item {
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
            border-radius: 12px;
            padding: 8px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .badge-item:hover {
            transform: scale(1.05);
            background: #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .badge-item.equipped {
            border-color: var(--gold);
            background: #fff9e6;
            box-shadow: 0 0 0 2px rgba(212, 165, 116, 0.3);
        }

        .badge-item img {
            width: 70px;
            height: 70px;
            object-fit: contain;
            display: block;
        }

        .badge-count-overlay {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            border: 2px solid white;
            z-index: 10;
        }

        /* 繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ繧ｪ繝ｼ繝舌・繝ｬ繧､ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s;
        }

        .loading-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        /* 繝ｦ繝ｼ繧ｶ繝ｼ驕ｸ謚槭Μ繧ｹ繝・*/
        .user-select-item {
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #eee;
        }

        .user-select-item:hover {
            background-color: #f8f9fa;
        }

        .user-select-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 2px solid var(--gold);
        }

        .user-select-badge {
            width: 24px;
            height: 24px;
            object-fit: contain;
            margin-left: 8px;
        }

        .user-select-name {
            font-weight: 700;
            color: var(--deep-purple);
            font-size: 1rem;
        }

        /* 繝翫ン繧ｲ繝ｼ繧ｷ繝ｧ繝ｳ繝峨Ο繝・・繝繧ｦ繝ｳ */
        .nav-dropdown {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .record-button {
            background: linear-gradient(135deg, var(--gold) 0%, #b8892d 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 6px 20px rgba(212, 168, 83, 0.5);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            cursor: pointer;
        }

        .record-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 168, 83, 0.6);
            color: white;
        }

        .nav-dropdown-menu {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            min-width: 200px;
            overflow: hidden;
        }

        .nav-dropdown-menu .dropdown-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            transition: background 0.2s;
        }

        .nav-dropdown-menu .dropdown-item:hover {
            background: #f5f5f5;
        }

        .nav-dropdown-menu .dropdown-divider {
            margin: 0;
        }

        .notification-badge {
            background: #dc3545;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
        }
    </style>
</head>

<body>
    <!-- 蜿ｳ荳翫・繝翫ン繧ｲ繝ｼ繧ｷ繝ｧ繝ｳ繝峨Ο繝・・繝繧ｦ繝ｳ -->
    <div class="nav-dropdown dropdown">
        <button class="record-button dropdown-toggle" type="button" id="navDropdown" data-bs-toggle="dropdown"
            aria-expanded="false">
            統 繝｡繝九Η繝ｼ
        </button>
        <ul class="dropdown-menu nav-dropdown-menu dropdown-menu-end" aria-labelledby="navDropdown">
            <li><a class="dropdown-item" href="../index.html">匠 繝帙・繝縺ｫ謌ｻ繧・/a></li>
            <li><a class="dropdown-item" href="./index.html">側 繝槭う繝壹・繧ｸ</a></li>
            <li>
                <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="../mahjong/index.html">投 繝ｩ繝ｳ繧ｭ繝ｳ繧ｰ</a></li>
            <li><a class="dropdown-item" href="../mahjong/record.html">統 險倬鹸縺吶ｋ</a></li>
            <li><a class="dropdown-item" href="../mahjong/users/index.html">則 繝ｦ繝ｼ繧ｶ繝ｼ荳隕ｧ</a></li>
            <li><a class="dropdown-item" href="../mahjong/team/index.html">遵 繝√・繝邂｡逅・<span id="team-notification-badge"
                        class="notification-badge" style="display:none;">0</span></a></li>
            <li><a class="dropdown-item" href="../badge/list.html">筒 繝舌ャ繧ｸ荳隕ｧ</a></li>
            <li><a class="dropdown-item" href="../badge/shop.html">將 繝舌ャ繧ｸ繧ｷ繝ｧ繝・・</a></li>
            <li><a class="dropdown-item" href="../ranking/index.html">腸 雉・肇繝ｩ繝ｳ繧ｭ繝ｳ繧ｰ</a></li>
            <li class="admin-only" style="display:none;"><a class="dropdown-item" href="../omikuji/index.html">視
                    縺翫∩縺上§</a></li>
            <li class="admin-only" style="display:none;">
                <hr class="dropdown-divider">
            </li>
            <li class="admin-only" style="display:none;">
                <a class="dropdown-item" href="../admin/index.html">笞呻ｸ・邂｡逅・判髱｢</a>
            </li>
        </ul>
    </div>

    <div class="container py-5">
        <!-- 謌ｻ繧九・繧ｿ繝ｳ -->
        <div class="mb-4">
            <a href="#" onclick="goBack(); return false;" class="back-button">
                竊・謌ｻ繧・            </a>
        </div>


        <!-- 繝倥ャ繝繝ｼ -->
        <header class="text-center mb-5">
            <h1 class="page-header display-4 fw-bold mb-3">側 繝槭う繝壹・繧ｸ</h1>
        </header>

        <!-- 繧ｳ繝ｳ繝・Φ繝・-->
        <div class="row justify-content-center">
            <div class="col-12 col-lg-8">

                <!-- 譛ｪ繝ｭ繧ｰ繧､繝ｳ譎・-->
                <div id="login-prompt" class="profile-card login-prompt" style="display: none;">
                    <h3 class="mb-4" style="font-family: var(--font-title); color: var(--deep-purple);">
                        繝ｭ繧ｰ繧､繝ｳ縺励※縺上□縺輔＞
                    </h3>
                    <p class="text-muted mb-4">
                        繝槭う繝壹・繧ｸ繧定｡ｨ遉ｺ縺吶ｋ縺ｫ縺ｯDiscord縺ｧ繝ｭ繧ｰ繧､繝ｳ縺悟ｿ・ｦ√〒縺吶・                    </p>
                    <button onclick="loginWithDiscord()" class="login-prompt-btn">
                        <img src="https://assets-global.website-files.com/6257adef93867e50d84d30e2/636e0a69f118df70ad7828d4_icon_clyde_blurple_RGB.svg"
                            alt="Discord" style="width: 24px;">
                        Discord縺ｧ繝ｭ繧ｰ繧､繝ｳ
                    </button>
                </div>

                <!-- 繝ｭ繧ｰ繧､繝ｳ貂医∩・医∪縺溘・髢ｲ隕ｧ繝｢繝ｼ繝会ｼ・-->
                <div id="profile-content" style="display: none;">
                    <div class="profile-card mb-4">
                        <!-- 荳頑ｮｵ: 繝舌ャ繧ｸ + 蜷榊燕 + 邱ｨ髮・・繧ｿ繝ｳ -->
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div class="d-flex align-items-center gap-2 flex-grow-1" style="min-width: 0;">
                                <img id="user-equipped-badge" src="" alt=""
                                    style="width: 36px; height: 36px; border-radius: 8px; display: none;">
                                <h2 id="user-name" class="mb-0 text-truncate"
                                    style="font-family: var(--font-title); color: var(--deep-purple); font-size: 1.4rem;">
                                    繝ｦ繝ｼ繧ｶ繝ｼ蜷・                                </h2>
                            </div>
                            <button id="nickname-edit-btn" onclick="openNicknameModal()"
                                class="btn btn-sm btn-outline-secondary flex-shrink-0" title="繝九ャ繧ｯ繝阪・繝繧貞､画峩"
                                style="display: none; padding: 4px 10px;">
                                笨擾ｸ・                            </button>
                        </div>

                        <!-- 荳区ｮｵ: 繧｢繝舌ち繝ｼ + 諠・ｱ -->
                        <div class="row align-items-start">
                            <div class="col-auto">
                                <div class="text-center">
                                    <img id="user-avatar" src="" alt="繧｢繝舌ち繝ｼ" class="avatar-large">
                                    <button id="sync-btn" onclick="updateAvatar()"
                                        class="btn btn-sm btn-outline-secondary mt-2" title="Discord縺九ｉ譛譁ｰ縺ｮ繧｢繝舌ち繝ｼ逕ｻ蜒上ｒ蜿門ｾ・
                                        style="font-size: 0.7rem; padding: 3px 8px;">
                                        売 蜷梧悄
                                    </button>
                                </div>
                            </div>
                            <div class="col">
                                <h2 id="page-title-label" class="small text-muted mb-1" style="display:none;">繝励Ξ繧､繝､繝ｼ</h2>

                                <!-- 繝√・繝蜷・-->
                                <div id="user-team-display" class="mb-2">
                                    <span class="badge bg-secondary" style="font-size: 0.85rem;">
                                        匠 <span id="user-team-name">譛ｪ謇螻・/span>
                                    </span>
                                </div>

                                <!-- 謇謖・≡ -->
                                <div id="user-coins-display" class="mb-2"
                                    style="display: none; flex-wrap: wrap; gap: 8px; align-items: center;">
                                    <span class="badge bg-light text-dark shadow-sm"
                                        style="font-size: 0.85rem; border: 1px solid var(--gold); padding: 6px 12px;">
                                        謇謖・≡: ｪ・<span id="user-coins-value">0</span>
                                    </span>
                                    <span class="badge bg-light text-dark shadow-sm"
                                        style="font-size: 0.85rem; border: 1px solid #17a2b8; padding: 6px 12px;">
                                        邱剰ｳ・肇: 投 <span id="total-assets-value">0</span>
                                    </span>
                                    <button id="coin-transfer-btn" onclick="openCoinTransferModal()"
                                        class="btn btn-sm btn-outline-primary"
                                        style="display: none; padding: 2px 8px; font-size: 0.75rem;">
                                        頂 騾・≡
                                    </button>
                                </div>

                                <!-- 莉紋ｺｺ縺ｮ蝣ｴ蜷医・縺ｿ陦ｨ遉ｺ縺吶ｋ陦ｨ遉ｺ繧ｨ繝ｪ繧｢ -->
                                <div id="view-area" class="mt-2" style="display:none;">
                                    <div class="discord-badge">
                                        ・鮗ｻ髮繝励Ξ繧､繝､繝ｼ
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 鮗ｻ髮邨ｱ險・-->
                    <div class="profile-card mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0;">
                                ・鮗ｻ髮邨ｱ險・                            </h4>
                            <div id="tournament-filter-container">
                                <select id="tournament-select" class="form-select form-select-sm"
                                    style="width: auto; min-width: 150px;" onchange="handleTournamentChange()">
                                    <!-- JS縺ｧ逕滓・ -->
                                </select>
                            </div>
                        </div>

                        <div id="stats-loading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ...</span>
                            </div>
                        </div>

                        <div id="stats-content" style="display: none;">
                            <div id="stats-grid">
                                <!-- 繧ｹ繧ｳ繧｢邉ｻ -->
                                <div class="row g-3 mb-3">
                                    <div class="col-6 col-md-4">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">邱丞粋繧ｹ繧ｳ繧｢</div>
                                            <div class="stat-value-mini" id="stat-total">-</div>
                                            <div class="stat-rank" id="rank-total">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">荳蛾ｺｻ繧ｹ繧ｳ繧｢</div>
                                            <div class="stat-value-mini" id="stat-sanma">-</div>
                                            <div class="stat-rank" id="rank-sanma">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">蝗幃ｺｻ繧ｹ繧ｳ繧｢</div>
                                            <div class="stat-value-mini" id="stat-yonma">-</div>
                                            <div class="stat-rank" id="rank-yonma">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 蟷ｳ蝮・・譛螟ｧ繧ｹ繧ｳ繧｢ -->
                                <div class="row g-3 mb-3">
                                    <div class="col-6">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">蟷ｳ蝮・せ繧ｳ繧｢</div>
                                            <div class="stat-value-mini" id="stat-avg-score">-</div>
                                            <div class="stat-rank" id="rank-avg-score">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">譛螟ｧ繧ｹ繧ｳ繧｢</div>
                                            <div class="stat-value-mini" id="stat-max-score">-</div>
                                            <div class="stat-rank" id="rank-max-score">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 邇・ｳｻ -->
                                <div class="row g-3 mb-3">
                                    <div class="col-6 col-md-3">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">蜥御ｺ・紫</div>
                                            <div class="stat-value-mini" id="stat-win-rate">-</div>
                                            <div class="stat-rank" id="rank-win-rate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">謾ｾ驫・紫</div>
                                            <div class="stat-value-mini" id="stat-deal-rate">-</div>
                                            <div class="stat-rank" id="rank-deal-rate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">繝医ャ繝礼紫</div>
                                            <div class="stat-value-mini" id="stat-top-rate">-</div>
                                            <div class="stat-rank" id="rank-top-rate">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">繝ｩ繧ｹ蝗樣∩</div>
                                            <div class="stat-value-mini" id="stat-avoid-rate">-</div>
                                            <div class="stat-rank" id="rank-avoid-rate">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 鬆・ｽ咲ｳｻ -->
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">蟷ｳ蝮・・ｽ・/div>
                                            <div class="stat-value-mini" id="stat-avg-rank">-</div>
                                            <div class="stat-rank" id="rank-avg-rank">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-card-mini">
                                            <div class="stat-label-mini">蟇ｾ螻謨ｰ</div>
                                            <div class="stat-value-mini" id="stat-games">-</div>
                                            <div class="stat-rank" id="rank-games">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="no-stats-msg" class="text-center text-muted py-3" style="display: none;">
                                縺ｾ縺鮗ｻ髮螟ｧ莨壹↓蜿ょ刈縺励※縺・∪縺帙ｓ
                            </div>
                        </div>
                    </div>

                    <!-- 繝舌ャ繧ｸ繧ｳ繝ｬ繧ｯ繧ｷ繝ｧ繝ｳ -->
                    <div class="profile-card mb-4" id="badge-collection-section" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0;">
                                筒 繝舌ャ繧ｸ繧ｳ繝ｬ繧ｯ繧ｷ繝ｧ繝ｳ
                            </h4>
                            <div class="d-flex gap-2">
                                <button id="badge-transfer-btn" onclick="openBadgeSelectionModal('transfer')"
                                    class="btn btn-sm btn-outline-primary" style="display: none;">
                                    隴ｲ貂｡
                                </button>
                                <button id="badge-sell-btn" onclick="openBadgeSelectionModal('sell')"
                                    class="btn btn-sm btn-outline-danger" style="display: none;">
                                    螢ｲ蜊ｴ
                                </button>
                                <button id="badge-change-btn" onclick="openBadgeChangeModal()"
                                    class="btn btn-sm btn-outline-secondary" style="display: none;">
                                    陬・捩
                                </button>
                            </div>
                        </div>

                        <!-- 髱槫｣ｲ蜩√ヰ繝・ず -->
                        <div id="special-badges-section" style="display: none;">
                            <h6 class="text-muted mb-2" style="font-size: 0.85rem;">醇 髯仙ｮ壹ヰ繝・ず</h6>
                            <div id="special-badge-list" class="row g-3 mb-4">
                                <!-- JS縺ｧ逕滓・ -->
                            </div>
                        </div>

                        <!-- 雉ｼ蜈･繝舌ャ繧ｸ -->
                        <div id="purchasable-badges-section" style="display: none;">
                            <h6 class="text-muted mb-2" style="font-size: 0.85rem;">將 雉ｼ蜈･繝舌ャ繧ｸ</h6>
                            <div id="purchasable-badge-list" class="row g-3">
                                <!-- JS縺ｧ逕滓・ -->
                            </div>
                        </div>

                        <div id="no-badges-msg" class="text-center text-muted py-3" style="display: none;">
                            縺ｾ縺繝舌ャ繧ｸ繧呈戟縺｣縺ｦ縺・∪縺帙ｓ
                        </div>
                    </div>

                    <!-- 雋ｩ螢ｲ螳溽ｸｾ繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ -->
                    <div class="profile-card mb-4" id="revenue-section" style="display: none;">
                        <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0 0 15px 0;">
                            腸 雋ｩ螢ｲ螳溽ｸｾ
                        </h4>
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="stat-card-mini">
                                    <div class="stat-label-mini">邏ｯ險亥庶逶・/div>
                                    <div class="stat-value-mini" id="total-revenue" style="color: #27ae60;">0</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-card-mini">
                                    <div class="stat-label-mini">雋ｩ螢ｲ蝗樊焚</div>
                                    <div class="stat-value-mini" id="revenue-count">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 譛霑代・豢ｻ蜍輔そ繧ｯ繧ｷ繝ｧ繝ｳ -->
                    <div class="profile-card mb-4" id="activity-section" style="display: none;">
                        <h4 style="font-family: var(--font-title); color: var(--deep-purple); margin: 0 0 15px 0;">
                            搭 譛霑代・豢ｻ蜍・                        </h4>
                        <div id="activity-list">
                            <div class="text-center text-muted py-3">隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ...</div>
                        </div>
                        <div id="activity-pagination" class="d-flex justify-content-center gap-2 mt-3"
                            style="display: none;"></div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- 繝舌ャ繧ｸ螟画峩繝｢繝ｼ繝繝ｫ -->
    <div class="modal fade" id="badgeChangeModal" tabindex="-1" aria-labelledby="badgeChangeModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="badgeChangeModalLabel">陬・捩繝舌ャ繧ｸ繧貞､画峩</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="badge-modal-list" class="row g-2">
                        <!-- JS縺ｧ逕滓・ -->
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-outline-danger btn-sm" onclick="equipBadge(null)">繝舌ャ繧ｸ繧貞､悶☆</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 繝九ャ繧ｯ繝阪・繝邱ｨ髮・Δ繝ｼ繝繝ｫ -->
    <div class="modal fade" id="nicknameModal" tabindex="-1" aria-labelledby="nicknameModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="nicknameModalLabel">繝九ャ繧ｯ繝阪・繝螟画峩</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label small text-muted">繝ｩ繝ｳ繧ｭ繝ｳ繧ｰ遲峨〒陦ｨ遉ｺ縺輔ｌ繧句錐蜑・/label>
                    <input type="text" id="user-nickname" class="form-control mb-3" placeholder="繝九ャ繧ｯ繝阪・繝繧貞・蜉・..">
                    <div class="d-grid gap-2">
                        <button onclick="useDiscordName()" class="btn btn-outline-secondary btn-sm">
                            Discord蜷阪ｒ菴ｿ逕ｨ
                        </button>
                        <button onclick="saveNickname()" class="btn btn-gold text-white fw-bold">
                            菫晏ｭ・                        </button>
                    </div>
                    <div id="save-msg" class="small mt-2 text-center" style="display:none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Supabase -->
    <!-- 繝舌ャ繧ｸ隴ｲ貂｡繝ｻ螢ｲ蜊ｴ逕ｨ繝舌ャ繧ｸ驕ｸ謚槭Δ繝ｼ繝繝ｫ -->
    <div class="modal fade" id="badgeActionModal" tabindex="-1" aria-labelledby="badgeActionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="badgeActionModalLabel">繝舌ャ繧ｸ繧帝∈謚・/h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="action-badge-list" class="row g-2">
                        <!-- JS縺ｧ逕滓・ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 繝ｦ繝ｼ繧ｶ繝ｼ驕ｸ謚槭Δ繝ｼ繝繝ｫ (隴ｲ貂｡繝ｻ騾・≡逕ｨ) -->
    <div class="modal fade" id="userSelectModal" tabindex="-1" aria-labelledby="userSelectModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userSelectModalLabel">隴ｲ貂｡蜈医・繝ｦ繝ｼ繧ｶ繝ｼ繧帝∈謚・/h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="transfer-user-list" class="list-group list-group-flush">
                        <!-- JS縺ｧ逕滓・ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 繧ｳ繧､繝ｳ騾・≡驥鷹｡榊・蜉帙Δ繝ｼ繝繝ｫ -->
    <div class="modal fade" id="coinAmountModal" tabindex="-1" aria-labelledby="coinAmountModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="coinAmountModalLabel">騾・≡驥鷹｡阪ｒ蜈･蜉・/h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="coin-transfer-target-name" class="fw-bold text-center mb-3"></p>
                    <div class="mb-3">
                        <label class="form-label">騾・≡縺吶ｋ繧ｳ繧､繝ｳ謨ｰ</label>
                        <input type="number" id="coin-transfer-amount" class="form-control" placeholder="驥鷹｡・.." min="1">
                        <div class="form-text mt-2 text-center">縺ゅ↑縺溘・謇謖・≡: ｪ・<span id="my-coins-ref">0</span></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
                    <button type="button" class="btn btn-primary" onclick="executeCoinTransfer()">騾・≡縺吶ｋ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase險ｭ螳・-->
    <script src="../js/supabase-config.js"></script>
    <script src="../js/auth-guard.js"></script>
    <script src="../js/navigation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            initAccordionNav('../');
        });
    </script>

    <script>
        let isViewMode = false;
        let targetId = null;
        let allProfiles = []; // 蜈ｨ繝ｦ繝ｼ繧ｶ繝ｼ縺ｮ繝励Ο繝輔ぃ繧､繝ｫ繝ｪ繧ｹ繝・
        /**
         * 繝壹・繧ｸ蛻晄悄蛹・         */
        async function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('user');

            // 蜈ｨ繝ｦ繝ｼ繧ｶ繝ｼ諠・ｱ繧貞叙蠕暦ｼ亥錐蜑崎ｧ｣豎ｺ逕ｨ・・            const { data: profiles, error: profileError } = await supabaseClient
                .from('profiles')
                .select('discord_user_id, account_name, avatar_url');
            if (profiles) allProfiles = profiles;

            const user = await getCurrentUser();
            const myId = user?.user_metadata?.provider_id;

            // 縺ｪ繧翫☆縺ｾ縺嶺ｸｭ縺ｮ繝ｦ繝ｼ繧ｶ繝ｼ諠・ｱ繧貞叙蠕・            const impersonated = getImpersonatedUser();
            const effectiveId = impersonated ? impersonated.discord_user_id : myId;

            // URL繝代Λ繝｡繝ｼ繧ｿ縺後≠繧句ｴ蜷・            if (urlUserId) {
                targetId = urlUserId;
                // 閾ｪ蛻・〒繧ゅ↑繧翫☆縺ｾ縺怜ｯｾ雎｡縺ｧ繧ゅ↑縺・ｴ蜷医・髢ｲ隕ｧ繝｢繝ｼ繝・                if (urlUserId !== myId && urlUserId !== (impersonated?.discord_user_id)) {
                    isViewMode = true;
                } else {
                    isViewMode = false;
                }
            } else {
                // URL繝代Λ繝｡繝ｼ繧ｿ縺後↑縺・ｴ蜷医・譛牙柑縺ｪ繝ｦ繝ｼ繧ｶ繝ｼID・医↑繧翫☆縺ｾ縺怜━蜈茨ｼ・                targetId = effectiveId;
                isViewMode = false;
            }

            // UI縺ｮ蝓ｺ譛ｬ陦ｨ遉ｺ蛻・ｊ譖ｿ縺・            setupUI();

            // 繝・・繧ｿ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ
            if (isViewMode) {
                await loadTargetUserInfo();
            } else {
                if (user) {
                    await displayMyInfo(user);
                } else {
                    showLoginPrompt();
                    return;
                }
            }

            // 鮗ｻ髮邨ｱ險医・隱ｭ縺ｿ霎ｼ縺ｿ・亥・譛峨Ο繧ｸ繝・け・・            await loadMahjongStats();

            // 繝舌ャ繧ｸ繧ｳ繝ｬ繧ｯ繧ｷ繝ｧ繝ｳ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ
            await loadOwnedBadges();

            // 雋ｩ螢ｲ螳溽ｸｾ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ
            await loadRevenueStats();

            // 譛霑代・豢ｻ蜍輔・隱ｭ縺ｿ霎ｼ縺ｿ
            await loadActivityLogs();
        }

        function setupUI() {
            const loginPrompt = document.getElementById('login-prompt');
            const profileContent = document.getElementById('profile-content');
            const viewArea = document.getElementById('view-area');
            const syncBtn = document.getElementById('sync-btn');
            const pageTitleLabel = document.getElementById('page-title-label');
            const pageHeader = document.querySelector('.page-header');
            const nicknameEditBtn = document.getElementById('nickname-edit-btn');

            if (profileContent) profileContent.style.display = 'block';
            if (loginPrompt) loginPrompt.style.display = 'none';

            if (isViewMode) {
                // 髢ｲ隕ｧ繝｢繝ｼ繝芽ｨｭ螳・                if (viewArea) viewArea.style.display = 'block';
                if (syncBtn) syncBtn.style.display = 'none';
                if (pageTitleLabel) pageTitleLabel.style.display = 'block';
                if (pageHeader) pageHeader.textContent = '側 繝励Ξ繧､繝､繝ｼ繝励Ο繝輔ぅ繝ｼ繝ｫ';
                if (nicknameEditBtn) nicknameEditBtn.style.display = 'none';
            } else {
                // 繝槭う繝壹・繧ｸ險ｭ螳・                if (viewArea) viewArea.style.display = 'none';
                if (syncBtn) syncBtn.style.display = 'inline-block';
                if (pageTitleLabel) pageTitleLabel.style.display = 'none';
                if (pageHeader) pageHeader.textContent = '側 繝槭う繝壹・繧ｸ';
                if (nicknameEditBtn) nicknameEditBtn.style.display = 'inline-block';
                const coinTransferBtn = document.getElementById('coin-transfer-btn');
                if (coinTransferBtn) coinTransferBtn.style.display = 'inline-block';
            }
        }

        function showLoginPrompt() {
            document.getElementById('login-prompt').style.display = 'block';
            document.getElementById('profile-content').style.display = 'none';
        }

        /**
         * 閾ｪ蛻・ｼ医∪縺溘・縺ｪ繧翫☆縺ｾ縺励Θ繝ｼ繧ｶ繝ｼ・峨・諠・ｱ繧定｡ｨ遉ｺ
         */
        async function displayMyInfo(user) {
            const discordUser = user.user_metadata;
            const impersonated = getImpersonatedUser();

            // 繝ｦ繝ｼ繧ｶ繝ｼ諠・ｱ縺ｮ蜿門ｾ暦ｼ医ヰ繝・ず諠・ｱ繝ｻ繧ｳ繧､繝ｳ繝ｻ繝√・繝諠・ｱ繧貞性繧・・            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('account_name, avatar_url, coins, equipped_badge_id, team_id, badges!equipped_badge_id(image_url, name), teams!team_id(team_name)')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            // 繧｢繝舌ち繝ｼ・医↑繧翫☆縺ｾ縺嶺ｸｭ縺ｯDB縺九ｉ縲√◎縺・〒縺ｪ縺代ｌ縺ｰDiscord・・            const avatarUrl = impersonated
                ? (profile?.avatar_url || 'https://via.placeholder.com/150')
                : (discordUser.avatar_url || 'https://via.placeholder.com/150');
            document.getElementById('user-avatar').src = avatarUrl;

            // 蜷榊燕・医↑繧翫☆縺ｾ縺嶺ｸｭ縺ｯ縺ｪ繧翫☆縺ｾ縺励Θ繝ｼ繧ｶ繝ｼ蜷阪ｒ蜆ｪ蜈茨ｼ・            const name = impersonated
                ? (impersonated.name || profile?.account_name || '繝ｦ繝ｼ繧ｶ繝ｼ')
                : (profile?.account_name || discordUser.full_name || discordUser.name || '繝ｦ繝ｼ繧ｶ繝ｼ');
            const coins = profile?.coins || 0;

            // 蜷榊燕縺ｮ縺ｿ陦ｨ遉ｺ・医ヰ繝・ず縺ｯ蛻･隕∫ｴ・・            document.getElementById('user-name').textContent = name;

            // 繝舌ャ繧ｸ逕ｻ蜒上ｒ險ｭ螳・            const badgeImg = document.getElementById('user-equipped-badge');
            const badge = profile?.badges;
            if (badgeImg && badge) {
                badgeImg.src = badge.image_url;
                badgeImg.title = badge.name;
                badgeImg.style.display = 'block';
            }

            // 繝√・繝蜷阪ｒ險ｭ螳・            const teamNameEl = document.getElementById('user-team-name');
            if (teamNameEl) {
                const team = profile?.teams;
                teamNameEl.textContent = team?.team_name || '譛ｪ謇螻・;
            }

            // 繧ｳ繧､繝ｳ陦ｨ遉ｺ縺ｮ譖ｴ譁ｰ
            const coinsDisplay = document.getElementById('user-coins-display');
            const coinsValue = document.getElementById('user-coins-value');
            if (coinsDisplay && coinsValue) {
                coinsValue.textContent = coins.toLocaleString();
                coinsDisplay.style.display = 'block';
            }

            // 繝九ャ繧ｯ繝阪・繝邱ｨ髮・・繧ｿ繝ｳ繧定｡ｨ遉ｺ
            const nicknameEditBtn = document.getElementById('nickname-edit-btn');
            if (nicknameEditBtn) {
                nicknameEditBtn.style.display = 'inline-block';
            }

            if (profile?.account_name) {
                document.getElementById('user-nickname').value = profile.account_name;
            }
        }

        // 繝九ャ繧ｯ繝阪・繝邱ｨ髮・Δ繝ｼ繝繝ｫ繧帝幕縺・        function openNicknameModal() {
            const modalEl = document.getElementById('nicknameModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }

        /**
         * 莉紋ｺｺ縺ｮ諠・ｱ繧貞叙蠕励＠縺ｦ陦ｨ遉ｺ
         */
        async function loadTargetUserInfo() {
            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select('*, badges!equipped_badge_id(image_url, name), teams!team_id(team_name)')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            if (profile) {
                document.getElementById('user-avatar').src = profile.avatar_url || 'https://via.placeholder.com/150';

                // 蜷榊燕繧定ｨｭ螳・                document.getElementById('user-name').textContent = profile.account_name || '蜷咲ｧｰ譛ｪ險ｭ螳・;

                // 繝舌ャ繧ｸ逕ｻ蜒上ｒ險ｭ螳・                const badgeImg = document.getElementById('user-equipped-badge');
                const badge = profile?.badges;
                if (badgeImg && badge) {
                    badgeImg.src = badge.image_url;
                    badgeImg.title = badge.name;
                    badgeImg.style.display = 'block';
                }

                // 繝√・繝蜷阪ｒ險ｭ螳・                const teamNameEl = document.getElementById('user-team-name');
                if (teamNameEl) {
                    const team = profile?.teams;
                    teamNameEl.textContent = team?.team_name || '譛ｪ謇螻・;
                }

                // 繧ｳ繧､繝ｳ陦ｨ遉ｺ縺ｮ譖ｴ譁ｰ
                const coins = profile?.coins || 0;
                const coinsDisplay = document.getElementById('user-coins-display');
                const coinsValue = document.getElementById('user-coins-value');
                if (coinsDisplay && coinsValue) {
                    coinsValue.textContent = coins.toLocaleString();
                    coinsDisplay.style.display = 'block';
                }
            } else {
                document.getElementById('user-name').textContent = 'Unknown Player';
            }
        }

        async function useDiscordName() {
            const user = await getCurrentUser();
            if (!user) return;
            const discordUser = user.user_metadata;
            const discordDisplayName = discordUser.custom_claims?.global_name || discordUser.full_name || discordUser.name;
            document.getElementById('user-nickname').value = discordDisplayName;
        }

        async function updateAvatar() {
            const user = await getCurrentUser();
            if (!user || isViewMode) return;

            const btn = document.getElementById('sync-btn');
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = '譖ｴ譁ｰ荳ｭ...';

            try {
                const discordUser = user.user_metadata;
                const avatarUrl = discordUser.avatar_url || discordUser.picture || '';

                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        avatar_url: avatarUrl,
                        updated_at: new Date().toISOString()
                    })
                    .eq('discord_user_id', targetId);

                if (error) throw error;

                alert('繧｢繝舌ち繝ｼ逕ｻ蜒上ｒ譖ｴ譁ｰ縺励∪縺励◆・・);
                document.getElementById('user-avatar').src = avatarUrl;
            } catch (err) {
                console.error('Error:', err);
                alert('繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function saveNickname() {
            if (isViewMode) return;

            const newNickname = document.getElementById('user-nickname').value.trim();
            const msg = document.getElementById('save-msg');

            if (!newNickname) {
                msg.textContent = '繝九ャ繧ｯ繝阪・繝繧貞・蜉帙＠縺ｦ縺上□縺輔＞';
                msg.className = 'small mt-1 text-danger flex-grow-1';
                msg.style.display = 'block';
                setTimeout(() => { msg.style.display = 'none'; }, 3000);
                return;
            }

            msg.style.display = 'block';
            msg.textContent = '菫晏ｭ倅ｸｭ...';
            msg.className = 'small mt-1 text-muted flex-grow-1';

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({
                        account_name: newNickname,
                        updated_at: new Date().toISOString()
                    })
                    .eq('discord_user_id', targetId);

                if (error) throw error;

                msg.textContent = '菫晏ｭ倥＠縺ｾ縺励◆・・;
                msg.className = 'small mt-2 text-center text-success';

                // 繝｢繝ｼ繝繝ｫ繧帝哩縺倥ｋ
                const modalEl = document.getElementById('nicknameModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) {
                    setTimeout(() => {
                        modal.hide();
                        // 繝ｦ繝ｼ繧ｶ繝ｼ諠・ｱ繧貞・隱ｭ縺ｿ霎ｼ縺ｿ縺励※繝舌ャ繧ｸ莉倥″縺ｮ蜷榊燕繧呈峩譁ｰ
                        loadTargetUserInfo();
                    }, 1000);
                }
            } catch (err) {
                console.error('Error updating nickname:', err);
                msg.textContent = '繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆';
                msg.className = 'small mt-2 text-center text-danger';
            }
        }

        // ============ 繝舌ャ繧ｸ邂｡逅・ｩ溯・ ============
        async function loadOwnedBadges() {
            const section = document.getElementById('badge-collection-section');
            const specialSection = document.getElementById('special-badges-section');
            const specialList = document.getElementById('special-badge-list');
            const purchasableSection = document.getElementById('purchasable-badges-section');
            const purchasableList = document.getElementById('purchasable-badge-list');
            const noBadgesMsg = document.getElementById('no-badges-msg');
            const totalAssetsEl = document.getElementById('total-assets-value');

            if (!section) return;

            // 髢ｲ隕ｧ繝｢繝ｼ繝峨・蝣ｴ蜷医・縲∬｣・捩繝舌ャ繧ｸ縺縺題｡ｨ遉ｺ縺吶ｋ縺九√そ繧ｯ繧ｷ繝ｧ繝ｳ閾ｪ菴馴國縺呻ｼ井ｻ雁屓縺ｯ繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ陦ｨ遉ｺ・・            section.style.display = 'block';

            try {
                // 謇謖√ヰ繝・ず縺ｮ蜿門ｾ・                const { data: owned, error } = await supabaseClient
                    .from('user_badges')
                    .select('badge_id, badges(*)')
                    .eq('user_id', targetId);

                if (error) throw error;

                // 繝ｦ繝ｼ繧ｶ繝ｼ縺ｮ謇謖√さ繧､繝ｳ繧貞叙蠕暦ｼ育ｷ剰ｳ・肇險育ｮ礼畑・・                const { data: profileData } = await supabaseClient
                    .from('profiles')
                    .select('coins, equipped_badge_id')
                    .eq('discord_user_id', targetId)
                    .maybeSingle();

                const userCoins = profileData?.coins || 0;
                const equippedId = profileData?.equipped_badge_id;
                let badgeAssets = 0;

                // 閾ｪ蛻・・繝壹・繧ｸ縺ｪ繧臥ｮ｡逅・・繧ｿ繝ｳ繧定｡ｨ遉ｺ
                const badgeBtn = document.getElementById('badge-change-btn');
                const transferBtn = document.getElementById('badge-transfer-btn');
                const sellBtn = document.getElementById('badge-sell-btn');
                if (!isViewMode) {
                    if (badgeBtn) badgeBtn.style.display = 'inline-block';
                    if (transferBtn) transferBtn.style.display = 'inline-block';
                    if (sellBtn) sellBtn.style.display = 'inline-block';
                }

                if (!owned || owned.length === 0) {
                    if (specialSection) specialSection.style.display = 'none';
                    if (purchasableSection) purchasableSection.style.display = 'none';
                    if (noBadgesMsg) noBadgesMsg.style.display = 'block';
                    if (totalAssetsEl) totalAssetsEl.textContent = userCoins.toLocaleString();
                    return;
                }

                // 繝舌ャ繧ｸ繧帝寔險茨ｼ磯㍾隍・ｒ繧ｫ繧ｦ繝ｳ繝茨ｼ・                const badgeGroups = {};
                owned.forEach(item => {
                    const badge = item.badges;
                    if (!badge) return;

                    if (!badgeGroups[badge.id]) {
                        badgeGroups[badge.id] = {
                            badge: badge,
                            count: 0
                        };
                    }
                    badgeGroups[badge.id].count++;
                    badgeAssets += (badge.price || 0);
                });

                // 邱剰ｳ・肇縺ｮ陦ｨ遉ｺ譖ｴ譁ｰ
                if (totalAssetsEl) {
                    totalAssetsEl.textContent = (userCoins + badgeAssets).toLocaleString();
                }

                // 繝舌ャ繧ｸ繧帝・蛻励↓螟画鋤縺励※繧ｽ繝ｼ繝・(order -> name)
                const aggregatedBadges = Object.values(badgeGroups).sort((a, b) => {
                    const orderA = a.badge.order ?? 999;
                    const orderB = b.badge.order ?? 999;
                    if (orderA !== orderB) return orderA - orderB;
                    return a.badge.name.localeCompare(b.badge.name);
                });

                // 髱槫｣ｲ蜩・ｼ・acha_weight = 0・峨→雉ｼ蜈･蜿ｯ閭ｽ繝舌ャ繧ｸ縺ｫ蛻・￠繧・                const specialBadges = aggregatedBadges.filter(item => item.badge.gacha_weight === 0);
                const purchasableBadges = aggregatedBadges.filter(item => item.badge.gacha_weight !== 0);

                // 繝舌ャ繧ｸHTML逕滓・髢｢謨ｰ
                const renderBadge = (item) => {
                    const badge = item.badge;
                    const isEquipped = badge.id === equippedId;
                    return `
                        <div class="col-4 col-sm-3 col-md-2 text-center mb-3">
                            <div class="position-relative">
                                <a href="../badge/index.html?id=${badge.id}" class="text-decoration-none">
                                    <div class="badge-item ${isEquipped ? 'equipped' : ''}" 
                                         title="${badge.name}${isEquipped ? ' (陬・捩荳ｭ)' : ''}"
                                         style="position: relative;">
                                        <img src="${badge.image_url}" alt="${badge.name}">
                                        ${item.count > 1 ? `<span class="badge-count-overlay">${item.count}</span>` : ''}
                                    </div>
                                </a>
                            </div>
                            <div class="small text-muted text-truncate mt-1" style="font-size: 0.75rem;">${badge.name}</div>
                        </div>
                    `;
                };

                // 髱槫｣ｲ蜩√ヰ繝・ず繧定｡ｨ遉ｺ
                if (specialBadges.length > 0) {
                    specialSection.style.display = 'block';
                    specialList.innerHTML = specialBadges.map(renderBadge).join('');
                } else {
                    specialSection.style.display = 'none';
                }

                // 雉ｼ蜈･繝舌ャ繧ｸ繧定｡ｨ遉ｺ
                if (purchasableBadges.length > 0) {
                    purchasableSection.style.display = 'block';
                    purchasableList.innerHTML = purchasableBadges.map(renderBadge).join('');
                } else {
                    purchasableSection.style.display = 'none';
                }

                // 縺ｩ縺｡繧峨ｂ縺ｪ縺・ｴ蜷・                if (specialBadges.length === 0 && purchasableBadges.length === 0) {
                    noBadgesMsg.style.display = 'block';
                } else {
                    noBadgesMsg.style.display = 'none';
                }

            } catch (err) {
                console.error('繝舌ャ繧ｸ蜿門ｾ励お繝ｩ繝ｼ:', err);
                if (noBadgesMsg) {
                    noBadgesMsg.textContent = '隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ縺ｫ繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆';
                    noBadgesMsg.className = 'text-center text-danger py-3';
                    noBadgesMsg.style.display = 'block';
                }
            }
        }

        // ============ 雋ｩ螢ｲ螳溽ｸｾ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ ============
        async function loadRevenueStats() {
            const section = document.getElementById('revenue-section');
            if (!section) return;

            try {
                // revenue_share・亥｣ｲ荳企ｄ蜈・ｼ峨・繝ｭ繧ｰ繧貞叙蠕・                const { data: logs, error } = await supabaseClient
                    .from('activity_logs')
                    .select('amount')
                    .eq('user_id', targetId)
                    .eq('action_type', 'revenue_share');

                if (error) {
                    console.log('Activity logs table may not exist yet:', error);
                    return;
                }

                if (!logs || logs.length === 0) {
                    // 雋ｩ螢ｲ螳溽ｸｾ縺後↑縺・ｴ蜷医・髱櫁｡ｨ遉ｺ縺ｮ縺ｾ縺ｾ
                    return;
                }

                section.style.display = 'block';

                const totalRevenue = logs.reduce((sum, log) => sum + (log.amount || 0), 0);
                document.getElementById('total-revenue').textContent = `ｪ・${totalRevenue.toLocaleString()}`;
                document.getElementById('revenue-count').textContent = logs.length;

            } catch (err) {
                console.error('雋ｩ螢ｲ螳溽ｸｾ蜿門ｾ励お繝ｩ繝ｼ:', err);
            }
        }

        // ============ 譛霑代・豢ｻ蜍輔Ο繧ｰ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ ============
        let activityPage = 0;
        const ACTIVITY_PER_PAGE = 10;

        async function loadActivityLogs(page = 1) {
            const listEl = document.getElementById('activity-list');
            const paginationEl = document.getElementById('activity-pagination');
            const section = document.getElementById('activity-section');
            if (!listEl) return;

            const pageSize = 10;
            console.log('--- loadActivityLogs start ---', { targetId, page });

            try {
                const targetProfile = allProfiles.find(u => u.discord_user_id === targetId);
                const targetName = targetProfile?.account_name;
                console.log('--- loadActivityLogs Integrated Fetch ---', { targetId, targetName });

                // 1. 譛譁ｰ縺ｮ豢ｻ蜍輔Ο繧ｰ (騾・≡繝ｻ縺翫∩縺上§遲・
                const { data: allLogs } = await supabaseClient
                    .from('activity_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(500);

                // 2. 譛譁ｰ縺ｮ鮗ｻ髮險倬鹸
                const { data: allMatches } = await supabaseClient
                    .from('match_results')
                    .select('*')
                    .order('event_datetime', { ascending: false })
                    .limit(500);

                // 3. 驕主悉縺ｮ鮗ｻ髮險倬鹸 (隨ｬ荳蝗槫､ｧ莨壹↑縺ｩ)
                const { data: legacyMatches } = await supabaseClient
                    .from('tournament_player_stats_snapshot')
                    .select('*')
                    .limit(500);

                // --- 繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ ---
                const logs = (allLogs || []).filter(l => {
                    // 縲蝉ｿｮ豁｣縲題・蛻・′縲御ｸｻ菴難ｼ・ser_id・峨阪〒縺ゅｋ繝ｭ繧ｰ縺ｮ縺ｿ繧定｡ｨ遉ｺ縲・                    // 縺薙ｌ縺ｫ繧医ｊ縲・∝女菫｡繝壹い縺ｮ驥崎､・｡ｨ遉ｺ繧・∬ｳｼ蜈･閠・′縲悟｣ｲ荳企ｄ蜈・阪Ο繧ｰ繧定ｦ九ｋ縺ｮ繧帝亟縺弱∪縺吶・                    if (l.user_id !== targetId) return false;

                    // 陬・捩繝ｭ繧ｰ縺ｯ髱櫁｡ｨ遉ｺ
                    if (l.action_type === 'badge_equip') return false;

                    return true;
                });

                const matches = (allMatches || []).filter(m =>
                    m.discord_user_id === targetId || (targetName && (m.account_name === targetName || m.nickname === targetName || m.player_name === targetName))
                );

                const legacy = (legacyMatches || []).filter(m =>
                    m.discord_user_id === targetId || (targetName && (m.account_name === targetName || m.nickname === targetName || m.player_name === targetName))
                );

                console.log('Filtered (Subjective Only):', { logs: logs.length, matches: matches.length, legacy: legacy.length });

                // --- 繝槭・繧ｸ ---
                // activity_logs 縺九ｉ鮗ｻ髮險倬鹸縺後↑縺上↑縺｣縺溘◆繧√∝腰邏斐↑邨仙粋縺ｨ繧ｽ繝ｼ繝医〒貂医・繧医≧縺ｫ縺ｪ繧翫∪縺吶・                let combined = [];

                logs.forEach(l => {
                    let details = l.details;
                    if (typeof details === 'string') { try { details = JSON.parse(details); } catch (e) { } }
                    combined.push({ ...l, details, timestamp: new Date(l.created_at), isMatch: false });
                });

                matches.forEach(m => {
                    combined.push({
                        action_type: 'mahjong', amount: null, match_id: m.match_id,
                        timestamp: new Date(m.event_datetime),
                        details: { rank: m.rank, final_score: m.final_score, mode: m.mahjong_mode },
                        isMatch: true
                    });
                });

                legacy.forEach(m => {
                    combined.push({
                        action_type: 'mahjong', amount: null, match_id: 'legacy-' + Math.random(),
                        timestamp: new Date(m.created_at || m.updated_at || '2024-01-01'),
                        details: {
                            rank: m.rank1_count > 0 ? 1 : (m.rank2_count > 0 ? 2 : (m.rank3_count > 0 ? 3 : 4)),
                            final_score: m.score_total, mode: '驕主悉螟ｧ莨・, is_legacy: true
                        },
                        isMatch: true
                    });
                });

                combined.sort((a, b) => b.timestamp - a.timestamp);

                if (combined.length === 0) {
                    const rlsHint = (allLogs && allLogs.length === 0) ? '<br><small class="text-warning">窶ｻ騾・≡險倬鹸縺ｪ縺ｩ縺・莉ｶ繧り｡ｨ遉ｺ縺輔ｌ縺ｪ縺・ｴ蜷医ヾupabase縺ｮ讓ｩ髯占ｨｭ螳・RLS)縺悟ｿ・ｦ√〒縺吶・/small>' : '';
                    listEl.innerHTML = `<div class="text-center text-muted py-3">豢ｻ蜍輔Ο繧ｰ縺ｯ縺ｾ縺縺ゅｊ縺ｾ縺帙ｓ${rlsHint}</div>`;
                    section.style.display = 'block';
                    paginationEl.style.display = 'none';
                    return;
                }

                section.style.display = 'block';

                // 5. 繝壹・繧ｸ繝阪・繧ｷ繝ｧ繝ｳ蜃ｦ逅・                const itemsPerPage = 8;
                const totalPages = Math.ceil(combined.length / itemsPerPage);
                const pageItems = combined.slice((page - 1) * itemsPerPage, page * itemsPerPage);

                const typeNames = {
                    'mahjong': '・鮗ｻ髮險倬鹸',
                    'transfer_send': '頂 騾・≡(騾・',
                    'transfer_receive': 'ｧｧ 騾・≡(蜿・',
                    'badge_transfer': '氏 繝舌ャ繧ｸ隴ｲ貂｡',
                    'badge_receive': '逃 繝舌ャ繧ｸ蜿怜叙',
                    'badge_sell': '超 繝舌ャ繧ｸ螢ｲ蜊ｴ',
                    'badge_purchase': '將 繝舌ャ繧ｸ雉ｼ蜈･',
                    'omikuji': '視 縺翫∩縺上§',
                    'revenue_share': '虫 螢ｲ荳企ｄ蜈・,
                    'admin_edit': '笞呻ｸ・邂｡逅・・ｿｮ豁｣'
                };

                listEl.innerHTML = pageItems.map(log => {
                    const date = log.timestamp.toLocaleString('ja-JP', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });
                    const typeName = typeNames[log.action_type] || log.action_type;
                    const amountStr = log.amount !== null ? `ｪ・${log.amount.toLocaleString()}` : '';

                    // 逶ｸ謇九・諠・ｱ繧貞叙蠕暦ｼ亥渕譛ｬ縺ｯ target_user_id縲ょｸｸ縺ｫ譛譁ｰ縺ｮ繝励Ο繝輔ぅ繝ｼ繝ｫ繧貞盾辣ｧ・・                    const otherId = log.target_user_id;
                    const otherProfile = otherId ? allProfiles.find(p => p.discord_user_id === String(otherId)) : null;

                    const otherHtml = otherProfile ? `
                        <div class="d-inline-flex align-items-center gap-1 mx-1">
                            <img src="${otherProfile.avatar_url || 'https://cdn.discordapp.com/embed/avatars/0.png'}" 
                                 class="rounded-circle shadow-sm" style="width: 24px; height: 24px; object-fit: cover;">
                            <span class="fw-bold">${otherProfile.account_name || '隱ｰ縺・}</span>
                        </div>` : (otherId ? `<span class="badge bg-secondary">ID: ${otherId}</span>` : '');

                    let detailsStr = '';
                    if (log.isMatch) {
                        const rank = log.details?.rank || '-';
                        const score = log.details?.final_score || '0';
                        const mode = log.details?.mode || '';
                        detailsStr = `<span class="badge bg-light text-dark shadow-sm">${mode} ${rank}菴・(${score}pts)</span>`;
                    } else if (log.action_type === 'transfer_send') {
                        detailsStr = `筐｡ ${otherHtml} 縺ｸ縺ｮ騾・≡`;
                    } else if (log.action_type === 'transfer_receive') {
                        detailsStr = `筮・${otherHtml} 縺九ｉ縺ｮ騾・≡`;
                    } else if (log.action_type === 'badge_transfer') {
                        detailsStr = `氏 縲・{log.details?.badge_name || '繝舌ャ繧ｸ'}縲阪ｒ ${otherHtml} 縺ｸ隴ｲ貂｡`;
                    } else if (log.action_type === 'badge_receive') {
                        detailsStr = `逃 縲・{log.details?.badge_name || '繝舌ャ繧ｸ'}縲阪ｒ ${otherHtml} 縺九ｉ蜿怜叙`;
                    } else if (log.action_type === 'badge_sell') {
                        detailsStr = `超 縲・{log.details?.badge_name || '繝舌ャ繧ｸ'}縲阪ｒ螢ｲ蜊ｴ`;
                    } else if (log.action_type === 'badge_purchase') {
                        detailsStr = `將 縲・{log.details?.badge_name || '繝舌ャ繧ｸ'}縲阪ｒ雉ｼ蜈･`;
                    } else if (log.action_type === 'omikuji') {
                        detailsStr = `視 驕句兇: <strong>${log.details?.rank || '荳肴・'}</strong>`;
                    } else if (log.action_type === 'revenue_share') {
                        detailsStr = `虫 縲・{log.details?.badge_name || '繝舌ャ繧ｸ'}縲阪・螢ｲ雋ｷ驍・・ ${otherId ? `(by ${otherHtml})` : ''}`;
                    } else if (log.action_type === 'admin_edit') {
                        detailsStr = `笞呻ｸ・邂｡逅・・↓繧医ｋ${log.amount >= 0 ? '蜉邂・ : '貂帷ｮ・}`;
                    }

                    return `
                        <div class="activity-item-card">
                            <span class="activity-date">${date}</span>
                            <div class="row align-items-center g-2">
                                <div class="col">
                                    <div class="d-flex flex-wrap align-items-center gap-2">
                                        <span class="activity-type-badge">${typeName}</span>
                                        <span class="activity-details">${detailsStr}</span>
                                    </div>
                                </div>
                                <div class="col-auto text-end">
                                    <span class="activity-amount ${log.amount > 0 ? 'text-success' : log.amount < 0 ? 'text-danger' : ''}">${amountStr}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // 6. 繝壹・繧ｸ繝阪・繧ｷ繝ｧ繝ｳUI
                if (totalPages > 1) {
                    let pagHtml = '';
                    for (let i = 1; i <= totalPages; i++) {
                        pagHtml += `<li class="page-item ${i === page ? 'active' : ''}">
                            <a class="page-link" href="javascript:void(0)" onclick="loadActivityLogs(${i})">${i}</a>
                        </li>`;
                    }
                    paginationEl.innerHTML = pagHtml;
                    paginationEl.style.display = 'flex';
                } else {
                    paginationEl.style.display = 'none';
                }

            } catch (err) {
                console.error('Activity logs error:', err);
                listEl.innerHTML = '<div class="text-center text-danger py-3">繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆</div>';
            }
        }

        // ============ 繝舌ャ繧ｸ隴ｲ貂｡繝ｻ螢ｲ蜊ｴ・壹ヰ繝・ず驕ｸ謚槭Δ繝ｼ繝繝ｫ ============
        async function openBadgeSelectionModal(mode) {
            const listEl = document.getElementById('action-badge-list');
            listEl.innerHTML = '<p class="text-center text-muted py-3">隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ...</p>';

            document.getElementById('badgeActionModalLabel').textContent = mode === 'transfer' ? '隴ｲ貂｡縺吶ｋ繝舌ャ繧ｸ繧帝∈謚・ : '螢ｲ蜊ｴ縺吶ｋ繝舌ャ繧ｸ繧帝∈謚・;

            const modalEl = document.getElementById('badgeActionModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();

            try {
                // 謇謖√ヰ繝・ず縺ｮ蜿門ｾ・(髱槫｣ｲ蜩∽ｻ･螟・
                const { data: owned, error } = await supabaseClient
                    .from('user_badges')
                    .select('badge_id, badges(*)')
                    .eq('user_id', targetId);

                if (error) throw error;

                // 髱槫｣ｲ蜩√ｒ髯､螟悶＠縺ｦ縲∝酔縺倥ヰ繝・ず繧偵∪縺ｨ繧√ｋ
                const badgeGroups = {};
                owned.forEach(item => {
                    const badge = item.badges;
                    if (!badge || badge.gacha_weight === 0) return;
                    if (!badgeGroups[badge.id]) {
                        badgeGroups[badge.id] = { badge: badge, count: 0 };
                    }
                    badgeGroups[badge.id].count++;
                });

                const sortedBadges = Object.values(badgeGroups);

                if (sortedBadges.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-muted py-3">驕ｸ謚槫庄閭ｽ縺ｪ繝舌ャ繧ｸ縺後≠繧翫∪縺帙ｓ</p>';
                    return;
                }

                listEl.innerHTML = sortedBadges.map(item => {
                    const badge = item.badge;
                    const priceInfo = mode === 'sell' ? `<div class="small text-danger fw-bold">ｪ・{Math.floor(badge.price * 0.5).toLocaleString()}</div>` : '';
                    return `
                        <div class="col-4 col-md-3 text-center mb-2">
                            <div class="badge-item" 
                                 onclick="onBadgeSelectedForAction('${badge.id}', '${badge.name.replace(/'/g, "\\'")}', ${badge.price}, '${mode}')"
                                 style="cursor: pointer; position: relative;"
                                 title="${badge.name}">
                                <img src="${badge.image_url}" alt="${badge.name}" style="width: 60px; height: 60px; object-fit: contain;">
                                ${item.count > 1 ? `<span class="badge-count-overlay">${item.count}</span>` : ''}
                            </div>
                            <div class="small text-truncate mt-1" style="font-size: 0.7rem;">${badge.name}</div>
                            ${priceInfo}
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('繝舌ャ繧ｸ隱ｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:', err);
                listEl.innerHTML = '<p class="text-center text-danger py-3">繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆</p>';
            }
        }

        let currentActionBadgeId = null;
        let currentActionBadgeName = '';
        let currentActionBadgePrice = 0;

        function onBadgeSelectedForAction(badgeId, badgeName, price, mode) {
            currentActionBadgeId = badgeId;
            currentActionBadgeName = badgeName;
            currentActionBadgePrice = price;

            // 驕ｸ謚槭Δ繝ｼ繝繝ｫ繧帝哩縺倥ｋ
            const actionModal = bootstrap.Modal.getInstance(document.getElementById('badgeActionModal'));
            actionModal.hide();

            if (mode === 'transfer') {
                openUserSelectModal('badge');
            } else {
                executeSell(badgeId, badgeName, price);
            }
        }

        // ============ 螢ｲ蜊ｴ螳溯｡・============
        async function executeSell(badgeId, badgeName, price) {
            const sellPrice = Math.floor(price * 0.5);
            if (!confirm(`縲・{badgeName}縲阪ｒ螢ｲ蜊ｴ縺励※ ｪ・{sellPrice.toLocaleString()} 繧貞女縺大叙繧翫∪縺吶°・歃n・医％縺ｮ謫堺ｽ懊・蜿悶ｊ豸医○縺ｾ縺帙ｓ・荏)) {
                return;
            }

            try {
                toggleLoading(true);

                // 1. 繝舌ャ繧ｸ繧・縺､蜑企勁
                const { data: owned, error: fetchError } = await supabaseClient
                    .from('user_badges')
                    .select('id')
                    .eq('user_id', targetId)
                    .eq('badge_id', badgeId)
                    .limit(1)
                    .single();

                if (fetchError) throw new Error('繝舌ャ繧ｸ縺ｮ謇謖√ョ繝ｼ繧ｿ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ縺ｧ縺励◆');

                const { error: deleteError } = await supabaseClient
                    .from('user_badges')
                    .delete()
                    .eq('id', owned.id);

                if (deleteError) throw deleteError;

                // 2. 繝舌ャ繧ｸ縺ｮ蝨ｨ蠎ｫ繧呈綾縺呻ｼ・emaining_count 縺瑚ｨｭ螳壹＆繧後※縺・ｋ蝣ｴ蜷茨ｼ・                const { data: badge, error: badgeFetchError } = await supabaseClient
                    .from('badges')
                    .select('remaining_count')
                    .eq('id', badgeId)
                    .single();

                if (!badgeFetchError && badge && badge.remaining_count !== null) {
                    await supabaseClient
                        .from('badges')
                        .update({ remaining_count: badge.remaining_count + 1 })
                        .eq('id', badgeId);
                }

                // 3. 繧ｳ繧､繝ｳ縺ｮ蜉邂・                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('coins')
                    .eq('discord_user_id', targetId)
                    .single();

                if (profileError) throw profileError;

                const { error: updateError } = await supabaseClient
                    .from('profiles')
                    .update({ coins: (profile.coins || 0) + sellPrice })
                    .eq('discord_user_id', targetId);

                if (updateError) throw updateError;

                // 4. 邱剰ｳ・肇繧貞刈邂・                if (typeof addToTotalAssets === 'function') {
                    await addToTotalAssets(targetId, sellPrice);
                }

                // 5. 豢ｻ蜍輔Ο繧ｰ繧定ｨ倬鹸
                if (typeof logActivity === 'function') {
                    await logActivity(targetId, 'badge_sell', {
                        amount: sellPrice,
                        badgeId: badgeId,
                        details: { badge_name: badgeName, original_price: price }
                    });
                }

                alert(`${badgeName} 繧貞｣ｲ蜊ｴ縺励∪縺励◆縲を洙・{sellPrice} 繧堤佐蠕励＠縺ｾ縺励◆縲Ａ);
                location.reload();
            } catch (err) {
                console.error('螢ｲ蜊ｴ繧ｨ繝ｩ繝ｼ:', err);
                alert('螢ｲ蜊ｴ蜃ｦ逅・↓螟ｱ謨励＠縺ｾ縺励◆: ' + err.message);
            } finally {
                toggleLoading(false);
            }
        }

        // ============ 隴ｲ貂｡・壹Θ繝ｼ繧ｶ繝ｼ驕ｸ謚・============
        let transferType = 'badge'; // 'badge' or 'coin'
        async function openUserSelectModal(type = 'badge') {
            transferType = type;
            const listEl = document.getElementById('transfer-user-list');
            listEl.innerHTML = '<p class="text-center text-muted py-4">隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ...</p>';

            document.getElementById('userSelectModalLabel').textContent = type === 'coin' ? '騾・≡蜈医・繝ｦ繝ｼ繧ｶ繝ｼ繧帝∈謚・ : '隴ｲ貂｡蜈医・繝ｦ繝ｼ繧ｶ繝ｼ繧帝∈謚・;

            const modal = new bootstrap.Modal(document.getElementById('userSelectModal'));
            modal.show();

            try {
                const { data: users, error } = await supabaseClient
                    .from('profiles')
                    .select('discord_user_id, account_name, avatar_url, equipped_badge_id, badges!equipped_badge_id(image_url, name)')
                    .neq('discord_user_id', targetId) // 閾ｪ蛻・ｻ･螟・                    .order('account_name');

                if (error) throw error;

                if (!users || users.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-muted py-4">繝ｦ繝ｼ繧ｶ繝ｼ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ</p>';
                    return;
                }

                listEl.innerHTML = users.map(u => {
                    const avatar = u.avatar_url || 'https://via.placeholder.com/40';
                    const badgeHtml = u.badges ? `<img src="${u.badges.image_url}" class="user-select-badge" title="${u.badges.name}">` : '';
                    return `
                        <div class="user-select-item" onclick="onUserSelectedForTransfer('${u.discord_user_id}', '${u.account_name.replace(/'/g, "\\'")}')">
                            <img src="${avatar}" class="user-select-avatar" onerror="this.src='https://via.placeholder.com/40'">
                            <div class="d-flex align-items-center flex-grow-1">
                                <span class="user-select-name">${u.account_name}</span>
                                ${badgeHtml}
                            </div>
                            <div class="text-muted small">驕ｸ謚・笶ｯ</div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('繝ｦ繝ｼ繧ｶ繝ｼ蜿門ｾ励お繝ｩ繝ｼ:', err);
                listEl.innerHTML = '<p class="text-center text-danger py-4">繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆</p>';
            }
        }

        function onUserSelectedForTransfer(userId, userName) {
            // 繝ｦ繝ｼ繧ｶ繝ｼ驕ｸ謚槭Δ繝ｼ繝繝ｫ繧帝哩縺倥ｋ
            const userModal = bootstrap.Modal.getInstance(document.getElementById('userSelectModal'));
            userModal.hide();

            if (transferType === 'badge') {
                executeTransferConfirmation(userId, userName);
            } else {
                openCoinAmountModal(userId, userName);
            }
        }

        // ============ 繧ｳ繧､繝ｳ騾・≡繝輔Ο繝ｼ ============
        let coinTransferTargetId = null;
        let coinTransferTargetName = '';

        function openCoinTransferModal() {
            openUserSelectModal('coin');
        }

        async function openCoinAmountModal(userId, userName) {
            coinTransferTargetId = userId;
            coinTransferTargetName = userName;

            document.getElementById('coin-transfer-target-name').textContent = `${userName} 縺輔ｓ縺ｸ騾・≡`;

            // 閾ｪ蛻・・莉翫・謇謖・≡繧定｡ｨ遉ｺ
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('coins')
                .eq('discord_user_id', targetId)
                .single();

            const currentCoins = profile?.coins || 0;
            document.getElementById('my-coins-ref').textContent = currentCoins.toLocaleString();
            document.getElementById('coin-transfer-amount').value = '';

            const modal = new bootstrap.Modal(document.getElementById('coinAmountModal'));
            modal.show();
        }

        async function executeCoinTransfer() {
            const amountInput = document.getElementById('coin-transfer-amount');
            const amount = parseInt(amountInput.value);

            if (isNaN(amount) || amount <= 0) {
                alert('譛牙柑縺ｪ驥鷹｡阪ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞');
                return;
            }

            // 譛邨ら｢ｺ隱・            if (!confirm(`${coinTransferTargetName} 縺輔ｓ縺ｫ ｪ・{amount.toLocaleString()} 繧帝・≡縺励∪縺吶°・歔)) {
                return;
            }

            try {
                toggleLoading(true);

                // 1. 閾ｪ蛻・・謇謖・≡繝√ぉ繝・け
                const { data: sender, error: senderError } = await supabaseClient
                    .from('profiles')
                    .select('coins')
                    .eq('discord_user_id', targetId)
                    .single();

                if (senderError) throw senderError;
                if ((sender.coins || 0) < amount) {
                    throw new Error('謇謖・≡縺瑚ｶｳ繧翫∪縺帙ｓ');
                }

                // 2. 逶ｸ謇九・蟄伜惠繝√ぉ繝・け・亥ｿｵ縺ｮ縺溘ａ・・                const { data: receiver, error: receiverError } = await supabaseClient
                    .from('profiles')
                    .select('coins')
                    .eq('discord_user_id', coinTransferTargetId)
                    .single();

                if (receiverError) throw receiverError;

                // 3. 騾・≡蜃ｦ逅・(繝槭う繝翫せ)
                const { error: updateSenderError } = await supabaseClient
                    .from('profiles')
                    .update({ coins: sender.coins - amount })
                    .eq('discord_user_id', targetId);

                if (updateSenderError) throw updateSenderError;

                // 4. 蜈･驥大・逅・(繝励Λ繧ｹ)
                const { error: updateReceiverError } = await supabaseClient
                    .from('profiles')
                    .update({ coins: (receiver.coins || 0) + amount })
                    .eq('discord_user_id', coinTransferTargetId);

                if (updateReceiverError) {
                    // 繝ｭ繝ｼ繝ｫ繝舌ャ繧ｯ逧・↑蜃ｦ逅・′蠢・ｦ√□縺後ヾupabase RLS/Update縺ｧ縺ｯ髮｣縺励＞縺ｮ縺ｧ繧ｨ繝ｩ繝ｼ騾夂衍
                    console.error('蜈･驥代↓螟ｱ謨励＠縺ｾ縺励◆・磯・≡蜈・・貂幃｡肴ｸ医∩・・', updateReceiverError);
                    alert('蜈･驥大・逅・↓螟ｱ謨励＠縺ｾ縺励◆縲らｮ｡逅・・↓騾｣邨｡縺励※縺上□縺輔＞縲・);
                    return;
                }

                // 5. 豢ｻ蜍輔Ο繧ｰ繧定ｨ倬鹸・磯∽ｿ｡蛛ｴ・・                if (typeof logActivity === 'function') {
                    await logActivity(targetId, 'transfer_send', {
                        amount: amount,
                        targetUserId: coinTransferTargetId,
                        details: { target_name: coinTransferTargetName }
                    });
                    // 豢ｻ蜍輔Ο繧ｰ繧定ｨ倬鹸・亥女菫｡蛛ｴ・・                    const senderName = document.getElementById('nickname-display')?.textContent || '隱ｰ縺・;
                    await logActivity(coinTransferTargetId, 'transfer_receive', {
                        amount: amount,
                        targetUserId: targetId,
                        details: { sender_name: senderName }
                    });
                }

                alert(`${coinTransferTargetName} 縺輔ｓ縺ｫ ｪ・{amount.toLocaleString()} 繧帝・≡縺励∪縺励◆・～);
                location.reload();

            } catch (err) {
                console.error('騾・≡繧ｨ繝ｩ繝ｼ:', err);
                alert('騾・≡縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + err.message);
            } finally {
                toggleLoading(false);
            }
        }

        async function executeTransferConfirmation(toUserId, toUserName) {
            if (!confirm(`縲・{currentActionBadgeName}縲阪ｒ ${toUserName} 縺輔ｓ縺ｫ隴ｲ貂｡縺励∪縺吶°・歃n・医≠縺ｪ縺溘・謇区戟縺｡縺九ｉ縺ｯ1縺､縺ｪ縺上↑繧翫∪縺呻ｼ荏)) {
                return;
            }

            try {
                toggleLoading(true);

                // 1. 閾ｪ蛻・・繝舌ャ繧ｸ繧・縺､蜑企勁
                const { data: owned, error: fetchError } = await supabaseClient
                    .from('user_badges')
                    .select('id')
                    .eq('user_id', targetId)
                    .eq('badge_id', currentActionBadgeId)
                    .limit(1)
                    .single();

                if (fetchError) throw new Error('隴ｲ貂｡縺吶ｋ繝舌ャ繧ｸ縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ');

                const { error: deleteError } = await supabaseClient
                    .from('user_badges')
                    .delete()
                    .eq('id', owned.id);

                if (deleteError) throw deleteError;

                // 2. 逶ｸ謇九↓莉倅ｸ・                const { error: insertError } = await supabaseClient
                    .from('user_badges')
                    .insert([{ user_id: toUserId, badge_id: currentActionBadgeId }]);

                if (insertError) throw insertError;

                // 3. 豢ｻ蜍輔Ο繧ｰ繧定ｨ倬鹸
                if (typeof logActivity === 'function') {
                    const senderName = document.getElementById('nickname-display')?.textContent || '隱ｰ縺・;
                    await logActivity(targetId, 'badge_transfer', {
                        badgeId: currentActionBadgeId,
                        targetUserId: toUserId,
                        details: { target_name: toUserName, badge_name: currentActionBadgeName }
                    });
                    await logActivity(toUserId, 'badge_receive', {
                        badgeId: currentActionBadgeId,
                        targetUserId: targetId,
                        details: { sender_name: senderName, badge_name: currentActionBadgeName }
                    });
                }

                alert(`${toUserName} 縺輔ｓ縺ｫ繝舌ャ繧ｸ繧定ｭｲ貂｡縺励∪縺励◆・～);
                location.reload();
            } catch (err) {
                console.error('隴ｲ貂｡繧ｨ繝ｩ繝ｼ:', err);
                alert('隴ｲ貂｡縺ｫ螟ｱ謨励＠縺ｾ縺励◆: ' + err.message);
            } finally {
                toggleLoading(false);
            }
        }

        async function equipBadge(badgeId) {
            if (isViewMode) return;

            // 迴ｾ蝨ｨ縺ｮ陬・捩迥ｶ豕√ｒ遒ｺ隱・            const { data: current } = await supabaseClient
                .from('profiles')
                .select('equipped_badge_id')
                .eq('discord_user_id', targetId)
                .maybeSingle();

            // 蜷後§繝舌ャ繧ｸ繧偵け繝ｪ繝・け縺励◆蝣ｴ蜷医・螟悶☆・井ｻｻ諢擾ｼ壻ｻ雁屓縺ｯ縲悟､悶☆縲肴ｩ溯・繧ょ・縺ｭ繧具ｼ・            const newBadgeId = (current?.equipped_badge_id === badgeId) ? null : badgeId;

            try {
                const { error } = await supabaseClient
                    .from('profiles')
                    .update({ equipped_badge_id: newBadgeId })
                    .eq('discord_user_id', targetId);

                if (error) throw error;

                await loadOwnedBadges(); // 繝ｪ繧ｹ繝域峩譁ｰ
                await loadTargetUserInfo(); // 蜷榊燕讓ｪ縺ｮ繝舌ャ繧ｸ譖ｴ譁ｰ
                displayUserInfo(); // 繝倥ャ繝繝ｼ譖ｴ譁ｰ

                // 繝｢繝ｼ繝繝ｫ繧帝哩縺倥ｋ
                const modalEl = document.getElementById('badgeChangeModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();
            } catch (err) {
                console.error('繝舌ャ繧ｸ螟画峩繧ｨ繝ｩ繝ｼ:', err);
                alert('繝舌ャ繧ｸ縺ｮ螟画峩縺ｫ螟ｱ謨励＠縺ｾ縺励◆');
            }
        }

        // 繝舌ャ繧ｸ螟画峩繝｢繝ｼ繝繝ｫ繧帝幕縺・        async function openBadgeChangeModal() {
            const listEl = document.getElementById('badge-modal-list');
            listEl.innerHTML = '<p class="text-center text-muted py-3">隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ...</p>';

            const modalEl = document.getElementById('badgeChangeModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();

            try {
                // 謇謖√ヰ繝・ず縺ｮ蜿門ｾ・                const { data: owned, error } = await supabaseClient
                    .from('user_badges')
                    .select('badge_id, badges(*)')
                    .eq('user_id', targetId);

                if (error) throw error;

                // 陬・捩荳ｭ縺ｮ繝舌ャ繧ｸID蜿門ｾ・                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('equipped_badge_id')
                    .eq('discord_user_id', targetId)
                    .maybeSingle();

                const equippedId = profile?.equipped_badge_id;

                if (!owned || owned.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-muted py-3">繝舌ャ繧ｸ繧呈戟縺｣縺ｦ縺・∪縺帙ｓ</p>';
                    return;
                }

                listEl.innerHTML = owned.map(item => {
                    const badge = item.badges;
                    if (!badge) return '';
                    const isEquipped = badge.id === equippedId;
                    return `
                        <div class="col-4 col-md-3 text-center">
                            <div class="badge-item ${isEquipped ? 'equipped' : ''}" 
                                 onclick="equipBadge('${badge.id}')"
                                 style="cursor: pointer;"
                                 title="${badge.name}${isEquipped ? ' (陬・捩荳ｭ)' : ''}">
                                <img src="${badge.image_url}" alt="${badge.name}" style="width: 60px; height: 60px; object-fit: contain;">
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('繝舌ャ繧ｸ隱ｭ縺ｿ霎ｼ縺ｿ繧ｨ繝ｩ繝ｼ:', err);
                listEl.innerHTML = '<p class="text-center text-danger py-3">繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆</p>';
            }
        }

        // ============ 鮗ｻ髮邨ｱ險域ｩ溯・ ============
        let allMahjongRecords = [];
        let myAccountName = '';
        let currentMyTournament = '隨ｬ莠悟屓鮗ｻ髮螟ｧ莨・;

        async function loadMahjongStats() {
            try {
                // URL繝代Λ繝｡繝ｼ繧ｿ縺九ｉ迚ｹ螳壹Θ繝ｼ繧ｶ繝ｼID繧貞叙蠕暦ｼ育ｮ｡逅・・畑・・                const urlParams = new URLSearchParams(window.location.search);
                const targetUserId = urlParams.get('user');

                if (targetUserId) {
                    // 迚ｹ螳壹Θ繝ｼ繧ｶ繝ｼ縺ｮ邨ｱ險医ｒ陦ｨ遉ｺ
                    myAccountName = targetUserId;
                } else {
                    // 閾ｪ蛻・・邨ｱ險医ｒ陦ｨ遉ｺ
                    const user = await getCurrentUser();
                    if (!user) return;
                    myAccountName = user.user_metadata.provider_id;
                }

                // 隨ｬ莠悟屓鮗ｻ髮螟ｧ莨壹ョ繝ｼ繧ｿ
                const { data: currentData, error: currentError } = await supabaseClient
                    .from('match_results')
                    .select('*');

                if (currentError) {
                    console.warn('隨ｬ莠悟屓繝・・繧ｿ蜿門ｾ励お繝ｩ繝ｼ:', currentError);
                }

                // 隨ｬ荳蝗樣ｺｻ髮螟ｧ莨壹ョ繝ｼ繧ｿ
                let legacyData = [];
                try {
                    const { data, error: legacyError } = await supabaseClient
                        .from('tournament_player_stats_snapshot')
                        .select('*');

                    if (legacyError) {
                        console.warn('隨ｬ荳蝗槭ョ繝ｼ繧ｿ蜿門ｾ励お繝ｩ繝ｼ:', legacyError);
                    } else {
                        legacyData = data || [];
                    }
                } catch (e) {
                    console.warn('隨ｬ荳蝗槭ョ繝ｼ繧ｿ蜿門ｾ励せ繧ｭ繝・・:', e);
                }

                // 譁ｰ繝・・繧ｿ縺ｫ繧・tournament_type 繧剃ｿ晞囿
                const taggedCurrentData = (currentData || []).map(r => ({
                    ...r,
                    tournament_type: r.tournament_type || '隨ｬ莠悟屓鮗ｻ髮螟ｧ莨・
                }));

                // 驕主悉繝・・繧ｿ縺ｫ tournament_type 繧剃ｿ晞囿
                const taggedLegacyData = (legacyData || []).map(r => ({
                    ...r,
                    tournament_type: r.tournament_type || '隨ｬ荳蝗樣ｺｻ髮螟ｧ莨・
                }));

                allMahjongRecords = [...taggedCurrentData, ...taggedLegacyData];
                console.log('投 蜿門ｾ励＠縺溘Ξ繧ｳ繝ｼ繝画焚:', allMahjongRecords.length);

                renderTournamentDropdown();
                displayMahjongStats();
            } catch (err) {
                console.error('鮗ｻ髮邨ｱ險亥叙蠕励お繝ｩ繝ｼ:', err);
                document.getElementById('stats-loading').style.display = 'none';
                document.getElementById('no-stats-msg').style.display = 'block';
                document.getElementById('stats-content').style.display = 'block';
            }
        }

        function renderTournamentDropdown() {
            const select = document.getElementById('tournament-select');
            if (!select) return;

            const tournaments = ['隨ｬ莠悟屓鮗ｻ髮螟ｧ莨・, '隨ｬ荳蝗樣ｺｻ髮螟ｧ莨・];

            let html = '';
            tournaments.forEach(t => {
                html += `<option value="${t}" ${currentMyTournament === t ? 'selected' : ''}>${t}</option>`;
            });
            html += `<option value="all" ${currentMyTournament === 'all' ? 'selected' : ''}>蜈ｨ繧ｷ繝ｼ繧ｺ繝ｳ</option>`;

            select.innerHTML = html;
        }

        function handleTournamentChange() {
            const select = document.getElementById('tournament-select');
            currentMyTournament = select.value;
            displayMahjongStats();
        }

        function displayMahjongStats() {
            // 螟ｧ莨壹ヵ繧｣繝ｫ繧ｿ
            let records = allMahjongRecords;
            if (currentMyTournament !== 'all') {
                records = allMahjongRecords.filter(r => r.tournament_type === currentMyTournament);
            }

            // 蜈ｨ繝励Ξ繧､繝､繝ｼ縺ｮ邨ｱ險郁ｨ育ｮ・            const playerStats = calculateAllPlayerStats(records);

            // 繝・ヰ繝・げ: 蜈ｨ繝励Ξ繧､繝､繝ｼ蜷阪ｒ陦ｨ遉ｺ
            console.log('識 閾ｪ蛻・・繧｢繧ｫ繧ｦ繝ｳ繝亥錐:', myAccountName);
            console.log('搭 蜈ｨ繝励Ξ繧､繝､繝ｼ蜷・', playerStats.map(p => p.name));

            // 閾ｪ蛻・・邨ｱ險医ｒ蜿門ｾ・            const myStats = playerStats.find(p => p.name === myAccountName);
            const totalPlayers = playerStats.length;

            document.getElementById('stats-loading').style.display = 'none';
            document.getElementById('stats-content').style.display = 'block';

            const statsGrid = document.getElementById('stats-grid');
            const noStatsMsg = document.getElementById('no-stats-msg');

            if (!myStats || myStats.games === 0) {
                if (statsGrid) statsGrid.style.display = 'none';
                noStatsMsg.style.display = 'block';
                return;
            }
            if (statsGrid) statsGrid.style.display = 'block';
            noStatsMsg.style.display = 'none';

            // 蜷・ｵｱ險医ｒ陦ｨ遉ｺ
            const formatScore = (val) => {
                if (typeof val !== 'number') return val;
                // 蟆乗焚轤ｹ隨ｬ1菴阪∪縺ｧ縺ｫ荳ｸ繧√ｋ縺後・0 縺ｮ蝣ｴ蜷医・謨ｴ謨ｰ縺ｫ縺吶ｋ
                return Math.round(val * 10) / 10;
            };

            updateStatCard('total', formatScore(myStats.total), playerStats, 'total', true);
            updateStatCard('sanma', formatScore(myStats.sanma), playerStats, 'sanma', true);
            updateStatCard('yonma', formatScore(myStats.yonma), playerStats, 'yonma', true);
            updateStatCard('avg-score', formatScore(myStats.avgScore), playerStats, 'avgScore', true);
            updateStatCard('max-score', formatScore(myStats.maxScore), playerStats, 'maxScore', true);
            updateStatCard('win-rate', myStats.winRate.toFixed(2) + ' / 隧ｦ蜷・, playerStats, 'winRate', true);
            updateStatCard('deal-rate', myStats.dealRate.toFixed(2) + ' / 隧ｦ蜷・, playerStats, 'dealRate', false);
            updateStatCard('top-rate', myStats.topRate.toFixed(1) + '%', playerStats, 'topRate', true);
            updateStatCard('avoid-rate', myStats.avoidRate.toFixed(1) + '%', playerStats, 'avoidRate', true);
            updateStatCard('avg-rank', myStats.avgRank.toFixed(2), playerStats, 'avgRank', false);
            updateStatCard('games', myStats.games, playerStats, 'games', true);
        }

        function updateStatCard(id, value, allStats, key, higherIsBetter) {
            document.getElementById('stat-' + id).textContent = value;

            // 鬆・ｽ崎ｨ育ｮ・            const sorted = [...allStats].filter(p => p.games > 0).sort((a, b) =>
                higherIsBetter ? b[key] - a[key] : a[key] - b[key]
            );
            const myRank = sorted.findIndex(p => p.name === myAccountName) + 1;
            const total = sorted.length;

            const rankEl = document.getElementById('rank-' + id);
            if (myRank > 0) {
                rankEl.textContent = `${myRank}/${total}菴港;
                rankEl.classList.remove('no-data');
            } else {
                rankEl.textContent = '-';
                rankEl.classList.add('no-data');
            }
        }

        function calculateAllPlayerStats(records) {
            const players = {};

            records.forEach(r => {
                // discord_user_id繧偵く繝ｼ縺ｨ縺励※菴ｿ逕ｨ・医Λ繝ｳ繧ｭ繝ｳ繧ｰ縺ｨ蜷後§繝ｭ繧ｸ繝・け・・                let id = r.discord_user_id;
                if (!id || id === 'null') {
                    id = r.nickname || r.account_name || 'Unknown';
                }
                if (!id) return;

                if (!players[id]) {
                    players[id] = {
                        name: id,
                        score: 0, sanma: 0, yonma: 0,
                        count: 0, win: 0, deal: 0,
                        r1: 0, r2: 0, r3: 0, r4: 0,
                        max_score: -Infinity
                    };
                }

                const p = players[id];
                const mode = r.mahjong_mode || r.mode || ''; // 繝ｩ繝ｳ繧ｭ繝ｳ繧ｰ逕ｻ髱｢縺ｫ蜷医ｏ縺帙※ mahjong_mode 繧貞━蜈・
                // 隨ｬ荳蝗槫､ｧ莨壹→隨ｬ莠悟屓螟ｧ莨壹〒逡ｰ縺ｪ繧九き繝ｩ繝蜷阪ｒ蜃ｦ逅・                if (r.tournament_type === '隨ｬ荳蝗樣ｺｻ髮螟ｧ莨・) {
                    p.score += Number(r.score_total || 0);
                    p.count += Number(r.matches_played || 0);
                    p.r1 += Number(r.rank1_count || 0);
                    p.r2 += Number(r.rank2_count || 0);
                    p.r3 += Number(r.rank3_count || 0);
                    p.r4 += Number(r.rank4_count || 0);
                    p.max_score = Math.max(p.max_score, Number(r.score_max || 0));
                } else {
                    p.score += Number(r.final_score || 0);
                    p.count += 1;
                    const rk = Number(r.rank);
                    if (rk === 1) p.r1++;
                    else if (rk === 2) p.r2++;
                    else if (rk === 3) p.r3++;
                    else if (rk === 4) p.r4++;
                    p.max_score = Math.max(p.max_score, Number(r.final_score || 0));
                }

                p.win += Number(r.win_count || r.wins || 0);
                p.deal += Number(r.deal_in_count || r.deals || 0);

                // 繝｢繝ｼ繝牙挨繧ｹ繧ｳ繧｢・井ｸ蛾ｺｻ繧ｹ繧ｳ繧｢繝ｻ蝗幃ｺｻ繧ｹ繧ｳ繧｢陦ｨ遉ｺ逕ｨ・・                if (mode === '荳蛾ｺｻ') p.sanma += Number(r.final_score || r.score_total || 0);
                if (mode === '蝗幃ｺｻ') p.yonma += Number(r.final_score || r.score_total || 0);
            });

            // 邨ｱ險亥､繧定ｨ育ｮ・            return Object.values(players).map(p => {
                const avgWin = p.count > 0 ? (p.win / p.count) : 0;
                const avgDeal = p.count > 0 ? (p.deal / p.count) : 0;
                const topRate = p.count > 0 ? (p.r1 / p.count) * 100 : 0;
                let lastCount = p.r4;
                if (p.r4 === 0 && p.r3 > 0) lastCount = p.r3;
                const avoidRate = p.count > 0 ? (1 - (lastCount / p.count)) * 100 : 0;
                const avgRank = p.count > 0 ? (1 * p.r1 + 2 * p.r2 + 3 * p.r3 + 4 * p.r4) / p.count : 0;
                const avgScore = p.count > 0 ? p.score / p.count : 0;

                return {
                    name: p.name,
                    total: p.score,
                    sanma: p.sanma,
                    yonma: p.yonma,
                    avgScore: avgScore,
                    maxScore: p.max_score === -Infinity ? 0 : p.max_score,
                    winRate: avgWin,
                    dealRate: avgDeal,
                    avgRank: avgRank,
                    topRate: topRate,
                    avoidRate: avoidRate,
                    games: p.count
                };
            });
        }

        // 謌ｻ繧九・繧ｿ繝ｳ - 蜑阪・繝壹・繧ｸ縺ｫ謌ｻ繧具ｼ亥ｱ･豁ｴ縺後↑縺・ｴ蜷医・繝帙・繝縺ｸ・・        function goBack() {
            if (document.referrer && document.referrer.includes(location.hostname)) {
                history.back();
            } else {
                location.href = '../index.html';
            }
        }

        function toggleLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }


        document.addEventListener('DOMContentLoaded', initPage);

    </script>
    <!-- 繝√・繝騾夂衍繝舌ャ繧ｸ -->
    <script>
        async function checkTeamNotifications() {
            const user = await getCurrentUser();
            if (!user) return;

            const discordId = user.user_metadata.provider_id;

            // 閾ｪ蛻・′繝ｪ繝ｼ繝繝ｼ縺ｮ繝√・繝繧貞叙蠕・            const { data: myTeams } = await supabaseClient
                .from('teams')
                .select('id')
                .eq('creator_discord_id', discordId);

            if (!myTeams || myTeams.length === 0) return;

            const teamIds = myTeams.map(t => t.id);

            // 菫晉蕗荳ｭ縺ｮ逕ｳ隲具ｼ亥刈蜈･繝ｻ閼ｱ騾・峨ｒ繧ｫ繧ｦ繝ｳ繝・            const { data: pendingRequests } = await supabaseClient
                .from('team_join_requests')
                .select('id')
                .in('team_id', teamIds)
                .in('status', ['pending', 'leave_pending']);

            const count = pendingRequests?.length || 0;

            if (count > 0) {
                const badge = document.getElementById('team-notification-badge');
                if (badge) {
                    badge.textContent = count;
                    badge.style.display = 'inline';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', checkTeamNotifications);
    </script>
</body>

</html>
